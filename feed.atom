<?xml version="1.0" encoding="UTF-8"?><feed xmlns="http://www.w3.org/2005/Atom">
  <title>Planète PostgreSQL</title>
  <id>https://planete.postgresql.fr/</id>
  <updated>2025-11-14T16:44:49Z</updated>
  <subtitle>L&#39;actualité de PostgreSQL de français</subtitle>
  <link href="https://planete.postgresql.fr/"></link>
  <author>
    <name>PostgreSQL.fr</name>
    <email>contact@postgresql.fr</email>
  </author>
  <entry>
    <title>Retour sur le DevFest Toulouse 2025</title>
    <updated>2025-11-14T14:00:00Z</updated>
    <id>tag:www.loxodata.com,2025-11-14:/post/devfest-toulouse-2025/</id>
    <link href="http://www.loxodata.com/post/devfest-toulouse-2025/" rel="alternate"></link>
    <summary type="html">&lt;h1 id=&#34;retour-sur-le-devfest-toulouse-2025&#34;&gt;Retour sur le DevFest Toulouse 2025&lt;/h1&gt;&#xA;&lt;p&gt;Le &lt;a href=&#34;https://devfesttoulouse.fr/&#34;&gt;DevFest Toulouse 2025&lt;/a&gt;, organisé par le &lt;a href=&#34;https://gdg.community.dev/gdg-toulouse/&#34;&gt;GDG Toulouse&lt;/a&gt;,&#xA;s&amp;rsquo;est tenu le jeudi 13 novembre au centre de congrès Diagora à Labège, dans l&amp;rsquo;Est Toulousain.&lt;/p&gt;&#xA;&lt;p&gt;Il y avait six salles en parallèle pour offrir des conférences sur des sujets techniques variés allant des langages de programmation, aux méthodes de&#xA;développement, à l&amp;rsquo;infrastructure, au frontend et l&amp;rsquo;IA.&lt;/p&gt;&#xA;&lt;p&gt;Une salle dédiée aux sponsors permettait d&amp;rsquo;échanger avec les équipes autour d&amp;rsquo;animations et de cafés.&lt;/p&gt;&#xA;&lt;h2 id=&#34;les-conférences&#34;&gt;Les conférences&lt;/h2&gt;&#xA;&lt;p&gt;Au vu du nombre de conférences, il faut faire des choix. Je vous présente donc ici les conférences auxquelles j&amp;rsquo;ai pu participer durant la journée.&lt;/p&gt;&#xA;&lt;p&gt;Vous pouvez consulter l&amp;rsquo;&lt;a href=&#34;https://devfesttoulouse.fr/agenda-2025/&#34;&gt;agenda complet&lt;/a&gt; pour visualiser la liste complète des conférences.&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;http://www.loxodata.com/images/post/devfest-toulouse-2025/dev-fest-toulouse-anotherworld.jpg&#34; alt=&#34;DevFest Toulouse intro&#34;&gt;&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&#xA;&lt;p&gt;&lt;em&gt;Another World, une belle leçon d’architecture logicielle&lt;/em&gt;, Olivier Poncet : la conférence d&amp;rsquo;ouverture permet de revenir sur l&amp;rsquo;architecture du célèbre jeu &lt;code&gt;Another World&lt;/code&gt;&#xA;créé par Éric Chahi et de son &lt;a href=&#34;https://github.com/ponceto/another-world-interpreter&#34;&gt;portage&lt;/a&gt; par Olivier pour le faire tourner dans un navigateur avec WebAssembly.&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;&#xA;&lt;p&gt;&lt;em&gt;Docker Bake, élégance et standardisation pour le build de vos images Docker&lt;/em&gt;, Mazlum Tosun : Mazlum nous présente l&amp;rsquo;outil &lt;a href=&#34;https://docs.docker.com/build/bake/&#34;&gt;Docker Bake&lt;/a&gt; basé sur Docker Buildx&#xA;pour construire vos images Docker de manière déclarative avec le format HCL, et de manière concurrente.&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;&#xA;&lt;p&gt;&lt;em&gt;Toute ma stack est dans ma BDD : Postgres et quelques &amp;ldquo;power tools&amp;rdquo; pour mon backend&lt;/em&gt;, Mathieu Passenau et Loïc des Rochettes : Mathieu et Loïc de chez &lt;a href=&#34;https://please-open.it/&#34;&gt;Please-open.it&lt;/a&gt; nous présentent leur idée d&amp;rsquo;utiliser PostgreSQL pour&#xA;toute la pile logiciel, en passant par le stockage, l&amp;rsquo;authentification via Keycloak, l&amp;rsquo;utilisation de fonctions pour la partie contrôleur et les APIs via PostgREST.&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;&#xA;&lt;p&gt;&lt;em&gt;Conception de logiciels : le match humains vs AI&lt;/em&gt;, Olivier Azeau : Olivier nous propose de participer à un quiz sur la conception logiciel et de comparer nos résultats avec ceux obtenus avec l&amp;rsquo;aide de l&amp;rsquo;IA.&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;&#xA;&lt;p&gt;&lt;em&gt;Renovate à la rescousse : Automatisez la dette technique de votre infra Kubernetes&lt;/em&gt;, Paul Vulliemin : Paul nous propose de découvrir l&amp;rsquo;outil &lt;a href=&#34;https://github.com/renovatebot/renovate&#34;&gt;Renovate&lt;/a&gt; pour la&#xA;mise à jour des dépendances d&amp;rsquo;outils dans le cadre de l&amp;rsquo;Infrastructure as code/Continous delivery avec un cluster Kubernetes.&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;&#xA;&lt;p&gt;&lt;em&gt;Metal-As-A-Service : Gérer votre bare-metal en MaaS, comme si c&amp;rsquo;était une machine virtuelle !&lt;/em&gt;, Julien Briault : Julien nous présente le &lt;code&gt;cloud du coeur&lt;/code&gt; mis en place aux restos du coeur et l&amp;rsquo;utilisation&#xA;d&amp;rsquo;un outil open source pour gérer ses serveurs physiques aussi simplement qu&amp;rsquo;une machine virtuelle afin de réduire les coûts d&amp;rsquo;exploitation du matériel.&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;&#xA;&lt;p&gt;&lt;em&gt;REX: une approche moderne de gestion de clusters Kubernetes&lt;/em&gt; : Alexandre Dias et Thomas Martin de chez Qonto nous présentent leur retour d&amp;rsquo;expérience sur l&amp;rsquo;administration de leurs clusters Kubernetes dans&#xA;une optique de réduction des coûts, de facilité de gestion et de résilience de la production.&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;&#xA;&lt;p&gt;&lt;em&gt;Beyond agile : Dans les coulisses des licornes géantes de la Tech !&lt;/em&gt;, Rachel Dubois : Rachel nous propose une conférence sur les bonnes pratiques utilisées par des grandes sociétés de la tech dans l&amp;rsquo;agilité&#xA;afin d&amp;rsquo;innover, et comment échouer leur permet de livrer des expériences utilisateurs toujours plus appétentes.&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h2 id=&#34;conclusion&#34;&gt;Conclusion&lt;/h2&gt;&#xA;&lt;p&gt;Cette édition du DevFest Toulouse montre à quel point les communautés de développeuses et développeurs sont dynamiques un peu partout en France.&lt;/p&gt;</summary>
    <author>
      <name>Loxodata</name>
    </author>
  </entry>
  <entry>
    <title>PostgreSQL Conference Europe 2025</title>
    <updated>2025-11-05T10:10:00Z</updated>
    <id>tag:www.loxodata.com,2025-11-05:/post/pgconf-eu-2025-report/</id>
    <link href="http://www.loxodata.com/post/pgconf-eu-2025-report/" rel="alternate"></link>
    <summary type="html">&lt;h1 id=&#34;retour-sur-la-postgresql-conference-europe-2025&#34;&gt;Retour sur la PostgreSQL Conference Europe 2025&lt;/h1&gt;&#xA;&lt;p&gt;Cette année, la PostgreSQL Conference Europe 2025 s&amp;rsquo;est déroulée à&#xA;Riga, en Lettonie. Cet évènement autour de PostgreSQL rassemble le&#xA;plus grand nombre de participants en Europe.&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;http://www.loxodata.com/images/post/pgconf-eu-2025/monument-liberte.jpg&#34; alt=&#34;Le monument de la liberté à Riga&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;La liste des conférences est disponible sur le site de&#xA;l&amp;rsquo;évènement : &lt;a href=&#34;https://www.postgresql.eu/events/pgconfeu2025/schedule/&#34;&gt;https://2025.pgconf.eu/&lt;/a&gt;.&#xA;Les supports de présentations, ainsi que les enregistrements vidéos sont&#xA;également mis à disposition dans la mesure du possible.&lt;/p&gt;&#xA;&lt;h2 id=&#34;community-events-day&#34;&gt;Community events day&lt;/h2&gt;&#xA;&lt;p&gt;Le mardi, pour la première fois cette année, était consacré à la communauté.&lt;/p&gt;&#xA;&lt;p&gt;La journée était découpée en ateliers d&amp;rsquo;une demi-journée. Les ateliers étaient&#xA;aussi divers qu&amp;rsquo;intéressants.&lt;/p&gt;&#xA;&lt;p&gt;Le nombre de places était limité, ce qui a engendré un peu de frustration.&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.postgresql.eu/events/pgconfeu2025/schedule/session/7150-postgresql-on-kubernetes-summit/&#34;&gt;PostgreSQL on Kubernetes Summit&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;De nombreuses interventions d&amp;rsquo;une dizaine de minutes devaient permettre de&#xA;dresser un état des lieux des opérateurs autour de PostgreSQL. Malheureusement,&#xA;la plupart des présentations ont été consacrées à l&amp;rsquo;opérateur CloudNativePG.&lt;/p&gt;&#xA;&lt;p&gt;Celui-ci présente toutefois un réel intérêt, puisqu&amp;rsquo;il est désormais&#xA;complètement libre.&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.postgresql.eu/events/pgconfeu2025/schedule/session/7151-community-organizers-conf/&#34;&gt;Community Organizers Conf&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;Un atelier à destination des organisateurs de conférences communautaires, avec&#xA;des conseils intéressants, et des retours d&amp;rsquo;expérience.&lt;/p&gt;&#xA;&lt;p&gt;Encore une preuve, s&amp;rsquo;il en fallait que la communauté est active et accueillante.&lt;/p&gt;&#xA;&lt;h2 id=&#34;la-conférence&#34;&gt;La conférence&lt;/h2&gt;&#xA;&lt;p&gt;Lors de la première intervention de la journée, Magnus Hagander a évoqué le&#xA;nombre de 650 participants. Encore une très nombreuse audience cette année.&lt;/p&gt;&#xA;&lt;p&gt;La &lt;a href=&#34;https://buff.ly/4b483Ff&#34;&gt;conférence d&amp;rsquo;ouverture&lt;/a&gt; est donnée par&#xA;Karen Sandler, de la &lt;a href=&#34;https://sfconservancy.org/&#34;&gt;Software Freedom Conservancy&lt;/a&gt;.&#xA;Le sujet abordé est celui de l&amp;rsquo;importance des logiciels libres dans le monde actuel.&lt;/p&gt;&#xA;&lt;p&gt;Les conférences sont ensuite réparties dans différentes salles, avec 4&#xA;conférences simultanées, dont une réservée aux sponsors. Nous résumons&#xA;ici nos notes à propos des présentations auxquelles nous avons&#xA;assisté.&lt;/p&gt;&#xA;&lt;h2 id=&#34;performance&#34;&gt;Performance&lt;/h2&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.postgresql.eu/events/pgconfeu2025/schedule/session/6952-improved-freezing-in-postgres-vacuum-from-idea-to-commit/&#34;&gt;Improved Freezing in Postgres Vacuum: From Idea to Commit&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;L&amp;rsquo;oratrice Melanie Plageman évoque les travaux entrepris depuis des&#xA;années pour améliorer le freeze des tuples visibles : de nombreuses&#xA;tentatives ont été abandonnées, car les solutions expérimentées ne sont pas&#xA;toujours meilleures que la situation actuelle.&lt;/p&gt;&#xA;&lt;p&gt;Pour rappel, le freeze d&amp;rsquo;un tuple visible consiste à oublier la&#xA;transaction ayant rendu visible la ligne, permettant ainsi le cycle&#xA;des identifiants de transaction. Un des inconvénients de ces tâches de&#xA;maintenance est l&amp;rsquo;amplification en écriture : une même page de&#xA;données est écrite plusieurs fois si nécessaire, à chaque itération&#xA;des maintenances.&lt;/p&gt;&#xA;&lt;p&gt;Finalement, la solution retenue, et livrée avec la version 18 de&#xA;PostgreSQL, est de freezer autant que possible les lignes pendant un&#xA;vacuum régulier, diminuant l&amp;rsquo;amplification en écriture.&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://anarazel.de/talks/2025-10-23-pgconf-eu-aio-in-PG-18-and-beyond/aio-in-PG-18-and-beyond.pdf&#34;&gt;AIO in PG 18 and beyond&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;L&amp;rsquo;orateur Andres Freund est l&amp;rsquo;auteur principal d&amp;rsquo;une nouvelle&#xA;fonctionnalité de PostgreSQL 18 : les entrées-sorties asynchrones.&lt;/p&gt;&#xA;&lt;p&gt;Après un rappel des enjeux et des possibilités de cette&#xA;fonctionnalité, il nous montre les gains potentiels, en intégrant dans&#xA;le test les travaux en cours pour les futures versions de PostgreSQL.&lt;/p&gt;&#xA;&lt;p&gt;En effet, si la fonctionnalité actuelle est limitée aux lectures&#xA;séquentielles et aux lectures « bitmap » des index, les lectures&#xA;indexées et les écritures sont prévues pour les versions 19, 20 ou 21&#xA;de PostgreSQL.&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.postgresql.eu/events/pgconfeu2025/sessions/session/6891/slides/759/fast-path-locking-pg18-pgconfeu-2025.pdf&#34;&gt;Fast-path locking improvements in PG18&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;L&amp;rsquo;orateur Tomas Vondra est un développeur habituel de PostgreSQL et&#xA;s&amp;rsquo;est trouvé confronté à un problème de performance d&amp;rsquo;une requête&#xA;utilisant un grand nombre de partitions. Cela l&amp;rsquo;a amené à se pencher&#xA;sur la façon dont les verrous sont obtenus lors de l&amp;rsquo;exécution d&amp;rsquo;une&#xA;requête, et en particulier le « fast-path locking ». Apparue dans la&#xA;version 9.2 de PostgreSQL, cette fonctionnalité permet d&amp;rsquo;avoir un&#xA;cache local de la table des verrous, mais seulement pour 16 objets, ce&#xA;qui pose un problème lorsqu&amp;rsquo;il y a un grand nombre de partitions : les&#xA;verrous sont alors notés dans la mémoire partagée, ce qui est plus lent.&lt;/p&gt;&#xA;&lt;p&gt;Tomas Vondra travaille alors pour proposer une solution permettant de&#xA;noter un plus grand nombre de verrous dans ce cache local : la&#xA;proposition, présente dans PostgreSQL 18, consiste à utiliser un&#xA;« &lt;a href=&#34;https://en.algorithmica.org/hpc/cpu-cache/associativity/&#34;&gt;set-associative&#xA;cache&lt;/a&gt; »&#xA;afin d&amp;rsquo;augmenter le nombre d&amp;rsquo;entrées possibles avec le même niveau de&#xA;performance.&lt;/p&gt;&#xA;&lt;p&gt;L&amp;rsquo;orateur constate alors le gain de performance, très visible dans les&#xA;Flame Graphs présentés. Pour terminer, outre la liste de toutes les&#xA;possibilités que cela ouvre pour les prochaines versions de&#xA;PostgreSQL, Tomas Vondra remercie l&amp;rsquo;auteur original de la&#xA;fonctionnalité, Robert Haas, qui a livré un code de qualité,&#xA;facilitant les améliorations proposées par la suite, et ce détail est&#xA;très important pour comprendre pourquoi PostgreSQL est un bon outil :&#xA;il est bien écrit !&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://resources.pganalyze.com/pganalyze_PGConf_EU_2025_pg_stat_plans.pdf&#34;&gt;Tracking plan shapes over time with Plan IDs and the new pg_stat_plans&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;L&amp;rsquo;orateur Lukas Fittl explique en quoi une nouvelle fonctionnalité de&#xA;PostgreSQL 18 lui a permis de reprendre une idée déjà présente, mais&#xA;en l&amp;rsquo;améliorant pour la rendre utilisable.&lt;/p&gt;&#xA;&lt;p&gt;La nouveauté de PostgreSQL 18 est la possibilité pour une extension de&#xA;stocker un identifiant de plan d&amp;rsquo;exécution, ce qui permet de suivre un&#xA;même plan au cours de l&amp;rsquo;exécution d&amp;rsquo;une requête, à travers les&#xA;différents « hooks » de PostgreSQL. À cela s&amp;rsquo;ajoute la possibilité&#xA;pour une extension d&amp;rsquo;utiliser des statistiques cumulatives.&lt;/p&gt;&#xA;&lt;p&gt;L&amp;rsquo;extension &lt;a href=&#34;https://github.com/pganalyze/pg_stat_plans&#34;&gt;&lt;code&gt;pg_stat_plans&lt;/code&gt;&lt;/a&gt;&#xA;permet alors de suivre l&amp;rsquo;utilisation des plans d&amp;rsquo;exécution par les requêtes&#xA;d&amp;rsquo;une instance PostgreSQL, permettant ainsi des analyses fines des&#xA;performances de nos requêtes, sans grever les performances de ces dernières.&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.postgresql.eu/events/pgconfeu2025/sessions/session/7010/slides/799/PgConfEU_MVCC_bmejias_ajaimini.pdf&#34;&gt;We have multiple concurrent versions of this title trying to understand MVCC&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;L&amp;rsquo;orateur Boriss Mejias revient sur un sujet couramment abordé dans&#xA;les conférences PostgreSQL, mais toujours nécessaire : la gestion de&#xA;la concurrence dans PostgreSQL.&lt;/p&gt;&#xA;&lt;p&gt;La présentation revient sur tous les éléments importants qui sont la&#xA;conséquence de l&amp;rsquo;implémentation de MVCC dans PostgreSQL : l&amp;rsquo;isolation&#xA;des transactions, la notion de lignes mortes, les raisons pour&#xA;lesquelles VACUUM est utile et a des conséquences, y compris sur la&#xA;réplication et le freeze des tuples visibles.&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;http://www.loxodata.com/images/post/pgconf-eu-2025/riga-aldaru-iela.jpg&#34; alt=&#34;rue du centre historique de Riga&#34;&gt;&lt;/p&gt;&#xA;&lt;h2 id=&#34;administration&#34;&gt;Administration&lt;/h2&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://drive.google.com/file/d/1iq40z1SEQGUPFrJcAph8Hmw6w7g5-Mig/view?usp=sharing&#34;&gt;What implementing pg_tde taught us about PostgreSQL&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;L&amp;rsquo;orateur Jan Wieremjewicz détaille le besoin exprimé par de plus en&#xA;plus d&amp;rsquo;utilisateurs de PostgreSQL : le chiffrement transparent des&#xA;données, ou TDE.&lt;/p&gt;&#xA;&lt;p&gt;Entre autres besoins, il nous rappelle que, pour des raisons&#xA;règlementaires, le chiffrement sur disque n&amp;rsquo;est plus suffisant, et que&#xA;certains utilisateurs ont maintenant besoin d&amp;rsquo;une solution de&#xA;chiffrement native dans leur base de données.&lt;/p&gt;&#xA;&lt;p&gt;L&amp;rsquo;orateur explique alors la démarche de recension des besoins des&#xA;utilisateurs pour aboutir à une solution. Un des besoins identifiés&#xA;est d&amp;rsquo;utiliser une solution open-source, et dont le code, à terme, est&#xA;présent dans PostgreSQL.&lt;/p&gt;&#xA;&lt;p&gt;Les solutions déjà existantes ne correspondant pas, Percona développe&#xA;alors une réponse aux besoins, avec comme objectif l&amp;rsquo;intégration dans&#xA;PostgreSQL.&lt;/p&gt;&#xA;&lt;p&gt;Ça n&amp;rsquo;est pas le cas actuellement : Percona propose une version&#xA;modifiée de PostgreSQL et une extension :&#xA;&lt;a href=&#34;https://github.com/percona/pg_tde&#34;&gt;pg_tde&lt;/a&gt;. Deux patchs proposés,&#xA;mais pas encore intégrés sont en effet nécessaires pour proposer un&#xA;chiffrement des tables.&lt;/p&gt;&#xA;&lt;p&gt;La solution est donc open-source, et utilisable, dans des limites&#xA;connues, et l&amp;rsquo;objectif de l&amp;rsquo;intégration dans PostgreSQL reste à&#xA;atteindre.&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.postgresql.eu/events/pgconfeu2025/schedule/session/7191-tde-as-an-extension-a-different-path-for-postgresql-encryption/&#34;&gt;TDE as an Extension: A Different Path for PostgreSQL Encryption&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;À la suite de la présentation précédente, l&amp;rsquo;orateur Zsolt Parragi&#xA;détaille l&amp;rsquo;implémentation actuelle de&#xA;&lt;a href=&#34;https://github.com/percona/pg_tde&#34;&gt;pg_tde&lt;/a&gt; : quel chemin pour y&#xA;arriver, qu&amp;rsquo;est-ce qui fonctionne, que reste-t-il à faire ?&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.postgresql.eu/events/pgconfeu2025/sessions/session/6975/slides/746/pgconfeu25_Postgres_Logparsing.pdf&#34;&gt;Parsing Postgres logs the non-pgBadger way&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;L&amp;rsquo;orateur Kaarel Moppel présente les différentes approches possibles&#xA;pour analyser les logs d&amp;rsquo;une instance PostgreSQL : d&amp;rsquo;outils Unix comme&#xA;sed/awk, en passant par pgBadger jusqu&amp;rsquo;au chargement des logs dans une&#xA;table de PostgreSQL, les possibilités sont nombreuses.&lt;/p&gt;&#xA;&lt;p&gt;L&amp;rsquo;orateur présente un nouvel outil :&#xA;&lt;a href=&#34;https://github.com/kmoppel/pgweasel&#34;&gt;pgweasel&lt;/a&gt;, écrit en GO,&#xA;permettant d&amp;rsquo;extraire des informations agrégées des fichiers de logs,&#xA;en visant de meilleures performances que les outils existants. Une&#xA;réécriture en Rust permet d&amp;rsquo;ailleurs d&amp;rsquo;être encore plus rapide qu&amp;rsquo;en&#xA;GO.&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.postgresql.eu/events/pgconfeu2025/sessions/session/7103/slides/780/Barman,%20past,%20present,%20and%20future%20of%20a%20pioneer%20community%20project.pdf&#34;&gt;Barman, past, present, and future of a pioneer community project&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;Les orateurs Giulio Calacoci et Martín Marqués reviennent sur&#xA;l&amp;rsquo;histoire de l&amp;rsquo;outil Barman, connu et utilisé depuis des années par&#xA;de nombreux utilisateurs pour mettre en œuvre leurs stratégies de&#xA;sauvegardes et restaurations des instances PostgreSQL.&lt;/p&gt;&#xA;&lt;p&gt;Si l&amp;rsquo;activité de l&amp;rsquo;outil, sous-entendu, son développement, a été&#xA;chaotique ces dernières années, il a été décidé de relancer, à travers&#xA;une communauté d&amp;rsquo;utilisateurs, la vie de l&amp;rsquo;outil pour répondre aux&#xA;besoins actuels.&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.postgresql.eu/events/pgconfeu2025/sessions/session/6908/slides/785/20251023_dkrautschick_PGConfEU_KafkaDebeziumForDBPeople.pdf&#34;&gt;Why PostgreSQL people should really care about Kafka and Debezium?&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;L&amp;rsquo;orateur Dirk Krautschick explique le fonctionnement et l&amp;rsquo;utilisation&#xA;du couple Kafka/Debezium pour « consommer » les flux de données d&amp;rsquo;une&#xA;instance PostgreSQL.&lt;/p&gt;&#xA;&lt;p&gt;Debezium est le connecteur utilisé par Kafka pour consommer les&#xA;données issues du décodage logique des journaux de transactions d&amp;rsquo;une&#xA;instance PostgreSQL. Cela permet de concevoir des architectures de&#xA;données évitant de devoir copier des données ou requêter une base :&#xA;tous les changements de données sont envoyés dans le flux.&lt;/p&gt;&#xA;&lt;p&gt;L&amp;rsquo;orateur mentionne pour finir un nouvel outil : &lt;a href=&#34;https://flink.apache.org/&#34;&gt;Apache&#xA;Flink&lt;/a&gt;, conçu très récemment !&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.postgresql.eu/events/pgconfeu2025/sessions/session/7094/slides/772/herrera-houska-repack-2025.pdf&#34;&gt;Table repacking, done right&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;Les orateurs Álvaro Herrera et Antonin Houska détaillent un besoin&#xA;très présent pour les administrateurs de bases de données : devoir&#xA;réorganiser physiquement une table. Après un historique des&#xA;différentes solutions présentes dans PostgreSQL (&lt;code&gt;VACUUM FULL&lt;/code&gt;), les&#xA;orateurs expliquent la difficulté d&amp;rsquo;intégrer l&amp;rsquo;outil&#xA;&lt;a href=&#34;https://github.com/cybertec-postgresql/pg_squeeze&#34;&gt;pg_squeeze&lt;/a&gt; dans&#xA;PostgreSQL, ce second outil faisant la même chose que la première&#xA;commande, mais en minimisant le verrouillage de l&amp;rsquo;objet traité.&lt;/p&gt;&#xA;&lt;p&gt;En effet, les orateurs proposent le renommage de &lt;code&gt;VACUUM FULL&lt;/code&gt; et&#xA;l&amp;rsquo;intégration de &lt;code&gt;pg_squeeze&lt;/code&gt; dans une commande &lt;code&gt;REPACK&lt;/code&gt; et son option&#xA;&lt;code&gt;CONCURRENTLY&lt;/code&gt;. Le patch est en cours d&amp;rsquo;intégration et a besoin de&#xA;testeurs !&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.postgresql.eu/events/pgconfeu2025/schedule/session/6817-operational-hazards-of-managing-postgresql-dbs-over-100tb/&#34;&gt;Operational hazards of managing PostgreSQL DBs over 100TB&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;L&amp;rsquo;oratrice Teresa Lopes expose un certain nombre de bonnes pratiques à&#xA;intégrer lorsque l&amp;rsquo;on s&amp;rsquo;attaque à des bases dépassant les 100TB.&lt;/p&gt;&#xA;&lt;p&gt;Parmi les pistes évoquées, Teresa détaille les opérations de &lt;code&gt;VACUUM&lt;/code&gt;,&#xA;les sauvegardes, et la réorganisation des colonnes en fonction de leur&#xA;type.&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.postgresql.eu/events/pgconfeu2025/schedule/session/6960-have-you-ever-wondered-how-a-cloud-platform-works/&#34;&gt;Have you ever wondered, how a cloud platform works?&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;Les orateurs Maximilian Stefanac et Philipp Thun présentent Cloud&#xA;Foundry, PaaS utilisé par SAP Business Technology, et reposant sur&#xA;PostgreSQL.&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.postgresql.eu/events/pgconfeu2025/schedule/session/6795-explain-make-it-make-sense/&#34;&gt;EXPLAIN: make it make sense&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;L&amp;rsquo;orateur Aivars Kalvāns explique ce qu&amp;rsquo;on peut retirer comme&#xA;information d&amp;rsquo;un plan d&amp;rsquo;exécution PostgreSQL.&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.postgresql.eu/events/pgconfeu2025/schedule/session/6825-database-in-distress-testing-and-repairing-different-types-of-database-corruption/&#34;&gt;Database in Distress: Testing and Repairing Different Types of Database Corruption&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;L&amp;rsquo;orateur Josef Machytka revient sur les cas de corruption qu&amp;rsquo;il a eu&#xA;à traiter.&lt;/p&gt;&#xA;&lt;p&gt;Il présente un outil qu&amp;rsquo;il a écrit pour générer des crashs de bases de données&#xA;de manière à étudier les solutions envisageables pour corriger les problèmes.&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;http://www.loxodata.com/images/post/pgconf-eu-2025/fusiliers-lettons.jpg&#34; alt=&#34;Monument dédié aux fusiliers lettons (1915-1920) à Riga&#34;&gt;&lt;/p&gt;&#xA;&lt;h2 id=&#34;high-availibility&#34;&gt;High availibility&lt;/h2&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://pgstef.github.io/talks/en/20251022_PGConfEU_Patroni-and-pgBackRest.pdf&#34;&gt;Patroni and pgBackRest: better together&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;L&amp;rsquo;orateur Stefan Fercot évoque l&amp;rsquo;intégration de deux outils&#xA;complémentaires : Patroni pour la haute disponibilité et pgBackRest&#xA;pour les sauvegardes et restauration des instances PostgreSQL.&lt;/p&gt;&#xA;&lt;p&gt;Quelles sont les différentes étapes où Patroni utilise pgBackRest :&#xA;archivage, réinitialisation d&amp;rsquo;un nœud, bootstrap du cluster. On&#xA;comprend que pgBackRest intervient aux moments critiques de la gestion&#xA;des données de PostgreSQL.&lt;/p&gt;&#xA;&lt;p&gt;Un point important noté par Stefan : pour savoir si tout se passe&#xA;bien, il est essentiel de lire les logs des trois composants impliqués !&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.postgresql.eu/events/pgconfeu2025/schedule/session/7134-kubernetes-from-the-database-out/&#34;&gt;Kubernetes from the Database Out&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;L&amp;rsquo;orateur Alastair Turner explique les points importants à savoir&#xA;lorsqu&amp;rsquo;on souhaite utiliser PostgreSQL dans un cluster Kubernetes.&lt;/p&gt;&#xA;&lt;p&gt;Quels sont les composants et concepts utilisés : réseau, stockage,&#xA;automatisation…&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://speakerdeck.com/hugh0capet/hazards-of-logical-decoding-in-postgresql&#34;&gt;Hazards of logical decoding in PostgreSQL&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;L&amp;rsquo;oratrice Polina Bungina revient sur ce qu&amp;rsquo;implique le décodage&#xA;logique dans PostgreSQL, au regard de son expérience chez Zalando. En&#xA;effet, cette technologie est loin d&amp;rsquo;être simple et peut entrainer des&#xA;effets de bords désastreux pour une instance de production.&lt;/p&gt;&#xA;&lt;p&gt;De la définition d&amp;rsquo;un LSN (Log Sequence Number) à la description d&amp;rsquo;un&#xA;slot et des différentes informations qui le constitue, on comprend au&#xA;fur et à mesure les différents points critiques qui peuvent entrainer&#xA;de vraies difficultés en cas de problèmes.&lt;/p&gt;&#xA;&lt;p&gt;En effet, une simple commande de maintenance sur une table répliquée&#xA;peut entrainer le stockage d&amp;rsquo;un gros volume de données, en plus des&#xA;WALs habituels, à cause du réordonnancement des transactions&#xA;répliquées. Il faut alors surveiller la vue &lt;code&gt;pg_stat_replication_slots&lt;/code&gt;.&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.postgresql.eu/events/pgconfeu2025/sessions/session/7018/slides/771/patroni_talk_pgconf2025.pdf&#34;&gt;Patroni: what the blog posts don&amp;rsquo;t tell you&amp;hellip;&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;L&amp;rsquo;orateur Cameron Murdoch souhaite ajouter quelques points importants&#xA;qu&amp;rsquo;on ne lit pas dans les blogposts habituels sur Patroni, notamment&#xA;la nécessité de sécuriser les flux vers les différents composants d&amp;rsquo;un&#xA;cluster.&lt;/p&gt;&#xA;&lt;p&gt;Création d&amp;rsquo;utilisateurs dédiés, de certificats pour des flux sécurisés,&#xA;procédures de mises à jour des différents composants : autant de&#xA;points critiques qui doivent faire partie de l&amp;rsquo;intégration de Patroni,&#xA;et le plus tôt possible pour éviter d&amp;rsquo;avoir à corriger plus tard.&lt;/p&gt;&#xA;&lt;h2 id=&#34;autres&#34;&gt;Autres&lt;/h2&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://speakerdeck.com/clairegiordano/behind-postgres-18-the-people-the-code-and-the-invisible-work-claire-giordano-pgconfeu-2025&#34;&gt;Behind Postgres 18: The People, the Code, &amp;amp; the Invisible Work&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;L&amp;rsquo;oratrice Claire Giordano fait le bilan des nombreuses contributions&#xA;nécessaire à fabriquer PostgreSQL 18 : le code, bien sûr, mais pas&#xA;seulement : la documentation, les évènements communautaires, les&#xA;contributions financières : de nombreux acteurs s&amp;rsquo;associent pour former&#xA;une communauté riche et diverse !&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.postgresql.eu/events/pgconfeu2025/sessions/session/6832/slides/800/all_about_cve_pgconf_eu_2025.pdf&#34;&gt;All about Common Vulnerabilities and exposures in PostgreSQL&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;L&amp;rsquo;oratrice Priyanka Chatterjee évoque un aspect mal connu : la gestion&#xA;des vulnérabilités dans le projet PostgreSQL. Qu&amp;rsquo;est-ce qu&amp;rsquo;un CVE,&#xA;comment le projet PostgreSQL est organisé pour répondre, et qu&amp;rsquo;est-ce&#xA;qu&amp;rsquo;un utilisateur doit comprendre des informations publiées lors de la&#xA;publication d&amp;rsquo;un correctif de sécurité.&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.postgresql.eu/events/pgconfeu2025/schedule/session/7138-from-stars-to-storage-engines-migrating-big-science-workloads-beyond-greenplum/&#34;&gt;From Stars to Storage Engines: Migrating Big Science Workloads Beyond Greenplum&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;L&amp;rsquo;orateur Joaquim Oliveira, détaille les difficultés rencontrées par&#xA;l&amp;rsquo;agence spatiale européenne (ESA) suite au rachat de VMware par&#xA;Broadcom, et le passage en produit commercial fermé de Greenplum.&lt;/p&gt;&#xA;&lt;p&gt;L&amp;rsquo;agence a étudié différentes solutions pour rester dans un monde&#xA;moins fermé. La décision a finalement été prise de travailler avec la&#xA;solution Warehouse de EDB.&lt;/p&gt;&#xA;&lt;p&gt;Bonne nouvelle, &lt;a href=&#34;https://warehouse-pg.io&#34;&gt;WarehousePG&lt;/a&gt; sur lequel est&#xA;basée l&amp;rsquo;offre d&amp;rsquo;EDB est open source.&lt;/p&gt;&#xA;&lt;h2 id=&#34;conclusion&#34;&gt;Conclusion&lt;/h2&gt;&#xA;&lt;p&gt;À nouveau, cette conférence a apporté aux quelques centaines de&#xA;présents de la matière pour l&amp;rsquo;avenir, en plus des nombreuses&#xA;rencontres et discussions : la communauté PostgreSQL est plus riche et&#xA;diverse que jamais !&lt;/p&gt;</summary>
    <author>
      <name>Loxodata</name>
    </author>
  </entry>
  <entry>
    <title>Plusieurs évènements sur Toulouse à ne pas rater en Novembre</title>
    <updated>2025-10-28T15:00:00Z</updated>
    <id>tag:www.loxodata.com,2025-10-28:/post/events-toulouse-2025/</id>
    <link href="http://www.loxodata.com/post/events-toulouse-2025/" rel="alternate"></link>
    <summary type="html">&lt;p&gt;Le mois prochain se tiendra deux évènements sur Toulouse autour du logiciel libre, mais pas seulement :&#xA;j&amp;rsquo;ai nommé le &lt;a href=&#34;https://devfesttoulouse.fr/&#34;&gt;DevFest Toulouse&lt;/a&gt; et le &lt;a href=&#34;https://capitoledulibre.org/&#34;&gt;Capitole du Libre&lt;/a&gt;.&lt;/p&gt;&#xA;&lt;p&gt;Le &lt;a href=&#34;https://devfesttoulouse.fr/&#34;&gt;DevFest Toulouse&lt;/a&gt; organisé par le &lt;a href=&#34;https://gdg.community.dev/gdg-toulouse/&#34;&gt;GDG Toulouse&lt;/a&gt; qui se tiendra le jeudi 13 novembre à Diagora (Labège), un évènement orienté plutôt développement. Un sujet autour de PostgreSQL sera proposé sur comment constituer toute une pile logicielle avec PostgreSQL.&lt;/p&gt;&#xA;&lt;p&gt;Le &lt;a href=&#34;https://capitoledulibre.org/&#34;&gt;Capitole du Libre&lt;/a&gt; organisé par l&amp;rsquo;&lt;a href=&#34;https://toulibre.org/&#34;&gt;association Toulibre&lt;/a&gt; qui aura lieu le weekend du 15 au 16 novembre à l&amp;rsquo;ENSEEIHT (Toulouse), autour du logiciel libre. Vous pourrez participer par exemple à un atelier qui présentera CloudNativePG afin d&amp;rsquo;opérer PostgreSQL&#xA;dans un cluster Kubernetes.&lt;/p&gt;&#xA;&lt;p&gt;J&amp;rsquo;en profite pour vous rappeler le redémarrage des meetups Toulousains de PostgreSQL. Si vous avez raté l&amp;rsquo;&lt;a href=&#34;https://www.loxodata.com/post/meetup-toulouse-2025-10/&#34;&gt;édition précédente&lt;/a&gt;, ça se passait chez &lt;a href=&#34;https://pictarine.com/&#34;&gt;Pictarine&lt;/a&gt; et organisé par le Toulouse PostgreSQL User Group.&lt;/p&gt;&#xA;&lt;p&gt;Crédits photo : Arthur Chauvineau&lt;/p&gt;</summary>
    <author>
      <name>Loxodata</name>
    </author>
  </entry>
  <entry>
    <title>Éviter les chevauchements temporels</title>
    <updated>2025-10-24T00:00:00Z</updated>
    <id>tag:www.loxodata.com,2025-10-24:/post/without_overlaps/</id>
    <link href="http://www.loxodata.com/post/without_overlaps/" rel="alternate"></link>
    <summary type="html">&lt;!-- raw HTML omitted --&gt;&#xA;&lt;p&gt;&lt;em&gt;Dans un &lt;a href=&#34;../type-range-1&#34;&gt;précédent&lt;/a&gt; article, nous avons présenté les&#xA;plages de valeurs. Nous allons voir qu&amp;rsquo;avec ce type de données, il est possible, entre autres,&#xA;de mettre en place un contrôle sur les chevauchements de données.&#xA;Pour cela, faisons un peu de pratique avec la mise en place du modèle de données d&amp;rsquo;une application de location de&#xA;vélos, nécessitant une gestion de chevauchement des locations et une recherche&#xA;de plages de disponibilité.&lt;/em&gt;&lt;/p&gt;&#xA;&lt;p&gt;&lt;em&gt;Nous comparons la mise en oeuvre et les performances d&amp;rsquo;une plage de&#xA;dates et la gestion d&amp;rsquo;intervalles avec l&amp;rsquo;utilisation de dates de&#xA;début et de fin utilisant les types scalaires traditionnels.&lt;/em&gt;&lt;/p&gt;&#xA;&lt;p&gt;Plusieurs stratégies existent :&lt;/p&gt;&#xA;&lt;ol&gt;&#xA;&lt;li&gt;Deux colonnes : &lt;code&gt;start_datetime&lt;/code&gt; et &lt;code&gt;end_datetime&lt;/code&gt;&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&lt;p&gt;La forme la plus classique consiste à stocker les bornes dans deux colonnes.&#xA;Le problème : aucune contrainte SQL native n’empêche deux lignes de se chevaucher en combinant deux colonnes.&#xA;Il faut alors recourir à un déclencheur vérifiant, à l’insertion ou la mise à jour, qu’aucune autre réservation n’entre en conflit.&lt;/p&gt;&#xA;&lt;ol start=&#34;2&#34;&gt;&#xA;&lt;li&gt;Colonnes range + contrainte d’exclusion&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&lt;p&gt;Une solution plus élégante, disponible depuis PostgreSQL 9.2, consiste à utiliser un type &lt;code&gt;range&lt;/code&gt; (&lt;code&gt;tsrange&lt;/code&gt;, &lt;code&gt;tstzrange&lt;/code&gt;, &lt;code&gt;daterange&lt;/code&gt;) et une contrainte d’exclusion avec un index GiST.&lt;/p&gt;&#xA;&lt;ol start=&#34;3&#34;&gt;&#xA;&lt;li&gt;PostgreSQL 18+ : la clause &lt;code&gt;WITHOUT OVERLAPS&lt;/code&gt;&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&lt;p&gt;Depuis PostgreSQL 18, il est désormais possible de déclarer cette logique directement dans la clé primaire ou une contrainte unique. Pour cela, on utilise la clause&#xA;&lt;code&gt;WITHOUT OVERLAPS&lt;/code&gt; pour la dernière colonne de la contrainte d&amp;rsquo;unicité.&lt;/p&gt;&#xA;&lt;h2 id=&#34;et-en-pratique&#34;&gt;Et en pratique&lt;/h2&gt;&#xA;&lt;p&gt;Créons trois tables correspondant aux trois stratégies :&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;code&gt;rents_exclude&lt;/code&gt; : contient des locations de vélos utilisant le type plage de dates et la contrainte d&amp;rsquo;exclusion ;&lt;/li&gt;&#xA;&lt;li&gt;&lt;code&gt;rents_wo_overlaps&lt;/code&gt; : les mêmes locations utilisant le type plage de dates et la clause &lt;code&gt;WITHOUT OVERLAPS&lt;/code&gt; ;&lt;/li&gt;&#xA;&lt;li&gt;&lt;code&gt;rents_2_dates&lt;/code&gt; : les mêmes locations de vélos que dans la table &lt;code&gt;rents_exclude&lt;/code&gt; mais en utilisant deux dates.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h3 id=&#34;avec-deux-dates&#34;&gt;Avec deux dates&lt;/h3&gt;&#xA;&lt;p&gt;Voici comment nous pouvons gérer des locations avec une&#xA;date de début et une date de fin utilisant des types &lt;code&gt;timestamptz&lt;/code&gt;.&lt;/p&gt;&#xA;&lt;p&gt;Nous créons une table contenant l&amp;rsquo;&lt;code&gt;id&lt;/code&gt; de location, les dates et heures de début de la&#xA;location, de fin de la location et l&amp;rsquo;identifiant du vélo.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;CREATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;TABLE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rents_2_dates&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;INT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;GENERATED&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;BY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;DEFAULT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;IDENTITY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;PRIMARY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;KEY&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;start_datetime&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;timestamptz&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;end_datetime&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;timestamptz&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bike_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;INT&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CONSTRAINT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;end_date_sup_start_date_chk&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CHECK&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;end_datetime&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;start_datetime&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CREATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INDEX&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rent2dates_start_datetime_idx&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;ON&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rents_2_dates&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;USING&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;btree&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;start_datetime&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CREATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INDEX&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rent2dates_end_datetime_idx&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;ON&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rents_2_dates&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;USING&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;btree&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;end_datetime&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CREATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INDEX&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rent2dates_bike_id_idx&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;ON&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rents_2_dates&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;USING&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;btree&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bike_id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Nous utilisons une contrainte &lt;code&gt;CHECK&lt;/code&gt; pour vérifier que &lt;code&gt;end_datetime&lt;/code&gt;&#xA;est supérieure à &lt;code&gt;start_datetime&lt;/code&gt;.&lt;/p&gt;&#xA;&lt;p&gt;Nous créons ensuite un déclencheur de contrôle sur les commandes&#xA;&lt;code&gt;INSERT&lt;/code&gt; et &lt;code&gt;UPDATE&lt;/code&gt;, et sa fonction en langage PL/pgSQL, assurant&#xA;l&amp;rsquo;intégrité des données. Dans le cas présent, il s&amp;rsquo;agit d&amp;rsquo;empêcher le&#xA;chevauchement de périodes de location pour un même vélo :&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;CREATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;OR&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;REPLACE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FUNCTION&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;check_rent_datetime_validity&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;RETURNS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;TRIGGER&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;$&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rents_2_dates$&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;DECLARE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;counting_of_existing_rentals&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;TEXT&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;DECLARE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;number_of_rents&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;INTEGER&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;BEGIN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;counting_of_existing_rentals&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s1&#34;&gt;    SELECT COUNT(*) AS count_rent&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s1&#34;&gt;        FROM rents_2_dates&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s1&#34;&gt;        WHERE (($1 &amp;gt;= start_datetime  AND $1 &amp;lt; end_datetime   )&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s1&#34;&gt;                OR ($2 &amp;gt; start_datetime AND $2 &amp;lt; end_datetime  ) )&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s1&#34;&gt;        AND bike_id = $3 &amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;IF&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TG_OP&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;UPDATE&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;THEN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;EXECUTE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;counting_of_existing_rentals&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;||&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39; AND id &amp;lt;&amp;gt; $4&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INTO&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;number_of_rents&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;USING&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;start_datetime&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;end_datetime&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bike_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;ELSIF&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TG_OP&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;INSERT&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;THEN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;EXECUTE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;counting_of_existing_rentals&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INTO&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;number_of_rents&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;USING&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;start_datetime&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;end_datetime&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bike_id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;END&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;IF&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;IF&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;number_of_rents&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;THEN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;RAISE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;EXCEPTION&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;Cette plage horaire n&amp;#39;&amp;#39;est pas disponible pour bike_id % pour la période % - % &amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bike_id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;start_datetime&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;end_datetime&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;RETURN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NULL&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;END&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;IF&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;RETURN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NEW&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;END&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;$&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rents_2_dates$&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;LANGUAGE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;plpgsql&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CREATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;TRIGGER&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;trg_check_rent_datetime_validity&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;BEFORE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INSERT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;OR&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;UPDATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;ON&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rents_2_dates&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FOR&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;EACH&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;ROW&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;EXECUTE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;PROCEDURE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;check_rent_datetime_validity&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Maintenant que le déclencheur de contrôle est prêt, passons à quelques tests.&lt;/p&gt;&#xA;&lt;p&gt;Insérons une location pour le vélo d&amp;rsquo;id 7, le 2025-09-01 de 09:00 à 11:00 et&#xA;de 12:00 à 18:00 :&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;err&#34;&gt;\&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;set&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;test_day&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;#39;&amp;#39;2025-09-01&amp;#39;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;date&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INSERT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INTO&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rents_2_dates&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;start_datetime&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;end_datetime&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bike_id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;VALUES&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;test_day&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;interval&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;09 hour&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;test_day&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;interval&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;11 hour&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;7&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;test_day&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;interval&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;12 hour&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;test_day&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;interval&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;18 hour&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;7&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;RETURNING&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;┌─────────┬────────────────────────┬────────────────────────┬─────────┐&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;│&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;   &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;│&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;     &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;start_datetime&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;     &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;│&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;end_datetime&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;│&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bike_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;│&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;├─────────┼────────────────────────┼────────────────────────┼─────────┤&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;│&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;       &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;│&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2025&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;09&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;01&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;09&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;00&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;00&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;02&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;│&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2025&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;09&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;01&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;11&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;00&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;00&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;02&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;│&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;       &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;7&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;│&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;│&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;       &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;│&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2025&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;09&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;01&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;12&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;00&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;00&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;02&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;│&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2025&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;09&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;01&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;18&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;00&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;00&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;02&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;│&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;       &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;7&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;│&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;└─────────┴────────────────────────┴────────────────────────┴─────────┘&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Avec l&amp;rsquo;outil &lt;code&gt;psql&lt;/code&gt;, vous pouvez définir des variables lors de la session avec &lt;code&gt;\set&lt;/code&gt;.&#xA;Pour les tests suivants, nous allons affecter &lt;code&gt;test_day&lt;/code&gt; avec la valeur &lt;code&gt;&#39;2025-09-01&#39;::date&lt;/code&gt;.&lt;/p&gt;&#xA;&lt;p&gt;Procédons alors au test d&amp;rsquo;insertion dans une plage horaire déjà&#xA;occupée.&#xA;Tentons d&amp;rsquo;insérer une location pour ce même &lt;code&gt;bike_id&lt;/code&gt; de&#xA;10:00 à 15:00 :&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;INSERT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INTO&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rents_2_dates&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;start_datetime&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;end_datetime&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bike_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;VALUES&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;test_day&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;interval&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;10 hour&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;test_day&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;interval&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;15 hour&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;7&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ERROR&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Cette&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;plage&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;horaire&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;n&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;est&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pas&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;disponible&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pour&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bike_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;7&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pour&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;la&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;période&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2025&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;09&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;01&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;10&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;00&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;00&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;02&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2025&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;09&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;01&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;15&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;00&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;00&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;02&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CONTEXT&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PL&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pgSQL&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;function&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;check_rent_datetime_validity&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;line&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;31&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;at&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;RAISE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;La fonction de contrôle remonte une erreur nous indiquant que la plage horaire n&amp;rsquo;est pas disponible&#xA;et la transaction est annulée.&lt;/p&gt;&#xA;&lt;p&gt;Après le test d&amp;rsquo;insertion, nous faisons un autre test, de mise à jour cette fois, en élargissant la période de la location &lt;code&gt;2&lt;/code&gt; (12:00 à 18:00) à 10:00-18:00 empiétant sur la location &lt;code&gt;1&lt;/code&gt; (09:00 à 11:00).&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;UPDATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rents_2_dates&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SET&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;start_datetime&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;test_day&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;interval&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;10 hour&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ERROR&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Cette&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;plage&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;horaire&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;n&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;est&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pas&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;disponible&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pour&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bike_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;7&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pour&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;la&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;période&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2025&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;09&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;01&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;10&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;00&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;00&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;02&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2025&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;09&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;01&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;18&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;00&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;00&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;02&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CONTEXT&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PL&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pgSQL&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;function&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;check_rent_datetime_validity&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;line&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;31&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;at&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;RAISE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Même phénomène que précédemment, le contrôle de la contrainte géré par la fonction annule la mise à jour et renvoie un message d&amp;rsquo;erreur avec le label défini.&lt;/p&gt;&#xA;&lt;h3 id=&#34;plage-de-dates-et-contraintes-dexclusion&#34;&gt;Plage de dates et contraintes d&amp;rsquo;exclusion&lt;/h3&gt;&#xA;&lt;p&gt;Utilisant le même principe, nous créons une table en remplaçant les deux&#xA;colonnes &lt;code&gt;date&lt;/code&gt; heure de début et de fin par une colonne de type&#xA;&lt;code&gt;range&lt;/code&gt;, ici un &lt;code&gt;TSTZRANGE&lt;/code&gt; :&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;CREATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;EXTENSION&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;btree_GiST&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;DROP&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;TABLE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;IF&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;EXISTS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rents_exclude&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CREATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;TABLE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rents_exclude&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;INT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;GENERATED&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;BY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;DEFAULT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;IDENTITY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;PRIMARY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;KEY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rent_dates&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TSTZRANGE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bike_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;INT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;EXCLUDE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;USING&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GiST&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rent_dates&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WITH&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bike_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;with&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;L&amp;rsquo;index créé est le suivant :&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;rents_exclude_rent_dates_bike_id_excl&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;   &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;EXCLUDE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;USING&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GiST&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rent_dates&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WITH&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bike_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WITH&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Nous avons un index multicolonne dont l&amp;rsquo;ordre est rent_dates, bike_id.&lt;/p&gt;&#xA;&lt;p&gt;Pourquoi devons-nous installer l&amp;rsquo;extension &lt;code&gt;btree_GiST&lt;/code&gt; ?&#xA;La liste des classes d&amp;rsquo;opérateurs pour un index &lt;code&gt;GiST&lt;/code&gt; est assez réduite :&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;index_method&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;opclass_name&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;indexed_type&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;is_default&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;--------------+----------------+---------------+------------&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;gist&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;         &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;box_ops&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;box&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;           &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;gist&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;         &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;circle_ops&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;     &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;circle&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;gist&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;         &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;multirange_ops&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;anymultirange&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;gist&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;         &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;point_ops&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;point&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;         &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;gist&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;         &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;poly_ops&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;       &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;polygon&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;       &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;gist&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;         &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;range_ops&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;anyrange&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;gist&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;         &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tsquery_ops&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tsquery&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;       &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;gist&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;         &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tsvector_ops&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;   &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tsvector&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;L&amp;rsquo;extension &lt;code&gt;btree_GiST&lt;/code&gt; fournit des classes d&amp;rsquo;opérateurs &lt;code&gt;GiST&lt;/code&gt; supplémentaires équivalentes à celui du Btree pour les types de données numériques, temporelles et texte.&#xA;Ces opérateurs sont donc utilisables par les index, ce qui permet d&amp;rsquo;affiner la contrainte d&amp;rsquo;exclusion.&#xA;Dans notre cas, en plus de la contrainte de chevauchement &lt;code&gt;&amp;amp;&amp;amp;&lt;/code&gt; sur la plage de date, on y rajoutera la contrainte de &lt;code&gt;bike_id&lt;/code&gt;.&lt;/p&gt;&#xA;&lt;p&gt;Passons à quelques tests d&amp;rsquo;insertion et validons le comportement d&amp;rsquo;exclusion.&#xA;Prenons le vélo &lt;code&gt;7&lt;/code&gt; n&amp;rsquo;ayant pas d&amp;rsquo;entrées dans la table &lt;code&gt;rent_exclude&lt;/code&gt;.&lt;/p&gt;&#xA;&lt;p&gt;Insérons deux locations : une le 2025-09-01 de 09:00 à 11:00 et une de 12:00 à 18:00.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;err&#34;&gt;\&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;set&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;test_day&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;#39;&amp;#39;2025-09-01&amp;#39;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;date&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INSERT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INTO&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rents_exclude&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rent_dates&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bike_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;VALUES&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TSTZRANGE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;test_day&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;interval&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;09 hour&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;test_day&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;interval&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;11 hour&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;7&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TSTZRANGE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;test_day&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;interval&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;12 hour&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;test_day&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;interval&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;18 hour&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;7&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;RETURNING&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;┌─────────┬─────────────────────────────────────────────────────┬─────────┐&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;│&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;   &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;│&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                     &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rent_dates&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                      &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;│&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bike_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;│&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;├─────────┼─────────────────────────────────────────────────────┼─────────┤&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;│&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;       &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;│&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;2025-09-01 09:00:00+02&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;2025-09-01 11:00:00+02&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;│&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;       &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;7&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;│&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;│&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;       &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;│&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;2025-09-01 12:00:00+02&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;2025-09-01 18:00:00+02&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;│&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;       &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;7&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;│&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;└─────────┴─────────────────────────────────────────────────────┴─────────┘&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Insérons une location pour le vélo &lt;code&gt;7&lt;/code&gt; sur une période déjà occupée (12:00 à 18:00) :&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;err&#34;&gt;\&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;set&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;test_day&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;#39;&amp;#39;2025-09-01&amp;#39;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;date&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INSERT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INTO&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rents_exclude&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rent_dates&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bike_id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;VALUES&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TSTZRANGE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;test_day&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;interval&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;11 hour&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;test_day&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;interval&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;17 hour&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;7&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ERROR&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;conflicting&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;key&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;value&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;violates&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;exclusion&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;constraint&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;rents_bike_id_rent_dates_excl&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;DETAIL&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;Key&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rent_dates&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bike_id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;7&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;2025-09-01 11:00:00+01&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;2025-09-01 17:00:00+01&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;conflicts&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;with&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;existing&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;key&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rent_dates&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bike_id&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;7&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;2025-09-01 12:00:00+01&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;2025-09-01 18:00:00+01&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)).&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Comme on le constate, une tentative d&amp;rsquo;insertion a échoué dans un&#xA;créneau déjà occupé pour le même &lt;code&gt;bike_id&lt;/code&gt; en raison&#xA;de la contrainte d&amp;rsquo;exclusion mise en place.&lt;/p&gt;&#xA;&lt;p&gt;Après le test d&amp;rsquo;insertion, nous faisons un autre test, de mise à jour cette fois, en élargissant la période de la location &lt;code&gt;2&lt;/code&gt; (12:00 à 18:00) à 10:00-18:00 en empiétant sur la location &lt;code&gt;1&lt;/code&gt; (09:00 à 11:00).&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;UPDATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rents_exclude&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;set&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rent_dates&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TSTZRANGE&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;test_day&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;interval&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;10 hour&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;test_day&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;interval&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;18 hour&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;where&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ERROR&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;conflicting&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;key&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;value&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;violates&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;exclusion&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;constraint&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;rents_rent_dates_bike_id_excl&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;DETAIL&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;Key&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rent_dates&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bike_id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;([&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;2025-09-01 10:00:00+02&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;2025-09-01 18:00:00+02&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;7&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;conflicts&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;with&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;existing&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;key&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rent_dates&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bike_id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;([&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;2025-09-01 09:00:00+02&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;2025-09-01 11:00:00+02&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;7&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;).&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;La transaction est annulée et un message d&amp;rsquo;erreur nous indique une violation de contrainte, car le créneau est déjà occupé pour le même &lt;code&gt;bike_id&lt;/code&gt;.&lt;/p&gt;&#xA;&lt;h3 id=&#34;plage-de-dates-et-la-clause-without-overlaps&#34;&gt;Plage de dates et la clause WITHOUT OVERLAPS&lt;/h3&gt;&#xA;&lt;p&gt;À présent, utilisons la nouvelle fonctionnalité &lt;a href=&#34;https://doc.postgresql.fr/18/sql-createtable.html#SQL-CREATETABLE-PARMS-UNIQUE&#34;&gt;&amp;ldquo;WITHOUT OVERLAPS&amp;rdquo;&lt;/a&gt;.&lt;/p&gt;&#xA;&lt;p&gt;Si cette option &lt;code&gt;WITHOUT OVERLAPS&lt;/code&gt; est spécifiée pour la dernière colonne, celle-ci est alors vérifiée pour les chevauchements plutôt que pour l&amp;rsquo;égalité.&#xA;Dans ce cas, les autres colonnes de la contrainte autorisent les doublons, à condition qu&amp;rsquo;ils ne se chevauchent pas dans la colonne WITHOUT OVERLAPS.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;CREATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;EXTENSION&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;btree_GiST&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CREATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;TABLE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rents_wo_overlaps&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;INT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;GENERATED&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;BY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;DEFAULT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;IDENTITY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;PRIMARY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;KEY&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rent_dates&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TSTZRANGE&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bike_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;INT&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;UNIQUE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bike_id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rent_dates&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WITHOUT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;OVERLAPS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Dans ce cas, l&amp;rsquo;index est le suivant :&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;rents_wo_overlaps_bike_id_rent_dates_key&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;UNIQUE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bike_id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rent_dates&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WITHOUT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;OVERLAPS&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;L&amp;rsquo;ordre des colonnes est différent de celui créé pour la table &lt;code&gt;rents_exclude&lt;/code&gt;, nous avons &lt;code&gt;bike_id&lt;/code&gt;, &lt;code&gt;rent_dates&lt;/code&gt;.&lt;/p&gt;&#xA;&lt;p&gt;Comme pour la contrainte d&amp;rsquo;exclusion un index de type &lt;code&gt;GiST&lt;/code&gt; est créé avec les mêmes types de contraintes.&#xA;Le comportement est donc le même que pour la table &lt;code&gt;rents_exclude&lt;/code&gt;.&lt;/p&gt;&#xA;&lt;h2 id=&#34;performance-et-taille-sur-le-disque&#34;&gt;Performance et taille sur le disque&lt;/h2&gt;&#xA;&lt;p&gt;Dans cette partie, nous allons contrôler les temps d&amp;rsquo;insertions avec des volumes conséquents,&#xA;le volume des index et analyser les temps d&amp;rsquo;exécution des requêtes.&lt;/p&gt;&#xA;&lt;h3 id=&#34;performance-en-insertion&#34;&gt;Performance en insertion&lt;/h3&gt;&#xA;&lt;p&gt;La création du jeu de données s&amp;rsquo;est effectuée de la façon suivante :&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;insertion de 1000 vélos de catégorie aléatoire ;&lt;/li&gt;&#xA;&lt;li&gt;création de trois locations par jour pour chaque vélo sur deux années calendaires.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;Ce qui produit une table avec 2 190 000 entrées.&lt;/p&gt;&#xA;&lt;p&gt;&lt;em&gt;Le jeu de test est produit et inséré sur un ordinateur de bureau avec la configuration par défaut de PostgreSQL.&lt;/em&gt;&lt;/p&gt;&#xA;&lt;p&gt;Vous pouvez trouver l&amp;rsquo;ensemble du jeu de test sur notre &lt;a href=&#34;https://gitlab.com/loxo-articles/without_overlaps/&#34;&gt;gitlab&lt;/a&gt;.&lt;/p&gt;&#xA;&lt;p&gt;Tout d&amp;rsquo;abord, comparons les vitesses d&amp;rsquo;insertions :&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Insertion dans la table &lt;code&gt;rents_2_dates&lt;/code&gt;, où le contrôle d&amp;rsquo;intégrité des données se fait par une fonction déclencheur :&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;set&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;track_functions&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;pl&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;select&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pg_stat_reset&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INSERT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INTO&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rents_2_dates&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INSERT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2190000&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Time&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;244937&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;342&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ms&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;04&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;04&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;937&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;&#xA;&lt;li&gt;Insertion dans la table &lt;code&gt;rents_exclude&lt;/code&gt;, où le contrôle d&amp;rsquo;intégrité des données se fait par contrainte d&amp;rsquo;exclusion :&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;INSERT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INTO&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rents_exclude&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INSERT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2190000&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Time&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;148393&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;870&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ms&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;02&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;28&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;394&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;&#xA;&lt;li&gt;Insertion dans la table &lt;code&gt;rents_wo_overlaps&lt;/code&gt;, où le contrôle d&amp;rsquo;intégrité des données se fait par contrainte d&amp;rsquo;exclusion et clause &lt;code&gt;WITHOUT OVERLAPS&lt;/code&gt; :&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;INSERT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INTO&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rents_wo_overlaps&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INSERT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2190000&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Time&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;119230&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;806&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ms&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;01&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;59&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;231&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Les opérations d’insertion sont plus performantes avec le type range, dans la mesure où le contrôle d’intégrité est assuré directement par la contrainte d’exclusion.&#xA;En revanche, dans la table &lt;code&gt;rents_2_date&lt;/code&gt;, ce contrôle est effectué par un déclencheur qui vérifie pour chaque ligne insérée ou mise à jour,&#xA;l’absence de tout chevauchement avec les enregistrements existants.&lt;/p&gt;&#xA;&lt;p&gt;Il est possible d&amp;rsquo;obtenir certaines informations sur le temps d&amp;rsquo;exécution de la fonction grâce à la vue&#xA;&lt;code&gt;pg_stat_user_functions&lt;/code&gt;. Pour cela, il faut activer le paramètre &lt;code&gt;track_functions&lt;/code&gt; dans la configuration de l&amp;rsquo;instance.&lt;/p&gt;&#xA;&lt;p&gt;Dans notre cas, nous avons activé le traçage sur les fonctions &lt;code&gt;PL/pgSQL&lt;/code&gt; dans la transaction d&amp;rsquo;insertion des données via la commande :&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;set&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;track_functions&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;pl&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Après l&amp;rsquo;import des données, voici les informations :&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;select&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;funcname&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;calls&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;self_time&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;||&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39; milliseconds&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;interval&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;as&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;self_time&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;from&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pg_stat_user_functions&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;┌──────────────────────────────┬─────────┬─────────────────┐&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;│&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;           &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;funcname&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;           &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;│&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;calls&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;│&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;self_time&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;│&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;├──────────────────────────────┼─────────┼─────────────────┤&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;│&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;check_rent_datetime_validity&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;│&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2190000&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;│&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;00&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;03&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;51&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;925302&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;│&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;└──────────────────────────────┴─────────┴─────────────────┘&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Le temps total d&amp;rsquo;insertion est de 04 min 05s. 03 min 52s sont occupées par&#xA;le traitement de la fonction, soit plus de 90% du temps.&lt;/p&gt;&#xA;&lt;h3 id=&#34;volume-des-index&#34;&gt;Volume des index&lt;/h3&gt;&#xA;&lt;p&gt;L&amp;rsquo;index &lt;code&gt;GiST&lt;/code&gt; est une structure arborescente équilibrée comme le &lt;code&gt;Btree&lt;/code&gt; contenant&#xA;des paires &lt;code&gt;clé, pointeur&lt;/code&gt;, mais les clés &lt;code&gt;GiST&lt;/code&gt; sont plus complexes qu&amp;rsquo;un &lt;code&gt;Btree&lt;/code&gt;,&#xA;ce qui amène un volume plus important.&lt;/p&gt;&#xA;&lt;p&gt;D&amp;rsquo;un côté, les tables &lt;code&gt;rents_exclude&lt;/code&gt; et &lt;code&gt;rents_wo_overlaps&lt;/code&gt; disposent d&amp;rsquo;un seul index &lt;code&gt;GiST&lt;/code&gt; spécifique pour le range :&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;rents_pkey&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;PRIMARY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;KEY&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;btree&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;rents_bike_id_rent_dates_excl&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;EXCLUDE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;USING&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GiST&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rent_dates&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WITH&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bike_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WITH&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;De l&amp;rsquo;autre, la table &lt;code&gt;rents_2_dates&lt;/code&gt; avec trois index de type &lt;code&gt;Btree&lt;/code&gt; :&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;rents_2_dates_pkey&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;PRIMARY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;KEY&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;btree&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;rent2dates_end_datetime_idx&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;btree&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;end_datetime&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;rent2dates_start_datetime_idx&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;btree&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tart_datetime&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;rent2dates_bike_id_idx&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;btree&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;stat_datetime&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;On trouve ci-dessous un tableau donnant par table le volume des données et le volume des index :&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;┌─────────────────────────────────────┬────────────┬──────────────┬────────────┐&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;│             table_name              │ table_size │ indexes_size │ total_size │&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;├─────────────────────────────────────┼────────────┼──────────────┼────────────┤&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;│ &lt;span class=&#34;s2&#34;&gt;&amp;#34;ams_rent_bike&amp;#34;&lt;/span&gt;.&lt;span class=&#34;s2&#34;&gt;&amp;#34;rents_exclude&amp;#34;&lt;/span&gt;     │ &lt;span class=&#34;m&#34;&gt;126&lt;/span&gt; MB     │ &lt;span class=&#34;m&#34;&gt;222&lt;/span&gt; MB       │ &lt;span class=&#34;m&#34;&gt;348&lt;/span&gt; MB     │&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;│ &lt;span class=&#34;s2&#34;&gt;&amp;#34;ams_rent_bike&amp;#34;&lt;/span&gt;.&lt;span class=&#34;s2&#34;&gt;&amp;#34;rents_2_dates&amp;#34;&lt;/span&gt;     │ &lt;span class=&#34;m&#34;&gt;126&lt;/span&gt; MB     │ &lt;span class=&#34;m&#34;&gt;97&lt;/span&gt; MB        │ &lt;span class=&#34;m&#34;&gt;223&lt;/span&gt; MB     │&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;│ &lt;span class=&#34;s2&#34;&gt;&amp;#34;ams_rent_bike&amp;#34;&lt;/span&gt;.&lt;span class=&#34;s2&#34;&gt;&amp;#34;rents_wo_overlaps&amp;#34;&lt;/span&gt; │ &lt;span class=&#34;m&#34;&gt;126&lt;/span&gt; MB     │ &lt;span class=&#34;m&#34;&gt;229&lt;/span&gt; MB       │ &lt;span class=&#34;m&#34;&gt;354&lt;/span&gt; MB     │&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;└─────────────────────────────────────┴────────────┴──────────────┴────────────┘&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Voyons maintenant le volume de chaque index :&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;┌───────────────────┬──────────────────────────────────────────┬────────────┬────────┬─────────────────────┐&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;│     rel_name      │                index_name                │ type_index │  size  │       columns       │&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;├───────────────────┼──────────────────────────────────────────┼────────────┼────────┼─────────────────────┤&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;│ rents_wo_overlaps │ rents_wo_overlaps_bike_id_rent_dates_key │ GiST       │ &lt;span class=&#34;m&#34;&gt;182&lt;/span&gt; MB │ rent_dates, bike_id │&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;│ rents_exclude     │ rents_exclude_rent_dates_bike_id_excl    │ GiST       │ &lt;span class=&#34;m&#34;&gt;173&lt;/span&gt; MB │ rent_dates, bike_id │&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;│ rents_2_dates     │ rent2dates_start_datetime_idx            │ btree      │ &lt;span class=&#34;m&#34;&gt;17&lt;/span&gt; MB  │ start_datetime      │&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;│ rents_2_dates     │ rent2dates_end_datetime_idx              │ btree      │ &lt;span class=&#34;m&#34;&gt;17&lt;/span&gt; MB  │ end_datetime        │&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;│ rents_2_dates     │ rent2dates_bike_id_idx                   │ btree      │ &lt;span class=&#34;m&#34;&gt;16&lt;/span&gt; MB  │ bike_id             │&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;└───────────────────┴──────────────────────────────────────────┴────────────┴────────┴─────────────────────┘&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Dans notre cas, nous comparons le volume de la somme des trois index &lt;code&gt;btree&lt;/code&gt; liés au stockage sur 2&#xA;colonnes avec le volume de l&amp;rsquo;index &lt;code&gt;GiST&lt;/code&gt; de la contrainte d&amp;rsquo;exclusion et avec l&amp;rsquo;index &lt;code&gt;GisT&lt;/code&gt; de la&#xA;contrainte d&amp;rsquo;unicité (qui utilise &lt;code&gt;WITHOUT OVERLAPS&lt;/code&gt;).&#xA;Comme nous l&amp;rsquo;avons indiqué plus haut, la clé dans ce dernier cas contient à la fois les données de la plage de date et le &lt;code&gt;bike_id&lt;/code&gt;.&lt;/p&gt;&#xA;&lt;p&gt;Le volume est différent entre les index &lt;code&gt;GiST&lt;/code&gt; car l&amp;rsquo;ordre des colonnes n&amp;rsquo;est pas le même.&#xA;On s&amp;rsquo;aperçoit également que chaque index &lt;code&gt;GiST&lt;/code&gt; est 3x plus volumineux que la somme des 3 index &lt;code&gt;Btree&lt;/code&gt;.&lt;/p&gt;&#xA;&lt;h2 id=&#34;performance-de-recherche&#34;&gt;Performance de recherche&lt;/h2&gt;&#xA;&lt;p&gt;Voyons à présent une mise en situation. Nous souhaitons connaître les disponibilités des vélos sur une journée donnée.&lt;/p&gt;&#xA;&lt;p&gt;Vous trouverez les requêtes dans les liens suivants :&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://gitlab.com/loxo-articles/without_overlaps/-/raw/main/queries/available_with_range_exclude.sql&#34;&gt;available_with_range_exclude.sql&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://gitlab.com/loxo-articles/without_overlaps/-/raw/main/queries/available_with_range_without_overlaps.sql&#34;&gt;available_with_range_without_overlaps.sql&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://gitlab.com/loxo-articles/without_overlaps/-/raw/main/queries/available_with_2_dates.sql&#34;&gt;available_with_2_dates.sql&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;Les structures des requêtes sont assez proches les unes des autres ; leur but est de&#xA;contrôler le bon usage des index et de comparer les temps des réponses.&lt;/p&gt;&#xA;&lt;p&gt;En ce qui concerne les performances, l&amp;rsquo;avantage est donné à l&amp;rsquo;utilisation de deux colonnes.&lt;/p&gt;&#xA;&lt;!-- raw HTML omitted --&gt;&#xA;&lt;table&gt;&#xA;&lt;thead&gt;&#xA;&lt;tr&gt;&#xA;&lt;th&gt;Table&lt;/th&gt;&#xA;&lt;th&gt;Temps&lt;/th&gt;&#xA;&lt;/tr&gt;&#xA;&lt;/thead&gt;&#xA;&lt;tbody&gt;&#xA;&lt;tr&gt;&#xA;&lt;td&gt;&lt;code&gt;rents_2_dates&lt;/code&gt;&lt;/td&gt;&#xA;&lt;td&gt;&lt;strong&gt;10 ms&lt;/strong&gt;&lt;/td&gt;&#xA;&lt;/tr&gt;&#xA;&lt;tr&gt;&#xA;&lt;td&gt;&lt;code&gt;rents_exclude&lt;/code&gt;&lt;/td&gt;&#xA;&lt;td&gt;&lt;strong&gt;15 ms&lt;/strong&gt;&lt;/td&gt;&#xA;&lt;/tr&gt;&#xA;&lt;tr&gt;&#xA;&lt;td&gt;&lt;code&gt;rents_wo_overlaps&lt;/code&gt;&lt;/td&gt;&#xA;&lt;td&gt;&lt;strong&gt;30 ms&lt;/strong&gt;&lt;/td&gt;&#xA;&lt;/tr&gt;&#xA;&lt;/tbody&gt;&#xA;&lt;/table&gt;&#xA;&lt;p&gt;La différence de temps entre &lt;code&gt;rents_exclude&lt;/code&gt; et &lt;code&gt;rents_wo_overlaps&lt;/code&gt; est dû a l&amp;rsquo;ordre des colonnes dans l&amp;rsquo;index.&lt;/p&gt;&#xA;&lt;p&gt;Vous pouvez trouver les résultats des &lt;code&gt;EXPLAIN (ANALYSE, buffers)&lt;/code&gt; ici :&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://gitlab.com/loxo-articles/without_overlaps/-/raw/main/explain_analyse/available_period_with_2_dates.txt&#34;&gt;available_period_with_2_dates.txt&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://gitlab.com/loxo-articles/without_overlaps/-/raw/main/explain_analyse/available_period_with_range_exclude.txt&#34;&gt;available_period_with_range_exclude.txt&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://gitlab.com/loxo-articles/without_overlaps/-/raw/main/explain_analyse/available_period_with_range_without_overlaps.txt&#34;&gt;available_period_with_range_without_overlaps.txt&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;Prenons un autre exemple, la liste des réservations pour une liste de vélos sur une période donnée :&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;err&#34;&gt;\&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;set&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;search_range&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TSTZRANGE&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;#39;&amp;#39;2025-09-01&amp;#39;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;date&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;interval&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;#39;&amp;#39;09 hour&amp;#39;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;#39;&amp;#39;2025-09-01&amp;#39;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;date&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;interval&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;#39;&amp;#39; 20 hour&amp;#39;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;EXPLAIN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;ANALYSE&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;BUFFERS&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rents&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rent_dates&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;search_range&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AND&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bike_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;100&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;\&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;set&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;vstart_datetime&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;#39;&amp;#39;2025-09-01&amp;#39;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;date&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;interval&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;#39;&amp;#39;09 hour&amp;#39;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;\&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;set&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;vend_datetime&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;#39;&amp;#39;2025-09-01&amp;#39;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;date&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;interval&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;#39;&amp;#39;20 hour&amp;#39;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;EXPLAIN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;ANALYSE&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;BUFFERS&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rents_2_dates&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;start_datetime&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;BETWEEN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;vstart_datetime&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AND&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;vend_datetime&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;OR&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;     &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;end_datetime&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;BETWEEN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;vstart_datetime&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AND&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;vend_datetime&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AND&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bike_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;100&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Dans ce cas, la lecture des plans d&amp;rsquo;exécutions nous indique que, pour l&amp;rsquo;interrogation des données dans la table &lt;code&gt;rents_2_dates&lt;/code&gt;, PostgreSQL parcourt trois index :&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;code&gt;rent2dates_start_datetime_idx&lt;/code&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;code&gt;rent2dates_end_datetime_idx&lt;/code&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;code&gt;rent2dates_bike_id_idx&lt;/code&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;Ces informations sont visibles dans le fichier &lt;a href=&#34;https://gitlab.com/loxo-articles/without_overlaps/-/raw/main/explain_analyse/rents_for_period_some_bikes_2_dates.txt?ref_type=heads&#34;&gt;rents_for_period_some_bikes_2_dates.txt&lt;/a&gt;.&lt;/p&gt;&#xA;&lt;p&gt;Pour la recherche dans la table &lt;code&gt;rents_exclude&lt;/code&gt;, il n&amp;rsquo;y a qu&amp;rsquo;un parcours d&amp;rsquo;index :&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;code&gt;rents_bike_id_rent_dates_excl&lt;/code&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;Ces informations sont visibles dans le fichier &lt;a href=&#34;https://gitlab.com/loxo-articles/without_overlaps/-/raw/main/explain_analyse/rents_for_period_some_bikes_range_exclude.txt?ref_type=heads&#34;&gt;rents_for_period_some_bikes_range_exclude.txt&lt;/a&gt;.&lt;/p&gt;&#xA;&lt;p&gt;De plus, nous pouvons constater que moins de blocs de données sont lus.&lt;/p&gt;&#xA;&lt;p&gt;Pour la recherche dans la table &lt;code&gt;rents_wo_overlaps&lt;/code&gt;, il n&amp;rsquo;y a qu&amp;rsquo;un parcours d&amp;rsquo;index :&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;code&gt;rents_wo_overlaps_bike_id_rent_dates_key&lt;/code&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;Ces informations sont visibles dans le fichier &lt;a href=&#34;https://gitlab.com/loxo-articles/without_overlaps/-/raw/main/rents_for_period_some_bikes_range_without_overlaps.txt?ref_type=heads&#34;&gt;rents_for_period_some_bikes_range_exclude.txt&lt;/a&gt;.&lt;/p&gt;&#xA;&lt;p&gt;Dans notre exemple avec une clause where &lt;code&gt;bike_id &amp;lt; 100&lt;/code&gt;, le résultat est le suivant :&lt;/p&gt;&#xA;&lt;table&gt;&#xA;&lt;thead&gt;&#xA;&lt;tr&gt;&#xA;&lt;th&gt;Table&lt;/th&gt;&#xA;&lt;th&gt;Temps&lt;/th&gt;&#xA;&lt;/tr&gt;&#xA;&lt;/thead&gt;&#xA;&lt;tbody&gt;&#xA;&lt;tr&gt;&#xA;&lt;td&gt;&lt;code&gt;rents_2_dates&lt;/code&gt;&lt;/td&gt;&#xA;&lt;td&gt;&lt;strong&gt;8 ms&lt;/strong&gt;&lt;/td&gt;&#xA;&lt;/tr&gt;&#xA;&lt;tr&gt;&#xA;&lt;td&gt;&lt;code&gt;rents_exlude&lt;/code&gt;&lt;/td&gt;&#xA;&lt;td&gt;&lt;strong&gt;0.7 ms&lt;/strong&gt;&lt;/td&gt;&#xA;&lt;/tr&gt;&#xA;&lt;tr&gt;&#xA;&lt;td&gt;&lt;code&gt;rents_wo_overlaps&lt;/code&gt;&lt;/td&gt;&#xA;&lt;td&gt;&lt;strong&gt;4 ms&lt;/strong&gt;&lt;/td&gt;&#xA;&lt;/tr&gt;&#xA;&lt;/tbody&gt;&#xA;&lt;/table&gt;&#xA;&lt;p&gt;En regardant de plus près le plan d&amp;rsquo;exécution, une piste d&amp;rsquo;amélioration sur la requête avec deux dates serait d&amp;rsquo;ajouter un index sur les trois colonnes &lt;code&gt;start_datetime&lt;/code&gt;, &lt;code&gt;end_datetime&lt;/code&gt;, &lt;code&gt;bike_id&lt;/code&gt;.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;CREATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INDEX&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rent2dates_start_end_bike_id_idx&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;ON&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rents_2_dates&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;USING&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;btree&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;start_datetime&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;end_datetime&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bike_id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Effectivement le temps d&amp;rsquo;exécution est amélioré, car la requête répond en 1.7ms.&#xA;Néanmoins, dans ce cas, l&amp;rsquo;index ajoute un volume de 85Mo.&lt;/p&gt;&#xA;&lt;p&gt;Voir le fichier &lt;a href=&#34;https://gitlab.com/loxo-articles/type-range/blob/master/explain_analyse/rents_for_period_some_bikes_2_date_optim.txt&#34;&gt;rents_for_period_some_bikes_2_date_optim.txt&lt;/a&gt;.&lt;/p&gt;&#xA;&lt;p&gt;Idem pour la table &lt;code&gt;rents_wo_overlaps&lt;/code&gt; en créant un index GiST (rent_dates, bike_id).&lt;/p&gt;&#xA;&lt;p&gt;Voici le plan &lt;a href=&#34;https://gitlab.com/loxo-articles/type-range/blob/master/explain_analyse/rents_for_period_some_bikes_range_wo_overlaps_optim.txt&#34;&gt;d&amp;rsquo;execution&lt;/a&gt;.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;CREATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INDEX&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rents_wo_overlaps_rents_date_bike_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;ON&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rents_wo_overlaps&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;USING&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GiST&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;rent_dates&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bike_id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Le temps d&amp;rsquo;exécution est de 0.5ms contre 4ms, mais nous rajoutons un index de 112 Mo.&lt;/p&gt;&#xA;&lt;p&gt;Après l&amp;rsquo;ajout des index, nous avons les temps suivants :&lt;/p&gt;&#xA;&lt;table&gt;&#xA;&lt;thead&gt;&#xA;&lt;tr&gt;&#xA;&lt;th&gt;Table&lt;/th&gt;&#xA;&lt;th&gt;Temps&lt;/th&gt;&#xA;&lt;/tr&gt;&#xA;&lt;/thead&gt;&#xA;&lt;tbody&gt;&#xA;&lt;tr&gt;&#xA;&lt;td&gt;&lt;code&gt;rents_2_dates&lt;/code&gt;&lt;/td&gt;&#xA;&lt;td&gt;&lt;strong&gt;1.7 ms&lt;/strong&gt;&lt;/td&gt;&#xA;&lt;/tr&gt;&#xA;&lt;tr&gt;&#xA;&lt;td&gt;&lt;code&gt;rents_exlude&lt;/code&gt;&lt;/td&gt;&#xA;&lt;td&gt;&lt;strong&gt;0.7 ms&lt;/strong&gt;&lt;/td&gt;&#xA;&lt;/tr&gt;&#xA;&lt;tr&gt;&#xA;&lt;td&gt;&lt;code&gt;rents_wo_overlaps&lt;/code&gt;&lt;/td&gt;&#xA;&lt;td&gt;&lt;strong&gt;0.5ms&lt;/strong&gt;&lt;/td&gt;&#xA;&lt;/tr&gt;&#xA;&lt;/tbody&gt;&#xA;&lt;/table&gt;&#xA;&lt;h2 id=&#34;conclusion&#34;&gt;Conclusion&lt;/h2&gt;&#xA;&lt;p&gt;La gestion des chevauchements temporels est un sujet qui peut devenir un vrai casse-tête lorsqu’il s’agit de modéliser des réservations, des plannings ou des périodes de validité.&#xA;Le type range facilite la manipulation des données.&lt;/p&gt;&#xA;&lt;p&gt;Il apporte notamment un avantage indéniable : le contrôle de l&amp;rsquo;intégrité des données, entièrement géré par la base de données.&#xA;Même si l&amp;rsquo;utilisation du type &lt;code&gt;TSTZRANGE&lt;/code&gt; ne semble pas naturelle de prime abord,&#xA;nous pouvons observer qu&amp;rsquo;une fois mis en place, ce type et les index &lt;code&gt;GiST&lt;/code&gt; proposent un ensemble concis et élégant à l&amp;rsquo;utilisation.&lt;/p&gt;&#xA;&lt;p&gt;La nouvelle fonctionnalité &lt;code&gt;WITHOUT OVERLAPS&lt;/code&gt; apporte une écriture simplifiée mais impose que la contrainte de non-chevauchement se trouve sur la dernière colonne.&#xA;Dans notre cas, nous avons dû créer un autre index composite avec une meilleure sélectivité sur les premières colonnes.&lt;/p&gt;&#xA;&lt;p&gt;En ce qui concerne les tests de performance en insertion, l&amp;rsquo;avantage est en faveur du type range. La contrainte d&amp;rsquo;exclusion étant intégrée, elle rend l&amp;rsquo;opération 2,4 fois plus rapide.&lt;/p&gt;&#xA;&lt;p&gt;Le volume sur disque d&amp;rsquo;un index GiST est deux à trois fois plus volumineux que la somme des trois index Btree de notre exemple.&lt;/p&gt;&#xA;&lt;p&gt;Pour l&amp;rsquo;exécution des requêtes, nous avons testé deux profils de requête : un complexe (CTE, jointure, etc.) et un plus simple (un &lt;code&gt;WHERE&lt;/code&gt; dans la table de location).&#xA;On se rend compte qu&amp;rsquo;il n&amp;rsquo;y a pas de grandes différences sur les temps d&amp;rsquo;exécution.&lt;/p&gt;</summary>
    <author>
      <name>Loxodata</name>
    </author>
  </entry>
  <entry>
    <title>Meetups PostgreSQL à Toulouse : c&#39;est reparti !</title>
    <updated>2025-10-10T13:11:00Z</updated>
    <id>tag:www.loxodata.com,2025-10-10:/post/meetup-toulouse-2025-10/</id>
    <link href="http://www.loxodata.com/post/meetup-toulouse-2025-10/" rel="alternate"></link>
    <summary type="html">&lt;h2 id=&#34;meetup-pg_ctl-restart--d-toulouse&#34;&gt;Meetup &lt;code&gt;pg_ctl restart -D Toulouse&lt;/code&gt;&lt;/h2&gt;&#xA;&lt;p&gt;Par le passé, des meetups PostgreSQL ont eu lieu à Toulouse.&#xA;L&amp;rsquo;initiative s&amp;rsquo;est essoufflée et la pandémie est passée par là.&lt;/p&gt;&#xA;&lt;p&gt;Mais&#xA;en novembre 2025, au &lt;a href=&#34;../feedback-cdl-2024&#34;&gt;Capitole du Libre&lt;/a&gt;,&#xA;Geoffrey de &lt;a href=&#34;https://pictarine.com&#34;&gt;Pictarine&lt;/a&gt; est venu vers moi après&#xA;une conférence en évoquant la possibilité de relancer cette&#xA;initiative. J&amp;rsquo;ai dit « banco! ».&lt;/p&gt;&#xA;&lt;p&gt;En juin, Pictarine nous donnait son&#xA;feu vert pour effectuer cette rencontre dans leurs locaux à Labège&#xA;Innopole, et nous nous sommes lancés dans l&amp;rsquo;organisation de&#xA;l&amp;rsquo;événement.&lt;/p&gt;&#xA;&lt;p&gt;Pour cela, nous avions, Geoffrey et moi, chacun un sujet :&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Geoffrey a proposé une présentation de la migration de 10 années de&#xA;business de Datastore vers PostgreSQL. Il y explique les enjeux,&#xA;la stratégie et les enseignements de cet exercice qui fut un succès&#xA;pour Pictarine ;&lt;/li&gt;&#xA;&lt;li&gt;Pour ma part, j&amp;rsquo;ai présenté les grandes nouveautés de PostgreSQL&#xA;18 (dont le support peut être &lt;a href=&#34;http://www.loxodata.com/downloads/slides/2025-10-09-Quoi-de-neuf-dans-postgresql-18.pdf&#34;&gt;téléchargé&#xA;ici&lt;/a&gt;).&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;Pour une reprise, c&amp;rsquo;est une réussite : 22 fans de PostgreSQL ont&#xA;participé à l&amp;rsquo;événement !&lt;/p&gt;&#xA;&lt;p&gt;Après une brève&#xA;&lt;a href=&#34;http://www.loxodata.com/downloads/slides/2025-10-09-meetup-tls-intro.pdf&#34;&gt;introduction&lt;/a&gt; sur&#xA;le déroulement du meetup, Geoffrey avons enchaîné nos présentations.&#xA;La soirée s&amp;rsquo;est terminée par un apéritif dînatoire avec des&#xA;discussions sur l&amp;rsquo;utilisation de notre SGBD préféré. Nous avons&#xA;également parlé de pouvoir participer au &lt;a href=&#34;https://devfesttoulouse.fr/&#34;&gt;DevFest&#xA;Toulouse&lt;/a&gt; cette année. De nombreuses&#xA;connexions se sont créées lors de cet événement.&lt;/p&gt;&#xA;&lt;p&gt;Je tiens à remercier encore une fois Pictarine d&amp;rsquo;avoir rendu ce&#xA;meetup possible en nous proposant ses locaux et en sponsorisant&#xA;l&amp;rsquo;apéritif dînatoire.&lt;/p&gt;&#xA;&lt;p&gt;Nous nous sommes entendus pour organiser le prochain meetup dans le&#xA;courant du mois de janvier 2026.&lt;/p&gt;</summary>
    <author>
      <name>Loxodata</name>
    </author>
  </entry>
  <entry>
    <title>Restauration Point-In-Time d’un cluster Patroni avec pgBackRest</title>
    <updated>2025-10-02T06:00:00Z</updated>
    <id>tag:www.loxodata.com,2025-10-02:/post/pitr-with-patroni/</id>
    <link href="http://www.loxodata.com/post/pitr-with-patroni/" rel="alternate"></link>
    <summary type="html">&lt;h1 id=&#34;restauration-point-in-time-dun-cluster-patroni-avec-pgbackrest&#34;&gt;Restauration Point-In-Time d’un cluster Patroni avec pgBackRest&lt;/h1&gt;&#xA;&lt;p&gt;Dans un &lt;a href=&#34;../logical-replication-with-patroni/&#34;&gt;article précédent&lt;/a&gt;, nous avons vu comment mettre en place une réplication logique avec &lt;strong&gt;Patroni&lt;/strong&gt;. Nous allons voir les méthodes de  &lt;strong&gt;restauration à un instant donné&lt;/strong&gt; (PITR - Point-In-Time Recovery) avec ce même outil.&lt;/p&gt;&#xA;&lt;p&gt;Grâce à l’intégration de &lt;strong&gt;pgBackRest&lt;/strong&gt; et &lt;strong&gt;Patroni&lt;/strong&gt;, il est possible de reconstruire proprement un cluster en cas de suppression ou corruption de données — tout en remontant précisément à une date ou une transaction cible.&lt;/p&gt;&#xA;&lt;h2 id=&#34;prérequis-pour-la-restauration-pitr&#34;&gt;Prérequis pour la restauration PITR&lt;/h2&gt;&#xA;&lt;p&gt;Avant toute tentative de restauration temporelle, assurez-vous que :&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;strong&gt;pgBackRest est correctement configuré&lt;/strong&gt; ;&lt;/li&gt;&#xA;&lt;li&gt;&lt;strong&gt;L’archivage des WAL est activé&lt;/strong&gt; ;&lt;/li&gt;&#xA;&lt;li&gt;&lt;strong&gt;Au moins une sauvegarde complète est disponible&lt;/strong&gt;.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;hr&gt;&#xA;&lt;h2 id=&#34;mise-en-situation--suppression-de-données&#34;&gt;Mise en situation : suppression de données&lt;/h2&gt;&#xA;&lt;p&gt;Créons une base de test et insérons quelques lignes dans une table :&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;CREATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;DATABASE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pitr_test&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;\&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;c&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pitr_test&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CREATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;TABLE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mytable&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;INT&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;payload&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;TEXT&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;inserted_at&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;TIMESTAMP&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;DEFAULT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;now&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INSERT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INTO&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mytable&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;n&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;text_&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;||&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;n&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;generate_series&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;10&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;n&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mytable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Résultat :&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt; id | payload |        inserted_at&#xA;----+---------+---------------------------&#xA;  0 | text_0  | 2025-07-21 09:14:15.78179&#xA;...&#xA; 10 | text_10 | 2025-07-21 09:14:15.78179&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;La transaction d’insertion est identifiable via le champ &lt;code&gt;xmin&lt;/code&gt; :&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xmin&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;xmax&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mytable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt; xmin | xmax | id | payload | inserted_at&#xA;------+-------+----+---------+----------------------------&#xA;  752 |     0 |  0 | text_0  | 2025-07-21 09:14:15.78179&#xA;...&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Supposons qu’une action destructive intervienne :&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;TRUNCATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mytable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;On force ensuite l&amp;rsquo;écriture des journaux de transaction pour garantir leur archivage :&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pg_switch_wal&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;now&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;hr&gt;&#xA;&lt;h2 id=&#34;étapes-de-restauration&#34;&gt;Étapes de restauration&lt;/h2&gt;&#xA;&lt;p&gt;Nous vous proposons deux méthodes afin de restaurer vos instances à la cible&#xA;voulue.&lt;/p&gt;&#xA;&lt;h3 id=&#34;méthode-1--restauration-manuelle-du-primaire&#34;&gt;Méthode 1 : restauration manuelle du primaire&lt;/h3&gt;&#xA;&lt;h4 id=&#34;1-identifier-le-nœud-primaire&#34;&gt;1. Identifier le nœud primaire&lt;/h4&gt;&#xA;&lt;p&gt;Dans notre exemple, le primaire est &lt;code&gt;pgdeb01&lt;/code&gt;.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;patronictl -c /etc/patroni/config.yml topology&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;+ Cluster: loxodemo &lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;7427142939826752414&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt; ------+----+-----------+&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; Member    &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; Host        &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; Role    &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; State     &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; TL &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; Lag in MB &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;+-----------+-------------+---------+-----------+----+-----------+&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; pgdeb01   &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; 10.200.0.11 &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; Leader  &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; running   &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;  &lt;span class=&#34;m&#34;&gt;3&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;           &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; + pgdeb02 &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; 10.200.0.12 &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; Replica &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; streaming &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;  &lt;span class=&#34;m&#34;&gt;3&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;         &lt;span class=&#34;m&#34;&gt;0&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; + pgdeb03 &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; 10.200.0.13 &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; Replica &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; streaming &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;  &lt;span class=&#34;m&#34;&gt;3&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;         &lt;span class=&#34;m&#34;&gt;0&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;+-----------+-------------+---------+-----------+----+-----------+&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;2-stopper-patroni-sur-les-réplicas&#34;&gt;2. Stopper Patroni sur les réplicas&lt;/h4&gt;&#xA;&lt;p&gt;Dans notre exemple, sur &lt;code&gt;pgdeb02&lt;/code&gt; et &lt;code&gt;pgdeb03&lt;/code&gt;.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;systemctl stop patroni&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;3-stopper-patroni-sur-le-primaire&#34;&gt;3. Stopper Patroni sur le primaire&lt;/h4&gt;&#xA;&lt;p&gt;Une fois arrêté, le cluster doit apparaître vide :&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;patronictl -c /etc/patroni/config.yml topology&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;+ Cluster: loxodemo &lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;7427142939826752414&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt; ------+&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; Member &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; Host &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; Role &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; State &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; TL &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; Lag in MB &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;+--------+------+------+-------+----+-----------+&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;+--------+------+------+-------+----+-----------+&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;4-restaurer-les-données-sur-le-futur-primaire&#34;&gt;4. Restaurer les données sur le futur primaire&lt;/h4&gt;&#xA;&lt;p&gt;On peut choisir n&amp;rsquo;importe quel nœud du cluster patroni pour effectuer cette opération.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;pgbackrest --stanza&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;loxodemo --delta restore &lt;span class=&#34;se&#34;&gt;\&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;  --type&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;time&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;  --target&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;2025-07-21 09:14:16.78179+00&amp;#34;&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;  --target-action&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;promote&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;5-lancer-postgresql-localement-sans-patroni&#34;&gt;5. Lancer PostgreSQL localement (sans Patroni)&lt;/h4&gt;&#xA;&lt;p&gt;Cette opération s&amp;rsquo;effectue toujours sur le futur primaire.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;su - postgres -c &lt;span class=&#34;s2&#34;&gt;&amp;#34;/usr/lib/postgresql/16/bin/postgres -D /data/postgres/loxodemo ...&amp;#34;&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;6-vérifier-les-logs-de-postgresql&#34;&gt;6. Vérifier les logs de PostgreSQL&lt;/h4&gt;&#xA;&lt;p&gt;Extrait typique indiquant la fin de la restauration :&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;recovery stopping before commit of transaction 753&#xA;last completed transaction was at log time 2025-07-21 09:14:15.792863+00&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;h4 id=&#34;7-vérifier-les-données-restaurées&#34;&gt;7. Vérifier les données restaurées&lt;/h4&gt;&#xA;&lt;p&gt;Dans un autre terminal, lancez &lt;code&gt;psql&lt;/code&gt; sur la base à vérifier.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;n&#34;&gt;pitr_test&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=#&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;select&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;from&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mytable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;payload&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;inserted_at&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;----+---------+---------------------------&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;text_0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2025&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;07&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;21&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;09&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;14&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;15&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;78179&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;text_1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2025&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;07&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;21&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;09&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;14&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;15&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;78179&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;text_2&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2025&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;07&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;21&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;09&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;14&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;15&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;78179&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;text_3&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2025&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;07&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;21&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;09&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;14&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;15&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;78179&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;text_4&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2025&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;07&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;21&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;09&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;14&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;15&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;78179&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;5&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;text_5&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2025&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;07&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;21&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;09&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;14&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;15&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;78179&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;6&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;text_6&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2025&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;07&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;21&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;09&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;14&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;15&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;78179&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;7&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;text_7&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2025&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;07&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;21&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;09&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;14&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;15&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;78179&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;8&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;text_8&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2025&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;07&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;21&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;09&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;14&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;15&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;78179&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;9&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;text_9&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2025&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;07&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;21&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;09&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;14&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;15&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;78179&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;10&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;text_10&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2025&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;07&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;21&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;09&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;14&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;15&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;78179&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;11&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Les données insérées à &lt;code&gt;09:14:15&lt;/code&gt; sont bien présentes, la suppression ayant eu lieu après.&lt;/p&gt;&#xA;&lt;p&gt;Forcer l’écriture des journaux de transaction.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;select&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pg_switch_wal&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pg_switch_wal&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;---------------&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;100072&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;D0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;8-stopper-postgresql-localement&#34;&gt;8. Stopper PostgreSQL localement&lt;/h4&gt;&#xA;&lt;h4 id=&#34;9-redémarrer-patroni-sur-le-primaire-choisi&#34;&gt;9. Redémarrer Patroni sur le primaire choisi&lt;/h4&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;systemctl start patroni&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;10-vérifier-la-promotion&#34;&gt;10. Vérifier la promotion&lt;/h4&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;patronictl -c /etc/patroni/config.yml topology&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;+ Cluster: loxodemo &lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;7427142939826752414&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt; -+----+-----------+&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; Member  &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; Host        &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; Role   &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; State   &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; TL &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; Lag in MB &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;+---------+-------------+--------+---------+----+-----------+&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; pgdeb01 &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; 10.200.0.11 &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; Leader &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; running &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;  &lt;span class=&#34;m&#34;&gt;5&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;           &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;+---------+-------------+--------+---------+----+-----------+&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;11-redémarrer-patroni-sur-chaque-réplica&#34;&gt;11. Redémarrer Patroni sur chaque réplica&lt;/h4&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;systemctl start patroni&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;patronictl -c /etc/patroni/config.yml topology&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;+ Cluster: loxodemo &lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;7427142939826752414&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt; ------+----+-----------+&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; Member    &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; Host        &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; Role    &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; State     &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; TL &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; Lag in MB &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;+-----------+-------------+---------+-----------+----+-----------+&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; pgdeb01   &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; 10.200.0.11 &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; Leader  &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; running   &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;  &lt;span class=&#34;m&#34;&gt;5&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;           &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; + pgdeb02 &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; 10.200.0.12 &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; Replica &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; streaming &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;  &lt;span class=&#34;m&#34;&gt;5&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;         &lt;span class=&#34;m&#34;&gt;0&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; + pgdeb03 &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; 10.200.0.13 &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; Replica &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; streaming &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;  &lt;span class=&#34;m&#34;&gt;5&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;         &lt;span class=&#34;m&#34;&gt;0&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;+-----------+-------------+---------+-----------+----+-----------+&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;hr&gt;&#xA;&lt;h3 id=&#34;méthode-2--bootstrap-du-cluster-avec-patroni&#34;&gt;Méthode 2 : Bootstrap du cluster avec Patroni&lt;/h3&gt;&#xA;&lt;p&gt;Cette méthode est plus lourde, mais parfois nécessaire (ex. : restauration complète ou scriptée).&lt;/p&gt;&#xA;&lt;h4 id=&#34;1-connectez-vous-sur-une-des-machines-qui-sera-le-futur-primaire&#34;&gt;1. Connectez-vous sur une des machines qui sera le futur primaire.&lt;/h4&gt;&#xA;&lt;h4 id=&#34;2-supprimer-ou-déplacer-le-répertoire-de-données-de-postgresql&#34;&gt;2. Supprimer ou déplacer le répertoire de données de PostgreSQL&lt;/h4&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;rm -rf /data/postgres/loxodemo&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ou&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;mv /data/postgres/loxodemo /data/postgres/loxodemo_archive&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;3-supprimer-le-cluster-dans-etcd&#34;&gt;3. Supprimer le cluster dans Etcd&lt;/h4&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;patronictl -c /etc/patroni/config.yml remove loxodemo&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Confirmation obligatoire :&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;Please confirm the cluster name to remove: loxodemo&#xA;You are about to remove all information ... please type: &amp;#34;Yes I am aware&amp;#34;: Yes I am aware&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;h4 id=&#34;4-modifier-la-configuration-de-patroni&#34;&gt;4. Modifier la configuration de Patroni&lt;/h4&gt;&#xA;&lt;p&gt;Ajoutez à la section &lt;code&gt;bootstrap&lt;/code&gt; :&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;bootstrap:&#xA;  method: pgbackrest&#xA;  pgbackrest:&#xA;    command: &amp;#39;/usr/bin/pgbackrest --stanza=loxodemo --delta restore&amp;#39;&#xA;    keep_existing_recovery_conf: false&#xA;    no_params: true&#xA;    recovery_conf:&#xA;      recovery_target_action: promote&#xA;      recovery_target_time: &amp;#34;2025-07-21 09:14:16.78179+00&amp;#34;&#xA;      restore_command: pgbackrest --stanza=loxodemo archive-get %f %p&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;h4 id=&#34;5-redémarrer-patroni-sur-le-futur-primaire&#34;&gt;5. Redémarrer Patroni sur le futur primaire&lt;/h4&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;systemctl start patroni&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Les logs doivent indiquer la séquence de bootstrap :&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;2025-07-21 12:59:23 INFO: Selected new etcd server http://10.200.0.12:2379&#xA;2025-07-21 12:59:23 INFO: No PostgreSQL configuration items changed, nothing to reload.&#xA;2025-07-21 12:59:23 INFO: Lock owner: None; I am pgdeb01&#xA;2025-07-21 12:59:23 INFO: trying to bootstrap a new cluster&#xA;2025-07-21 12:59:23 INFO: Running custom bootstrap script: /usr/bin/pgbackrest --stanza=loxodemo restore&#xA;2025-07-21 12:59:24 INFO: Lock owner: None; I am pgdeb01&#xA;2025-07-21 12:59:24 INFO: not healthy enough for leader race&#xA;2025-07-21 12:59:24 INFO: bootstrap in progress&#xA;2025-07-21 12:59:25 INFO: Lock owner: None; I am pgdeb01&#xA;2025-07-21 12:59:25 INFO: not healthy enough for leader race&#xA;2025-07-21 12:59:25 INFO: bootstrap in progress&#xA;2025-07-21 12:59:26 INFO: Lock owner: None; I am pgdeb01&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Forcer l’écriture des journaux de transaction et par conséquent l’archivage.&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code class=&#34;language-sql=&#34; data-lang=&#34;sql=&#34;&gt;select * from pg_switch_wal();&#xA; pg_switch_wal&#xA;---------------&#xA; 0/9004A00&#xA;(1 row)&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;h4 id=&#34;6-redémarrer-patroni-sur-chaque-réplica&#34;&gt;6. Redémarrer Patroni sur chaque réplica&lt;/h4&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;systemctl start patroni&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Contrôler l&amp;rsquo;état du cluster:&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;patronictl -c /etc/patroni/config.yml topology&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;+ Cluster: loxodemo &lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;7427142939826752414&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt; ------+-----+-----------+&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; Member    &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; Host        &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; Role    &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; State     &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;  TL &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; Lag in MB &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;+-----------+-------------+---------+-----------+-----+-----------+&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; pgdeb01   &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; 10.200.0.11 &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; Leader  &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; running   &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;  &lt;span class=&#34;m&#34;&gt;10&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;           &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; + pgdeb02 &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; 10.200.0.12 &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; Replica &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; streaming &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;  &lt;span class=&#34;m&#34;&gt;10&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;         &lt;span class=&#34;m&#34;&gt;0&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; + pgdeb03 &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; 10.200.0.13 &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; Replica &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; streaming &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;  &lt;span class=&#34;m&#34;&gt;10&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;         &lt;span class=&#34;m&#34;&gt;0&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;+-----------+-------------+---------+-----------+-----+-----------+&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;quelle-méthode-choisir-&#34;&gt;Quelle méthode choisir ?&lt;/h2&gt;&#xA;&lt;table&gt;&#xA;&lt;thead&gt;&#xA;&lt;tr&gt;&#xA;&lt;th&gt;Méthode&lt;/th&gt;&#xA;&lt;th&gt;Avantages&lt;/th&gt;&#xA;&lt;th&gt;Inconvénients&lt;/th&gt;&#xA;&lt;/tr&gt;&#xA;&lt;/thead&gt;&#xA;&lt;tbody&gt;&#xA;&lt;tr&gt;&#xA;&lt;td&gt;Manuelle (&amp;ndash;delta)&lt;/td&gt;&#xA;&lt;td&gt;Restauration plus rapide, plus granulaire&lt;/td&gt;&#xA;&lt;td&gt;Plus de manipulation manuelle&lt;/td&gt;&#xA;&lt;/tr&gt;&#xA;&lt;tr&gt;&#xA;&lt;td&gt;Bootstrap Patroni&lt;/td&gt;&#xA;&lt;td&gt;Automatisable, plus propre dans certains cas&lt;/td&gt;&#xA;&lt;td&gt;Plus long, pas de restauration delta&lt;/td&gt;&#xA;&lt;/tr&gt;&#xA;&lt;/tbody&gt;&#xA;&lt;/table&gt;&#xA;&lt;h2 id=&#34;conclusion&#34;&gt;Conclusion&lt;/h2&gt;&#xA;&lt;p&gt;Grâce à &lt;strong&gt;pgBackRest&lt;/strong&gt; et &lt;strong&gt;Patroni&lt;/strong&gt;, il est possible de restaurer un cluster PostgreSQL à un instant précis, que ce soit pour corriger une erreur humaine ou revenir à un état stable après une défaillance. Selon les besoins (rapidité vs réinitialisation complète), l’une ou l’autre des méthodes peut être utilisée efficacement.&lt;/p&gt;</summary>
    <author>
      <name>Loxodata</name>
    </author>
  </entry>
  <entry>
    <title>Le saviez-vous ? Les tables dans PostgreSQL sont limitées à 1600 colonnes</title>
    <updated>2025-11-13T00:00:00Z</updated>
    <id>tag:www.data-bene.io,2025-11-13:/fr/blog/le-saviez-vous-les-tables-dans-postgresql-sont-limitees-a-1600-colonnes/</id>
    <content type="html"> &lt;p&gt;&lt;strong&gt;Saviez-vous qu’une table ne peut pas contenir plus de 1 600 colonnes ?&lt;/strong&gt; Cet article de blog est inspiré d’une conversation avec Pierre Ducroquet.&lt;/p&gt;&#xA;&lt;h2 id=&#34;tout-dabord-la-documentation&#34;&gt;&lt;a class=&#34;heading-anchor&#34; href=&#34;#tout-dabord-la-documentation&#34;&gt;Tout d’abord, la documentation&lt;/a&gt;&lt;/h2&gt;&#xA;&lt;p&gt;&lt;a href=&#34;https://www.postgresql.org/docs/current/limits.html&#34; rel=&#34;noopener&#34;&gt;L’annexe K&lt;/a&gt; de la documentation PostgreSQL  indique qu’une table peut contenir jusqu’à 1 600 colonnes.&lt;/p&gt;&#xA;&lt;p&gt;Il s’agit d’une &lt;strong&gt;limite codée en dur&lt;/strong&gt;, visible dans le code source à l’adresse &lt;code&gt;src/include/access/htup_details.h&lt;/code&gt; :&lt;/p&gt;&#xA;&lt;pre class=&#34;language-plaintext&#34;&gt;&lt;code class=&#34;language-plaintext&#34;&gt;#define MaxTupleAttributeNumber 1664&#xA;#define MaxHeapAttributeNumber&#x9;1600&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;h2 id=&#34;atteindre-la-limite-de-maniere-classique&#34;&gt;&lt;a class=&#34;heading-anchor&#34; href=&#34;#atteindre-la-limite-de-maniere-classique&#34;&gt;Atteindre la limite de manière classique&lt;/a&gt;&lt;/h2&gt;&#xA;&lt;p&gt;Vérifions d’abord cette affirmation par quelques tests.&lt;/p&gt;&#xA;&lt;h3 id=&#34;jouer-avec-la-definition-de-la-table&#34;&gt;&lt;a class=&#34;heading-anchor&#34; href=&#34;#jouer-avec-la-definition-de-la-table&#34;&gt;Jouer avec la définition de la table&lt;/a&gt;&lt;/h3&gt;&#xA;&lt;p&gt;Nous utilisons ici un script bash simple, facile à adapter aux différents tests.&lt;/p&gt;&#xA;&lt;pre class=&#34;language-sql&#34;&gt;&lt;code class=&#34;language-sql&#34;&gt;&lt;span class=&#34;token comment&#34;&gt;-- Exemple classique&lt;/span&gt;&#xA;&#xA;&lt;span class=&#34;token keyword&#34;&gt;DO&lt;/span&gt; $$&#xA;&lt;span class=&#34;token keyword&#34;&gt;DECLARE&lt;/span&gt;&#xA;    i &lt;span class=&#34;token keyword&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&#xA;&lt;span class=&#34;token keyword&#34;&gt;BEGIN&lt;/span&gt;&#xA;    &lt;span class=&#34;token keyword&#34;&gt;EXECUTE&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#39;DROP TABLE IF EXISTS tint_1601;&#39;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&#xA;    &lt;span class=&#34;token keyword&#34;&gt;EXECUTE&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#39;CREATE TABLE tint_1601(i_1 int);&#39;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&#xA;    &lt;span class=&#34;token keyword&#34;&gt;FOR&lt;/span&gt; i &lt;span class=&#34;token operator&#34;&gt;IN&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;2.&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;.1601&lt;/span&gt; &lt;span class=&#34;token keyword&#34;&gt;LOOP&lt;/span&gt;&#xA;        &lt;span class=&#34;token keyword&#34;&gt;EXECUTE&lt;/span&gt; &lt;span class=&#34;token function&#34;&gt;format&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#39;ALTER TABLE tint_1601 ADD COLUMN i_%s int;&#39;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;,&lt;/span&gt; i&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&#xA;    &lt;span class=&#34;token keyword&#34;&gt;END&lt;/span&gt; &lt;span class=&#34;token keyword&#34;&gt;LOOP&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&#xA;&lt;span class=&#34;token keyword&#34;&gt;END&lt;/span&gt; $$&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;Le résultat est le suivant :&lt;/p&gt;&#xA;&lt;pre class=&#34;language-plaintext&#34;&gt;&lt;code class=&#34;language-plaintext&#34;&gt;NOTICE:  table &#34;tint_1600&#34; does not exist, skipping&#xA;ERROR:  tables can have at most 1600 columns&#xA;CONTEXT:  SQL statement &#34;ALTER TABLE tint_1600 ADD COLUMN i_1601 int;&#34;&#xA;PL/pgSQL function inline_code_block line 8 at EXECUTE&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;Jusqu’ici, tout va bien (ou du moins, tout fonctionne comme prévu).&lt;/p&gt;&#xA;&lt;p&gt;Vous pourriez tenter de remplacer le type &lt;code&gt;int4&lt;/code&gt; par le type &lt;code&gt;int2&lt;/code&gt; pour arriver à créer une table de plus de 1 600 colonnes. Mais cela ne fonctionnera pas plus, car il s’agit d’une limite codée en dur.&lt;/p&gt;&#xA;&lt;h3 id=&#34;jouer-avec-le-contenu-dune-table&#34;&gt;&lt;a class=&#34;heading-anchor&#34; href=&#34;#jouer-avec-le-contenu-dune-table&#34;&gt;Jouer avec le contenu d’une table&lt;/a&gt;&lt;/h3&gt;&#xA;&lt;p&gt;Générons une table de 1600 colonnes à partir du script sql précédent :&lt;/p&gt;&#xA;&lt;pre class=&#34;language-sql&#34;&gt;&lt;code class=&#34;language-sql&#34;&gt;&lt;span class=&#34;token keyword&#34;&gt;DO&lt;/span&gt; $$&#xA;&lt;span class=&#34;token keyword&#34;&gt;DECLARE&lt;/span&gt;&#xA;    i &lt;span class=&#34;token keyword&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&#xA;&lt;span class=&#34;token keyword&#34;&gt;BEGIN&lt;/span&gt;&#xA;    &lt;span class=&#34;token keyword&#34;&gt;EXECUTE&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#39;DROP TABLE IF EXISTS tint_1600;&#39;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&#xA;    &lt;span class=&#34;token keyword&#34;&gt;EXECUTE&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#39;CREATE TABLE tint_1600(i_1 int);&#39;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&#xA;    &lt;span class=&#34;token keyword&#34;&gt;FOR&lt;/span&gt; i &lt;span class=&#34;token operator&#34;&gt;IN&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;2.&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;.1600&lt;/span&gt; &lt;span class=&#34;token keyword&#34;&gt;LOOP&lt;/span&gt;&#xA;        &lt;span class=&#34;token keyword&#34;&gt;EXECUTE&lt;/span&gt; &lt;span class=&#34;token function&#34;&gt;format&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#39;ALTER TABLE tint_1600 ADD COLUMN i_%s int;&#39;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;,&lt;/span&gt; i&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&#xA;    &lt;span class=&#34;token keyword&#34;&gt;END&lt;/span&gt; &lt;span class=&#34;token keyword&#34;&gt;LOOP&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&#xA;&lt;span class=&#34;token keyword&#34;&gt;END&lt;/span&gt; $$&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;Construisons puis insérons un tuple de 1600 colonnes :&lt;/p&gt;&#xA;&lt;pre class=&#34;language-sql&#34;&gt;&lt;code class=&#34;language-sql&#34;&gt;&lt;span class=&#34;token keyword&#34;&gt;DO&lt;/span&gt; $$&#xA;&lt;span class=&#34;token keyword&#34;&gt;DECLARE&lt;/span&gt;&#xA;    s &lt;span class=&#34;token keyword&#34;&gt;TEXT&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&#xA;    rows_inserted &lt;span class=&#34;token keyword&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&#xA;&lt;span class=&#34;token keyword&#34;&gt;BEGIN&lt;/span&gt;&#xA;    s :&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;token function&#34;&gt;format&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;&#xA;                 &lt;span class=&#34;token string&#34;&gt;&#39;INSERT INTO tint_1600 VALUES (1%s);&#39;&lt;/span&gt;&#xA;               &lt;span class=&#34;token punctuation&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;token keyword&#34;&gt;repeat&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#39;,1&#39;&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1599&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&#xA;               &lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&#xA;    &lt;span class=&#34;token keyword&#34;&gt;EXECUTE&lt;/span&gt; s&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&#xA;&#xA;    GET DIAGNOSTICS rows_inserted &lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt; ROW_COUNT&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&#xA;    RAISE NOTICE &lt;span class=&#34;token string&#34;&gt;&#39;Rows inserted: %&#39;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;,&lt;/span&gt; rows_inserted&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&#xA;&lt;span class=&#34;token keyword&#34;&gt;END&lt;/span&gt; $$&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;The output is:&lt;/p&gt;&#xA;&lt;pre class=&#34;language-plaintext&#34;&gt;&lt;code class=&#34;language-plaintext&#34;&gt;NOTICE:  Rows inserted: 1&#xA;DO&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;Sans surprise, c’est encore un succès.&lt;/p&gt;&#xA;&lt;h3 id=&#34;trop-gros-pour-echouer&#34;&gt;&lt;a class=&#34;heading-anchor&#34; href=&#34;#trop-gros-pour-echouer&#34;&gt;Trop gros pour échouer ?&lt;/a&gt;&lt;/h3&gt;&#xA;&lt;p&gt;Continuons à repousser les limites.&lt;/p&gt;&#xA;&lt;p&gt;On créé maintenant une autre table de 1 600 colonnes, cette fois avec le type de données &lt;code&gt;char(127)&lt;/code&gt;.&lt;/p&gt;&#xA;&lt;p&gt;On réutilise notre script bash avec quelques modifications :&lt;/p&gt;&#xA;&lt;pre class=&#34;language-sql&#34;&gt;&lt;code class=&#34;language-sql&#34;&gt;&lt;span class=&#34;token comment&#34;&gt;-- Create a table with 1,600 columns: 1 x int + 1599 x char(127)&lt;/span&gt;&#xA;&lt;span class=&#34;token keyword&#34;&gt;DO&lt;/span&gt; $$&#xA;&lt;span class=&#34;token keyword&#34;&gt;DECLARE&lt;/span&gt;&#xA;    i &lt;span class=&#34;token keyword&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&#xA;&lt;span class=&#34;token keyword&#34;&gt;BEGIN&lt;/span&gt;&#xA;    &lt;span class=&#34;token keyword&#34;&gt;EXECUTE&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#39;DROP TABLE IF EXISTS tint_1600;&#39;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&#xA;    &lt;span class=&#34;token keyword&#34;&gt;EXECUTE&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#39;CREATE TABLE tint_1600(i_1 int);&#39;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&#xA;    &lt;span class=&#34;token keyword&#34;&gt;FOR&lt;/span&gt; i &lt;span class=&#34;token operator&#34;&gt;IN&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;2.&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;.1600&lt;/span&gt; &lt;span class=&#34;token keyword&#34;&gt;LOOP&lt;/span&gt;&#xA;        &lt;span class=&#34;token keyword&#34;&gt;EXECUTE&lt;/span&gt; &lt;span class=&#34;token function&#34;&gt;format&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#39;ALTER TABLE tint_1600 ADD COLUMN c_%s char(127) NOT NULL;&#39;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;,&lt;/span&gt; i&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&#xA;    &lt;span class=&#34;token keyword&#34;&gt;END&lt;/span&gt; &lt;span class=&#34;token keyword&#34;&gt;LOOP&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&#xA;&lt;span class=&#34;token keyword&#34;&gt;END&lt;/span&gt; $$&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&#xA;&#xA;&lt;span class=&#34;token comment&#34;&gt;-- Insert a tuple - 1 x int + 1599 x char(127)&lt;/span&gt;&#xA;&lt;span class=&#34;token keyword&#34;&gt;DO&lt;/span&gt; $$&#xA;&lt;span class=&#34;token keyword&#34;&gt;DECLARE&lt;/span&gt;&#xA;    s &lt;span class=&#34;token keyword&#34;&gt;TEXT&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&#xA;&lt;span class=&#34;token keyword&#34;&gt;BEGIN&lt;/span&gt;&#xA;    s :&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;token function&#34;&gt;format&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;&#xA;                 &lt;span class=&#34;token string&#34;&gt;&#39;INSERT INTO tint_1600 VALUES (1%s);&#39;&lt;/span&gt;&#xA;               &lt;span class=&#34;token punctuation&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;token keyword&#34;&gt;repeat&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt; $q$&lt;span class=&#34;token punctuation&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#39;1&#39;&lt;/span&gt;::&lt;span class=&#34;token keyword&#34;&gt;char&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;127&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;$q$ &lt;span class=&#34;token punctuation&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;1599&lt;/span&gt; &lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&#xA;               &lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&#xA;    &lt;span class=&#34;token keyword&#34;&gt;EXECUTE&lt;/span&gt; s&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&#xA;&lt;span class=&#34;token keyword&#34;&gt;END&lt;/span&gt; $$&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;token identifier&#34;&gt;&lt;span class=&#34;token punctuation&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;`&lt;/span&gt;&#xA;&#xA;Le résultat est :&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;ERROR:  row is too big: size 25616, maximum size 8160&lt;/p&gt;&#xA;&lt;pre class=&#34;language-plaintext&#34;&gt;&lt;code class=&#34;language-plaintext&#34;&gt;&#xA;Comme on peut le voir, la table comporte effectivement 1 600 colonnes, mais cette fois, le tuple ne peut pas tenir dans une seule page heap, ce qui explique l&#39;erreur « row is too big: size 25616, maximum size 8160 ». Si vous avez fait attention au script, vous avez pu constater que les colonnes sont définies comme `NOT NULL`. Aussi, lors de la création de la table, PostgreSQL aurait pu se rendre compte que l&#39;insertion de données serait impossible. Mais il n&#39;y a pas eu d&#39;alerte.&#xA;&#xA;## Quid des JOINs ?&#xA;&#xA;Pour simplifier, testons avec une jointure automatique :&#xA;&#xA;```sql&#xA;SELECT a.*,b.* FROM tint_1600 a, tint_1600 b;&#xA;ERROR:  target lists can have at most 1664 entries&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;Maintenant, c’est la clause &lt;code&gt;SELECT&lt;/code&gt; de (&lt;code&gt;a.*,b.*&lt;/code&gt;) qui a atteint sa propre limite (&lt;code&gt;MaxTupleAttributeNumber = 1664&lt;/code&gt;).&lt;/p&gt;&#xA;&lt;h2 id=&#34;atteindre-la-limite-de-colonnes-de-maniere-inattendue&#34;&gt;&lt;a class=&#34;heading-anchor&#34; href=&#34;#atteindre-la-limite-de-colonnes-de-maniere-inattendue&#34;&gt;Atteindre la limite de colonnes de manière inattendue&lt;/a&gt;&lt;/h2&gt;&#xA;&lt;p&gt;Il arrive que vous deviez modifier votre application, et que cela entraîne des modifications de schéma.&lt;br&gt;&#xA;La plupart du temps, il s’agit de modifications de tables, comme l’ajout ou la suppression de colonnes.&lt;/p&gt;&#xA;&lt;h3 id=&#34;explorer-add-/-drop-column&#34;&gt;&lt;a class=&#34;heading-anchor&#34; href=&#34;#explorer-add-/-drop-column&#34;&gt;Explorer &lt;code&gt;ADD&lt;/code&gt; / &lt;code&gt;DROP COLUMN&lt;/code&gt;&lt;/a&gt;&lt;/h3&gt;&#xA;&lt;p&gt;Voyons ce qui se passe côté SQL lorsque nous ajoutons, puis supprimons, une colonne.&lt;/p&gt;&#xA;&lt;pre class=&#34;language-sql&#34;&gt;&lt;code class=&#34;language-sql&#34;&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# CREATE TABLE tadc_1600(i_1 int NOT NULL);&lt;/span&gt;&#xA;&#xA;&lt;span class=&#34;token keyword&#34;&gt;CREATE&lt;/span&gt; &lt;span class=&#34;token keyword&#34;&gt;TABLE&lt;/span&gt;&#xA;&#xA;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# ALTER TABLE tadc_1600 ADD COLUMN i_2 int NOT NULL;&lt;/span&gt;&#xA;&#xA;&lt;span class=&#34;token keyword&#34;&gt;ALTER&lt;/span&gt; &lt;span class=&#34;token keyword&#34;&gt;TABLE&lt;/span&gt;&#xA;&#xA;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# SELECT attname,attnum,attstorage,attnotnull,attisdropped&lt;/span&gt;&#xA;   &lt;span class=&#34;token keyword&#34;&gt;FROM&lt;/span&gt; pg_attribute&#xA;   &lt;span class=&#34;token keyword&#34;&gt;WHERE&lt;/span&gt; attrelid&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;&#xA;                   &lt;span class=&#34;token keyword&#34;&gt;SELECT&lt;/span&gt; oid&#xA;                   &lt;span class=&#34;token keyword&#34;&gt;FROM&lt;/span&gt; pg_class&#xA;                   &lt;span class=&#34;token keyword&#34;&gt;WHERE&lt;/span&gt; relname&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#39;tadc_1600&#39;&lt;/span&gt;&#xA;                   &lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&#xA;     &lt;span class=&#34;token operator&#34;&gt;AND&lt;/span&gt; attnum &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt; &lt;span class=&#34;token keyword&#34;&gt;ORDER&lt;/span&gt; &lt;span class=&#34;token keyword&#34;&gt;BY&lt;/span&gt; attnum&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&#xA;&#xA; attname &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; attnum &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; attstorage &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; attnotnull &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; attisdropped&#xA;&lt;span class=&#34;token comment&#34;&gt;---------+--------+------------+------------+--------------&lt;/span&gt;&#xA; i_1     &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt;      &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; p          &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; t          &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; f&#xA; i_2     &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt;      &lt;span class=&#34;token number&#34;&gt;2&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; p          &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; t          &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; f&#xA;&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;2&lt;/span&gt; &lt;span class=&#34;token keyword&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&#xA;&#xA;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# ALTER TABLE tadc_1600 DROP COLUMN i_2;&lt;/span&gt;&#xA;&#xA;&lt;span class=&#34;token keyword&#34;&gt;ALTER&lt;/span&gt; &lt;span class=&#34;token keyword&#34;&gt;TABLE&lt;/span&gt;&#xA;&#xA;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# SELECT attname,attnum,attstorage,attnotnull,attisdropped&lt;/span&gt;&#xA;   &lt;span class=&#34;token keyword&#34;&gt;FROM&lt;/span&gt; pg_attribute&#xA;   &lt;span class=&#34;token keyword&#34;&gt;WHERE&lt;/span&gt; attrelid&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;&#xA;                   &lt;span class=&#34;token keyword&#34;&gt;SELECT&lt;/span&gt; oid&#xA;                   &lt;span class=&#34;token keyword&#34;&gt;FROM&lt;/span&gt; pg_class&#xA;                   &lt;span class=&#34;token keyword&#34;&gt;WHERE&lt;/span&gt; relname&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#39;tadc_1600&#39;&lt;/span&gt;&#xA;                   &lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&#xA;     &lt;span class=&#34;token operator&#34;&gt;AND&lt;/span&gt; attnum &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt; &lt;span class=&#34;token keyword&#34;&gt;ORDER&lt;/span&gt; &lt;span class=&#34;token keyword&#34;&gt;BY&lt;/span&gt; attnum&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&#xA;&#xA;           attname            &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; attnum &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; attstorage &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; attnotnull &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; attisdropped&#xA;&lt;span class=&#34;token comment&#34;&gt;------------------------------+--------+------------+------------+--------------&lt;/span&gt;&#xA; i_1                          &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt;      &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; p          &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; t          &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; f&#xA; &lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;pg&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;dropped&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;2.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt;      &lt;span class=&#34;token number&#34;&gt;2&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; p          &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; f          &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; t&#xA;&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;2&lt;/span&gt; &lt;span class=&#34;token keyword&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;Lors de la suppression d’une colonne, cette colonne&lt;/p&gt;&#xA;&lt;ul class=&#34;list&#34;&gt;&#xA;&lt;li&gt;est renommée en « . » + « pg.dropped.» + attnum + « . »,&lt;/li&gt;&#xA;&lt;li&gt;devient NULLable,&lt;/li&gt;&#xA;&lt;li&gt;est marquée comme supprimée.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h3 id=&#34;iterer-sur-lajout/la-suppression-de-colonnes&#34;&gt;&lt;a class=&#34;heading-anchor&#34; href=&#34;#iterer-sur-lajout/la-suppression-de-colonnes&#34;&gt;Itérer sur l’ajout/la suppression de colonnes&lt;/a&gt;&lt;/h3&gt;&#xA;&lt;p&gt;On peut se demander s’il existe une limite au nombre d’opérations d’ajout/suppression qui peuvent être exécutées sur une table donnée.&lt;/p&gt;&#xA;&lt;p&gt;Comme d’habitude, testons :&lt;/p&gt;&#xA;&lt;pre class=&#34;language-sql&#34;&gt;&lt;code class=&#34;language-sql&#34;&gt;&lt;span class=&#34;token comment&#34;&gt;-- ADD / DROP COLUMN example&lt;/span&gt;&#xA;&lt;span class=&#34;token keyword&#34;&gt;DO&lt;/span&gt; $$&#xA;&lt;span class=&#34;token keyword&#34;&gt;DECLARE&lt;/span&gt;&#xA;    i &lt;span class=&#34;token keyword&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&#xA;&lt;span class=&#34;token keyword&#34;&gt;BEGIN&lt;/span&gt;&#xA;    &lt;span class=&#34;token keyword&#34;&gt;EXECUTE&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#39;DROP TABLE IF EXISTS tadc;&#39;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&#xA;    &lt;span class=&#34;token keyword&#34;&gt;EXECUTE&lt;/span&gt; &lt;span class=&#34;token string&#34;&gt;&#39;CREATE TABLE tadc(i_1 int);&#39;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&#xA;    &lt;span class=&#34;token keyword&#34;&gt;FOR&lt;/span&gt; i &lt;span class=&#34;token operator&#34;&gt;IN&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;2.&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;.1601&lt;/span&gt; &lt;span class=&#34;token keyword&#34;&gt;LOOP&lt;/span&gt;&#xA;        &lt;span class=&#34;token keyword&#34;&gt;EXECUTE&lt;/span&gt; &lt;span class=&#34;token function&#34;&gt;format&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#39;ALTER TABLE tadc ADD COLUMN i_%s int;&#39;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;,&lt;/span&gt; i&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&#xA;        &lt;span class=&#34;token keyword&#34;&gt;EXECUTE&lt;/span&gt; &lt;span class=&#34;token function&#34;&gt;format&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#39;ALTER TABLE tadc DROP COLUMN i_%s;&#39;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;,&lt;/span&gt; i&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&#xA;    &lt;span class=&#34;token keyword&#34;&gt;END&lt;/span&gt; &lt;span class=&#34;token keyword&#34;&gt;LOOP&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&#xA;&lt;span class=&#34;token keyword&#34;&gt;END&lt;/span&gt; $$&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;Le résultat est :&lt;/p&gt;&#xA;&lt;pre class=&#34;language-plaintext&#34;&gt;&lt;code class=&#34;language-plaintext&#34;&gt;ERROR:  tables can have at most 1600 columns&#xA;CONTEXT:  SQL statement &#34;ALTER TABLE tadc ADD COLUMN i_1601 int;&#34;&#xA;PL/pgSQL function inline_code_block line 8 at EXECUTE&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;Oh oh ! On a atteint la limite des 1 600 ici aussi !&lt;/p&gt;&#xA;&lt;p&gt;Explorons un peu ce qui se passe :&lt;/p&gt;&#xA;&lt;pre class=&#34;language-sql&#34;&gt;&lt;code class=&#34;language-sql&#34;&gt;&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token comment&#34;&gt;# SELECT attname,attnum,attstorage,attnotnull,attisdropped&lt;/span&gt;&#xA;   &lt;span class=&#34;token keyword&#34;&gt;FROM&lt;/span&gt; pg_attribute&#xA;   &lt;span class=&#34;token keyword&#34;&gt;WHERE&lt;/span&gt; attrelid&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;&#xA;                   &lt;span class=&#34;token keyword&#34;&gt;SELECT&lt;/span&gt; oid&#xA;                   &lt;span class=&#34;token keyword&#34;&gt;FROM&lt;/span&gt; pg_class&#xA;                   &lt;span class=&#34;token keyword&#34;&gt;WHERE&lt;/span&gt; relname&lt;span class=&#34;token operator&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;token string&#34;&gt;&#39;tadc&#39;&lt;/span&gt;&#xA;                   &lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&#xA;     &lt;span class=&#34;token operator&#34;&gt;AND&lt;/span&gt; attnum &lt;span class=&#34;token operator&#34;&gt;&gt;&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;0&lt;/span&gt; &lt;span class=&#34;token keyword&#34;&gt;ORDER&lt;/span&gt; &lt;span class=&#34;token keyword&#34;&gt;BY&lt;/span&gt; attnum&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&#xA;&#xA;             attname             &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; attnum &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; attstorage &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; attnotnull &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; attisdropped&#xA;&lt;span class=&#34;token comment&#34;&gt;---------------------------------+--------+------------+------------+--------------&lt;/span&gt;&#xA; i_1                             &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt;      &lt;span class=&#34;token number&#34;&gt;1&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; p          &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; t          &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; f&#xA; &lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;pg&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;dropped&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;2.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;    &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt;      &lt;span class=&#34;token number&#34;&gt;2&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; p          &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; f          &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; t&#xA; &lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;pg&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;dropped&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;3.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;    &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt;      &lt;span class=&#34;token number&#34;&gt;3&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; p          &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; f          &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; t&#xA; &lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;pg&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;dropped&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;4.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;    &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt;      &lt;span class=&#34;token number&#34;&gt;4&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; p          &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; f          &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; t&#xA; &lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;pg&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;dropped&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;5.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;    &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt;      &lt;span class=&#34;token number&#34;&gt;5&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; p          &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; f          &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; t&#xA;&#xA; &lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;pg&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;dropped&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;1599.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt;   &lt;span class=&#34;token number&#34;&gt;1599&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; p          &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; f          &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; t&#xA; &lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;pg&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;dropped&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;1600.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;.&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt;   &lt;span class=&#34;token number&#34;&gt;1600&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; p          &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; f          &lt;span class=&#34;token operator&#34;&gt;|&lt;/span&gt; t&#xA;&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;1600&lt;/span&gt; &lt;span class=&#34;token keyword&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;La table &lt;code&gt;tadc&lt;/code&gt; comporte 1 600 colonnes. Vous pouvez vous en apercevoir car toutes les modifications sont ajoutées à la table, et son contenu n’est pas réécrit.&lt;/p&gt;&#xA;&lt;p&gt;Aussi, à ce stade, toute modification supplémentaire visant à ajouter ou supprimer des colonnes sera vouée à l’échec.&lt;/p&gt;&#xA;&lt;p&gt;Comment faire pour me sortir de cette situation ?&lt;/p&gt;&#xA;&lt;h4 id=&#34;le-chevalier-du-vacuum-devrait-sauver-la-princesse-postgresql-non&#34;&gt;&lt;a class=&#34;heading-anchor&#34; href=&#34;#le-chevalier-du-vacuum-devrait-sauver-la-princesse-postgresql-non&#34;&gt;Le chevalier du VACUUM devrait sauver la princesse PostgreSQL, non ?&lt;/a&gt;&lt;/h4&gt;&#xA;&lt;p&gt;Et non ! La commande &lt;code&gt;VACUUM&lt;/code&gt; fonctionne au niveau du tuple, donc même si vous exécutez un &lt;code&gt;VACUUM FULL&lt;/code&gt;, la structure de la table ne changera pas.&lt;/p&gt;&#xA;&lt;h4 id=&#34;donc-le-dragon-a-mange-le-chevalier-que-fait-on&#34;&gt;&lt;a class=&#34;heading-anchor&#34; href=&#34;#donc-le-dragon-a-mange-le-chevalier-que-fait-on&#34;&gt;Donc le dragon a mangé le chevalier, que fait-on ?&lt;/a&gt;&lt;/h4&gt;&#xA;&lt;p&gt;Il ne s’agit pas d’un problème de tuples morts, mais plutôt d’un problème de catalogue.&lt;br&gt;&#xA;Vous devez créer une nouvelle définition de table.&lt;/p&gt;&#xA;&lt;p&gt;Voici quelques solutions, des plus simples aux plus complexes :&lt;/p&gt;&#xA;&lt;ol class=&#34;list&#34;&gt;&#xA;&lt;li&gt;&#xA;&lt;p&gt;Créer une nouvelle table avec interruption de service&lt;/p&gt;&#xA;&lt;ul class=&#34;list&#34;&gt;&#xA;&lt;li&gt;&lt;code&gt;CREATE TABLE LIKE (INCLUDING ALL)&lt;/code&gt;&lt;/li&gt;&#xA;&lt;li&gt;Copier (&lt;code&gt;COPY&lt;/code&gt;) les données de l’ancienne table vers la nouvelle&lt;/li&gt;&#xA;&lt;li&gt;Renommer les tables&lt;/li&gt;&#xA;&lt;li&gt;Supprimer l’ancienne table&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;&#xA;&lt;p&gt;Exploiter la réplication logique pour minimiser les interruptions de service&lt;/p&gt;&#xA;&lt;ul class=&#34;list&#34;&gt;&#xA;&lt;li&gt;&lt;code&gt;CREATE TABLE LIKE (INCLUDING ALL)&lt;/code&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;code&gt;CREATE local PUBLICATION/SUBSCRIPTION&lt;/code&gt;&lt;/li&gt;&#xA;&lt;li&gt;Une fois les données synchronisées, arrêter/mettre en pause le service applicatif&lt;/li&gt;&#xA;&lt;li&gt;Supprimer l’abonnement&lt;/li&gt;&#xA;&lt;li&gt;Renommer les tables&lt;/li&gt;&#xA;&lt;li&gt;Redémarrer/relancer l’application&lt;/li&gt;&#xA;&lt;li&gt;Supprimer l’ancienne table&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&lt;h2 id=&#34;contactez-nous&#34;&gt;&lt;a class=&#34;heading-anchor&#34; href=&#34;#contactez-nous&#34;&gt;Contactez-nous&lt;/a&gt;&lt;/h2&gt;&#xA;&lt;p&gt;Vous avez d’autres idées pour résoudre ce problème ? Vous avez trouvé d’autres moyens étranges de déclencher cette erreur liée à la limite codée en dur ? &lt;a href=&#34;https://www.data-bene.io/en/#contact&#34; rel=&#34;noopener&#34;&gt;Contactez-nous&lt;/a&gt; ! Nous sommes toujours ravis d’échanger sur PostgreSQL.&lt;/p&gt;&#xA; </content>
    <link href="https://www.data-bene.io/fr/blog/le-saviez-vous-les-tables-dans-postgresql-sont-limitees-a-1600-colonnes/" rel="alternate"></link>
    <summary type="html"></summary>
    <author>
      <name>Frédéric Delacourt</name>
    </author>
  </entry>
  <entry>
    <title>Statistiques cumulatives dans PostgreSQL 18</title>
    <updated>2025-09-29T00:00:00Z</updated>
    <id>tag:www.data-bene.io,2025-09-29:/fr/blog/statistiques-cumulatives-dans-postgresql-18/</id>
    <content type="html"> &lt;p&gt;Dans &lt;strong&gt;PostgreSQL 18&lt;/strong&gt;, le sous-système de statistiques et de supervision bénéficie d’une refonte majeure: statistiques cumulatives étendues, nouvelle visibilité I/O par backend, possibilité pour les extensions d’exporter / importer / ajuster les statistiques, et améliorations des contrôles GUC ainsi que du comportement de cache et de snapshot. Ces changements ouvrent de nouvelles perspectives pour l’analyse de performance, la simulation inter-environnements et une meilleure intégration avec les extensions. Dans cet article, j’explore les nouveautés, les points d’attention, les paramètres GUC, ainsi que la manière dont les auteurs d’extensions peuvent exploiter la nouvelle API en C.&lt;/p&gt;&#xA;&lt;h2 id=&#34;introduction-and-motivation&#34;&gt;&lt;a class=&#34;heading-anchor&#34; href=&#34;#introduction-and-motivation&#34;&gt;Introduction &amp;amp; motivation&lt;/a&gt;&lt;/h2&gt;&#xA;&lt;p&gt;Les statistiques (au sens large: compteurs de supervision, métriques I/O, et estimations pour le planificateur / optimiseur) sont au cœur à la fois de l’optimisation de performance et des décisions internes de PostgreSQL. Des statistiques transparentes, fiables et manipulables permettent entre autres aux DBAs d’adresser directement l’efficacité de PostgreSQL, et donnent aux «extensions» la possibilité d’améliorer l’expérience utilisateur.&lt;/p&gt;&#xA;&lt;p&gt;Cela dit, le système historique de statistiques de PostgreSQL n’était pas exempt de frictions: capacité limitée à réinitialiser les statistiques des relations, métriques exprimées dans des unités pas toujours alignées avec les besoins utilisateurs, absence d’API C pour utiliser le moteur de statistiques cumulatives de PostgreSQL. PostgreSQL 18 répond directement à ces préoccupations.&lt;/p&gt;&#xA;&lt;p&gt;Voici un résumé des améliorations clés.&lt;/p&gt;&#xA;&lt;h2 id=&#34;un-avertissement-sur-les-statistiques&#34;&gt;&lt;a class=&#34;heading-anchor&#34; href=&#34;#un-avertissement-sur-les-statistiques&#34;&gt;Un avertissement sur les statistiques&lt;/a&gt;&lt;/h2&gt;&#xA;&lt;p&gt;Bien que les statistiques soient extrêmement utiles, leur collecte peut consommer du temps et des ressources. PostgreSQL 18 introduit un point important: avec l’élargissement du spectre des métriques collectables, la taille maximale de la table de hachage a été augmentée. Gardez cela à l’esprit, surtout si vous concevez des systèmes à grande échelle avec des architectures «un ensemble de tables par client»: on a constaté que la limite de 1 Go pouvait être atteinte avec quelques millions de tables.&lt;/p&gt;&#xA;&lt;h2 id=&#34;quoi-de-neuf-dans-postgresql-18-et-les-«-stats-»&#34;&gt;&lt;a class=&#34;heading-anchor&#34; href=&#34;#quoi-de-neuf-dans-postgresql-18-et-les-«-stats-»&#34;&gt;Quoi de neuf dans PostgreSQL 18 et les « stats »&lt;/a&gt;&lt;/h2&gt;&#xA;&lt;p&gt;Voici les nouvelles fonctionnalités majeures ou les améliorations concernant les statistiques et la supervision.&lt;/p&gt;&#xA;&lt;p&gt;De manière générale, &lt;a href=&#34;https://www.postgresql.org/docs/18/monitoring-stats.html#MONITORING-PG-STAT-IO-VIEW&#34; rel=&#34;noopener&#34;&gt;pg_stat_io&lt;/a&gt; rapporte désormais l’activité I/O en octets plutôt qu’en pages, ce qui est plus pratique pour l’analyse. De plus, les statistiques WAL y ont été déplacées depuis &lt;code&gt;pg_stat_wal&lt;/code&gt;, offrant ainsi une vue unique et complète.&lt;/p&gt;&#xA;&lt;h3 id=&#34;mises-a-jour&#34;&gt;&lt;a class=&#34;heading-anchor&#34; href=&#34;#mises-a-jour&#34;&gt;Mises à jour&lt;/a&gt;&lt;/h3&gt;&#xA;&lt;p&gt;&lt;a href=&#34;https://www.postgresql.org/docs/18/pgupgrade.html&#34; rel=&#34;noopener&#34;&gt;pg_upgrade&lt;/a&gt; est désormais capable de conserver les statistiques de l’optimiseur, supprimant la nécessité de relancer un &lt;code&gt;ANALYZE&lt;/code&gt; complet pour obtenir de bons plans de requêtes après une montée de version: une avancée très attendue pour les grandes bases!&lt;/p&gt;&#xA;&lt;p&gt;Attention toutefois: les statistiques personnalisées ajoutées par une extension ainsi que celles créées avec &lt;a href=&#34;https://www.postgresql.org/docs/18/sql-createstatistics.html&#34; rel=&#34;noopener&#34;&gt;CREATE STATISTICS&lt;/a&gt; ne sont pas conservées.&lt;/p&gt;&#xA;&lt;p&gt;Vous voudrez sûrement examiner les nouvelles options de &lt;a href=&#34;https://www.postgresql.org/docs/18/app-vacuumdb.html&#34; rel=&#34;noopener&#34;&gt;vacuumdb&lt;/a&gt; (&lt;code&gt;--missing-stats-only&lt;/code&gt;) pour n’analyser que ce qui est nécessaire.&lt;/p&gt;&#xA;&lt;p&gt;Dans la même veine, l’option &lt;code&gt;--[no-]statistics&lt;/code&gt; a été ajoutée à &lt;a href=&#34;https://www.postgresql.org/docs/18/app-pgdump.html&#34; rel=&#34;noopener&#34;&gt;pg_dump&lt;/a&gt;, &lt;a href=&#34;https://www.postgresql.org/docs/18/app-pgdumpall.html&#34; rel=&#34;noopener&#34;&gt;pg_dumpall&lt;/a&gt;, et &lt;a href=&#34;https://www.postgresql.org/docs/18/app-pgrestore.html&#34; rel=&#34;noopener&#34;&gt;pg_restore&lt;/a&gt;.&lt;/p&gt;&#xA;&lt;h3 id=&#34;maintenance&#34;&gt;&lt;a class=&#34;heading-anchor&#34; href=&#34;#maintenance&#34;&gt;Maintenance&lt;/a&gt;&lt;/h3&gt;&#xA;&lt;p&gt;Il est désormais plus simple d’évaluer l’effort de maintenance sur les objets, puisque le temps total passé dans les opérations VACUUM et ANALYZE (y compris&lt;br&gt;&#xA;automatiques) est rapporté dans &lt;a href=&#34;https://www.postgresql.org/docs/18/monitoring-stats.html#MONITORING-PG-STAT-ALL-TABLES-VIEW&#34; rel=&#34;noopener&#34;&gt;pg_stat_all_tables&lt;/a&gt; et ses variantes.&lt;/p&gt;&#xA;&lt;p&gt;Un nouveau GUC à ne pas oublier: &lt;a href=&#34;https://www.postgresql.org/docs/18/runtime-config-statistics.html#GUC-TRACK-COST-DELAY-TIMING&#34; rel=&#34;noopener&#34;&gt;track_cost_delay_timing&lt;/a&gt;. Il collecte le temps passé à dormir (suite aux opérations retardées) pour &lt;code&gt;VACUUM&lt;/code&gt; et &lt;code&gt;ANALYZE&lt;/code&gt;. Très intéressant, mais comme les autres GUC &lt;code&gt;track_io*&lt;/code&gt;, il multiplie les appels à l’horloge système, ce qui peut provoquer un impact sévère sur certaines plateformes. Toujours vérifier avec un outil comme &lt;a href=&#34;https://www.postgresql.org/docs/18/pgtesttiming.html&#34; rel=&#34;noopener&#34;&gt;pg_test_timing&lt;/a&gt; pour s’assurer que votre système peut le supporter!&lt;/p&gt;&#xA;&lt;p&gt;Plus de questions sur l’activité du checkpointer grâce à &lt;a href=&#34;https://www.postgresql.org/docs/18/monitoring-stats.html#MONITORING-PG-STAT-CHECKPOINTER-VIEW&#34; rel=&#34;noopener&#34;&gt;pg_stat_checkpointer&lt;/a&gt;. Le nouvel attribut &lt;code&gt;num_done&lt;/code&gt; indique le nombre de checkpoints &lt;strong&gt;terminés&lt;/strong&gt;. Vous pouvez aussi savoir quel type de buffers a été écrit grâce à &lt;code&gt;slru_written&lt;/code&gt;, et &lt;code&gt;buffers_written&lt;/code&gt; qui ne concerne désormais que &lt;code&gt;shared_buffers&lt;/code&gt;: auparavant, journal et vue n’affichaient pas les mêmes totaux, car un compteur &lt;code&gt;SLRU&lt;/code&gt; &lt;a href=&#34;https://git.postgresql.org/gitweb/?p=postgresql.git;a=commitdiff;h=17cc5f666&#34; rel=&#34;noopener&#34;&gt;existait dans un cas mais pas dans l’autre&lt;/a&gt;.&lt;/p&gt;&#xA;&lt;h3 id=&#34;analyse&#34;&gt;&lt;a class=&#34;heading-anchor&#34; href=&#34;#analyse&#34;&gt;Analyse&lt;/a&gt;&lt;/h3&gt;&#xA;&lt;p&gt;Envie d’en savoir plus sur l’I/O traité par un backend (PID) ? Appelez &lt;a href=&#34;https://www.postgresql.org/docs/18/monitoring-stats.html#PG-STAT-GET-BACKEND-IO&#34; rel=&#34;noopener&#34;&gt;pg_stat_get_backend_io(int)&lt;/a&gt; et vous obtiendrez une sortie similaire à la vue &lt;code&gt;pg_stat_io&lt;/code&gt;, mais pour ce processus. Pour les stats WAL de ce PID: utilisez &lt;a href=&#34;https://www.postgresql.org/docs/18/monitoring-stats.html#PG-STAT-GET-BACKEND-WAL&#34; rel=&#34;noopener&#34;&gt;pg_stat_get_backend_wal(int)&lt;/a&gt;.&lt;/p&gt;&#xA;&lt;p&gt;De nouveaux attributs &lt;code&gt;parallel_workers_to_launch&lt;/code&gt; et &lt;code&gt;parallel_workers_launched&lt;/code&gt; apparaissent dans &lt;a href=&#34;https://www.postgresql.org/docs/18/monitoring-stats.html#MONITORING-PG-STAT-DATABASE-VIEW&#34; rel=&#34;noopener&#34;&gt;pg_stat_database&lt;/a&gt;. Le ratio permet de savoir si nous avons assez de slots pour les workers parallèles.&lt;/p&gt;&#xA;&lt;p&gt;Changements intéressants dans &lt;a href=&#34;https://www.postgresql.org/docs/18/pgstatstatements.html&#34; rel=&#34;noopener&#34;&gt;pg_stat_statements&lt;/a&gt;: plus de requêtes seront regroupées sous le même identifiant. Par exemple, les&lt;br&gt;&#xA;motifs &lt;code&gt;IN (1,2,3, ...)&lt;/code&gt; n’utiliseront que la première et la dernière constante. Un changement plus contre-intuitif concerne le nom de table utilisé dans une requête: seul le nom est pris en compte, pas le schéma ni l’OID de relation. Cela permet de suivre les tables supprimées ou recréées, mais cela peut aussi regrouper les stats de tables sans lien ayant simplement le même nom. Pour séparer les stats de tables homonymes, il faudra les aliaser dans les requêtes (&lt;code&gt;FROM my.table mt, other.table ot&lt;/code&gt;)…&lt;/p&gt;&#xA;&lt;p&gt;Enfin, ajouts à &lt;a href=&#34;https://www.postgresql.org/docs/18/view-pg-backend-memory-contexts.html&#34; rel=&#34;noopener&#34;&gt;pg_backend_memory_contexts&lt;/a&gt; avec &lt;code&gt;path&lt;/code&gt; (pour récupérer parent/enfant) et &lt;code&gt;type&lt;/code&gt; pour distinguer les contextes &lt;code&gt;AllocSet&lt;/code&gt;, &lt;code&gt;Generation&lt;/code&gt;, &lt;code&gt;Slab&lt;/code&gt; et &lt;code&gt;Bump&lt;/code&gt;… Et au fait, que sont &lt;code&gt;Slab&lt;/code&gt; et &lt;code&gt;Bump&lt;/code&gt; ? Pas documentés ; il faut &lt;a href=&#34;https://github.com/postgres/postgres/tree/master/src/backend/utils/mmgr&#34; rel=&#34;noopener&#34;&gt;lire les en-têtes des fichiers C ici&lt;/a&gt;. Ils existent pour optimiser l’allocation, la réallocation et la réinitialisation mémoire selon les usages attendus. Par exemple, &lt;code&gt;Slab&lt;/code&gt; est défini comme un «MemoryContext implementation designed for cases where large numbers of equally-sized objects can be allocated and freed efficiently with minimal memory wastage and fragmentation».&lt;/p&gt;&#xA;&lt;p&gt;Ah, non, encore une dernière: &lt;code&gt;wal_buffers_full&lt;/code&gt; a été ajouté à &lt;code&gt;pg_stat_statements&lt;/code&gt; pour permettre un meilleur réglage de &lt;code&gt;wal_buffers&lt;/code&gt;.&lt;/p&gt;&#xA;&lt;h3 id=&#34;replication&#34;&gt;&lt;a class=&#34;heading-anchor&#34; href=&#34;#replication&#34;&gt;Réplication&lt;/a&gt;&lt;/h3&gt;&#xA;&lt;p&gt;De meilleures informations apparaissent désormais pour la gestion des conflits en réplication logique grâce à de nouveaux attributs dans &lt;a href=&#34;https://www.postgresql.org/docs/18/monitoring-stats.html#MONITORING-PG-STAT-SUBSCRIPTION-STATS&#34; rel=&#34;noopener&#34;&gt;pg_stat_subscription_stats&lt;/a&gt;. En référence, cet extrait du &lt;a href=&#34;https://git.postgresql.org/gitweb/?p=postgresql.git;a=commitdiff;h=6c2b5edec&#34; rel=&#34;noopener&#34;&gt;commit&lt;/a&gt; liste les attributs introduits:&lt;/p&gt;&#xA;&lt;ul class=&#34;list&#34;&gt;&#xA;&lt;li&gt;&lt;code&gt;confl_insert_exists&lt;/code&gt;: nombre de fois où une insertion de ligne a violé une contrainte unique NOT DEFERRABLE.&lt;/li&gt;&#xA;&lt;li&gt;&lt;code&gt;confl_update_origin_differs&lt;/code&gt;: nombre de fois où une mise à jour a été faite sur une ligne déjà modifiée par une autre origine.&lt;/li&gt;&#xA;&lt;li&gt;&lt;code&gt;confl_update_exists&lt;/code&gt;: nombre de fois où la valeur mise à jour d’une ligne viole une contrainte unique NOT DEFERRABLE.&lt;/li&gt;&#xA;&lt;li&gt;&lt;code&gt;confl_update_missing&lt;/code&gt;: nombre de fois où le tuple à mettre à jour est manquant.&lt;/li&gt;&#xA;&lt;li&gt;&lt;code&gt;confl_delete_origin_differs&lt;/code&gt;: nombre de fois où une suppression a été effectuée sur une ligne déjà modifiée par une autre origine.&lt;/li&gt;&#xA;&lt;li&gt;&lt;code&gt;confl_delete_missing&lt;/code&gt;: nombre de fois où le tuple à supprimer est manquant.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h3 id=&#34;avance&#34;&gt;&lt;a class=&#34;heading-anchor&#34; href=&#34;#avance&#34;&gt;Avancé&lt;/a&gt;&lt;/h3&gt;&#xA;&lt;p&gt;Un &lt;a href=&#34;https://www.postgresql.org/docs/18/functions-admin.html#FUNCTIONS-ADMIN-STATSMOD&#34; rel=&#34;noopener&#34;&gt;nouveau jeu de fonctions&lt;/a&gt; permet désormais de gérer les statistiques de relations et d’attributs (&lt;code&gt;relpages&lt;/code&gt;, &lt;code&gt;avg_width&lt;/code&gt;, etc.). Cela offre la possibilité d’exporter, importer et ajuster les stats à volonté, afin de répliquer le comportement du planificateur hors production, de maintenir des stats corrigées, et plus encore.&lt;/p&gt;&#xA;&lt;h3 id=&#34;mon-prefere-pour-les-auteurs-dextensions-la-nouvelle-api-c-de-stats&#34;&gt;&lt;a class=&#34;heading-anchor&#34; href=&#34;#mon-prefere-pour-les-auteurs-dextensions-la-nouvelle-api-c-de-stats&#34;&gt;Mon préféré pour les auteurs d’extensions: la nouvelle API C de stats&lt;/a&gt;&lt;/h3&gt;&#xA;&lt;p&gt;L’une des évolutions les plus enthousiasmantes est ce que PostgreSQL 18 &lt;em&gt;ouvre&lt;/em&gt; aux auteurs d’extensions.&lt;/p&gt;&#xA;&lt;p&gt;Cette petite ligne au bas de la section &lt;a href=&#34;https://www.postgresql.org/docs/18/release-18.html#RELEASE-18-MODULES&#34; rel=&#34;noopener&#34;&gt;E.1.3.9 Modules&lt;/a&gt; est celle qui nous intéresse :&lt;/p&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;Allow extensions to use the server’s cumulative statistics API (Michael Paquier)&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;p&gt;Jusqu’ici, la manipulation des statistiques était réservée à l’interne ; désormais, une API officielle et structurée est disponible pour construire (ou envelopper) autour.&lt;/p&gt;&#xA;&lt;p&gt;Le &lt;a href=&#34;https://git.postgresql.org/gitweb/?p=postgresql.git;a=commitdiff;h=7949d9594&#34; rel=&#34;noopener&#34;&gt;message de commit&lt;/a&gt; est bien rédigé et couvre l’essentiel des nouveautés. Un sous-ensemble des options est &lt;a href=&#34;https://www.postgresql.org/docs/18/xfunc-c.html#XFUNC-ADDIN-CUSTOM-CUMULATIVE-STATISTICS&#34; rel=&#34;noopener&#34;&gt;détaillé dans la documentation&lt;/a&gt;. Cependant, il faut encore plonger dans le code source pour en savoir plus ; en particulier, il vaut la peine de regarder l’extension &lt;code&gt;injection points&lt;/code&gt; (fournie avec PostgreSQL) qui utilise cette nouvelle API.&lt;/p&gt;&#xA;&lt;p&gt;Pour aller plus loin sur la manière dont une extension peut exploiter ces nouvelles capacités, vous pourrez bientôt découvrir &lt;strong&gt;PACS (PostgreSQL Advanced Cumulative Statistics)&lt;/strong&gt; sur Codeberg : mon projet qui propose une bibliothèque de wrappers et des utilitaires autour des nouvelles APIs de statistiques de PostgreSQL 18.&lt;/p&gt;&#xA;&lt;p&gt;En attendant, la présentation que j’ai donnée à &lt;a href=&#34;https://archive.fosdem.org/2025/schedule/event/fosdem-2025-4496-stats-roll-baby-stats-roll-/&#34; rel=&#34;noopener&#34;&gt;FOSDEM 2025&lt;/a&gt; explore ce sujet plus en détail.&lt;/p&gt;&#xA; </content>
    <link href="https://www.data-bene.io/fr/blog/statistiques-cumulatives-dans-postgresql-18/" rel="alternate"></link>
    <summary type="html"></summary>
    <author>
      <name>Frédéric Delacourt</name>
    </author>
  </entry>
  <entry>
    <title>Base de données la plus désirée trois années consécutives : L&#39;attrait de PostgreSQL pour les développeurs</title>
    <updated>2025-08-09T00:00:00Z</updated>
    <id>tag:www.data-bene.io,2025-08-09:/fr/blog/base-de-donnees-la-plus-desiree-trois-annees-consecutives/</id>
    <content type="html"> &lt;p&gt;PostgreSQL vit plus qu’un simple moment de gloire—elle établit un schéma clair d’excellence soutenue. Pour la troisième année consécutive, cette base de données pilotée par la communauté a revendiqué la première place dans les résultats 2025 de l’enquête annuelle des développeurs de Stack Overflow, et les résultats révèlent à la fois ce que les développeurs valorisent aujourd’hui et où se dirige le paysage des bases de données.&lt;/p&gt;&#xA;&lt;p&gt;Les résultats de l’enquête montrent que PostgreSQL est classée au plus haut rang parmi toutes les technologies de bases de données pour les développeurs qui veulent l’utiliser dans la prochaine année (47%) ou l’ont utilisée cette année et veulent continuer à l’utiliser l’année prochaine (66%) pour la troisième année d’affilée.&lt;/p&gt;&#xA;&lt;h2 id=&#34;les-chiffres-racontent-une-histoire-convaincante&#34;&gt;&lt;a class=&#34;heading-anchor&#34; href=&#34;#les-chiffres-racontent-une-histoire-convaincante&#34;&gt;Les chiffres racontent une histoire convaincante&lt;/a&gt;&lt;/h2&gt;&#xA;&lt;p&gt;Les données de l’enquête de plus de 49 000 développeurs à travers 177 pays fournissent une preuve claire de l’attrait soutenu de PostgreSQL. Depuis 2023, PostgreSQL s’est constamment classée comme la technologie de base de données la plus désirée et la plus admirée parmi les développeurs.&lt;/p&gt;&#xA;&lt;p&gt;En regardant les mesures spécifiques des visualisations de l’enquête, PostgreSQL mène avec 46,5% des développeurs voulant travailler avec elle dans l’année à venir, tandis qu’un impressionnant 65,5% de ceux qui l’ont utilisée veulent continuer à le faire. Ce ne sont pas seulement des chiffres impressionnants—ils représentent une cohérence qui est rare dans le paysage technologique en rapide évolution.&lt;/p&gt;&#xA;&lt;p&gt;Les données de l’enquête révèlent également un schéma intéressant parmi les développeurs utilisant actuellement d’autres technologies de bases de données. Les développeurs travaillant avec MongoDB et Redis montrent un désir particulièrement fort d’ajouter PostgreSQL à leur boîte à outils l’année prochaine, voyant la valeur d’ajouter des compétences en bases de données relationnelles à leur répertoire.&lt;/p&gt;&#xA;&lt;h2 id=&#34;lavantage-communautaire-en-action&#34;&gt;&lt;a class=&#34;heading-anchor&#34; href=&#34;#lavantage-communautaire-en-action&#34;&gt;L’avantage communautaire en action&lt;/a&gt;&lt;/h2&gt;&#xA;&lt;p&gt;Pourquoi PostgreSQL a-t-elle atteint ce niveau de succès soutenu ? La réponse réside dans son modèle de développement piloté par la communauté. En tant que projet open source, PostgreSQL bénéficie d’un développement collaboratif qui est à la fois transparent et réactif aux besoins du monde réel.&lt;/p&gt;&#xA;&lt;p&gt;Le projet PostgreSQL représente le meilleur de ce que le développement piloté par la communauté peut accomplir. Avec plus de 400 contributeurs de code à travers plus de 140 entreprises de soutien, le projet se vante de plus de 55 000 commits et plus de 1,6 million de lignes de code soigneusement élaboré. Cette approche diverse et globalement distribuée du développement résulte en des tests plus approfondis, des corrections de bogues plus rapides, et des fonctionnalités plus innovantes que les modèles de développement commercial traditionnels n’atteignent typiquement.&lt;/p&gt;&#xA;&lt;p&gt;Les versions majeures sont publiées annuellement avec approximativement 180 fonctionnalités par version, complétées par des versions mineures trimestrielles qui incluent de nombreuses améliorations et corrections. Cette cadence régulière d’innovation constamment contribuée par des individus partout dans le monde assure que PostgreSQL ne fait pas que suivre le rythme des besoins des développeurs—elle les anticipe. Plus que cela, chaque individu a la capacité de contribuer au projet pour s’assurer que partout où le logiciel prend du retard, la fonctionnalité change pour répondre aux demandes modernes.&lt;/p&gt;&#xA;&lt;h2 id=&#34;plus-quune-simple-base-de-donnees-relationnelle&#34;&gt;&lt;a class=&#34;heading-anchor&#34; href=&#34;#plus-quune-simple-base-de-donnees-relationnelle&#34;&gt;Plus qu’une simple base de données relationnelle&lt;/a&gt;&lt;/h2&gt;&#xA;&lt;p&gt;Un facteur clé dans l’attrait large de PostgreSQL est qu’elle n’est pas limitée à être juste un système de base de données relationnelle. PostgreSQL est objet-relationnelle par conception, capable de gérer des types de données diverses incluant JSON/JSONB, XML, Clé-Valeur, géométriques, géospatiales, UUID natif, et données de séries temporelles. Cette polyvalence explique pourquoi les développeurs de milieux NoSQL trouvent PostgreSQL attractive—elle offre la fiabilité relationnelle tout en maintenant la flexibilité à laquelle ils sont habitués.&lt;/p&gt;&#xA;&lt;p&gt;Le soutien étendu pour différents types de données, combiné avec les caractéristiques ACID (Atomicité, Cohérence, Isolation, Durabilité), permet une gestion de données optimisée, performante, et fiable indépendamment des exigences spécifiques en place. De plus, l’énorme réseau d’extensions piloté par la communauté de PostgreSQL s’appuie sur son extensibilité native, fournissant des solutions pour la gestion géospatiale, la récupération après sinistre, l’infrastructure de haute disponibilité, la surveillance, l’audit, et bien plus.&lt;/p&gt;&#xA;&lt;h2 id=&#34;le-paysage-plus-large-des-bases-de-donnees&#34;&gt;&lt;a class=&#34;heading-anchor&#34; href=&#34;#le-paysage-plus-large-des-bases-de-donnees&#34;&gt;Le paysage plus large des bases de données&lt;/a&gt;&lt;/h2&gt;&#xA;&lt;p&gt;Tandis que PostgreSQL domine les positions de tête, l’enquête révèle un écosystème de bases de données sain et compétitif. Les classements complets montrent :&lt;/p&gt;&#xA;&lt;p&gt;&lt;strong&gt;Bases de données les plus désirées :&lt;/strong&gt;&lt;br&gt;&#xA;• PostgreSQL : 46,5%&lt;br&gt;&#xA;• SQLite : 28,3%&lt;br&gt;&#xA;• Redis : 23,5%&lt;br&gt;&#xA;• MySQL : 20,5%&lt;br&gt;&#xA;• MongoDB : 17,6%&lt;/p&gt;&#xA;&lt;p&gt;&lt;strong&gt;Bases de données les plus admirées :&lt;/strong&gt;&lt;br&gt;&#xA;• PostgreSQL : 65,5%&lt;br&gt;&#xA;• SQLite : 59%&lt;br&gt;&#xA;• Redis : 54,9%&lt;br&gt;&#xA;• MongoDB : 45,7%&lt;br&gt;&#xA;• MySQL : 43,2%&lt;/p&gt;&#xA;&lt;p&gt;Ces chiffres reflètent un écosystème diversifié où différentes bases de données servent des objectifs spécifiques. La forte performance de SQLite souligne l’importance continue des solutions légères et intégrées. Redis maintient sa position comme une base de données spécialisée hautement considérée pour la mise en cache et les applications temps réel. Les bases de données traditionnelles comme MySQL et Microsoft SQL Server continuent de détenir des positions significatives, tandis que les nouvelles technologies comme DuckDB montrent des scores d’admiration impressionnants malgré des taux d’utilisation plus faibles.&lt;/p&gt;&#xA;&lt;h2 id=&#34;la-fondation-du-succes-durable-de-postgresql&#34;&gt;&lt;a class=&#34;heading-anchor&#34; href=&#34;#la-fondation-du-succes-durable-de-postgresql&#34;&gt;La fondation du succès durable de PostgreSQL&lt;/a&gt;&lt;/h2&gt;&#xA;&lt;p&gt;Trois années consécutives au sommet des préférences des développeurs n’arrive pas par accident. La domination soutenue de PostgreSQL découle de forces fondamentales qui continuent de bien servir les développeurs alors que les paysages technologiques changent. La résilience intégrée dans PostgreSQL à travers son modèle de développement piloté par la communauté signifie qu’elle s’adapte sans perdre la stabilité. Son extensibilité la distingue de manières pratiques—plutôt que d’attendre les feuilles de route des fournisseurs ou de s’inquiéter des lacunes de fonctionnalités, les développeurs peuvent construire ce dont ils ont besoin ou tirer parti de l’écosystème étendu d’extensions communautaires. La nature open source assure que PostgreSQL reste focalisée sur les besoins des développeurs plutôt que sur les modèles d’affaires, avec des corrections de bogues qui se produisent rapidement et des fonctionnalités qui se développent basées sur des cas d’usage du monde réel.&lt;/p&gt;&#xA;&lt;p&gt;Après 35 ans de développement actif et trois années consécutives comme la technologie de base de données la plus désirée, PostgreSQL a prouvé que le développement open source piloté par la communauté peut livrer à la fois une utilité immédiate et une valeur à long terme. Pour les développeurs et organisations regardant leurs choix de bases de données, PostgreSQL offre quelque chose d’increasingly rare : une technologie qui s’améliore avec le temps sans laisser ses utilisateurs derrière.&lt;/p&gt;&#xA; </content>
    <link href="https://www.data-bene.io/fr/blog/base-de-donnees-la-plus-desiree-trois-annees-consecutives/" rel="alternate"></link>
    <summary type="html"></summary>
    <author>
      <name>Frédéric Delacourt</name>
    </author>
  </entry>
  <entry>
    <title>Retour de HOW2025</title>
    <updated>2025-07-14T00:00:00Z</updated>
    <id>tag:www.data-bene.io,2025-07-14:/fr/blog/retour-de-how2025/</id>
    <content type="html"> &lt;p&gt;Les 27 et 28 juin se tenaient les conférences Highgo Open World, consacrées à l’écosystème PostgreSQL et au projet IvorySQL. Côté chiffres, le succès est notable : près de 1 000 participants sur place, jusqu’à 8 000 connexions simultanées sur les streams, et environ 25 000 spectateurs au total.&lt;/p&gt;&#xA;&lt;p&gt;Le programme comptait 101 conférences techniques animées par 105 intervenants. La majorité des sessions étaient en mandarin, avec un track anglophone proposé en traduction simultanée. Vous pouvez consulter le programme complet sur &lt;a href=&#34;https://ivorysql.io/schedule/&#34; rel=&#34;noopener&#34;&gt;IvorySQL.io&lt;/a&gt; et retrouver les replays sur Weibo via &lt;a href=&#34;https://ivorysql.io/2025/06/27/live-access-june27/&#34; rel=&#34;noopener&#34;&gt;ce lien.&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;Nous étions un petit groupe de la communauté internationale présents, dont &lt;a href=&#34;https://postgresql.life/post/grant_zhou/&#34; rel=&#34;noopener&#34;&gt;Grant Zhou&lt;/a&gt; qui assure entre autre la liaison et la collaboration avec l’association PostgreSQL en Chine et dans le reste du monde.&lt;/p&gt;&#xA;&lt;p&gt;Sur le plan technique, le contenu était dense et particulièrement intéressant. J’ai retenu notamment :&lt;/p&gt;&#xA;&lt;ul class=&#34;list&#34;&gt;&#xA;&lt;li&gt;&#xA;&lt;p&gt;La présentation d’Alena Rybakina sur le planificateur de requêtes PostgreSQL et les stratégies pour contourner certaines limites.&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;&#xA;&lt;p&gt;Un focus clair et concret sur Patroni (Haute-Disponibilité) par Alexander Kukushkin et Polina Bungina.&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;&#xA;&lt;p&gt;Florentz Tselai a présenté 2 sujets en appliquant ses préceptes: simplicité efficacité, sur l’utilisation de «l’IA» avec PostgreSQL et la gestion des données avec comme support Sun Tzu et les 36 stratagèmes.&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;&#xA;&lt;p&gt;Également une très bonne introduction à Bazel et son utilisation pour Monogres (à découvrir bientôt) présenté avec énergie par Alvaro Hernandez.&lt;/p&gt;&#xA;&lt;p&gt;Monogres est une initiative très intéressante qui doit permettre de renforcer le contrôle de la supply chain logicielle, un thème  majeur dans l’IT de nos jours. Et j’y ai aussi vu une très belle occasion d’offrir une vitrine a des variations de PostgreSQL avec des fonctionnalités et des correctifs dont l’inclusion dans PostgreSQL lui-même même ou le backport dans des version majeures précédentes n’est pas toujours possible.&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;&#xA;&lt;p&gt;Michael Meskes avait l’honneur d’une conférence plénière pour un sujet qui le mérite largement: « From Code to Commerce: Open Source Business Models Today », une keynote sur l’open-source et les logiciels libres, appliqués à l’écosystème PostgreSQL.&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;&#xA;&lt;p&gt;Mon collègue Andrea a présenté les évolutions et les tendances des entreprises pour transiter vers IvorySQL et PostgreSQL&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;&#xA;&lt;p&gt;Pour ma part, j’ai présenté linux PSI dans le contexte PostgreSQL.&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;Comme tout est en streaming, je vous encourage à aller explorer et visionner les sujets qui vous intéressent. Il y a ausi des conférences en anglais pré-enregistrées mais j’avoue avoir profité des créneaux pour échanger avec des participants.&lt;/p&gt;&#xA;&lt;p&gt;En apparté des conférences, j’ai eu la chance de rencontrer plusieurs membres de la communauté PostgreSQL chinoise très réputés pour leur implication dans le succès de PostgreSQL localement. J’ai eu aussi l’occasion d’en apprendre d’avantage sur Cloudberry, en remplacement de Greenplum, merci Dianjin Wang!&lt;/p&gt;&#xA;&lt;hr&gt;&#xA;&lt;p&gt;Pour Data Bene s’était également un moment prévu pour rencontrer l’équipe en charge d’IvorySQL, basée en grande partie dans le Shandong, la province où se trouve Jinan, ville hôte des conférences. Ivory est un projet auquel nous participons activement et qui permet aux entreprises de s’affranchir d’Oracle «en douceur». C’est un sujet important pour nos clients et qui occupe un place prépondérante dans notre partenariat avec Highgo: ils portent ce projet depuis plusieurs années déjà et nous voulons permettre aux entreprises européenes d’en profiter avec un accompagnement et expertise adaptée.&lt;/p&gt;&#xA;&lt;hr&gt;&#xA;&lt;p&gt;Les conférences étaient très bien organisées et l’acceuil formidable, le «Social Event» au «beer garden» local parfaitement adapté à la chaleur de Jinan fin juin!&lt;/p&gt;&#xA;&lt;p&gt;Vu le programme des conférences j’ai amèrement regreté de ne rien comprendre (Il y avait 1 track en Anglais et 5 en Mandarin) … mais il se dit déjà que l’an prochain les conférences en Mandarin pourraient peut être être traduites (en anglais), et la date avancée en Mai pour profiter d’un climat plus doux.&lt;/p&gt;&#xA;&lt;p&gt;Il y a tellement à y apprendre que j’y retournerai avec grand plaisir.&lt;/p&gt;&#xA; </content>
    <link href="https://www.data-bene.io/fr/blog/retour-de-how2025/" rel="alternate"></link>
    <summary type="html"></summary>
    <author>
      <name>Frédéric Delacourt</name>
    </author>
  </entry>
  <entry>
    <title>Une visite à PGConf.DE 2025 et des discussions sur PostgreSQL dans le contexte des sciences de la vie</title>
    <updated>2025-06-06T00:00:00Z</updated>
    <id>tag:www.data-bene.io,2025-06-06:/fr/blog/une-visite-a-pgconfde-2025-et-des-discussions-sur-PostgreSQL-dans-le-contexte-des-sciences-de-la-vie/</id>
    <content type="html"> &lt;p&gt;C’est toujours un plaisir d’assister aux événements Postgres, et la &lt;a href=&#34;http://PGConf.DE&#34; rel=&#34;noopener&#34;&gt;PGConf.DE&lt;/a&gt; 2025 à Berlin n’a pas fait exception. Cette année, l’événement a permis de renouer de vieilles amitiés et a offert un environnement ouvert et accueillant pour en nouer de nouvelles. Et, bien sûr, il y a eu des exposés passionnants!&lt;/p&gt;&#xA;&lt;p&gt;Lors de la conférence, j’ai eu l’occasion de parler de Postgres dans le contexte des sciences de la vie (voir la section suivante). Dans l’ensemble, j’ai trouvé qu’il y avait une belle diversité de présentations : une sélection qui couvrait le cœur de Postgres, son écosystème et bien plus encore.&lt;/p&gt;&#xA;&lt;p&gt;Je suis convaincu qu’à la fin de la conférence, la plupart des participants, sinon tous, sont repartis plus riches qu’ils n’étaient venus, d’une manière ou d’une autre.&lt;/p&gt;&#xA;&lt;h2 id=&#34;presentations&#34;&gt;&lt;a class=&#34;heading-anchor&#34; href=&#34;#presentations&#34;&gt;Présentations&lt;/a&gt;&lt;/h2&gt;&#xA;&lt;p&gt;En amont de cet événement, j’ai eu l’honneur de voir l’une de mes conférences retenue. Son titre était : « &lt;a href=&#34;https://www.postgresql.eu/events/pgconfde2025/schedule/session/6541-postgres-and-life-science-from-cells-to-stars/&#34; rel=&#34;noopener&#34;&gt;Postgres et les sciences de la vie : des cellules aux étoiles&lt;/a&gt;&amp;quot; et il était organisé comme une méta-analyse / un hommage à l’extensibilité de Postgres et à ses diverses applications au monde naturel.&lt;/p&gt;&#xA;&lt;p&gt;Afin de raconter au mieux cette histoire, j’ai présenté au public les cinq sujets suivants, de portée croissante :&lt;/p&gt;&#xA;&lt;ul class=&#34;list&#34;&gt;&#xA;&lt;li&gt;Cartographie neuronale avec une interface graphique compatible PostGIS&#xA;&lt;ul class=&#34;list&#34;&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://github.com/catmaid/CATMAID&#34; rel=&#34;noopener&#34;&gt;Code source de CATMAID&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;Examen hydrologique des rivières avec l’extension PgHydro&#xA;&lt;ul class=&#34;list&#34;&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://github.com/pghydro/pghydro&#34; rel=&#34;noopener&#34;&gt;Code source de PgHydro&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;Méta-analyse de la biomasse des poissons avec Vanilla Postgres&#xA;&lt;ul class=&#34;list&#34;&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.nature.com/articles/s41597-024-04026-0&#34; rel=&#34;noopener&#34;&gt;Lien vers une publication évaluée par des pairs&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;Tableau de bord de la COVID-19 avec l’extension Citus&#xA;&lt;ul class=&#34;list&#34;&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.citusdata.com/blog/2021/12/11/uk-covid-19-dashboard-built-using-postgres-and-citus/&#34; rel=&#34;noopener&#34;&gt;Lien vers l’article de blog&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;Classification par étoiles basée sur des forks de Postgres et des modifications d’extensions&#xA;&lt;ul class=&#34;list&#34;&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://indico.cern.ch/event/1471762/contributions/6280216/&#34; rel=&#34;noopener&#34;&gt;Lien vers la présentation au Cern PGDay - 2025&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;J’ai apprécié la préparation et la présentation de cette conférence, qui a donné lieu à des échanges enrichissants. Deux points ont particulièrement retenu mon attention et me semblaient intéressants à aborder ici :&lt;/p&gt;&#xA;&lt;ol class=&#34;list&#34;&gt;&#xA;&lt;li&gt;&#xA;&lt;p&gt;Quelles sont les trois technologies (outils/flux de travail) qui bénéficieraient le plus, en termes d’amélioration d’impact ou de facilité d’adoption, si leurs complexités étaient considérablement réduites/abstraites ?&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;&#xA;&lt;p&gt;Lors de ma présentation, j’ai affirmé que le cerveau était compatible avec l’ACID. Bien que je fasse principalement référence aux potentiels d’action des neurones, cette affirmation a été légitimement contestée.&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&lt;h3 id=&#34;1-outils-/-flux-de-travail-identifies&#34;&gt;&lt;a class=&#34;heading-anchor&#34; href=&#34;#1-outils-/-flux-de-travail-identifies&#34;&gt;1. Outils / flux de travail identifiés&lt;/a&gt;&lt;/h3&gt;&#xA;&lt;p&gt;&lt;em&gt;1. Quelles sont les trois technologies (outils/flux de travail) qui bénéficieraient le plus, en termes d’amélioration d’impact ou de facilité d’adoption, si leurs complexités étaient considérablement réduites/abstraites ?&lt;/em&gt;&lt;/p&gt;&#xA;&lt;h4 id=&#34;1-vectorisation-dimage&#34;&gt;&lt;a class=&#34;heading-anchor&#34; href=&#34;#1-vectorisation-dimage&#34;&gt;1. Vectorisation d’image&lt;/a&gt;&lt;/h4&gt;&#xA;&lt;p&gt;Dès le départ, j’ai pensé à la classification des images issues de scanner à résonance magnétique. Ce sujet est très discuté au sein de la communauté médicale, et de nombreuses startups se sont également lancées dans ce domaine. Personnellement, je pense qu’il y a en effet une dynamique pour améliorer l’accessibilité, mais qu’il existe encore une forte séparation entre le développeur et l’utilisateur final. Bien que je n’aie pas de réponse toute faite à ce stade, je vous conseillerais, pour commencer, de vous renseigner sur &lt;a href=&#34;https://github.com/pgvector/pgvector&#34; rel=&#34;noopener&#34;&gt;vecteur pg&lt;/a&gt; et &lt;a href=&#34;https://github.com/postgresml/postgresml&#34; rel=&#34;noopener&#34;&gt;postgresml&lt;/a&gt;. Compte tenu de l’intégration des vecteurs et de l’apprentissage automatique dans ce défi, j’envisagerais d’utiliser un service d’intégration d’images pour convertir la sortie IRM brute en un format compatible avec pgvector.&lt;/p&gt;&#xA;&lt;h4 id=&#34;2-gestion-des-donnees-et-controle-des-versions&#34;&gt;&lt;a class=&#34;heading-anchor&#34; href=&#34;#2-gestion-des-donnees-et-controle-des-versions&#34;&gt;2. Gestion des données et contrôle des versions&lt;/a&gt;&lt;/h4&gt;&#xA;&lt;p&gt;En tant qu’ancien universitaire, je peux témoigner de l’omniprésence des feuilles de calcul classiques (le format .csv étant moins courant, mais toujours utilisé). De plus, les fichiers sont généralement stockés dans des répertoires locaux, sur un serveur privé ou dans une infrastructure partagée, mais avec une architecture de dossiers classique. On imagine aisément les frictions potentielles lorsque la conversation s’étend à plusieurs chercheurs de différents groupes. Si l’on ajoute à cela un taux de rotation naturellement élevé des étudiants, associé à une mentalité de « j’aime faire les choses à ma façon », on comprend l’importance des normes. Si les améliorations peuvent être abordées sous différents angles, je souhaiterais me concentrer sur la gestion des données et le contrôle des versions.&lt;/p&gt;&#xA;&lt;p&gt;Des données bien ordonnées et une bonne hygiène organisationnelle sont des gages de réussite dans tout domaine d’études. Cependant, le suivi des modifications se limite le plus souvent, voire exclusivement, aux documents texte. Bien que cela puisse surprendre le lecteur, le terme « dépôt de code » ne fait pas partie du vocabulaire universitaire courant. Même le terme « Linux » évoque un certain « mysterium tremendum et fascinans » (Otto, 1923). La sécurité des données étant une priorité, des options d’auto-hébergement telles que &lt;a href=&#34;https://forgejo.org/&#34; rel=&#34;noopener&#34;&gt;Forgejo&lt;/a&gt; pourraient être très utiles aux scientifiques du vivant, notamment en cas de réserves quant au stockage des données en ligne. Au lieu d’avoir plusieurs brouillons de fichiers, par exemple « draft-1_final », « draft_final_final », etc., des outils comme Forgejo permettent de suivre l’avancement des documents et d’offrir aux chercheurs une plus grande transparence sur les modifications passées (ce qui facilite la collaboration entre les équipes).&lt;/p&gt;&#xA;&lt;h4 id=&#34;3-conformite-et-audit&#34;&gt;&lt;a class=&#34;heading-anchor&#34; href=&#34;#3-conformite-et-audit&#34;&gt;3. Conformité et audit&lt;/a&gt;&lt;/h4&gt;&#xA;&lt;p&gt;La confiance est un sujet central dans tout domaine de recherche, et dans certaines circonstances, l’audit (ou toute autre forme de preuve de travail) peut occuper une place centrale. Dans le cas présent, Postgres et l’une de ses extensions associées, &lt;a href=&#34;https://github.com/pgaudit/pgaudit&#34; rel=&#34;noopener&#34;&gt;pgAudit&lt;/a&gt;, peuvent constituer une avancée significative vers la conformité. En raison des capacités de Postgres, ce service peut parfois être perçu comme intimidant et réservé aux grands projets. Je pense qu’il pourrait devenir très répandu grâce à la publication d’un guide du type « Postgres pour les petits projets ».&lt;/p&gt;&#xA;&lt;h4 id=&#34;decouverte-et-exposition&#34;&gt;&lt;a class=&#34;heading-anchor&#34; href=&#34;#decouverte-et-exposition&#34;&gt;Découverte et exposition&lt;/a&gt;&lt;/h4&gt;&#xA;&lt;p&gt;Au final, personne n’utilisera volontairement quelque chose sans en connaître l’existence. C’est pourquoi la découvrabilité est l’un des concepts les plus fondamentaux lorsqu’on parle d’impact et d’adoptabilité. Il appartient aux mainteneurs, aux contributeurs et aux communautés derrière ces outils open source de partager leurs avancées sur plusieurs plateformes et dans différentes conférences. Honnêtement, le moyen le plus simple d’aider est d’en parler et de mettre la main à la pâte.&lt;/p&gt;&#xA;&lt;h3 id=&#34;2-le-cerveau-et-la-conformite-a-lacid&#34;&gt;&lt;a class=&#34;heading-anchor&#34; href=&#34;#2-le-cerveau-et-la-conformite-a-lacid&#34;&gt;2. Le cerveau et la conformité à l’ACID&lt;/a&gt;&lt;/h3&gt;&#xA;&lt;p&gt;&lt;em&gt;2. Lors de ma conférence, j’ai affirmé que le cerveau était compatible avec l’ACID. Bien que je fasse principalement référence aux potentiels d’action des neurones, cette affirmation a été contestée à juste titre.&lt;/em&gt;&lt;/p&gt;&#xA;&lt;p&gt;Ce fut une autre discussion passionnante après la présentation, et même si elle mériterait un article de blog dédié, je souhaitais partager rapidement mes réflexions. Dans l’une de mes diapositives, j’ai affirmé que le cerveau est compatible avec ACID, du moins dans le sens où les transactions sont tout ou rien. Les neurones, un type cellulaire courant dans le cerveau, ont la caractéristique de recevoir des signaux qui se compilent jusqu’à atteindre un seuil, après quoi le neurone envoie son propre signal, ou « se déclenche ». C’est une simplification grossière : voici un petit lien &lt;a href=&#34;https://en.wikipedia.org/wiki/Action_potential&#34; rel=&#34;noopener&#34;&gt;Wikipédia&lt;/a&gt; pour plus d’informations.&lt;/p&gt;&#xA;&lt;p&gt;Cependant, des auditeurs perspicaces ont remarqué que le cerveau est complexe et comporte différentes régions. Il peut y avoir des pertes de mémoire et des activités pouvant altérer le fonctionnement et la conscience. Cependant, dans quelle mesure les influences externes sur le cerveau sont-elles liées à un système de base de données ? Si une base de données Postgres est corrompue, elle n’est plus compatible ACID, contrairement à ce qu’elle était auparavant. Tous ces points sont à la fois valables et intéressants. Il sera intéressant d’y réfléchir et de rédiger une réponse plus formelle.&lt;/p&gt;&#xA;&lt;h2 id=&#34;reflexions-finales&#34;&gt;&lt;a class=&#34;heading-anchor&#34; href=&#34;#reflexions-finales&#34;&gt;Réflexions finales&lt;/a&gt;&lt;/h2&gt;&#xA;&lt;p&gt;En résumé, ce fut une excellente conférence. Je sais que je parle au nom de tous les participants en remerciant tous ceux qui y ont contribué, qu’ils soient membres du personnel, bénévoles, intervenants ou autres.&lt;/p&gt;&#xA;&lt;h2 id=&#34;references&#34;&gt;&lt;a class=&#34;heading-anchor&#34; href=&#34;#references&#34;&gt;Références&lt;/a&gt;&lt;/h2&gt;&#xA;&lt;p&gt;Foote, K. J., Grant, J. W. A., &amp;amp; Biron, P. M. (2024). A global dataset of salmonid biomass in streams. Scientific data, 11(1), 1172. &lt;a href=&#34;https://doi.org/10.1038/s41597-024-04026-0&#34; rel=&#34;noopener&#34;&gt;https://doi.org/10.1038/s41597-024-04026-0&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;Giordano, C., &amp;amp; Hadjibagheri, P. (2021, December 11). UK COVID-19 dashboard built using Postgres and Citus for millions of users. Microsoft TechCommunity Blog. &lt;a href=&#34;https://techcommunity.microsoft.com/t5/azure-database-for-postgresql/uk-covid-19-dashboard-built-using-postgres-and-citus-for/ba-p/3039052&#34; rel=&#34;noopener&#34;&gt;https://techcommunity.microsoft.com/t5/azure-database-for-postgresql/uk-covid-19-dashboard-built-using-postgres-and-citus-for/ba-p/3039052&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;Kazimiers, T., et al. (2021). CATMAID (Collaborative Annotation Toolkit for Massive Amounts of Image Data) [Computer software]. GitHub. &lt;a href=&#34;https://github.com/catmaid/CATMAID&#34; rel=&#34;noopener&#34;&gt;https://github.com/catmaid/CATMAID&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;Krefl, D., &amp;amp; Nienartowicz, K. (2025, January 17). Harnessing Postgres and HPC for petabyte-scale variable star classification in astronomy [Conference presentation]. CERN PGDay 2025, Geneva, Switzerland. &lt;a href=&#34;https://indico.cern.ch/event/1336647/contributions/5660229/&#34; rel=&#34;noopener&#34;&gt;https://indico.cern.ch/event/1336647/contributions/5660229/&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;Otto, R. (1923). The idea of the holy: An inquiry into the non-rational factor in the idea of the divine and its relation to the rational (J. W. Harvey, Trans.). Oxford University Press. (Original work published 1917)&lt;/p&gt;&#xA;&lt;p&gt;Teixeira, A. de A., &amp;amp; PgHydro Project. (2022). pghydro (Version 6.6) [Computer software]. GitHub. &lt;a href=&#34;https://github.com/pghydro/pghydro&#34; rel=&#34;noopener&#34;&gt;https://github.com/pghydro/pghydro&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;Wikipedia contributors. (2025, May 16). Action potential. Wikipedia, The Free Encyclopedia. &lt;a href=&#34;https://en.wikipedia.org/wiki/Action_potential&#34; rel=&#34;noopener&#34;&gt;https://en.wikipedia.org/wiki/Action_potential&lt;/a&gt;&lt;/p&gt;&#xA; </content>
    <link href="https://www.data-bene.io/fr/blog/une-visite-a-pgconfde-2025-et-des-discussions-sur-PostgreSQL-dans-le-contexte-des-sciences-de-la-vie/" rel="alternate"></link>
    <summary type="html"></summary>
    <author>
      <name>Frédéric Delacourt</name>
    </author>
  </entry>
  <entry>
    <title>Il était une fois une base confinée - PostgreSQL, QR Codes et l&#39;art de la sauvegarde sans réseau</title>
    <updated>2025-04-01T00:00:00Z</updated>
    <id>tag:www.data-bene.io,2025-04-01:/fr/blog/sauvegarde-sans-reseau/</id>
    <content type="html"> &lt;h2 id=&#34;📦-le-fort-knox-des-bases-de-donnees&#34;&gt;&lt;a class=&#34;heading-anchor&#34; href=&#34;#📦-le-fort-knox-des-bases-de-donnees&#34;&gt;📦 Le Fort Knox des bases de données&lt;/a&gt;&lt;/h2&gt;&#xA;&lt;p&gt;Il était une fois, dans une salle serveur lointaine, entourée de verre blindé et de béton armé, une base PostgreSQL tellement confinée, tellement isolée, qu’elle ne pouvait que rêver du cloud.&lt;/p&gt;&#xA;&lt;p&gt;Pas de réseau.&lt;/p&gt;&#xA;&lt;p&gt;Pas d’USB.&lt;/p&gt;&#xA;&lt;p&gt;Aucun stockage externe accessible en écriture.&lt;/p&gt;&#xA;&lt;p&gt;Juste un clavier, un écran, et le bourdonnement des filtres à air de qualité industrielle.&lt;/p&gt;&#xA;&lt;p&gt;Ce n’était pas un simple environnement “air-gapped”. C’était une zone d’exfiltration zéro, avec une sécurité opérationnelle si rigoureuse qu’on aurait cru qu’elle protégeait des secrets d’État — ou pire, un système bancaire des années 80.&lt;/p&gt;&#xA;&lt;p&gt;Et pourtant, dans cet oubli numérique, une question demeurait :&lt;br&gt;&#xA;&lt;strong&gt;Comment sauvegarder une base PostgreSQL sans jamais extraire un seul fichier ?&lt;/strong&gt;&lt;/p&gt;&#xA;&lt;hr&gt;&#xA;&lt;h2 id=&#34;🎥-quand-lecran-devient-ton-reseau&#34;&gt;&lt;a class=&#34;heading-anchor&#34; href=&#34;#🎥-quand-lecran-devient-ton-reseau&#34;&gt;🎥 Quand l’écran devient ton réseau&lt;/a&gt;&lt;/h2&gt;&#xA;&lt;p&gt;Notre client ne voulait pas juste une sauvegarde. Il &lt;em&gt;en avait besoin&lt;/em&gt;. La crainte n’était pas le vol, mais &lt;strong&gt;la perte totale&lt;/strong&gt; : une carte mère qui meurt en silence, enfermant les données à jamais dans sa cage de verre. Et dans ce cas, casser le mur à la masse n’est pas un plan de reprise d’activité très élégant.&lt;/p&gt;&#xA;&lt;p&gt;Nous avons envisagé toutes les options :&lt;/p&gt;&#xA;&lt;ul class=&#34;list&#34;&gt;&#xA;&lt;li&gt;OCR d’un défilement de dump SQL ? Trop imprécis.&lt;/li&gt;&#xA;&lt;li&gt;Filmer la sortie &lt;code&gt;psql&lt;/code&gt; ? Beaucoup trop verbeux.&lt;/li&gt;&#xA;&lt;li&gt;Imprimer l’hexadécimal ? On a quand même une conscience.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;Et puis, l’illumination : &lt;strong&gt;les QR codes&lt;/strong&gt;.&lt;/p&gt;&#xA;&lt;p&gt;Et si on faisait un &lt;code&gt;pg_dump&lt;/code&gt; de la base…&lt;/p&gt;&#xA;&lt;p&gt;…en QR codes…&lt;/p&gt;&#xA;&lt;p&gt;…affichés à l’écran…&lt;/p&gt;&#xA;&lt;p&gt;…filmés par une caméra haute fréquence…&lt;/p&gt;&#xA;&lt;p&gt;…puis reconstitués image par image à l’extérieur ?&lt;/p&gt;&#xA;&lt;p&gt;C’était absurde. Donc forcément prometteur.&lt;/p&gt;&#xA;&lt;hr&gt;&#xA;&lt;h2 id=&#34;🧠-hacking-pg_dump-la-version-pixelisee&#34;&gt;&lt;a class=&#34;heading-anchor&#34; href=&#34;#🧠-hacking-pg_dump-la-version-pixelisee&#34;&gt;🧠 Hacking &lt;code&gt;pg_dump&lt;/code&gt; : la version pixelisée&lt;/a&gt;&lt;/h2&gt;&#xA;&lt;p&gt;L’outil adoré &lt;code&gt;pg_dump&lt;/code&gt; de PostgreSQL est modulaire. On l’a donc enrichi d’un nouvel “archiver” : &lt;code&gt;--format=qrcode&lt;/code&gt;.&lt;/p&gt;&#xA;&lt;p&gt;Voici le fonctionnement :&lt;/p&gt;&#xA;&lt;ol class=&#34;list&#34;&gt;&#xA;&lt;li&gt;&lt;strong&gt;Encodage QR&lt;/strong&gt; : chaque portion de sortie SQL est convertie en QR code (format PNG).&lt;/li&gt;&#xA;&lt;li&gt;&lt;strong&gt;Streaming&lt;/strong&gt; : au lieu de sauvegarder les images, on les envoie directement sur &lt;code&gt;stdout&lt;/code&gt;.&lt;/li&gt;&#xA;&lt;li&gt;&lt;strong&gt;Mise en page&lt;/strong&gt; : notre interface affiche plusieurs QR codes à l’écran en haute résolution (on parle de 2000+ pixels — de quoi afficher une grille bien dense).&lt;/li&gt;&#xA;&lt;li&gt;&lt;strong&gt;Capture vidéo&lt;/strong&gt; : une machine dédiée avec une caméra 1280Hz filme l’écran et enregistre la séquence complète.&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&lt;p&gt;Pas de macros. Pas de tricherie. Juste des photons et des images.&lt;/p&gt;&#xA;&lt;hr&gt;&#xA;&lt;h2 id=&#34;🔍-reconstruction-a-la-sortie-de-la-cage&#34;&gt;&lt;a class=&#34;heading-anchor&#34; href=&#34;#🔍-reconstruction-a-la-sortie-de-la-cage&#34;&gt;🔍 Reconstruction à la sortie de la cage&lt;/a&gt;&lt;/h2&gt;&#xA;&lt;p&gt;Une fois la vidéo extraite du cube de verre :&lt;/p&gt;&#xA;&lt;ul class=&#34;list&#34;&gt;&#xA;&lt;li&gt;Notre parseur lit la vidéo image par image.&lt;/li&gt;&#xA;&lt;li&gt;Les QR codes sont détectés et décodés en parallèle.&lt;/li&gt;&#xA;&lt;li&gt;Chaque bloc est identifié par son numéro de séquence.&lt;/li&gt;&#xA;&lt;li&gt;Le tout est réassemblé en un fichier &lt;code&gt;pg_dump.sql&lt;/code&gt; complet.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;Et voilà : la base renaît — &lt;strong&gt;entièrement exportée sans transfert numérique&lt;/strong&gt;.&lt;br&gt;&#xA;Rien que de la lumière et des lentilles.&lt;/p&gt;&#xA;&lt;hr&gt;&#xA;&lt;h2 id=&#34;🧩-performances-et-fidelite&#34;&gt;&lt;a class=&#34;heading-anchor&#34; href=&#34;#🧩-performances-et-fidelite&#34;&gt;🧩 Performances et fidélité&lt;/a&gt;&lt;/h2&gt;&#xA;&lt;ul class=&#34;list&#34;&gt;&#xA;&lt;li&gt;&lt;strong&gt;QR Version&lt;/strong&gt; : Version 40, mode binaire optimisé pour la densité maximale.&lt;/li&gt;&#xA;&lt;li&gt;&lt;strong&gt;Correction d’erreur&lt;/strong&gt; : Niveau Q pour une robustesse accrue.&lt;/li&gt;&#xA;&lt;li&gt;&lt;strong&gt;Affichage&lt;/strong&gt; : Grille 25×16 QR codes sur un écran 1920×1080 — soit 350 blocs par image (environ 1 Mo par frame).&lt;/li&gt;&#xA;&lt;li&gt;&lt;strong&gt;Vitesse de lecture&lt;/strong&gt; : ~60 images/seconde → 21 000 blocs/seconde ≈ 60 Mo/s !&lt;/li&gt;&#xA;&lt;li&gt;&lt;strong&gt;Durée totale&lt;/strong&gt; : Une sauvegarde logique complète de moins de 6 Go exportée en moins de 100 minutes !&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;hr&gt;&#xA;&lt;h2 id=&#34;🛡️-pourquoi-cest-important&#34;&gt;&lt;a class=&#34;heading-anchor&#34; href=&#34;#🛡️-pourquoi-cest-important&#34;&gt;🛡️ Pourquoi c’est important&lt;/a&gt;&lt;/h2&gt;&#xA;&lt;p&gt;Ce n’est pas juste une anecdote technique — c’est une preuve que &lt;strong&gt;la souplesse de PostgreSQL s’étend jusqu’à l’absurde&lt;/strong&gt;. Les environnements ultra-sécurisés ne sont pas rares : défense, finance, infrastructures critiques… Et quand les outils classiques ne suffisent plus, l’architecture extensible de PostgreSQL permet d’innover, même en milieu extrême.&lt;/p&gt;&#xA;&lt;p&gt;Chez &lt;strong&gt;Data Bene&lt;/strong&gt;, on vit pour ce genre de défi. Optimiser les plans d’exécution ou imaginer des méthodes d’exfiltration qui ressemblent à de l’espionnage, c’est notre terrain de jeu.&lt;/p&gt;&#xA;&lt;hr&gt;&#xA;&lt;p&gt;&lt;em&gt;Envie d’essayer ? Écrivez-nous — on adore les sauvegardes bizarres.&lt;/em&gt;&lt;/p&gt;&#xA;&lt;p&gt;&lt;em&gt;Et si jamais vous pensez à utiliser &lt;code&gt;pg_restore&lt;/code&gt; en spectacle laser, appelez-nous. On est curieux.&lt;/em&gt;&lt;/p&gt;&#xA; </content>
    <link href="https://www.data-bene.io/fr/blog/sauvegarde-sans-reseau/" rel="alternate"></link>
    <summary type="html"></summary>
    <author>
      <name>Frédéric Delacourt</name>
    </author>
  </entry>
  <entry>
    <title>PostgreSQL Hebdo #123</title>
    <updated>2025-11-04T15:04:00Z</updated>
    <id>tag:sebastien.lardiere.net,2025-11-04:/blog/index.php/post/2025/11/04/PostgreSQL-Hebdo-123</id>
    <link href="https://sebastien.lardiere.net/blog/index.php/post/2025/11/04/PostgreSQL-Hebdo-123" rel="alternate"></link>
    <summary type="html">&lt;p&gt;Lu ces dernières semaines :&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://explain.technical.li/postgres-indexes-beyond-b-tree/&#34;&gt;Postgres Indexes Beyond B-Tree—GIN, GiST, BRIN, SP-GiST&lt;/a&gt; : les différents types d&#39;index et leurs utilisations ;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://vondra.me/posts/how-often-is-the-query-plan-optimal/&#34;&gt;How often is the query plan optimal?&lt;/a&gt; : à propos de la méthode utilisée pour obtenir le meilleur plan d&#39;exécution ;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.glukhov.org/post/2025/09/postgresql-cheatsheet/&#34;&gt;PostgreSQL Cheatsheet: A Developer’s Quick Reference&lt;/a&gt; : liste consistante de ce qu&#39;on peut faire avec PostgreSQL : commande, paramètre, l&#39;essentiel y est ;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://vondra.me/posts/tuning-aio-in-postgresql-18/&#34;&gt;Tuning AIO in PostgreSQL 18&lt;/a&gt; : comme souvent avec PostgreSQL, les valeurs par défaut sont conservatrices !&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.depesz.com/2025/10/29/waiting-for-postgresql-19-add-psql-prompt-variable-for-search_path/&#34;&gt;Waiting for PostgreSQL 19 – Add psql PROMPT variable for search_path&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://pgfeaturediff.com/?from=17&amp;amp;to=18&#34; title=&#34;https://pgfeaturediff.com/?from=17&amp;amp;to=18&#34;&gt;https://pgfeaturediff.com/?from=17&amp;...&lt;/a&gt; : matrices des fonctionnalités de PostgreSQL&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://pgversions.com/?version=15.3&#34; title=&#34;https://pgversions.com/?version=15.3&#34;&gt;https://pgversions.com/?version=15....&lt;/a&gt; : état des lieux des versions de PostgreSQL&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://boringsql.com/posts/beyond-start-end-columns/&#34;&gt;Beyond Start and End: PostgreSQL Range Types&lt;/a&gt; : les types de données &#34;range&#34; sont vraiment mal connues et pas assez utilisé, cet article est très complet à ce sujet !&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.enterprisedb.com/blog/changes-not-null-postgres-18&#34;&gt;Changes to NOT NULL in Postgres 18&lt;/a&gt; : à la fois une belle fonctionnalité et une aventure pour de nouveaux développeurs de PostgreSQL ;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://topicpartition.io/blog/postgres-pubsub-queue-benchmarks&#34;&gt;Kafka is fast -- I&#39;ll use Postgres&lt;/a&gt; : bien utilisé, PostgreSQL est largement suffisant, et l&#39;asynchronisme d&#39;une file de message résoud bien des problèmes.&lt;/li&gt;&#xA;&lt;/ul&gt;</summary>
    <author>
      <name>Sébastien Lardière</name>
    </author>
  </entry>
  <entry>
    <title>PostgreSQL Hebdo #122</title>
    <updated>2025-09-17T14:41:00Z</updated>
    <id>tag:sebastien.lardiere.net,2025-09-17:/blog/index.php/post/2025/09/19/PostgreSQL-Hebdo-122</id>
    <link href="https://sebastien.lardiere.net/blog/index.php/post/2025/09/19/PostgreSQL-Hebdo-122" rel="alternate"></link>
    <summary type="html">&lt;p&gt;Lu ces dernières semaines :&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.cybertec-postgresql.com/en/select-for-update-considered-harmful-postgresql/&#34;&gt;SELECT FOR UPDATE considered harmful in PostgreSQL&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://dev.to/shayy/postgres-is-too-good-and-why-thats-actually-a-problem-4imc&#34;&gt;Postgres is Too Good (And Why That&#39;s Actually a Problem)&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://kmoppel.github.io/2025-08-06-no-you-dont-need-extensions-to-compact-postgres-tables/&#34;&gt;No, you don&#39;t necessarily need extensions to compact Postgres tables&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://raymondtukpe.com/sql-nulls-are-weird.html&#34;&gt;SQL NULLs are Weird! &lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.thatguyfromdelhi.com/2025/05/for-key-share-optimization-and-slru-trap.html&#34;&gt;FOR KEY SHARE optimization and the SLRU Trap&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://thebuild.com/blog/2025/08/10/lies-damn-lies-and-llm-output/&#34;&gt;Lies, Damn Lies, and LLM Output&lt;/a&gt; : l&#39;IA nous ment, et ceux qui s&#39;en servent nous manipulent ! fuyez ! (attention : d&#39;autres articles que celui mentionné existent !)&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://sebastien.lardiere.net/blog/index.php/post/2025/09/19/&#34;&gt;Partitioned table statistics&lt;/a&gt; : une bonne raison de lancer un ANALYZE hors Auto-vacuum.&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.footcow.com/app/article/postgresql-18-beta-les-revolutions-qui-nous-attendent&#34;&gt;PostgreSQL 18 Beta: The revolutions that await us&lt;/a&gt; : PostgreSQL 18 arrive très bientôt !&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.pgmustard.com/blog/enable-parameters-work-differently-in-postgres-18&#34;&gt;&#34;enable&#34; parameters will work differently in Postgres 18&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.loxodata.com/post/postgresql-18-rc1/&#34;&gt;PostgreSQL 18 en RC1&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&lt;p&gt;PostgreSQL 18 est attendu le 25 septembre !&lt;/p&gt;</summary>
    <author>
      <name>Sébastien Lardière</name>
    </author>
  </entry>
  <entry>
    <title>PostgreSQL Hebdo #121</title>
    <updated>2025-05-13T14:47:00Z</updated>
    <id>tag:sebastien.lardiere.net,2025-05-13:/blog/index.php/post/2025/04/13/PostgreSQL-Hebdo-121</id>
    <link href="https://sebastien.lardiere.net/blog/index.php/post/2025/04/13/PostgreSQL-Hebdo-121" rel="alternate"></link>
    <summary type="html">&lt;p&gt;Lu ces dernières semaines :&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://kmoppel.github.io/2025-04-10-postgres-scaling-roadmap/&#34;&gt;A roadmap to scaling Postgres&lt;/a&gt; : Une liste complète de concepts à utiliser pour assurer une montée en charge de PostgreSQL ;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://r.ena.to/blog/optimizing-postgres-table-layout-for-maximum-efficiency/&#34;&gt;Optimizing Postgres table layout for maximum efficiency&lt;/a&gt; : Une explication simple et claire à propos de l&#39;alignement des types de données ;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://tselai.com/all-databases-are-just-files&#34;&gt;(All) Databases Are Just Files. Postgres Too&lt;/a&gt; ;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://cedardb.com/blog/postgres_compatibility/&#34;&gt;What It Takes to Be PostgreSQL Compatible&lt;/a&gt; : de nombreaux produits adoptent une compatibilité avec PostgreSQL ;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://blog.danslimmon.com/2025/03/14/did-u-ever-read-so-hard-u-accidentally-wrote/&#34;&gt;did u ever read so hard u accidentally wrote?&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.postgresql.org/about/news/postgresql-175-169-1513-1418-and-1321-released-3072/&#34;&gt;PostgreSQL 17.5, 16.9, 15.13, 14.18, and 13.21 Released!&lt;/a&gt; et en français &lt;a href=&#34;https://www.loxodata.com/post/postgresql-17-5/&#34;&gt;PostgreSQL 17.5 et autres correctifs&lt;/a&gt;  : à noter la fin de vie de PostgreSQL 13 en novembre ;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&lt;p&gt;À venir dans PostgreSQL 18 :&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.depesz.com/2025/05/05/waiting-for-postgresql-18-add-function-to-get-memory-context-stats-for-processes/&#34;&gt;Add function to get memory context stats for processes&lt;/a&gt; : interessant de pouvoir suivre l&#39;état d&#39;un processus, cela dévoile beaucoup d&#39;informations utile ;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.postgresql.org/about/news/postgresql-18-beta-1-released-3070/&#34;&gt;PostgreSQL 18 Beta 1 Released!&lt;/a&gt; et en français &lt;a href=&#34;https://www.loxodata.com/post/postgresql-18-beta1/&#34;&gt;PostgreSQL 18 bêta 1&lt;/a&gt; : à vos tests !&lt;/li&gt;&#xA;&lt;/ul&gt;</summary>
    <author>
      <name>Sébastien Lardière</name>
    </author>
  </entry>
  <entry>
    <title>PostgreSQL Hebdo #120</title>
    <updated>2025-02-21T15:20:00Z</updated>
    <id>tag:sebastien.lardiere.net,2025-02-21:/blog/index.php/post/2025/02/21/PostgreSQL-Hebdo-120</id>
    <link href="https://sebastien.lardiere.net/blog/index.php/post/2025/02/21/PostgreSQL-Hebdo-120" rel="alternate"></link>
    <summary type="html">&lt;p&gt;Lu ces dernières semaines :&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://blog.octo.com/7-things-a-developer-should-know-about-databases&#34;&gt;7 things a developer should know about databases&lt;/a&gt; : de précieux conseils, à lire attentivement et à faire circuler auprès de vos équipes !&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://blog.dalibo.com//2025/02/10/patchs_parallelisations_2.html&#34;&gt;La suite des patchs sur la parallélisation &lt;/a&gt; : Au-delà du fond, qui est intéressant, c’est le point de vue sur le développement de PostgreSQL est mis en évidence, et cela permet de mieux comprendre cet aspect de la communauté PostgreSQL ;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.loxodata.com/post/pgwatch3/&#34;&gt;pgwatch3&lt;/a&gt; : quelques explications sur la nouvelle version de l&#39;outil de supervision pgwatch ;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.twilio.com/en-us/blog/sqlite-postgresql-complicated&#34;&gt;SQLite or PostgreSQL? It&#39;s Complicated!&lt;/a&gt; : comparatif de performances sur de vraies données !&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.postgresql.org/about/news/postgresql-174-168-1512-1417-and-1320-released-3018/&#34;&gt;PostgreSQL 17.4, 16.8, 15.12, 14.17, and 13.20 Released!&lt;/a&gt; et &lt;a href=&#34;https://www.postgresql.org/about/news/postgresql-173-167-1511-1416-and-1319-released-3015/&#34;&gt;PostgreSQL 17.3, 16.7, 15.11, 14.16, and 13.19 Released!&lt;/a&gt; : mettez à jour !&#xA;&lt;ul&gt;&#xA;&lt;li&gt;en français : &lt;a href=&#34;https://www.loxodata.com/post/postgresql-17-4/&#34;&gt;PostgreSQL 17.4 et autres correctifs&lt;/a&gt; et  &lt;a href=&#34;https://www.loxodata.com/post/postgresql-17-3/&#34;&gt;PostgreSQL 17.3 et autres correctifs&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.cybertec-postgresql.com/en/end-of-the-road-for-postgresql-streaming-replication/&#34;&gt;End of the road for PostgreSQL streaming replication?&lt;/a&gt; : pourquoi il est difficile de paralléliser le rejeu de la réplication dans une instance Standby ;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.crunchydata.com/blog/enhanced-postgres-release-notes&#34;&gt;Enhanced Postgres Release Notes&lt;/a&gt; : très bonne idée, et gros travail : on trouve maintenant un lien vers le commit pour chacune des entrées des notes de publication ;&lt;/li&gt;&#xA;&lt;/ul&gt;</summary>
    <author>
      <name>Sébastien Lardière</name>
    </author>
  </entry>
  <entry>
    <title>PostgreSQL Hebdo #119</title>
    <updated>2025-01-31T16:16:00Z</updated>
    <id>tag:sebastien.lardiere.net,2025-01-31:/blog/index.php/post/2025/01/31/PostgreSQL-Hebdo-119</id>
    <link href="https://sebastien.lardiere.net/blog/index.php/post/2025/01/31/PostgreSQL-Hebdo-119" rel="alternate"></link>
    <summary type="html">&lt;p&gt;Lu ces dernières semaines :&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.depesz.com/2024/12/01/sql-best-practices-dont-compare-count-with-0/&#34;&gt;SQL best practices – don’t compare count(*) with 0&lt;/a&gt; : il n&#39;est pas utile de compter quelque chose alors qu&#39;on juste savoir s&#39;il existe ;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://raymondtukpe.com/sql-nulls-are-weird.html&#34;&gt;SQL NULLs are Weird!&lt;/a&gt; : maîtriser cet aspect du SQL n&#39;est pas si évident, et pourtant fondamental ;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://notso.boringsql.com/posts/deletes-are-difficult/&#34;&gt;DELETEs are difficult&lt;/a&gt;: tout savoir sur l&#39;opération DELETE ;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.pgedge.com/blog/understanding-and-reducing-postgresql-replication-lag&#34;&gt;Understanding and Reducing PostgreSQL Replication Lag&lt;/a&gt; : le retard de réplication peut avoir de nombreux impacts, le mesurer et le maitriser est important ;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://thebuild.com/blog/2025/01/28/vacuum-index_cleanup-off-considered-harmful/&#34;&gt;VACUUM (INDEX_CLEANUP OFF) Considered Harmful&lt;/a&gt; : attention aux options de commandes qui pourraient paraître intéressantes au premier abord ;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.binwang.me/2024-12-02-PostgreSQL-High-Availability-Solutions-Part-1.html&#34;&gt;Jepsen Test on Patroni: A PostgreSQL High Availability Solution&lt;/a&gt; : test très complet de Patroni ;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://rodoq.medium.com/are-all-your-update-useful-6b8d548085bf&#34;&gt;Are all your UPDATE useful ?&lt;/a&gt; : Vos UPDATE sont-ils toujours utiles ?&lt;/li&gt;&#xA;&lt;li&gt;Le projet PostgreSQL Ecosystem est maintenant public : &lt;a href=&#34;https://www.loxodata.com/post/pg-ecosystem/&#34; title=&#34;https://www.loxodata.com/post/pg-ecosystem/&#34;&gt;https://www.loxodata.com/post/pg-ec...&lt;/a&gt; et &lt;a href=&#34;https://pg-ecosystem.gitlab.io/pg-ecosystem/&#34; title=&#34;https://pg-ecosystem.gitlab.io/pg-ecosystem/&#34;&gt;https://pg-ecosystem.gitlab.io/pg-e...&lt;/a&gt; ;&lt;/li&gt;&#xA;&lt;/ul&gt;</summary>
    <author>
      <name>Sébastien Lardière</name>
    </author>
  </entry>
  <entry>
    <title>PostgreSQL Hebdo #118</title>
    <updated>2024-11-22T16:09:00Z</updated>
    <id>tag:sebastien.lardiere.net,2024-11-22:/blog/index.php/post/2024/11/22/PostgreSQL-Hebdo-118</id>
    <link href="https://sebastien.lardiere.net/blog/index.php/post/2024/11/22/PostgreSQL-Hebdo-118" rel="alternate"></link>
    <summary type="html">&lt;p&gt;Lu ces dernières semaines :&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://pgversions.com/&#34; title=&#34;https://pgversions.com/&#34;&gt;https://pgversions.com/&lt;/a&gt; : outil permettant de connaitre les différences entre une version mineure et l&#39;état actuel de PostgreSQL ;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://pgpedia.info/blog/index.html&#34; title=&#34;https://pgpedia.info/blog/index.html&#34;&gt;https://pgpedia.info/blog/index.htm...&lt;/a&gt; : blog résumant l&#39;activité de développement de PostgreSQL ;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://rhaas.blogspot.com/2024/11/why-pgdump-is-amazing.html&#34;&gt;Why pg_dump Is Amazing&lt;/a&gt; : oui, pg_dump est un bon outil, très utile, qu&#39;il faut maitriser ;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://databaserookies.wordpress.com/2024/11/02/plpgsql-how-conditional-expressions-are-evaluated/&#34;&gt;PL/pgSQL Secrets: How Conditional Expressions Are Parsed and Evaluated Under the Hood.&lt;/a&gt; : ou on comprend qu&#39;un IF est en fait un SELECT ;&lt;/li&gt;&#xA;&lt;li&gt;Publication de PostgreSQL 17.2 : &lt;a href=&#34;https://www.loxodata.com/post/postgresql-17-2/&#34; title=&#34;https://www.loxodata.com/post/postgresql-17-2/&#34;&gt;https://www.loxodata.com/post/postg...&lt;/a&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.crunchydata.com/blog/a-change-to-relresultinfo-a-near-miss-with-postgres-17-1&#34;&gt;A change to ResultRelInfo - A Near Miss with Postgres 17.1&lt;/a&gt; : retour sur un petit couac&lt;/li&gt;&#xA;&lt;/ul&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://challahscript.com/what_i_wish_someone_told_me_about_postgres&#34;&gt;What I Wish Someone Told Me About Postgres&lt;/a&gt; : le plein de bonnes idées à retenir ;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://stormatics.tech/blogs/scenarios-that-trigger-autovacuum-in-postgresql&#34;&gt;Scenarios That Trigger Autovacuum in PostgreSQL&lt;/a&gt; : article assez complet sur le fonctionnement d&#39;autovacuum.&lt;/li&gt;&#xA;&lt;/ul&gt;</summary>
    <author>
      <name>Sébastien Lardière</name>
    </author>
  </entry>
  <entry>
    <title>Patroni aux commandes</title>
    <updated>2025-11-04T06:00:00Z</updated>
    <id>tag:blog.dalibo.com,2025-11-04://2025/11/04/pglift-patroni-aux-commandes.html</id>
    <link href="https://blog.dalibo.com//2025/11/04/pglift-patroni-aux-commandes.html" rel="alternate"></link>
    <summary type="html">&lt;p&gt;&lt;em&gt;Vallée de Munster, 04 novembre 2025&lt;/em&gt;&lt;/p&gt;&#xA;&#xA;&lt;p&gt;La haute disponibilité dans nos métiers de l’IT est un vaste sujet.&#xA;PostgreSQL étant au cœur de nombreux Systèmes d’Information, il est&#xA;souvent source de nombreuses questions pour construire des architectures&#xA;robustes, redondantes et hautement disponibles.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Cet article propose une brève présentation de Patroni : son rôle, les&#xA;composants essentiels pour l’utiliser, ainsi que quelques bonnes&#xA;pratiques. Nous aborderons également l’usage de notre socle technique&#xA;d’industrialisation pour exploiter Patroni.&lt;/p&gt;&#xA;&#xA;&lt;!--MORE--&gt;&#xA;&#xA;&lt;h2 id=&#34;patroni-de-quoi-parlons-nous-&#34;&gt;Patroni, de quoi parlons-nous ?&lt;/h2&gt;&#xA;&#xA;&lt;p&gt;Patroni est une solution de « template » pour gérer une ou des grappes&#xA;(&lt;strong&gt;Clusters&lt;/strong&gt;) d’instances PostgreSQL. En fonction de la configuration&#xA;retenue, Patroni permet d’assurer la haute disponibilité d’un service&#xA;PostgreSQL, de maintenir l’agrégat en condition opérationnelle, de le&#xA;superviser et provoquer une bascule automatique en cas d’incident.&lt;/p&gt;&#xA;&#xA;&lt;h3 id=&#34;composants&#34;&gt;Composants&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;Nous retrouvons dans le schéma suivant l’ensemble des composants minimum&#xA;requis pour mettre en place une grappe de serveurs PostgreSQL avec&#xA;Patroni.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;&lt;img src=&#34;/img/patroni_archi.png&#34; alt=&#34;architecture Patroni&#34; /&gt;&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;  &lt;li&gt;Patroni est un service écrit en Python qui va piloter le cycle de vie&#xA;des instances PostgreSQL en se basant sur un système distribué (cf.&#xA;DCS ci-dessous)&lt;/li&gt;&#xA;  &lt;li&gt;un &lt;strong&gt;DCS&lt;/strong&gt; (Distributed Consensus Store ou parfois appelé Distributed&#xA;Configuration Store), ce composant permet de partager l’état des&#xA;nœuds, leur configuration au sein du &lt;strong&gt;cluster&lt;/strong&gt; et de garantir&#xA;l’unicité du rôle &lt;strong&gt;leader&lt;/strong&gt;. C’est la source de vérité principale&#xA;d’un cluster Patroni. La littérature et nos observations montrent&#xA;qu’&lt;a href=&#34;https://etcd.io/&#34;&gt;etcd&lt;/a&gt; est souvent adopté pour assurer ce rôle.&lt;/li&gt;&#xA;  &lt;li&gt;PostgreSQL ! Dans l’architecture que nous présentons, PostgreSQL&#xA;(notre SGBD de cœur ❤️ ) est piloté par Patroni. Ce dernier utilise&#xA;des fonctionnalités natives de PostgreSQL (Exemple : la réplication&#xA;physique de PostgreSQL).&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;p&gt;En complément de ces composants, on peut retrouver, entre autres, les&#xA;éléments optionnels suivants :&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;  &lt;li&gt;Une solution de sauvegarde au fil de l’eau de type &lt;strong&gt;PITR&lt;/strong&gt; (par&#xA;exemple &lt;a href=&#34;https://pgbackrest.org/&#34;&gt;pgBackrest&lt;/a&gt;,&#xA;&lt;a href=&#34;https://pgbarman.org/&#34;&gt;Barman&lt;/a&gt;,…)&lt;/li&gt;&#xA;  &lt;li&gt;Un aiguilleur de connexions (par exemple&#xA;&lt;a href=&#34;https://www.haproxy.org/&#34;&gt;HAProxy&lt;/a&gt;)&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;h2 id=&#34;configuration-de-notre-sgbd-favori---statique-vs-dynamique&#34;&gt;Configuration de notre SGBD favori - statique vs dynamique&lt;/h2&gt;&#xA;&#xA;&lt;p&gt;Dans l’architecture que nous présentons, Patroni se charge de gérer le&#xA;cycle de vie des instances PostgreSQL. Il va initier et configurer les&#xA;instances PostgreSQL sur la base de sa configuration et de l’état du&#xA;&lt;strong&gt;cluster&lt;/strong&gt;. Les utilisateur·ices ont plusieurs choix possibles pour&#xA;configurer PostgreSQL :&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;  &lt;li&gt;&#xA;    &lt;p&gt;En utilisant une configuration dite statique de Patroni (qui&#xA;s’applique à un seul nœud) :&lt;/p&gt;&#xA;&#xA;    &lt;ul&gt;&#xA;      &lt;li&gt;Via le fichier de configuration (YAML) de Patroni, en éditant la&#xA;&lt;a href=&#34;https://patroni.readthedocs.io/en/latest/yaml_configuration.html#postgresql&#34;&gt;section&#xA;postgresql&lt;/a&gt;&#xA;dudit fichier&lt;/li&gt;&#xA;      &lt;li&gt;En définissant des variables d’environnement au démarrage de Patroni&#xA;(entre autres les variables&#xA;&lt;a href=&#34;https://patroni.readthedocs.io/en/latest/ENVIRONMENT.html#postgresql&#34;&gt;&lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;PATRONI_POSTGRESQL_*&lt;/code&gt;&lt;/a&gt;&#xA;pour altérer la configuration de PostgreSQL)&lt;/li&gt;&#xA;    &lt;/ul&gt;&#xA;  &lt;/li&gt;&#xA;  &lt;li&gt;&#xA;    &lt;p&gt;En utilisant la configuration dite dynamique de Patroni. Cette&#xA;configuration s’applique à l’ensemble des instances de notre&#xA;&lt;strong&gt;Cluster&lt;/strong&gt; et est stockée dans le &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;DCS&lt;/code&gt;. Elle est modifiable via la&#xA;commande &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;patronictl edit-config&lt;/code&gt; et consultable avec&#xA;&lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;patronictl show-config&lt;/code&gt;.&lt;/p&gt;&#xA;&#xA;    &lt;p&gt;La configuration suivante, s’applique à l’ensemble des instances&#xA;PostgreSQL de notre grappe :&lt;/p&gt;&#xA;&#xA;    &lt;div class=&#34;language-console highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;gp&#34;&gt;$&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;patronictl show-config&#xA;&lt;span class=&#34;go&#34;&gt;loop_wait: 10&#xA;postgresql:&#xA;  parameters:&#xA;    max_connections: 50&#xA;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;&#xA;&#xA;    &lt;p&gt;et est appliquée par Patroni à l’ensemble des instances PostgreSQL :&lt;/p&gt;&#xA;&#xA;    &lt;div class=&#34;language-console highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;gp&#34;&gt;$&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;psql&#xA;&lt;span class=&#34;go&#34;&gt;psql (17.2 (Debian 17.2-1.pgdg120+1))&#xA;Type &#34;help&#34; for help.&#xA;&#xA;&lt;/span&gt;&lt;span class=&#34;gp&#34;&gt;[17/pg1] postgres@~=#&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;show max_connections&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&#xA;&lt;span class=&#34;go&#34;&gt; max_connections&#xA;-----------------&#xA; 50&#xA;(1 row)&#xA;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;&#xA;  &lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;h3 id=&#34;pièges-classiques&#34;&gt;Pièges classiques&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;&lt;strong&gt;Attention, &lt;a href=&#34;https://patroni.readthedocs.io/en/latest/patroni_configuration.html#postgresql-parameters-controlled-by-patroni&#34;&gt;Certaines options sont exclusivement paramétrables&#xA;dynamiquement (au niveau&#xA;DCS)&lt;/a&gt;,&#xA;c’est le cas, entre autre, de l’option &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;max_connections&lt;/code&gt;. Pour les&#xA;autres paramètres, lorsqu’on utilise les deux méthodes de configuration&#xA;(fichier et DCS), la majorité des options statiques prévalent.&lt;/strong&gt;&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Par exemple, si l’utilisateur⋅ice attribue 8 Go pour le paramètre&#xA;&lt;a href=&#34;https://www.postgresql.org/docs/17/runtime-config-resource.html#GUC-SHARED-BUFFERS&#34;&gt;&lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;shared_buffers&lt;/code&gt;&lt;/a&gt;&#xA;dans le fichier de configuration de Patroni et utilise une autre valeur&#xA;dans la configuration dynamique (&lt;strong&gt;DCS&lt;/strong&gt;), seule la configuration&#xA;statique (définie dans le fichier) sera prise en compte et appliquée&#xA;&lt;strong&gt;au nœud&lt;/strong&gt; (et non à l’ensemble du Cluster).&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Par exemple, nous montrons ici la modification d’un paramètre dynamique&#xA;et sa non prise en compte par Patroni / PostgreSQL :&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;  &lt;li&gt;&#xA;    &lt;p&gt;On positionne la valeur de l’option &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;shared_buffers&lt;/code&gt; à &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;8 GB&lt;/code&gt; dans le&#xA;fichier de configuration de Patroni :&lt;/p&gt;&#xA;&#xA;    &lt;div class=&#34;language-console highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;gp&#34;&gt;$&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;cat&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;PATRONICTL_CONFIG_FILE&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;}&lt;/span&gt; | yq &lt;span class=&#34;nt&#34;&gt;-r&lt;/span&gt; .postgresql.parameters.shared_buffers&#xA;&lt;span class=&#34;go&#34;&gt;8 GB&#xA;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;&#xA;  &lt;/li&gt;&#xA;  &lt;li&gt;&#xA;    &lt;p&gt;On modifie ensuite la valeur du &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;shared_buffers&lt;/code&gt; dans la configuration&#xA;dynamique :&lt;/p&gt;&#xA;&#xA;    &lt;div class=&#34;language-console highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;gp&#34;&gt;$&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;patronictl edit-config &lt;span class=&#34;nt&#34;&gt;--force&lt;/span&gt; &lt;span class=&#34;nt&#34;&gt;-p&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;shared_buffers&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&#39;4 GB&#39;&lt;/span&gt;&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;&#xA;  &lt;/li&gt;&#xA;  &lt;li&gt;&#xA;    &lt;p&gt;On relance notre ou nos instances PostgreSQL :&lt;/p&gt;&#xA;&#xA;    &lt;div class=&#34;language-console highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;gp&#34;&gt;$&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;patronictl restart pgdemo&#xA;&lt;span class=&#34;go&#34;&gt;When should the restart take place (e.g. 2025-01-23T10:18)  [now]:&#xA;Are you sure you want to restart members pg1? [y/N]: y&#xA;Restart if the PostgreSQL version is less than provided (e.g. 9.5.2)  []: 18.0&#xA;Success: restart on member pg1&#xA;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;&#xA;  &lt;/li&gt;&#xA;  &lt;li&gt;&#xA;    &lt;p&gt;Pour, au final, observer la non prise en compte de la configuration&#xA;dynamique :&lt;/p&gt;&#xA;&#xA;    &lt;div class=&#34;language-console highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;gp&#34;&gt;$&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;psql&#xA;&lt;span class=&#34;go&#34;&gt;psql (17.2 (Debian 17.2-1.pgdg120+1))&#xA;Type &#34;help&#34; for help.&#xA;&#xA;&lt;/span&gt;&lt;span class=&#34;gp&#34;&gt;[17/pg1] postgres@~=#&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;show shared_buffers&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&#xA;&lt;span class=&#34;go&#34;&gt; shared_buffers&#xA;----------------&#xA; 8GB&#xA;(1 row)&#xA;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;&#xA;  &lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;p&gt;Ce comportement bien que décrit dans la documentation, peut être source&#xA;de confusion. Il peut conduire à une forme de disparité non souhaitable&#xA;au sein d’un &lt;strong&gt;Cluster&lt;/strong&gt; d’instances PostgreSQL.&lt;/p&gt;&#xA;&#xA;&lt;h2 id=&#34;et-notre-socle-dans-léquation-&#34;&gt;Et notre Socle dans l’équation ?!&lt;/h2&gt;&#xA;&#xA;&lt;p&gt;Notre solution d’industrialisation, le &lt;a href=&#34;https://www.dalibo.com/socle&#34;&gt;Socle Postgres&#xA;Dalibo&lt;/a&gt;, et son composant central&#xA;&lt;a href=&#34;https://gitlab.com/dalibo/pglift&#34;&gt;pglift&lt;/a&gt;, depuis la &lt;a href=&#34;https://pglift.readthedocs.io/en/latest/news.html#v2-5-0-2025-10-09&#34;&gt;version&#xA;2.5&lt;/a&gt;,&#xA;offrent la possibilité de choisir entre une configuration statique ou&#xA;dynamique.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Par défaut, pglift utilise une configuration locale, mais les&#xA;utilisateur·ices peuvent modifier ce comportement en utilisant la&#xA;configuration suivante :&lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-yaml highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;na&#34;&gt;patroni&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt;&#xA;  &lt;span class=&#34;pi&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;...&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;]&lt;/span&gt;&#xA;  &lt;span class=&#34;na&#34;&gt;configuration_mode&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt;&#xA;    &lt;span class=&#34;na&#34;&gt;auth&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;dynamic&lt;/span&gt;&#xA;    &lt;span class=&#34;na&#34;&gt;parameters&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;dynamic&lt;/span&gt;&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;Ces options permettent de choisir de gérer dynamiquement les entrées HBA&#xA;et la configuration de PostgreSQL. Concrètement :&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;  &lt;li&gt;lors de la création d’un &lt;strong&gt;Cluster&lt;/strong&gt;, celui-ci sera initialisé avec&#xA;les entrées HBA et la configuration PostgreSQL stockées dans le DCS ;&lt;/li&gt;&#xA;  &lt;li&gt;toute modification d’un paramètre (HBA ou configuration) mettra&#xA;automatiquement à jour les informations correspondantes dans le DCS&#xA;(via l’API de Patroni).&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;p&gt;À titre d’exemple, nous créons ici une instance gérée par Patroni via&#xA;pglift :&lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-console highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;gp&#34;&gt;$&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;pglift instance create main1 &lt;span class=&#34;nt&#34;&gt;--port&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;5974 &lt;span class=&#34;nt&#34;&gt;--patroni-cluster&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;pgdemo &lt;span class=&#34;nt&#34;&gt;--patroni-node&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;main1&#xA;&lt;span class=&#34;go&#34;&gt;INFO     initializing PostgreSQL&#xA;INFO     setting up Patroni service&#xA;INFO     bootstrapping PostgreSQL with Patroni&#xA;&lt;/span&gt;&lt;span class=&#34;c&#34;&gt;...&#xA;&lt;/span&gt;&lt;span class=&#34;go&#34;&gt;INFO     configuring PostgreSQL&#xA;INFO     altering role &#39;replrole&#39;&#xA;INFO     creating instance dumps directory: /srv/data/17-main1&#xA;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;Lors de l’initialisation, Patroni est configuré (par pglift) de manière&#xA;à garnir le DCS en utilisant les modèles de configuration fournis par&#xA;pglift :&lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-console highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;gp&#34;&gt;$&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;pglift instance &lt;span class=&#34;nb&#34;&gt;exec &lt;/span&gt;main1 &lt;span class=&#34;nt&#34;&gt;--&lt;/span&gt; patronictl show-config&#xA;&lt;span class=&#34;go&#34;&gt;loop_wait: 10&#xA;postgresql:&#xA;  parameters:&#xA;    effective_cache_size: 22 GB&#xA;    shared_buffers: 8 GB&#xA;&lt;/span&gt;&lt;span class=&#34;c&#34;&gt;    ...&#xA;&lt;/span&gt;&lt;span class=&#34;go&#34;&gt;  pg_hba:&#xA;  - local all postgres trust&#xA;  - local all backup trust&#xA;&lt;/span&gt;&lt;span class=&#34;c&#34;&gt;  ...&#xA;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;Les utilisateur·rices peuvent ensuite modifier la configuration&#xA;dynamique soit via la commande pglift (Exemple :&#xA;&lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;pglift pgconf -i main1 set max_connections=&#39;30&#39;&lt;/code&gt;), soit via Ansible :&lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-yaml highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;nn&#34;&gt;---&lt;/span&gt;&#xA;&lt;span class=&#34;pi&#34;&gt;-&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;Manage primary instance&lt;/span&gt;&#xA;  &lt;span class=&#34;na&#34;&gt;hosts&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;localhost&lt;/span&gt;&#xA;  &lt;span class=&#34;na&#34;&gt;tasks&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt;&#xA;    &lt;span class=&#34;pi&#34;&gt;-&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;Create primary instance pg1&lt;/span&gt;&#xA;      &lt;span class=&#34;na&#34;&gt;dalibo.pglift.instance&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt;&#xA;        &lt;span class=&#34;na&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;main1&lt;/span&gt;&#xA;        &lt;span class=&#34;na&#34;&gt;port&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;m&#34;&gt;5974&lt;/span&gt;&#xA;        &lt;span class=&#34;na&#34;&gt;state&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;started&lt;/span&gt;&#xA;        &lt;span class=&#34;na&#34;&gt;settings&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt;&#xA;          &lt;span class=&#34;na&#34;&gt;max_connections&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;m&#34;&gt;40&lt;/span&gt;&#xA;        &lt;span class=&#34;na&#34;&gt;patroni&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt;&#xA;          &lt;span class=&#34;na&#34;&gt;cluster&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;pgdemo&lt;/span&gt;&#xA;          &lt;span class=&#34;na&#34;&gt;node&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;main1&lt;/span&gt;&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;div class=&#34;language-console highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;gp&#34;&gt;$&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;ansible-playbook /tmp/patroni.yml&#xA;&lt;span class=&#34;c&#34;&gt;...&#xA;&lt;/span&gt;&lt;span class=&#34;go&#34;&gt;TASK [Manage primary instance pg1] *************&#xA;changed: [localhost]&#xA;&lt;/span&gt;&lt;span class=&#34;c&#34;&gt;...&#xA;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;Peu importe l’interface utilisée, pglift va appeler l’API de Patroni&#xA;pour modifier la configuration distribuée :&lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-console highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;gp&#34;&gt;$&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;pglift instance &lt;span class=&#34;nb&#34;&gt;exec &lt;/span&gt;main1 &lt;span class=&#34;nt&#34;&gt;--&lt;/span&gt; patronictl show-config |&lt;span class=&#34;se&#34;&gt;\&lt;/span&gt;&#xA;&lt;span class=&#34;go&#34;&gt;  yq -r .postgresql.parameters.max_connections&#xA;30&#xA;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;pglift, que ce soit via sa ligne de commande ou via Ansible, permet de&#xA;faire abstraction du type d’instance. Ainsi, une instance gérée par&#xA;Patroni, malgré certaines spécificités, peut être configurée de manière&#xA;similaire à une instance plus simple (par exemple, une instance&#xA;&lt;em&gt;standalone&lt;/em&gt;).&lt;/p&gt;&#xA;&#xA;&lt;h2 id=&#34;quelques-pratiques-et-recommandations&#34;&gt;Quelques pratiques et recommandations&lt;/h2&gt;&#xA;&#xA;&lt;p&gt;Patroni offre plusieurs choix pour stocker sa configuration, mais aussi&#xA;les paramètres spécifiques pour PostgreSQL. Les deux techniques ont du&#xA;sens et le choix entre configuration dynamique ou statique va dépendre&#xA;de plusieurs critères.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Voici quelques questions pertinentes pour choisir l’une ou l’autre&#xA;option :&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;  &lt;li&gt;Ma configuration est-elle globale à l’ensemble des instances&#xA;PostgreSQL d’une grappe ?&lt;/li&gt;&#xA;  &lt;li&gt;Dois-je appliquer un ensemble de paramètres à un seul nœud (ou un&#xA;groupe limité de nœuds) ?&lt;/li&gt;&#xA;  &lt;li&gt;Est-il possible et facile de déployer la configuration avec des outils&#xA;d’automatisation (Exemple via un Playbook Ansible) ?&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;p&gt;Lors de l’utilisation de Patroni, nous recommandons de définir et suivre&#xA;une stratégie adaptée et documentée pour configurer Patroni et&#xA;PostgreSQL. Il nous semble intéressant et utile de :&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;  &lt;li&gt;&#xA;    &lt;p&gt;S’appuyer sur des outils de déploiement et d’automatisation pour&#xA;mettre en place et maintenir votre configuration (Ansible, Puppet,&#xA;cfengine,…).&lt;/p&gt;&#xA;&#xA;    &lt;p&gt;Cette approche permet de maintenir en un seul endroit (Exemple : un&#xA;entrepôt Git) l’ensemble de votre configuration. Cela facilite&#xA;grandement la gestion de vos instances (modification, audit,…).&lt;/p&gt;&#xA;  &lt;/li&gt;&#xA;  &lt;li&gt;&#xA;    &lt;p&gt;limiter au strict minimum l’utilisation simultanée d’une configuration&#xA;statique (fichier de configuration) et dynamique (DCS).&lt;/p&gt;&#xA;&#xA;    &lt;p&gt;Notamment, lorsqu’on utilise un DCS comme source de configuration, il&#xA;nous semble idéal d’y consigner les paramètres communs à toutes les&#xA;instances.&lt;/p&gt;&#xA;  &lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;h2 id=&#34;conclusions--ressources&#34;&gt;Conclusions &amp;amp; ressources&lt;/h2&gt;&#xA;&#xA;&lt;p&gt;Patroni est une solution de haute disponibilité largement reconnue et&#xA;utilisée depuis plusieurs années, qui a progressivement intégré de&#xA;nombreuses fonctionnalités pour répondre aux besoins des utilisateurs.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;En raison de la complexité et des enjeux de la haute disponibilité,&#xA;Dalibo a investi significativement dans la R&amp;amp;D autour de Patroni, grâce&#xA;aux contributions de ses DBA et développeur·euse·s ainsi qu’aux retours&#xA;récurrents de ses clients.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Les divers chantiers concernant Patroni, nous ont permis entre autres de&#xA;produire :&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;  &lt;li&gt;&#xA;    &lt;p&gt;Une &lt;a href=&#34;https://www.dalibo.com/formation-postgresql-haute-disponibilite&#34;&gt;formation spécifique dédiée à&#xA;Patroni&lt;/a&gt;&lt;/p&gt;&#xA;  &lt;/li&gt;&#xA;  &lt;li&gt;&#xA;    &lt;p&gt;Une &lt;a href=&#34;https://github.com/dalibo/check_patroni&#34;&gt;sonde pour nagios (et les équivalents&#xA;Nagios)&lt;/a&gt;&lt;/p&gt;&#xA;  &lt;/li&gt;&#xA;  &lt;li&gt;&#xA;    &lt;p&gt;L’implémentation du support de Patroni dans &lt;a href=&#34;https://www.dalibo.com/socle&#34;&gt;notre solution&#xA;d’industrialisation&lt;/a&gt;&lt;/p&gt;&#xA;  &lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;!--&#xA;    vim: spelllang=fr spell&#xA;  --&gt;</summary>
    <author>
      <name>blog.dalibo.com</name>
    </author>
  </entry>
  <entry>
    <title>Sécuriser Postgres avec le mode user de systemd</title>
    <updated>2025-10-20T05:00:00Z</updated>
    <id>tag:blog.dalibo.com,2025-10-20://2025/10/20/securiser-postgres-avec-le-mode-user-de-systemd.html</id>
    <link href="https://blog.dalibo.com//2025/10/20/securiser-postgres-avec-le-mode-user-de-systemd.html" rel="alternate"></link>
    <summary type="html">&lt;p&gt;&lt;em&gt;Eymoutiers, le 20 octobre 2025&lt;/em&gt;&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Nouvel épisode de notre &lt;a href=&#34;https://blog.dalibo.com/2025/06/30/industrialisation_postgresql.html&#34;&gt;série dédiée à l’industrialisation de PostgreSQL&lt;/a&gt; :&#xA;après le &lt;a href=&#34;https://blog.dalibo.com/2025/08/28/installation_pglift.html&#34;&gt;déploiement d’instances Postgres à grande échelle&lt;/a&gt; et la&#xA;&lt;a href=&#34;https://blog.dalibo.com/2025/09/11/industrialiser-les-sauvegardes-de-postgresql.html&#34;&gt;gestion homogène des sauvegardes Postgres avec pglift&lt;/a&gt;, nous allons cette fois&#xA;nous pencher sur la question de la sécurité.&lt;/p&gt;&#xA;&#xA;&lt;!--MORE--&gt;&#xA;&#xA;&lt;h2 id=&#34;les-bases-de-données-sont-les-cibles-ultimes-des-attaques-informatiques&#34;&gt;Les bases de données sont les cibles ultimes des attaques informatiques&lt;/h2&gt;&#xA;&#xA;&lt;p&gt;Les bases de données contiennent les informations les plus précieuses d’une&#xA;organisation : données personnelles, informations financières, secrets&#xA;commerciaux, dossiers médicaux, etc.&#xA;Elles représentent donc le point névralgique et un bastion à protéger au cœur&#xA;de chaque système d’information.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;PostgreSQL propose bien sûr un large panel de mesures internes pour la sécurité :&#xA;un controle des accès très fin avec le fichier &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;pg_hba.conf&lt;/code&gt;, le chiffrement&#xA;TLS des communications, un système de roles/permissions sophitiqué ou encore&#xA;les règles &lt;a href=&#34;https://doc.postgresql.fr/current/ddl-rowsecurity.html&#34;&gt;RLS&lt;/a&gt; pour filtrer les lectures lignes par lignes.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Mais qu’en est-il de l’environnement dans lequel PostgreSQL évolue ?&#xA;En particulier, comment protéger l’instance PostgreSQL depuis l’extérieur ?&lt;/p&gt;&#xA;&#xA;&lt;p&gt;&lt;img src=&#34;/img/2025_pexels-nguyendesigner-241028.jpg&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;&#xA;&#xA;&lt;h2 id=&#34;selinux-est-le-standard-de-lindustrie&#34;&gt;SELinux est le standard de l’industrie&lt;/h2&gt;&#xA;&#xA;&lt;p&gt;&lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;SELinux&lt;/code&gt; (pour “Security-Enhanced Linux”) répond à cette question en ajoutant&#xA;une couche de sécurité supplémentaire au-delà du système de permissions&#xA;traditionnel. Développé initialement par la NSA, SELinux applique des politiques&#xA;de sécurité strictes qui définissent précisément quels processus peuvent accéder&#xA;à quelles ressources (fichiers, ports réseau, etc.). Chaque processus est ainsi&#xA;isolé et confiné dans un contexte spécifique. Concrètement, si un utilisateur&#xA;(non privilégié) se voit accorder des privilèges sudo, il peut contourner ces&#xA;restrictions : le mode &lt;a href=&#34;https://docs.redhat.com/en/documentation/red_hat_enterprise_linux/7/html/virtualization_security_guide/sect-virtualization_security_guide-svirt-mac&#34;&gt;Mandatory Access Control (MAC)&lt;/a&gt; est alors contourné, et&#xA;la sécurité des services en cours d’exécution ne peut plus être garantie.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Concernant PostgreSQL, bien qu’il ne soit pas lancé en &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;root&lt;/code&gt;, un accès privilégié&#xA;(via sudo) est souvent nécessaire pour gérer (activer, démarrer, stopper,…) les&#xA;services liés aux instances via systemd. Définir une politique SELinux devient&#xA;alors complexe, surtout avec les autres composants de la stack PostgreSQL, comme&#xA;pgBackRest ou Patroni. Cela soulève la question du juste équilibre entre permettre&#xA;aux DBA de gérer PostgreSQL (et les services annexes), tout en préservant la sécurité&#xA;globale du système.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Voir notre article ci-dessous pour un exemple concret:&lt;/p&gt;&#xA;&#xA;&lt;p&gt;&lt;a href=&#34;https://blog.dalibo.com/2014/10/06/Confiner_PostgreSQL_avec_SELinux.html&#34;&gt;https://blog.dalibo.com/2014/10/06/Confiner_PostgreSQL_avec_SELinux.html&lt;/a&gt;&lt;/p&gt;&#xA;&#xA;&lt;h2 id=&#34;ansible-augmente-la-surface-dattaque&#34;&gt;Ansible augmente la surface d’attaque&lt;/h2&gt;&#xA;&#xA;&lt;p&gt;La difficulté augmente également lorsque l’on passe à l’échelle supérieure et que&#xA;l’on veut piloter un parc d’instances avec un outil d’orchestration comme Ansible.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Pour gérer chaque instance PostgreSQL, le nœud de contrôle Ansible va se connecter&#xA;en SSH à chaque serveur et devra acquérir les privilèges superutilisateur pour&#xA;certaines opérations, notamment pour manipuler le service Postgres.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Par exemple:&lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-yaml highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;  &lt;span class=&#34;pi&#34;&gt;-&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;Enabling postgresql services&lt;/span&gt;&#xA;    &lt;span class=&#34;na&#34;&gt;become&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;true&lt;/span&gt;&#xA;    &lt;span class=&#34;na&#34;&gt;ansible.builtin.service&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt;&#xA;      &lt;span class=&#34;na&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;postgresql&lt;/span&gt;&#xA;      &lt;span class=&#34;na&#34;&gt;state&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;started&lt;/span&gt;&#xA;      &lt;span class=&#34;na&#34;&gt;enabled&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;true&lt;/span&gt;&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;Ici la ligne &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;become: true&lt;/code&gt; permet de devenir &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;root&lt;/code&gt; le temps de réaliser la tâche&#xA;pour vérifier l’état du service et de l’activer et démarrer si nécessaire.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Cette simple ligne semble anodine, mais implique que l’utilisateur lançant le playbook&#xA;peut acquérir les droits superutilisateur à tout moment sur un nœud distant.&#xA;Concrètement, cela signifie que l’utilisateur pilotant les playbooks Ansible est&#xA;de facto &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;root&lt;/code&gt; sur l’ensemble du parc d’instances Postgres.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;&lt;img src=&#34;/img/2025_ansible.drawio.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;&#xA;&#xA;&lt;p&gt;C’est en cela qu’Ansible peut élargir la surface d’attaque vers PostgreSQL. En effet,&#xA;le nœud de contrôle est une cible de choix pour les attaquants : plutôt que d’attaquer&#xA;directement les bases de données qui sont généralement les éléments les plus protégés,&#xA;ils tenteront d’accéder indirectement aux instances en passant par des points d’entrées&#xA;moins bien sécurisés et plus facile d’accès.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Bien sûr, il est possible de restreindre les commandes accessibles via des solutions d’élévation&#xA;de privilèges comme &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;sudo&lt;/code&gt;, &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;doas&lt;/code&gt; ou d’autres mécanismes similaires, notamment en configurant&#xA;leurs fichiers de contrôle (par exemple &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;/etc/sudoers&lt;/code&gt; pour &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;sudo&lt;/code&gt;). Cependant, cela ajoute une&#xA;couche supplémentaire de complexité et augmente le risque d’erreur de configuration.&lt;/p&gt;&#xA;&#xA;&lt;h2 id=&#34;séparer-les-rôles-pour-mieux-confiner-postgres&#34;&gt;Séparer les rôles pour mieux confiner Postgres&lt;/h2&gt;&#xA;&#xA;&lt;p&gt;La solution consiste à revenir à la racine du problème. Dans le cycle de&#xA;vie d’une instance Postgres, 2 types d’intervenant sont impliqués.&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;  &lt;li&gt;Un rôle “sysadmin” chargé de préparer la machine qui hébergera PostgreSQL&#xA;en installant tous les paquets logiciels nécessaires.&lt;/li&gt;&#xA;  &lt;li&gt;Un rôle “dba” chargé de créer les instances Postgres et garantir leur&#xA;bon fonctionnement.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;p&gt;Pour chacun de ces deux rôles, on assigne un et un seul utilisateur système.&#xA;Le rôle “sysadmin” aura les droits de l’utilisateur &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;root&lt;/code&gt;, tandis que&#xA;le rôle dba se limitera à des droits restreints nécessaires à la gestion des instances&#xA;PostgreSQL. Dans les exemples qui suivent, nous utiliserons l’utilisateur &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;postgres&lt;/code&gt;.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Concrètement cela signifie que l’on veut interdire aux DBA d’acquérir les&#xA;privilèges root via &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;sudo&lt;/code&gt; et lui interdire d’utiliser &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;become: true&lt;/code&gt;&#xA;dans ses playbooks Ansible !&lt;/p&gt;&#xA;&#xA;&lt;h2 id=&#34;les-services-utilisateur-de-systemd--un-trésor-caché&#34;&gt;Les services utilisateur de Systemd : un trésor caché&lt;/h2&gt;&#xA;&#xA;&lt;p&gt;Mais cela semble impossible puisque le service Postgres est lancé en tant&#xA;que &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;root&lt;/code&gt; via une commande du type &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;sudo systemctl start postgresql&lt;/code&gt; ?&lt;/p&gt;&#xA;&#xA;&lt;p&gt;C’est ici qu’entre en jeu le “mode user” de systemd, un mode de fonctionnement&#xA;largement méconnu et sous-estimé. En effet, la commande &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;systemctl --user&lt;/code&gt;&#xA;permet à chaque utilisateur de démarrer/arrêter/activer/désactiver ses propres&#xA;services.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Dans le cas de PostgreSQL, on fera généralement tourner le service avec&#xA;l’utilisateur système &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;postgres&lt;/code&gt; mais il est possible d’utiliser n’importe&#xA;quel autre utilisateur. On stockera les données (PGDATA) dans le dossier &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;$HOME&lt;/code&gt;&#xA;de l’utilisateur plutot que dans le dossier traditionnel &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;/var/lib/postgres&lt;/code&gt;.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Enfin il est nécessaire d’activer la fonction &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;lingering&lt;/code&gt; pour l’utilisateur,&#xA;qui permet au service de continuer à tourner, même après la déconnexion de&#xA;l’utilisateur. Cette fonction est activée par la commande ci-dessous:&lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-bash highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;loginctl enable-linger &amp;lt;utilisateur&amp;gt;&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;h2 id=&#34;pglift--la-sécurité-par-défaut&#34;&gt;pglift : la sécurité par défaut&lt;/h2&gt;&#xA;&#xA;&lt;p&gt;En tant qu’outil de déploiement, &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;pglift&lt;/code&gt; tire pleinement partie de systemd et&#xA;de ce mode utilisateur.&#xA;Lorsque systemd est activé, &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;pglift&lt;/code&gt; utilise le mode utilisateur par défaut.&#xA;Concrètement la commande &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;pglift instance create&lt;/code&gt; initialise une nouvelle instance&#xA;et crée une unité de service systemd pour l’utilisateur &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;postgres&lt;/code&gt;.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Désormais, l’utilisateur &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;postgres&lt;/code&gt; peut manipuler son instance sans utiliser&#xA;la commande &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;sudo&lt;/code&gt;. De même, il peut créer une instance avec un playbook&#xA;Ansible sans utiliser &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;become: true&lt;/code&gt;.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Par exemple :&lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-yaml highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;pi&#34;&gt;-&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;Create and configure my postgresql instances&lt;/span&gt;&#xA;  &lt;span class=&#34;na&#34;&gt;hosts&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;localhost&lt;/span&gt;&#xA;  &lt;span class=&#34;na&#34;&gt;tasks&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt;&#xA;    &lt;span class=&#34;pi&#34;&gt;-&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;Create production instance&lt;/span&gt;&#xA;      &lt;span class=&#34;na&#34;&gt;dalibo.pglift.instance&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt;&#xA;        &lt;span class=&#34;na&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;prod&lt;/span&gt;&#xA;        &lt;span class=&#34;na&#34;&gt;state&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;started&lt;/span&gt;&#xA;        &lt;span class=&#34;na&#34;&gt;port&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&#34;&lt;/span&gt;&#xA;        &lt;span class=&#34;na&#34;&gt;settings&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt;&#xA;          &lt;span class=&#34;na&#34;&gt;max_connections&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;m&#34;&gt;100&lt;/span&gt;&#xA;          &lt;span class=&#34;na&#34;&gt;shared_buffers&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;1GB&lt;/span&gt;&#xA;          &lt;span class=&#34;na&#34;&gt;unix_socket_directories&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;/tmp&lt;/span&gt;&#xA;          &lt;span class=&#34;na&#34;&gt;shared_preload_libraries&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;pg_stat_statements, passwordcheck&lt;/span&gt;&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;Atout majeur de ce confinement du service postgres : cela rend l’activation de&#xA;SELinux complètement trivial ! Puisque le processus PostgreSQL tourne dans&#xA;le contexte de l’utilisateur système &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;postgres&lt;/code&gt;, les accès aux ressources sont&#xA;déjà encadrés par les droits d’accès standard.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;En d’autres termes, si un attaquant arrive à compromettre une instance&#xA;PostgreSQL créée avec pglift, il ne pourra pas “sortir” du rôle &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;postgres&lt;/code&gt;&#xA;et n’aura pas accès à des ressources non-autorisées.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Cette approche permet également d’isoler plusieurs instances PostgreSQL exécutées&#xA;sous des comptes utilisateurs distincts. Chaque instance dispose de son propre&#xA;répertoire de données, accessible uniquement à l’utilisateur qui l’exécute. Ainsi,&#xA;les données ne sont ni accessibles ni modifiables par d’autres comptes, y compris&#xA;l’utilisateur postgres. Ce cloisonnement, basé sur les permissions classiques&#xA;du système de fichiers, assure une séparation stricte et efficace des&#xA;environnements basée sur des mécanismes éprouvés.&lt;/p&gt;&#xA;&#xA;&lt;h2 id=&#34;etablir-une-politique-de-sécurité-à-grande-échelle&#34;&gt;Etablir une politique de sécurité à grande échelle&lt;/h2&gt;&#xA;&#xA;&lt;p&gt;En résumé, pglift vous permet facilement et par défaut de:&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;  &lt;li&gt;Séparer clairement les rôles “sysadmin” et “dba”&lt;/li&gt;&#xA;  &lt;li&gt;Activer SELinux sans configuration complexe&lt;/li&gt;&#xA;  &lt;li&gt;Interdire &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;sudo&lt;/code&gt; à l’utilisateur &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;postgres&lt;/code&gt;&lt;/li&gt;&#xA;  &lt;li&gt;Éradiquer la clause &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;become: true&lt;/code&gt; des playbooks PostgreSQL&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;p&gt;Il existe évidement d’autres mesures de sécurité à mettre en place pour&#xA;compléter l’arsenal de protection de vos bases de données. On peut notamment&#xA;citer :&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;  &lt;li&gt;Imposer les accès nominatifs avec un annuaire externe et &lt;a href=&#34;https://ldap2pg.readthedocs.io/en/latest/&#34;&gt;ldap2pg&lt;/a&gt;&lt;/li&gt;&#xA;  &lt;li&gt;Anonymiser les données sur les environnements secondaires (dev, testing) avec&#xA;&lt;a href=&#34;https://postgresql-anonymizer.readthedocs.io/en/stable/&#34;&gt;PostgreSQL Anonymizer&lt;/a&gt;&lt;/li&gt;&#xA;  &lt;li&gt;Tracer toutes les interactions des utilisateurs avec &lt;a href=&#34;https://www.pgaudit.org/&#34;&gt;pgaudit&lt;/a&gt;&lt;/li&gt;&#xA;  &lt;li&gt;Compartimenter les processus et les ressources de PostgreSQL grace&#xA;espaces de noms (“namespaces”) de Linux&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;p&gt;De vastes sujets, que nous arborderons peut-être à l’occasion d’un prochain&#xA;article !&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Crédit Photo: &lt;a href=&#34;https://www.pexels.com/fr-fr/photo/signalisation-241028/&#34;&gt;Pew Nguyen&lt;/a&gt;&lt;/p&gt;</summary>
    <author>
      <name>blog.dalibo.com</name>
    </author>
  </entry>
  <entry>
    <title>ldap2pg 6.5 pour PostgreSQL 18</title>
    <updated>2025-10-06T05:00:00Z</updated>
    <id>tag:blog.dalibo.com,2025-10-06://2025/10/06/ldap2pg-6.5.html</id>
    <link href="https://blog.dalibo.com//2025/10/06/ldap2pg-6.5.html" rel="alternate"></link>
    <summary type="html">&lt;p&gt;&lt;em&gt;Paris, le 6 octobre 2025&lt;/em&gt;&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Dalibo vous annonce la disponibilité de ldap2pg 6.5.&#xA;Cette version apporte le support de PostgreSQL 18 et quelques correctifs.&#xA;Suivez la &lt;a href=&#34;https://ldap2pg.readthedocs.io/en/latest/install/&#34;&gt;documentation pour installer&lt;/a&gt; cette nouvelle version.&lt;/p&gt;&#xA;&#xA;&lt;!--MORE--&gt;&#xA;&#xA;&lt;p&gt;&lt;img src=&#34;https://github.com/dalibo/ldap2pg/raw/master/docs/img/logo-phrase.png&#34; alt=&#34;ldap2pg&#34; /&gt;&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Depuis 2017, ldap2pg propose la meilleure solution de synchronisation automatique de rôles et de privilèges pour PostgreSQL.&#xA;Configurez l’authentification LDAP dans le fichier &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;pg_hba.conf&lt;/code&gt;&#xA;puis utilisez ldap2pg pour créer et configurer les rôles depuis votre annuaire d’entreprise.&lt;/p&gt;&#xA;&#xA;&lt;h3 id=&#34;postgresql-18&#34;&gt;PostgreSQL 18&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;PostgreSQL 18 apporte un peu plus de rigueur&#xA;et a requis quelques ajustements dans les requêtes d’inspection des privilèges.&#xA;Ces ajustements optimisent toutes les requêtes d’inspection des privilèges&#xA;pour toutes les versions de PostgreSQL.&lt;/p&gt;&#xA;&#xA;&lt;h3 id=&#34;routines-fonctions-procédures&#34;&gt;Routines, fonctions, procédures&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;Dans PostgreSQL,&#xA;la distinction entre procédures et fonctions est très mince.&#xA;D’ailleurs, la syntaxe &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;CREATE PROCEDURE&lt;/code&gt; n’existe que depuis PostgreSQL 11.&#xA;PostgreSQL utilise le mot clef &lt;em&gt;ROUTINE&lt;/em&gt; pour traiter indifféremment fonctions et procédures.&#xA;C’est notamment le cas pour les privilèges par défaut&#xA;qui ne peuvent être distingués pour les procédures ou les fonctions.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;ldap2pg 6.5 respecte mieux la nomenclature de PostgreSQL.&#xA;Les privilèges sur les routines s’appliquent aux procédures comme aux fonctions.&#xA;Les requêtes de gestion des fonctions sont désormais correctement limitées aux fonctions.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;À partir de ldap2pg 6.5,&#xA;mieux vaut utiliser &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;__execute_on_routines__&lt;/code&gt; que l’équivalent pour les fonctions.&lt;/p&gt;&#xA;&#xA;&lt;h3 id=&#34;autres-changements&#34;&gt;Autres changements&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;ldap2pg 6.5 permet de gérer les privilèges par défaut à soi-même,&#xA;applique la configuration utilisateur sur les rôles dynamiques&#xA;et accepte de gérer les droits d’objets dans des bases à accès limité.&#xA;Enfin ldap2pg est disponible dans les dépôts Ubuntu 24.04 de Dalibo Labs.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Pour plus d’informations, consultez la &lt;a href=&#34;https://ldap2pg.readthedocs.io/en/latest/changelog/#ldap2pg-65&#34;&gt;documentation des changements&lt;/a&gt;.&#xA;Pour mettre à jour en toute sécurité,&#xA;désactivez les tâches planifiées ldap2pg,&#xA;testez la synchronisation manuellement avec la nouvelle version&#xA;et validez les changements que peuvent apporter cette nouvelle version.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Retrouvez la documentation en anglais, des procédures et le support communautaire à ces adresses :&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;  &lt;li&gt;Documentation en ligne : &lt;a href=&#34;http://ldap2pg.rtfd.io/en/latest/&#34;&gt;http://ldap2pg.rtfd.io/en/latest/&lt;/a&gt;&lt;/li&gt;&#xA;  &lt;li&gt;Le projet sur GitHub : &lt;a href=&#34;https://github.com/dalibo/ldap2pg&#34;&gt;https://github.com/dalibo/ldap2pg&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;hr /&gt;&#xA;&#xA;&lt;p&gt;&lt;strong&gt;Étienne BERSAC et Pierre-Louis GONON développent ldap2pg,&#xA;un projet du &lt;a href=&#34;https://labs.dalibo.com/&#34;&gt;Dalibo Labs&lt;/a&gt;.&#xA;Pour toutes questions techniques,&#xA;l’équipe recommande d’utiliser la page de &lt;a href=&#34;https://github.com/dalibo/ldap2pg/discussions&#34;&gt;ldap2pg sur GitHub&lt;/a&gt;.&lt;/strong&gt;&lt;/p&gt;</summary>
    <author>
      <name>blog.dalibo.com</name>
    </author>
  </entry>
  <entry>
    <title>Industrialiser les sauvegardes de PostgreSQL</title>
    <updated>2025-09-11T05:00:00Z</updated>
    <id>tag:blog.dalibo.com,2025-09-11://2025/09/11/industrialiser-les-sauvegardes-de-postgresql.html</id>
    <link href="https://blog.dalibo.com//2025/09/11/industrialiser-les-sauvegardes-de-postgresql.html" rel="alternate"></link>
    <summary type="html">&lt;p&gt;&lt;em&gt;Nantes, le 11 Septembre 2025&lt;/em&gt;&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Nous avons vu dans un précédent article comment faciliter l’industrialisation du déploiement d’instances PostgreSQL.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Dans ce nouvel article, nous allons approfondir sur le déploiement des sauvegardes, qui sont un aspect important &#xA;à prendre en compte pour que les instances déployées automatiquement soient prêtes pour la production. Nous verrons&#xA;comment l’outil &lt;em&gt;pglift&lt;/em&gt; peut aider dans cette démarche.&lt;/p&gt;&#xA;&#xA;&lt;!--MORE--&gt;&#xA;&#xA;&lt;h2 id=&#34;types-de-sauvegarde&#34;&gt;Types de sauvegarde&lt;/h2&gt;&#xA;&#xA;&lt;p&gt;Pour les sauvegardes de PostgreSQL, on distingue deux stratégies distinctes mais complémentaires, les sauvegardes &#xA;physiques et les sauvegardes logiques.&lt;/p&gt;&#xA;&#xA;&lt;h3 id=&#34;sauvegardes-physiques-locale&#34;&gt;Sauvegardes physiques locale&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;Une sauvegarde physique est une copie du répertoire données de l’instance. Si cette opération est réalisée « à froid », c’est à dire lorsque l’instance est arrêtée, la restauration se fait par simple copie des fichiers sauvegardés vers le répertoire de &#xA;données. Si la sauvegarde est réalisée « à chaud », cette dernière est alors composée de données incohérentes. Il faut &#xA;alors, en plus de la sauvegarde des fichiers de données, sauvegarder les archives des journaux de transactions (WAL). &#xA;Lors du redémarrage, PostgreSQL rejoue les WAL sur les fichiers de données afin de retrouver un état cohérent. Souvent, on &#xA;utilise un outil de sauvegarde pour gérer les opérations de sauvegarde et restauration, ainsi que la gestion de &#xA;l’archivage des WAL. Dans cet article, nous allons nous pencher sur l’utilisation de pgBackRest au travers de pglift&#xA;pour automatiser le déploiement d’une sauvegarde dans un dépôt local.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Avec pglift, il est possible d’industrialiser la configuration de pgBackRest pour nos instances.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Voici un exemple simple d’une configuration de pglift qui le permet :&lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-yaml highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;nn&#34;&gt;---&lt;/span&gt;&#xA;&lt;span class=&#34;na&#34;&gt;systemd&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;pi&#34;&gt;{}&lt;/span&gt;&#xA;&lt;span class=&#34;na&#34;&gt;postgresql&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt;&#xA;    &lt;span class=&#34;na&#34;&gt;auth&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt;&#xA;        &lt;span class=&#34;na&#34;&gt;host&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;scram-sha-256&lt;/span&gt;&#xA;        &lt;span class=&#34;na&#34;&gt;local&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;peer&lt;/span&gt;&#xA;    &lt;span class=&#34;na&#34;&gt;datadir&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;/pgsql_data/{version}/{name}/data&lt;/span&gt;&#xA;&lt;span class=&#34;na&#34;&gt;pgbackrest&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt;&#xA;    &lt;span class=&#34;na&#34;&gt;repository&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt;&#xA;        &lt;span class=&#34;na&#34;&gt;mode&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;path&lt;/span&gt;&#xA;        &lt;span class=&#34;na&#34;&gt;path&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;/pgsql_backups/pgbackrest&lt;/span&gt;&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;Lorsqu’une instance PostgreSQL est déployée avec cette configuration de site, &#xA;et qu’un nom de stanza pgBackRest est spécifié lors de la création &#xA;d’instance, pgBackRest est configuré lors du déploiement :&lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-bash highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;postgres@srv-pg1 ~]&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;pglift instance create main &lt;span class=&#34;nt&#34;&gt;--pgbackrest-stanza&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;my_app&#xA;INFO     initializing PostgreSQL         &#xA;INFO     configuring PostgreSQL authentication&#xA;INFO     configuring PostgreSQL&#xA;INFO     enabling systemd unit pglift-postgresql@14-main.service&#xA;INFO     starting PostgreSQL 14/main&#xA;INFO     starting systemd unit pglift-postgresql@14-main.service&#xA;INFO     creating role &lt;span class=&#34;s1&#34;&gt;&#39;backup&#39;&lt;/span&gt;&#xA;INFO     configuring pgBackRest stanza &lt;span class=&#34;s1&#34;&gt;&#39;my_app&#39;&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;for &lt;/span&gt;pg1-path&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;/pgsql_data/14/main/data&#xA;INFO     creating pgBackRest stanza &lt;span class=&#34;s1&#34;&gt;&#39;my_app&#39;&lt;/span&gt;&#xA;INFO     checking pgBackRest configuration &lt;span class=&#34;k&#34;&gt;for &lt;/span&gt;stanza &lt;span class=&#34;s1&#34;&gt;&#39;my_app&#39;&lt;/span&gt;&#xA;INFO     enabling systemd unit pglift-backup@14-main.timer&#xA;INFO     creating instance dumps directory: /home/postgres/.local/share/pglift/srv/dumps/14-main&#xA;INFO     starting systemd unit pglift-backup@14-main.timer&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;pglift génère un fichier de configuration pour pgBackRest :&lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-bash highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;postgres@srv-pg1 ~]&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;cat&lt;/span&gt; ~/.local/share/pglift/etc/pgbackrest/pgbackrest.conf &#xA;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;global]&#xA;lock-path &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; /run/user/1001/pglift/pgbackrest/lock&#xA;log-path &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; /home/postgres/.local/share/pglift/log/pgbackrest&#xA;spool-path &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; /home/postgres/.local/share/pglift/srv/pgbackrest/spool&#xA;repo1-path &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; /pgsql_backups/pgbackrest&#xA;repo1-retention-archive &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; 2&#xA;repo1-retention-diff &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; 3&#xA;repo1-retention-full &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; 2&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;Il ajoute une stanza pour l’instance dans &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;conf.d&lt;/code&gt; :&lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-bash highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;postgres@srv-pg1 ~]&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;cat&lt;/span&gt; ~/.local/share/pglift/etc/pgbackrest/conf.d/my_app.conf &#xA;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;my_app]&#xA;pg1-path &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; /pgsql_data/14/main/data&#xA;pg1-port &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; 5432&#xA;pg1-user &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; backup&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;Enfin, il prend également en charge la configuration du paramètre &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;archive_command&lt;/code&gt; pour &#xA;archiver les WAL vers le dépôt de sauvegarde via la commande &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;pgbackrest archive-push&lt;/code&gt; :&lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-bash highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;postgres@srv-pg1 ~]&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;pglift instance &lt;span class=&#34;nb&#34;&gt;exec &lt;/span&gt;main &lt;span class=&#34;nt&#34;&gt;--&lt;/span&gt; psql &lt;span class=&#34;nt&#34;&gt;-c&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;show archive_command&#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&#xA;                                                                     archive_command                               &#xA;                                      &#xA;&lt;span class=&#34;nt&#34;&gt;-------------------------------------------------------------------------------------------------------------------&lt;/span&gt;&#xA;&lt;span class=&#34;nt&#34;&gt;--------------------------------------&lt;/span&gt;&#xA; /usr/bin/pgbackrest &lt;span class=&#34;nt&#34;&gt;--config-path&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;/home/postgres/.local/share/pglift/etc/pgbackrest &lt;span class=&#34;nt&#34;&gt;--stanza&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;my_app &lt;span class=&#34;nt&#34;&gt;--pg1-path&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;/pg&#xA;sql_data/14/main/data archive-push %p&#xA;&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;1 row&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;Par conséquent, dès le déploiement, les WAL sont archivés dans le dépôt de sauvegarde&#xA;de pgBackRest et la sauvegarde de l’instance est alors possible. Pour cela, on utilise &#xA;la commande &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;pglift instance backup&lt;/code&gt; :&lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-bash highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;postgres@srv-pg1 ~]&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;pglift instance backup&#xA;INFO     backing up instance 17/main with pgBackRest    &#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;Pour lister les sauvegardes présentes dans le dépôt, on utilise la commande &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;pglift instance backups&lt;/code&gt; :&lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-bash highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;postgres@srv-pg1 ~]&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;pglift instance backups&#xA;                                       Available backups &lt;span class=&#34;k&#34;&gt;for &lt;/span&gt;instance 14/main                                        &#xA;┏━━━━━━━━━━━━━━━━━━┳━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━┳━━━━━━━━━━━┓&#xA;┃ label            ┃ size    ┃ repo_size ┃ date_start                ┃ date_stop                 ┃ &lt;span class=&#34;nb&#34;&gt;type&lt;/span&gt; ┃ databases ┃&#xA;┡━━━━━━━━━━━━━━━━━━╇━━━━━━━━━╇━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━╇━━━━━━━━━━━┩&#xA;│ 20250826-121904F │ 26.5 MB │ 3.3 MB    │ 2025-08-26 12:19:04+02:00 │ 2025-08-26 12:19:10+02:00 │ full │ postgres  │&#xA;└──────────────────┴─────────┴───────────┴───────────────────────────┴───────────────────────────┴──────┴───────────┘&#xA;&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;Sinon, la commande &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;pgbackrest info&lt;/code&gt;, exécutée au travers de &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;pglift instance exec&lt;/code&gt;&#xA;permet aussi d’obtenir les informations sur les sauvegardes, cette fois directement &#xA;depuis pgBackRest :&lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-bash highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;postgres@srv-pg1 ~]&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;pglift instance &lt;span class=&#34;nb&#34;&gt;exec &lt;/span&gt;main &lt;span class=&#34;nt&#34;&gt;--&lt;/span&gt; pgbackrest info&#xA;stanza: my_app&#xA;    status: ok&#xA;    cipher: none&#xA;&#xA;    db &lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;current&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;&#xA;        wal archive min/max &lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;14&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;: 000000010000000000000001/000000010000000000000003&#xA;&#xA;        full backup: 20250826-121904F&#xA;            timestamp start/stop: 2025-08-26 12:19:04+02 / 2025-08-26 12:19:10+02&#xA;            wal start/stop: 000000010000000000000003 / 000000010000000000000003&#xA;            database size: 25.3MB, database backup size: 25.3MB&#xA;            repo1: backup &lt;span class=&#34;nb&#34;&gt;set &lt;/span&gt;size: 3.2MB, backup size: 3.2MB&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;Pour vérifier le bon fonctionnement, on peut créer une table dans une nouvelle base de données, pour y insérer quelques lignes :&lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-bash highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;postgres@srv-pg1 pglift]&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;pglift database create db1&#xA;INFO     creating &lt;span class=&#34;s1&#34;&gt;&#39;db1&#39;&lt;/span&gt; database &lt;span class=&#34;k&#34;&gt;in &lt;/span&gt;17/main      &#xA;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;postgres@srv-pg1 pglift]&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;pglift instance &lt;span class=&#34;nb&#34;&gt;exec &lt;/span&gt;main &lt;span class=&#34;nt&#34;&gt;--&lt;/span&gt; psql &lt;span class=&#34;nt&#34;&gt;-d&lt;/span&gt; db1 &lt;span class=&#34;nt&#34;&gt;-c&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;CREATE TABLE t1 (id INT); INSERT INTO t1 VALUES (1),(2),(3);&#34;&lt;/span&gt;&#xA;CREATE TABLE&#xA;INSERT 0 3&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;Noter ensuite la date et l’heure actuelle :&lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-bash highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;postgres@srv-pg1 ~]&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;pglift instance &lt;span class=&#34;nb&#34;&gt;exec &lt;/span&gt;main &lt;span class=&#34;nt&#34;&gt;--&lt;/span&gt; psql &lt;span class=&#34;nt&#34;&gt;-c&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;select now();&#34;&lt;/span&gt;&#xA;              now              &#xA;&lt;span class=&#34;nt&#34;&gt;-------------------------------&lt;/span&gt;&#xA; 2025-08-26 12:20:18.968157+02&#xA;&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;1 row&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;&#xA;&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;Puis supprimer la table &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;t1&lt;/code&gt; :&lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-bash highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;postgres@srv-pg1 ~]&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;pglift instance &lt;span class=&#34;nb&#34;&gt;exec &lt;/span&gt;main &lt;span class=&#34;nt&#34;&gt;--&lt;/span&gt; psql &lt;span class=&#34;nt&#34;&gt;-d&lt;/span&gt; db1 &lt;span class=&#34;nt&#34;&gt;-c&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;DROP TABLE t1&#34;&lt;/span&gt;&#xA;DROP TABLE&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;La table &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;t1&lt;/code&gt;, désormais manquante, n’était pas présente au moment de la sauvegarde, &#xA;ni même la base de données &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;db1&lt;/code&gt; qui la contient. On pourrait donc croire que les &#xA;données sont perdues. Cependant, les actions menant à la création de la base de &#xA;données et de la table on été enregistrées dans les journaux de transaction (WAL), &#xA;il est donc tout à fait possible de retrouver les données en restaurant la &#xA;sauvegarde qui précède l’existence de la table, puis en laissant PostgreSQL &#xA;rejouer les WAL sur ses fichiers de données pendant la phase de recover.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Les WAL sont archivés dans le dépôt de sauvegarde de pgBackRest, et PostgreSQL &#xA;est capable d’accéder à ces archives via le paramètre &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;restore_command&lt;/code&gt;, qui &#xA;est également configuré automatiquement par pglift lors du déploiement :&lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-plaintext highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;postgres=# show restore_command ;&#xA;                                                     restore_command                                                     &#xA;-------------------------------------------------------------------------------------------------------------------------&#xA; /usr/bin/pgbackrest --config-path=/home/postgres/.local/share/pglift/etc/pgbackrest --stanza=my_app archive-get %f &#34;%p&#34;&#xA;(1 row)&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;Le rejeu des WAL est exécuté lors du premier démarrage qui suit la restauration. &#xA;Pour restaurer notre table &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;t1&lt;/code&gt;, pglift va donc exécuter une restauration de &#xA;l’instance via pgBackRest. Ce dernier va alors configurer PostgreSQL pour rejouer &#xA;les WAL jusqu’à la date et heure demandée, c’est à dire celle que nous avons noté&#xA;plus tôt.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;L’instance est arrêtée, puis restaurée avec la commande &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;pglift instance restore&lt;/code&gt;. &#xA;On spécifie la date au format &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;YYYY-MM-JJ HH:MM:SS&lt;/code&gt; avec l’option &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;--date&lt;/code&gt;.&lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-bash highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;postgres@srv-pg1 pglift]&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;pglift instance stop&#xA;INFO     stopping PostgreSQL 17/main&#xA;INFO     stopping systemd unit pglift-postgresql@17-main.&#xA;INFO     stopping systemd unit pglift-backup@17-main.timer&#xA;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;postgres@srv-pg1 pglift]&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;pglift instance restore &lt;span class=&#34;nt&#34;&gt;--date&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;2025-08-26 12:20:18&#34;&lt;/span&gt;&#xA;INFO     restoring instance 17/main with pgBackRest &#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;Démarrer l’instance. PostgreSQL effectue alors le recover jusqu’à la date et heure cible :&lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-bash highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;postgres@srv-pg1 ~]&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;pglift instance start&#xA;INFO     starting PostgreSQL 14/main                                                                               &#xA;INFO     starting systemd unit pglift-postgresql@14-main.service                                                   &#xA;INFO     starting systemd unit pglift-backup@14-main.timer     &#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;La trace lors du démarrage nous indique bien que le recovery s’est arrêté avant la &#xA;transaction exécutée à 12:20:35, ce qui correspond à la suppression de la table &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;t1&lt;/code&gt;.&lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-bash highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;Aug 26 10:21:06 srv-pg1 postgresql-14-main[33116]: &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;13-1] &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;33116]: &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;6-1] &lt;span class=&#34;nv&#34;&gt;db&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;,user&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;,app&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;,client&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; LOG:  restored log file &lt;span class=&#34;s2&#34;&gt;&#34;000000010000000000000004&#34;&lt;/span&gt; from archive&#xA;Aug 26 10:21:06 srv-pg1 postgresql-14-main[33116]: &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;14-1] &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;33116]: &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;7-1] &lt;span class=&#34;nv&#34;&gt;db&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;,user&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;,app&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;,client&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; LOG:  recovery stopping before commit of transaction 736, &lt;span class=&#34;nb&#34;&gt;time &lt;/span&gt;2025-08-26 12:20:35.654705+02&#xA;Aug 26 10:21:06 srv-pg1 postgresql-14-main[33116]: &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;15-1] &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;33116]: &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;8-1] &lt;span class=&#34;nv&#34;&gt;db&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;,user&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;,app&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;,client&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; LOG:  redo &lt;span class=&#34;k&#34;&gt;done &lt;/span&gt;at 0/40188D8 system usage: CPU: user: 0.00 s, system: 0.03 s, elapsed: 0.14 s&#xA;Aug 26 10:21:06 srv-pg1 postgresql-14-main[33116]: &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;16-1] &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;33116]: &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;9-1] &lt;span class=&#34;nv&#34;&gt;db&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;,user&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;,app&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;,client&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; LOG:  last completed transaction was at log &lt;span class=&#34;nb&#34;&gt;time &lt;/span&gt;2025-08-26 12:20:14.593246+02&#xA;Aug 26 10:21:06 srv-pg1 postgresql-14-main[33116]: &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;17-1] &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;33116]: &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;10-1] &lt;span class=&#34;nv&#34;&gt;db&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;,user&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;,app&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;,client&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; LOG:  selected new timeline ID: 2&#xA;Aug 26 10:21:06 srv-pg1 postgresql-14-main[33116]: &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;18-1] &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;33116]: &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;11-1] &lt;span class=&#34;nv&#34;&gt;db&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;,user&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;,app&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;,client&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; LOG:  archive recovery &lt;span class=&#34;nb&#34;&gt;complete&lt;/span&gt;&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;La table est donc bien de nouveau consultable dans la base de données &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;db1&lt;/code&gt; :&lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-bash highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;postgres@srv-pg1 ~]&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;pglift instance &lt;span class=&#34;nb&#34;&gt;exec &lt;/span&gt;main &lt;span class=&#34;nt&#34;&gt;--&lt;/span&gt; psql &lt;span class=&#34;nt&#34;&gt;-d&lt;/span&gt; db1 &lt;span class=&#34;nt&#34;&gt;-c&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;SELECT * FROM t1&#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&#xA; &lt;span class=&#34;nb&#34;&gt;id&lt;/span&gt; &#xA;&lt;span class=&#34;nt&#34;&gt;----&lt;/span&gt;&#xA;  1&#xA;  2&#xA;  3&#xA;&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;3 rows&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;h4 id=&#34;sauvegarde-physique-à-distance&#34;&gt;Sauvegarde physique à distance&lt;/h4&gt;&#xA;&#xA;&lt;p&gt;Nous avons décrit le fonctionnement de la sauvegarde physique locale, mais&#xA;pgBackRest peut également fonctionner sur un modèle client-serveur, dans lequel&#xA;un serveur pgBackRest regroupe les sauvegardes provenant de plusieurs instances &#xA;PostgreSQL dans un dépôt unique et centralise leurs planifications. Ce mode &#xA;de fonctionnement ne sera pas développé en détail dans cet article, mais il est &#xA;également supporté par pglift.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;&lt;a href=&#34;https://pglift.readthedocs.io/en/latest/user/setup/pgbackrest.html#remote-repository-mode&#34;&gt;Voir la documentation associée&lt;/a&gt;&lt;/p&gt;&#xA;&#xA;&lt;h3 id=&#34;sauvegardes-logiques&#34;&gt;Sauvegardes logiques&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;Les sauvegardes logiques fonctionnent selon un principe différent. Dans ce &#xA;mode de sauvegarde, les données de l’instance sont exportées dans un ou plusieurs &#xA;fichiers.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Un dump est une sauvegarde qui correspond au résultat d’une lecture cohérente de &#xA;la base de données, telle qu’elle était au moment du début de la sauvegarde, et &#xA;quelque soit la durée d’export des données. Cela est rendu possible par le &#xA;mécanisme MVCC de PostgreSQL, qui permet d’accéder aux versions précédentes des &#xA;données qui pourraient avoir été modifiées pendant que la sauvegarde est effectuée.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Le dump peut être importé sur son instance d’origine pour restaurer une base de &#xA;données à un état précédent. Il peut aussi être utile pour des besoins de &#xA;migration, ou pour porter des données sur une instance de test par exemple.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;L’outil standard &lt;em&gt;pg_dump&lt;/em&gt; permet de réaliser ces sauvegardes, et il peut être &#xA;piloté par &lt;em&gt;pglift&lt;/em&gt; pour réaliser les dumps sur les instances qu’il déploie.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;&lt;em&gt;pglift&lt;/em&gt; effectue l’export des données via la commande spécifiée dans la &#xA;clé &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;postgresql.dump_commands&lt;/code&gt; de sa configuration. La valeur par défaut est la &#xA;suivante :&lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-yaml highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;na&#34;&gt;dump_commands&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt;&#xA;&lt;span class=&#34;pi&#34;&gt;-&lt;/span&gt; &lt;span class=&#34;pi&#34;&gt;-&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;{bindir}/pg_dump&#39;&lt;/span&gt;&#xA;&lt;span class=&#34;pi&#34;&gt;-&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;-Fc&lt;/span&gt;&#xA;&lt;span class=&#34;pi&#34;&gt;-&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;-f&lt;/span&gt;&#xA;&lt;span class=&#34;pi&#34;&gt;-&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;{path}/{dbname}_{date}.dump&#39;&lt;/span&gt;&#xA;&lt;span class=&#34;pi&#34;&gt;-&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;-d&lt;/span&gt;&#xA;&lt;span class=&#34;pi&#34;&gt;-&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;{conninfo}&#39;&lt;/span&gt;&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;On voit ici que &lt;em&gt;pg_dump&lt;/em&gt; sera utilisé pour réaliser un dump au format&#xA;&lt;em&gt;custom&lt;/em&gt; (&lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;-Fc&lt;/code&gt;).&lt;/p&gt;&#xA;&#xA;&lt;p&gt;L’emplacement du dump (&lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;{path}&lt;/code&gt;) correspond au paramètre &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;dumps_directory&lt;/code&gt;,&#xA;qui est par défaut déduit du répertoire de données :&lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-yaml highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;na&#34;&gt;dumps_directory&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;/pgsql_data/backups/dumps/{version}-{name}&lt;/span&gt;&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;Sur notre instance &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;main&lt;/code&gt;, nous pouvons donc faire une sauvegarde de la base&#xA;de données &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;db1&lt;/code&gt; avec la commande suivante :&lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-bash highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;postgres@srv-pg1 ~]&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;pglift database dump db1&#xA;INFO     backing up database &lt;span class=&#34;s1&#34;&gt;&#39;db1&#39;&lt;/span&gt; on instance 14/main &#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;On retrouve bien le dump à l’emplacement prévu :&lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-bash highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;postgres@srv-pg1 ~]&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;ls&lt;/span&gt; &lt;span class=&#34;nt&#34;&gt;-l&lt;/span&gt; /pgsql_data/backups/dumps/14-main/&#xA;total 4&#xA;&lt;span class=&#34;nt&#34;&gt;-rw-r--r--&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;.&lt;/span&gt; 1 postgres &lt;span class=&#34;nb&#34;&gt;users &lt;/span&gt;1176 Sep  1 14:35 db1_2025-09-01T14:35:30+00:00.dump&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;Et &lt;em&gt;pglift&lt;/em&gt; peut également lister les dumps présents dans ce répertoire :&lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-plaintext highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;[postgres@srv-pg1 ~]$ pglift database dumps&#xA;                                                   Dumps for all databases                                                    &#xA;┏━━━━━━━━━━━━━━━━┳━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓&#xA;┃ id             ┃ dbname ┃ date                      ┃ path                                                                 ┃&#xA;┡━━━━━━━━━━━━━━━━╇━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩&#xA;│ db1_665a78398d │ db1    │ 2025-09-01 14:35:30+00:00 │ /pgsql_data/backups/dumps/14-main/db1_2025-09-01T14:35:30+00:00.dump │&#xA;└────────────────┴────────┴───────────────────────────┴──────────────────────────────────────────────────────────────────────┘&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;Supprimer à nouveau la table &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;t1&lt;/code&gt; :&lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-bash highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;postgres@srv-pg1 ~]&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;pglift instance &lt;span class=&#34;nb&#34;&gt;exec &lt;/span&gt;main &lt;span class=&#34;nt&#34;&gt;--&lt;/span&gt; psql &lt;span class=&#34;nt&#34;&gt;-d&lt;/span&gt; db1 &lt;span class=&#34;nt&#34;&gt;-c&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;DROP TABLE t1&#34;&lt;/span&gt;&#xA;DROP TABLE&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;Pour retrouver nos données à partir de la sauvegarde, il convient de supprimer &#xA;la base de données, puis de restaurer via le dump, en spécifiant son identifiant :&lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-bash highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;postgres@srv-pg1 ~]&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;pglift database drop db1&#xA;INFO     dropping &lt;span class=&#34;s1&#34;&gt;&#39;db1&#39;&lt;/span&gt; database    &#xA;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;postgres@srv-pg1 ~]&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;pglift database restore db1_665a78398d&#xA;INFO     restoring dump &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;db1&#39;&lt;/span&gt; on instance 14/main    &#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;Les données sont bien restaurées :&lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-bash highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;postgres@srv-pg1 ~]&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;pglift instance &lt;span class=&#34;nb&#34;&gt;exec &lt;/span&gt;main &lt;span class=&#34;nt&#34;&gt;--&lt;/span&gt; psql &lt;span class=&#34;nt&#34;&gt;-d&lt;/span&gt; db1 &lt;span class=&#34;nt&#34;&gt;-c&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;SELECT * FROM t1&#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&#xA; &lt;span class=&#34;nb&#34;&gt;id&lt;/span&gt; &#xA;&lt;span class=&#34;nt&#34;&gt;----&lt;/span&gt;&#xA;  1&#xA;  2&#xA;  3&#xA;&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;3 rows&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;h1 id=&#34;pour-conclure&#34;&gt;Pour conclure&lt;/h1&gt;&#xA;&#xA;&lt;p&gt;Pour industrialiser PostgreSQL sans risque pour la sécurité des données, il &#xA;est important de prévoir au plus tôt comment celles-ci seront sauvegardées.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Nous avons vu comment l’outil &lt;em&gt;pglift&lt;/em&gt; nous permettait d’industrialiser le déploiement&#xA;de nos sauvegardes, physiques ou logiques, de telle sorte que toute nouvelle instance&#xA;est prête à être sauvegardées dès son initialisation. Le déploiement de la&#xA;sauvegarde étant alors industriel, on réduit les risques d’erreurs lors de sa&#xA;mise en place.&lt;/p&gt;</summary>
    <author>
      <name>blog.dalibo.com</name>
    </author>
  </entry>
  <entry>
    <title>Plongez dans le monde de CloudNativePG #9 - L&#39;ajout dynamique d&#39;extensions</title>
    <updated>2025-09-09T05:00:00Z</updated>
    <id>tag:blog.dalibo.com,2025-09-09://2025/09/09/cnpg-9.html</id>
    <link href="https://blog.dalibo.com//2025/09/09/cnpg-9.html" rel="alternate"></link>
    <summary type="html">&lt;p&gt;&lt;em&gt;Lyon, le 9 septembre 2025&lt;/em&gt;&lt;/p&gt;&#xA;&#xA;&lt;p&gt;&lt;strong&gt;CloudNativePG&lt;/strong&gt; ou comment embarquer un éléphant sur un porte-conteneurs !&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Les extensions font partie des nombreux avantages de PostgreSQL. Elles&#xA;permettent de rajouter des fonctionnalités à nos bases de données en chargeant des&#xA;modules complémentaires comme &lt;a href=&#34;https://postgis.net/&#34;&gt;&lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;PostGIS&lt;/code&gt;&lt;/a&gt; ou&#xA;encore &lt;a href=&#34;https://postgresql-anonymizer.readthedocs.io/en/stable/&#34;&gt;&lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;PostgreSQL Anonymizer&lt;/code&gt;&lt;/a&gt;.&#xA;CloudNativePG embarque déjà quelques extensions. Mais si l’on veut en rajouter&#xA;une, comment cela se passe-t-il 🤔 ?&lt;/p&gt;&#xA;&#xA;&lt;p&gt;C’est ce que nous allons voir avec une nouvelle fonctionnalité de la version&#xA;1.27 de l’opérateur et de l’utilisation du nouveau paramètre&#xA;&lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;extension_control_path&lt;/code&gt; de la version 18 de PostgreSQL.&lt;/p&gt;&#xA;&#xA;&lt;!--MORE--&gt;&#xA;&#xA;&lt;p&gt;&lt;img src=&#34;/img/cnpg-header.png&#34; alt=&#34;moteur&#34; /&gt;&lt;/p&gt;&#xA;&#xA;&lt;h3 id=&#34;les-extensions-disponibles&#34;&gt;Les extensions disponibles&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;Au moment de la rédaction de ce post, une quarantaine d’extensions sont&#xA;disponibles dans une instance PostgreSQL déployée avec CloudNativePG. Cela peut&#xA;facilement être vu avec la commande suivante :&lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-sql highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;n&#34;&gt;postgres&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=#&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;COUNT&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;pg_available_extensions&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&#xA; &lt;span class=&#34;k&#34;&gt;count&lt;/span&gt; &#xA;&lt;span class=&#34;c1&#34;&gt;-------&lt;/span&gt;&#xA;    &lt;span class=&#34;mi&#34;&gt;46&lt;/span&gt;&#xA;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;row&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;Ces extensions-là sont disponibles, car elles se trouvent être ajoutées à l’image&#xA;lors de sa construction. Certains opérateurs en embarquent plus, d’autres&#xA;beaucoup moins. Il est donc intéressant de vérifier celles qui sont déjà&#xA;déployées et dans quelles versions est disponibles.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Jusqu’à présent, si nous souhaitions utiliser une extension qui ne faisait pas&#xA;partie de cette liste, il était nécessaire de modifier l’image utilisée pour&#xA;l’intégrer. Bien que tout à fait faisable, cela n’était pas très flexible.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;La version 18 de PostgreSQL apporte une nouveauté avec le paramètre&#xA;&lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;extension_control_path&lt;/code&gt; qui permet d’indiquer d’autres emplacements où peuvent&#xA;être trouvées des extensions. L’idée des développeurs de CloudNativePG est de&#xA;mettre à jour ce paramètre en fonction des nouvelles extensions que nous&#xA;ajoutons pour prendre en compte dynamiquement les ajouts. Nous verrons plus tard&#xA;sur quel mécanisme de Kubernetes se repose cette fonctionnalité.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;L’idée est de présenter notre nouvelle extension via un nouveau conteneur à&#xA;notre &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;Pod&lt;/code&gt;. Et qui dit conteneur, dit image 📦.&lt;/p&gt;&#xA;&#xA;&lt;h3 id=&#34;création-dune-extension&#34;&gt;Création d’une extension&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;Bon pour commencer, il nous faut une extension. Pour les plus curieux, vous&#xA;pouvez trouver des explications sur comment faire dans cette suite d’&lt;a href=&#34;https://blog.dalibo.com/2023/06/08/hackingpg1.html&#34;&gt;articles&lt;/a&gt;.&#xA;Je me suis clairement inspiré de celui-ci, et ai donc deux fichiers dans un&#xA;dossier &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;/share/&lt;/code&gt; :&lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-bash highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;cat&lt;/span&gt; ./share/monextension--1.0.sql &#xA;&lt;span class=&#34;se&#34;&gt;\e&lt;/span&gt;cho Ne pas exécuter ce script, mais passer par CREATE EXTENSION&#xA;&#xA;CREATE OR REPLACE FUNCTION incremente&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;int&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;&#xA;RETURNS int&#xA;LANGUAGE sql&#xA;AS &lt;span class=&#34;s1&#34;&gt;&#39;SELECT $1+1&#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&#xA;&#xA;&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;cat&lt;/span&gt; ./share/monextension.control &#xA;comment &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;Mon extension&#39;&lt;/span&gt;&#xA;default_version &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;1.0&#39;&lt;/span&gt;&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;Lorsque cette extension sera installée dans la base de données, la&#xA;fonction &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;incremente()&lt;/code&gt; sera disponible.&lt;/p&gt;&#xA;&#xA;&lt;h3 id=&#34;création-de-limage&#34;&gt;Création de l’image&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;Les fichiers de l’extension seront ajoutés au &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;Pod&lt;/code&gt; PostgreSQL via le mécanisme&#xA;d’&lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;ImageVolume&lt;/code&gt; de Kubernetes. Cette fonctionnalité doit être activée sur votre&#xA;cluster. Elle est toujours en version&#xA;&lt;a href=&#34;https://kubernetes.io/blog/2025/04/29/kubernetes-v1-33-image-volume-beta/&#34;&gt;&lt;em&gt;beta&lt;/em&gt;&lt;/a&gt;&#xA;dans la version 1.33 de Kubernetes et notez que tous les &lt;em&gt;container runtime&lt;/em&gt; ne&#xA;supportent pas encore cela. Elle permet d’attacher un volume à partir du contenu&#xA;d’une image sans devoir modifier l’image principale. Ici, nous allons empaqueter&#xA;nos fichiers d’extensions.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Le &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;Dockerfile&lt;/code&gt; de notre exemple est ultra simpliste :&lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-dockerfile highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;s&#34;&gt; debian:bookworm&lt;/span&gt;&#xA;&#xA;&lt;span class=&#34;k&#34;&gt;RUN &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;mkdir&lt;/span&gt; &lt;span class=&#34;nt&#34;&gt;-p&lt;/span&gt; /share/extension&#xA;&#xA;&lt;span class=&#34;k&#34;&gt;COPY&lt;/span&gt;&lt;span class=&#34;s&#34;&gt; ./share /share/extension&lt;/span&gt;&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;L’image se repose sur &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;debian:bookworm&lt;/code&gt; et ne fait que créer un dossier&#xA;&lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;/share/extension&lt;/code&gt; en y incluant les fichiers de notre extension. Le dossier&#xA;&lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;/share/extension&lt;/code&gt; est un pré-requis que doit respecter notre image.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;La commande &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;docker build -t monextension:1.0&lt;/code&gt; permet de créer notre image&#xA;localement :&lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-bash highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;nb&#34;&gt;sudo &lt;/span&gt;docker build &lt;span class=&#34;nt&#34;&gt;-t&lt;/span&gt; monextension:1.0 &lt;span class=&#34;nb&#34;&gt;.&lt;/span&gt;              &#xA;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;+] Building 1.6s &lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;8/8&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt; FINISHED                                                                        docker:default&#xA; &lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;internal] load build definition from Dockerfile                                                              0.0s&#xA; &lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt; transferring dockerfile: 120B                                                                              0.0s&#xA; &lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;internal] load metadata &lt;span class=&#34;k&#34;&gt;for &lt;/span&gt;docker.io/library/debian:bookworm                                                1.5s&#xA; &lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;internal] load .dockerignore                                                                                 0.0s&#xA; &lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt; transferring context: 2B                                                                                   0.0s&#xA; &lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;1/3] FROM docker.io/library/debian:bookworm@sha256:731dd1380d6a8d170a695dbeb17fe0eade0e1c29f654cf0a3a07f372  0.0s&#xA; &lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;internal] load build context                                                                                 0.0s&#xA; &lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt; transferring context: 119B                                                                                 0.0s&#xA; &lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt; CACHED &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;2/3] RUN &lt;span class=&#34;nb&#34;&gt;mkdir&lt;/span&gt; &lt;span class=&#34;nt&#34;&gt;-p&lt;/span&gt; /share/extension                                                                    0.0s&#xA; &lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt; CACHED &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;3/3] COPY ./share /share/extension                                                                    0.0s&#xA; &lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt; exporting to image                                                                                            0.0s&#xA; &lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt; exporting layers                                                                                           0.0s&#xA; &lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt; writing image sha256:f267ee02248f74f371a68ebd37287f4727639342f5b4305e5d21670149195b72                      0.0s&#xA; &lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt; naming to docker.io/library/monextension:1.0                                                               0.0s&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;Il nous reste à rendre cette image disponible pour notre cluster Kubernetes.&#xA;Vous pouvez passer par une &lt;em&gt;registry&lt;/em&gt; publique. Ici, pour faire beaucoup plus&#xA;simple, et comme &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;kind&lt;/code&gt; est utilisé, nous poussons l’image sur le &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;Node&lt;/code&gt; avec :&lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-bash highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;kind load docker-image monextension:1.0&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;Maintenant que l’image est prête, voyons comment la rajouter à notre &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;Cluster&lt;/code&gt;&#xA;PostgreSQL.&lt;/p&gt;&#xA;&#xA;&lt;h3 id=&#34;définition-du-cluster&#34;&gt;Définition du &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;Cluster&lt;/code&gt;&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;La définition du &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;Cluster&lt;/code&gt; est la suivante :&lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-yaml highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;nn&#34;&gt;---&lt;/span&gt;&#xA;&lt;span class=&#34;na&#34;&gt;apiVersion&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;postgresql.cnpg.io/v1&lt;/span&gt;&#xA;&lt;span class=&#34;na&#34;&gt;kind&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;Cluster&lt;/span&gt;&#xA;&lt;span class=&#34;na&#34;&gt;metadata&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt;&#xA;  &lt;span class=&#34;na&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;postgresql&lt;/span&gt;&#xA;&lt;span class=&#34;na&#34;&gt;spec&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt;&#xA;  &lt;span class=&#34;na&#34;&gt;imageName&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;ghcr.io/cloudnative-pg/postgresql:18beta2&lt;/span&gt;&#xA;  &lt;span class=&#34;na&#34;&gt;instances&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;m&#34;&gt;1&lt;/span&gt;&#xA;  &lt;span class=&#34;na&#34;&gt;storage&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt;&#xA;    &lt;span class=&#34;na&#34;&gt;size&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;1Gi&lt;/span&gt;&#xA;  &lt;span class=&#34;na&#34;&gt;postgresql&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt;&#xA;    &lt;span class=&#34;na&#34;&gt;extensions&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt;&#xA;      &lt;span class=&#34;pi&#34;&gt;-&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;monextension&lt;/span&gt;&#xA;        &lt;span class=&#34;na&#34;&gt;image&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt;&#xA;          &lt;span class=&#34;na&#34;&gt;reference&lt;/span&gt;&lt;span class=&#34;pi&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;monextension:1.0&lt;/span&gt;&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;La fin de ce fichier nous intéresse particulièrement avec la partie&#xA;&lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;spec.postgresql.extensions&lt;/code&gt; qui liste les extensions à rajouter et les images&#xA;associées. Ici, l’extension &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;monextension&lt;/code&gt; dans sa version 1.0 va être rajoutée&#xA;en même temps que le &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;Cluster&lt;/code&gt; sera créé.&lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-bash highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;kubectl apply &lt;span class=&#34;nt&#34;&gt;-f&lt;/span&gt; cluster.yaml&#xA;cluster.postgresql.cnpg.io/postgresql created&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;À la création, trois images seront désormais récupérées : deux pour le&#xA;fonctionnement de PostgreSQL avec CloudNativePG et la troisième correspondant à&#xA;l’extension.&lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-bash highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;kubectl describe pod postgresql-1 | &lt;span class=&#34;nb&#34;&gt;grep &lt;/span&gt;image    &#xA;  Normal  Pulled     29s                kubelet            Container image &lt;span class=&#34;s2&#34;&gt;&#34;ghcr.io/cloudnative-pg/cloudnative-pg:1.27.0&#34;&lt;/span&gt; already present on machine&#xA;  Normal  Pulled     28s                kubelet            Container image &lt;span class=&#34;s2&#34;&gt;&#34;ghcr.io/cloudnative-pg/postgresql:18beta2&#34;&lt;/span&gt; already present on machine&#xA;  Normal  Pulled     28s                kubelet            Container image &lt;span class=&#34;s2&#34;&gt;&#34;monextension:1.0&#34;&lt;/span&gt; already present on machine&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;L’extension est désormais bien disponible dans notre instance :&lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-bash highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;kubectl cnpg psql postgresql            &#xA;psql &lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;18beta2 &lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;Debian 18~beta2-1.pgdg110+1&lt;span class=&#34;o&#34;&gt;))&lt;/span&gt;&#xA;Type &lt;span class=&#34;s2&#34;&gt;&#34;help&#34;&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;for &lt;/span&gt;help.&#xA;&#xA;&lt;span class=&#34;nv&#34;&gt;postgres&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# SELECT * FROM pg_available_extensions WHERE name = &#39;monextension&#39;;&lt;/span&gt;&#xA;     name     | default_version | installed_version |    comment    &#xA;&lt;span class=&#34;nt&#34;&gt;--------------&lt;/span&gt;+-----------------+-------------------+---------------&#xA; monextension | 1.0             |                   | Mon extension&#xA;&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;1 row&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;L’ordre &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;CREATE EXTENSION&lt;/code&gt; peut être passé pour l’installer et retrouver notre&#xA;fonction &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;incremente&lt;/code&gt; :&lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-sql highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;n&#34;&gt;postgres&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=#&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;CREATE&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;EXTENSION&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;monextension&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&#xA;&lt;span class=&#34;k&#34;&gt;CREATE&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;EXTENSION&lt;/span&gt;&#xA;&lt;span class=&#34;n&#34;&gt;postgres&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=#&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;incremente&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;41&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&#xA; &lt;span class=&#34;n&#34;&gt;incremente&lt;/span&gt; &#xA;&lt;span class=&#34;c1&#34;&gt;------------&lt;/span&gt;&#xA;         &lt;span class=&#34;mi&#34;&gt;42&lt;/span&gt;&#xA;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;row&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;CloudNativePG a procédé à la modification du paramètre &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;extension_control_path&lt;/code&gt;&#xA;pour que l’instance puisse trouver la nouvelle extension dans le volume qui&#xA;vient d’être monté.&lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-sql highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;n&#34;&gt;postgres&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=#&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;show&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;extension_control_path&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&#xA;         &lt;span class=&#34;n&#34;&gt;extension_control_path&lt;/span&gt;         &#xA;&lt;span class=&#34;c1&#34;&gt;----------------------------------------&lt;/span&gt;&#xA; &lt;span class=&#34;err&#34;&gt;$&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;system&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;extensions&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;monextension&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;share&lt;/span&gt;&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;Cette nouvelle fonctionnalité est très intéressante et les quelques étapes&#xA;ci-dessus montrent comment parvenir à l’exploiter. L’exemple est rudimentaire&#xA;certes, mais bien fonctionnel et permet également d’aborder certaines choses qui&#xA;fâchent 😆.&lt;/p&gt;&#xA;&#xA;&lt;h3 id=&#34;quelques-limites-tout-de-même&#34;&gt;Quelques limites tout de même&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;L’ajout d’extension de manière déclarative dans Kubernetes a des avantages.&#xA;L’avantage majeur est de ne pas devoir modifier l’image principale. Elle a également&#xA;certaines limites. Celles-ci ne discréditent pas cette nouvelle fonctionnalité,&#xA;mais il faut en avoir conscience !&lt;/p&gt;&#xA;&#xA;&lt;p&gt;La première des choses est la taille de l’image. Pour cet exemple, l’idée était&#xA;d’aller au plus simple et de ne pas trop se préoccuper de cette notion. Mais&#xA;avouez qu’utiliser une image d’environ 120 Mo pour ajouter deux fichiers de&#xA;quelques centaines octets… 🌱 écologiquement ce n’est pas terrible. Évidemment,&#xA;la clause &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;FROM&lt;/code&gt; du &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;Dockerfile&lt;/code&gt; peut être adaptée pour partir d’une image &#xA;plus légère et, soyons honnêtes il sera difficile de faire pire comme exemple&#xA;avec uniquement deux fichiers texte. À garder en tête tout de même.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Plus subtile cette fois-ci, je vous laisse essayer de rajouter une extension à&#xA;un &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;Cluster&lt;/code&gt; déjà en fonctionnement. La commande &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;kubectl apply -f cluster.yaml&lt;/code&gt;&#xA;renvoie bien le message &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;cluster.postgresql.cnpg.io/postgresql configured&lt;/code&gt;.&#xA;Notre &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;Cluster&lt;/code&gt; est donc mis à jour, l’extension est disponible. Au passage,&#xA;vous aurez remarqué que l’instance a été redémarrée 💥. Et oui, un &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;Rolling Update&lt;/code&gt;&#xA;de tous les &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;Pods&lt;/code&gt; liés au &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;Cluster&lt;/code&gt; est déclenché pour que le nouveau volume&#xA;puisse être monté sur les &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;Pods&lt;/code&gt;. C’est une petite différence avec la manière de faire sur&#xA;un environnement virtuel ou physique. Assurez-vous que l’ajout d’une extension&#xA;fonctionne bien sur un environnement de test avant de le faire en production.&lt;/p&gt;&#xA;&#xA;&lt;h3 id=&#34;conclusion&#34;&gt;Conclusion&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;Avec la dernière version de CloudNativePG, vous pouvez ajouter dynamiquement, au&#xA;démarrage des instances, de nouvelles extensions. Cette nouveauté, rendue&#xA;possible par le nouveau paramètre &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;extension_control_path&lt;/code&gt; de la version 18 de&#xA;PostgreSQL et le concept d’&lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;ImageVolume&lt;/code&gt; de Kubernetes, ravira les utilisateurs&#xA;qui n’auront pas à modifier l’image principale du conteneur.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Cette nouvelle manière de faire rendra l’usage d’instance PostgreSQL dans&#xA;Kubernetes plus flexible en ce qui concerne la gestion des extensions. Reste à&#xA;attendre que toutes fonctionnalités deviennent stables, mais l’évolution est&#xA;très intéressante ✨.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;&lt;strong&gt;Des questions, des commentaires ? &lt;a href=&#34;mailto:pierrick.chovelon@dalibo.com?subject=[Commentaire-Blog] CloudNativePG&#34;&gt;Écrivez-nous !&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;</summary>
    <author>
      <name>blog.dalibo.com</name>
    </author>
  </entry>
  <entry>
    <title>Pourquoi mettre le pg_wal sur une partition dédiée ?</title>
    <updated>2025-09-03T05:00:00Z</updated>
    <id>tag:blog.dalibo.com,2025-09-03://2025/09/03/partition-pg_wal.html</id>
    <link href="https://blog.dalibo.com//2025/09/03/partition-pg_wal.html" rel="alternate"></link>
    <summary type="html">&lt;p&gt;&lt;em&gt;Brive-la-Gaillarde, le 3 septembre 2025&lt;/em&gt;&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Il est régulièrement recommandé de mettre le répertoire &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;pg_wal&lt;/code&gt; de PostgreSQL sur &#xA;une partition dédiée, mais quelles en sont les motivations ?&lt;/p&gt;&#xA;&#xA;&lt;!--MORE--&gt;&#xA;&#xA;&lt;h3 id=&#34;pourquoi-&#34;&gt;Pourquoi ?&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;Le répertoire &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;pg_wal&lt;/code&gt; contient les journaux de transactions de l’instance,&#xA;appelés &lt;em&gt;WAL&lt;/em&gt; (&lt;em&gt;Write-Ahead-Log&lt;/em&gt;).&#xA;Ces journaux sont écrits avant d’appliquer les changements sur les données,&#xA;afin de garantir la durabilité des transactions et de permettre la récupération &#xA;en cas de problème.&#xA;Plusieurs avantages motivent la séparation du répertoire &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;pg_wal&lt;/code&gt; sur une partition &#xA;ou un disque distinct :&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;  &lt;li&gt;&#xA;    &lt;p&gt;&lt;strong&gt;Meilleure organisation et maintenance :&lt;/strong&gt; avoir son &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;pg_wal&lt;/code&gt; sur un volume &#xA;distinct facilite la gestion et évite les erreurs de manipulation. Par exemple, on réduit &#xA;le risque de supprimer accidentellement les WAL lors d’interventions sur la &#xA;partition principale de données. Il est également plus simple de superviser séparément &#xA;l’espace occupé par les données et par les journaux de transactions.&lt;/p&gt;&#xA;  &lt;/li&gt;&#xA;  &lt;li&gt;&#xA;    &lt;p&gt;&lt;strong&gt;Performances I/O améliorées :&lt;/strong&gt; les écritures de WAL sont essentiellement &#xA;séquentielles, et un disque réservé à ces journaux permet de lisser les I/O sans &#xA;interférer avec les lectures/écritures aléatoires des fichiers de données. N’espérez &#xA;cependant pas de gros gains de performances avec du matériel récent (SSD, NVMe…).&lt;/p&gt;&#xA;  &lt;/li&gt;&#xA;  &lt;li&gt;&#xA;    &lt;p&gt;&lt;strong&gt;Isolation des risques de saturation :&lt;/strong&gt; séparer &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;pg_wal&lt;/code&gt; sur une partition dédiée &#xA;limite l’impact d’une éventuelle saturation. Si la partition principale contenant &#xA;les données se remplit complètement, les nouvelles écritures de données &#xA;deviennent impossibles (erreurs « &lt;em&gt;No space left on device&lt;/em&gt; »), mais le serveur &#xA;PostgreSQL lui-même ne s’arrêtera pas tant que les WAL sont encore&#xA;accessibles en écriture. Inversement, si c’est le répertoire &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;pg_wal&lt;/code&gt; qui arrive &#xA;à saturation, PostgreSQL ne peut plus effectuer aucune écriture. Il stoppe alors immédiatement le serveur et refuse de redémarrer tant que le problème &#xA;n’est pas résolu. Il reste toujours possible de remplir le répertoire des WAL en cas de problème &#xA;(ex: archiveur défaillant, réplication en retard, etc… – voir plus loin). &#xA;L’avantage est que ces situations n’impacteront que la partition &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;pg_wal&lt;/code&gt; et seront &#xA;plus facilement identifiables et traitables sans compromettre le reste des données.&lt;/p&gt;&#xA;  &lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;p&gt;&lt;strong&gt;À noter :&lt;/strong&gt; avoir une partition dédiée pour les logs est également une bonne pratique.&lt;/p&gt;&#xA;&#xA;&lt;h3 id=&#34;comment&#34;&gt;Comment ?&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;Il faudra tout d’abord faire la demande auprès de votre administrateur système,&#xA;voici les informations nécessaires à fournir afin d’éviter toute ambiguïté :&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;  &lt;li&gt;Stockage SSD de préférence, si possible différent de celui contenant le répertoire&#xA;data, afin de profiter au maximum de la parallélisation des I/O.&lt;/li&gt;&#xA;  &lt;li&gt;Formatage &lt;a href=&#34;https://public.dalibo.com/exports/formation/manuels/formations/perf1/perf1.handout.html#syst%C3%A8me-dexploitation&#34;&gt;ext4 ou XFS&lt;/a&gt;.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;p&gt;Et enfin faire le montage et donner les permissions à l’utilisateur postgres sur&#xA;le répertoire, par exemple ici &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;/var/lib/postgresql/pg_wal/17/main/wal&lt;/code&gt;.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;La mise en place d’une partition séparée pour &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;pg_wal&lt;/code&gt; peut se faire de deux manières :&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Dès l’initialisation de l’instance, vous pouvez spécifier un emplacement différent &#xA;pour les WAL. Par exemple, la commande d’initialisation suivante crée l’instance tout &#xA;en plaçant &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;pg_wal&lt;/code&gt; à l’emplacement désiré :&lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-bash highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;sudo&lt;/span&gt; &lt;span class=&#34;nt&#34;&gt;-iu&lt;/span&gt; postgres /usr/lib/postgresql/17/bin/initdb &lt;span class=&#34;se&#34;&gt;\&lt;/span&gt;&#xA;    &lt;span class=&#34;nt&#34;&gt;--pgdata&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;/var/lib/postgresql/pgdata &lt;span class=&#34;se&#34;&gt;\&lt;/span&gt;&#xA;    &lt;span class=&#34;nt&#34;&gt;--waldir&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;/var/lib/postgresql/pg_wal/17/main/wal&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;PostgreSQL écrira alors ses journaux de transactions dans ce répertoire dédié.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Il est également possible de déplacer le &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;pg_wal&lt;/code&gt; d’une instance déjà en service, mais &#xA;cela nécessite une brève interruption. La procédure générale est :&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Arrêt de l’instance&lt;/p&gt;&#xA;&lt;div class=&#34;language-bash highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;c&#34;&gt;# Vérification du pg_wal&lt;/span&gt;&#xA;&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;ls&lt;/span&gt; /var/lib/postgresql/17/main/pg_wal/&#xA;000000010000000000000003  000000010000000000000004  000000010000000000000005  archive_status  summaries&#xA;&#xA;&lt;span class=&#34;c&#34;&gt;# Arrêt de l&#39;instance&lt;/span&gt;&#xA;&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;sudo &lt;/span&gt;systemctl stop postgresql&#xA;&#xA;&lt;span class=&#34;c&#34;&gt;# Vérification du bon arrêt de l&#39;instance&lt;/span&gt;&#xA;&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;ps &lt;span class=&#34;nt&#34;&gt;-u&lt;/span&gt; postgres &lt;span class=&#34;nt&#34;&gt;-f&lt;/span&gt; f&#xA;UID          PID    PPID  C STIME TTY      STAT   TIME CMD&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;Préparation du nouveau répertoire&lt;/p&gt;&#xA;&lt;div class=&#34;language-bash highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;c&#34;&gt;# Création du répertoire&lt;/span&gt;&#xA;&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;sudo mkdir&lt;/span&gt; &lt;span class=&#34;nt&#34;&gt;-p&lt;/span&gt; /var/lib/postgresql/pg_wal&#xA;&#xA;&lt;span class=&#34;c&#34;&gt;# Montage du répertoire pg_wal sur la partition dédiée&lt;/span&gt;&#xA;&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;sudo &lt;/span&gt;mount /dev/sdc /var/lib/postgresql/pg_wal&#xA;&#xA;&lt;span class=&#34;c&#34;&gt;# Création du sous répertoire afin d&#39;éviter de mettre les WAL à la racine du point de montage&lt;/span&gt;&#xA;&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;sudo mkdir&lt;/span&gt; &lt;span class=&#34;nt&#34;&gt;-p&lt;/span&gt; /var/lib/postgresql/pg_wal/17/main/wal&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;Déplacement de l’intégralité du répertoire &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;pg_wal&lt;/code&gt; vers la nouvelle partition&lt;/p&gt;&#xA;&lt;div class=&#34;language-bash highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;c&#34;&gt;# Copie du contenu du pg_wal vers notre pg_wal&lt;/span&gt;&#xA;&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;sudo &lt;/span&gt;rsync &lt;span class=&#34;nt&#34;&gt;-av&lt;/span&gt; /var/lib/postgresql/17/main/pg_wal/ /var/lib/postgresql/pg_wal/17/main/wal/&#xA;sending incremental file list&#xA;./&#xA;000000010000000000000003&#xA;000000010000000000000004&#xA;000000010000000000000005&#xA;archive_status/&#xA;summaries/&#xA;&#xA;sent 50,344,304 bytes  received 88 bytes  100,688,784.00 bytes/sec&#xA;total size is 50,331,648  speedup is 1.00&#xA;&#xA;&lt;span class=&#34;c&#34;&gt;# Vérification que les WAL sont tous présents&lt;/span&gt;&#xA;&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;sudo ls&lt;/span&gt; &lt;span class=&#34;nt&#34;&gt;-la&lt;/span&gt; /var/lib/postgresql/pg_wal/17/main/wal/&#xA;total 49156&#xA;drwx------ 4 postgres postgres      141 Aug 27 05:33 &lt;span class=&#34;nb&#34;&gt;.&lt;/span&gt;&#xA;drwxr-xr-x 5 postgres postgres     4096 Aug 27 05:31 ..&#xA;&lt;span class=&#34;nt&#34;&gt;-rw-------&lt;/span&gt; 1 postgres postgres 16777216 Aug 27 05:45 000000010000000000000003&#xA;&lt;span class=&#34;nt&#34;&gt;-rw-------&lt;/span&gt; 1 postgres postgres 16777216 Aug 27 05:33 000000010000000000000004&#xA;&lt;span class=&#34;nt&#34;&gt;-rw-------&lt;/span&gt; 1 postgres postgres 16777216 Aug 27 05:33 000000010000000000000005&#xA;drwx------ 2 postgres postgres        6 Aug 26 04:47 archive_status&#xA;drwx------ 2 postgres postgres        6 Aug 26 04:47 summaries&#xA;&#xA;&lt;span class=&#34;c&#34;&gt;# Renommage du répertoire pg_wal&lt;/span&gt;&#xA;&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;sudo mv&lt;/span&gt; /var/lib/postgresql/17/main/pg_wal /var/lib/postgresql/17/main/pg_wal_old&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;Création du lien symbolique et ajout des permissions&lt;/p&gt;&#xA;&lt;div class=&#34;language-bash highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;c&#34;&gt;# Création du lien symbolique reliant pg_wal vers notre pg_wal&lt;/span&gt;&#xA;&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;sudo ln&lt;/span&gt; &lt;span class=&#34;nt&#34;&gt;-s&lt;/span&gt; /var/lib/postgresql/pg_wal/17/main/wal /var/lib/postgresql/17/main/pg_wal&#xA;&#xA;&lt;span class=&#34;c&#34;&gt;# Vérification dans le pgdata que le lien symbolique a bien été créé&lt;/span&gt;&#xA;&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;ls&lt;/span&gt; &lt;span class=&#34;nt&#34;&gt;-l&lt;/span&gt; /var/lib/postgresql/17/main/ | &lt;span class=&#34;nb&#34;&gt;grep &lt;/span&gt;pg_wal&#xA;lrwxrwxrwx 1 root     root       25 Aug 27 05:54 pg_wal -&amp;gt; /var/lib/postgresql/pg_wal/17/main/wal&#xA;&#xA;&lt;span class=&#34;c&#34;&gt;# Ajout des droits à l&#39;utilisateur postgres sur le répertoire pg_wal&lt;/span&gt;&#xA;&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;sudo chown&lt;/span&gt; &lt;span class=&#34;nt&#34;&gt;-R&lt;/span&gt; postgres:postgres /var/lib/postgresql/pg_wal/17/main/wal&#xA;&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;sudo chown&lt;/span&gt; &lt;span class=&#34;nt&#34;&gt;-h&lt;/span&gt; postgres:postgres /var/lib/postgresql/17/main/pg_wal&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;Redémarrage de l’instance&lt;/p&gt;&#xA;&lt;div class=&#34;language-bash highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;c&#34;&gt;# Redémarrage de l&#39;instance&lt;/span&gt;&#xA;&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;sudo &lt;/span&gt;systemctl start postgresql&#xA;&#xA;&lt;span class=&#34;c&#34;&gt;# Vérification que les nouveaux WAL sont créés au bon endroit&lt;/span&gt;&#xA;&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;ls&lt;/span&gt; &lt;span class=&#34;nt&#34;&gt;-l&lt;/span&gt; /var/lib/postgresql/pg_wal/17/main/wal/&#xA;total 360448&#xA;&lt;span class=&#34;nt&#34;&gt;-rw-------&lt;/span&gt; 1 postgres postgres 16777216 Aug 27 05:58 000000010000000000000003&#xA;&lt;span class=&#34;nt&#34;&gt;-rw-------&lt;/span&gt; 1 postgres postgres 16777216 Aug 27 05:58 000000010000000000000004&#xA;&lt;span class=&#34;nt&#34;&gt;-rw-------&lt;/span&gt; 1 postgres postgres 16777216 Aug 27 05:59 000000010000000000000005&#xA;&lt;span class=&#34;nt&#34;&gt;-rw-------&lt;/span&gt; 1 postgres postgres 16777216 Aug 27 05:59 000000010000000000000006&#xA;&lt;span class=&#34;nt&#34;&gt;-rw-------&lt;/span&gt; 1 postgres postgres 16777216 Aug 27 05:59 000000010000000000000007&#xA;drwx------ 2 postgres postgres        6 Aug 26 04:47 archive_status&#xA;drwx------ 2 postgres postgres        6 Aug 26 04:47 summaries&#xA;&#xA;&lt;span class=&#34;c&#34;&gt;# Suppression de pg_wal_old une fois le bon fonctionnement validé&lt;/span&gt;&#xA;&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;sudo rm&lt;/span&gt; &lt;span class=&#34;nt&#34;&gt;-rf&lt;/span&gt; /var/lib/postgresql/17/main/pg_wal_old&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;&lt;strong&gt;À noter :&lt;/strong&gt; certains outils de sauvegarde ou de réplication pourraient ne pas &#xA;conserver le lien symbolique. Par exemple, un &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;pg_basebackup&lt;/code&gt; sur le primaire ne &#xA;recréera pas automatiquement le lien symbolique sur un secondaire, à moins d’utiliser &#xA;l’option &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;--waldir&lt;/code&gt; lors de la sauvegarde.&lt;/p&gt;&#xA;&#xA;&lt;h3 id=&#34;et-si-cest-trop-tard&#34;&gt;Et si c’est trop tard ?&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;Que faire si votre instance se retrouve avec le &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;pg_wal&lt;/code&gt; saturé (ou sur le point de &#xA;l’être) ? Voici deux approches envisageables pour réagir en urgence :&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;  &lt;li&gt;&#xA;    &lt;p&gt;&lt;strong&gt;Ajouter de l’espace disque :&lt;/strong&gt; la solution la plus simple et sûre est d’augmenter &#xA;la taille de la partition qui héberge actuellement &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;pg_wal&lt;/code&gt;. Si votre système de fichiers &#xA;ou votre environnement le permet, étendez la partition saturée pour redonner de la &#xA;marge à PostgreSQL.&#xA;Le serveur pourra ainsi redémarrer normalement une fois qu’il dispose à nouveau &#xA;d’espace libre, donnant le temps de traiter la cause et minimisant ainsi la coupure&#xA;de production. Cette option évite de toucher aux fichiers internes, mais n’est &#xA;pas toujours possible selon le contexte (partition non extensible, pas de stockage &#xA;additionnel disponible immédiatement, etc…).&lt;/p&gt;&#xA;  &lt;/li&gt;&#xA;  &lt;li&gt;&#xA;    &lt;p&gt;&lt;strong&gt;Déplacer le &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;pg_wal&lt;/code&gt; :&lt;/strong&gt; si vous ne pouvez pas agrandir l’espace disque existant, &#xA;il faut alors déplacer les WAL vers un emplacement plus spacieux. &#xA;La démarche est similaire à celle décrite plus haut :&lt;/p&gt;&#xA;  &lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;div class=&#34;language-bash highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;&lt;span class=&#34;c&#34;&gt;# Arrêt de l&#39;instance&lt;/span&gt;&#xA;&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;sudo &lt;/span&gt;systemctl stop postgresql&#xA;&#xA;&lt;span class=&#34;c&#34;&gt;# Création du répertoire&lt;/span&gt;&#xA;&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;sudo mkdir&lt;/span&gt; &lt;span class=&#34;nt&#34;&gt;-p&lt;/span&gt; /var/lib/postgresql/pg_wal&#xA;&#xA;&lt;span class=&#34;c&#34;&gt;# Montage du répertoire pg_wal sur la partition dédiée&lt;/span&gt;&#xA;&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;sudo &lt;/span&gt;mount /dev/sdc /var/lib/postgresql/pg_wal&#xA;&#xA;&lt;span class=&#34;c&#34;&gt;# Création du sous répertoire&lt;/span&gt;&#xA;&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;sudo mkdir&lt;/span&gt; &lt;span class=&#34;nt&#34;&gt;-p&lt;/span&gt; /var/lib/postgresql/pg_wal/17/main/wal&#xA;&#xA;&lt;span class=&#34;c&#34;&gt;# Copie du contenu du pg_wal vers notre pg_wal&lt;/span&gt;&#xA;&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;sudo &lt;/span&gt;rsync &lt;span class=&#34;nt&#34;&gt;-av&lt;/span&gt; /var/lib/postgresql/17/main/pg_wal/ /var/lib/postgresql/pg_wal/17/main/wal/&#xA;&#xA;&lt;span class=&#34;c&#34;&gt;# Renommage du répertoire pg_wal&lt;/span&gt;&#xA;&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;sudo mv&lt;/span&gt; /var/lib/postgresql/17/main/pg_wal /var/lib/postgresql/17/main/pg_wal_old&#xA;&#xA;&lt;span class=&#34;c&#34;&gt;# Création du lien symbolique reliant pg_wal vers notre pg_wal&lt;/span&gt;&#xA;&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;sudo ln&lt;/span&gt; &lt;span class=&#34;nt&#34;&gt;-s&lt;/span&gt; /var/lib/postgresql/pg_wal/17/main/wal /var/lib/postgresql/17/main/pg_wal&#xA;&#xA;&lt;span class=&#34;c&#34;&gt;# Ajout des droits à l&#39;utilisateur postgres sur le répertoire pg_wal&lt;/span&gt;&#xA;&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;sudo chown&lt;/span&gt; &lt;span class=&#34;nt&#34;&gt;-R&lt;/span&gt; postgres:postgres /var/lib/postgresql/pg_wal/17/main/wal&#xA;&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;sudo chown&lt;/span&gt; &lt;span class=&#34;nt&#34;&gt;-h&lt;/span&gt; postgres:postgres /var/lib/postgresql/17/main/pg_wal&#xA;&#xA;&lt;span class=&#34;c&#34;&gt;# Redémarrage de l&#39;instance&lt;/span&gt;&#xA;&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;sudo &lt;/span&gt;systemctl start postgresql&#xA;&#xA;&lt;span class=&#34;c&#34;&gt;# Suppression de l&#39;ancien répertoire&lt;/span&gt;&#xA;&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;sudo rm&lt;/span&gt; &lt;span class=&#34;nt&#34;&gt;-rf&lt;/span&gt; /var/lib/postgresql/17/main/pg_wal_old&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;Cette manipulation permet de relancer rapidement le service afin de traiter le &#xA;problème ensuite. Veillez à ne pas perdre de WAL en route, sous peine de compromettre &#xA;la capacité de récupération. N’oubliez pas dans tous les cas de corriger la &#xA;cause de fond de la saturation (reprise d’un archivage interrompu, nettoyage &#xA;des slots de réplication obsolètes, etc…).&#xA;Il est préférable de se préparer en amont afin d’éviter le recours à ce&#xA;genre de solutions exécutées en urgence et sous pression.&lt;/p&gt;&#xA;&#xA;&lt;h3 id=&#34;exemples-rencontrés-au-support&#34;&gt;Exemples rencontrés au support&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;Enfin, voici quelques cas réels, observés au support, car ça n’arrive pas qu’aux autres :&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;  &lt;li&gt;&lt;strong&gt;Un ordre “CREATE TABLE AS”&lt;/strong&gt; qui a généré &lt;strong&gt;330 Go&lt;/strong&gt; de WAL. L’instance a subi &#xA;&lt;strong&gt;quatre interruptions sur la journée.&lt;/strong&gt;&lt;/li&gt;&#xA;  &lt;li&gt;&lt;strong&gt;Espace insuffisant pour VACUUM FULL&lt;/strong&gt;, il faut normalement prévoir le double d’espace pris&#xA;par la table concernée. Le VACUUM FULL a saturé l’espace disque, arrêtant net&#xA;l’instance sans possibilité de la remettre en marche avant l’ajout d’espace disque&#xA;par l’administrateur système. La recherche et la suppression des “fichiers orphelins”&#xA;générés par l’arrêt brutal du VACUUM FULL sont chronophages et risquées.&lt;/li&gt;&#xA;  &lt;li&gt;&lt;strong&gt;Processus &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;archiver&lt;/code&gt; en erreur suite à une différence de version pgbackrest.&lt;/strong&gt; Une&#xA;mise à jour avait été effectuée sur le primaire, mais pas sur le serveur d’archivage,&#xA;aboutissant à une accumulation de &lt;strong&gt;100 Go&lt;/strong&gt; de WAL.&lt;/li&gt;&#xA;  &lt;li&gt;&lt;strong&gt;Suite à un VACUUM FREEZE non effectué après une grosse restauration&lt;/strong&gt;, l’autovacuum&#xA;a fini par geler de force un grand nombre de lignes, ralentissant le système, ce&#xA;qui a généré un total de &lt;strong&gt;600 Go&lt;/strong&gt; de WAL.&lt;/li&gt;&#xA;  &lt;li&gt;&lt;strong&gt;Un archivage qui a décroché suite à un retard impossible à rattraper&lt;/strong&gt;, générant&#xA;&lt;strong&gt;200 Go&lt;/strong&gt; de WAL par heure. En dernier recours, arrêt de l’archivage en passant le &#xA;paramètre &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;archive_command&lt;/code&gt; à &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;/bin/true&lt;/code&gt; alors qu’il restait 5 Go d’espace disque. &#xA;Cette manipulation entraîne obligatoirement la reconstruction du secondaire.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;p&gt;Les exemples sont nombreux, les causes diverses : de l’erreur de manipulation au&#xA;VACUUM qui rattrape un retard, en passant par le serveur d’archivage injoignable.&lt;/p&gt;&#xA;&#xA;&lt;h3 id=&#34;a-retenir&#34;&gt;A retenir&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;Placer le répertoire &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;pg_wal&lt;/code&gt; sur une partition dédiée est une bonne pratique pour la &#xA;plupart des installations : cela améliore la résilience et peut apporter un gain de &#xA;performance dans certains cas. Il convient toutefois de dimensionner &#xA;correctement toutes les partitions (données, WAL, et logs), de surveiller leur taux &#xA;d’occupation (supervision), et d’anticiper les opérations lourdes. La séparation &#xA;du &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;pg_wal&lt;/code&gt; évite bien des scénarios catastrophiques où PostgreSQL s’arrête &#xA;pour protéger l’intégrité des données. Avec une bonne architecture de stockage &#xA;et une supervision proactive, on se donne toutes les chances d’éviter ces interruptions &#xA;de service liées à l’espace disque.&lt;/p&gt;</summary>
    <author>
      <name>blog.dalibo.com</name>
    </author>
  </entry>
  <entry>
    <title>Sauvegardes personnelles avec Restic</title>
    <updated>2025-10-08T14:00:00Z</updated>
    <id>tag:fljd.in,2025-10-08:/2025/10/08/sauvegardes-personnelles-avec-restic/</id>
    <link href="https://fljd.in/2025/10/08/sauvegardes-personnelles-avec-restic/" rel="alternate"></link>
    <summary type="html">&lt;p&gt;Ces derniers temps, j’ai mis fin à une histoire d’amour avec Debian qui aura&#xA;duré près de trois ans. Pas que je n’aime plus le système, oh non, je le préfère&#xA;toujours à sa cousine Ubuntu. Mais voilà, j’ai un attachement particulier à&#xA;Archlinux depuis, wouh, au moins les bancs de l’école d’ingénieur où nous&#xA;l’installions sur des machines virtuelles et où nous nous adonnions à la&#xA;pratique du &lt;a href=&#34;https://github.com/fosslife/awesome-ricing&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;linux ricing&lt;/a&gt; pour passer le temps.&lt;/p&gt;&#xA;&lt;p&gt;Après une expérimentation de &lt;a href=&#34;https://manjaro.org/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Manjaro i3&lt;/a&gt; entre 2019 et 2022 sur mon poste&#xA;professionnel, je me suis convaincu qu’il me fallait retourner à l’essentiel. Au&#xA;début du mois de septembre, j’ai réussi le portage de ma &lt;a href=&#34;https://gitlab.com/fljdin/dotfiles/-/tree/main/sway&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;config Sway&lt;/a&gt; de&#xA;Debian Trixie vers Archlinux. L’occasion parfaite pour requestionner mes&#xA;pratiques en matière de sauvegarde de poste et de remplacer &lt;a href=&#34;https://fljd.in/2021/08/24/borg-ou-la-sauvegarde-facile/&#34;&gt;BorgBackup&lt;/a&gt; par&#xA;Restic.&lt;/p&gt;&#xA;&lt;hr&gt;&#xA;&lt;h2 id=&#34;prise-en-main-éclair&#34;&gt;Prise en main éclair&lt;/h2&gt;&#xA;&lt;p&gt;J’ai lu plusieurs articles et avis au sujet de Restic. Je l’avais vite identifié&#xA;comme un outil équivalent à BorgBackup, mais je ne m’étais pas pressé de le&#xA;tester. Quelle erreur ! J’ai été déconcerté par la facilité d’utilisation, par&#xA;son interface en ligne de commande claire et complète, et par sa&#xA;&lt;a href=&#34;https://restic.readthedocs.io/en/stable/010_introduction.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;documentation&lt;/a&gt; de qualité.&lt;/p&gt;&#xA;&lt;p&gt;Pour avoir régulièrement vécu des dégâts sur des clés de mauvaise qualité avec&#xA;ma pratique exotique sur BorgBackup, je m’étais penché sur la possibilité de&#xA;sauvegarder vers un dossier distant avec SSH. J’ai du insisté deux bonnes heures&#xA;à l’époque sans parvenir à quoique ce soit avec Borg.&lt;/p&gt;&#xA;&lt;p&gt;Avec Restic, ce n’est pas moins de 13 types différents de dépôts supportés, dont&#xA;le &lt;a href=&#34;https://restic.readthedocs.io/en/stable/030_preparing_a_new_repo.html#sftp&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;SFTP&lt;/a&gt;. Il ne m’en fallait pas plus pour tourner le dos à son homologue. La&#xA;mise en place d’un dépôt est simplifiée à l’extrême :&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-fish&#34; data-lang=&#34;fish&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;set&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;-x&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;RESTIC_REPOSITORY&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;sftp:&amp;lt;server&amp;gt;:&amp;lt;directory&amp;gt;&amp;#34;&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nf&#34;&gt;restic&lt;/span&gt; init&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nf&#34;&gt;restic&lt;/span&gt; backup ~ &lt;span class=&#34;se&#34;&gt;\&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;--dry-run&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;--exclude-file&lt;/span&gt; ~/.config/restic/excludes.txt&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Je ne suis pas en reste avec une gestion poussée des stratégies de rétention des&#xA;instantanés. Pour l’exemple, je maintiens une sauvegarde par semaine, pendant&#xA;trois mois.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-fish&#34; data-lang=&#34;fish&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nf&#34;&gt;restic&lt;/span&gt; forget &lt;span class=&#34;na&#34;&gt;--prune&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;--keep-within-weekly&lt;/span&gt; 3m&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;La technique d’exploration d’un instantané est identique à Borg, avec un montage&#xA;&lt;a href=&#34;https://www.kernel.org/doc/html/latest/filesystems/fuse.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;FUSE&lt;/a&gt; sous Linux. Une fois encore, la &lt;a href=&#34;https://restic.readthedocs.io/en/stable/050_restore.html#restore-using-mount&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;documentation&lt;/a&gt; est limpide à ce&#xA;sujet.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-fish&#34; data-lang=&#34;fish&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nf&#34;&gt;sudo&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;install&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;-o&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;$USER&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;-g&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;$USER&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;-d&lt;/span&gt; /mnt/restic&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nf&#34;&gt;restic&lt;/span&gt; mount /mnt/restic&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;planification-avec-systemd&#34;&gt;Planification avec systemd&lt;/h2&gt;&#xA;&lt;p&gt;Je me suis prêté au même jeu qu’avec BorgBackup sur ma précédente installation&#xA;Debian. En lieu et place de &lt;code&gt;cron&lt;/code&gt;, je planifie mes sauvegardes avec un &lt;em&gt;timer&lt;/em&gt;&#xA;utilisateur pour déclencher une tâche deux fois par jour sur mes journées de&#xA;travail.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-toml&#34; data-lang=&#34;toml&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c&#34;&gt;# ~/.config/systemd/user/restic.timer&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Unit&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nx&#34;&gt;Description&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Daily&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;Restic&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;backup&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nx&#34;&gt;Documentation&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;man&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;restic&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Timer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nx&#34;&gt;OnCalendar&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Mon&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;..&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Fri&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;09&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;30&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nx&#34;&gt;OnCalendar&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Mon&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;..&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Fri&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;16&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;30&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nx&#34;&gt;Persistent&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;kc&#34;&gt;true&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Install&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nx&#34;&gt;WantedBy&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;timers&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;target&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;La tâche consiste à appeler &lt;code&gt;restic&lt;/code&gt; avec mon fichier d’exclusion, suivi d’une&#xA;purge des vieux instantanés présents sur le dépôt.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-toml&#34; data-lang=&#34;toml&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c&#34;&gt;# ~/.config/systemd/user/restic.service&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Unit&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nx&#34;&gt;Description&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Restic&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;backup&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Service&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nx&#34;&gt;Type&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;oneshot&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nx&#34;&gt;ExecStart&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;restic&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;backup&lt;/span&gt; &lt;span class=&#34;err&#34;&gt;%&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;h&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;--exclude-file&lt;/span&gt; &lt;span class=&#34;err&#34;&gt;$&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;RESTIC_EXCLUDE_FILE&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nx&#34;&gt;ExecStartPost&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;restic&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;forget&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;--prune&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;--keep-within-weekly&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;m&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Pour la configuration, je déclare les variables dans un fichier d’environnement&#xA;pour que &lt;code&gt;restic&lt;/code&gt; sache identifier et déchiffrer correctement les instantanés.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-ini&#34; data-lang=&#34;ini&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# ~/.config/environment.d/restic.conf&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;na&#34;&gt;RESTIC_REPOSITORY&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;sftp:&amp;lt;server&amp;gt;:&amp;lt;directory&amp;gt;&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;na&#34;&gt;RESTIC_PASSWORD_FILE&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;$HOME/.config/restic/pass&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;na&#34;&gt;RESTIC_EXCLUDE_FILE&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;$HOME/.config/restic/excludes.txt&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Pour armer la planification, il suffit de recharger &lt;code&gt;systemd&lt;/code&gt;.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-fish&#34; data-lang=&#34;fish&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nf&#34;&gt;systemctl&lt;/span&gt; &lt;span class=&#34;na&#34;&gt;--user&lt;/span&gt; daemon-reload&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;En exportant les bonnes variables dans votre shell, la consultation des&#xA;instantanés se fait sobrement avec la commande suivante.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-fish&#34; data-lang=&#34;fish&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nf&#34;&gt;restic&lt;/span&gt; snapshots&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-console&#34; data-lang=&#34;console&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt;repository 3db74709 opened (version 2, compression level auto)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt;ID Time Host Tags Paths Size&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt;-----------------------------------------------------------------------------------&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt;f7bb4fea 2025-09-16 11:50:18 florent-dalibo /home/florent 4.309 GiB&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt;5a4dbf59 2025-09-19 09:30:01 florent-dalibo /home/florent 5.639 GiB&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt;1012f0ab 2025-09-27 19:28:38 florent-dalibo /home/florent 5.871 GiB&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt;629c2687 2025-10-03 09:30:00 florent-dalibo /home/florent 6.006 GiB&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt;98b32adb 2025-10-08 10:00:08 florent-dalibo /home/florent 4.677 GiB&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt;-----------------------------------------------------------------------------------&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt;5 snapshots&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;conclusion&#34;&gt;Conclusion&lt;/h2&gt;&#xA;&lt;p&gt;Restic est un bon outil. Tellement bon, que la communauté Gnome l’utilise à&#xA;présent comme &lt;em&gt;backend&lt;/em&gt; pour l’interface Déjà Dup dans leur dernière version&#xA;49.0 sortie le &lt;a href=&#34;https://discourse.gnome.org/t/deja-dup-49-0-released/31441&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;mois dernier&lt;/a&gt;.&lt;/p&gt;&#xA;&lt;p&gt;Pour ma part, tout se déroule bien depuis presque un mois. Il ne manque plus&#xA;qu’à sécuriser le serveur distant qui fait office de dépôt avec ses propres&#xA;sauvegardes ! Pour ce faire, j’envisage de mettre en place Restic sur la plupart&#xA;des répertoires d’importances de mon serveur multimédia, en gardant bien en&#xA;mémoire le principe 3-2-1 de la sauvegarde réussie.&lt;/p&gt;&#xA;&lt;p&gt;Prenez soin de vos sauvegardes.&lt;/p&gt;</summary>
    <author>
      <name>Florent Jardin</name>
    </author>
  </entry>
  <entry>
    <title>Le partitionnement par UUID v7</title>
    <updated>2025-06-17T08:45:00Z</updated>
    <id>tag:fljd.in,2025-06-17:/2025/06/17/le-partitionnement-par-uuid-v7/</id>
    <link href="https://fljd.in/2025/06/17/le-partitionnement-par-uuid-v7/" rel="alternate"></link>
    <summary type="html">&lt;p&gt;Au dernier PG Day 2025, j’ai pris la parole pour présenter une méthode de&#xA;conception que je juge mature et astucieuse : le partitionnement temporel&#xA;avec le type UUID et sa version 7.&lt;/p&gt;&#xA;&lt;p&gt;Le support de présentation est disponible à cette &lt;a href=&#34;https://fljd.in/documents/pgdayfr-2025-lightning-talk-partitionnement-uuidv7.pdf&#34;&gt;adresse&lt;/a&gt; et je reprendrais&#xA;dans cet article, les exemples en guise de démonstration. Je vous propose de&#xA;passer en détail ce que j’ai pu y dire, et ne pas y dire faute de temps.&#xA;Également, je vous invite à lire ou redécouvrir mes recherches sur le&#xA;&lt;a href=&#34;https://fljd.in/2021/04/23/le-partitionnement-par-hachage/&#34;&gt;partitionnement par hachage&lt;/a&gt;.&lt;/p&gt;&#xA;&lt;hr&gt;&#xA;&lt;h2 id=&#34;explorer-les-limites&#34;&gt;Explorer les limites&lt;/h2&gt;&#xA;&lt;p&gt;En première lecture de la documentation, nous pouvons prendre conscience que le&#xA;choix de la clé de partitionnement est crucial pour parvenir au meilleur&#xA;compromis stockage/performance. Parmi les contraintes qui s’imposent à nous,&#xA;l’une d’entre elles est particulièrement fondamentale :&lt;/p&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;Pour créer une contrainte d&amp;rsquo;unicité ou une clé primaire sur une table&#xA;partitionnée, la clé de partitionnement ne doit pas inclure des expressions ou&#xA;des appels de fonction, et les colonnes de la contrainte doivent inclure toutes&#xA;les colonnes de la clé de partitionnement. Cette limitation existe parce que les&#xA;index individuels créant la contrainte peuvent seulement forcer l&amp;rsquo;unicité sur&#xA;leur propre partition ; de ce fait, la structure même de la partition doit&#xA;garantir qu&amp;rsquo;il n&amp;rsquo;existe pas de duplicats dans les différentes partitions.&lt;/p&gt;&#xA;&lt;p&gt;Documentation : &lt;a href=&#34;https://www.postgresql.org/docs/current/ddl-partitioning.html#DDL-PARTITIONING-DECLARATIVE-LIMITATIONS&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://www.postgresql.org/docs/current/ddl-partitioning.html&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;&#xA;&lt;p&gt;En résumé, si nous souhaitons une contrainte de clé primaire sur notre table&#xA;partitionnée, il nous faut y inclure la colonne présente dans la clé de&#xA;partitionnement.&lt;/p&gt;&#xA;&lt;p&gt;Voyons par l’exemple l’application de cette règle. Un des nombreux cas concernés&#xA;par cette limitation est le partitionnement par date, à des fins de purges ou&#xA;d’archivage. Une contrainte de clé primaire est requise pour identifier chaque&#xA;ligne et un champ &lt;code&gt;timestamp&lt;/code&gt; est utilisé pour catégoriser les lignes selon leur&#xA;date de création.&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;https://fljd.in/img/fr/2025-06-17-partitionnement-uuidv7-01.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;CREATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;TABLE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;foo&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;bigint&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NOT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NULL&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;varchar&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;created_at&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;timestamp&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NOT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NULL&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PARTITION&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;BY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;RANGE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;created_at&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;-- CREATE TABLE&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;ALTER&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;TABLE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;foo&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;ADD&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;PRIMARY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;KEY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;-- ERROR: unique constraint on partitioned table must include all&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;-- partitioning columns&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;-- DETAIL: PRIMARY KEY constraint on table &amp;#34;foo&amp;#34; lacks column &amp;#34;created_at&amp;#34;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;-- which is part of the partition key.&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Pour respecter l’unicité entre toutes les partitions, PostgreSQL se simplifie la&#xA;tâche en renforçant la contrainte au moment de la distribution des lignes dans&#xA;les partitions. Ainsi, chaque partition dispose d’un index unique pour le&#xA;respect de la contrainte d’identité, sans se soucier d’un risque de collision&#xA;entre deux lignes de partitions différentes.&lt;/p&gt;&#xA;&lt;p&gt;Reprenons notre exemple pour y entrevoir les dérives qu’apporte ce choix de&#xA;modélisation. Ici, nous respecterons à la lettre ce que PostgreSQL nous impose,&#xA;à savoir : inclure la colonne &lt;code&gt;created_at&lt;/code&gt; dans la contrainte de clé primaire.&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;https://fljd.in/img/fr/2025-06-17-partitionnement-uuidv7-02.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;ALTER&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;TABLE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;foo&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;ADD&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;PRIMARY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;KEY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;created_at&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;-- ALTER TABLE&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CREATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;TABLE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;foo_p202506&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PARTITION&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;OF&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;foo&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FOR&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;VALUES&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;2025-06-01&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;TO&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;2025-07-01&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;-- CREATE TABLE&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CREATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;TABLE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;foo_default&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PARTITION&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;OF&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;foo&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;DEFAULT&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;-- CREATE TABLE&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Avec ce choix, il devient possible d’insérer deux valeurs &lt;code&gt;id&lt;/code&gt; identiques, pour&#xA;peu que leurs dates de création soient différentes. L’identité n’est donc plus&#xA;un simple numéro, mais un couple &lt;code&gt;id, timestamp&lt;/code&gt; à questionner systématiquement&#xA;lors d’une consultation avec la clause &lt;code&gt;WHERE&lt;/code&gt;.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;INSERT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INTO&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;foo&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;created_at&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;VALUES&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;2025-06-04&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;2024-01-01&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;-- INSERT 0 2&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tableoid&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;regclass&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;partname&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;created_at&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;foo&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;-- partname | id | created_at&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;-- -------------+----+---------------------&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;-- foo_p202506 | 1 | 2025-06-04 00:00:00&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;-- foo_default | 1 | 2024-01-01 00:00:00&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Les choses empirent lorsqu’une relation de clé étrangère s’immisce dans le&#xA;casse-tête de la modélisation. En effet, le maintien de l’identité composite&#xA;d’une ligne se révèle acrobatique, lors de la rédaction des requêtes SQL&#xA;d’insertion et de jointure.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;CREATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;TABLE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bar&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;bigint&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;PRIMARY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;KEY&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;text&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;created_at&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;timestamp&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NOT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NULL&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;foo_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;bigint&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;foo_created_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;timestamp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FOREIGN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;KEY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;foo_id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;foo_created_id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;REFERENCES&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;foo&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;created_at&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;-- CREATE TABLE&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WITH&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;foo_insert&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INSERT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INTO&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;foo&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;created_at&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;VALUES&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;foo&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;clock_timestamp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;())&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;RETURNING&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;created_at&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INSERT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INTO&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bar&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;created_at&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;foo_id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;foo_created_id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;bar&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;clock_timestamp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;created_at&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;foo_insert&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;-- INSERT 0 1&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bar&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bar&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;created_at&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;foo&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;foo&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bar&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;JOIN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;foo&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;ON&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;foo&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bar&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;foo_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AND&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;foo&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;created_at&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bar&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;foo_created_id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;-- id | created_at | data | id | name&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;-- ----+----------------------------+------+----+------&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;-- 1 | 2025-06-16 20:12:02.101194 | bar | 2 | foo&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;L’exercice devient catastrophique lorsque la seconde table requiert d’être&#xA;partitionnée à son tour, et où le risque de mauvaise rédaction des requêtes&#xA;augmente selon le degré de connaissance du modèle par les équipes de&#xA;développement. Nous retiendrons que cette pratique n’a pas cours et se conclut&#xA;fréquemment par un retour arrière.&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;https://fljd.in/img/fr/2025-06-17-partitionnement-uuidv7-03.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;&#xA;&lt;hr&gt;&#xA;&lt;h2 id=&#34;la-version-7-du-type-uuid&#34;&gt;La version 7 du type UUID&lt;/h2&gt;&#xA;&lt;p&gt;La &lt;a href=&#34;https://www.rfc-editor.org/rfc/rfc9562&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;RFC 9562&lt;/a&gt; voit le jour en mai 2024 et propose d’étendre le type de&#xA;données UUID de trois nouvelles versions (6, 7 et 8). Un UUID (ou &lt;em&gt;Universally&#xA;Unique IDentifier&lt;/em&gt;) est une donnée encodée sur 16 octets, garantissant une&#xA;unicité à travers le temps (son heure de génération) et l’espace (son serveur de&#xA;génération). Les UUID sont redoutables dans un contexte de systèmes distribués&#xA;où chaque participant peut créer de la donnée (une ligne) sans risque de collision&#xA;avec une autre donnée.&lt;/p&gt;&#xA;&lt;p&gt;La structure d’un UUID v7 se voit doté d’un &lt;em&gt;timestamp UNIX&lt;/em&gt; d’une précision à la&#xA;milliseconde, encodé dans les 48 premiers bits de sa valeur. Cette version est&#xA;un compromis entre la randomicité et la praticité. Les bénéfices vous paraîtront&#xA;limpides à l’issue de cet article.&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;https://fljd.in/img/fr/2025-06-17-partitionnement-uuidv7-04.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;La version 7 était unanimement attendue, car elle apporte une réponse bien plus&#xA;appropriée pour l’indexation dans les bases de données, offrant à la fois une&#xA;unicité et une sortabilité pour les champs. Auparavant, l’indexation sur une&#xA;donnée UUID v4 était désastreuse pour le cache et la fragmentation. Avec cet&#xA;accroissement monotone des UUID au fil du temps, la gestion interne d’un index&#xA;B-Tree se voit naturellement facilitée avec un équilibrage moins fréquent et une&#xA;prédictibilité dans ses performances.&lt;/p&gt;&#xA;&lt;p&gt;Une &lt;a href=&#34;https://dev.to/umangsinha12/postgresql-uuid-performance-benchmarking-random-v4-and-time-based-v7-uuids-n9b&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;publication récente&lt;/a&gt; annonçait des gains significatifs entre la version&#xA;4 et la version 7, sur les insertions, les consultations par index ainsi que sur&#xA;l’espace occupé par les tables et les index. De quoi se réconcilier avec le type&#xA;UUID !&lt;/p&gt;&#xA;&lt;table&gt;&#xA;&lt;thead&gt;&#xA;&lt;tr&gt;&#xA;&lt;th&gt;Metric&lt;/th&gt;&#xA;&lt;th style=&#34;text-align: right&#34;&gt;UUIDv4&lt;/th&gt;&#xA;&lt;th style=&#34;text-align: right&#34;&gt;UUIDv7&lt;/th&gt;&#xA;&lt;th style=&#34;text-align: right&#34;&gt;Improvement&lt;/th&gt;&#xA;&lt;/tr&gt;&#xA;&lt;/thead&gt;&#xA;&lt;tbody&gt;&#xA;&lt;tr&gt;&#xA;&lt;td&gt;Insert Time (10M rows)&lt;/td&gt;&#xA;&lt;td style=&#34;text-align: right&#34;&gt;5 min 35 sec&lt;/td&gt;&#xA;&lt;td style=&#34;text-align: right&#34;&gt;3 min 38 sec&lt;/td&gt;&#xA;&lt;td style=&#34;text-align: right&#34;&gt;~35% faster&lt;/td&gt;&#xA;&lt;/tr&gt;&#xA;&lt;tr&gt;&#xA;&lt;td&gt;Table Size&lt;/td&gt;&#xA;&lt;td style=&#34;text-align: right&#34;&gt;3618 MB&lt;/td&gt;&#xA;&lt;td style=&#34;text-align: right&#34;&gt;3443 MB&lt;/td&gt;&#xA;&lt;td style=&#34;text-align: right&#34;&gt;~5% smaller&lt;/td&gt;&#xA;&lt;/tr&gt;&#xA;&lt;tr&gt;&#xA;&lt;td&gt;Index Size&lt;/td&gt;&#xA;&lt;td style=&#34;text-align: right&#34;&gt;776 MB&lt;/td&gt;&#xA;&lt;td style=&#34;text-align: right&#34;&gt;602 MB&lt;/td&gt;&#xA;&lt;td style=&#34;text-align: right&#34;&gt;~22% smaller&lt;/td&gt;&#xA;&lt;/tr&gt;&#xA;&lt;tr&gt;&#xA;&lt;td&gt;Point Lookup Latency&lt;/td&gt;&#xA;&lt;td style=&#34;text-align: right&#34;&gt;0.167 ms&lt;/td&gt;&#xA;&lt;td style=&#34;text-align: right&#34;&gt;0.038 ms&lt;/td&gt;&#xA;&lt;td style=&#34;text-align: right&#34;&gt;~4x faster&lt;/td&gt;&#xA;&lt;/tr&gt;&#xA;&lt;tr&gt;&#xA;&lt;td&gt;Range Scan Latency&lt;/td&gt;&#xA;&lt;td style=&#34;text-align: right&#34;&gt;8.284 ms&lt;/td&gt;&#xA;&lt;td style=&#34;text-align: right&#34;&gt;3.791 ms&lt;/td&gt;&#xA;&lt;td style=&#34;text-align: right&#34;&gt;~2x faster&lt;/td&gt;&#xA;&lt;/tr&gt;&#xA;&lt;/tbody&gt;&#xA;&lt;/table&gt;&#xA;&lt;p&gt;La communauté de développement de PostgreSQL a suivi l’actualité de cette RFC,&#xA;en proposant un &lt;a href=&#34;https://www.postgresql.org/message-id/CAAhFRxitJv=yoGnXUgeLB_O&amp;#43;M7J2BJAmb5jqAT9gZ3bij3uLDA@mail.gmail.com&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;premier patch&lt;/a&gt; en février 2023 alors que le brouillon de&#xA;l’&lt;em&gt;Internet Engineering Task Force&lt;/em&gt; (IETF) venait d’être publié. C’est lors du&#xA;&lt;a href=&#34;https://commitfest.postgresql.org/patch/4388/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;CommitFest&lt;/a&gt; de janvier 2025 que le sujet est clôturé avec l’ajout dans le&#xA;commit &lt;a href=&#34;https://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=78c5e141e9c139fc2ff36a220334e4aa25e1b0eb&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;78c5e14&lt;/a&gt; de deux méthodes pour la version 18, annoncée à l’automne&#xA;prochain.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-text&#34; data-lang=&#34;text&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;author Masahiko Sawada &amp;lt;msawada@postgresql.org&amp;gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; Wed, 11 Dec 2024 23:54:41 +0000 (15:54 -0800)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;committer Masahiko Sawada &amp;lt;msawada@postgresql.org&amp;gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; Wed, 11 Dec 2024 23:54:41 +0000 (15:54 -0800)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;Add UUID version 7 generation function.&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;This commit introduces the uuidv7() SQL function, which generates UUID&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;version 7 as specified in RFC 9652. UUIDv7 combines a Unix timestamp&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;in milliseconds and random bits, offering both uniqueness and&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;sortability.&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;This commit also expands the uuid_extract_timestamp() function to&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;support UUID version 7.&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;Additionally, an alias uuidv4() is added for the existing&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;gen_random_uuid() SQL function to maintain consistency.&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Vous me voyez venir ? À l’aide de cette nouvelle RFC, il devient possible de&#xA;disposer d’une colonne d’identité contenant une valeur temporelle et qui devient&#xA;&lt;em&gt;de facto&lt;/em&gt;, une candidate idéale pour la clé de partitionnement. Le tout sans&#xA;surcoût pour le stockage, car chaque champ UUID consommera 16 octets, autant&#xA;qu’un &lt;code&gt;bigint&lt;/code&gt; (8 octets) et un &lt;code&gt;timestamp&lt;/code&gt; (8 octets) réunis !&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;https://fljd.in/img/fr/2025-06-partitionnement-uuidv7-05.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;&#xA;&lt;hr&gt;&#xA;&lt;h2 id=&#34;partitionner-par-uuid-v7&#34;&gt;Partitionner par UUID v7&lt;/h2&gt;&#xA;&lt;p&gt;L’idée originale me vient d’un &lt;a href=&#34;https://postgresql.verite.pro/blog/2024/07/15/uuid-v7-pure-sql.html#partitioning-by-uuid-v7&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;article&lt;/a&gt; de Daniel Vérité, lu l’été dernier,&#xA;alors même que la RFC venait de sortir, mais que le patch dans PostgreSQL était&#xA;bloqué par la période de gel avant la sortie de la version 17. Il était question&#xA;de pouvoir implémenter ses propres méthodes en PL/pgSQL sur les versions en&#xA;vigueur, sans attendre la version 18.&lt;/p&gt;&#xA;&lt;p&gt;La création de la table &lt;code&gt;foo&lt;/code&gt; se réalise ainsi :&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;CREATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;TABLE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;foo&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;uuid&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;PRIMARY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;KEY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;DEFAULT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;uuidv7&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;varchar&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PARTITION&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;BY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;RANGE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;-- CREATE TABLE&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CREATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;TABLE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;foo_p202506&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PARTITION&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;OF&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;foo&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FOR&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;VALUES&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;uuidv7_boundary&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;2025-06-01&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;TO&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;uuidv7_boundary&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;2025-07-01&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;-- CREATE TABLE&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CREATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;TABLE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;foo_default&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PARTITION&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;OF&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;foo&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;DEFAULT&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;-- CREATE TABLE&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;La méthode &lt;code&gt;uuidv7_boundary&lt;/code&gt; est inédite et n’a pas d’équivalent dans les&#xA;versions à venir de PostgreSQL, bien qu’elle mériterait amplement sa place. Sa&#xA;définition est disponible sur le dépôt &lt;a href=&#34;https://github.com/dverite/postgres-uuidv7-sql/blob/main/sql/uuidv7-sql--1.0.sql#L63&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;dverite/postgres-uuidv7-sql&lt;/a&gt;.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;CREATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FUNCTION&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;uuidv7_boundary&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;timestamptz&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;RETURNS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;uuid&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;$$&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/* uuid fields: version=0b0111, variant=0b10 */&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;select&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;encode&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;overlay&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;\x00000000000070008000000000000000&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bytea&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;placing&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;substring&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;int8send&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;floor&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;extract&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;epoch&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;from&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;$&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1000&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;bigint&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;from&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;from&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;6&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;hex&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;uuid&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;$$&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;LANGUAGE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;sql&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;stable&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;strict&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;parallel&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;safe&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Grâce à cette fonction, il est possible d’obtenir les bornes d’une partition en&#xA;ne conservant que la donnée temporelle d’un UUID et en remplissant le reste par&#xA;des zéros (et quelques bits fixes). Pour la table &lt;code&gt;foo&lt;/code&gt;, on se retrouve dès lors&#xA;avec la partition qui respecte les valeurs comprises entre juin et juillet.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-text&#34; data-lang=&#34;text&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; Partitioned table &amp;#34;public.foo&amp;#34;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; Column | Type | Collation | Nullable | Default&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;--------+-------------------+-----------+----------+----------&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; id | uuid | | not null | uuidv7()&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; name | character varying | | |&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;Partition key: RANGE (id)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;Indexes:&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; &amp;#34;foo_pkey&amp;#34; PRIMARY KEY, btree (id)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;Partitions: foo_p202506 FOR VALUES&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; FROM (&amp;#39;0197285b-e300-7000-8000-000000000000&amp;#39;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; TO (&amp;#39;0197c2da-ab00-7000-8000-000000000000&amp;#39;),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; foo_default DEFAULT&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;INSERT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INTO&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;foo&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;VALUES&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;foo&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;-- INSERT 0 1&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tableoid&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;regclass&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;partname&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;uuid_extract_timestamp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;created_at&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;foo&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;\&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;gx&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;-- -[ RECORD 1 ]------------------------------------&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;-- partname | foo_p202506&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;-- id | 01977a44-364a-752a-b62e-c026ac2f930d&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;-- name | foo&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;-- created_at | 2025-06-16 21:43:00.17+02&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;hr&gt;&#xA;&lt;h2 id=&#34;une-pratique-en-bonne-voie&#34;&gt;Une pratique en bonne voie&lt;/h2&gt;&#xA;&lt;p&gt;Au cours de ma prise de parole, le temps m’avait manqué pour conclure. Les&#xA;adeptes de l’extension &lt;a href=&#34;https://github.com/pgpartman/pg_partman&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;pg_partman&lt;/a&gt; ne seront pas complètement réjouis&#xA;d’apprendre que le support du partitionnement automatique pour une colonne de&#xA;type UUID est partiellement implémenté.&lt;/p&gt;&#xA;&lt;p&gt;La gestion de types &lt;code&gt;text&lt;/code&gt; et &lt;code&gt;uuid&lt;/code&gt; a été &lt;a href=&#34;https://github.com/pgpartman/pg_partman/pull/683&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;apportée&lt;/a&gt; en novembre 2024,&#xA;permettant ce genre de magie pour provisionner un certain nombre de partitions.&#xA;Les fonctions &lt;code&gt;partman.uuid7_time_encoder&lt;/code&gt; et &lt;code&gt;partman.uuid7_time_decoder&lt;/code&gt; sont&#xA;équivalentes respectivement aux fonctions précédentes &lt;code&gt;uuidv7_boundary&lt;/code&gt; et&#xA;&lt;code&gt;uuid_extract_timestamp&lt;/code&gt;.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;CREATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;TABLE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;foo&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;uuid&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;PRIMARY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;KEY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;DEFAULT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;uuidv7&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;varchar&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PARTITION&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;BY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;RANGE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;-- CREATE TABLE&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;partman&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;create_parent&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_parent_table&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;public.foo&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_control&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;id&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_interval&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;1 month&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_time_encoder&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;partman.uuid7_time_encoder&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_time_decoder&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;partman.uuid7_time_decoder&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;-- create_parent&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;-- ---------------&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;-- t&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Cependant, le déplacement automatique des lignes de la partition &lt;code&gt;default&lt;/code&gt; vers&#xA;une autre au cours de la maintenance par &lt;code&gt;partition_data_time()&lt;/code&gt; provoque encore&#xA;une erreur à l’heure de la rédaction de cet article. La &lt;a href=&#34;https://github.com/pgpartman/pg_partman/pull/730&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;PR 739&lt;/a&gt;, proposée&#xA;en janvier dernier, tente de corriger en grande partie les angles morts des&#xA;travaux engagés.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;partman&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;partition_data_time&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_parent_table&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;public.foo&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;-- ERROR: Cannot run on partition set without time&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;-- based control column or epoch flag set with&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;-- an id column. Found control: uuid, epoch: none&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;-- CONTEXT: PL/pgSQL function partman.partition_data_time()&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;-- line 63 at RAISE&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;hr&gt;&#xA;&lt;h2 id=&#34;le-mot-de-la-fin&#34;&gt;Le mot de la fin&lt;/h2&gt;&#xA;&lt;p&gt;Les articles que j’ai énoncés précédemment me conforte dans l’idée que le type&#xA;UUID dans sa version 7 est une belle opportunité pour l’adoption de PostgreSQL,&#xA;notamment pour ce cas d’usage du partitionnement par date.&lt;/p&gt;&#xA;&lt;p&gt;L’accueil que cette rapide présentation a reçu m’a fait également l’effet d’un&#xA;appel d’air par l’audience, voyant dans l’UUID un moyen de pousser les limites&#xA;du moteur de base de données relationnel et open-source le plus avancé au monde.&lt;/p&gt;</summary>
    <author>
      <name>Florent Jardin</name>
    </author>
  </entry>
  <entry>
    <title>Substituer une variable dans un script SQL</title>
    <updated>2024-11-25T08:00:00Z</updated>
    <id>tag:fljd.in,2024-11-25:/2024/11/25/substituer-une-variable-dans-un-script-sql/</id>
    <link href="https://fljd.in/2024/11/25/substituer-une-variable-dans-un-script-sql/" rel="alternate"></link>
    <summary type="html">&lt;p&gt;Il est fréquent de vouloir automatiser une tâche répétitive en la scriptant&#xA;rapidement, puis à force d&amp;rsquo;itérations, de l&amp;rsquo;enrichir, voire de l&amp;rsquo;intégrer dans&#xA;la base de code d&amp;rsquo;un projet. À ce jeu, les outils comme SQL*Plus et psql peuvent&#xA;être de puissants alliés et des interpréteurs aussi pertinents que Bash ou&#xA;Python.&lt;/p&gt;&#xA;&lt;p&gt;Dans le cadre des projets de migration que je mène régulièrement, il m&amp;rsquo;arrive de&#xA;tomber sur ces scripts, en grand nombre. Certains ont la particularité de&#xA;proposer des paramètres d&amp;rsquo;entrée, traités par SQL*Plus avec le mécanisme très&#xA;confortable de substitution de variables. Dans cet article, je partage quelques&#xA;astuces pour convertir certains aspects de ces scripts grâce aux fonctionnalités&#xA;équivalentes que l&amp;rsquo;on retrouve sur l&amp;rsquo;outil psql de PostgreSQL.&lt;/p&gt;&#xA;&lt;hr&gt;&#xA;&lt;h2 id=&#34;substituer-une-variable&#34;&gt;Substituer une variable&amp;hellip;&lt;/h2&gt;&#xA;&lt;p&gt;Comme point de départ, penchons-nous sur la syntaxe supportée par l&amp;rsquo;outil&#xA;d&amp;rsquo;Oracle avec un exemple fil rouge. Nous incarnons un utilisateur qui souhaite&#xA;obtenir le résultat des ventes d&amp;rsquo;une société factice, en appliquant deux filtres&#xA;basés sur un numéro produit et deux dates passées en paramètres.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;-- sqlplus-report-01.sql&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CONNECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;user&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;password&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;@&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;database&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;DEF&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;amp;1&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;DEF&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;start_date&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;amp;2&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;DEF&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;end_date&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;amp;3&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;NVL&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SUM&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;amount&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;total_amount&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;orders&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;JOIN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;products&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;USING&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AND&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;order_date&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;BETWEEN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TO_DATE&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;amp;start_date&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;YYYY-MM-DD&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AND&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TO_DATE&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;amp;end_date&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;YYYY-MM-DD&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;QUIT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-console&#34; data-lang=&#34;console&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;gp&#34;&gt;$&lt;/span&gt; sqlplus -S /nolog @sqlplus-report-01.sql &lt;span class=&#34;m&#34;&gt;20&lt;/span&gt; 2024-11-01 2024-11-30&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt;old 3: WHERE product_id = &amp;amp;product_id&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt;new 3: WHERE product_id = 20&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt;old 4: AND order_date BETWEEN TO_DATE(&amp;#39;&amp;amp;start_date&amp;#39;, &amp;#39;YYYY-MM-DD&amp;#39;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt;new 4: AND order_date BETWEEN TO_DATE(&amp;#39;2024-11-01&amp;#39;, &amp;#39;YYYY-MM-DD&amp;#39;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt;old 5: AND TO_DATE(&amp;#39;&amp;amp;end_date&amp;#39;, &amp;#39;YYYY-MM-DD&amp;#39;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt;new 5: AND TO_DATE(&amp;#39;2024-11-30&amp;#39;, &amp;#39;YYYY-MM-DD&amp;#39;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt;&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;err&#34;&gt;&lt;/span&gt;&lt;span class=&#34;go&#34;&gt;TOTAL_AMOUNT&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt;------------&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt; 1378.98&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Comme nous pouvons l&amp;rsquo;observer, la substitution s&amp;rsquo;opère en SQL*Plus dès que le&#xA;caractère &lt;code&gt;&amp;amp;&lt;/code&gt; est rencontré, que son contenu soit ou non entouré de guillemets&#xA;simples. En début de script, j&amp;rsquo;ai appliqué une stratégie simple en définissant&#xA;une variable avec un nom évocateur, pour faciliter la lisibilité et la&#xA;maintenance du script et ne plus s&amp;rsquo;accommoder des variables nommées selon leur&#xA;position dans la liste des arguments.&lt;/p&gt;&#xA;&lt;hr&gt;&#xA;&lt;p&gt;Pour obtenir un résultat équivalent avec psql, nous devons effectuer une&#xA;&lt;a href=&#34;https://psql-tips.org/psql_tips_all.html#tip037&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;assignation&lt;/a&gt; de variables en dehors du script, avec l&amp;rsquo;option &lt;code&gt;-v&lt;/code&gt; ou &lt;code&gt;--set&lt;/code&gt;&#xA;fournie par psql. Ces variables seront alors substituées dans le script à l&amp;rsquo;aide&#xA;du mécanisme d&amp;rsquo;&lt;a href=&#34;https://www.postgresql.org/docs/current/app-psql.html#APP-PSQL-INTERPOLATION&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;interpolation&lt;/a&gt;.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;-- psql-report-01.sql&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;\&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pset&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;footer&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;off&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;COALESCE&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SUM&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;amount&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;total_amount&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;orders&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;JOIN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;products&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;USING&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AND&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;order_date&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;BETWEEN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;start_date&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;date&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AND&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;end_date&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;date&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-console&#34; data-lang=&#34;console&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;gp&#34;&gt;$&lt;/span&gt; psql -f psql-report-01.sql &lt;span class=&#34;se&#34;&gt;\&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;&lt;span class=&#34;gp&#34;&gt;$&lt;/span&gt; -v &lt;span class=&#34;nv&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;20&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;&lt;span class=&#34;gp&#34;&gt;$&lt;/span&gt; -v &lt;span class=&#34;nv&#34;&gt;start_date&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;2024-11-01&amp;#39;&lt;/span&gt; -v &lt;span class=&#34;nv&#34;&gt;end_date&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;2024-11-30&amp;#39;&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt; total_amount&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt;--------------&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt; 1378.98&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;La reprise du script original est tout à fait triviale, on y retrouve une&#xA;syntaxe similaire avec le caractère &lt;code&gt;:&lt;/code&gt; en lieu et place de &lt;code&gt;&amp;amp;&lt;/code&gt;. Toutefois, si&#xA;la variable doit être comprise entre deux guillemets simples, nous constatons&#xA;que le caractère &lt;code&gt;:&lt;/code&gt; doit être saisi à l&amp;rsquo;extérieur et non à l&amp;rsquo;intérieur.&lt;/p&gt;&#xA;&lt;hr&gt;&#xA;&lt;h2 id=&#34;-dans-un-bloc-anonyme&#34;&gt;&amp;hellip; dans un bloc anonyme&lt;/h2&gt;&#xA;&lt;p&gt;Les choses se gâtent lorsque le script devient plus complexe, et nécessite de&#xA;manipuler nos précédentes variables dans un bloc anonyme PL/SQL. Reprenons notre&#xA;script pour l&amp;rsquo;enrichir d&amp;rsquo;un message personnalisé si le produit demandé n&amp;rsquo;existe&#xA;pas. Une première lecture sur la table &lt;code&gt;products&lt;/code&gt; peut, éventuellement,&#xA;retourner l&amp;rsquo;exception &lt;code&gt;NO_DATA_FOUND&lt;/code&gt; que nous souhaitons intercepter.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;-- sqlplus-report-02.sql&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CONNECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;user&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;password&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;@&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;database&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;DEF&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;amp;1&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;DEF&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;start_date&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;amp;2&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;DEF&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;end_date&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;amp;3&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SET&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;serveroutput&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;ON&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SET&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;feedback&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;OFF&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SET&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;verify&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;OFF&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;DECLARE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;products&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;%&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;TYPE&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_sum&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;NUMBER&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_start&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;DATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TO_DATE&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;amp;start_date&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;YYYY-MM-DD&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_end&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;DATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TO_DATE&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;amp;end_date&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;YYYY-MM-DD&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;BEGIN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INTO&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;products&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;NVL&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SUM&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;amount&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INTO&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_sum&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;orders&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AND&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;order_date&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;BETWEEN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_start&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AND&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_end&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;DBMS_OUTPUT&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PUT_LINE&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;Total amount: &amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;||&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_sum&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;EXCEPTION&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WHEN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;NO_DATA_FOUND&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;THEN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;DBMS_OUTPUT&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PUT_LINE&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;Product &amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;||&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;||&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39; does not exist&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;END&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;QUIT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-console&#34; data-lang=&#34;console&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;gp&#34;&gt;$&lt;/span&gt; sqlplus -S /nolog @sqlplus-report-02.sql &lt;span class=&#34;m&#34;&gt;120&lt;/span&gt; 2024-11-01 2024-11-30&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt;Product 120 does not exist&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;hr&gt;&#xA;&lt;p&gt;Du côté de notre alternative PostgreSQL et son invite de commande psql, il&#xA;apparaît qu&amp;rsquo;un bloc anonyme en PL/pgSQL ne permet pas de réaliser la&#xA;substitution comme nous le souhaitons. Si nous tentons de réaliser un contrôle&#xA;avec le renvoi d&amp;rsquo;une exception, nous obtenons une erreur de syntaxe, car la&#xA;variable n&amp;rsquo;est pas substituée.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;-- psql-report-02-wrong.sql&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;DO&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;$$&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;DECLARE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;products&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;%&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;TYPE&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_sum&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;numeric&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_start&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;date&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;start_date&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;date&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_end&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;date&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;end_date&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;date&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;BEGIN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INTO&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;STRICT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;products&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;COALESCE&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SUM&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;amount&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INTO&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_sum&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;orders&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AND&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;order_date&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;BETWEEN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_start&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AND&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_end&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;RAISE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;NOTICE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;Total amount: %&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_sum&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;EXCEPTION&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WHEN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;no_data_found&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;THEN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;RAISE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;NOTICE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;Product % does not exist&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;END&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;$$&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-console&#34; data-lang=&#34;console&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;gp&#34;&gt;$&lt;/span&gt; psql -f psql-report-02-wrong.sql &lt;span class=&#34;se&#34;&gt;\&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;&lt;span class=&#34;gp&#34;&gt;$&lt;/span&gt; -v &lt;span class=&#34;nv&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;120&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;&lt;span class=&#34;gp&#34;&gt;$&lt;/span&gt; -v &lt;span class=&#34;nv&#34;&gt;start_date&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;2024-11-01&amp;#39;&lt;/span&gt; -v &lt;span class=&#34;nv&#34;&gt;end_date&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;2024-11-30&amp;#39;&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt;psql:psql-report-02-wrong.sql:25: ERROR: syntax error at or near &amp;#34;:&amp;#34;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt;LINE 5: p_start date := :&amp;#39;start_date&amp;#39;::date;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt; ^&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Fort heureusement, psql ne nous laisse pas sans ressource. Les méta-commandes&#xA;qu&amp;rsquo;il propose peuvent nous permettre d&amp;rsquo;obtenir le même résultat, moyennant une&#xA;réécriture plus profonde du script. Nous allons utiliser la méta-commande&#xA;&lt;code&gt;\gset&lt;/code&gt; pour stocker l&amp;rsquo;état du produit puis la méta-commande &lt;code&gt;\if&lt;/code&gt; pour réaliser&#xA;le contrôle.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;-- psql-report-02.sql&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;\&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pset&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;footer&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;off&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NOT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;EXISTS&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;products&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unknown_product&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;\&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;gset&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;\&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unknown_product&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;\&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;echo&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;Product&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;does not exist&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;\&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;quit&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;\&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;endif&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;COALESCE&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SUM&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;amount&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;total_amount&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;orders&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;JOIN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;products&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;USING&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AND&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;order_date&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;BETWEEN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;start_date&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;date&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AND&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;end_date&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;date&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-console&#34; data-lang=&#34;console&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;gp&#34;&gt;$&lt;/span&gt; psql -f report.sql &lt;span class=&#34;se&#34;&gt;\&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;&lt;span class=&#34;gp&#34;&gt;$&lt;/span&gt; -v &lt;span class=&#34;nv&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;120&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;&lt;span class=&#34;gp&#34;&gt;$&lt;/span&gt; -v &lt;span class=&#34;nv&#34;&gt;start_date&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;2024-11-01&amp;#39;&lt;/span&gt; -v &lt;span class=&#34;nv&#34;&gt;end_date&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;2024-11-30&amp;#39;&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt;Product 120 does not exist&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;hr&gt;&#xA;&lt;h2 id=&#34;-à-tout-prix&#34;&gt;&amp;hellip; à tout prix&lt;/h2&gt;&#xA;&lt;p&gt;Il est probable que les méta-commandes de psql ne viennent pas à bout de toutes&#xA;les ingéniosités (et aberrations) que peuvent réserver les scripts compatibles&#xA;avec SQL*Plus. Progressons encore avec une évolution plus complexe de notre&#xA;exemple.&lt;/p&gt;&#xA;&lt;p&gt;Notre utilisateur souhaite à présent obtenir un score de performance pour la&#xA;période de vente de son produit, en comparant avec la période précédente. Nous&#xA;aurions besoin ici d&amp;rsquo;un curseur pour réutiliser plusieurs fois la même requête&#xA;de calcul des ventes ainsi que d&amp;rsquo;une fonction pour calculer le score de&#xA;performance en gérant correctement la division possible par zéro.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;-- sqlplus-report-03.sql&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CONNECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;user&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;password&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;@&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;database&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;DEF&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;amp;1&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;DEF&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;start_date&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;amp;2&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;DEF&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;end_date&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;amp;3&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SET&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;serveroutput&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;ON&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SET&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;feedback&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;OFF&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SET&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;verify&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;OFF&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;DECLARE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;products&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;%&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;TYPE&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_sum&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;NUMBER&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_prev_sum&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;NUMBER&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_start&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;DATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TO_DATE&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;amp;start_date&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;YYYY-MM-DD&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_end&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;DATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TO_DATE&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;amp;end_date&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;YYYY-MM-DD&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_prev_start&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;DATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_start&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_end&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_start&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_prev_end&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;DATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_start&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CURSOR&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c_orders&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;v_start&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;DATE&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;v_end&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;DATE&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;IS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SUM&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;amount&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;total_amount&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;orders&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AND&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;order_date&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;BETWEEN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;v_start&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AND&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;v_end&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FUNCTION&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;score&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_sum&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;NUMBER&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_prev_sum&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;NUMBER&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;RETURN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;NUMBER&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;IS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;v_score&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;NUMBER&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;BEGIN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;RETURN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ROUND&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_sum&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_prev_sum&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_prev_sum&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;100&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;EXCEPTION&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WHEN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ZERO_DIVIDE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;THEN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;RETURN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NULL&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;END&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;BEGIN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INTO&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;products&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;OPEN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c_orders&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_start&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_end&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FETCH&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c_orders&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INTO&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_sum&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CLOSE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c_orders&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;OPEN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c_orders&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_prev_start&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_prev_end&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FETCH&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c_orders&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INTO&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_prev_sum&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CLOSE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c_orders&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;DBMS_OUTPUT&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PUT_LINE&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;Total amount: &amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;||&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_sum&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;DBMS_OUTPUT&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PUT_LINE&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;Performance score: &amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;||&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;score&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_sum&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_prev_sum&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;EXCEPTION&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WHEN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;NO_DATA_FOUND&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;THEN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;DBMS_OUTPUT&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PUT_LINE&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;Product &amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;||&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;||&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39; does not exist&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;END&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;QUIT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-console&#34; data-lang=&#34;console&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;gp&#34;&gt;$&lt;/span&gt; sqlplus -S /nolog @sqlplus-report-03.sql &lt;span class=&#34;m&#34;&gt;20&lt;/span&gt; 2024-11-01 2024-11-30&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt;Total amount: 1378.98&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt;Performance score: 162.99&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Bien que l&amp;rsquo;exemple soit volontairement simpliste et qu&amp;rsquo;il puisse faire appel à&#xA;une &lt;a href=&#34;https://fljd.in/2023/02/10/le-fenetrage-a-la-rescousse/&#34;&gt;fonction de fenêtrage&lt;/a&gt;, nous allons jouer le jeu de la conversion du&#xA;script au plus proche de sa syntaxe originale. Pour cela, identifions les&#xA;faiblesses du PL/pgSQL.&lt;/p&gt;&#xA;&lt;hr&gt;&#xA;&lt;p&gt;&lt;strong&gt;Les routines éphémères ne sont pas prises en charge&lt;/strong&gt;&lt;/p&gt;&#xA;&lt;p&gt;Le langage PL/pgSQL n&amp;rsquo;autorise pas la déclaration de fonctions ou de procédures&#xA;stockées dont la portée serait exclusive au contexte d&amp;rsquo;exécution. La seule&#xA;alternative est de définir globalement la routine, afin qu&amp;rsquo;elle soit connue de&#xA;l&amp;rsquo;analyseur syntaxique et exécutée correctement. Dans le cas présent, je ne&#xA;souhaite pas que la fonction persiste après l&amp;rsquo;appel de mon script. Qu&amp;rsquo;à cela ne&#xA;tienne, nous pouvons créer une fonction temporaire dans le schéma &lt;code&gt;pg_temp&lt;/code&gt; !&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;-- temp-function.sql&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;DO&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;$$&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;BEGIN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CREATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FUNCTION&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pg_temp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;score&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_sum&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;numeric&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_prev_sum&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;numeric&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;RETURNS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;numeric&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;LANGUAGE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;plpgsql&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;$&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;func$&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;BEGIN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;RETURN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ROUND&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_sum&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_prev_sum&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_prev_sum&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;100&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;EXCEPTION&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WHEN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;division_by_zero&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;THEN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;RETURN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NULL&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;END&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;$&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;func$&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;RAISE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;NOTICE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;Score: %&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pg_temp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;score&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;100&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;50&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;RAISE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;NOTICE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;Score: %&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pg_temp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;score&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;100&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;END&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;$$&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-console&#34; data-lang=&#34;console&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;gp&#34;&gt;$&lt;/span&gt; psql -f temp-function.sql&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt;psql:temp-function.sql:16: NOTICE: Score: 100.00&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt;psql:temp-function.sql:16: NOTICE: Score: &amp;lt;NULL&amp;gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt;DO&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;La fonction &lt;code&gt;pg_temp.score(numeric, numeric)&lt;/code&gt; est dès lors accessible dans le&#xA;reste de notre bloc anonyme, et ce, uniquement pour la durée de la session. La&#xA;gestion des exceptions est conforme au besoin, il a suffit de remplacer&#xA;&lt;code&gt;ZERO_DIVIDE&lt;/code&gt; par &lt;code&gt;division_by_zero&lt;/code&gt; comme le stipule la &lt;a href=&#34;https://www.postgresql.org/docs/current/errcodes-appendix.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;documentation&lt;/a&gt;.&lt;/p&gt;&#xA;&lt;p&gt;&lt;strong&gt;La substitution ne s&amp;rsquo;applique pas dans un bloc anonyme&lt;/strong&gt;&lt;/p&gt;&#xA;&lt;p&gt;Comme nous l&amp;rsquo;avons vu précédemment, la substitution n&amp;rsquo;intervient pas lorsque&#xA;nous nous trouvons dans un bloc de code PL/pgSQL. Pour contourner cette&#xA;limitation, nous allons devoir utiliser les &lt;a href=&#34;https://www.postgresql.org/docs/current/runtime-config-custom.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;variables de session&#xA;personnalisées&lt;/a&gt; mises à disposition pour l&amp;rsquo;écosystème d&amp;rsquo;extensions avec&#xA;PostgreSQL.&lt;/p&gt;&#xA;&lt;p&gt;Ces variables peuvent être manipulées aussi bien en psql avec le mot-clé &lt;code&gt;SET&lt;/code&gt;&#xA;qu&amp;rsquo;en SQL ou en PL/pgSQL avec les fonctions &lt;a href=&#34;https://pgpedia.info/c/current_setting.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;current_setting&lt;/code&gt;&lt;/a&gt; et&#xA;&lt;a href=&#34;https://pgpedia.info/s/set_config.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;set_config&lt;/code&gt;&lt;/a&gt;. La seule contrainte consiste à leur définir un préfixe qui&#xA;n&amp;rsquo;entre pas en conflit avec celui d&amp;rsquo;autres variables déjà déclarées dans notre&#xA;instance.&lt;/p&gt;&#xA;&lt;p&gt;Pour revenir à notre exercice de conversion, cela signifie que nos paramètres&#xA;de script peuvent être montés en variables de session dans les toutes premières&#xA;instructions. Dès que nous sommes dans un bloc anonyme, il convient alors de les&#xA;rappeler dans des variables classiques comme le montre le code suivant :&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;SET&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;my&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SET&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;my&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;start_date&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;start_date&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SET&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;my&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;end_date&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;end_date&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;DO&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;$$&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;DECLARE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;my_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;current_setting&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;my.product_id&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_start&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;date&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;current_setting&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;my.start_date&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;date&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_end&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;date&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;current_setting&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;my.end_date&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;date&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;BEGIN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;...&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;END&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;$$&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;strong&gt;Conversion complète&lt;/strong&gt;&lt;/p&gt;&#xA;&lt;p&gt;Toutes ces astuces mises bout à bout permet d&amp;rsquo;obtenir une nouvelle version du&#xA;script, converti de PL/SQL à PL/pgSQL :&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;-- psql-report-03.sql&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;\&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;set&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;QUIET&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;on&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SET&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;my&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SET&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;my&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;start_date&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;start_date&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SET&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;my&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;end_date&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;end_date&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;DO&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;$$&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;DECLARE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;my_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;current_setting&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;my.product_id&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;products&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;%&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;TYPE&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_sum&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;numeric&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_prev_sum&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;numeric&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_start&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;date&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;current_setting&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;my.start_date&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;date&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_end&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;date&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;current_setting&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;my.end_date&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;date&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_prev_start&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;date&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_start&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;interval&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;1 day&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_end&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_start&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_prev_end&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;date&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_start&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;interval&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;1 day&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c_orders&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CURSOR&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;v_start&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;date&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;v_end&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;date&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;IS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;COALESCE&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SUM&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;amount&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;orders&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AND&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;order_date&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;BETWEEN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;v_start&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AND&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;v_end&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;BEGIN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CREATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FUNCTION&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pg_temp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;score&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_sum&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;numeric&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_prev_sum&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;numeric&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;RETURNS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;numeric&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;LANGUAGE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;plpgsql&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;$&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;func$&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;BEGIN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;RETURN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ROUND&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_sum&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_prev_sum&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_prev_sum&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;100&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;EXCEPTION&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WHEN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;division_by_zero&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;THEN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;RETURN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NULL&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;END&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;$&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;func$&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INTO&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;STRICT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;products&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;my_id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;OPEN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c_orders&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_start&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_end&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FETCH&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c_orders&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INTO&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_sum&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CLOSE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c_orders&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;OPEN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c_orders&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_prev_start&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_prev_end&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FETCH&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c_orders&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INTO&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_prev_sum&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CLOSE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c_orders&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;RAISE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;NOTICE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;Total amount: %&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_sum&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;RAISE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;NOTICE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;Performance score: %&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pg_temp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;score&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_sum&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p_prev_sum&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;EXCEPTION&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WHEN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;no_data_found&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;THEN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;RAISE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;NOTICE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;Product % does not exist&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;my_id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;END&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;$$&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-console&#34; data-lang=&#34;console&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;gp&#34;&gt;$&lt;/span&gt; psql -f psql-report-03.sql&lt;span class=&#34;se&#34;&gt;\&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;&lt;span class=&#34;gp&#34;&gt;$&lt;/span&gt; -v &lt;span class=&#34;nv&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;20&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;&lt;span class=&#34;gp&#34;&gt;$&lt;/span&gt; -v &lt;span class=&#34;nv&#34;&gt;start_date&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;2024-11-01&amp;#39;&lt;/span&gt; -v &lt;span class=&#34;nv&#34;&gt;end_date&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;2024-11-30&amp;#39;&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt;psql:psql-report-03.sql:55: NOTICE: Total amount: 1378.98&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt;psql:psql-report-03.sql:55: NOTICE: Performance score: 162.99&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;hr&gt;&#xA;&lt;h2 id=&#34;conclusion&#34;&gt;Conclusion&lt;/h2&gt;&#xA;&lt;p&gt;Convertir un script SQL*Plus pour qu&amp;rsquo;il devienne compatible avec l&amp;rsquo;outil psql de&#xA;PostgreSQL est un exercice surmontable, pour peu que l&amp;rsquo;on connaisse les bonnes&#xA;astuces et alternatives qui répondent au besoin initial. Bien sûr, une&#xA;traduction un pour un, en conservant la syntaxe et un semblant de lisibilité,&#xA;pourrait s&amp;rsquo;avérer plus ardue que l&amp;rsquo;exemple que j&amp;rsquo;ai concocté.&lt;/p&gt;&#xA;&lt;p&gt;Je reste toujours sceptique face à celles et ceux qui souhaitent conserver ce&#xA;genre de pratiques de développement, que je trouve obsolètes. Migrer vers&#xA;PostgreSQL n&amp;rsquo;est-il pas l&amp;rsquo;occasion de moderniser sa base de code, ou de&#xA;questionner son rapport à la technologie ? Dans notre exemple, comme je l&amp;rsquo;avais&#xA;mentionné, il est possible d&amp;rsquo;obtenir le même résultat en une seule requête SQL,&#xA;sans avoir à recourir à un bloc anonyme PL/pgSQL.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;-- psql-report-04.sql&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;\&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pset&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;footer&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;off&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NOT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;EXISTS&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;products&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unknown_product&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;\&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;gset&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;\&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unknown_product&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;\&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;echo&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;Product&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;does not exist&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;\&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;quit&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;\&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;endif&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;end_date&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;date&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;start_date&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;date&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;days&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;\&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;gset&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;start_date&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;date&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;days&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;prev_start&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;\&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;gset&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WITH&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;periods&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;d&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;start_date&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;d&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;days&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;1 day&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;interval&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;end_date&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;generate_series&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(:&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;prev_start&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;date&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;start_date&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;date&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;days&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;1 day&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;interval&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;d&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;amounts&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;start_date&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;COALESCE&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SUM&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;amount&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;total_amount&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;LAG&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SUM&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;amount&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;OVER&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;ORDER&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;BY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;start_date&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;prev_total_amount&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;orders&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;JOIN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;periods&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;ON&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;order_date&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;BETWEEN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;start_date&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AND&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;end_date&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;GROUP&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;BY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;start_date&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;total_amount&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ROUND&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;total_amount&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;prev_total_amount&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;prev_total_amount&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;100&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;performance_score&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;amounts&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;prev_total_amount&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;IS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NOT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NULL&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-console&#34; data-lang=&#34;console&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;gp&#34;&gt;$&lt;/span&gt; psql -f psql-report-04.sql&lt;span class=&#34;se&#34;&gt;\&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;&lt;span class=&#34;gp&#34;&gt;$&lt;/span&gt; -v &lt;span class=&#34;nv&#34;&gt;product_id&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;20&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;&lt;span class=&#34;gp&#34;&gt;$&lt;/span&gt; -v &lt;span class=&#34;nv&#34;&gt;start_date&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;2024-11-01&amp;#39;&lt;/span&gt; -v &lt;span class=&#34;nv&#34;&gt;end_date&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;2024-11-30&amp;#39;&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt; total_amount | performance_score&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt;--------------+-------------------&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt; 1378.98 | 162.99&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;message&#34;&gt;Tous les scripts de cet article, ainsi que les commandes DDL pour construire&#xA;le modèle de données, sont disponibles cette &lt;a href=&#34;https://gist.github.com/fljdin/45d9ece1c9aba054c85cfbede09c95fd&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;adresse&lt;/a&gt;.&lt;/div&gt;</summary>
    <author>
      <name>Florent Jardin</name>
    </author>
  </entry>
  <entry>
    <title>Poissons et coquillages</title>
    <updated>2024-10-14T08:30:00Z</updated>
    <id>tag:fljd.in,2024-10-14:/2024/10/14/poissons-et-coquillages/</id>
    <link href="https://fljd.in/2024/10/14/poissons-et-coquillages/" rel="alternate"></link>
    <summary type="html">&lt;p&gt;En tant que pur produit académique des années 2010, mon langage de script de prédilection a&#xA;toujours été le Bash (&lt;em&gt;Bourne Again Shell&lt;/em&gt;). Non sans ignorer qu&amp;rsquo;il ait pu en exister d&amp;rsquo;autres, je&#xA;ne me suis jamais vraiment tourné vers d&amp;rsquo;autres shells pour automatiser les tâches du quotidien&#xA;dans mon métier de DBA.&lt;/p&gt;&#xA;&lt;p&gt;Et pour cause, j&amp;rsquo;ai administré des centaines de serveurs de distributions très variées et il&#xA;n&amp;rsquo;était pas bien vu d&amp;rsquo;installer des dépendances systèmes lourdes pour enrichir des scripts Python&#xA;ou Perl. Nous apprenions donc à écrire des scripts portables et universels, compatibles partout&#xA;où nous déposions nos valises.&lt;/p&gt;&#xA;&lt;p&gt;Me suis-je enfermé dans un dogme conservateur, en m&amp;rsquo;interdisant &lt;em&gt;de facto&lt;/em&gt; à me tourner vers des&#xA;shells modernes et bien plus aisés à appréhender ?&lt;/p&gt;&#xA;&lt;hr&gt;&#xA;&lt;h2 id=&#34;beurk-le-bash&#34;&gt;Beurk, le Bash&lt;/h2&gt;&#xA;&lt;p&gt;Ne faisons pas de détour, le Bash c&amp;rsquo;est moche. Puissant, pratique, universel, mais moche.&lt;/p&gt;&#xA;&lt;p&gt;Vous pourriez penser que c&amp;rsquo;est un avis parfaitement subjectif, et qu&amp;rsquo;il ne faut pas juger un livre&#xA;à sa couverture&amp;hellip; mais avouez-le, une partie de vous pense sensiblement la même chose que moi.&#xA;Combien d&amp;rsquo;heures ai-je pu perdre durant ma courbe d&amp;rsquo;apprentissage du langage, à cause d&amp;rsquo;un grand&#xA;nombre de subtilités et de pièges de syntaxes ?&lt;/p&gt;&#xA;&lt;p&gt;Entre les assignations sans espace autour du signe &lt;code&gt;=&lt;/code&gt;, les accolades &lt;code&gt;{}&lt;/code&gt; pour les variables&#xA;contenant un signe &lt;code&gt;_&lt;/code&gt;, les backticks &lt;code&gt;` `&lt;/code&gt; pour les commandes subshells, ou encore les doubles&#xA;crochets &lt;code&gt;[[ ... ]]&lt;/code&gt; pour les comparaisons non-POSIX, il y a de quoi s&amp;rsquo;arracher les cheveux.&lt;/p&gt;&#xA;&lt;p&gt;Certain·e·s y verront une forme d&amp;rsquo;esthétisme ou de tradition d&amp;rsquo;une culture informatique, mais&#xA;personnellement je trouve que c&amp;rsquo;est un langage qui vieillit mal, très mal. Vous ne vous offusqueriez&#xA;pas non plus si je devais vous témoigner mon désamour le Perl, n&amp;rsquo;est-ce pas ?&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# une comparaison de deux variables&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;o&#34;&gt;[[&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;$a&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;$b&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;]]&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# une addition et une affectation&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nv&#34;&gt;z&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;$((&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;$x&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;+&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;$y&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;))&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# une boucle for&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; i in &lt;span class=&#34;k&#34;&gt;$(&lt;/span&gt;seq &lt;span class=&#34;m&#34;&gt;1&lt;/span&gt; 10&lt;span class=&#34;k&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;do&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; &lt;span class=&#34;nb&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;$i&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;done&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# un switch case&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;$1&lt;/span&gt; in&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; 1&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;un&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;;&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; 2&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;deux&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;;&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; *&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;autre&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;;&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;esac&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# une chaîne en minuscule&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nv&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,,&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# une gestion des erreurs de commandes chaînées&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;some_command &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; another_command&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;[[&lt;/span&gt; &lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;PIPESTATUS&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[0]&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt; -ne &lt;span class=&#34;m&#34;&gt;0&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;||&lt;/span&gt; &lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;PIPESTATUS&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[1]&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt; -ne &lt;span class=&#34;m&#34;&gt;0&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;]]&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;then&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; &lt;span class=&#34;nb&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;Une des commandes a échoué&amp;#34;&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;fi&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Le &lt;a href=&#34;https://en.wikipedia.org/wiki/Bash_%28Unix_shell%29&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Bash&lt;/a&gt; est apparu l&amp;rsquo;année de ma naissance, en 1989. Il a été conçu en opposition au &lt;a href=&#34;https://en.wikipedia.org/wiki/Bourne_shell&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Bourne Shell&lt;/a&gt;&#xA;(&lt;code&gt;sh&lt;/code&gt;) pour apporter des fonctionnalités de programmation plus avancées. Il est devenu le shell par&#xA;défaut de la plupart des distributions Linux, et est devenu un standard pour tous les scripts à travers&#xA;le monde entier.&lt;/p&gt;&#xA;&lt;p&gt;Fort de ses années de succès, et de son emprise sur le monde Unix, le Bash s&amp;rsquo;impose parfois comme la première&#xA;porte vers la programmation pour des administrateurices système ou les étudiant·e·s en informatique. Et il&#xA;faut accepter que la qualité de ses premiers scripts n&amp;rsquo;est pas toujours au rendez-vous. Souvenez-vous des&#xA;longues heures passées sur StackOverflow à trouver la syntaxe la plus lisible ou la plus efficace, car les&#xA;réponses se révélaient aussi variées que touffues !&lt;/p&gt;&#xA;&lt;p&gt;Et c&amp;rsquo;est l&amp;rsquo;un des plus gros problèmes que je trouve au Bash : ce langage de programmation est exigeant,&#xA;excentrique, voire &lt;a href=&#34;https://fr.wikipedia.org/wiki/Idiosyncrasie&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;idiosyncratique&lt;/a&gt;, et qui ne pardonne pas les erreurs. Un des &lt;a href=&#34;https://dev.to/taikedz/your-bash-scripts-are-rubbish-use-another-language-5dh7&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;paradoxes&lt;/a&gt; que j&amp;rsquo;associe&#xA;au Bash est qu&amp;rsquo;il peut ne pas être considéré comme un véritable langage de programmation, réduisant ainsi&#xA;la volonté et l&amp;rsquo;effort de l&amp;rsquo;apprendre en profondeur par une large communauté de professionnel·le·s.&lt;/p&gt;&#xA;&lt;p&gt;&lt;a href=&#34;https://dev.to/taikedz/your-bash-scripts-are-rubbish-use-another-language-5dh7&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Et si vos scripts Bash sont nuls, utilisez un autre langage.&lt;/a&gt;&lt;/p&gt;&#xA;&lt;hr&gt;&#xA;&lt;h2 id=&#34;lami-fish-friendly-interactive-shell&#34;&gt;L&amp;rsquo;ami Fish, Friendly Interactive Shell&lt;/h2&gt;&#xA;&lt;p&gt;Je suis tombé sur &lt;a href=&#34;https://fishshell.com/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Fish&lt;/a&gt; par hasard, alors que je questionnais mon usage quotidien sur &lt;a href=&#34;https://fr.wikipedia.org/wiki/Z_Shell&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;ZSH&lt;/a&gt;. Sur&#xA;mon poste personnel, j&amp;rsquo;ai étendu mon expérience passée sur le Bash avec une configuration ZSH enrichie de&#xA;&lt;a href=&#34;https://ohmyz.sh/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Oh My Zsh&lt;/a&gt;. C&amp;rsquo;était un peu le jour et la nuit dans l&amp;rsquo;interaction avec mes terminaux : la navigation,&#xA;les suggestions, les thèmes, les plugins, tout est plus fluide et plus agréable. Sa compatibilité avec&#xA;Bash m&amp;rsquo;avait alors évité de tout réapprendre.&lt;/p&gt;&#xA;&lt;p&gt;Fish répond au besoin de modernité et de simplicité que je cherche sans vraiment le savoir. Contrairement&#xA;à ZSH, un grand nombre de fonctionnalités sont disponibles sans aucune configuration préalable ou plugin&#xA;à activer.&lt;/p&gt;&#xA;&lt;p&gt;&lt;strong&gt;Assistance à la commande&lt;/strong&gt;&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Recopie la commande incomplète et en erreur sans besoin de naviguer dans l&amp;rsquo;historique&lt;/li&gt;&#xA;&lt;li&gt;Accès à l&amp;rsquo;historique partiel avec les touches directionnelles dès la première frappe au clavier&lt;/li&gt;&#xA;&lt;li&gt;Proposition de chemins avec la complétion de la touche Tab, suivie des touches directionnelles&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;&lt;img src=&#34;https://fljd.in/img/fr/2024-20-14-fish-01.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;&lt;strong&gt;Auto-suggestions des chemins et des options d&amp;rsquo;une grande majorité des outils&lt;/strong&gt;&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Mémoire des précédents répertoires parcourus&lt;/li&gt;&#xA;&lt;li&gt;Support très complet des commandes Git, notamment le &lt;code&gt;git rebase -i&lt;/code&gt; ❤️&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;&lt;img src=&#34;https://fljd.in/img/fr/2024-20-14-fish-02.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;&lt;strong&gt;Coloration plus poussée des commandes&lt;/strong&gt;&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;une couleur différente par mot selon la syntaxe employée (variables, chemin, options)&lt;/li&gt;&#xA;&lt;li&gt;un rouge prononcé pour les commandes inconnues&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;hr&gt;&#xA;&lt;h2 id=&#34;un-langage-qui-vous-veut-du-bien&#34;&gt;Un langage qui vous veut du bien&lt;/h2&gt;&#xA;&lt;p&gt;Pour revenir au sujet principal de cet article, Fish révolutionne notre rapport avec la rédaction&#xA;de scripts. Fini les pièges et la syntaxe qui nous ont tenu en otage durant des années. Les choses&#xA;deviennent bien plus simples et lisibles.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-fish&#34; data-lang=&#34;fish&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c&#34;&gt;# une comparaison de deux variables&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;test&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;$a&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;$b&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c&#34;&gt;# une addition et une affectation&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;set&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;z&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;math&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;$x&lt;/span&gt; + &lt;span class=&#34;nv&#34;&gt;$y&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c&#34;&gt;# une boucle for&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;i&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;in&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;seq&lt;/span&gt; &lt;span class=&#34;m&#34;&gt;1&lt;/span&gt; &lt;span class=&#34;m&#34;&gt;10&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; &lt;span class=&#34;k&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;$i&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c&#34;&gt;# un switch case&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;$argv&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; &lt;span class=&#34;nf&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;un&amp;#34;&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; &lt;span class=&#34;nf&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;deux&amp;#34;&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; *&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;autre&amp;#34;&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c&#34;&gt;# une chaîne en minuscule&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;set&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;a&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;string &lt;/span&gt;lower &lt;span class=&#34;nv&#34;&gt;$a&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c&#34;&gt;# une gestion des erreurs de commandes chaînées&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;some_command&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;another_command&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;contains &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;1&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;$pipestatus&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; &lt;span class=&#34;k&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;Une des commandes a échoué&amp;#34;&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;L&amp;rsquo;investissement initial pour perdre ses habitudes acquises avec Bash est modéré, notamment&#xA;le &lt;a href=&#34;https://fishshell.com/docs/current/language.html#variables-export&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;remplacement&lt;/a&gt; de &lt;code&gt;export&lt;/code&gt; ou de l&amp;rsquo;assignation &lt;code&gt;=&lt;/code&gt; par la méthode &lt;code&gt;set -x&lt;/code&gt; ou &lt;code&gt;set -u&lt;/code&gt;&#xA;respectivement. Mais l&amp;rsquo;enrichissement du langage par quelques nouveaux mots-clés permet&#xA;d&amp;rsquo;alléger le script avec des syntaxes claires et lisibles (&lt;code&gt;contains&lt;/code&gt;, &lt;code&gt;math&lt;/code&gt; ou &lt;code&gt;string&lt;/code&gt;&#xA;présents dans l&amp;rsquo;exemple ci-dessus).&lt;/p&gt;&#xA;&lt;p&gt;L&amp;rsquo;ajout de plugins communautaire n&amp;rsquo;est pas en reste, si comme moi, vous en consommiez avec&#xA;Oh-My-ZSH. L&amp;rsquo;outil &lt;a href=&#34;https://github.com/jorgebucaran/fisher&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Fisher&lt;/a&gt; s&amp;rsquo;installe dans votre &lt;code&gt;~/.config/fish&lt;/code&gt; et donne accès à un&#xA;gestionnaire complet et sobre. Pour ma part, j&amp;rsquo;ai pu rapidement combler mon besoin de charger&#xA;les variables d&amp;rsquo;environnement fournies par l&amp;rsquo;agent SSH (&lt;code&gt;ssh-agent&lt;/code&gt;) lors du démarrage de ma&#xA;session.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-console&#34; data-lang=&#34;console&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;gp&#34;&gt;$&lt;/span&gt; fisher install danhper/fish-ssh-agent&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt;fisher install version 4.4.5&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt;Fetching https://api.github.com/repos/danhper/fish-ssh-agent/tarball/HEAD&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt;Installing danhper/fish-ssh-agent&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt; /home/florent/.config/fish/functions/__ssh_agent_is_started.fish&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt; /home/florent/.config/fish/functions/__ssh_agent_start.fish&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt; /home/florent/.config/fish/conf.d/fish-ssh-agent.fish&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt;Updated 1 plugin/s&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Pas de mystère, ni d&amp;rsquo;arcanes magiques, votre environnement est enrichi de nouvelles fonctions&#xA;et de scripts de démarrage, développés en Fish.&lt;/p&gt;&#xA;&lt;hr&gt;&#xA;&lt;h2 id=&#34;osons-la-modernité&#34;&gt;Osons la modernité&lt;/h2&gt;&#xA;&lt;p&gt;La documentation du projet est très bien fournie. En plus de la page &lt;a href=&#34;https://en.wikipedia.org/wiki/Bash_%28Unix_shell%29&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Tutorial&lt;/a&gt;, vous trouverez&#xA;une page dédiée aux &lt;a href=&#34;https://fishshell.com/docs/current/fish_for_bash_users.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;utilisateurs de Bash&lt;/a&gt; pour vous aider à réussir votre transition. Pour ma&#xA;part, j&amp;rsquo;y retrouve des syntaxes bien plus proches du Python, et c&amp;rsquo;est un vrai plaisir.&lt;/p&gt;&#xA;&lt;p&gt;Le projet est vivant, avec un rythme de versions régulier. Je me suis surpris moi-même à ne pas en&#xA;avoir entendu parler par d&amp;rsquo;autres collègues ou auprès des auteurices de blogs que je suis. Au cours des&#xA;dernières années, la communauté francophone a essaimé quelques bons articles qui complètent le&#xA;mien.&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://lkdjiin.github.io/blog/2016/12/13/changer-de-shell-de-bash-a-fish/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Changer de shell, de Bash à Fish&lt;/a&gt; (2016)&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://ubunlog.com/fr/ligne-de-commande-fish-smart/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Fish, une ligne de commande intelligente et simple d&amp;rsquo;utilisation&lt;/a&gt; (2017)&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://toptips.fr/comment-passer-de-bash-a-fish-shell-sous-linux/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Comment passer de Bash à Fish Shell sous Linux&lt;/a&gt; (2021)&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://blog.otso.fr/2024-01-17-passer-zsh-fish-shell&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Migration de shell de zsh à fish&lt;/a&gt; (2024)&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;Ces temps-ci, je fais évoluer mon expérience d&amp;rsquo;utilisateur de Linux avec une transition vers Wayland&#xA;et SwayWM (j&amp;rsquo;y reviendrais dans un autre article). Je ne le cache pas, la tentation de remplacer mes&#xA;scripts Bash qui gèrent mes thèmes ou les composants &lt;em&gt;swaybar&lt;/em&gt;, est forte, très forte.&lt;/p&gt;&#xA;&lt;p&gt;De quoi occuper mes prochaines longues soirées d&amp;rsquo;hiver.&lt;/p&gt;</summary>
    <author>
      <name>Florent Jardin</name>
    </author>
  </entry>
  <entry>
    <title>Les types hiérarchiques</title>
    <updated>2024-09-19T11:20:00Z</updated>
    <id>tag:fljd.in,2024-09-19:/2024/09/19/les-types-hierarchiques/</id>
    <link href="https://fljd.in/2024/09/19/les-types-hierarchiques/" rel="alternate"></link>
    <summary type="html">&lt;p&gt;Bien que la norme SQL définisse un ensemble de règles pour que les systèmes de bases&#xA;de données puissent être interchangeables, il existe de petites singularités dans la&#xA;nature. À ce titre, le type de données &lt;code&gt;hierarchyid&lt;/code&gt; fourni par SQL Server est un&#xA;exemple flagrant. Si vous êtes amené à basculer vers PostgreSQL, deux solutions s&amp;rsquo;offrent&#xA;à vous.&lt;/p&gt;&#xA;&lt;p&gt;Une première et plus simple consiste à lier chaque nœud à son parent à l&amp;rsquo;aide d&amp;rsquo;une nouvelle&#xA;colonne &lt;code&gt;parentid&lt;/code&gt; et d&amp;rsquo;y appliquer une contrainte de clé étrangère. Une autre approche,&#xA;plus complète, consiste à utiliser l&amp;rsquo;extension &lt;code&gt;ltree&lt;/code&gt;. Cet article traite de ce dernier&#xA;cas.&lt;/p&gt;&#xA;&lt;hr&gt;&#xA;&lt;h2 id=&#34;à-la-recherche-de-ses-descendants&#34;&gt;À la recherche de ses descendants&lt;/h2&gt;&#xA;&lt;p&gt;Conçu pour représenter une &lt;a href=&#34;https://learn.microsoft.com/en-us/sql/relational-databases/hierarchical-data-sql-server&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;relation hiérarchique&lt;/a&gt; sous la forme d&amp;rsquo;un arbre binaire, le&#xA;type &lt;code&gt;hierarchyid&lt;/code&gt; a la particularité de stocker la liste des nœuds successifs jusqu&amp;rsquo;à&#xA;la racine dans une seule colonne. Ainsi, le nœud &lt;code&gt;/1/1/2/&lt;/code&gt; représente un nœud de niveau&#xA;3, enfant du nœud &lt;code&gt;/1/1/&lt;/code&gt;, lui-même enfant du nœud &lt;code&gt;/1/&lt;/code&gt;, lui-même enfant de la racine &lt;code&gt;/&lt;/code&gt;.&lt;/p&gt;&#xA;&lt;p&gt;Plusieurs méthodes sont fournies avec le langage Transact-SQL pour manipuler les données et&#xA;toutes parcourent l&amp;rsquo;arbre binaire pour en extraire rapidement l&amp;rsquo;information souhaitée sans&#xA;avoir à joindre les nœuds de la table entre eux.&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://learn.microsoft.com/en-us/sql/t-sql/data-types/tostring-database-engine&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;ToString()&lt;/code&gt;&lt;/a&gt; : retourne la représentation textuelle du nœud courant.&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://learn.microsoft.com/en-us/sql/t-sql/data-types/getlevel-database-engine&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;GetLevel()&lt;/code&gt;&lt;/a&gt; : retourne le niveau de profondeur du nœud courant.&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://learn.microsoft.com/en-us/sql/t-sql/data-types/getancestor-database-engine&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;GetAncestor(n)&lt;/code&gt;&lt;/a&gt; : retourne le nœud de niveau &lt;code&gt;n&lt;/code&gt; dans l&amp;rsquo;arbre.&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://learn.microsoft.com/en-us/sql/t-sql/data-types/getdescendant-database-engine&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;GetDescendant(c1, c2)&lt;/code&gt;&lt;/a&gt; : retourne un nouveau nœud enfant entre deux nœuds.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;L&amp;rsquo;extension &lt;a href=&#34;https://www.postgresql.org/docs/current/ltree.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;ltree&lt;/a&gt;, disponible depuis le paquet &lt;code&gt;contrib&lt;/code&gt; de PostgreSQL, est aussi complète,&#xA;voire plus, que le type &lt;code&gt;hierarchyid&lt;/code&gt;. Elle fournit un type de données complexe, nommé &lt;code&gt;ltree&lt;/code&gt;,&#xA;et permet de stocker des labels de 1 000 caractères alphanumériques séparés par des points. Le&#xA;chemin (&lt;code&gt;path&lt;/code&gt;) ainsi constitué, peut lui-même contenir jusqu&amp;rsquo;à 65 635 labels.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;CREATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;EXTENSION&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ltree&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CREATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;TABLE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;locations&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ltree&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;PRIMARY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;KEY&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;location&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;text&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NOT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NULL&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;locationtype&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;text&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NOT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NULL&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INSERT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INTO&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;locations&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;VALUES&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;1&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;Earth&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;Planet&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;1.1&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;Europe&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;Continent&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;1.1.1&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;France&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;Country&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;1.1.1.1&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;Paris&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;City&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;1.1.2&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;Spain&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;Country&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;1.1.2.1&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;Madrid&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;City&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;1.2&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;South-America&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;Continent&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;1.2.1&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;Brazil&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;Country&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;1.2.1.1&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;Brasilia&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;City&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;1.2.2&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;Bahia&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;State&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;1.2.2.1&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;Salvador&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;City&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;1.3&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;Antarctica&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;Continent&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;1.3.1&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;McMurdo Station&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;City&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Obtenir le niveau de profondeur d&amp;rsquo;un nœud devient trivial avec la fonction &lt;code&gt;nlevel()&lt;/code&gt;&#xA;fournie par l&amp;rsquo;extension &lt;code&gt;ltree&lt;/code&gt;.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;location&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;locationtype&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nlevel&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;level&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;locations&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;ORDER&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;BY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-console&#34; data-lang=&#34;console&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt; id | location | locationtype | level&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt;---------+-----------------+--------------+-------&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt; 1 | Earth | Planet | 1&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt; 1.1 | Europe | Continent | 2&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt; 1.1.1 | France | Country | 3&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt; 1.1.1.1 | Paris | City | 4&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt; 1.1.2 | Spain | Country | 3&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt; 1.1.2.1 | Madrid | City | 4&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt; 1.2 | South-America | Continent | 2&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt; 1.2.1 | Brazil | Country | 3&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt; 1.2.1.1 | Brasilia | City | 4&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt; 1.2.2 | Bahia | State | 3&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt; 1.2.2.1 | Salvador | City | 4&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt; 1.3 | Antarctica | Continent | 2&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt; 1.3.1 | McMurdo Station | City | 3&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt; 2.1.1 | unknown | State | 3&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt;(14 rows)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Une autre méthode nommée &lt;code&gt;subpath()&lt;/code&gt; permet de récupérer une partie du chemin d&amp;rsquo;un nœud.&#xA;Voyons comment obtenir le nœud parent de chaque nœud de la table.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;location&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;locationtype&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;subpath&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nlevel&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;parentid&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;locations&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;ORDER&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;BY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-console&#34; data-lang=&#34;console&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt; id | location | locationtype | parent&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt;---------+-----------------+--------------+--------&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt; 1 | Earth | Planet |&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt; 1.1 | Europe | Continent | 1&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt; 1.1.1 | France | Country | 1.1&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt; 1.1.1.1 | Paris | City | 1.1.1&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt; 1.1.2 | Spain | Country | 1.1&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt; 1.1.2.1 | Madrid | City | 1.1.2&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt; 1.2 | South-America | Continent | 1&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt; 1.2.1 | Brazil | Country | 1.2&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt; 1.2.1.1 | Brasilia | City | 1.2.1&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt; 1.2.2 | Bahia | State | 1.2&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt; 1.2.2.1 | Salvador | City | 1.2.2&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt; 1.3 | Antarctica | Continent | 1&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt; 1.3.1 | McMurdo Station | City | 1.3&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt; 2.1.1 | unknown | State | 2.1&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt;(14 rows)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Enfin, la recherche des nœuds enfants depuis un nœud donné est possible grâce aux&#xA;opérateurs de comparaison spécialisés. Pour favoriser les performances, il est recommandé&#xA;de créer un index GIST sur la colonne de clé primaire &lt;code&gt;id&lt;/code&gt;.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;CREATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INDEX&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;ON&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;locations&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;USING&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GIST&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;La requête suivante liste toutes les villes d&amp;rsquo;Europe.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;l1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;locations&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;l1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;JOIN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;locations&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;l2&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;ON&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;l1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;@&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;l2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;l1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;locationtype&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;City&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AND&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;l2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;location&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;Europe&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-console&#34; data-lang=&#34;console&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt; id | location | locationtype&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt;---------+----------+--------------&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt; 1.1.1.1 | Paris | City&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt; 1.1.2.1 | Madrid | City&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt;(2 rows)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;hr&gt;&#xA;&lt;h2 id=&#34;travailler-sous-contraintes&#34;&gt;Travailler sous contraintes&lt;/h2&gt;&#xA;&lt;p&gt;La contrainte de clé primaire m&amp;rsquo;empêche actuellement d&amp;rsquo;insérer un chemin déjà existant.&#xA;Par contre, il est bien possible d&amp;rsquo;ajouter une nouvelle ligne dont le chemin ne présente&#xA;pas d&amp;rsquo;ancêtre dans la table.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;INSERT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INTO&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;locations&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;VALUES&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;2.1.1&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;Unknown&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;Continent&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-console&#34; data-lang=&#34;console&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt;INSERT 0 1&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;À ce jeu, SQL Server et PostgreSQL n&amp;rsquo;ont plus trop de différences, il devient nécessaire&#xA;d&amp;rsquo;ajouter une &lt;a href=&#34;https://learn.microsoft.com/en-us/sql/relational-databases/hierarchical-data-sql-server#enforce-a-tree&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;colonne supplémentaire&lt;/a&gt;, nommée &lt;code&gt;parentid&lt;/code&gt; par exemple, pour ajouter la&#xA;contrainte de clé étrangère. La requête suivante réutilise la fonction &lt;code&gt;subpath()&lt;/code&gt; en&#xA;s&amp;rsquo;assurant qu&amp;rsquo;une valeur nulle soit insérée s&amp;rsquo;il s&amp;rsquo;agit d&amp;rsquo;un nœud racine.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;DELETE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;locations&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;@&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;2&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;ALTER&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;TABLE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;locations&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;ADD&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;COLUMN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;parentid&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ltree&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;REFERENCES&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;locations&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;GENERATED&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ALWAYS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CASE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;subpath&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nlevel&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WHEN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;THEN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;null&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;ELSE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;subpath&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nlevel&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;END&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;STORED&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;À présent, dès qu&amp;rsquo;une nouvelle ligne est insérée, la contrainte de clé étrangère est&#xA;automatiquement vérifiée.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;INSERT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INTO&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;locations&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;VALUES&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;2.1.1&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;Unknown&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;Continent&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-console&#34; data-lang=&#34;console&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt;ERROR: insert or update on table &amp;#34;locations&amp;#34; violates&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt; foreign key constraint &amp;#34;locations_parentid_fkey&amp;#34;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt;DETAIL: Key (parentid)=(2.1) is not present in table &amp;#34;locations&amp;#34;.&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;hr&gt;&#xA;&lt;h2 id=&#34;une-solution-parmi-dautres&#34;&gt;Une solution parmi d&amp;rsquo;autres&lt;/h2&gt;&#xA;&lt;p&gt;La méthode de stockage des données hiérarchiques sous forme de chemin est une solution&#xA;ingénieuse et disponible facilement avec PostgreSQL. Cependant, il s&amp;rsquo;agit d&amp;rsquo;une extension&#xA;du langage SQL et chaque moteur peut proposer une implémentation qui peut radicalement&#xA;changer d&amp;rsquo;un système à l&amp;rsquo;autre.&lt;/p&gt;&#xA;&lt;p&gt;Comme je l&amp;rsquo;indiquais en introduction, la réponse universelle reste la reconstruction d&amp;rsquo;une&#xA;relation hiériarchique à l&amp;rsquo;aide d&amp;rsquo;une requête récursive et la syntaxe &lt;code&gt;WITH RECURSIVE&lt;/code&gt;. Pour&#xA;reprendre l&amp;rsquo;exemple de la table &lt;code&gt;locations&lt;/code&gt;, la liste des villes présentes en Europe pourrait&#xA;être obtenue de la manière suivante.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;WITH&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;RECURSIVE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;loc&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;parentid&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;location&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;locationtype&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;locations&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;location&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;Europe&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;UNION&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;ALL&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;l&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;l&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;parentid&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;l&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;location&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;l&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;locationtype&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;locations&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;l&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;JOIN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;loc&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;ON&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;l&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;parentid&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;loc&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;locationtype&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;City&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-console&#34; data-lang=&#34;console&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt; id | parentid | location | locationtype&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt;----+----------+----------+--------------&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt; 4 | 3 | Paris | City&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt; 6 | 5 | Madrid | City&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;go&#34;&gt;(2 rows)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</summary>
    <author>
      <name>Florent Jardin</name>
    </author>
  </entry>
  <entry>
    <title>Retour sur le PG Day France 2025</title>
    <updated>2025-06-18T07:56:12Z</updated>
    <id>tag:blog.atolcd.com,2025-06-18:/retour-sur-le-pg-day-france-2025/</id>
    <content type="html">&#xA;&lt;p class=&#34;article-editor-paragraph article-editor-content__has-focus&#34;&gt;Les 3 et 4 juin derniers, la communauté francophone de PostgreSQL s’est retrouvée à Mons, en Belgique, à l’occasion de l’édition 2025 du PG Day France. Chaque année depuis 2008, cet événement itinérant investit une nouvelle ville pour faire vivre et grandir la communauté autour de PostgreSQL. PostgreSQL (prononcé Post-Gress-Q-L) est un système de gestion de base de données relationnelle (SGBDR) open source. C’est l’un des SGBD les plus puissants, fiables et évolutifs du marché, très prisé par les développeurs, les entreprises et les administrations.&lt;/p&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;Après Toulouse, Lille, Toulon, Marseille, Lyon, Nantes, Montpellier ou encore Strasbourg, c’était au tour de Mons d’accueillir ateliers, conférences, retours d’expérience et moments de convivialité entre passionnés, utilisateurs et professionnels du monde PostgreSQL.&lt;/p&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;Nous avons pu suivre avec intérêt les échanges et les présentations qui ont rythmé ces deux journées. L’événement a une fois de plus illustré la richesse de l’écosystèmePostgreSQL et les nombreuses possibilités qu’il offre – bien au-delà du simple SGBD relationnel.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure class=&#34;wp-block-image size-full&#34;&gt;&lt;img fetchpriority=&#34;high&#34; decoding=&#34;async&#34; width=&#34;512&#34; height=&#34;483&#34; src=&#34;https://blog.atolcd.com/wp-content/uploads/2025/06/pg-days-1.jpg&#34; alt=&#34;&#34; class=&#34;wp-image-5978&#34; srcset=&#34;https://blog.atolcd.com/wp-content/uploads/2025/06/pg-days-1.jpg 512w, https://blog.atolcd.com/wp-content/uploads/2025/06/pg-days-1-300x283.jpg 300w&#34; sizes=&#34;(max-width: 512px) 100vw, 512px&#34; /&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;Nous saluons l’organisation et l’énergie des bénévoles et intervenants qui font du PG Day France un rendez-vous incontournable pour toute la communauté PostgreSQL francophone.&lt;/p&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;Parmi les temps forts de la première journée, plusieurs ateliers techniques étaient proposés permettant d’assister à un de ces ateliers parmi les 3. Nous avons opté pour un atelier différent chacun à savoir : &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;article-editor-heading article-editor-content__has-focus&#34;&gt;Atelier : Industrialisez vos déploiements PostgreSQL avec pglift et Ansible&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p class=&#34;article-editor-paragraph article-editor-content__has-focus&#34;&gt;&lt;em&gt;Par Alexandre Pereira et Julian Vanden Broeck&lt;/em&gt;&lt;/p&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;Le but de cet atelier était d’industrialiser le déploiement des instances, bases de données et rôles PostgreSQL à l&amp;rsquo;aide de pglift et Ansible. Dalibo met à disposition en open source sur son lab ces collections ansible [&lt;a class=&#34;article-editor-link article-editor-link&#34; href=&#34;https://labs.dalibo.com/dalibo_ansible_collections&#34; rel=&#34;noopener noreferrer&#34;&gt;https://labs.dalibo.com/dalibo_ansible_collections&lt;/a&gt;] ainsi que l’outil pglift [&lt;a class=&#34;article-editor-link article-editor-link&#34; href=&#34;https://gitlab.com/dalibo/pglift&#34; rel=&#34;noopener noreferrer&#34;&gt;https://gitlab.com/dalibo/pglift&lt;/a&gt;]&lt;/p&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;Malgré un effet démo malencontreux sur les environnements mis à disposition permettant de faire les cas pratiques, cela a permis de voir ce qu’il était possible de faire avec ces collections et outils pour permettre l’industrialisation des déploiements de postgresql, des sauvegardes avec pgbackrest ou encore de la haute disponibilité avec patroni en utilisant pglift et Ansible.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;article-editor-heading article-editor-content__has-focus&#34;&gt;Atelier: Are you collecting the right metrics ?&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;&lt;em&gt;Par Frédéric Delacourt&lt;/em&gt;&lt;/p&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;Les métriques sont des données quantifiables permettant de suivre l’état de santé et les performances de sa base de données PostgreSQL. Leur principale utilité est de surveiller la base de données, afin de détecter des anomalies dans le but d’alerter les DBA (DataBase Administrator) et les ops/devops d&amp;rsquo;éventuels problèmes. Bien utilisé, on peut s’en servir pour comprendre certains comportements pour optimiser les performances et ressources de notre base.&lt;/p&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;Ces métriques peuvent être classées en plusieurs catégories : &lt;/p&gt;&#xA;&lt;ul class=&#34;article-editor-bullet-list&#34;&gt;&#xA;&lt;li class=&#34;article-editor-list-item&#34;&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;Informatives : qui permettent de suivre et comprendre l’activité de la base, comme le nombre de requêtes par minutes, la taille des tables, la fréquence d’utilisation de chaque index…&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li class=&#34;article-editor-list-item&#34;&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;Importantes (pour la performance) : qui permettent de détecter, anticiper et/ou corriger des lenteurs. On y retrouve par exemple le nombre de connexions ouvertes, le taux de requêtes lentes, le taux de bloat dans les tables…Critiques : qui peuvent mettre en péril l’état de santé de la base comme le nombre de transactions bloquées, un disque presque plein, le nombre d&amp;rsquo;erreurs SQL, des nouvelles connexions rejetées…&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;article-editor-heading article-editor-content__has-focus&#34;&gt;Keynote : Où sont passées les femmes de l&amp;rsquo;histoire de la tech? Par Laura Durieux&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p class=&#34;article-editor-paragraph article-editor-content__has-focus&#34;&gt;La keynote d’ouverture nous a présenté des femmes qui ont marqué l’histoire de la tech depuis son commencement, à savoir les calculs astronomiques jusqu’au développement de programme. On a pu en apprendre un peu sur ces femmes clefs de l’histoire avec notamment : &lt;/p&gt;&#xA;&lt;ul class=&#34;article-editor-bullet-list&#34;&gt;&#xA;&lt;li class=&#34;article-editor-list-item&#34;&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;Nicole-Reine Lepaute qui calcule le retour de la Comète de Halley de façon assez précise pour l’époque (1759)&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li class=&#34;article-editor-list-item&#34;&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;Maria Mitchell la première à observer une « comète télescopique » (comète non visible à l’œil nu)&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li class=&#34;article-editor-list-item&#34;&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;Ada Lovelace qui a écrit les premières formes d’algorithme &lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li class=&#34;article-editor-list-item&#34;&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;Grace Hopper qui a été la première développeuse sur le Mark I et une des fondatrices du langage COBOL&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li class=&#34;article-editor-list-item&#34;&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;ENIAC Girls était un groupe de six programmeuses ayant participé au développement et à la programmation d&amp;rsquo;un des premiers ordinateurs au monde, l&amp;rsquo;ENIAC&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li class=&#34;article-editor-list-item&#34;&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;Hedy Lamarr qui a inventé le FHSS, une technologie qui est toujours derrière le wifi et le Bluetooth&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;Il y en avait encore d’autres dans la présentation que nous vous laisserons découvrir si vous avez l’occasion de voir cette conférence. Cela a été aussi l’occasion de voir ce qui a entraîné la sous-représentation des femmes dans le domaine de la tech à travers notre société depuis l&amp;rsquo;arrivée des ordinateurs personnels dans les foyers, souvent associés au père et leur fils dans les publicités… On ne voudrait pas vous spoiler trop non plus, mais on vous conseille de la voir, d&amp;rsquo;y réfléchir et d’agir pour ouvrir le monde de la tech à tous et toutes.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;article-editor-heading article-editor-content__has-focus&#34;&gt;Postgres sur Kubernetes pour le DBA réticent Par Karen Jex&lt;/h3&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;Une présentation de Postgres sur Kubernetes qui est une évolution des pratiques passant de serveur physique, puis de machines virtuelles et maintenant de conteneurs pour le déploiement de PostgreSQL. Kubernetes a déjà 10 ans, il s’agit d’une solution mature qui a montré ses qualités pour le déploiement d’applications de façon automatisée et scalable mais qui entraîne quelques réticences pour le déploiement de base de données, car son principe étant des conteneurs stateless et éphémères. Mais il y a du stockage persistant qui permet de ne pas perdre ces données. De plus en plus de sociétés passent à Kubernetes, le plus grand frein étant surtout la montée en compétence nécessaire sur Kubernetes mais qui permet une fois ce stade passé de gagner du temps pour d’autres tâches nécessitant l’expertise d’un DBA.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;article-editor-heading article-editor-content__has-focus&#34;&gt;Tout savoir sur max_connections Par Guillaume Lelarge&lt;/h3&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;Présentation du paramètre de configuration ‘max_connections’, son utilisation, les différentes valeurs qu’il peut prendre et le changement de performances liées à ces valeurs.&lt;/p&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;Avoir une trop grosse valeur de max_connections, permet d’avoir un fort pic d’utilisation de la base, mais la mémoire initiale que prend PostgreSQL s’en voit augmentée (et de manière très significative, voire exponentielle quand les valeurs deviennent très grandes).&lt;/p&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;Présentation également de la consommation des connexions en comparant des connexions avec pooler et sans pooler. Les avantages et inconvénients de chacun comme le temps de connexion à la base (qui n’est pas nécessaire pour les pooler car celle-ci est réutilisée) qui peut représenter un bon pourcentage du temps total de l’exécution de la session. La mise en place d’un pooler permet d’augmenter grandement le nombre de transactions par seconde en minimisant ces temps de connexion.&lt;/p&gt;&#xA;&lt;h3 class=&#34;article-editor-heading&#34;&gt;Json in Postgres Par Sébastien Delobel&lt;/h3&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;Présentation du Type Json dans PostgreSQL et son utilisation ainsi que les bonnes pratiques à avoir notamment entre les JSON et les JSONB.&lt;/p&gt;&#xA;&lt;ul class=&#34;article-editor-bullet-list&#34;&gt;&#xA;&lt;li class=&#34;article-editor-list-item&#34;&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;Le format JSON permet de stocker la donnée en texte, il est pratique quand on cherche uniquement à stocker la donnée sans y toucher. Attention tout de même, lorsqu&amp;rsquo;un update sur ce champ, l’ancien contenu est écrasé et remplacé par le nouveau.&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li class=&#34;article-editor-list-item&#34;&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;Le format JSONB quant à lui est plutôt utile pour interroger et modifier les données. Il permet de stocker les informations sous format binaire, ce qui permet plus de flexibilité. On peut indexer un champ à l’intérieur du json, faire des recherches et des filtres sur les données.&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;Lors d’une modification, on peut ajouter ou supprimer certaines clés directement et sans avoir à devoir réécrire tout l’objet pour ne perdre aucune donnée.&lt;/p&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;On retiendra l’usage d’un index b-tree sur une seule valeur et l’utilisation d’un index GIN sur plusieurs valeurs composantes.&lt;/p&gt;&#xA;&lt;h3 class=&#34;article-editor-heading&#34;&gt;Clôture de la première journée&lt;/h3&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;La journée s’est terminée par une présentation de la ville de Mons par Stefan Fercot qui était le contact local de l’événement, avec les différents sites incontournables de la ville : son beffroi, la grand-place, la Collégiale Sainte Waudru, le Doudou et son rituel et surtout le singe du Grand’Garde qui, à l’instar de notre Chouette dijonnaise, porte lui aussi bonheur si on touche sa tête de la main gauche ! &lt;/p&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;Comme à son accoutumée, la journée s&amp;rsquo;est terminée par un community event dans un lieu incontournable en Belgique… à savoir une brasserie &lt;img src=&#34;https://s.w.org/images/core/emoji/16.0.1/72x72/1f609.png&#34; alt=&#34;😉&#34; class=&#34;wp-smiley&#34; style=&#34;height: 1em; max-height: 1em;&#34; /&gt; pour un moment d’échange et de partage entre participants, speakers et organisateurs.&lt;/p&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;Après une première journée bien remplie, nous voilà prêts à attaquer de nouveau une deuxième journée de présentation avec au programme. &lt;/p&gt;&#xA;&lt;h3 class=&#34;article-editor-heading&#34;&gt;Anatomy of Table-Level Locks in PostgreSQL Par Gülçin Yıldırım Jelinek&lt;/h3&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;Présentation sur les locks, accès concurrents, les différents niveaux de blocage en fonction des actions, les différents niveaux d’isolation des transactions et comment faire pour éviter qu’une transaction bloque pendant plusieurs minutes, voire heures la base de données.&lt;/p&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;Si une transaction pose un verrou celui-ci est conservé tant que la transaction n’est pas terminée, il faut donc veiller à éviter de faire des modifications qui pose un verrou trop important en même temps qu’un gros traitement de données qui garderait un verrou potentiellement exclusif pendant un long moment et bloquerait les autres transactions.&lt;/p&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;Afin d’analyser et limiter cela, il est possible d’utiliser la vue pg_locks et surtout la fonction pg_blocking_pids() qui permet de voir quels autres processus bloquent le processus en question ainsi que de limiter le temps de lock via le paramètre lock_timeout, mais surtout de découper les instructions en plusieurs étapes pour ne pas mixer les types de lock et ne pas bloquer d’autres requêtes.&lt;/p&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;La présentation s’est terminée par l’usage de l’outil pgroll permettant des modifications de schéma PostgreSQL sûres, réversibles et sans temps d&amp;rsquo;arrêt.&lt;/p&gt;&#xA;&lt;h3 class=&#34;article-editor-heading&#34;&gt;Réglage automatisé de PostgreSQL : Explorer l&amp;rsquo;optimisation des paramètres serveur Par Luigi Nardi&lt;/h3&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;Présentation de DBtune qui permet d’automatiser l’optimisation de la configuration de base de données à travers le machine learning afin de tester plusieurs configurations et ajuster les paramètres pour trouver une configuration optimale pour la base en fonction de la machine, de ces métriques et de l’usage de celles-ci de façon dynamique.&lt;/p&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;Dans les exemples de configurations effectuées après plusieurs itérations de configuration une instance Amazon RDS permettait d’avoir des performances similaires de transactions par secondes quasi identiques entre une instance RDS m5.2xl avec DBtune et une instance de base RDS m5.4xl avec deux fois plus de ressources matérielles.&lt;/p&gt;&#xA;&lt;h3 class=&#34;article-editor-heading&#34;&gt;Table ronde &amp;#8211; Comment contribuer à PostgreSQL ?&lt;/h3&gt;&#xA;&lt;ul class=&#34;article-editor-bullet-list&#34;&gt;&#xA;&lt;li class=&#34;article-editor-list-item&#34;&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;L’importance de la traduction : certains pays où la documentation dans la langue locale n’est pas disponible et où les personnes parlent peu anglais.&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li class=&#34;article-editor-list-item&#34;&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;Découverte de bug et création de ticket et/ou proposition de correctif.&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li class=&#34;article-editor-list-item&#34;&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;Proposition de nouvelle feature. (plus complexe, car il faut prouver l&amp;rsquo;utilité de cette feature comparer à un correctif de bug) &lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li class=&#34;article-editor-list-item&#34;&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;Propager l’existence du réseau FR pour accueillir de nouveaux “adeptes” et montrer que la communauté est accessible et accueillante, comme par exemple par le biais de conférences ou table ronde comme celle-ci.&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h3 class=&#34;article-editor-heading&#34;&gt;Lightning Talks&lt;/h3&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;Quelques courtes présentations de 5 minutes sur différents sujets avec : &lt;/p&gt;&#xA;&lt;ul class=&#34;article-editor-bullet-list&#34;&gt;&#xA;&lt;li class=&#34;article-editor-list-item&#34;&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;présentation de l’outil pgSimload par Jean-Paul Argudo &lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li class=&#34;article-editor-list-item&#34;&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;les différents types d’index par Thibaut Madeleine&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li class=&#34;article-editor-list-item&#34;&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;le partitionnement par timestamp avec uuid v7 par Florent Jardin&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li class=&#34;article-editor-list-item&#34;&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;l’extension pg_tde et Percona Server par Yoann La Cancellera&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li class=&#34;article-editor-list-item&#34;&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;FOSS4G Belgium 2025 par Gael Kruwialis&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li class=&#34;article-editor-list-item&#34;&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;PostgreSQL Conference Europe 2025 par Marc Linster&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li class=&#34;article-editor-list-item&#34;&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;Agent IA et Postgres par Matt Cornillon&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h3 class=&#34;article-editor-heading&#34;&gt;Comment se débarrasser de Full Page Write ? Par Fabien Coelho&lt;/h3&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;Présentation sur la configuration de full page write afin de ne pas avoir de baisse de performance sur le nombre de transactions par seconde au moment des écritures, mais sa désactivation peut poser d’autres questions sur l&amp;rsquo;intégrité des données. Un paramètre à modifier avec prudence.&lt;/p&gt;&#xA;&lt;h3 class=&#34;article-editor-heading&#34;&gt;Voyage au centre des statistiques dans postgres Par Louise Leinweber&lt;/h3&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;Présentation de multiples solutions natives de Postgres permettant d’avoir des statistiques sur les différentes données et tables utilisées par le planificateur de requête. On peut retrouver ces données dans la vue système pg_stats qui contient par exemple pour une colonne d’une table les valeurs les plus fréquentes, la fréquence de ces données, la fréquence de valeur nul sur un champ…&lt;/p&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;À partir de ces statistiques, le planificateur de requête va opter pour le meilleur plan à partir d’estimation lié à ces statistiques. Si elles sont erronées en nombre de lignes estimées par rapport à la réalité cela peut entraîner de ne pas avoir utilisé le meilleur plan d’exécution.&lt;/p&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;On a pu aussi voir comment est calculée la sélectivité dans différents opérateurs ainsi que le fonctionnement de la combinaison de sélectivité et surtout qu’il était possible d’agir dessus en créant de nouvelles statistiques (&lt;code&gt;CREATE STATISTIC&lt;/code&gt; [&lt;a class=&#34;article-editor-link article-editor-link&#34; href=&#34;https://www.postgresql.org/docs/17/sql-createstatistics.html&#34; rel=&#34;noopener noreferrer&#34;&gt;https://www.postgresql.org/docs/17/sql-createstatistics.html&lt;/a&gt;]) afin d’influencer sur cela en fonction de cas d’usage spécifique s’il y a un lien entre différentes colonnes d’une même table et permettre à PostgreSQL d’avoir une bonne estimation du nombre de lignes, et ainsi répondre de façon plus rapide.&lt;/p&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;Il est possible de modifier la configuration de ces collectes de statistiques de manière globale, mais aussi par colonne / table.&lt;/p&gt;&#xA;&lt;h3 class=&#34;article-editor-heading&#34;&gt;Comment déplacer une base Postgres avec zéro downtime ? Par Naeva Mallet&lt;/h3&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;Cette conférence nous montrait un retour d’expérience chez “leboncoin”, sur comment déplacer un grand nombre de bases d’instances individuelles vers des instances mutualisées afin de réduire les coûts. L&amp;rsquo;objectif était d&amp;rsquo;automatiser le processus pour déplacer les bases en quelques commandes, et surtout avec le moins de downtime possible.&lt;/p&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;Pour cela la réplication logique a été utilisée en plusieurs étapes :&lt;/p&gt;&#xA;&lt;ul class=&#34;article-editor-bullet-list&#34;&gt;&#xA;&lt;li class=&#34;article-editor-list-item&#34;&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;Copie de la structure et clef primaire de la base source&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li class=&#34;article-editor-list-item&#34;&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;publication et souscription de la réplication logique&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li class=&#34;article-editor-list-item&#34;&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;attente copie des données&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li class=&#34;article-editor-list-item&#34;&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;création des index&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li class=&#34;article-editor-list-item&#34;&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;copie séquences et suppression de la réplication &lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;Cela a aussi abouti à la mise à disposition en open-source de ce script (&lt;a class=&#34;article-editor-link article-editor-link&#34; href=&#34;https://github.com/leboncoin/pg-logical-replication-helper&#34; rel=&#34;noopener noreferrer&#34;&gt;https://github.com/leboncoin/pg-logical-replication-helper&lt;/a&gt;) permettant la migration logique entre deux instances de base.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;article-editor-heading article-editor-content__has-focus&#34;&gt;Clôture&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure class=&#34;wp-block-image size-full&#34;&gt;&lt;img decoding=&#34;async&#34; width=&#34;512&#34; height=&#34;171&#34; src=&#34;https://blog.atolcd.com/wp-content/uploads/2025/06/pg-fays-2.png&#34; alt=&#34;&#34; class=&#34;wp-image-5980&#34; srcset=&#34;https://blog.atolcd.com/wp-content/uploads/2025/06/pg-fays-2.png 512w, https://blog.atolcd.com/wp-content/uploads/2025/06/pg-fays-2-300x100.png 300w&#34; sizes=&#34;(max-width: 512px) 100vw, 512px&#34; /&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;p class=&#34;article-editor-paragraph&#34;&gt;Après ces deux jours intensifs de présentation, place aux remerciements pour les orateurs, sponsors, bénévoles de l’association Postgresql FR, participants et graphiste de cette belle affiche. Beaucoup d’informations emmagasinées, beaucoup d&amp;rsquo;échanges enrichissants avec les organisateurs, participants et orateurs de l’événement. C’est toujours un réel plaisir de pouvoir échanger avec les membres de la communauté Postgres.&lt;/p&gt;&#xA;&lt;p class=&#34;article-editor-paragraph article-editor-content__has-focus&#34;&gt;Et un remerciement particulier pour les locaux de l’étape Stephan et Leila qui nous ont fait découvrir leur magnifique ville de Mons et la Belgique. &lt;/p&gt;&#xA;&#xA;&#xA;&lt;p&gt;Cet article &lt;a href=&#34;https://blog.atolcd.com/retour-sur-le-pg-day-france-2025/&#34;&gt;Retour sur le PG Day France 2025&lt;/a&gt; est apparu en premier sur &lt;a href=&#34;https://blog.atolcd.com&#34;&gt;Atol Open Blog&lt;/a&gt;.&lt;/p&gt;&#xA;</content>
    <link href="https://blog.atolcd.com/retour-sur-le-pg-day-france-2025/?utm_source=rss&amp;utm_medium=rss&amp;utm_campaign=retour-sur-le-pg-day-france-2025" rel="alternate"></link>
    <summary type="html">&lt;p&gt;Les 3 et 4 juin derniers, la communauté francophone de PostgreSQL s’est retrouvée à Mons, en Belgique, à l’occasion de l’édition 2025 du PG Day France. Chaque année depuis 2008, cet événement itinérant investit une nouvelle ville pour faire vivre... &lt;a class=&#34;more-link&#34; href=&#34;https://blog.atolcd.com/retour-sur-le-pg-day-france-2025/&#34;&gt;Continue Reading &amp;#8594;&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;Cet article &lt;a href=&#34;https://blog.atolcd.com/retour-sur-le-pg-day-france-2025/&#34;&gt;Retour sur le PG Day France 2025&lt;/a&gt; est apparu en premier sur &lt;a href=&#34;https://blog.atolcd.com&#34;&gt;Atol Open Blog&lt;/a&gt;.&lt;/p&gt;&#xA;</summary>
    <author>
      <name>Romy Fuentes</name>
    </author>
  </entry>
  <entry>
    <title>[Infographie] PostgreSQL</title>
    <updated>2021-02-11T11:23:13Z</updated>
    <id>tag:blog.atolcd.com,2021-02-11:/infographie-postgresql/</id>
    <content type="html">&#xA;&lt;p&gt;PostgreSQL est un SGBD que nous affectionnons particulièrement chez Atol CD ! Retrouvez dans cette infographie quelques caractéristiques techniques, des chiffres-clé, son histoire mais aussi pourquoi nous l&amp;rsquo;aimons et notre Top5 des fonctionnalités côté développement.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure class=&#34;wp-block-gallery columns-1 is-cropped wp-block-gallery-1 is-layout-flex wp-block-gallery-is-layout-flex&#34;&gt;&lt;ul class=&#34;blocks-gallery-grid&#34;&gt;&lt;li class=&#34;blocks-gallery-item&#34;&gt;&lt;figure&gt;&lt;img decoding=&#34;async&#34; width=&#34;866&#34; height=&#34;2560&#34; src=&#34;https://blog.atolcd.com/wp-content/uploads/2021/02/infographie_PostgreSQL-scaled.jpg&#34; alt=&#34;&#34; data-id=&#34;4477&#34; data-full-url=&#34;https://blog.atolcd.com/wp-content/uploads/2021/02/infographie_PostgreSQL-scaled.jpg&#34; data-link=&#34;https://blog.atolcd.com/infographie-postgresql/infographie_postgresql/&#34; class=&#34;wp-image-4477&#34; srcset=&#34;https://blog.atolcd.com/wp-content/uploads/2021/02/infographie_PostgreSQL-scaled.jpg 866w, https://blog.atolcd.com/wp-content/uploads/2021/02/infographie_PostgreSQL-101x300.jpg 101w, https://blog.atolcd.com/wp-content/uploads/2021/02/infographie_PostgreSQL-346x1024.jpg 346w, https://blog.atolcd.com/wp-content/uploads/2021/02/infographie_PostgreSQL-768x2271.jpg 768w, https://blog.atolcd.com/wp-content/uploads/2021/02/infographie_PostgreSQL-520x1536.jpg 520w, https://blog.atolcd.com/wp-content/uploads/2021/02/infographie_PostgreSQL-693x2048.jpg 693w, https://blog.atolcd.com/wp-content/uploads/2021/02/infographie_PostgreSQL-600x1774.jpg 600w, https://blog.atolcd.com/wp-content/uploads/2021/02/infographie_PostgreSQL-945x2794.jpg 945w&#34; sizes=&#34;(max-width: 866px) 100vw, 866px&#34; /&gt;&lt;/figure&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/figure&gt;&#xA;&lt;p&gt;Cet article &lt;a href=&#34;https://blog.atolcd.com/infographie-postgresql/&#34;&gt;[Infographie] PostgreSQL&lt;/a&gt; est apparu en premier sur &lt;a href=&#34;https://blog.atolcd.com&#34;&gt;Atol Open Blog&lt;/a&gt;.&lt;/p&gt;&#xA;</content>
    <link href="https://blog.atolcd.com/infographie-postgresql/?utm_source=rss&amp;utm_medium=rss&amp;utm_campaign=infographie-postgresql" rel="alternate"></link>
    <summary type="html">&lt;p&gt;PostgreSQL est un SGBD que nous affectionnons particulièrement chez Atol CD ! Retrouvez dans cette infographie quelques caractéristiques techniques, des chiffres-clé, son histoire mais aussi pourquoi nous l&amp;#8217;aimons et notre Top5 des fonctionnalités côté développement.&lt;/p&gt;&#xA;&lt;p&gt;Cet article &lt;a href=&#34;https://blog.atolcd.com/infographie-postgresql/&#34;&gt;[Infographie] PostgreSQL&lt;/a&gt; est apparu en premier sur &lt;a href=&#34;https://blog.atolcd.com&#34;&gt;Atol Open Blog&lt;/a&gt;.&lt;/p&gt;&#xA;</summary>
    <author>
      <name>Romy Fuentes</name>
    </author>
  </entry>
  <entry>
    <title>Sortie de PostgreSQL 13</title>
    <updated>2020-09-24T05:54:57Z</updated>
    <id>tag:blog.atolcd.com,2020-09-24:/sortie-de-postgresql-13/</id>
    <content type="html">&#xA;&lt;p&gt;&lt;span style=&#34;font-weight: 400;&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; class=&#34;alignnone size-full wp-image-4130&#34; src=&#34;https://blog.atolcd.com/wp-content/uploads/2020/09/pg13.jpg&#34; alt=&#34;&#34; width=&#34;960&#34; height=&#34;540&#34; srcset=&#34;https://blog.atolcd.com/wp-content/uploads/2020/09/pg13.jpg 960w, https://blog.atolcd.com/wp-content/uploads/2020/09/pg13-300x169.jpg 300w, https://blog.atolcd.com/wp-content/uploads/2020/09/pg13-768x432.jpg 768w, https://blog.atolcd.com/wp-content/uploads/2020/09/pg13-600x338.jpg 600w, https://blog.atolcd.com/wp-content/uploads/2020/09/pg13-945x532.jpg 945w&#34; sizes=&#34;auto, (max-width: 960px) 100vw, 960px&#34; /&gt;Malgré des actualités plutôt moroses au Botswana concernant nos chers éléphants, il y en a un qui se porte bien et est encore plus fort à savoir PostgreSQL qui sort en version 13 stable ce jeudi 24 septembre 2020. &lt;/span&gt;&lt;/p&gt;&#xA;&lt;p&gt;&lt;span style=&#34;font-weight: 400;&#34;&gt;Après seulement 3 versions Bêta et une RC le voilà dans les starting blocks pour débarquer sur vos serveurs ! Et comme à chaque nouvelle version son&lt;/span&gt; &lt;span style=&#34;font-weight: 400;&#34;&gt;lot de nouveautés&lt;/span&gt;&lt;span style=&#34;font-weight: 400;&#34;&gt;.&lt;/span&gt;&lt;/p&gt;&#xA;&lt;p&gt;&lt;span style=&#34;font-weight: 400;&#34;&gt;Un petit rappel qui peut parfois éviter bien des catastrophes, si vous avez prévu de migrer vers PostgreSQL 13, vous devriez jeter un oeil sur &lt;a href=&#34;https://www.postgresql.org/docs/13/release-13.html#id-1.11.6.5.4&#34;&gt;les potentielles incompatibilités avec les précédentes versions&lt;/a&gt;  (et aussi sur les versions intermédiaires si vous faite un gap de plusieurs versions d&amp;rsquo;un coup), il est toujours préférable d&amp;rsquo;identifier ces légers changements en amont plutôt qu&amp;rsquo;une fois en production. Mais rassurez-vous, dans cette version pas de quoi freiner significativement une migration.&lt;/span&gt;&lt;/p&gt;&#xA;&lt;h1&gt;Partitionnement&lt;/h1&gt;&#xA;&lt;p&gt;Des améliorations sont ajoutées sur le partitionnement de tables, tant au niveau performance avec l&amp;rsquo;ajout de cas où une jointure directe entre partition peut être utilisée dans une requête, mais aussi de fonctionnalités telles que  la gestion des triggers avec le support de la clause BEFORE ou bien encore la réplication logique sans avoir besoin de publier chaque partition.&lt;/p&gt;&#xA;&lt;h1&gt;Index&lt;/h1&gt;&#xA;&lt;p&gt;Là aussi des améliorations de performances mais aussi des gains d&amp;rsquo;espace disque sur les index B-tree surtout pour ceux contenant des doublons, mais si vous passez par un pg_upgrade il voudra passer par un reindex pour bénéficier de ces changements.&lt;/p&gt;&#xA;&lt;h1&gt;Planificateur&lt;/h1&gt;&#xA;&lt;p&gt;Le planificateur de requête PostgreSQL a lui aussi eu le droit à quelques améliorations notamment au niveau des statistiques ce qui peut améliorer les plans d&amp;rsquo;exécution et donc les performances.&lt;/p&gt;&#xA;&lt;h1&gt;Performance générale&lt;/h1&gt;&#xA;&lt;p&gt;Les performances ne sont pas en reste dans cette nouvelle version, avec l&amp;rsquo;ajout du &lt;span style=&#34;font-weight: 400;&#34;&gt;tri incrémentiel ce qui accélère le tri des données dans certains cas,  sur les agrégations de hachage qui peuvent désormais utiliser le stockage sur disque dans le cadre de grands ensembles d&amp;rsquo;agrégation, sur la conversion de type entier vers texte.&lt;/span&gt;&lt;/p&gt;&#xA;&lt;h1&gt;Vues système&lt;/h1&gt;&#xA;&lt;p&gt;De nouvelles vues système font leur apparition :&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.postgresql.org/docs/13/progress-reporting.html#BASEBACKUP-PROGRESS-REPORTING&#34;&gt;pg_stat_progress_basebackup &lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.postgresql.org/docs/13/progress-reporting.html#ANALYZE-PROGRESS-REPORTING&#34;&gt;pg_stat_progress_analyze &lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.postgresql.org/docs/13/view-pg-shmem-allocations.html&#34;&gt;pg_shmem_allocations &lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.postgresql.org/docs/13/monitoring-stats.html#MONITORING-PG-STAT-SLRU-VIEW&#34;&gt;pg_stat_slru&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;la vue &lt;a href=&#34;https://www.postgresql.org/docs/13/monitoring-stats.html#PG-STAT-ACTIVITY-VIEW&#34;&gt;pg_stat_activity&lt;/a&gt; se voit elle ajoutée une colonne leader_pid ce qui permet de retrouver rapidement tous les processus impliqués dans une requête parallèle.&lt;/p&gt;&#xA;&lt;h1&gt;Fonctionnalités&lt;/h1&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;ajout de la fonctionnalité &lt;a href=&#34;https://www.postgresql.org/docs/13/sql-select.html#SQL-LIMIT&#34;&gt;FETCH FIRST WITH TIES&lt;/a&gt; (vous trouverez &lt;a href=&#34;http://pgphil.ovh/topn_13_beta_01.php&#34;&gt;ici&lt;/a&gt; un exemple)&lt;/li&gt;&#xA;&lt;li&gt;Ajout de la fonction gen_random_uuid() utilisable sans activer d’extensions&lt;/li&gt;&#xA;&lt;li&gt;Ajout de la possibilité de renommer une colonne d&amp;rsquo;une vue :&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;pre class=&#34;crayon-plain-tag&#34;&gt;ALTER VIEW [ IF EXISTS ] name RENAME [ COLUMN ] column_name TO new_column_name&lt;/pre&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Ajout de la fonction .datetime() dans les jsonpath pour convertir automatique une chaîne en date ou horodatage&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h1&gt;Client psql&lt;/h1&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Ajout de nouvelles commandes pour afficher la description de classe d&amp;rsquo;opérateur et famille d&amp;rsquo;opérateur&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;a class=&#34;link&#34; title=&#34;Meta-Commands&#34; href=&#34;https://www.postgresql.org/docs/13/app-psql.html#APP-PSQL-META-COMMANDS&#34;&gt;&lt;code class=&#34;literal&#34;&gt;\dAc&lt;/code&gt;&lt;/a&gt;, &lt;code class=&#34;literal&#34;&gt;\dAf&lt;/code&gt;, &lt;code class=&#34;literal&#34;&gt;\dAo&lt;/code&gt;, et &lt;code class=&#34;literal&#34;&gt;\dAp&lt;/code&gt;.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;Ajout du statut de la transaction dans le prompt &lt;br /&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;* dans une transaction&lt;/li&gt;&#xA;&lt;li&gt;! dans un échec de transaction&lt;/li&gt;&#xA;&lt;li&gt;? pour un état indéterminé de la transaction&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h1&gt;Administration&lt;/h1&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Ajout de la capacité de la commande VACUUM à traiter des index en parallèle&lt;/li&gt;&#xA;&lt;li&gt;la commande reindexdb peut aussi paralléliser les tâches&lt;/li&gt;&#xA;&lt;li&gt;introduction de la notion de « trusted extension » qui permet à un super utilisateur de définir les extensions qu’un utilisateur a le droit d&amp;rsquo;installer dans sa base de données en ayant le droit CREATE.&lt;/li&gt;&#xA;&lt;li&gt;Ajout pour pg_dump de l&amp;rsquo;option &amp;#8211;include-foreign-data pour inclure dans la sauvegarde les données de serveurs distants&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;La liste des nouveautés dans cette version est grande, toutes les nouveautés n&amp;rsquo;ont pas été abordées mais vous pouvez bien sur les retrouver dans la &lt;a href=&#34;https://www.postgresql.org/docs/13/release-13.html&#34;&gt;note de version&lt;/a&gt;. Le focus a surtout été fait sur le côté utilisateur plutôt qu&amp;rsquo;administrateur de PostgreSQL.&lt;/p&gt;&#xA;&lt;p&gt; &lt;/p&gt;&#xA;&lt;p&gt; &lt;/p&gt;&#xA;&lt;p&gt; &lt;/p&gt;&#xA;&lt;p&gt; &lt;/p&gt;&#xA;&lt;p&gt; &lt;/p&gt;&#xA;&lt;p&gt;Cet article &lt;a href=&#34;https://blog.atolcd.com/sortie-de-postgresql-13/&#34;&gt;Sortie de PostgreSQL 13&lt;/a&gt; est apparu en premier sur &lt;a href=&#34;https://blog.atolcd.com&#34;&gt;Atol Open Blog&lt;/a&gt;.&lt;/p&gt;&#xA;</content>
    <link href="https://blog.atolcd.com/sortie-de-postgresql-13/?utm_source=rss&amp;utm_medium=rss&amp;utm_campaign=sortie-de-postgresql-13" rel="alternate"></link>
    <summary type="html">&lt;p&gt;Malgré des actualités plutôt moroses au Botswana concernant nos chers éléphants, il y en a un qui se porte bien et est encore plus fort à savoir PostgreSQL qui sort en version 13 stable ce jeudi 24 septembre 2020.  Après... &lt;a class=&#34;more-link&#34; href=&#34;https://blog.atolcd.com/sortie-de-postgresql-13/&#34;&gt;Continue Reading &amp;#8594;&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;Cet article &lt;a href=&#34;https://blog.atolcd.com/sortie-de-postgresql-13/&#34;&gt;Sortie de PostgreSQL 13&lt;/a&gt; est apparu en premier sur &lt;a href=&#34;https://blog.atolcd.com&#34;&gt;Atol Open Blog&lt;/a&gt;.&lt;/p&gt;&#xA;</summary>
    <author>
      <name>Romy Fuentes</name>
    </author>
  </entry>
  <entry>
    <title>Sortie de PostgreSQL 11</title>
    <updated>2018-10-19T13:12:39Z</updated>
    <id>tag:blog.atolcd.com,2018-10-19:/sortie-de-postgresql-11/</id>
    <content type="html">&lt;p&gt;Après seulement une release candidate (mais auparavant 4 version bêta), PostgreSQL 11 vient de sortir!!!! Et comme à chaque nouvelle version son lot de nouveautés que nous allons essayer de passer rapidement en revue.&lt;/p&gt;&#xA;&lt;p&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; class=&#34;aligncenter size-full wp-image-3169&#34; src=&#34;https://blog.atolcd.com/wp-content/uploads/2018/10/PostGresql11.jpg&#34; alt=&#34;&#34; width=&#34;826&#34; height=&#34;540&#34; srcset=&#34;https://blog.atolcd.com/wp-content/uploads/2018/10/PostGresql11.jpg 826w, https://blog.atolcd.com/wp-content/uploads/2018/10/PostGresql11-300x196.jpg 300w, https://blog.atolcd.com/wp-content/uploads/2018/10/PostGresql11-768x502.jpg 768w, https://blog.atolcd.com/wp-content/uploads/2018/10/PostGresql11-600x392.jpg 600w&#34; sizes=&#34;auto, (max-width: 826px) 100vw, 826px&#34; /&gt;&lt;/p&gt;&#xA;&lt;h2&gt;Amélioration de la parallélisation&lt;/h2&gt;&#xA;&lt;p&gt;Quoi de mieux que de commencer le tour des nouveautés par un sujet que l&amp;rsquo;on a abordé lors du &lt;a href=&#34;https://blog.atolcd.com/conference-la-parallelisation-au-service-de-loptimisation/&#34;&gt;PG Day France 2018&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;PostgreSQL 11 va encore plus loin dans la parallélisation avec :&lt;/p&gt;&#xA;&lt;ul style=&#34;list-style-type: disc;&#34;&gt;&#xA;&lt;li style=&#34;list-style-type: none;&#34;&gt;&#xA;&lt;ul style=&#34;list-style-type: disc;&#34;&gt;&#xA;&lt;li&gt;Création d&amp;rsquo;index B-tree en parallèle&lt;/li&gt;&#xA;&lt;li&gt;Parallélisation des UNION ALL&lt;/li&gt;&#xA;&lt;li&gt;Amélioration du Parallel hash join (paralléliser le remplissage d’une seule table de hachage, partagée) et parallelized sequential scans&lt;/li&gt;&#xA;&lt;li&gt;Parallélisation sur la création de vue matérialisée et table à partir des résultats d&amp;rsquo;une requête&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;&lt;/p&gt;&lt;pre class=&#34;crayon-plain-tag&#34;&gt;CREATE TABLE .. AS, SELECT INTO et CREATE MATERIALIZED VIEW.&lt;/pre&gt;&lt;p&gt;&lt;/p&gt;&#xA;&lt;ul style=&#34;list-style-type: disc;&#34;&gt;&#xA;&lt;li&gt;Ajout d&amp;rsquo;un paramètre de configuration du serveur « parallel_leader_participation » qui permet de contrôler si le processus leader participe à l&amp;rsquo;exécution des sous plans d&amp;rsquo;exécution&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h2&gt;Amélioration du partitionnement&lt;/h2&gt;&#xA;&lt;ul style=&#34;list-style-type: disc;&#34;&gt;&#xA;&lt;li style=&#34;list-style-type: none;&#34;&gt;&#xA;&lt;ul style=&#34;list-style-type: disc;&#34;&gt;&#xA;&lt;li&gt;La possibilité de partitionner une table par hashage de clé (en plus des autres)&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;&lt;/p&gt;&lt;pre class=&#34;crayon-plain-tag&#34;&gt;CREATE TABLE hash1 (col1 NUMERIC, col2 VARCHAR(10)) PARTITION BY HASH(col1);&#xD;&#xA;CREATE TABLE hash1a PARTITION OF hash1 FOR VALUES WITH (MODULUS 4, REMAINDER 0) ;&#xD;&#xA;CREATE TABLE hash1b PARTITION OF hash1 FOR VALUES WITH (MODULUS 4, REMAINDER 1) ;&#xD;&#xA;CREATE TABLE hash1c PARTITION OF hash1 FOR VALUES WITH (MODULUS 4, REMAINDER 2) ;&#xD;&#xA;CREATE TABLE hash1d PARTITION OF hash1 FOR VALUES WITH (MODULUS 4, REMAINDER 3) ;&lt;/pre&gt;&lt;p&gt;&lt;/p&gt;&#xA;&lt;ul style=&#34;list-style-type: disc;&#34;&gt;&#xA;&lt;li style=&#34;list-style-type: none;&#34;&gt;&#xA;&lt;ul style=&#34;list-style-type: disc;&#34;&gt;&#xA;&lt;li&gt;Ajout possible d&amp;rsquo;une partition par défaut pour les données ne correspondant à aucune partition&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;&lt;/p&gt;&lt;pre class=&#34;crayon-plain-tag&#34;&gt;CREATE TABLE table1d PARTITION OF table1 DEFAULT;&lt;/pre&gt;&lt;p&gt;&lt;/p&gt;&#xA;&lt;ul style=&#34;list-style-type: disc;&#34;&gt;&#xA;&lt;li style=&#34;list-style-type: none;&#34;&gt;&#xA;&lt;ul style=&#34;list-style-type: disc;&#34;&gt;&#xA;&lt;li&gt;La possibilité de créer des clés primaires, clés étrangères, index et triggers qui seront automatiquement applicables sur l&amp;rsquo;ensemble des partitions&lt;/li&gt;&#xA;&lt;li&gt;Support du changement automatique de partition en cas de mise à jour de la clé de partitionnement&lt;/li&gt;&#xA;&lt;li&gt;Amélioration des performances lors des SELECT sur la lecture des partitions&lt;/li&gt;&#xA;&lt;li&gt;Support des upsert sur les tables partitionnées&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;&lt;/p&gt;&lt;pre class=&#34;crayon-plain-tag&#34;&gt;INSERT  INTO  tablep1 (col1, col2) &#xD;&#xA;VALUES  (100,  &#39;update&#39;) &#xD;&#xA;ON  CONFLICT ON CONSTRAINT tablep1_pkey &#xD;&#xA;DO UPDATE SET col2=&#39;update&#39; ;&lt;/pre&gt;&lt;p&gt;&lt;/p&gt;&#xA;&lt;h2&gt;Gestion des transactions dans les procédures stockées&lt;/h2&gt;&#xA;&lt;p&gt;PostgreSQL 11 introduit la possibilité de créer des procédures (en PL/pgSQL, PL/Perl, PL/Python, et PL/Tcl). Depuis de nombreuses années, il est possible dans PostgreSQL de créer des fonctions et bien ici ça y ressemble fortement, sauf que l&amp;rsquo;on ne retourne pas de résultats et que l&amp;rsquo;on peut gérer les transactions !&lt;/p&gt;&lt;pre class=&#34;crayon-plain-tag&#34;&gt;CREATE PROCEDURE transaction_test1()&#xD;&#xA;LANGUAGE plpgsql&#xD;&#xA;AS $$&#xD;&#xA;BEGIN&#xD;&#xA;  FOR i IN 0..9 LOOP&#xD;&#xA;    INSERT INTO table1 (col1) VALUES (i) ;&#xD;&#xA;    IF i % 2 = 0 THEN&#xD;&#xA;      COMMIT;&#xD;&#xA;    ELSE&#xD;&#xA;      ROLLBACK;&#xD;&#xA;    END IF;&#xD;&#xA;  END LOOP;&#xD;&#xA;END;&#xD;&#xA;$$;&lt;/pre&gt;&lt;p&gt;L&amp;rsquo;exécution de ces procédures se fait en utilisant la commande CALL&lt;/p&gt;&lt;pre class=&#34;crayon-plain-tag&#34;&gt;CALL transaction_test1();&lt;/pre&gt;&lt;p&gt;&lt;/p&gt;&#xA;&lt;h2&gt;Compilation JIT&lt;/h2&gt;&#xA;&lt;p&gt;PostgreSQL 11 introduit le support de la compilation Just-in-Time (JIT) pour optimiser l’exécution de code et d’autres opérations. Utilisant des composants du projet LLVM, l’introduction de JIT dans PostgreSQL accélère les requêtes utilisant des expressions, listes, agrégats, projections, ainsi que certaines opérations internes.&lt;/p&gt;&#xA;&lt;p&gt;Pour pouvoir utiliser la compilation JIT, vous devrez installer la dépendance LLVM puis activer la compilation JIT soit dans le fichier de configuration (jit = on), soit durant votre session en exécutant SET jit = on.&lt;/p&gt;&#xA;&lt;p&gt;La compilation JIT bénéficie surtout aux requêtes de longue durée et limitées par le processeur. Ce seront souvent des requêtes analytiques (OLAP). Pour les requêtes courtes, le surcoût apporté par la compilation JIT sera souvent supérieur au temps qu&amp;rsquo;elle permet de gagner.&lt;/p&gt;&#xA;&lt;h2&gt;Améliorations générales SQL&lt;/h2&gt;&#xA;&lt;ul style=&#34;list-style-type: disc;&#34;&gt;&#xA;&lt;li style=&#34;list-style-type: none;&#34;&gt;&#xA;&lt;ul style=&#34;list-style-type: disc;&#34;&gt;&#xA;&lt;li&gt;Support de toutes les clauses (SQL:2011) dans les fonctions de fenêtrage ce qui permet maintenant l’utilisation de RANGE dans des clauses PRECEDING/FOLLOWING, GROUPS ou d’exclusion&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;&lt;/p&gt;&lt;pre class=&#34;crayon-plain-tag&#34;&gt;WINDOW window_name AS ( &#xD;&#xA;  [ PARTITION BY expression [, ...] ]&#xD;&#xA;  [ ORDER BY expression [ ASC | DESC | USING operator ] [ NULLS { FIRST | LAST } ] [, ...] ]&#xD;&#xA;  [ frame_clause ]&#xD;&#xA;)&#xD;&#xA;&#xD;&#xA;frame_clause :&#xD;&#xA;{ RANGE | ROWS | GROUPS } frame_start [ frame_exclusion ]&#xD;&#xA;{ RANGE | ROWS | GROUPS } BETWEEN frame_start AND frame_end [ frame_exclusion ]&#xD;&#xA;&#xD;&#xA;frame_start / frame_end :&#xD;&#xA;&#xD;&#xA;UNBOUNDED PRECEDING&#xD;&#xA;offset PRECEDING&#xD;&#xA;CURRENT ROW&#xD;&#xA;offset FOLLOWING&#xD;&#xA;UNBOUNDED FOLLOWING&#xD;&#xA;&#xD;&#xA;frame_exclusion :&#xD;&#xA;&#xD;&#xA;EXCLUDE CURRENT ROW&#xD;&#xA;EXCLUDE GROUP&#xD;&#xA;EXCLUDE TIES&#xD;&#xA;EXCLUDE NO OTHERS&lt;/pre&gt;&lt;p&gt;&lt;/p&gt;&#xA;&lt;ul style=&#34;list-style-type: disc;&#34;&gt;&#xA;&lt;li style=&#34;list-style-type: none;&#34;&gt;&#xA;&lt;ul style=&#34;list-style-type: disc;&#34;&gt;&#xA;&lt;li&gt;Ajout de fonctions de hash sha-2 : sha224(), sha256(), sha384() et sha512()&lt;/li&gt;&#xA;&lt;li&gt;Ajout de fonctions de recherche plein texte : json(b)_to_tsvector() et websearch_to_tsquery()&lt;/li&gt;&#xA;&lt;li&gt;Ajout de l&amp;rsquo;opérateur ^@ identique à LIKE &amp;lsquo;mot%&amp;rsquo; mais plus efficace sur un index b-tree&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;&lt;/p&gt;&lt;pre class=&#34;crayon-plain-tag&#34;&gt;text ^@ text&lt;/pre&gt;&lt;p&gt;&lt;/p&gt;&#xA;&lt;ul style=&#34;list-style-type: disc;&#34;&gt;&#xA;&lt;li style=&#34;list-style-type: none;&#34;&gt;&#xA;&lt;ul style=&#34;list-style-type: disc;&#34;&gt;&#xA;&lt;li&gt;Amélioration des index avec l&amp;rsquo;ajout du mot clef INCLUDE, qui permet d&amp;rsquo;indiquer une liste de colonnes qui seront incluses dans l&amp;rsquo;index comme des colonnes non clés. L&amp;rsquo;ajout de colonnes dans la création d&amp;rsquo;index permet alors l&amp;rsquo;utilisation de parcours d&amp;rsquo;index couvrants.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;&lt;/p&gt;&lt;pre class=&#34;crayon-plain-tag&#34;&gt;CREATE [ UNIQUE ] INDEX [ CONCURRENTLY ] [ [ IF NOT EXISTS ] nom ] ON [ ONLY ] nom_table [ USING méthode ]&#xD;&#xA;    ( { nom_colonne | ( expression ) } [ COLLATE collation ] [ classeop ] [ ASC | DESC ] [ NULLS { FIRST | LAST } ] [, ...] )&#xD;&#xA;    [ INCLUDE ( nom_colonne [, ...] ) ]&#xD;&#xA;    [ WITH ( parametre_stockage = valeur [, ... ] ) ]&#xD;&#xA;    [ TABLESPACE nom_espacelogique ]&#xD;&#xA;    [ WHERE prédicat ]&lt;/pre&gt;&lt;p&gt;&lt;/p&gt;&#xA;&lt;ul style=&#34;list-style-type: disc;&#34;&gt;&#xA;&lt;li&gt;Amélioration de l’ordre ALTER TABLE .. ADD COLUMN .. DEFAULT .. avec une valeur par défaut non NULL n’a plus besoin de réécrire entièrement la table lors de son exécution, ce qui entraîne une grosse amélioration des performances.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h2&gt;Authentification&lt;/h2&gt;&#xA;&lt;ul style=&#34;list-style-type: disc;&#34;&gt;&#xA;&lt;li&gt;Ajout de l&amp;rsquo;authentification LDAP, mais celle ci n&amp;rsquo;est utilisée que pour valider les paires nom d&amp;rsquo;utilisateur/mot de passe. De ce fait, pour pouvoir utiliser LDAP comme méthode d&amp;rsquo;authentification, l&amp;rsquo;utilisateur doit préalablement exister dans la base.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h2&gt;psql&lt;/h2&gt;&#xA;&lt;p&gt;Le client psql évolue lui aussi :&lt;/p&gt;&#xA;&lt;ul style=&#34;list-style-type: disc;&#34;&gt;&#xA;&lt;li style=&#34;list-style-type: none;&#34;&gt;&#xA;&lt;ul style=&#34;list-style-type: disc;&#34;&gt;&#xA;&lt;li&gt;Ajout des commandes « quit » et « exit » dans le client psql&amp;#8230; (fini les personnes prisent de panique pour sortir de leur terminal ??? )&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://media.giphy.com/media/xTk9ZBWrma4PIC9y4E/giphy.gif&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;&#xA;&lt;ul style=&#34;list-style-type: disc;&#34;&gt;&#xA;&lt;li style=&#34;list-style-type: none;&#34;&gt;&#xA;&lt;ul style=&#34;list-style-type: disc;&#34;&gt;&#xA;&lt;li&gt;Ajout de la commande \gdesc pour afficher les noms et types de colonnes du résultat de la requête&lt;/li&gt;&#xA;&lt;li&gt;Ajout de variables pour les erreurs et activités des requêtes ERROR, SQLSTATE, ROW_COUNT, LAST_ERROR_MESSAGE, and LAST_ERROR_SQLSTATE.&lt;/li&gt;&#xA;&lt;li&gt;Ajout de la possibilité de tester l&amp;rsquo;existence d&amp;rsquo;une variable par exemple dans un if&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;&lt;/p&gt;&lt;pre class=&#34;crayon-plain-tag&#34;&gt;\if :{?variable_name}&lt;/pre&gt;&lt;p&gt;&lt;/p&gt;&#xA;&lt;ul style=&#34;list-style-type: disc;&#34;&gt;&#xA;&lt;li&gt;Amélioration de la complétion dans l&amp;rsquo;écriture de requêtes&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;En dehors de ces nouveautés en terme d&amp;rsquo;utilisation, cette nouvelle version apporte aussi des améliorations de performance et d&amp;rsquo;utilisation de mémoire.&lt;/p&gt;&#xA;&lt;p&gt;Et voilà, nous avons fini notre petit tour rapide des nouveautés de postgreSQL 11, mais ne vous inquiétez pas une version 12 est déjà en préparation pour le troisième trimestre 2019.&lt;/p&gt;&#xA;&lt;p&gt;Cet article &lt;a href=&#34;https://blog.atolcd.com/sortie-de-postgresql-11/&#34;&gt;Sortie de PostgreSQL 11&lt;/a&gt; est apparu en premier sur &lt;a href=&#34;https://blog.atolcd.com&#34;&gt;Atol Open Blog&lt;/a&gt;.&lt;/p&gt;&#xA;</content>
    <link href="https://blog.atolcd.com/sortie-de-postgresql-11/?utm_source=rss&amp;utm_medium=rss&amp;utm_campaign=sortie-de-postgresql-11" rel="alternate"></link>
    <summary type="html">&lt;p&gt;Après seulement une release candidate (mais auparavant 4 version bêta), PostgreSQL 11 vient de sortir!!!! Et comme à chaque nouvelle version son lot de nouveautés que nous allons essayer de passer rapidement en revue. Amélioration de la parallélisation Quoi de... &lt;a class=&#34;more-link&#34; href=&#34;https://blog.atolcd.com/sortie-de-postgresql-11/&#34;&gt;Continue Reading &amp;#8594;&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;Cet article &lt;a href=&#34;https://blog.atolcd.com/sortie-de-postgresql-11/&#34;&gt;Sortie de PostgreSQL 11&lt;/a&gt; est apparu en premier sur &lt;a href=&#34;https://blog.atolcd.com&#34;&gt;Atol Open Blog&lt;/a&gt;.&lt;/p&gt;&#xA;</summary>
    <author>
      <name>Romy Fuentes</name>
    </author>
  </entry>
  <entry>
    <title>Pimp My PostgreSQL</title>
    <updated>2018-01-26T11:07:23Z</updated>
    <id>tag:blog.atolcd.com,2018-01-26:/pimp-my-postgresql/</id>
    <content type="html">&lt;p&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; class=&#34;alignright wp-image-2934&#34; src=&#34;https://blog.atolcd.com/wp-content/uploads/2018/01/pimp-my-postgresql.png&#34; alt=&#34;&#34; width=&#34;491&#34; height=&#34;290&#34; /&gt;Une question qui se pose souvent après l&amp;rsquo;installation d&amp;rsquo;une instance postgreSQL, c&amp;rsquo;est comment configurer ce fichier postgresql.conf. Dans le doute souvent, beaucoup de personnes conservent la configuration par défaut, ce qui ne va pas poser vraiment de problème pour une utilisation légère. Mais si on a une instance postgreSQL avec postGIS et des millions d&amp;rsquo;enregistrements, cela va rapidement se trouver problématique si on laisse les valeurs par défaut&amp;#8230;&lt;/p&gt;&#xA;&lt;p&gt;Pour les initiés qui installent régulièrement de nouvelles instances postgreSQL, se plonger dans les plus de 600 lignes du fichier de configuration par défaut ne les effraie pas. Mais on n&amp;rsquo;installe pas forcément tous les jours un nouveau serveur avec des caractéristiques différentes. Il faut donc soit se replonger pour une centième fois dans la documentation de postgres pour se rappeler à notre bonne mémoire les différents paramètres et les valeurs à adapter en fonction de la ram, disque, cpu&amp;#8230;&lt;/p&gt;&#xA;&lt;p&gt;En plus de devoir se rappeler les &lt;strong&gt;paramètres à modifier,&lt;/strong&gt; il faut aussi connaître les &lt;strong&gt;règles de calcul &lt;/strong&gt;pour les valeurs comme par exemple le « effective_cache_size » qui est préconisé à 75% de la ram total du serveur si celui-ci est dédié à postgres.&lt;/p&gt;&#xA;&lt;p&gt;Le but de cet article n&amp;rsquo;est pas de voir ni de détailler tous les paramètres de configuration possibles et inimaginables, mais de voir cela comme un mémo pour les initiés ou de s’interroger sur les &lt;strong&gt;paramètres qui seraient potentiellement à modifier en fonction du serveur&lt;/strong&gt; (et des applications qui l&amp;rsquo;utilisent) si l&amp;rsquo;on ne connait pas l&amp;rsquo;utilisation des paramètres de ce fichier postgresql.conf.&lt;/p&gt;&#xA;&lt;p&gt;Pour cela un petit outil a été conçu par Cybertec, qui permet de renseigner quelques caractéristiques et de voir évoluer en conséquence le fichier postgresql.conf notamment en fonction de la ram du serveur, du nombre de cpu, de la taille de la base&amp;#8230; etc.&lt;/p&gt;&#xA;&lt;p&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; class=&#34;alignnone size-full wp-image-2925&#34; src=&#34;https://blog.atolcd.com/wp-content/uploads/2018/01/pgconfigurator.png&#34; alt=&#34;&#34; width=&#34;1005&#34; height=&#34;993&#34; srcset=&#34;https://blog.atolcd.com/wp-content/uploads/2018/01/pgconfigurator.png 1005w, https://blog.atolcd.com/wp-content/uploads/2018/01/pgconfigurator-300x296.png 300w, https://blog.atolcd.com/wp-content/uploads/2018/01/pgconfigurator-768x759.png 768w, https://blog.atolcd.com/wp-content/uploads/2018/01/pgconfigurator-945x934.png 945w, https://blog.atolcd.com/wp-content/uploads/2018/01/pgconfigurator-600x593.png 600w&#34; sizes=&#34;auto, (max-width: 1005px) 100vw, 1005px&#34; /&gt;&lt;/p&gt;&#xA;&lt;p&gt;Cela ne remplace pas une connaissance aguerrie de postgreSQL et de sa configuration mais ça permet de se faire une idée des paramètres à adapter en fonction de son serveur et de ses besoins.&lt;/p&gt;&#xA;&lt;p&gt;Cet outil est disponible en ligne à cette adresse : &lt;a href=&#34;http://pgconfigurator.cybertec.at/&#34;&gt;http://pgconfigurator.cybertec.at/&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;Cet article &lt;a href=&#34;https://blog.atolcd.com/pimp-my-postgresql/&#34;&gt;Pimp My PostgreSQL&lt;/a&gt; est apparu en premier sur &lt;a href=&#34;https://blog.atolcd.com&#34;&gt;Atol Open Blog&lt;/a&gt;.&lt;/p&gt;&#xA;</content>
    <link href="https://blog.atolcd.com/pimp-my-postgresql/?utm_source=rss&amp;utm_medium=rss&amp;utm_campaign=pimp-my-postgresql" rel="alternate"></link>
    <summary type="html">&lt;p&gt;Une question qui se pose souvent après l&amp;#8217;installation d&amp;#8217;une instance postgreSQL, c&amp;#8217;est comment configurer ce fichier postgresql.conf. Dans le doute souvent, beaucoup de personnes conservent la configuration par défaut, ce qui ne va pas poser vraiment de problème pour une... &lt;a class=&#34;more-link&#34; href=&#34;https://blog.atolcd.com/pimp-my-postgresql/&#34;&gt;Continue Reading &amp;#8594;&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;Cet article &lt;a href=&#34;https://blog.atolcd.com/pimp-my-postgresql/&#34;&gt;Pimp My PostgreSQL&lt;/a&gt; est apparu en premier sur &lt;a href=&#34;https://blog.atolcd.com&#34;&gt;Atol Open Blog&lt;/a&gt;.&lt;/p&gt;&#xA;</summary>
    <author>
      <name>Romy Fuentes</name>
    </author>
  </entry>
  <entry>
    <title>Sortie de PostgreSQL 10</title>
    <updated>2017-10-05T13:28:32Z</updated>
    <id>tag:blog.atolcd.com,2017-10-05:/sortie-de-postgresql-10/</id>
    <content type="html">&lt;p&gt;Aujourd&amp;rsquo;hui, c&amp;rsquo;est la sortie de &lt;strong&gt;PostgreSQL 10&lt;/strong&gt;!!!! Première révolution, la numérotation des versions : on passe de 9.4&amp;#8230;9.6 pour les versions majeures à 10, 11, 12&amp;#8230; Ce point est important car un changement de version majeure implique une migration des données. Une opération beaucoup plus lourde que la seule mise à jour des exécutables !&lt;/p&gt;&#xA;&lt;p&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; class=&#34;aligncenter size-full wp-image-2788&#34; src=&#34;https://blog.atolcd.com/wp-content/uploads/2017/10/postgresql-10.jpg&#34; alt=&#34;&#34; width=&#34;558&#34; height=&#34;337&#34; srcset=&#34;https://blog.atolcd.com/wp-content/uploads/2017/10/postgresql-10.jpg 558w, https://blog.atolcd.com/wp-content/uploads/2017/10/postgresql-10-300x181.jpg 300w&#34; sizes=&#34;auto, (max-width: 558px) 100vw, 558px&#34; /&gt;&lt;/p&gt;&#xA;&lt;p&gt;Voici quelques détails sur cette&lt;strong&gt; nouvelle version 10&lt;/strong&gt; et ce qu&amp;rsquo;elle apporte :&lt;/p&gt;&#xA;&lt;h2&gt;Performance et partitionnement&lt;/h2&gt;&#xA;&lt;ul style=&#34;list-style-type: disc;&#34;&gt;&#xA;&lt;li&gt;Le partitionnement de table est maintenant un attribut de la table :&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;&lt;/p&gt;&lt;pre class=&#34;crayon-plain-tag&#34;&gt;CREATE TABLE table_name ( ... )&#xD;&#xA;[ PARTITION BY { RANGE | LIST } ( { column_name | ( expression ) }&#xD;&#xA;&#xD;&#xA;CREATE TABLE table_name&#xD;&#xA;PARTITION OF parent_table [ (&#xD;&#xA;) ] FOR VALUES partition_bound_spec&lt;/pre&gt;&lt;p&gt;&lt;/p&gt;&#xA;&lt;ul style=&#34;list-style-type: disc;&#34;&gt;&#xA;&lt;li&gt;PostgreSQL 10 va plus loin dans la parallélisation avec le parallélisme des Index-Only Scan, Index Scan, Bitmap Heap Scan, Merge Join / Gather Merge, Subplan-Related Improvements&lt;/li&gt;&#xA;&lt;li&gt;Amélioration des performances pour les agrégats et jointures avec &lt;code&gt;postgres_fdw&lt;/code&gt;&lt;/li&gt;&#xA;&lt;li&gt;Amélioration des performances de l&amp;rsquo;analyseur de requête&lt;/li&gt;&#xA;&lt;li&gt;Apparition des statistiques multi-colonnes&lt;/li&gt;&#xA;&lt;li&gt;Amélioration du plan d’exécution des requêtes&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h2&gt;Réplication et scalabilité&lt;/h2&gt;&#xA;&lt;ul style=&#34;list-style-type: disc;&#34;&gt;&#xA;&lt;li&gt;Réplication logique : légère et basée sur les WAL, répliquant les objets individuellement via les commandes PUBLICATION (primaire) et SUBSCRIPTION (secondaire)&lt;/li&gt;&#xA;&lt;li style=&#34;list-style-type: none;&#34;&gt;&#xA;&lt;pre class=&#34;crayon-plain-tag&#34;&gt;CREATE PUBLICATION financials FOR TABLE ONLY loans, ONLY fines;&lt;/pre&gt;&lt;br /&gt;&#xA;&lt;pre class=&#34;crayon-plain-tag&#34;&gt;CREATE SUBSCRIPTION financials&#xD;&#xA;CONNECTION &#39;dbname=libdata user=postgres host=172.17.0.2&#39;&#xD;&#xA;PUBLICATION financials;&lt;/pre&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;QUORUM replication : avec ANY et FIRST pour synchronous_standby_names;&lt;/li&gt;&#xA;&lt;li style=&#34;list-style-type: none;&#34;&gt;&#xA;&lt;pre class=&#34;crayon-plain-tag&#34;&gt;synchronous_standby_names = ANY 2(node1,node2,node3);&#xD;&#xA;synchronous_standby_names = FIRST 2(node1,node2);&lt;/pre&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;Suppression automatique à la fin de la session des slots de réplication temporaires&lt;/li&gt;&#xA;&lt;li&gt;Amélioration de libpq permettant des connexions a de multiples systèmes&lt;/li&gt;&#xA;&lt;li&gt;Amélioration des performances de la réplication physique&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h2&gt;Administration&lt;/h2&gt;&#xA;&lt;ul style=&#34;list-style-type: disc;&#34;&gt;&#xA;&lt;li style=&#34;list-style-type: none;&#34;&gt;&#xA;&lt;ul style=&#34;list-style-type: disc;&#34;&gt;&#xA;&lt;li&gt;Support de la compression pour pg_receivewal&lt;/li&gt;&#xA;&lt;li&gt;Ajout d&amp;rsquo;informations sur les Background processes et Wait Events dans pg_stat_activity&lt;/li&gt;&#xA;&lt;li&gt;Ajout de fonctions qui remontent à l&amp;rsquo;utilisateur des informations sur le status de transaction. L&amp;rsquo;usage principal de ces fonctions est de déterminer les transactions commitées entre deux snapshots.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;&lt;/p&gt;&lt;pre class=&#34;crayon-plain-tag&#34;&gt;txid_status(bigint)&lt;/pre&gt;&lt;p&gt;&lt;/p&gt;&#xA;&lt;h2&gt;Fonctionnalités SQL et développeurs&lt;/h2&gt;&#xA;&lt;ul style=&#34;list-style-type: disc;&#34;&gt;&#xA;&lt;li style=&#34;list-style-type: none;&#34;&gt;&#xA;&lt;ul style=&#34;list-style-type: disc;&#34;&gt;&#xA;&lt;li&gt;Gestion de colonne Identity qui vise à remplacer l&amp;rsquo;utilisation du type serial et qui est conforme au standard SQL&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;&lt;/p&gt;&lt;pre class=&#34;crayon-plain-tag&#34;&gt;CREATE TABLE test_new (&#xD;&#xA;    id int GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,&#xD;&#xA;    payload text&#xD;&#xA;);&lt;/pre&gt;&lt;p&gt;plus d&amp;rsquo;informations sur ce sujet &lt;a href=&#34;https://blog.2ndquadrant.com/postgresql-10-identity-columns/&#34;&gt;ici par exemple&lt;/a&gt;&lt;/p&gt;&#xA;&lt;ul style=&#34;list-style-type: disc;&#34;&gt;&#xA;&lt;li style=&#34;list-style-type: none;&#34;&gt;&#xA;&lt;ul style=&#34;list-style-type: disc;&#34;&gt;&#xA;&lt;li&gt;Possibilité de renommer la valeur d&amp;rsquo;une énumération&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;&lt;/p&gt;&lt;pre class=&#34;crayon-plain-tag&#34;&gt;CREATE TYPE langage AS ENUM (&#39;SQL&#39;, &#39;JAVA&#39;, &#39;HTML&#39;) ;&#xD;&#xA;ALTER TYPE langage RENAME VALUE &#39;HTML&#39; TO &#39;HTML5&#39; ;&lt;/pre&gt;&lt;p&gt;&lt;/p&gt;&#xA;&lt;ul style=&#34;list-style-type: disc;&#34;&gt;&#xA;&lt;li style=&#34;list-style-type: none;&#34;&gt;&#xA;&lt;ul style=&#34;list-style-type: disc;&#34;&gt;&#xA;&lt;li&gt;Ajout des triggers AFTER STATEMENT qui peuvent avoir accès à l’ensemble des lignes modifiées, avant et après changement, à travers une pseudo-variable de type table&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;&lt;/p&gt;&lt;pre class=&#34;crayon-plain-tag&#34;&gt;CREATE TRIGGER nom_trigger AFTER DELETE ON nom_table&#xD;&#xA;REFERENCING OLD TABLE AS OLD&#xD;&#xA;FOR EACH STATEMENT&#xD;&#xA;EXECUTE PROCEDURE nom_procedure();&lt;/pre&gt;&lt;p&gt;&lt;/p&gt;&#xA;&lt;ul style=&#34;list-style-type: disc;&#34;&gt;&#xA;&lt;li style=&#34;list-style-type: none;&#34;&gt;&#xA;&lt;ul style=&#34;list-style-type: disc;&#34;&gt;&#xA;&lt;li&gt;Ajout de la fonction xmltable qui produit une table basée sur la valeur XML donnée.&lt;/li&gt;&#xA;&lt;li&gt;Supprimer des éléments d&amp;rsquo;un JSONB&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;&lt;/p&gt;&lt;pre class=&#34;crayon-plain-tag&#34;&gt;SELECT &#39;{&#34;a&#34;:1 , &#34;b&#34;:2, &#34;c&#34;:3}&#39;::jsonb - &#39;{a,c}&#39;::text[] ;&lt;/pre&gt;&lt;p&gt;&lt;/p&gt;&#xA;&lt;ul style=&#34;list-style-type: disc;&#34;&gt;&#xA;&lt;li style=&#34;list-style-type: none;&#34;&gt;&#xA;&lt;ul style=&#34;list-style-type: disc;&#34;&gt;&#xA;&lt;li&gt;Il est possible de créer des indexes full text sur une colonne JSON ou JSONB&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;&lt;/p&gt;&lt;pre class=&#34;crayon-plain-tag&#34;&gt;CREATE INDEX bookdata_fts ON bookdata&#xD;&#xA;USING gin (( to_tsvector(&#39;english&#39;,bookdata) ));&#xD;&#xA;&#xD;&#xA;SELECT bookdata -&amp;gt; &#39;title&#39;&#xD;&#xA;FROM bookdata&#xD;&#xA;WHERE to_tsvector(&#39;english&#39;,bookdata) @@ to_tsquery(&#39;duke&#39;);&lt;/pre&gt;&lt;p&gt;&lt;/p&gt;&#xA;&lt;h2&gt;Sécurité&lt;/h2&gt;&#xA;&lt;ul style=&#34;list-style-type: disc;&#34;&gt;&#xA;&lt;li style=&#34;list-style-type: none;&#34;&gt;&#xA;&lt;ul style=&#34;list-style-type: disc;&#34;&gt;&#xA;&lt;li&gt;Authentification SCRAM plus sécurisée que md5&lt;/li&gt;&#xA;&lt;li&gt;Création de nouveau rôle pour le monitoring évitant ainsi d&amp;rsquo;être super utilisateur&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;&lt;/p&gt;&lt;pre class=&#34;crayon-plain-tag&#34;&gt;pg_read_all_settings : Lit toutes les variables de configuration, y compris celles normalement visibles des seuls super-utilisateurs.&#xD;&#xA;pg_read_all_stats : Lit toutes les vues pg_stat_* et utilise plusieurs extensions relatives aux statistiques, y compris celles normalement visibles des seuls super-utilisateurs.&#xD;&#xA;pg_stat_scan_tables : Exécute des fonctions de monitoring pouvant prendre des verrous verrous ACCESS SHARE sur les tables, potentiellement pour une longue durée.&#xD;&#xA;pg_monitor : Lit et exécute plusieurs vues et fonctions de monitoring. Ce rôle est membre de pg_read_all_settings, pg_read_all_stats et pg_stat_scan_tables.&lt;/pre&gt;&lt;p&gt;&lt;/p&gt;&#xA;&lt;ul style=&#34;list-style-type: disc;&#34;&gt;&#xA;&lt;li style=&#34;list-style-type: none;&#34;&gt;&#xA;&lt;ul style=&#34;list-style-type: disc;&#34;&gt;&#xA;&lt;li&gt;Ajout de politiques restrictive dans les politiques de sécurité pour l&amp;rsquo;accès aux lignes et plus seulement de politiques permissives&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;&lt;/p&gt;&lt;pre class=&#34;crayon-plain-tag&#34;&gt;CREATE POLICY admin_local_only ON passwd AS RESTRICTIVE TO admin&#xD;&#xA;    USING (pg_catalog.inet_client_addr() IS NULL);&lt;/pre&gt;&lt;p&gt;&lt;/p&gt;&#xA;&lt;h2&gt;Autres fonctionnalités&lt;/h2&gt;&#xA;&lt;ul style=&#34;list-style-type: disc;&#34;&gt;&#xA;&lt;li&gt;file_fdw peut maintenant utiliser les programmes&lt;/li&gt;&#xA;&lt;li style=&#34;list-style-type: none;&#34;&gt;&#xA;&lt;pre class=&#34;crayon-plain-tag&#34;&gt;CREATE FOREIGN TABLE&#xD;&#xA;   test(a int, b text)&#xD;&#xA;   SERVER csv&#xD;&#xA;   OPTIONS (program &#39;gunzip -c /tmp/data.czv.gz&#39;);&lt;/pre&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;support des collations ICU&lt;/li&gt;&#xA;&lt;li&gt;Ajout d&amp;rsquo;un module amcheck permettant de vérifier cohérence / corruption d&amp;rsquo;un index B-Tree&lt;/li&gt;&#xA;&lt;li style=&#34;list-style-type: none;&#34;&gt;&#xA;&lt;pre class=&#34;crayon-plain-tag&#34;&gt;CREATE EXTENSION amcheck ;&#xD;&#xA;   SELECT bt_index_check(&#39;idx1_check1&#39;) ;&lt;/pre&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h2&gt;Modifications entrainant une incompatibilité ascendante&lt;/h2&gt;&#xA;&lt;ul style=&#34;list-style-type: disc;&#34;&gt;&#xA;&lt;li&gt;“xlog” et “clog” qui deviennent respectivement “wal” et “xact”.&lt;/li&gt;&#xA;&lt;li&gt;fin du support du protocole client/serveur 1.0 (clients datant d’avant la version 6.3)&lt;/li&gt;&#xA;&lt;li&gt;changement de valeurs par défaut pour pg_basebackup&lt;/li&gt;&#xA;&lt;li&gt;fin du support des TIMESTAMP avec floating point.&lt;/li&gt;&#xA;&lt;li&gt;Le module contrib/tsearch2 a été supprimé qui permettait une comptabilité avec les fonction de recherche full text avant la version 8.3&lt;/li&gt;&#xA;&lt;li&gt;fin du support de la commande pg_dump pour les bases de données plus anciennes que la version 8.0&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;p&gt;Et voilà, nous avons fini notre petit tour rapide des nouveautés de postgreSQL 10 mais une version 11 est déjà prévue pour dans 12 mois !&lt;/p&gt;&#xA;&lt;p&gt;Cet article &lt;a href=&#34;https://blog.atolcd.com/sortie-de-postgresql-10/&#34;&gt;Sortie de PostgreSQL 10&lt;/a&gt; est apparu en premier sur &lt;a href=&#34;https://blog.atolcd.com&#34;&gt;Atol Open Blog&lt;/a&gt;.&lt;/p&gt;&#xA;</content>
    <link href="https://blog.atolcd.com/sortie-de-postgresql-10/?utm_source=rss&amp;utm_medium=rss&amp;utm_campaign=sortie-de-postgresql-10" rel="alternate"></link>
    <summary type="html">&lt;p&gt;Aujourd&amp;#8217;hui, c&amp;#8217;est la sortie de PostgreSQL 10!!!! Première révolution, la numérotation des versions : on passe de 9.4&amp;#8230;9.6 pour les versions majeures à 10, 11, 12&amp;#8230; Ce point est important car un changement de version majeure implique une migration des... &lt;a class=&#34;more-link&#34; href=&#34;https://blog.atolcd.com/sortie-de-postgresql-10/&#34;&gt;Continue Reading &amp;#8594;&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;Cet article &lt;a href=&#34;https://blog.atolcd.com/sortie-de-postgresql-10/&#34;&gt;Sortie de PostgreSQL 10&lt;/a&gt; est apparu en premier sur &lt;a href=&#34;https://blog.atolcd.com&#34;&gt;Atol Open Blog&lt;/a&gt;.&lt;/p&gt;&#xA;</summary>
    <author>
      <name>Romy Fuentes</name>
    </author>
  </entry>
  <entry>
    <title>PostgreSQL Basics : lire un plan d’exécution comme un·e pro (ou presque)</title>
    <updated>2025-05-13T15:20:05Z</updated>
    <id>tag:blog.capdata.fr,2025-05-13:/index.php/postgresql-basics-lire-un-plan-dexecution/</id>
    <content type="html">&lt;a class=&#34;synved-social-button synved-social-button-share synved-social-size-24 synved-social-resolution-single synved-social-provider-twitter nolightbox&#34; data-provider=&#34;twitter&#34; target=&#34;_blank&#34; rel=&#34;nofollow&#34; title=&#34;Share on Twitter&#34; href=&#34;https://twitter.com/intent/tweet?url=https%3A%2F%2Fblog.capdata.fr%2F%3Fp%3D10697&amp;#038;text=Article%20sur%20le%20blog%20de%20la%20Capdata%20Tech%20Team%20%3A%20&#34; style=&#34;font-size: 0px;width:24px;height:24px;margin:0;margin-bottom:5px;margin-right:5px&#34;&gt;&lt;img decoding=&#34;async&#34; alt=&#34;twitter&#34; title=&#34;Share on Twitter&#34; class=&#34;synved-share-image synved-social-image synved-social-image-share&#34; width=&#34;24&#34; height=&#34;24&#34; style=&#34;display: inline;width:24px;height:24px;margin: 0;padding: 0;border: none;box-shadow: none&#34; src=&#34;https://blog.capdata.fr/wp-content/plugins/social-media-feather/synved-social/image/social/regular/48x48/twitter.png&#34; /&gt;&lt;/a&gt;&lt;a class=&#34;synved-social-button synved-social-button-share synved-social-size-24 synved-social-resolution-single synved-social-provider-linkedin nolightbox&#34; data-provider=&#34;linkedin&#34; target=&#34;_blank&#34; rel=&#34;nofollow&#34; title=&#34;Share on Linkedin&#34; href=&#34;https://www.linkedin.com/shareArticle?mini=true&amp;#038;url=https%3A%2F%2Fblog.capdata.fr%2F%3Fp%3D10697&amp;#038;title=PostgreSQL%20Basics%20%3A%20lire%20un%20plan%20d%E2%80%99ex%C3%A9cution%20comme%20un%C2%B7e%20pro%20%28ou%20presque%29&#34; style=&#34;font-size: 0px;width:24px;height:24px;margin:0;margin-bottom:5px;margin-right:5px&#34;&gt;&lt;img decoding=&#34;async&#34; alt=&#34;linkedin&#34; title=&#34;Share on Linkedin&#34; class=&#34;synved-share-image synved-social-image synved-social-image-share&#34; width=&#34;24&#34; height=&#34;24&#34; style=&#34;display: inline;width:24px;height:24px;margin: 0;padding: 0;border: none;box-shadow: none&#34; src=&#34;https://blog.capdata.fr/wp-content/plugins/social-media-feather/synved-social/image/social/regular/48x48/linkedin.png&#34; /&gt;&lt;/a&gt;&lt;a class=&#34;synved-social-button synved-social-button-share synved-social-size-24 synved-social-resolution-single synved-social-provider-mail nolightbox&#34; data-provider=&#34;mail&#34; rel=&#34;nofollow&#34; title=&#34;Share by email&#34; href=&#34;mailto:?subject=PostgreSQL%20Basics%20%3A%20lire%20un%20plan%20d%E2%80%99ex%C3%A9cution%20comme%20un%C2%B7e%20pro%20%28ou%20presque%29&amp;#038;body=Article%20sur%20le%20blog%20de%20la%20Capdata%20Tech%20Team%20%3A%20:%20https%3A%2F%2Fblog.capdata.fr%2F%3Fp%3D10697&#34; style=&#34;font-size: 0px;width:24px;height:24px;margin:0;margin-bottom:5px&#34;&gt;&lt;img decoding=&#34;async&#34; alt=&#34;mail&#34; title=&#34;Share by email&#34; class=&#34;synved-share-image synved-social-image synved-social-image-share&#34; width=&#34;24&#34; height=&#34;24&#34; style=&#34;display: inline;width:24px;height:24px;margin: 0;padding: 0;border: none;box-shadow: none&#34; src=&#34;https://blog.capdata.fr/wp-content/plugins/social-media-feather/synved-social/image/social/regular/48x48/mail.png&#34; /&gt;&lt;/a&gt;&lt;h1&gt;Introduction :&lt;/h1&gt;&#xA;&lt;p&gt;Quand une requête PostgreSQL est considérée comme lente ou que ses performances se dégradent soudainement, il y a un réflexe à toujours avoir : utiliser les plans d&amp;#8217;exécution. Je n’apprends certainement rien à la majorité des personnes qui liront cet article, mais si cela permet de garder vigilants les débutants et de leur enseigner quelques ficelles, alors cet article vaut le coup.&lt;/p&gt;&#xA;&lt;p&gt;Si vous avez déjà été dans le cas de figure où un plan d&amp;#8217;exécution est trop gros pour que vous sachiez par quel bout le prendre, ou si vous avez l&amp;#8217;impression qu&amp;#8217;on vous parle chinois quand on évoque les index scan ou les &amp;#8220;cost&amp;#8221; d&amp;#8217;une requête, alors vous êtes au bon endroit.&lt;/p&gt;&#xA;&lt;p&gt;Dans cet article, premier d&amp;#8217;une série sur les bases de PostgreSQL, nous allons démystifier l&amp;#8217;optimisation des requêtes en utilisant EXPLAIN comme point de départ, et les plans d&amp;#8217;exécution générés comme fil conducteur.&lt;/p&gt;&#xA;&lt;p&gt;L’objectif : vous aider à identifier rapidement les informations clés, repérer les goulots d’étranglement, et gagner en autonomie pour diagnostiquer les performances de vos requêtes.&lt;/p&gt;&#xA;&lt;p&gt;C’est parti !&lt;/p&gt;&#xA;&lt;h2&gt;EXPLAIN ANALYZE : c’est quoi exactement et pourquoi l’utiliser ?&lt;/h2&gt;&#xA;&lt;p&gt;Pour commencer, il faut savoir qu&amp;#8217;un moteur de base de données, que ce soit PostgreSQL ou un autre ne &amp;#8220;lit&amp;#8221; pas une requête comme un humain pourrait la lire, de gauche à droite. Il élabore plutôt un plan d&amp;#8217;exécution : il créé un ensemble d&amp;#8217;étape qui se veulent le plus optimisées possible pour aller chercher les données que vous lui demander de la façon la plus efficace possible.&lt;/p&gt;&#xA;&lt;p&gt;Il y a un moyen simple de voir ce plan d&amp;#8217;exécution, c&amp;#8217;est d&amp;#8217;utiliser la commande EXPLAIN ANALYZE. Elle nous permet en plus de comprendre de quelle façon le moteur à réellement exécuté notre ordre SQL (et pas seulement comment il pensait le faire). C&amp;#8217;est un peu comme lire un journal de bord de l&amp;#8217;exécution de la requête.&lt;/p&gt;&#xA;&lt;h3&gt;Prenons un exemple simple :&lt;/h3&gt;&#xA;&lt;p&gt;Imaginons que nous avons une table users, constituée comme tel :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: sql; title: ; notranslate&#34;&gt;CREATE TABLE users (&#xD;&#xA;id integer PRIMARY KEY,&#xD;&#xA;name vachar(30),&#xD;&#xA;age integer,&#xD;&#xA;email varchar(80) );&lt;/pre&gt;&#xA;&lt;p&gt;Et que nous souhaitons utiliser la requête suivante dans notre application :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: sql; title: ; notranslate&#34;&gt;SELECT * FROM users WHERE email = &#39;foo@example.com&#39;;&lt;/pre&gt;&#xA;&lt;p&gt;Sur cette table, nous n&amp;#8217;avons pas d&amp;#8217;index. Voici donc ce à quoi pourrait ressembler notre plan d&amp;#8217;éxecution si nous utilisons la commande :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: sql; title: ; notranslate&#34;&gt;EXPLAIN ANALYZE SELECT * FROM users WHERE email = &#39;foo@example.com&#39;;&#xD;&#xA;&#xD;&#xA;Seq Scan on users (cost=0.00..35.50 rows=1 width=100)&#xD;&#xA;Filter: (email = &#39;foo@example.com&#39;)&#xD;&#xA;Rows Removed by Filter: 999&#xD;&#xA;Actual time=0.010..0.420 rows=1 loops=1&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;h3&gt;Les termes du plan d&amp;#8217;exécution :&lt;/h3&gt;&#xA;&lt;p&gt;A première vue, il n&amp;#8217;est pas évident de comprendre tout les termes que l&amp;#8217;on voit dans le plan d&amp;#8217;exécution généré.&lt;/p&gt;&#xA;&lt;p&gt;Voici un récapitulatif des principaux :&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;strong&gt;Seq Scan / Index Scan :&lt;/strong&gt; Le type de parcours utilisé (séquentiel ou via un index)&lt;/li&gt;&#xA;&lt;li&gt;&lt;strong&gt;cost=… :&lt;/strong&gt; Estimation du &amp;#8220;coût&amp;#8221; total de l’opération, selon PostgreSQL. Le coût n&amp;#8217;est pas exprimé dans une unité particulière, c&amp;#8217;est juste un indicatif. Plus il est élevé, plus l&amp;#8217;opération est &amp;#8220;coûteuse&amp;#8221;, notre but étant d&amp;#8217;éviter les coûts énormes pour que tout soit plus simple.&lt;/li&gt;&#xA;&lt;li&gt;&lt;strong&gt;rows=… :&lt;/strong&gt; Estimation du nombre de lignes que l&amp;#8217;étape va retourner&lt;/li&gt;&#xA;&lt;li&gt;&lt;strong&gt;actual time=… :&lt;/strong&gt; Le temps réel que cette étape a pris (en millisecondes)&lt;/li&gt;&#xA;&lt;li&gt;&lt;strong&gt;Rows Removed by Filter :&lt;/strong&gt; Nombre de lignes lues mais éliminées par un filtre&lt;/li&gt;&#xA;&lt;li&gt;&lt;strong&gt;loops=1 :&lt;/strong&gt; Nombre de fois que cette étape a été exécutée (ex. dans une boucle)&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h3&gt;Puis un exemple plus compliqué :&lt;/h3&gt;&#xA;&lt;p&gt;Attention, tout les plans d&amp;#8217;exécution de requête ne sont pas aussi simples que celui que je viens de vous présenter. Bien souvent ils se présentent sous la forme de plusieurs nœuds indentés  qu&amp;#8217;il faut lire dans le bon ordre. Imaginons une nouvelle table orders qui répertorie les commandes passées par un user :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: sql; title: ; notranslate&#34;&gt;CREATE TABLE orders (&#xD;&#xA;id_orders integer PRIMARY KEY,&#xD;&#xA;created_at timestamp,&#xD;&#xA;total numeric,&#xD;&#xA;status text,&#xD;&#xA;user_id integer references users(id));&lt;/pre&gt;&#xA;&lt;p&gt;Nous pouvons alors imaginer la requête suivante :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: sql; title: ; notranslate&#34;&gt;SELECT u.name, o.total, o.created_at&#xD;&#xA;FROM users u&#xD;&#xA;JOIN orders o ON u.id = o.user_id&#xD;&#xA;WHERE o.status = &#39;completed&#39;&#xD;&#xA;ORDER BY o.created_at DESC&#xD;&#xA;LIMIT 10;&lt;/pre&gt;&#xA;&lt;p&gt;Qui remonte les dix premières commandes,  avec le nom de l&amp;#8217;acheteur, le total de la commande et sa date, pour les 10 premières commandes dans l&amp;#8217;ordre des dates dont le statut est &amp;#8220;completed&amp;#8221;.&lt;/p&gt;&#xA;&lt;p&gt;Si on execute un explain analyze sur cette requête, on obtient un plan d&amp;#8217;execution de cet ordre :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: sql; title: ; notranslate&#34;&gt; Limit (cost=123.45..123.48 rows=10 width=40) (actual time=1.234..1.239 rows=10 loops=1)&#xD;&#xA;   -&amp;amp;gt; Sort (cost=123.45..130.00 rows=2620 width=40) (actual time=1.234..1.236 rows=10 loops=1)&#xD;&#xA;      Sort Key: o.created_at DESC&#xD;&#xA;      Sort Method: top-N heapsort Memory: 25kB&#xD;&#xA;       -&amp;amp;gt; Nested Loop (cost=0.42..100.00 rows=2620 width=40) (actual time=0.045..0.980 rows=200 loops=1)&#xD;&#xA;            -&amp;amp;gt; Index Scan using idx_orders_created_at on orders o (cost=0.29..45.00 rows=2620 width=24) (actual time=0.030..0.340 rows=200 loops=1)&#xD;&#xA;                 Filter: (status = &#39;completed&#39;)&#xD;&#xA;                 Rows Removed by Filter: 50&#xD;&#xA;            -&amp;amp;gt; Index Scan using users_pkey on users u (cost=0.13..0.20 rows=1 width=16) (actual time=0.003..0.004 rows=1 loops=200)&#xD;&#xA;                 Index Cond: (id = o.user_id)&lt;/pre&gt;&#xA;&lt;p&gt;Si on devait visualiser ce plan d&amp;#8217;exécution de manière graphique pour qu&amp;#8217;il soit plus simple à lire, ça donnerait ça :&lt;/p&gt;&#xA;&lt;p&gt;&lt;a href=&#34;https://blog.capdata.fr/wp-content/uploads/2025/04/chrome_zyhdtutiuX.png&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; class=&#34;alignnone wp-image-10701&#34; src=&#34;https://blog.capdata.fr/wp-content/uploads/2025/04/chrome_zyhdtutiuX-300x170.png&#34; alt=&#34;&#34; width=&#34;508&#34; height=&#34;288&#34; srcset=&#34;https://blog.capdata.fr/wp-content/uploads/2025/04/chrome_zyhdtutiuX-300x170.png 300w, https://blog.capdata.fr/wp-content/uploads/2025/04/chrome_zyhdtutiuX-768x434.png 768w, https://blog.capdata.fr/wp-content/uploads/2025/04/chrome_zyhdtutiuX.png 853w&#34; sizes=&#34;auto, (max-width: 508px) 100vw, 508px&#34; /&gt;&lt;/a&gt;&lt;/p&gt;&#xA;&lt;h3&gt;Comment lire un plan d&amp;#8217;exécution :&lt;/h3&gt;&#xA;&lt;p&gt;Pour lire un plan d&amp;#8217;exécution, on part toujours du nœud le plus indenté, puis on remonte vers les nœuds supérieur. Dans notre cas, on partirais des deux index scan pour remonter ensuite sur le Nested Loop, puis sur le Sort, et enfin sur le Limit.&lt;br /&gt;&#xA;La raison est simple : le plan d’exécution reflète l’ordre réel d’exécution de la requête par PostgreSQL.&lt;br /&gt;&#xA;Chaque étape du plan consomme les résultats produits par les étapes précédentes. Autrement dit : PostgreSQL commence par les opérations de lecture (accès aux tables, scans d’index&amp;#8230;), puis applique les jointures, les filtres, les tris, etc. en remontant vers le haut du plan.&lt;br /&gt;&#xA;Le nœud le plus &amp;#8220;haut&amp;#8221; du plan (celui avec le moins d’indentation) correspond à l’opération finale, celle qui retourne les résultats à l’utilisateur. Les blocs en dessous (plus indentés) sont les dépendances nécessaires pour y arriver.&lt;br /&gt;&#xA;C’est donc une logique de pipeline de traitement :&lt;/p&gt;&#xA;&lt;ol&gt;&#xA;&lt;li&gt;&lt;strong&gt;Lire les données&lt;/strong&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;strong&gt;Les filtrer&lt;/strong&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;strong&gt;Les combiner&lt;/strong&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;strong&gt;Les trier / agréger&lt;/strong&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;strong&gt;Les retourner&lt;/strong&gt;&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&lt;p&gt;Lire un plan d’exécution &amp;#8220;du plus profond vers le haut&amp;#8221;, c’est suivre le chemin de vie d’une ligne de résultat depuis le disque jusqu’à votre terminal.&lt;/p&gt;&#xA;&lt;h3&gt;Petite encyclopédie des nœuds les plus courants dans un plan d’exécution&lt;/h3&gt;&#xA;&lt;p&gt;Voici une sélection des nœuds que vous croiserez régulièrement dans les plans d’exécution PostgreSQL, avec une explication simple et directe pour chacun :&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li class=&#34;&#34; data-start=&#34;251&#34; data-end=&#34;420&#34;&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;253&#34; data-end=&#34;420&#34;&gt;&lt;strong data-start=&#34;253&#34; data-end=&#34;265&#34;&gt;Seq Scan&lt;/strong&gt;&lt;br data-start=&#34;265&#34; data-end=&#34;268&#34; /&gt;Lecture séquentielle de toute la table.&lt;br data-start=&#34;309&#34; data-end=&#34;312&#34; /&gt;&lt;em data-start=&#34;317&#34; data-end=&#34;331&#34;&gt;À surveiller&lt;/em&gt; : Normal sur petites tables, mais sur les grosses, cela peut indiquer un index manquant.&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li class=&#34;&#34; data-start=&#34;422&#34; data-end=&#34;607&#34;&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;424&#34; data-end=&#34;607&#34;&gt;&lt;strong data-start=&#34;424&#34; data-end=&#34;438&#34;&gt;Index Scan&lt;/strong&gt;&lt;br data-start=&#34;438&#34; data-end=&#34;441&#34; /&gt;Parcours d’un index pour chercher les lignes correspondantes.&lt;br data-start=&#34;504&#34; data-end=&#34;507&#34; /&gt;&lt;em data-start=&#34;512&#34; data-end=&#34;526&#34;&gt;À surveiller&lt;/em&gt; : Rapide si l’index est bien choisi. Peut devenir lent avec beaucoup de &lt;em data-start=&#34;599&#34; data-end=&#34;606&#34;&gt;loops&lt;/em&gt;.&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li class=&#34;&#34; data-start=&#34;609&#34; data-end=&#34;804&#34;&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;611&#34; data-end=&#34;804&#34;&gt;&lt;strong data-start=&#34;611&#34; data-end=&#34;630&#34;&gt;Index Only Scan&lt;/strong&gt;&lt;br data-start=&#34;630&#34; data-end=&#34;633&#34; /&gt;Comme un Index Scan, mais sans lire la table si toutes les colonnes nécessaires sont déjà dans l’index.&lt;br data-start=&#34;740&#34; data-end=&#34;743&#34; /&gt;&lt;em data-start=&#34;748&#34; data-end=&#34;762&#34;&gt;À surveiller&lt;/em&gt; : Ultra-performant ! À viser si possible.&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li class=&#34;&#34; data-start=&#34;806&#34; data-end=&#34;1031&#34;&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;808&#34; data-end=&#34;1031&#34;&gt;&lt;strong data-start=&#34;808&#34; data-end=&#34;829&#34;&gt;Bitmap Index Scan&lt;/strong&gt; + &lt;strong data-start=&#34;832&#34; data-end=&#34;852&#34;&gt;Bitmap Heap Scan&lt;/strong&gt;&lt;br data-start=&#34;852&#34; data-end=&#34;855&#34; /&gt;PostgreSQL construit une &amp;#8220;carte&amp;#8221; des lignes à lire, puis les récupère en une seule passe.&lt;br data-start=&#34;946&#34; data-end=&#34;949&#34; /&gt;&lt;em data-start=&#34;954&#34; data-end=&#34;968&#34;&gt;À surveiller&lt;/em&gt; : Très performant pour des filtres avec beaucoup de résultats.&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li class=&#34;&#34; data-start=&#34;1033&#34; data-end=&#34;1244&#34;&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;1035&#34; data-end=&#34;1244&#34;&gt;&lt;strong data-start=&#34;1035&#34; data-end=&#34;1050&#34;&gt;Nested Loop&lt;/strong&gt;&lt;br data-start=&#34;1050&#34; data-end=&#34;1053&#34; /&gt;Pour chaque ligne de la première table, PostgreSQL cherche dans la seconde.&lt;br data-start=&#34;1130&#34; data-end=&#34;1133&#34; /&gt;&lt;em data-start=&#34;1138&#34; data-end=&#34;1152&#34;&gt;À surveiller&lt;/em&gt; : Bien sur de petits volumes, mais peut exploser sur de grandes tables (effet quadratique).&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li class=&#34;&#34; data-start=&#34;1246&#34; data-end=&#34;1445&#34;&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;1248&#34; data-end=&#34;1445&#34;&gt;&lt;strong data-start=&#34;1248&#34; data-end=&#34;1261&#34;&gt;Hash Join&lt;/strong&gt;&lt;br data-start=&#34;1261&#34; data-end=&#34;1264&#34; /&gt;PostgreSQL construit une table de hachage en mémoire pour faire la jointure.&lt;br data-start=&#34;1342&#34; data-end=&#34;1345&#34; /&gt;&lt;em data-start=&#34;1350&#34; data-end=&#34;1364&#34;&gt;À surveiller&lt;/em&gt; : Performant si la mémoire le permet. Attention à la taille des jeux de données.&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li class=&#34;&#34; data-start=&#34;1447&#34; data-end=&#34;1621&#34;&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;1449&#34; data-end=&#34;1621&#34;&gt;&lt;strong data-start=&#34;1449&#34; data-end=&#34;1463&#34;&gt;Merge Join&lt;/strong&gt;&lt;br data-start=&#34;1463&#34; data-end=&#34;1466&#34; /&gt;Jointure optimisée entre deux sources déjà triées.&lt;br data-start=&#34;1518&#34; data-end=&#34;1521&#34; /&gt;&lt;em data-start=&#34;1526&#34; data-end=&#34;1540&#34;&gt;À surveiller&lt;/em&gt; : Excellent en perfs si les colonnes jointes sont indexées ou triées à l’avance.&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li class=&#34;&#34; data-start=&#34;1623&#34; data-end=&#34;1794&#34;&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;1625&#34; data-end=&#34;1794&#34;&gt;&lt;strong data-start=&#34;1625&#34; data-end=&#34;1638&#34;&gt;Aggregate&lt;/strong&gt;&lt;br data-start=&#34;1638&#34; data-end=&#34;1641&#34; /&gt;Calcule une agrégation (COUNT, SUM, AVG, &amp;#8230;).&lt;br data-start=&#34;1696&#34; data-end=&#34;1699&#34; data-is-only-node=&#34;&#34; /&gt;&lt;em data-start=&#34;1704&#34; data-end=&#34;1718&#34;&gt;À surveiller&lt;/em&gt; : Peut être coûteux si l’agrégation se fait sur de gros volumes sans index.&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li class=&#34;&#34; data-start=&#34;1796&#34; data-end=&#34;1959&#34;&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;1798&#34; data-end=&#34;1959&#34;&gt;&lt;strong data-start=&#34;1798&#34; data-end=&#34;1806&#34;&gt;Sort&lt;/strong&gt;&lt;br data-start=&#34;1806&#34; data-end=&#34;1809&#34; /&gt;Trie les données selon une ou plusieurs colonnes.&lt;br data-start=&#34;1860&#34; data-end=&#34;1863&#34; /&gt;&lt;em data-start=&#34;1868&#34; data-end=&#34;1882&#34;&gt;À surveiller&lt;/em&gt; : Peut consommer beaucoup de mémoire ; un bon index peut éviter cette étape.&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li class=&#34;&#34; data-start=&#34;1961&#34; data-end=&#34;2136&#34;&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;1963&#34; data-end=&#34;2136&#34;&gt;&lt;strong data-start=&#34;1963&#34; data-end=&#34;1972&#34;&gt;Limit&lt;/strong&gt;&lt;br data-start=&#34;1972&#34; data-end=&#34;1975&#34; /&gt;Tronque le résultat à N lignes.&lt;br data-start=&#34;2010&#34; data-end=&#34;2013&#34; /&gt;&lt;em data-start=&#34;2018&#34; data-end=&#34;2032&#34;&gt;À surveiller&lt;/em&gt; : Très utile combiné avec ORDER BY, car PostgreSQL peut s’arrêter dès qu’il a assez de lignes triées.&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li class=&#34;&#34; data-start=&#34;2138&#34; data-end=&#34;2327&#34;&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;2140&#34; data-end=&#34;2327&#34;&gt;&lt;strong data-start=&#34;2140&#34; data-end=&#34;2152&#34;&gt;CTE Scan&lt;/strong&gt;&lt;br data-start=&#34;2152&#34; data-end=&#34;2155&#34; /&gt;Utilisé quand vous avez une clause WITH (CTE – Common Table Expression).&lt;br data-start=&#34;2231&#34; data-end=&#34;2234&#34; /&gt;&lt;em data-start=&#34;2239&#34; data-end=&#34;2253&#34;&gt;À surveiller&lt;/em&gt; : Si le CTE n’est pas matérialisé, il peut être recalculé à chaque appel.&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h2&gt;Options utiles de EXPLAIN / EXPLAIN ANALYZE&lt;/h2&gt;&#xA;&lt;p&gt;La commande EXPLAIN (et sa variante EXPLAIN ANALYZE) peut être enrichie avec plusieurs options facultatives pour mieux comprendre ce que PostgreSQL fait avec vos requêtes. Voici une présentation des principales.&lt;/p&gt;&#xA;&lt;h4&gt;ANALYZE : exécuter la requête pour de vrai&lt;/h4&gt;&#xA;&lt;p&gt;Cette option (souvent appelée “EXPLAIN ANALYZE”) &lt;strong&gt;exécute réellement la requête&lt;/strong&gt; et mesure les temps d&amp;#8217;exécution.&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: sql; title: ; notranslate&#34;&gt; EXPLAIN ANALYZE SELECT * FROM users WHERE email = &#39;foo@example.com&#39;; &lt;/pre&gt;&#xA;&lt;p&gt;Sans cette option, PostgreSQL ne fait qu’estimer le plan, il ne l’exécute pas réellement.&lt;/p&gt;&#xA;&lt;h4&gt;VERBOSE: plus de détails sur les colonnes et les expressions&lt;/h4&gt;&#xA;&lt;p&gt;Affiche le nom exact des colonnes internes et les expressions utilisées dans chaque étape du plan.&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: sql; title: ; notranslate&#34;&gt; EXPLAIN (ANALYZE, VERBOSE) SELECT name FROM users WHERE age &amp;amp;gt; 30; &lt;/pre&gt;&#xA;&lt;p&gt;Très utile quand on travaille avec des fonctions, des agrégats ou des vues complexes.&lt;/p&gt;&#xA;&lt;h4&gt;BUFFERS : détail des lectures mémoire et disque&lt;/h4&gt;&#xA;&lt;p&gt;Montre combien de blocs de données ont été lus en mémoire (cache partagé) et depuis le disque.&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: sql; title: ; notranslate&#34;&gt; EXPLAIN (ANALYZE, BUFFERS) SELECT * FROM orders WHERE status = &#39;completed&#39;; &lt;/pre&gt;&#xA;&lt;p&gt;Idéal pour identifier si une requête est ralentie par des accès disques trop nombreux.&lt;/p&gt;&#xA;&lt;h4&gt;WAL : suivi des écritures dans le journal de transactions&lt;/h4&gt;&#xA;&lt;p&gt;Affiche l’impact de la requête sur le WAL (Write-Ahead Logging), c’est-à-dire les écritures nécessaires à la durabilité.&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: sql; title: ; notranslate&#34;&gt; EXPLAIN (ANALYZE, WAL) INSERT INTO logs SELECT * FROM events; &lt;/pre&gt;&#xA;&lt;p&gt;Surtout utile pour comprendre le coût caché des requêtes d’écriture.&lt;/p&gt;&#xA;&lt;h4&gt;COSTS : afficher ou masquer les coûts estimés&lt;/h4&gt;&#xA;&lt;p&gt;Permet de désactiver les lignes cost=&amp;#8230; si on veut se concentrer uniquement sur les temps réels (actual time).&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: sql; title: ; notranslate&#34;&gt; EXPLAIN (ANALYZE, COSTS OFF) SELECT * FROM users; &lt;/pre&gt;&#xA;&lt;p&gt;Pratique pour alléger la lecture d’un plan quand on n’a pas besoin des estimations.&lt;/p&gt;&#xA;&lt;h4&gt;SETTINGS : voir les paramètres ayant influencé le plan&lt;/h4&gt;&#xA;&lt;p&gt;Affiche les paramètres de configuration de PostgreSQL qui ont eu un impact sur la génération du plan.&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: sql; title: ; notranslate&#34;&gt; EXPLAIN (ANALYZE, SETTINGS) SELECT * FROM users; &lt;/pre&gt;&#xA;&lt;p&gt;Très utile pour le debug avancé, ou si certains paramètres sont modifiés via SET.&lt;/p&gt;&#xA;&lt;h4&gt;SUMMARY : afficher ou non les temps globaux&lt;/h4&gt;&#xA;&lt;p&gt;Contrôle l’affichage du résumé final (Planning Time, Execution Time).&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: sql; title: ; notranslate&#34;&gt; EXPLAIN (ANALYZE, SUMMARY OFF) SELECT * FROM users; &lt;/pre&gt;&#xA;&lt;p&gt;Par défaut activé, mais vous pouvez le désactiver si vous ne souhaitez pas ces infos à la fin du plan.&lt;/p&gt;&#xA;&lt;h4&gt;TIMING : activer ou désactiver la mesure des temps internes&lt;/h4&gt;&#xA;&lt;p&gt;PostgreSQL mesure le actual time pour chaque nœud du plan. Cette option permet de désactiver ces mesures (utile pour les très petites requêtes ou les benchmarks massifs).&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: sql; title: ; notranslate&#34;&gt; EXPLAIN (ANALYZE, TIMING OFF) SELECT * FROM users; &lt;/pre&gt;&#xA;&lt;p&gt;Désactive les mesures fines, ce qui peut légèrement améliorer les performances du plan d’analyse lui-même.&lt;/p&gt;&#xA;&lt;h4&gt;FORMAT : changer la sortie (TEXT, JSON, YAML)&lt;/h4&gt;&#xA;&lt;p&gt;Permet d’obtenir un plan dans un format structuré (parfait pour les outils externes comme explain.dalibo.com).&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: sql; title: ; notranslate&#34;&gt; EXPLAIN (ANALYZE, FORMAT JSON) SELECT * FROM users; &lt;/pre&gt;&#xA;&lt;p&gt;Pratique pour générer un plan visuel, l’analyser en script, ou l’intégrer dans des outils de perf.&lt;/p&gt;&#xA;&lt;h2&gt;OK super, mais une fois qu&amp;#8217;on sait ça, on en fait quoi ?&lt;/h2&gt;&#xA;&lt;p data-start=&#34;260&#34; data-end=&#34;525&#34;&gt;On pourrait passer des heures à décortiquer les différentes lignes d&amp;#8217;un plan d&amp;#8217;exécution sans pour autant avancer plus que ça. L&amp;#8217;important est maintenant de savoir quoi en faire. Parce que c&amp;#8217;est bien beau de l&amp;#8217;afficher, encore faut-il savoir quoi y chercher.&lt;/p&gt;&#xA;&lt;p data-start=&#34;260&#34; data-end=&#34;525&#34;&gt;Voici une petite liste non exhaustive des indices à repérer dans un plan d&amp;#8217;exécution qui pourraient vous mener à une raison pour la lenteur de votre requête :&lt;/p&gt;&#xA;&lt;h3&gt;&lt;img src=&#34;https://s.w.org/images/core/emoji/16.0.1/72x72/1f50e.png&#34; alt=&#34;🔎&#34; class=&#34;wp-smiley&#34; style=&#34;height: 1em; max-height: 1em;&#34; /&gt; Une lecture séquentielle sur une grosse table :&lt;/h3&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;659&#34; data-end=&#34;678&#34;&gt;&lt;strong data-start=&#34;659&#34; data-end=&#34;674&#34;&gt;Symptôme&lt;/strong&gt; :&lt;/p&gt;&#xA;&lt;div class=&#34;contain-inline-size rounded-md border-[0.5px] border-token-border-medium relative bg-token-sidebar-surface-primary&#34;&gt;&#xA;&lt;div class=&#34;overflow-y-auto p-4&#34; dir=&#34;ltr&#34;&gt;&lt;code class=&#34;whitespace-pre! language-text&#34;&gt;Seq Scan on users  (rows=100000)&lt;br /&gt;&#xA;&lt;/code&gt;&lt;/div&gt;&#xA;&lt;/div&gt;&#xA;&lt;p&gt;&lt;strong data-start=&#34;725&#34; data-end=&#34;755&#34;&gt;Pourquoi c’est un souci&lt;/strong&gt;&lt;br data-start=&#34;755&#34; data-end=&#34;758&#34; /&gt;PostgreSQL lit toute la table ligne par ligne. C’est très lent et parfaitement inutile, surtout si vous ne voulez que quelques lignes de cette table.&lt;/p&gt;&#xA;&lt;p&gt;&lt;strong data-start=&#34;861&#34; data-end=&#34;887&#34;&gt;Comment le voir&lt;/strong&gt;&lt;/p&gt;&#xA;&lt;ul data-start=&#34;890&#34; data-end=&#34;992&#34;&gt;&#xA;&lt;li class=&#34;&#34; data-start=&#34;890&#34; data-end=&#34;914&#34;&gt;On note la présence d&amp;#8217;un nœud SEQ SCAN dans notre plan d&amp;#8217;exécution&lt;/li&gt;&#xA;&lt;li class=&#34;&#34; data-start=&#34;915&#34; data-end=&#34;992&#34;&gt;Nombre de lignes parcourues très élevé (puce rows ou présence de row removed by filter)&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;&lt;strong data-start=&#34;994&#34; data-end=&#34;1010&#34;&gt;Solutions&lt;/strong&gt;&lt;/p&gt;&#xA;&lt;ul data-start=&#34;1011&#34; data-end=&#34;1184&#34;&gt;&#xA;&lt;li class=&#34;&#34; data-start=&#34;1011&#34; data-end=&#34;1085&#34;&gt;Ajouter un index sur la colonne filtrée peut souvent aider dans ce genre de cas.&lt;/li&gt;&#xA;&lt;li class=&#34;&#34; data-start=&#34;1086&#34; data-end=&#34;1184&#34;&gt;Réécrire la requête pour qu’elle utilise une clause mieux optimisée (exclusion, inclusion&amp;#8230;)&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h3&gt;&lt;img src=&#34;https://s.w.org/images/core/emoji/16.0.1/72x72/1f50e.png&#34; alt=&#34;🔎&#34; class=&#34;wp-smiley&#34; style=&#34;height: 1em; max-height: 1em;&#34; /&gt; Trop de Loop&lt;/h3&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;1242&#34; data-end=&#34;1261&#34;&gt;&lt;strong data-start=&#34;1242&#34; data-end=&#34;1257&#34;&gt;Symptôme&lt;/strong&gt; :&lt;/p&gt;&#xA;&lt;div class=&#34;contain-inline-size rounded-md border-[0.5px] border-token-border-medium relative bg-token-sidebar-surface-primary&#34;&gt;&#xA;&lt;div class=&#34;overflow-y-auto p-4&#34; dir=&#34;ltr&#34;&gt;&lt;code class=&#34;whitespace-pre! language-text&#34;&gt;Index Scan using users_pkey on users  (loops=10000)&lt;br /&gt;&#xA;&lt;/code&gt;&lt;/div&gt;&#xA;&lt;/div&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;1327&#34; data-end=&#34;1489&#34;&gt;&lt;strong data-start=&#34;1327&#34; data-end=&#34;1357&#34;&gt;Pourquoi c’est un souci&lt;/strong&gt;&lt;br data-start=&#34;1357&#34; data-end=&#34;1360&#34; /&gt;Une opération lente est répétée pour chaque ligne de l’opération extérieure, souvent dans une jointure en boucle (Nested Loop).&lt;/p&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;1491&#34; data-end=&#34;1519&#34;&gt;&lt;strong data-start=&#34;1491&#34; data-end=&#34;1517&#34;&gt;Comment le voir&lt;/strong&gt;&lt;/p&gt;&#xA;&lt;ul data-start=&#34;1520&#34; data-end=&#34;1575&#34;&gt;&#xA;&lt;li data-start=&#34;1520&#34; data-end=&#34;1535&#34;&gt;Nombre de loop très élevés&lt;/li&gt;&#xA;&lt;li class=&#34;&#34; data-start=&#34;1520&#34; data-end=&#34;1535&#34;&gt;Souvent précédé d&amp;#8217;un Nested Loop plus haut dans le plan d&amp;#8217;exécution&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;1577&#34; data-end=&#34;1593&#34;&gt;&lt;strong data-start=&#34;1577&#34; data-end=&#34;1593&#34;&gt;Solutions&lt;/strong&gt;&lt;/p&gt;&#xA;&lt;ul data-start=&#34;1594&#34; data-end=&#34;1764&#34;&gt;&#xA;&lt;li class=&#34;&#34; data-start=&#34;1594&#34; data-end=&#34;1657&#34;&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;1596&#34; data-end=&#34;1657&#34;&gt;Changer le type de jointure pour quelque chose de plus simple a traiter (hash join ou merge join)&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li class=&#34;&#34; data-start=&#34;1658&#34; data-end=&#34;1715&#34;&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;1660&#34; data-end=&#34;1715&#34;&gt;Réécrire la requête pour faire moins de &amp;#8220;aller-retours&amp;#8221;&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li class=&#34;&#34; data-start=&#34;1716&#34; data-end=&#34;1764&#34;&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;1718&#34; data-end=&#34;1764&#34;&gt;Ajouter des index pour faciliter les jointures&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h3 data-start=&#34;1718&#34; data-end=&#34;1764&#34;&gt;&lt;img src=&#34;https://s.w.org/images/core/emoji/16.0.1/72x72/1f50e.png&#34; alt=&#34;🔎&#34; class=&#34;wp-smiley&#34; style=&#34;height: 1em; max-height: 1em;&#34; /&gt; Des estimations loin de la réalité&lt;/h3&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;1826&#34; data-end=&#34;1845&#34;&gt;&lt;strong data-start=&#34;1826&#34; data-end=&#34;1841&#34;&gt;Symptôme&lt;/strong&gt; :&lt;/p&gt;&#xA;&lt;div class=&#34;contain-inline-size rounded-md border-[0.5px] border-token-border-medium relative bg-token-sidebar-surface-primary&#34;&gt;&#xA;&lt;div class=&#34;overflow-y-auto p-4&#34; dir=&#34;ltr&#34;&gt;&lt;code class=&#34;whitespace-pre! language-text&#34;&gt;rows=10   actual rows=10000&lt;br /&gt;&#xA;&lt;/code&gt;&lt;/div&gt;&#xA;&lt;/div&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;1887&#34; data-end=&#34;2017&#34;&gt;&lt;strong data-start=&#34;1887&#34; data-end=&#34;1917&#34;&gt;Pourquoi c’est un souci&lt;/strong&gt;&lt;br data-start=&#34;1917&#34; data-end=&#34;1920&#34; /&gt;PostgreSQL s’est trompé dans son estimation, ce qui l’a peut-être mené à choisir un mauvais plan.&lt;/p&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;2019&#34; data-end=&#34;2179&#34;&gt;&lt;strong data-start=&#34;2019&#34; data-end=&#34;2045&#34;&gt;Comment le voir&lt;/strong&gt;&lt;br data-start=&#34;2045&#34; data-end=&#34;2048&#34; /&gt;Comparez le nombre de rows (estimation) avec les actual rows. Si l’écart est très important, les statistiques sont probablement obsolètes.&lt;/p&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;2181&#34; data-end=&#34;2197&#34;&gt;&lt;strong data-start=&#34;2181&#34; data-end=&#34;2197&#34;&gt;Solutions&lt;/strong&gt;&lt;/p&gt;&#xA;&lt;ul data-start=&#34;2198&#34; data-end=&#34;2421&#34;&gt;&#xA;&lt;li class=&#34;&#34; data-start=&#34;2198&#34; data-end=&#34;2259&#34;&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;2200&#34; data-end=&#34;2259&#34;&gt;Rafraichir les statistiques dans ce cas ne peut pas faire de mal : Analyze ou vaccuum analyze si nécessaire.&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li class=&#34;&#34; data-start=&#34;2260&#34; data-end=&#34;2352&#34;&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;2262&#34; data-end=&#34;2352&#34;&gt;Ajuster les statistiques&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li class=&#34;&#34; data-start=&#34;2353&#34; data-end=&#34;2421&#34;&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;2355&#34; data-end=&#34;2421&#34;&gt;Éviter les expressions trop complexes qui biaisent les estimations&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h3 data-start=&#34;2355&#34; data-end=&#34;2421&#34;&gt;&lt;img src=&#34;https://s.w.org/images/core/emoji/16.0.1/72x72/1f50e.png&#34; alt=&#34;🔎&#34; class=&#34;wp-smiley&#34; style=&#34;height: 1em; max-height: 1em;&#34; /&gt; Un tri qui consomme trop&lt;/h3&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;2494&#34; data-end=&#34;2513&#34;&gt;&lt;strong data-start=&#34;2494&#34; data-end=&#34;2509&#34;&gt;Symptôme&lt;/strong&gt; :&lt;/p&gt;&#xA;&lt;div class=&#34;contain-inline-size rounded-md border-[0.5px] border-token-border-medium relative bg-token-sidebar-surface-primary&#34;&gt;&#xA;&lt;div class=&#34;overflow-y-auto p-4&#34; dir=&#34;ltr&#34;&gt;&lt;code class=&#34;whitespace-pre! language-text&#34;&gt;Sort  (Sort Method: quicksort / external merge, Memory: 100MB)&lt;br /&gt;&#xA;&lt;/code&gt;&lt;/div&gt;&#xA;&lt;/div&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;2590&#34; data-end=&#34;2723&#34;&gt;&lt;strong data-start=&#34;2590&#34; data-end=&#34;2620&#34;&gt;Pourquoi c’est un souci&lt;/strong&gt;&lt;br data-start=&#34;2620&#34; data-end=&#34;2623&#34; /&gt;Le tri est trop gros, PostgreSQL n’arrive plus à le faire en RAM → il passe sur disque → c’est lent.&lt;/p&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;2725&#34; data-end=&#34;2753&#34;&gt;&lt;strong data-start=&#34;2725&#34; data-end=&#34;2751&#34;&gt;Comment le voir&lt;/strong&gt;&lt;/p&gt;&#xA;&lt;ul data-start=&#34;2754&#34; data-end=&#34;2879&#34;&gt;&#xA;&lt;li class=&#34;&#34; data-start=&#34;2754&#34; data-end=&#34;2813&#34;&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;2756&#34; data-end=&#34;2813&#34;&gt;Nœud SORT avec un SORT METHOD lent (EXTERNAL MERGE)&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li class=&#34;&#34; data-start=&#34;2814&#34; data-end=&#34;2843&#34;&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;2816&#34; data-end=&#34;2843&#34;&gt;Consommation mémoire élevée&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li class=&#34;&#34; data-start=&#34;2844&#34; data-end=&#34;2879&#34;&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;2846&#34; data-end=&#34;2879&#34;&gt;Étape qui prend beaucoup de temps&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;2881&#34; data-end=&#34;2897&#34;&gt;&lt;strong data-start=&#34;2881&#34; data-end=&#34;2897&#34;&gt;Solutions&lt;/strong&gt;&lt;/p&gt;&#xA;&lt;ul data-start=&#34;2898&#34; data-end=&#34;3077&#34;&gt;&#xA;&lt;li class=&#34;&#34; data-start=&#34;2898&#34; data-end=&#34;2962&#34;&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;2900&#34; data-end=&#34;2962&#34;&gt;Ajouter un index sur les colonnes utilisées dans le ORDER BY&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li class=&#34;&#34; data-start=&#34;2963&#34; data-end=&#34;3027&#34;&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;2965&#34; data-end=&#34;3027&#34;&gt;Réduire la quantité de lignes à trier avec un LIMIT en amont&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li class=&#34;&#34; data-start=&#34;3028&#34; data-end=&#34;3077&#34;&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;3030&#34; data-end=&#34;3077&#34;&gt;Éviter les sous-requêtes non filtrées avant tri&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h3 data-start=&#34;3030&#34; data-end=&#34;3077&#34;&gt;&lt;img src=&#34;https://s.w.org/images/core/emoji/16.0.1/72x72/1f50e.png&#34; alt=&#34;🔎&#34; class=&#34;wp-smiley&#34; style=&#34;height: 1em; max-height: 1em;&#34; /&gt; Une clause Limit inefficace&lt;/h3&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;3164&#34; data-end=&#34;3183&#34;&gt;&lt;strong data-start=&#34;3164&#34; data-end=&#34;3179&#34;&gt;Symptôme&lt;/strong&gt; :&lt;/p&gt;&#xA;&lt;div class=&#34;contain-inline-size rounded-md border-[0.5px] border-token-border-medium relative bg-token-sidebar-surface-primary&#34;&gt;&#xA;&lt;div class=&#34;overflow-y-auto p-4&#34; dir=&#34;ltr&#34;&gt;&lt;code class=&#34;whitespace-pre! language-text&#34;&gt;Sort → Limit&lt;br /&gt;&#xA;&lt;/code&gt;&lt;/div&gt;&#xA;&lt;/div&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;3210&#34; data-end=&#34;3355&#34;&gt;&lt;strong data-start=&#34;3210&#34; data-end=&#34;3240&#34;&gt;Pourquoi c’est un souci&lt;/strong&gt;&lt;br data-start=&#34;3240&#34; data-end=&#34;3243&#34; /&gt;PostgreSQL trie &lt;em data-start=&#34;3259&#34; data-end=&#34;3266&#34;&gt;toute&lt;/em&gt; la table avant d’en extraire 10 lignes. S’il y a 1 million de lignes, c’est pas optimal.&lt;/p&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;3357&#34; data-end=&#34;3385&#34;&gt;&lt;strong data-start=&#34;3357&#34; data-end=&#34;3383&#34;&gt;Comment le voir&lt;/strong&gt;&lt;/p&gt;&#xA;&lt;ul data-start=&#34;3386&#34; data-end=&#34;3479&#34;&gt;&#xA;&lt;li class=&#34;&#34; data-start=&#34;3386&#34; data-end=&#34;3422&#34;&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;3388&#34; data-end=&#34;3422&#34;&gt;Le SORT est au-dessus du LIMIT&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li class=&#34;&#34; data-start=&#34;3423&#34; data-end=&#34;3479&#34;&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;3425&#34; data-end=&#34;3479&#34;&gt;Le tri prend beaucoup de temps même pour un LIMIT 10&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;3481&#34; data-end=&#34;3497&#34;&gt;&lt;strong data-start=&#34;3481&#34; data-end=&#34;3497&#34;&gt;Solutions&lt;/strong&gt;&lt;/p&gt;&#xA;&lt;ul data-start=&#34;3498&#34; data-end=&#34;3678&#34;&gt;&#xA;&lt;li class=&#34;&#34; data-start=&#34;3498&#34; data-end=&#34;3588&#34;&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;3500&#34; data-end=&#34;3588&#34;&gt;Utiliser un index qui permet de lire déjà trié (ORDER BY created_at DESC → index DESC)&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li class=&#34;&#34; data-start=&#34;3589&#34; data-end=&#34;3678&#34;&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;3591&#34; data-end=&#34;3678&#34;&gt;Repenser la requête pour éviter le tri global (ex : préfiltrage ou pagination efficace)&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h3 data-start=&#34;3591&#34; data-end=&#34;3678&#34;&gt;&lt;img src=&#34;https://s.w.org/images/core/emoji/16.0.1/72x72/1f50e.png&#34; alt=&#34;🔎&#34; class=&#34;wp-smiley&#34; style=&#34;height: 1em; max-height: 1em;&#34; /&gt; Des filtres appliqués trop tard&lt;/h3&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;3744&#34; data-end=&#34;3763&#34;&gt;&lt;strong data-start=&#34;3744&#34; data-end=&#34;3759&#34;&gt;Symptôme&lt;/strong&gt; :&lt;/p&gt;&#xA;&lt;div class=&#34;contain-inline-size rounded-md border-[0.5px] border-token-border-medium relative bg-token-sidebar-surface-primary&#34;&gt;&#xA;&lt;div class=&#34;overflow-y-auto p-4&#34; dir=&#34;ltr&#34;&gt;&lt;code class=&#34;whitespace-pre! language-text&#34;&gt;Rows Removed by Filter: 999000&lt;br /&gt;&#xA;&lt;/code&gt;&lt;/div&gt;&#xA;&lt;/div&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;3808&#34; data-end=&#34;3948&#34;&gt;&lt;strong data-start=&#34;3808&#34; data-end=&#34;3838&#34;&gt;Pourquoi c’est un souci&lt;/strong&gt;&lt;br data-start=&#34;3838&#34; data-end=&#34;3841&#34; /&gt;Le filtre est appliqué après avoir lu la majorité des lignes → PostgreSQL fait beaucoup de travail inutile.&lt;/p&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;3950&#34; data-end=&#34;3978&#34;&gt;&lt;strong data-start=&#34;3950&#34; data-end=&#34;3976&#34;&gt;Comment le voir&lt;/strong&gt;&lt;/p&gt;&#xA;&lt;ul data-start=&#34;3979&#34; data-end=&#34;4071&#34;&gt;&#xA;&lt;li class=&#34;&#34; data-start=&#34;3979&#34; data-end=&#34;4023&#34;&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;3981&#34; data-end=&#34;4023&#34;&gt;Présence de FILTER (&amp;#8230;) en bas de plan&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li class=&#34;&#34; data-start=&#34;4024&#34; data-end=&#34;4071&#34;&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;4026&#34; data-end=&#34;4071&#34;&gt;Très grand nombre de ROWS REMOVED BY FILTER&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;4073&#34; data-end=&#34;4089&#34;&gt;&lt;strong data-start=&#34;4073&#34; data-end=&#34;4089&#34;&gt;Solutions&lt;/strong&gt;&lt;/p&gt;&#xA;&lt;ul data-start=&#34;4090&#34; data-end=&#34;4311&#34;&gt;&#xA;&lt;li class=&#34;&#34; data-start=&#34;4090&#34; data-end=&#34;4120&#34;&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;4092&#34; data-end=&#34;4120&#34;&gt;Indexer la colonne du filtre&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li class=&#34;&#34; data-start=&#34;4121&#34; data-end=&#34;4203&#34;&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;4123&#34; data-end=&#34;4203&#34;&gt;Réécrire la requête pour que le filtre soit pris en compte plus tôt dans le plan&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li class=&#34;&#34; data-start=&#34;4204&#34; data-end=&#34;4311&#34;&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;4206&#34; data-end=&#34;4311&#34;&gt;Éviter les fonctions non indexables dans le WHERE (ex : LOWER(email) → préférer un index fonctionnel)&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;h1&gt;Conclusion&lt;/h1&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;313&#34; data-end=&#34;605&#34;&gt;Comme souvent avec PostgreSQL, il est difficile — voire impossible — de tout couvrir en un seul article. Chaque plan d&amp;#8217;exécution est unique, chaque requête a ses subtilités, et chaque base de données a ses petites surprises. Il n’existe pas de recette miracle qui marcherait à tous les coups.&lt;/p&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;607&#34; data-end=&#34;813&#34;&gt;Mais avec les bons réflexes, quelques outils et un peu de méthode, on peut rapidement progresser : repérer les symptômes, lire les signes, poser les bonnes questions… et surtout, tester, encore et toujours.&lt;/p&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;607&#34; data-end=&#34;813&#34;&gt;EXPLAIN ANALYZE n’est pas réservé aux DBA ou aux experts en perfs. C’est un compagnon de route pour toute personne qui écrit des requêtes, et qui veut comprendre ce qui se passe sous le capot.&lt;/p&gt;&#xA;&lt;p class=&#34;&#34; data-start=&#34;1011&#34; data-end=&#34;1213&#34;&gt;Et si vous vous sentez encore un peu perdu·e face à un plan trop verbeux : pas de panique. Avec l’habitude, ça devient un langage qu’on apprend à lire presque instinctivement. Et ça commence maintenant.&lt;/p&gt;&#xA;&lt;p&gt;&lt;strong&gt;Continuez votre lecture sur le blog :&lt;/strong&gt;&lt;/p&gt;&#xA;&lt;ul class=&#34;similar-posts&#34;&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://blog.capdata.fr/index.php/pruning-de-partitions-sous-postgresql/&#34; rel=&#34;bookmark&#34; title=&#34;7 décembre 2020&#34;&gt;&amp;#8220;Pruning&amp;#8221; de partitions sous PostgreSQL ou comment bien élaguer !&lt;/a&gt; (Capdata team) [PostgreSQL]&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://blog.capdata.fr/index.php/postgresql-13-les-nouveautes-interessantes/&#34; rel=&#34;bookmark&#34; title=&#34;30 octobre 2020&#34;&gt;PostgreSQL 13 : présentation&lt;/a&gt; (Emmanuel RAMI) [PostgreSQL]&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://blog.capdata.fr/index.php/nouveautes-pg_stat_statements-avec-postgresql-15/&#34; rel=&#34;bookmark&#34; title=&#34;16 mars 2023&#34;&gt;Nouveautés pg_stat_statements avec PostgreSQL 15&lt;/a&gt; (David Baffaleuf) [PostgreSQL]&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://blog.capdata.fr/index.php/postgresql-optimiser-vos-operations-vacuum-et-analyze/&#34; rel=&#34;bookmark&#34; title=&#34;26 février 2025&#34;&gt;PostgreSQL : optimiser vos opérations vacuum et analyze !&lt;/a&gt; (Emmanuel RAMI) [PostgreSQL]&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://blog.capdata.fr/index.php/query-store-bloquer-les-regressions-de-plans-dexecution-et-capture-mode/&#34; rel=&#34;bookmark&#34; title=&#34;6 avril 2022&#34;&gt;Query Store : bloquer les régressions de plans d&amp;#8217;exécution et Capture Mode&lt;/a&gt; (Capdata team) [SQL Server]&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;&lt;!-- Similar Posts took 2.272 ms --&gt;&lt;/p&gt;&#xA;&lt;a class=&#34;synved-social-button synved-social-button-share synved-social-size-24 synved-social-resolution-single synved-social-provider-twitter nolightbox&#34; data-provider=&#34;twitter&#34; target=&#34;_blank&#34; rel=&#34;nofollow&#34; title=&#34;Share on Twitter&#34; href=&#34;https://twitter.com/intent/tweet?url=https%3A%2F%2Fblog.capdata.fr%2F%3Fp%3D10697&amp;#038;text=Article%20sur%20le%20blog%20de%20la%20Capdata%20Tech%20Team%20%3A%20&#34; style=&#34;font-size: 0px;width:24px;height:24px;margin:0;margin-bottom:5px;margin-right:5px&#34;&gt;&lt;img decoding=&#34;async&#34; alt=&#34;twitter&#34; title=&#34;Share on Twitter&#34; class=&#34;synved-share-image synved-social-image synved-social-image-share&#34; width=&#34;24&#34; height=&#34;24&#34; style=&#34;display: inline;width:24px;height:24px;margin: 0;padding: 0;border: none;box-shadow: none&#34; src=&#34;https://blog.capdata.fr/wp-content/plugins/social-media-feather/synved-social/image/social/regular/48x48/twitter.png&#34; /&gt;&lt;/a&gt;&lt;a class=&#34;synved-social-button synved-social-button-share synved-social-size-24 synved-social-resolution-single synved-social-provider-linkedin nolightbox&#34; data-provider=&#34;linkedin&#34; target=&#34;_blank&#34; rel=&#34;nofollow&#34; title=&#34;Share on Linkedin&#34; href=&#34;https://www.linkedin.com/shareArticle?mini=true&amp;#038;url=https%3A%2F%2Fblog.capdata.fr%2F%3Fp%3D10697&amp;#038;title=PostgreSQL%20Basics%20%3A%20lire%20un%20plan%20d%E2%80%99ex%C3%A9cution%20comme%20un%C2%B7e%20pro%20%28ou%20presque%29&#34; style=&#34;font-size: 0px;width:24px;height:24px;margin:0;margin-bottom:5px;margin-right:5px&#34;&gt;&lt;img decoding=&#34;async&#34; alt=&#34;linkedin&#34; title=&#34;Share on Linkedin&#34; class=&#34;synved-share-image synved-social-image synved-social-image-share&#34; width=&#34;24&#34; height=&#34;24&#34; style=&#34;display: inline;width:24px;height:24px;margin: 0;padding: 0;border: none;box-shadow: none&#34; src=&#34;https://blog.capdata.fr/wp-content/plugins/social-media-feather/synved-social/image/social/regular/48x48/linkedin.png&#34; /&gt;&lt;/a&gt;&lt;a class=&#34;synved-social-button synved-social-button-share synved-social-size-24 synved-social-resolution-single synved-social-provider-mail nolightbox&#34; data-provider=&#34;mail&#34; rel=&#34;nofollow&#34; title=&#34;Share by email&#34; href=&#34;mailto:?subject=PostgreSQL%20Basics%20%3A%20lire%20un%20plan%20d%E2%80%99ex%C3%A9cution%20comme%20un%C2%B7e%20pro%20%28ou%20presque%29&amp;#038;body=Article%20sur%20le%20blog%20de%20la%20Capdata%20Tech%20Team%20%3A%20:%20https%3A%2F%2Fblog.capdata.fr%2F%3Fp%3D10697&#34; style=&#34;font-size: 0px;width:24px;height:24px;margin:0;margin-bottom:5px&#34;&gt;&lt;img decoding=&#34;async&#34; alt=&#34;mail&#34; title=&#34;Share by email&#34; class=&#34;synved-share-image synved-social-image synved-social-image-share&#34; width=&#34;24&#34; height=&#34;24&#34; style=&#34;display: inline;width:24px;height:24px;margin: 0;padding: 0;border: none;box-shadow: none&#34; src=&#34;https://blog.capdata.fr/wp-content/plugins/social-media-feather/synved-social/image/social/regular/48x48/mail.png&#34; /&gt;&lt;/a&gt;&lt;p&gt;L’article &lt;a rel=&#34;nofollow&#34; href=&#34;https://blog.capdata.fr/index.php/postgresql-basics-lire-un-plan-dexecution/&#34;&gt;PostgreSQL Basics : lire un plan d&amp;#8217;exécution comme un·e pro (ou presque)&lt;/a&gt; est apparu en premier sur &lt;a rel=&#34;nofollow&#34; href=&#34;https://blog.capdata.fr&#34;&gt;Capdata TECH BLOG&lt;/a&gt;.&lt;/p&gt;&#xA;</content>
    <link href="https://blog.capdata.fr/index.php/postgresql-basics-lire-un-plan-dexecution/" rel="alternate"></link>
    <summary type="html">&lt;p&gt;Introduction : Quand une requête PostgreSQL est considérée comme lente ou que ses performances se dégradent soudainement, il y a un réflexe à toujours avoir : utiliser les plans d&amp;#8217;exécution. Je n’apprends certainement rien à la majorité des personnes qui&amp;#8230; &lt;a href=&#34;https://blog.capdata.fr/index.php/postgresql-basics-lire-un-plan-dexecution/&#34; class=&#34;more-link&#34;&gt;Continuer la lecture &lt;span class=&#34;meta-nav&#34;&gt;&amp;#8594;&lt;/span&gt;&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;L’article &lt;a rel=&#34;nofollow&#34; href=&#34;https://blog.capdata.fr/index.php/postgresql-basics-lire-un-plan-dexecution/&#34;&gt;PostgreSQL Basics : lire un plan d&amp;#8217;exécution comme un·e pro (ou presque)&lt;/a&gt; est apparu en premier sur &lt;a rel=&#34;nofollow&#34; href=&#34;https://blog.capdata.fr&#34;&gt;Capdata TECH BLOG&lt;/a&gt;.&lt;/p&gt;&#xA;</summary>
    <author>
      <name>Sarah FAVEERE</name>
    </author>
  </entry>
  <entry>
    <title>PostgreSQL : optimiser vos opérations vacuum et analyze !</title>
    <updated>2025-02-26T11:00:21Z</updated>
    <id>tag:blog.capdata.fr,2025-02-26:/index.php/postgresql-optimiser-vos-operations-vacuum-et-analyze/</id>
    <content type="html">&lt;a class=&#34;synved-social-button synved-social-button-share synved-social-size-24 synved-social-resolution-single synved-social-provider-twitter nolightbox&#34; data-provider=&#34;twitter&#34; target=&#34;_blank&#34; rel=&#34;nofollow&#34; title=&#34;Share on Twitter&#34; href=&#34;https://twitter.com/intent/tweet?url=https%3A%2F%2Fblog.capdata.fr%2F%3Fp%3D10670&amp;#038;text=Article%20sur%20le%20blog%20de%20la%20Capdata%20Tech%20Team%20%3A%20&#34; style=&#34;font-size: 0px;width:24px;height:24px;margin:0;margin-bottom:5px;margin-right:5px&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; alt=&#34;twitter&#34; title=&#34;Share on Twitter&#34; class=&#34;synved-share-image synved-social-image synved-social-image-share&#34; width=&#34;24&#34; height=&#34;24&#34; style=&#34;display: inline;width:24px;height:24px;margin: 0;padding: 0;border: none;box-shadow: none&#34; src=&#34;https://blog.capdata.fr/wp-content/plugins/social-media-feather/synved-social/image/social/regular/48x48/twitter.png&#34; /&gt;&lt;/a&gt;&lt;a class=&#34;synved-social-button synved-social-button-share synved-social-size-24 synved-social-resolution-single synved-social-provider-linkedin nolightbox&#34; data-provider=&#34;linkedin&#34; target=&#34;_blank&#34; rel=&#34;nofollow&#34; title=&#34;Share on Linkedin&#34; href=&#34;https://www.linkedin.com/shareArticle?mini=true&amp;#038;url=https%3A%2F%2Fblog.capdata.fr%2F%3Fp%3D10670&amp;#038;title=PostgreSQL%20%3A%20optimiser%20vos%20op%C3%A9rations%20vacuum%20et%20analyze%20%21&#34; style=&#34;font-size: 0px;width:24px;height:24px;margin:0;margin-bottom:5px;margin-right:5px&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; alt=&#34;linkedin&#34; title=&#34;Share on Linkedin&#34; class=&#34;synved-share-image synved-social-image synved-social-image-share&#34; width=&#34;24&#34; height=&#34;24&#34; style=&#34;display: inline;width:24px;height:24px;margin: 0;padding: 0;border: none;box-shadow: none&#34; src=&#34;https://blog.capdata.fr/wp-content/plugins/social-media-feather/synved-social/image/social/regular/48x48/linkedin.png&#34; /&gt;&lt;/a&gt;&lt;a class=&#34;synved-social-button synved-social-button-share synved-social-size-24 synved-social-resolution-single synved-social-provider-mail nolightbox&#34; data-provider=&#34;mail&#34; rel=&#34;nofollow&#34; title=&#34;Share by email&#34; href=&#34;mailto:?subject=PostgreSQL%20%3A%20optimiser%20vos%20op%C3%A9rations%20vacuum%20et%20analyze%20%21&amp;#038;body=Article%20sur%20le%20blog%20de%20la%20Capdata%20Tech%20Team%20%3A%20:%20https%3A%2F%2Fblog.capdata.fr%2F%3Fp%3D10670&#34; style=&#34;font-size: 0px;width:24px;height:24px;margin:0;margin-bottom:5px&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; alt=&#34;mail&#34; title=&#34;Share by email&#34; class=&#34;synved-share-image synved-social-image synved-social-image-share&#34; width=&#34;24&#34; height=&#34;24&#34; style=&#34;display: inline;width:24px;height:24px;margin: 0;padding: 0;border: none;box-shadow: none&#34; src=&#34;https://blog.capdata.fr/wp-content/plugins/social-media-feather/synved-social/image/social/regular/48x48/mail.png&#34; /&gt;&lt;/a&gt;&lt;p&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; class=&#34;alignnone size-medium wp-image-10677&#34; src=&#34;https://blog.capdata.fr/wp-content/uploads/2025/02/vacuum-300x200.png&#34; alt=&#34;&#34; width=&#34;300&#34; height=&#34;200&#34; srcset=&#34;https://blog.capdata.fr/wp-content/uploads/2025/02/vacuum-300x200.png 300w, https://blog.capdata.fr/wp-content/uploads/2025/02/vacuum-768x513.png 768w, https://blog.capdata.fr/wp-content/uploads/2025/02/vacuum.png 800w&#34; sizes=&#34;auto, (max-width: 300px) 100vw, 300px&#34; /&gt;&lt;/p&gt;&#xA;&lt;p&gt;Hello&lt;/p&gt;&#xA;&lt;p&gt;pour commencer cette année 2025 , voici un petit article PostgreSQL ou l&amp;#8217;on vous présente comment optimiser les opérations de maintenance que sont les VACUUM et les ANALYZE.&lt;/p&gt;&#xA;&lt;p&gt;Ces 2 opérations sont essentielles pour conserver des performances optimales pour notre instance et garantir au planner de construire des plans d&amp;#8217;exécutions optimisés.&lt;/p&gt;&#xA;&lt;p&gt;les opérations VACUUM et/ou ANALYZE peuvent être longues et sources de nombreuses écritures dans les WALs sur des tables volumineuses.&lt;br /&gt;&#xA;C&amp;#8217;est pourquoi, et ce depuis la version &lt;strong&gt;PostgreSQL 16&lt;/strong&gt;, il est possible de modifier le comportement de ces opérations en affectant une taille de buffer. Il s&amp;#8217;agit du &amp;#8220;&lt;a href=&#34;https://www.postgresql.org/docs/current/runtime-config-resource.html#GUC-VACUUM-BUFFER-USAGE-LIMIT&#34;&gt;buffer_usage_limit&lt;/a&gt;&amp;#8220;.&lt;/p&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;h2&gt;Principe de fonctionnement.&lt;/h2&gt;&#xA;&lt;p&gt;Ce procédé s&amp;#8217;appuie sur le principe de &amp;#8220;ring buffer&amp;#8221; configuré pour PostgreSQL.&lt;/p&gt;&#xA;&lt;p&gt;Attention, à ne pas confondre, évidement, avec les &amp;#8220;rings buffer&amp;#8221; de SQL Server !!&lt;/p&gt;&#xA;&lt;p&gt;Pour rappel, PostgreSQL utilise cette stratégie de &amp;#8220;ring buffer&amp;#8221; afin de dédier un espace mémoire pour les opérations lourdes , telles, la lecture séquentielle sur une table volumineuse, un CREATE TABLE AS SELECT, un COPY&amp;#8230;. mais aussi un VACUUM !&lt;/p&gt;&#xA;&lt;p&gt;En fait, cet espace est utilisé pour éviter de &amp;#8220;flusher&amp;#8221; sur disque de manière trop brutale les pages en mémoire montées dans le &amp;#8220;&lt;strong&gt;shared buffer&lt;/strong&gt;&amp;#8220;. Cela pénaliserait en grande partie toute opération concurrente à notre traitement actif puisqu&amp;#8217;elle n&amp;#8217;aurait plus d&amp;#8217;espace pour mettre ses propres pages en mémoire.&lt;/p&gt;&#xA;&lt;p&gt;Jusqu&amp;#8217;à la version PostgreSQL 16, cet espace mémoire était défini à&lt;strong&gt; 256Ko&lt;/strong&gt;. Ainsi, au cours d&amp;#8217;une lecture séquentielle, chaque page  de &lt;strong&gt;8Ko&lt;/strong&gt; par défaut, est montée en mémoire dans cet espace si le nombre de pages totales à traiter pour la table, dépasse 1/4 du paramètre &amp;#8220;&lt;strong&gt;shared_buffer&lt;/strong&gt;&amp;#8220;.&lt;/p&gt;&#xA;&lt;p&gt;Il en est de même pour une opération VACUUM ou ANALYZE qui utilise également ce ring buffer et permet d&amp;#8217;optimiser cette opération.&lt;/p&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;h3&gt;Nouveautés PostgreSQL 16 et PostgreSQL 17&lt;/h3&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;p&gt;Depuis la version PostgreSQL 16, il est possible de configurer la taille du buffer de façon unitaire. Par exemple, lors d&amp;#8217;un VACUUM, il est tout à fait possible de choisir une valeur pour &amp;#8220;&lt;strong&gt;BUFFER_USAGE_LIMIT&lt;/strong&gt;&amp;#8220;.&lt;/p&gt;&#xA;&lt;p&gt;Depuis le version PostgreSQL 17, la valeur par défaut affectée à &amp;#8220;&lt;strong&gt;BUFFER_USAGE_LIMIT&lt;/strong&gt;&amp;#8221; est de &lt;strong&gt;2Mo&lt;/strong&gt;.&lt;/p&gt;&#xA;&lt;p&gt;Il vous est possible de paramétrer la valeur de &lt;strong&gt;128Ko&lt;/strong&gt; jusqu&amp;#8217;à &lt;strong&gt;16Go&lt;/strong&gt;. Attention, cependant, cette valeur ne peux excéder &lt;strong&gt;1/8&lt;/strong&gt; du paramètre &amp;#8220;&lt;strong&gt;shared_buffer&lt;/strong&gt;&amp;#8220;.&lt;br /&gt;&#xA;Si vous faites le calcul, pour un serveur comportant &lt;strong&gt;32Go de RAM&lt;/strong&gt;, vous ne pourrez obtenir, au plus, &lt;strong&gt;1Go&lt;/strong&gt; pour votre ring buffer.&lt;/p&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;h5&gt;Cas d&amp;#8217;utilisation pour un VACUUM&lt;/h5&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;p&gt;Sur une instance PostgreSQL 13, nous lançons un VACUUM simple sur une table de 2,5Go. Nous utilisons une base exemple créée via &amp;#8220;pgbench&amp;#8221;.&lt;/p&gt;&#xA;&lt;p&gt;Nous avons utilisé les options &amp;#8220;&lt;strong&gt;DISABLE_PAGE_SKIPPING&lt;/strong&gt;&amp;#8221; pour analyser, dans un premier temps, tous les blocs de notre table et ne pas sur baser sur les informations de la visibility_map.&lt;/p&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: sql; title: ; notranslate&#34;&gt;(postgres@[local]:5433) [pgbenchmark] primaire $  vacuum (verbose,DISABLE_PAGE_SKIPPING) public.pgbench_accounts;&#xD;&#xA;INFO: 00000: aggressively vacuuming &amp;quot;public.pgbench_accounts&amp;quot;&#xD;&#xA;LOCATION: lazy_scan_heap, vacuumlazy.c:797&#xD;&#xA;INFO: 00000: &amp;quot;pgbench_accounts&amp;quot;: found 0 removable, 20000000 nonremovable row versions in 327869 out of 327869 pages&#xD;&#xA;DETAIL: 0 dead row versions cannot be removed yet, oldest xmin: 196215&#xD;&#xA;There were 0 unused item identifiers.&#xD;&#xA;Skipped 0 pages due to buffer pins, 0 frozen pages.&#xD;&#xA;0 pages are entirely empty.&#xD;&#xA;CPU: user: 1.34 s, system: 0.67 s, elapsed: 18.90 s.&#xD;&#xA;LOCATION: lazy_scan_heap, vacuumlazy.c:1759&#xD;&#xA;VACUUM&#xD;&#xA;Time: 18920.292 ms (00:18.920)&lt;/pre&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;p&gt;Le temps passé pour cette opération est d&amp;#8217;un peu plus de 18 secondes en temps CPU pour analyser les 327869 blocs de notre table. Soit une taille de 2.5Go.&lt;/p&gt;&#xA;&lt;p&gt;Nous effectuons la même opération sur cette même table, mais sur un moteur &lt;strong&gt;PostgreSQL 17&lt;/strong&gt;. Nous positionnons le paramètre &lt;strong&gt;BUFFER_USAGE_LIMIT&lt;/strong&gt;  à &lt;strong&gt;8Mo&lt;/strong&gt;.&lt;/p&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: sql; title: ; notranslate&#34;&gt;(postgres@[local]:5437) [pgbenchmark] primaire $  vacuum (verbose,DISABLE_PAGE_SKIPPING,BUFFER_USAGE_LIMIT &#39;8MB&#39;) public.pgbench_accounts;&#xD;&#xA;INFO: 00000: aggressively vacuuming &amp;quot;pgbenchmark.public.pgbench_accounts&amp;quot;&#xD;&#xA;LOCATION: heap_vacuum_rel, vacuumlazy.c:475&#xD;&#xA;INFO: 00000: finished vacuuming &amp;quot;pgbenchmark.public.pgbench_accounts&amp;quot;: index scans: 0&#xD;&#xA;pages: 0 removed, 327869 remain, 327869 scanned (100.00% of total)&#xD;&#xA;tuples: 0 removed, 20000000 remain, 0 are dead but not yet removable&#xD;&#xA;removable cutoff: 208163, which was 0 XIDs old when operation ended&#xD;&#xA;new relfrozenxid: 208163, which is 5 XIDs ahead of previous value&#xD;&#xA;frozen: 0 pages from table (0.00% of total) had 0 tuples frozen&#xD;&#xA;index scan not needed: 0 pages from table (0.00% of total) had 0 dead item identifiers removed&#xD;&#xA;avg read rate: 134.208 MB/s, avg write rate: 0.034 MB/s&#xD;&#xA;buffer usage: 330350 hits, 325508 misses, 83 dirtied&#xD;&#xA;WAL usage: 84 records, 83 full page images, 684232 bytes&#xD;&#xA;system usage: CPU: user: 1.41 s, system: 0.64 s, elapsed: 18.94 s&#xD;&#xA;LOCATION: heap_vacuum_rel, vacuumlazy.c:763&#xD;&#xA;VACUUM&#xD;&#xA;Time: 18955.006 ms (00:18.955)&lt;/pre&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;p&gt;C&amp;#8217;est  à peu de chose près, dans le même temps d&amp;#8217;exécution. soir 18 secondes.&lt;/p&gt;&#xA;&lt;p&gt;La suite consiste à redémarrer l&amp;#8217;instance PostgreSQL 17 et constater les temps d&amp;#8217;exécution pour chaque occurrence de lancement.&lt;br /&gt;&#xA;Nous exécutons donc, les mêmes ordres VACUUM, mais sans l&amp;#8217;option &amp;#8220;&lt;strong&gt;DISABLE_PAGE_SKIPPING&lt;/strong&gt;&amp;#8221;&lt;/p&gt;&#xA;&lt;p&gt;Sur la version PostgreSQL 13, nous voyons qu&amp;#8217;à la première exécution, juste après redémarrage, nous sommes à 32 millisecondes. Et à chaque exécution suivante, nous ne descendons pas en dessous de 15 millisecondes&amp;#8230;.&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: sql; title: ; notranslate&#34;&gt;(postgres@[local]:5433) [pgbenchmark] primaire $  vacuum public.pgbench_accounts;&#xD;&#xA;VACUUM&#xD;&#xA;Time: 32.149 ms&#xD;&#xA;&#xD;&#xA;(postgres@[local]:5433) [pgbenchmark] primaire $  vacuum public.pgbench_accounts;&#xD;&#xA;VACUUM&#xD;&#xA;Time: 15.001 ms&#xD;&#xA;&#xD;&#xA;(postgres@[local]:5433) [pgbenchmark] primaire $  vacuum public.pgbench_accounts;&#xD;&#xA;VACUUM&#xD;&#xA;Time: 15.295 ms&lt;/pre&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;p&gt;En version PostgreSQL 17, nous faisons également un &amp;#8220;flush&amp;#8221; des pages dans le buffer cache à chaque exécution, tout en modifiant la valeur de &amp;#8220;&lt;strong&gt;BUFFER_USAGE_LIMIT&lt;/strong&gt;&amp;#8220;.&lt;/p&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: sql; title: ; notranslate&#34;&gt;(postgres@[local]:5437) [pgbenchmark] primaire $  vacuum (BUFFER_USAGE_LIMIT &#39;128kB&#39;) public.pgbench_accounts;&#xD;&#xA;VACUUM&#xD;&#xA;Time: 18.098 ms&#xD;&#xA;&#xD;&#xA;(postgres@[local]:5437) [pgbenchmark] primaire $  vacuum (BUFFER_USAGE_LIMIT &#39;8MB&#39;) public.pgbench_accounts;&#xD;&#xA;VACUUM&#xD;&#xA;Time: 6.461 ms&#xD;&#xA;&#xD;&#xA;(postgres@[local]:5437) [pgbenchmark] primaire $  vacuum (BUFFER_USAGE_LIMIT &#39;16MB&#39;) public.pgbench_accounts;&#xD;&#xA;VACUUM&#xD;&#xA;Time: 4.333 ms&lt;/pre&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;p&gt;Le constat est simple, plus nous augmentons le &amp;#8220;&lt;strong&gt;BUFFER_USAGE_LIMIT&lt;/strong&gt;&amp;#8220;, et plus le temps d&amp;#8217;exécution du VACUUM diminue.&lt;/p&gt;&#xA;&lt;p&gt;Nous comprendrons donc que sur une table de plus de 100Go, le gain peut être assez important.&lt;/p&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;h5&gt;Cas d&amp;#8217;utilisation pour un ANALYZE&lt;/h5&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;p&gt;Pour l&amp;#8217;instance PostgreSQL 13, nous exécutons le calcul de statistiques sur cette même table&lt;/p&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: sql; title: ; notranslate&#34;&gt;(postgres@[local]:5433) [pgbenchmark] primaire $  vacuum (analyze,verbose) public.pgbench_accounts;&#xD;&#xA;INFO: 00000: vacuuming &amp;quot;public.pgbench_accounts&amp;quot;&#xD;&#xA;LOCATION: lazy_scan_heap, vacuumlazy.c:802&#xD;&#xA;INFO: 00000: &amp;quot;pgbench_accounts&amp;quot;: found 0 removable, 52 nonremovable row versions in 1 out of 327869 pages&#xD;&#xA;DETAIL: 0 dead row versions cannot be removed yet, oldest xmin: 196278&#xD;&#xA;There were 0 unused item identifiers.&#xD;&#xA;Skipped 0 pages due to buffer pins, 0 frozen pages.&#xD;&#xA;0 pages are entirely empty.&#xD;&#xA;CPU: user: 0.00 s, system: 0.00 s, elapsed: 0.00 s.&#xD;&#xA;LOCATION: lazy_scan_heap, vacuumlazy.c:1759&#xD;&#xA;INFO: 00000: analyzing &amp;quot;public.pgbench_accounts&amp;quot;&#xD;&#xA;LOCATION: do_analyze_rel, analyze.c:336&#xD;&#xA;INFO: 00000: &amp;quot;pgbench_accounts&amp;quot;: scanned 30000 of 327869 pages, containing 1830000 live rows and 0 dead rows; 30000 rows in sample, 20000009 estimated total rows&#xD;&#xA;LOCATION: acquire_sample_rows, analyze.c:1190&#xD;&#xA;VACUUM&#xD;&#xA;Time: 29526.404 ms (00:29.526)&lt;/pre&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;p&gt;Nous sommes autour de 29 secondes pour analyser 30000 pages sur les 32769 que composent cette table.&lt;br /&gt;&#xA;Le sample est choisi en fonction de la valeur de &amp;#8220;&lt;strong&gt;default_statistics_target&lt;/strong&gt;&amp;#8220;, par défaut à 100, avec 30000 lignes analysées par défaut.&lt;/p&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;p&gt;Sur la version PostgreSQL 17, les résultats sont les suivants&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: sql; title: ; notranslate&#34;&gt;(postgres@[local]:5437) [pgbenchmark] primaire $  vacuum (analyze,verbose,BUFFER_USAGE_LIMIT &#39;128kB&#39;) public.pgbench_accounts;&#xD;&#xA;INFO: 00000: vacuuming &amp;quot;pgbenchmark.public.pgbench_accounts&amp;quot;&#xD;&#xA;LOCATION: heap_vacuum_rel, vacuumlazy.c:480&#xD;&#xA;INFO: 00000: finished vacuuming &amp;quot;pgbenchmark.public.pgbench_accounts&amp;quot;: index scans: 0&#xD;&#xA;pages: 0 removed, 327869 remain, 1 scanned (0.00% of total)&#xD;&#xA;tuples: 0 removed, 20000000 remain, 0 are dead but not yet removable&#xD;&#xA;removable cutoff: 208163, which was 0 XIDs old when operation ended&#xD;&#xA;frozen: 0 pages from table (0.00% of total) had 0 tuples frozen&#xD;&#xA;index scan not needed: 0 pages from table (0.00% of total) had 0 dead item identifiers removed&#xD;&#xA;avg read rate: 46.211 MB/s, avg write rate: 0.000 MB/s&#xD;&#xA;buffer usage: 37 hits, 100 misses, 0 dirtied&#xD;&#xA;WAL usage: 0 records, 0 full page images, 0 bytes&#xD;&#xA;system usage: CPU: user: 0.00 s, system: 0.00 s, elapsed: 0.01 s&#xD;&#xA;LOCATION: heap_vacuum_rel, vacuumlazy.c:763&#xD;&#xA;INFO: 00000: analyzing &amp;quot;public.pgbench_accounts&amp;quot;&#xD;&#xA;LOCATION: do_analyze_rel, analyze.c:321&#xD;&#xA;INFO: 00000: &amp;quot;pgbench_accounts&amp;quot;: scanned 30000 of 327869 pages, containing 1830000 live rows and 0 dead rows; 30000 rows in sample, 20000009 estimated total rows&#xD;&#xA;LOCATION: acquire_sample_rows, analyze.c:1301&#xD;&#xA;VACUUM&#xD;&#xA;Time: 8151.201 ms (00:08.151)&#xD;&#xA;&#xD;&#xA;(postgres@[local]:5437) [pgbenchmark] primaire $  vacuum (analyze,BUFFER_USAGE_LIMIT &#39;8MB&#39;) public.pgbench_accounts;&#xD;&#xA;VACUUM&#xD;&#xA;Time: 7282.546 ms (00:07.283)&lt;/pre&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;p&gt;Les différences de gains sont moins impressionnantes que sur un simple VACUUM à chaque changement de &amp;#8220;&lt;strong&gt;BUFFER_USAGE_LIMIT&lt;/strong&gt;&amp;#8220;, mais on voit qu&amp;#8217;en version PostgreSQL 17, nous sommes tout de même 4 fois plus rapide qu&amp;#8217;en version PostgreSQL 13.&lt;/p&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;h4&gt;Remarques&lt;/h4&gt;&#xA;&lt;p&gt;Gardez à l&amp;#8217;esprit que la valeur de &amp;#8220;&lt;strong&gt;BUFFER_USAGE_LIMIT&amp;#8221;&lt;/strong&gt; est plafonnée à &lt;strong&gt;1/8 &lt;/strong&gt;de&lt;strong&gt; &amp;#8220;shared_buffer&amp;#8221;&lt;/strong&gt;. Inutile donc de mettre à 1024Mo, si vous ne possédez que 8Go de RAM.&lt;/p&gt;&#xA;&lt;p&gt;Attention si vous mettez une valeur trop grande, les transactions concurrentes effectuant des lectures séquentielles seront pénalisées par les opérations VACUUM. D&amp;#8217;ailleurs, il est possible de mettre &amp;#8220;&lt;strong&gt;BUFFER_USAGE_LIMIT&lt;/strong&gt;&amp;#8221; à 0, mais ceci n&amp;#8217;est pas conseillé lors d&amp;#8217;une activité transactionnelle en cours.&lt;/p&gt;&#xA;&lt;p&gt;Pour aller plus loin dans l&amp;#8217;optimisation d&amp;#8217;une opération de vacuum, vous pouvez également passer le paramètre &amp;#8220;&lt;strong&gt;INDEX_CLEANUP&lt;/strong&gt;&amp;#8221; à &lt;strong&gt;off&lt;/strong&gt;. Ceci aura pour effet de ne pas s&amp;#8217;occuper de traiter les entrées des index qui pointent sur les lignes mortes de la table.&lt;br /&gt;&#xA;Un &amp;#8220;&lt;strong&gt;REINDEX&lt;/strong&gt;&amp;#8221; sera alors nécessaire à la fin du VACUUM sur les index de la table.&lt;/p&gt;&#xA;&lt;p&gt;De plus, il est possible de positionner l&amp;#8217;option &amp;#8220;&lt;strong&gt;SKIP_DATABASE_STATS&lt;/strong&gt;&amp;#8221; afin d&amp;#8217;indiquer à l&amp;#8217;ordre VACUUM de ne pas rechercher l&amp;#8217;ID de transaction le plus ancien pour l&amp;#8217;ensemble des tables de la base et de geler celui-ci (datfrozenid).&lt;/p&gt;&#xA;&lt;p&gt;Les opérations VACUUM sur les grosses tables seront bien entendu optimisées mais attention aux plages de maintenance choisies !!&lt;/p&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;p&gt;Bonne journée à vous.&lt;/p&gt;&#xA;&lt;p&gt;Emmanuel Rami&lt;/p&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;strong&gt;Continuez votre lecture sur le blog :&lt;/strong&gt;&lt;/p&gt;&#xA;&lt;ul class=&#34;similar-posts&#34;&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://blog.capdata.fr/index.php/postgresql-13-les-nouveautes-interessantes/&#34; rel=&#34;bookmark&#34; title=&#34;30 octobre 2020&#34;&gt;PostgreSQL 13 : présentation&lt;/a&gt; (Emmanuel RAMI) [PostgreSQL]&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://blog.capdata.fr/index.php/pruning-de-partitions-sous-postgresql/&#34; rel=&#34;bookmark&#34; title=&#34;7 décembre 2020&#34;&gt;&amp;#8220;Pruning&amp;#8221; de partitions sous PostgreSQL ou comment bien élaguer !&lt;/a&gt; (Capdata team) [PostgreSQL]&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://blog.capdata.fr/index.php/requetes-consommatrices-sous-postgresql-episode-1/&#34; rel=&#34;bookmark&#34; title=&#34;24 mai 2016&#34;&gt;Requêtes consommatrices sous PostgreSQL (épisode 1)&lt;/a&gt; (David Baffaleuf) [PostgreSQL]&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://blog.capdata.fr/index.php/nouveautes-mysql-8-0-les-histogrammes/&#34; rel=&#34;bookmark&#34; title=&#34;25 juin 2019&#34;&gt;Nouveautés MySQL 8.0 : Les Histogrammes&lt;/a&gt; (Capdata team) [MySQL]&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://blog.capdata.fr/index.php/postgresql-basics-lire-un-plan-dexecution/&#34; rel=&#34;bookmark&#34; title=&#34;13 mai 2025&#34;&gt;PostgreSQL Basics : lire un plan d&amp;#8217;exécution comme un·e pro (ou presque)&lt;/a&gt; (Sarah FAVEERE) [PostgreSQL]&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;&lt;!-- Similar Posts took 2.968 ms --&gt;&lt;/p&gt;&#xA;&lt;a class=&#34;synved-social-button synved-social-button-share synved-social-size-24 synved-social-resolution-single synved-social-provider-twitter nolightbox&#34; data-provider=&#34;twitter&#34; target=&#34;_blank&#34; rel=&#34;nofollow&#34; title=&#34;Share on Twitter&#34; href=&#34;https://twitter.com/intent/tweet?url=https%3A%2F%2Fblog.capdata.fr%2F%3Fp%3D10670&amp;#038;text=Article%20sur%20le%20blog%20de%20la%20Capdata%20Tech%20Team%20%3A%20&#34; style=&#34;font-size: 0px;width:24px;height:24px;margin:0;margin-bottom:5px;margin-right:5px&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; alt=&#34;twitter&#34; title=&#34;Share on Twitter&#34; class=&#34;synved-share-image synved-social-image synved-social-image-share&#34; width=&#34;24&#34; height=&#34;24&#34; style=&#34;display: inline;width:24px;height:24px;margin: 0;padding: 0;border: none;box-shadow: none&#34; src=&#34;https://blog.capdata.fr/wp-content/plugins/social-media-feather/synved-social/image/social/regular/48x48/twitter.png&#34; /&gt;&lt;/a&gt;&lt;a class=&#34;synved-social-button synved-social-button-share synved-social-size-24 synved-social-resolution-single synved-social-provider-linkedin nolightbox&#34; data-provider=&#34;linkedin&#34; target=&#34;_blank&#34; rel=&#34;nofollow&#34; title=&#34;Share on Linkedin&#34; href=&#34;https://www.linkedin.com/shareArticle?mini=true&amp;#038;url=https%3A%2F%2Fblog.capdata.fr%2F%3Fp%3D10670&amp;#038;title=PostgreSQL%20%3A%20optimiser%20vos%20op%C3%A9rations%20vacuum%20et%20analyze%20%21&#34; style=&#34;font-size: 0px;width:24px;height:24px;margin:0;margin-bottom:5px;margin-right:5px&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; alt=&#34;linkedin&#34; title=&#34;Share on Linkedin&#34; class=&#34;synved-share-image synved-social-image synved-social-image-share&#34; width=&#34;24&#34; height=&#34;24&#34; style=&#34;display: inline;width:24px;height:24px;margin: 0;padding: 0;border: none;box-shadow: none&#34; src=&#34;https://blog.capdata.fr/wp-content/plugins/social-media-feather/synved-social/image/social/regular/48x48/linkedin.png&#34; /&gt;&lt;/a&gt;&lt;a class=&#34;synved-social-button synved-social-button-share synved-social-size-24 synved-social-resolution-single synved-social-provider-mail nolightbox&#34; data-provider=&#34;mail&#34; rel=&#34;nofollow&#34; title=&#34;Share by email&#34; href=&#34;mailto:?subject=PostgreSQL%20%3A%20optimiser%20vos%20op%C3%A9rations%20vacuum%20et%20analyze%20%21&amp;#038;body=Article%20sur%20le%20blog%20de%20la%20Capdata%20Tech%20Team%20%3A%20:%20https%3A%2F%2Fblog.capdata.fr%2F%3Fp%3D10670&#34; style=&#34;font-size: 0px;width:24px;height:24px;margin:0;margin-bottom:5px&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; alt=&#34;mail&#34; title=&#34;Share by email&#34; class=&#34;synved-share-image synved-social-image synved-social-image-share&#34; width=&#34;24&#34; height=&#34;24&#34; style=&#34;display: inline;width:24px;height:24px;margin: 0;padding: 0;border: none;box-shadow: none&#34; src=&#34;https://blog.capdata.fr/wp-content/plugins/social-media-feather/synved-social/image/social/regular/48x48/mail.png&#34; /&gt;&lt;/a&gt;&lt;p&gt;L’article &lt;a rel=&#34;nofollow&#34; href=&#34;https://blog.capdata.fr/index.php/postgresql-optimiser-vos-operations-vacuum-et-analyze/&#34;&gt;PostgreSQL : optimiser vos opérations vacuum et analyze !&lt;/a&gt; est apparu en premier sur &lt;a rel=&#34;nofollow&#34; href=&#34;https://blog.capdata.fr&#34;&gt;Capdata TECH BLOG&lt;/a&gt;.&lt;/p&gt;&#xA;</content>
    <link href="https://blog.capdata.fr/index.php/postgresql-optimiser-vos-operations-vacuum-et-analyze/" rel="alternate"></link>
    <summary type="html">&lt;p&gt;Hello pour commencer cette année 2025 , voici un petit article PostgreSQL ou l&amp;#8217;on vous présente comment optimiser les opérations de maintenance que sont les VACUUM et les ANALYZE. Ces 2 opérations sont essentielles pour conserver des performances optimales pour&amp;#8230; &lt;a href=&#34;https://blog.capdata.fr/index.php/postgresql-optimiser-vos-operations-vacuum-et-analyze/&#34; class=&#34;more-link&#34;&gt;Continuer la lecture &lt;span class=&#34;meta-nav&#34;&gt;&amp;#8594;&lt;/span&gt;&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;L’article &lt;a rel=&#34;nofollow&#34; href=&#34;https://blog.capdata.fr/index.php/postgresql-optimiser-vos-operations-vacuum-et-analyze/&#34;&gt;PostgreSQL : optimiser vos opérations vacuum et analyze !&lt;/a&gt; est apparu en premier sur &lt;a rel=&#34;nofollow&#34; href=&#34;https://blog.capdata.fr&#34;&gt;Capdata TECH BLOG&lt;/a&gt;.&lt;/p&gt;&#xA;</summary>
    <author>
      <name>Sarah FAVEERE</name>
    </author>
  </entry>
  <entry>
    <title>La montée de version en zero-downtime : merci la réplication !</title>
    <updated>2024-12-19T10:28:41Z</updated>
    <id>tag:blog.capdata.fr,2024-12-19:/index.php/la-montee-de-version-en-zero-downtime-merci-la-replication/</id>
    <content type="html">&lt;a class=&#34;synved-social-button synved-social-button-share synved-social-size-24 synved-social-resolution-single synved-social-provider-twitter nolightbox&#34; data-provider=&#34;twitter&#34; target=&#34;_blank&#34; rel=&#34;nofollow&#34; title=&#34;Share on Twitter&#34; href=&#34;https://twitter.com/intent/tweet?url=https%3A%2F%2Fblog.capdata.fr%2F%3Fp%3D10633&amp;#038;text=Article%20sur%20le%20blog%20de%20la%20Capdata%20Tech%20Team%20%3A%20&#34; style=&#34;font-size: 0px;width:24px;height:24px;margin:0;margin-bottom:5px;margin-right:5px&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; alt=&#34;twitter&#34; title=&#34;Share on Twitter&#34; class=&#34;synved-share-image synved-social-image synved-social-image-share&#34; width=&#34;24&#34; height=&#34;24&#34; style=&#34;display: inline;width:24px;height:24px;margin: 0;padding: 0;border: none;box-shadow: none&#34; src=&#34;https://blog.capdata.fr/wp-content/plugins/social-media-feather/synved-social/image/social/regular/48x48/twitter.png&#34; /&gt;&lt;/a&gt;&lt;a class=&#34;synved-social-button synved-social-button-share synved-social-size-24 synved-social-resolution-single synved-social-provider-linkedin nolightbox&#34; data-provider=&#34;linkedin&#34; target=&#34;_blank&#34; rel=&#34;nofollow&#34; title=&#34;Share on Linkedin&#34; href=&#34;https://www.linkedin.com/shareArticle?mini=true&amp;#038;url=https%3A%2F%2Fblog.capdata.fr%2F%3Fp%3D10633&amp;#038;title=La%20mont%C3%A9e%20de%20version%20en%20zero-downtime%20%3A%20merci%20la%20r%C3%A9plication%20%21&#34; style=&#34;font-size: 0px;width:24px;height:24px;margin:0;margin-bottom:5px;margin-right:5px&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; alt=&#34;linkedin&#34; title=&#34;Share on Linkedin&#34; class=&#34;synved-share-image synved-social-image synved-social-image-share&#34; width=&#34;24&#34; height=&#34;24&#34; style=&#34;display: inline;width:24px;height:24px;margin: 0;padding: 0;border: none;box-shadow: none&#34; src=&#34;https://blog.capdata.fr/wp-content/plugins/social-media-feather/synved-social/image/social/regular/48x48/linkedin.png&#34; /&gt;&lt;/a&gt;&lt;a class=&#34;synved-social-button synved-social-button-share synved-social-size-24 synved-social-resolution-single synved-social-provider-mail nolightbox&#34; data-provider=&#34;mail&#34; rel=&#34;nofollow&#34; title=&#34;Share by email&#34; href=&#34;mailto:?subject=La%20mont%C3%A9e%20de%20version%20en%20zero-downtime%20%3A%20merci%20la%20r%C3%A9plication%20%21&amp;#038;body=Article%20sur%20le%20blog%20de%20la%20Capdata%20Tech%20Team%20%3A%20:%20https%3A%2F%2Fblog.capdata.fr%2F%3Fp%3D10633&#34; style=&#34;font-size: 0px;width:24px;height:24px;margin:0;margin-bottom:5px&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; alt=&#34;mail&#34; title=&#34;Share by email&#34; class=&#34;synved-share-image synved-social-image synved-social-image-share&#34; width=&#34;24&#34; height=&#34;24&#34; style=&#34;display: inline;width:24px;height:24px;margin: 0;padding: 0;border: none;box-shadow: none&#34; src=&#34;https://blog.capdata.fr/wp-content/plugins/social-media-feather/synved-social/image/social/regular/48x48/mail.png&#34; /&gt;&lt;/a&gt;&lt;h1&gt;Introduction :&lt;/h1&gt;&#xA;&lt;p&gt;Dans le monde des bases de données, garantir une disponibilité continue est une exigence incontournable, surtout pour les systèmes critiques où chaque minute d&amp;#8217;arrêt peut entraîner des pertes significatives. Lorsqu’il s’agit de migrer une base de données vers une nouvelle version, ce défi prend une toute autre dimension. Comment mettre à jour votre système sans interrompre les services, tout en préservant l’intégrité des données ?&lt;/p&gt;&#xA;&lt;p&gt;PostgreSQL offre une solution élégante : la réplication logique. Cet outil permet de transférer des données de manière fluide entre différentes versions de PostgreSQL, tout en maintenant la base de données source opérationnelle. Dans cet article, nous allons explorer étape par étape comment utiliser cette fonctionnalité pour réaliser une montée de version sans temps d&amp;#8217;arrêt, du déploiement initial à la bascule finale vers la nouvelle version.&lt;/p&gt;&#xA;&lt;p&gt;Que vous soyez en train de planifier une migration ou simplement curieux de découvrir les possibilités offertes par PostgreSQL, suivez ce guide pratique qui vous permettra de transformer un défi complexe en une opération maîtrisée et efficace.&lt;/p&gt;&#xA;&lt;h1&gt;Le test :&lt;/h1&gt;&#xA;&lt;ol&gt;&#xA;&lt;li&gt;&#xA;&lt;h3&gt;Préparation&lt;/h3&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&lt;p&gt;Pour tester cette nouvelle méthode, nous aurons besoin de deux instances PostgreSQL. Pour cet article j&amp;#8217;ai choisit de démontrer la technique en migrant d&amp;#8217;une version 14 à une version 17 de PostgreSQL.&lt;/p&gt;&#xA;&lt;p&gt;Je commence donc par installer les versions sur deux machines différentes pouvant communiquer entre elles (c&amp;#8217;est important) :&lt;/p&gt;&#xA;&lt;p&gt;Sur les deux machines nous pouvons exécuter les commandes suivantes :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;&#xD;&#xA;root@ip-192-1-1-246:~# sudo apt update sudo apt upgrade -y&#xD;&#xA;&#xD;&#xA;...&#xD;&#xA;&#xD;&#xA;root@ip-192-1-1-246:~# sudo apt -y install gnupg2 wget vim&#xD;&#xA;&#xD;&#xA;...&#xD;&#xA;&#xD;&#xA;root@ip-192-1-1-246:~# sudo sh -c &#39;echo &amp;quot;deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main&amp;quot; &amp;amp;gt; /etc/apt/sources.list.d/pgdg.list&#39;&#xD;&#xA;root@ip-192-1-1-246:~# curl -fsSL https://www.postgresql.org/media/keys/ACCC4CF8.asc|sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/postgresql.gpg&#xD;&#xA;&#xD;&#xA;root@ip-192-1-1-246:~# sudo apt -y update&#xD;&#xA;Get:1 file:/etc/apt/mirrors/debian.list Mirrorlist [38 B]&#xD;&#xA;Get:2 file:/etc/apt/mirrors/debian-security.list Mirrorlist [47 B]&#xD;&#xA;Hit:3 https://cdn-aws.deb.debian.org/debian bookworm InRelease&#xD;&#xA;Hit:4 https://cdn-aws.deb.debian.org/debian bookworm-updates InRelease&#xD;&#xA;Hit:5 https://cdn-aws.deb.debian.org/debian bookworm-backports InRelease&#xD;&#xA;Hit:6 https://cdn-aws.deb.debian.org/debian-security bookworm-security InRelease&#xD;&#xA;Get:7 http://apt.postgresql.org/pub/repos/apt bookworm-pgdg InRelease [129 kB]&#xD;&#xA;Get:8 http://apt.postgresql.org/pub/repos/apt bookworm-pgdg/main amd64 Packages [359 kB]&#xD;&#xA;Fetched 489 kB in 1s (348 kB/s)&#xD;&#xA;Reading package lists... Done&#xD;&#xA;Building dependency tree... Done&#xD;&#xA;Reading state information... Done&#xD;&#xA;All packages are up to date.&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;p&gt;Puis sur notre première machine :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;&#xD;&#xA;root@ip-192-1-1-246:~# sudo apt install postgresql-14&#xD;&#xA;Reading package lists... Done&#xD;&#xA;Building dependency tree... Done&#xD;&#xA;Reading state information... Done&#xD;&#xA;The following additional packages will be installed:&#xD;&#xA;libcommon-sense-perl libgdbm-compat4 libio-pty-perl libipc-run-perl&#xD;&#xA;libjson-perl libjson-xs-perl libllvm16 libperl5.36 libpq5 libsensors-config&#xD;&#xA;libsensors5 libtypes-serialiser-perl libxslt1.1 libz3-4 logrotate perl&#xD;&#xA;perl-modules-5.36 postgresql-client-14 postgresql-client-common&#xD;&#xA;postgresql-common ssl-cert sysstat&#xD;&#xA;&#xD;&#xA;...&#xD;&#xA;&#xD;&#xA;root@ip-192-1-1-246:~# systemctl status postgresql@14-main.service&#xD;&#xA;● postgresql@14-main.service - PostgreSQL Cluster 14-main&#xD;&#xA;Loaded: loaded (/lib/systemd/system/postgresql@.service; enabled-runtime;&amp;amp;gt;&#xD;&#xA;Active: active (running) since Wed 2024-12-04 09:43:55 UTC; 2min 55s ago&#xD;&#xA;Process: 15248 ExecStart=/usr/bin/pg_ctlcluster --skip-systemctl-redirect &amp;amp;gt;&#xD;&#xA;Main PID: 15253 (postgres)&#xD;&#xA;Tasks: 7 (limit: 4633)&#xD;&#xA;Memory: 17.3M&#xD;&#xA;CPU: 239ms&#xD;&#xA;CGroup: /system.slice/system-postgresql.slice/postgresql@14-main.service&#xD;&#xA;├─15253 /usr/lib/postgresql/14/bin/postgres -D /var/lib/postgresq&amp;amp;gt;&#xD;&#xA;├─15255 &amp;quot;postgres: 14/main: checkpointer &amp;quot;&#xD;&#xA;├─15256 &amp;quot;postgres: 14/main: background writer &amp;quot;&#xD;&#xA;├─15257 &amp;quot;postgres: 14/main: walwriter &amp;quot;&#xD;&#xA;├─15258 &amp;quot;postgres: 14/main: autovacuum launcher &amp;quot;&#xD;&#xA;├─15259 &amp;quot;postgres: 14/main: stats collector &amp;quot;&#xD;&#xA;└─15260 &amp;quot;postgres: 14/main: logical replication launcher &amp;quot;&#xD;&#xA;&#xD;&#xA;Dec 04 09:43:53 ip-192-1-1-246 systemd[1]: Starting postgresql@14-main.service&amp;amp;gt;&#xD;&#xA;Dec 04 09:43:55 ip-192-1-1-246 systemd[1]: Started postgresql@14-main.service &amp;amp;gt;&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;p&gt;Puis sur la deuxième machine :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;&#xD;&#xA;admin@ip-192-1-1-89:~$ sudo apt install postgresql-17&#xD;&#xA;Reading package lists... Done&#xD;&#xA;Building dependency tree... Done&#xD;&#xA;Reading state information... Done&#xD;&#xA;The following additional packages will be installed:&#xD;&#xA;libcommon-sense-perl libgdbm-compat4 libio-pty-perl libipc-run-perl&#xD;&#xA;libjson-perl libjson-xs-perl libllvm16 libperl5.36 libpq5 libsensors-config&#xD;&#xA;libsensors5 libtypes-serialiser-perl libxslt1.1 libz3-4 logrotate perl&#xD;&#xA;perl-modules-5.36 postgresql-client-17 postgresql-client-common&#xD;&#xA;postgresql-common ssl-cert sysstat&#xD;&#xA;&#xD;&#xA;admin@ip-192-1-1-89:~$ systemctl status postgresql@17-main.service&#xD;&#xA;● postgresql@17-main.service - PostgreSQL Cluster 17-main&#xD;&#xA;Loaded: loaded (/lib/systemd/system/postgresql@.service; enabled-runtime; &amp;amp;gt;&#xD;&#xA;Active: active (running) since Wed 2024-12-04 09:52:33 UTC; 2min 13s ago&#xD;&#xA;Process: 15235 ExecStart=/usr/bin/pg_ctlcluster --skip-systemctl-redirect 1&amp;amp;gt;&#xD;&#xA;Main PID: 15240 (postgres)&#xD;&#xA;Tasks: 6 (limit: 4633)&#xD;&#xA;Memory: 20.5M&#xD;&#xA;CPU: 332ms&#xD;&#xA;CGroup: /system.slice/system-postgresql.slice/postgresql@17-main.service&#xD;&#xA;├─15240 /usr/lib/postgresql/17/bin/postgres -D /var/lib/postgresql&amp;amp;gt;&#xD;&#xA;├─15241 &amp;quot;postgres: 17/main: checkpointer &amp;quot;&#xD;&#xA;├─15242 &amp;quot;postgres: 17/main: background writer &amp;quot;&#xD;&#xA;├─15244 &amp;quot;postgres: 17/main: walwriter &amp;quot;&#xD;&#xA;├─15245 &amp;quot;postgres: 17/main: autovacuum launcher &amp;quot;&#xD;&#xA;└─15246 &amp;quot;postgres: 17/main: logical replication launcher &amp;quot;&#xD;&#xA;&#xD;&#xA;Dec 04 09:52:31 ip-192-1-1-89 systemd[1]: Starting postgresql@17-main.service -&amp;amp;gt;&#xD;&#xA;Dec 04 09:52:33 ip-192-1-1-89 systemd[1]: Started postgresql@17-main.service -&amp;amp;gt;&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;p&gt;Nos deux instances sont maintenant installées. Sur notre première base de données, nous allons créer une base, avec deux tables, et quelques lignes.&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;&#xD;&#xA;postgres@ip-192-1-1-246:/etc/postgresql/14/main$ psql&#xD;&#xA;psql (14.15 (Debian 14.15-1.pgdg120+1))&#xD;&#xA;Type &amp;quot;help&amp;quot; for help.&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: sql; title: ; notranslate&#34;&gt;&#xD;&#xA;postgres=# CREATE DATABASE mydb;&#xD;&#xA;CREATE DATABASE&#xD;&#xA;postgres=# \c mydb&#xD;&#xA;You are now connected to database &amp;quot;mydb&amp;quot; as user &amp;quot;postgres&amp;quot;.&#xD;&#xA;mydb=# CREATE TABLE customers (&#xD;&#xA;id SERIAL PRIMARY KEY,&#xD;&#xA;name TEXT NOT NULL,&#xD;&#xA;email TEXT UNIQUE,&#xD;&#xA;created_at TIMESTAMP DEFAULT NOW()&#xD;&#xA;);&#xD;&#xA;CREATE TABLE&#xD;&#xA;mydb=# CREATE TABLE orders (&#xD;&#xA;id SERIAL PRIMARY KEY,&#xD;&#xA;customer_id INT REFERENCES customers(id),&#xD;&#xA;amount NUMERIC(10,2) NOT NULL,&#xD;&#xA;order_date TIMESTAMP DEFAULT NOW()&#xD;&#xA;);&#xD;&#xA;CREATE TABLE&#xD;&#xA;mydb=# INSERT INTO customers (name, email) VALUES&#xD;&#xA;(&#39;Alice&#39;, &#39;alice@example.com&#39;),&#xD;&#xA;(&#39;Bob&#39;, &#39;bob@example.com&#39;),&#xD;&#xA;(&#39;Charlie&#39;, &#39;charlie@example.com&#39;);&#xD;&#xA;INSERT 0 3&#xD;&#xA;mydb=# INSERT INTO orders (customer_id, amount) VALUES&#xD;&#xA;(1, 50.75),&#xD;&#xA;(2, 20.00),&#xD;&#xA;(1, 75.00);&#xD;&#xA;INSERT 0 3&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;h3&gt;2. Configurer la base de données source&lt;/h3&gt;&#xA;&lt;p&gt;Sur notre première machine, nous allons modifier les paramètres du fichier de configuration de PostgreSQL pour permettre de pouvoir créer la réplication :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;&#xD;&#xA;root@ip-192-1-1-246:~# su - postgres&#xD;&#xA;postgres@ip-192-1-1-246:~$ cd /etc/postgresql/14/main&#xD;&#xA;postgres@ip-192-1-1-246:/etc/postgresql/14/main$ vi postgresql.conf&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;p&gt;Il s&amp;#8217;agit de modifier les paramètres suivants :&lt;/p&gt;&#xA;&lt;blockquote&gt;&lt;p&gt;wal_level = logical&lt;br /&gt;&#xA;max_replication_slots = 4&lt;br /&gt;&#xA;max_wal_senders = 4&lt;/p&gt;&lt;/blockquote&gt;&#xA;&lt;p&gt;Nous modifierons ensuite le pg_hba pour rajouter l&amp;#8217;autorisation de connexion entre les deux machines :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;&#xD;&#xA;postgres@ip-192-1-1-246:/etc/postgresql/14/main$ vi pg_hba.conf&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;p&gt;Il suffira de rajouter une ligne :&lt;/p&gt;&#xA;&lt;blockquote&gt;&lt;p&gt;host replication &lt;span class=&#34;hljs-attribute&#34;&gt;all&lt;/span&gt; &amp;lt;destination_ip&amp;gt; scram-sha-256&lt;/p&gt;&#xA;&lt;p&gt;host replication all &amp;lt;source_ip&amp;gt; scram-sha-256&lt;/p&gt;&#xA;&lt;p&gt;host all replication &amp;lt;destination_ip&amp;gt; scram-sha-256&lt;/p&gt;&#xA;&lt;p&gt;host all replication &amp;lt;source-ip&amp;gt; scram-sha-256&lt;/p&gt;&lt;/blockquote&gt;&#xA;&lt;p&gt;Il ne faut pas oublier de redémarrer le serveur PostgreSQL une fois ces modifications effectuées :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;&#xD;&#xA;root@ip-192-1-1-246:~# systemctl stop postgresql@14-main.service&#xD;&#xA;root@ip-192-1-1-246:~# systemctl start postgresql@14-main.service&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;h3&gt;3. Configurer la base de donnée de destination&lt;/h3&gt;&#xA;&lt;p&gt;Après avoir configuré notre base de donnée depuis laquelle nous allons faire notre migration, il nous faut a présent configurer celle qui va recevoir la nouvelle base de donnée migrée.&lt;/p&gt;&#xA;&lt;p&gt;Pour cela, nous allons répéter les étapes de configuration de la base de donnée source, en les adaptant sur notre base de donnée de destination : modifier le postgresql.conf, puis le pg_hba.conf, redémarrer ensuite la base de données&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;&#xD;&#xA;postgres@ip-192-1-1-89:~$ cd /etc/postgresql/17/main/&#xD;&#xA;postgres@ip-192-1-1-89:/etc/postgresql/17/main$ vi postgresql.conf&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;blockquote&gt;&lt;p&gt;wal_level = logical&lt;br /&gt;&#xA;max_replication_slots = 4&lt;br /&gt;&#xA;max_wal_senders = 4&lt;/p&gt;&lt;/blockquote&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;&#xD;&#xA;postgres@ip-192-1-1-246:/etc/postgresql/14/main$ vi pg_hba.conf&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;blockquote&gt;&lt;p&gt;host replication &lt;span class=&#34;hljs-attribute&#34;&gt;all&lt;/span&gt; &amp;lt;destination_ip&amp;gt; scram-sha-256&lt;/p&gt;&#xA;&lt;p&gt;host replication all &amp;lt;source_ip&amp;gt; scram-sha-256&lt;/p&gt;&#xA;&lt;p&gt;host all replication &amp;lt;destination_ip&amp;gt; scram-sha-256&lt;/p&gt;&#xA;&lt;p&gt;host all replication &amp;lt;source-ip&amp;gt; scram-sha-256&lt;/p&gt;&lt;/blockquote&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;&#xD;&#xA;root@ip-192-1-1-246:~# systemctl stop postgresql@14-main.service&#xD;&#xA;root@ip-192-1-1-246:~# systemctl start postgresql@14-main.service&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;p&gt;Il ne faudra pas oublier de créer la base de donnée ainsi que toutes les structures de tables et autres objets dans notre base cible pour qu&amp;#8217;elle puisse recevoir les données. Pour avoir les scripts de création de la base de données, vous pouvez faire un pg_dump avec l&amp;#8217;option&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;&#xD;&#xA;postgres@ip-192-1-1-89:~$ psql&#xD;&#xA;psql (17.2 (Debian 17.2-1.pgdg120+1))&#xD;&#xA;Type &amp;quot;help&amp;quot; for help.&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;pre class=&#34;brush: sql; title: ; notranslate&#34;&gt;&#xD;&#xA;postgres=# CREATE DATABASE mydb;&#xD;&#xA;CREATE DATABASE&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;p&gt;N&amp;#8217;oubliez pas de donner tout les droits à votre utilisateur de replication pour qu&amp;#8217;il puisse lire, écrire&amp;#8230; Sur votre base de données repliquée, sur la source, comme sur la destination :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: sql; title: ; notranslate&#34;&gt;&#xD;&#xA;postgres=# GRANT ALL PRIVILEGES ON DATABASE &amp;quot;mydb&amp;quot; to replication;&#xD;&#xA;GRANT&#xD;&#xA;&#xD;&#xA;mydb=# GRANT ALL PRIVILEGES ON all tables in schema public to replication;&#xD;&#xA;GRANT&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;h3&gt;4. Mise en place de la réplication logique&lt;/h3&gt;&#xA;&lt;p&gt;Maintenant que nos deux environnement sont bien en place, nous sommes prêts à mettre en route le processus de réplication logique pour commencer à transférer les données. Les étapes du dessous ont demandé une première intervention hors horaire de prod, notamment pour redémarrer le service postgreSQL, mais le but d&amp;#8217;une migration avec réplication logique, c&amp;#8217;est de pouvoir ensuite n&amp;#8217;avoir rien à toucher jusqu&amp;#8217;au moment de basculer les applicatifs d&amp;#8217;une ip a une autre.&lt;/p&gt;&#xA;&lt;p&gt;Sur notre machine source, on créé la publication qui va nous servir à transférer nos tables :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;&#xD;&#xA;postgres@ip-192-1-1-246:~$ psql&#xD;&#xA;psql (14.15 (Debian 14.15-1.pgdg120+1))&#xD;&#xA;Type &amp;quot;help&amp;quot; for help.&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: sql; title: ; notranslate&#34;&gt;&#xD;&#xA;postgres=# \c mydb&#xD;&#xA;You are now connected to database &amp;quot;mydb&amp;quot; as user &amp;quot;postgres&amp;quot;.&#xD;&#xA;mydb=# CREATE PUBLICATION my_pub FOR ALL TABLES;&#xD;&#xA;CREATE PUBLICATION&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;p&gt;On va ensuite créé la souscription sur la base de données cible de notre migration :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: sql; title: ; notranslate&#34;&gt;&#xD;&#xA;mydb=# create subscription my_sub connection &#39;host=192.1.1.246 port=5432 dbname=mydb user=replication password=replication&#39;publication my_pub;&#xD;&#xA;NOTICE: created replication slot &amp;quot;my_sub&amp;quot; on publisher&#xD;&#xA;CREATE SUBSCRIPTION&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;p&gt;Maintenant que la subscription est en place, on peut vérifier qu&amp;#8217;elle fonctionne. Pendant ce temps, la vrai production, sur la version 14, peut continuer à fonctionner, elle sera automatiquement repliquée sur la nouvelle version 17.&lt;/p&gt;&#xA;&lt;p&gt;On peut vérifier ou en est notre replication avec la commande &lt;span class=&#34;hljs-keyword&#34;&gt;SELECT&lt;/span&gt; &lt;span class=&#34;hljs-operator&#34;&gt;*&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;FROM&lt;/span&gt; pg_stat_subscription;&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: sql; title: ; notranslate&#34;&gt;&#xD;&#xA;mydb=# SELECT * FROM pg_stat_subscription;&#xD;&#xA;-[ RECORD 1 ]---------+------------------------------&#xD;&#xA;subid | 16422&#xD;&#xA;subname | my_sub&#xD;&#xA;worker_type | apply&#xD;&#xA;pid | 16076&#xD;&#xA;leader_pid |&#xD;&#xA;relid |&#xD;&#xA;received_lsn | 0/1733988&#xD;&#xA;last_msg_send_time | 2024-12-04 14:23:59.873074+00&#xD;&#xA;last_msg_receipt_time | 2024-12-04 14:23:59.872357+00&#xD;&#xA;latest_end_lsn | 0/1733988&#xD;&#xA;latest_end_time | 2024-12-04 14:23:59.873074+00&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;h3&gt;5. Test de replication, bascule, et nettoyage&lt;/h3&gt;&#xA;&lt;p&gt;Une fois que la synchronisation de votre replication logique est terminée, ce qui peut prendre un certain temps si vous avez beaucoup de données, vous pouvez constater de vous même sur les lignes que vous ajoutez, modifiez ou supprimez sur votre instance source sont repliquées sur l&amp;#8217;instance de destination.&lt;/p&gt;&#xA;&lt;p&gt;Par exemple, ajoutons un nouveau customer sur notre base source :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;&#xD;&#xA;postgres@ip-192-1-1-246:~$ psql&#xD;&#xA;psql (14.15 (Debian 14.15-1.pgdg120+1))&#xD;&#xA;Type &amp;quot;help&amp;quot; for help.&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: sql; title: ; notranslate&#34;&gt;&#xD;&#xA;postgres=# \c mydb&#xD;&#xA;You are now connected to database &amp;quot;mydb&amp;quot; as user &amp;quot;postgres&amp;quot;.&#xD;&#xA;mydb=# INSERT INTO customers (name, email) VALUES (&#39;Diana&#39;, &#39;diana@example.com&#39;);&#xD;&#xA;INSERT 0 1&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;p&gt;Si nous allons requêter sur notre instance de destination :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: sql; title: ; notranslate&#34;&gt;&#xD;&#xA;mydb=# select * from customers where name=&#39;Diana&#39;;&#xD;&#xA;id | name | email | created_at&#xD;&#xA;----+-------+-------------------+----------------------------&#xD;&#xA;4 | Diana | diana@example.com | 2024-12-04 14:31:05.708031&#xD;&#xA;(1 row)&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;p&gt;Quand vous vous êtes bien assuré que tout fonctionne, vous pouvez alors rediriger les drivers odbc de vos applications vers le nouveau serveur et non plus l&amp;#8217;ancien.&lt;/p&gt;&#xA;&lt;p&gt;Une fois que cela est fait, vous pouvez alors supprimer le lien de replication, puisque l&amp;#8217;ancienne instance ne sera plus alimentée, et même supprimer l&amp;#8217;ancienne version si vous n&amp;#8217;en avez plus l&amp;#8217;utilité.&lt;/p&gt;&#xA;&lt;p&gt;Sur la destination, notre nouveau serveur de prod :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: sql; title: ; notranslate&#34;&gt;&#xD;&#xA;DROP SUBSCRIPTION my_sub;&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;p&gt;Sur la source, ancien serveur qui va être supprimé :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: sql; title: ; notranslate&#34;&gt;&#xD;&#xA;DROP PUBLICATION my_pub;&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;h1&gt;Conclusion&lt;/h1&gt;&#xA;&lt;p&gt;La réplication logique se distingue comme l’une des meilleures solutions pour minimiser le temps d’arrêt lors d’une migration de version PostgreSQL. En permettant une synchronisation continue des données entre deux instances, elle garantit une transition en douceur sans jamais interrompre les services en cours. Cela en fait un choix idéal pour les environnements critiques où la disponibilité est primordiale.&lt;/p&gt;&#xA;&lt;h3&gt;Avantages :&lt;/h3&gt;&#xA;&lt;p&gt;&lt;strong&gt;Zéro downtime :&lt;/strong&gt; la source reste opérationnelle pendant toute la migration.&lt;br /&gt;&#xA;&lt;strong&gt;Flexibilité :&lt;/strong&gt; possibilité de migrer vers une infrastructure différente (nouveau matériel, cloud, etc.).&lt;br /&gt;&#xA;&lt;strong&gt;Granularité :&lt;/strong&gt; la réplication logique peut se limiter à certaines tables si nécessaire.&lt;/p&gt;&#xA;&lt;h3&gt;Inconvénients :&lt;/h3&gt;&#xA;&lt;p&gt;&lt;strong&gt;Complexité initiale :&lt;/strong&gt; la configuration et les tests nécessitent une bonne maîtrise des paramètres de PostgreSQL.&lt;br /&gt;&#xA;&lt;strong&gt;Impact sur les performances :&lt;/strong&gt; la charge de réplication peut légèrement affecter les performances de la base source, surtout avec un grand volume de données.&lt;br /&gt;&#xA;&lt;strong&gt;Non pris en charge pour certains types de données :&lt;/strong&gt; les types spécifiques ou les extensions non standards ne sont pas toujours compatibles avec la réplication logique.&lt;/p&gt;&#xA;&lt;p&gt;Si la réplication logique est souvent la méthode privilégiée pour des mises à jour critiques, elle n’est pas la seule option. Des alternatives comme les outils de sauvegarde et restauration ou la réplication physique peuvent répondre à d’autres besoins spécifiques, notamment pour des bases de données très volumineuses ou des scénarios nécessitant une réplication complète du système.&lt;/p&gt;&#xA;&lt;p&gt;Dans tous les cas, le choix de la méthode dépendra de votre contexte, de vos contraintes techniques et de vos objectifs métier. Prenez le temps d’évaluer les différentes options pour garantir une migration réussie et sans surprise.&lt;strong&gt;Continuez votre lecture sur le blog :&lt;/strong&gt;&lt;/p&gt;&#xA;&lt;ul class=&#34;similar-posts&#34;&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://blog.capdata.fr/index.php/replication-logique-avec-postgresql/&#34; rel=&#34;bookmark&#34; title=&#34;23 janvier 2020&#34;&gt;Réplication logique avec PostgreSQL&lt;/a&gt; (Capdata team) [PostgreSQL]&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://blog.capdata.fr/index.php/migration-postgresql-via-slony-i-ou-comment-reduire-le-temps-de-coupure/&#34; rel=&#34;bookmark&#34; title=&#34;27 janvier 2020&#34;&gt;Migration PostgreSQL via SLONY-I ou comment réduire le temps de coupure&lt;/a&gt; (Capdata team) [PostgreSQL]&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://blog.capdata.fr/index.php/migrer-dun-cluster-galera-mariadb-10-3-vers-mariadb-10-5-avec-la-replication-logique/&#34; rel=&#34;bookmark&#34; title=&#34;25 février 2022&#34;&gt;Migrer d&amp;#8217;un cluster Galera MariaDB 10.3 vers MariaDB 10.5 avec la réplication logique&lt;/a&gt; (David Baffaleuf) [ContainerMySQLNon classé]&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://blog.capdata.fr/index.php/comparatif-des-gestionnaires-de-vip-dans-un-cluster-patroni-episode-1-keepalived/&#34; rel=&#34;bookmark&#34; title=&#34;6 mars 2022&#34;&gt;Comparatif des gestionnaires de VIP dans un cluster Patroni : épisode 1 (KEEPALIVED)&lt;/a&gt; (David Baffaleuf) [ContainerPostgreSQL]&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://blog.capdata.fr/index.php/pyrseas-et-postgresql-comparer-facilement-des-schema-de-base-de-donnees/&#34; rel=&#34;bookmark&#34; title=&#34;3 janvier 2023&#34;&gt;Pyrseas et Postgresql : Comparer facilement des schémas de base de données&lt;/a&gt; (Sarah FAVEERE) [PostgreSQL]&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;&lt;!-- Similar Posts took 2.175 ms --&gt;&lt;/p&gt;&#xA;&lt;a class=&#34;synved-social-button synved-social-button-share synved-social-size-24 synved-social-resolution-single synved-social-provider-twitter nolightbox&#34; data-provider=&#34;twitter&#34; target=&#34;_blank&#34; rel=&#34;nofollow&#34; title=&#34;Share on Twitter&#34; href=&#34;https://twitter.com/intent/tweet?url=https%3A%2F%2Fblog.capdata.fr%2F%3Fp%3D10633&amp;#038;text=Article%20sur%20le%20blog%20de%20la%20Capdata%20Tech%20Team%20%3A%20&#34; style=&#34;font-size: 0px;width:24px;height:24px;margin:0;margin-bottom:5px;margin-right:5px&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; alt=&#34;twitter&#34; title=&#34;Share on Twitter&#34; class=&#34;synved-share-image synved-social-image synved-social-image-share&#34; width=&#34;24&#34; height=&#34;24&#34; style=&#34;display: inline;width:24px;height:24px;margin: 0;padding: 0;border: none;box-shadow: none&#34; src=&#34;https://blog.capdata.fr/wp-content/plugins/social-media-feather/synved-social/image/social/regular/48x48/twitter.png&#34; /&gt;&lt;/a&gt;&lt;a class=&#34;synved-social-button synved-social-button-share synved-social-size-24 synved-social-resolution-single synved-social-provider-linkedin nolightbox&#34; data-provider=&#34;linkedin&#34; target=&#34;_blank&#34; rel=&#34;nofollow&#34; title=&#34;Share on Linkedin&#34; href=&#34;https://www.linkedin.com/shareArticle?mini=true&amp;#038;url=https%3A%2F%2Fblog.capdata.fr%2F%3Fp%3D10633&amp;#038;title=La%20mont%C3%A9e%20de%20version%20en%20zero-downtime%20%3A%20merci%20la%20r%C3%A9plication%20%21&#34; style=&#34;font-size: 0px;width:24px;height:24px;margin:0;margin-bottom:5px;margin-right:5px&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; alt=&#34;linkedin&#34; title=&#34;Share on Linkedin&#34; class=&#34;synved-share-image synved-social-image synved-social-image-share&#34; width=&#34;24&#34; height=&#34;24&#34; style=&#34;display: inline;width:24px;height:24px;margin: 0;padding: 0;border: none;box-shadow: none&#34; src=&#34;https://blog.capdata.fr/wp-content/plugins/social-media-feather/synved-social/image/social/regular/48x48/linkedin.png&#34; /&gt;&lt;/a&gt;&lt;a class=&#34;synved-social-button synved-social-button-share synved-social-size-24 synved-social-resolution-single synved-social-provider-mail nolightbox&#34; data-provider=&#34;mail&#34; rel=&#34;nofollow&#34; title=&#34;Share by email&#34; href=&#34;mailto:?subject=La%20mont%C3%A9e%20de%20version%20en%20zero-downtime%20%3A%20merci%20la%20r%C3%A9plication%20%21&amp;#038;body=Article%20sur%20le%20blog%20de%20la%20Capdata%20Tech%20Team%20%3A%20:%20https%3A%2F%2Fblog.capdata.fr%2F%3Fp%3D10633&#34; style=&#34;font-size: 0px;width:24px;height:24px;margin:0;margin-bottom:5px&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; alt=&#34;mail&#34; title=&#34;Share by email&#34; class=&#34;synved-share-image synved-social-image synved-social-image-share&#34; width=&#34;24&#34; height=&#34;24&#34; style=&#34;display: inline;width:24px;height:24px;margin: 0;padding: 0;border: none;box-shadow: none&#34; src=&#34;https://blog.capdata.fr/wp-content/plugins/social-media-feather/synved-social/image/social/regular/48x48/mail.png&#34; /&gt;&lt;/a&gt;&lt;p&gt;L’article &lt;a rel=&#34;nofollow&#34; href=&#34;https://blog.capdata.fr/index.php/la-montee-de-version-en-zero-downtime-merci-la-replication/&#34;&gt;La montée de version en zero-downtime : merci la réplication !&lt;/a&gt; est apparu en premier sur &lt;a rel=&#34;nofollow&#34; href=&#34;https://blog.capdata.fr&#34;&gt;Capdata TECH BLOG&lt;/a&gt;.&lt;/p&gt;&#xA;</content>
    <link href="https://blog.capdata.fr/index.php/la-montee-de-version-en-zero-downtime-merci-la-replication/" rel="alternate"></link>
    <summary type="html">&lt;p&gt;Introduction : Dans le monde des bases de données, garantir une disponibilité continue est une exigence incontournable, surtout pour les systèmes critiques où chaque minute d&amp;#8217;arrêt peut entraîner des pertes significatives. Lorsqu’il s’agit de migrer une base de données vers&amp;#8230; &lt;a href=&#34;https://blog.capdata.fr/index.php/la-montee-de-version-en-zero-downtime-merci-la-replication/&#34; class=&#34;more-link&#34;&gt;Continuer la lecture &lt;span class=&#34;meta-nav&#34;&gt;&amp;#8594;&lt;/span&gt;&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;L’article &lt;a rel=&#34;nofollow&#34; href=&#34;https://blog.capdata.fr/index.php/la-montee-de-version-en-zero-downtime-merci-la-replication/&#34;&gt;La montée de version en zero-downtime : merci la réplication !&lt;/a&gt; est apparu en premier sur &lt;a rel=&#34;nofollow&#34; href=&#34;https://blog.capdata.fr&#34;&gt;Capdata TECH BLOG&lt;/a&gt;.&lt;/p&gt;&#xA;</summary>
    <author>
      <name>Sarah FAVEERE</name>
    </author>
  </entry>
  <entry>
    <title>pg_vector : l’IA et PostgreSQL</title>
    <updated>2024-12-03T07:22:34Z</updated>
    <id>tag:blog.capdata.fr,2024-12-03:/index.php/pg_vector-lia-et-postgresql/</id>
    <content type="html">&lt;a class=&#34;synved-social-button synved-social-button-share synved-social-size-24 synved-social-resolution-single synved-social-provider-twitter nolightbox&#34; data-provider=&#34;twitter&#34; target=&#34;_blank&#34; rel=&#34;nofollow&#34; title=&#34;Share on Twitter&#34; href=&#34;https://twitter.com/intent/tweet?url=https%3A%2F%2Fblog.capdata.fr%2F%3Fp%3D10620&amp;#038;text=Article%20sur%20le%20blog%20de%20la%20Capdata%20Tech%20Team%20%3A%20&#34; style=&#34;font-size: 0px;width:24px;height:24px;margin:0;margin-bottom:5px;margin-right:5px&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; alt=&#34;twitter&#34; title=&#34;Share on Twitter&#34; class=&#34;synved-share-image synved-social-image synved-social-image-share&#34; width=&#34;24&#34; height=&#34;24&#34; style=&#34;display: inline;width:24px;height:24px;margin: 0;padding: 0;border: none;box-shadow: none&#34; src=&#34;https://blog.capdata.fr/wp-content/plugins/social-media-feather/synved-social/image/social/regular/48x48/twitter.png&#34; /&gt;&lt;/a&gt;&lt;a class=&#34;synved-social-button synved-social-button-share synved-social-size-24 synved-social-resolution-single synved-social-provider-linkedin nolightbox&#34; data-provider=&#34;linkedin&#34; target=&#34;_blank&#34; rel=&#34;nofollow&#34; title=&#34;Share on Linkedin&#34; href=&#34;https://www.linkedin.com/shareArticle?mini=true&amp;#038;url=https%3A%2F%2Fblog.capdata.fr%2F%3Fp%3D10620&amp;#038;title=pg_vector%20%3A%20l%E2%80%99IA%20et%20PostgreSQL&#34; style=&#34;font-size: 0px;width:24px;height:24px;margin:0;margin-bottom:5px;margin-right:5px&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; alt=&#34;linkedin&#34; title=&#34;Share on Linkedin&#34; class=&#34;synved-share-image synved-social-image synved-social-image-share&#34; width=&#34;24&#34; height=&#34;24&#34; style=&#34;display: inline;width:24px;height:24px;margin: 0;padding: 0;border: none;box-shadow: none&#34; src=&#34;https://blog.capdata.fr/wp-content/plugins/social-media-feather/synved-social/image/social/regular/48x48/linkedin.png&#34; /&gt;&lt;/a&gt;&lt;a class=&#34;synved-social-button synved-social-button-share synved-social-size-24 synved-social-resolution-single synved-social-provider-mail nolightbox&#34; data-provider=&#34;mail&#34; rel=&#34;nofollow&#34; title=&#34;Share by email&#34; href=&#34;mailto:?subject=pg_vector%20%3A%20l%E2%80%99IA%20et%20PostgreSQL&amp;#038;body=Article%20sur%20le%20blog%20de%20la%20Capdata%20Tech%20Team%20%3A%20:%20https%3A%2F%2Fblog.capdata.fr%2F%3Fp%3D10620&#34; style=&#34;font-size: 0px;width:24px;height:24px;margin:0;margin-bottom:5px&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; alt=&#34;mail&#34; title=&#34;Share by email&#34; class=&#34;synved-share-image synved-social-image synved-social-image-share&#34; width=&#34;24&#34; height=&#34;24&#34; style=&#34;display: inline;width:24px;height:24px;margin: 0;padding: 0;border: none;box-shadow: none&#34; src=&#34;https://blog.capdata.fr/wp-content/plugins/social-media-feather/synved-social/image/social/regular/48x48/mail.png&#34; /&gt;&lt;/a&gt;&lt;h2&gt;1. Introduction : L&amp;#8217;intelligence artificielle et le rôle des bases de données&lt;/h2&gt;&#xA;&lt;p&gt;L&amp;#8217;intelligence artificielle (IA) connaît une popularité croissante, des assistants virtuels aux voitures autonomes, en passant par les recommandations de films et de produits. Mais pour que ces technologies fonctionnent, elles ont besoin de données, souvent en grande quantité. C’est là qu’interviennent les bases de données : elles stockent, gèrent et permettent d&amp;#8217;accéder à ces données de manière efficace.&lt;/p&gt;&#xA;&lt;p&gt;Les bases de données, comme PostgreSQL, ont donc un rôle clé dans l’IA. Mais l&amp;#8217;IA ne traite pas toujours des informations simples comme des noms ou des chiffres ; souvent, elle doit manipuler des informations complexes, comme des représentations numériques d&amp;#8217;images, de sons, ou de textes. Pour gérer ces données spécifiques, il faut des outils adaptés, et c&amp;#8217;est là que l&amp;#8217;extension pg_vector de PostgreSQL entre en jeu.&lt;/p&gt;&#xA;&lt;h2&gt;2. Les vecteurs en informatique et dans pg_vector&lt;/h2&gt;&#xA;&lt;p&gt;Dans le cadre de l’informatique, un vecteur est simplement une liste de nombres. Ces nombres peuvent représenter n’importe quoi : les caractéristiques d’un produit, les mots d’un texte ou même une image. Par exemple, pour un document texte, chaque mot peut être transformé en une série de nombres qui capture son sens dans un certain contexte.&lt;/p&gt;&#xA;&lt;p&gt;L’extension pg_vector permet à PostgreSQL de stocker et de manipuler ces vecteurs. Elle offre un moyen simple de les utiliser directement dans une base de données. Imaginons que nous avons des centaines de documents et que nous souhaitions rechercher les plus similaires à un texte donné : en stockant les représentations numériques (ou embeddings) de ces documents sous forme de vecteurs, nous pouvons facilement comparer leur similarité grâce à pg_vector.&lt;/p&gt;&#xA;&lt;h2&gt;3. Le lien entre l&amp;#8217;IA et les vecteurs&lt;/h2&gt;&#xA;&lt;p&gt;L&amp;#8217;intelligence artificielle repose sur la capacité à comprendre et traiter des informations complexes. Par exemple, quand une IA doit reconnaître une image, elle ne &amp;#8220;voit&amp;#8221; pas comme nous. Au lieu de cela, l&amp;#8217;image est transformée en une série de nombres, un vecteur, qui représente ses caractéristiques (couleurs, formes, etc.).&lt;/p&gt;&#xA;&lt;p&gt;Le même principe s’applique au texte. Les modèles de traitement du langage, comme ceux utilisés par les moteurs de recherche ou les chatbots, transforment chaque mot ou phrase en vecteur. Ces vecteurs capturent le sens des mots et permettent à l&amp;#8217;IA de manipuler des informations complexes sans &amp;#8220;comprendre&amp;#8221; le langage humain.&lt;/p&gt;&#xA;&lt;p&gt;C&amp;#8217;est ici que les embeddings entrent en jeu. Un embedding est un vecteur qui représente des données sous une forme que l’IA peut utiliser. Par exemple, dans un système de recommandation, chaque produit est converti en un embedding, et les produits les plus proches de celui que nous venons de consulter (en termes de vecteur) nous seront recommandés. Grâce à pg_vector, ces embeddings peuvent être stockés et comparés directement dans une base de données.&lt;/p&gt;&#xA;&lt;h2&gt;4. Pourquoi est-ce utile ?&lt;/h2&gt;&#xA;&lt;p&gt;L&amp;#8217;extension pg_vector est très utile pour des applications qui nécessitent la recherche par similarité. Par exemple, dans un moteur de recherche, si nous voulons trouver les documents les plus proches d&amp;#8217;un texte donné, pg_vector permet de comparer les vecteurs (ou embeddings) de chaque document pour voir lesquels sont les plus similaires.&lt;/p&gt;&#xA;&lt;p&gt;Autre exemple, dans une plateforme de streaming musical, chaque chanson peut être convertie en vecteur qui représente ses caractéristiques (comme le tempo, la tonalité, etc.). Grâce à pg_vector, on peut facilement recommander des chansons similaires à celles que nous écoutons.&lt;/p&gt;&#xA;&lt;p&gt;L’avantage de pg_vector, c’est qu’il permet de gérer ces vecteurs directement dans la base de données, ce qui évite de passer par des systèmes externes plus complexes. Cela simplifie le développement et améliore la performance, car tout est géré au même endroit.&lt;/p&gt;&#xA;&lt;h2&gt;5. Le test&lt;/h2&gt;&#xA;&lt;p&gt;Pour démontrer le fonctionnement de l&amp;#8217;extension, rien de tel qu&amp;#8217;un petit test pour éprouver les fonctionnalités qu&amp;#8217;elle propose. Le test sera plutôt simple et succinct pour être accessible. Le prérequi est d&amp;#8217;avoir une version PostgreSQL 14 ou plus récente d&amp;#8217;installée.&lt;/p&gt;&#xA;&lt;h3&gt;Etape 1 :&lt;/h3&gt;&#xA;&lt;p&gt;On commence par installer l&amp;#8217;extension pg_vector. Pour cela, nous allons avoir besoin d&amp;#8217;un certain nombre d&amp;#8217;outils pour le faire fonctionner. Une partie de ces outils sont disponible dans la distribution dev de PostgreSQL&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;&#xD;&#xA;root@ip-192-1-1-201:~# sudo apt install postgresql-server-dev-14&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;p&gt;Nous aurons également besoin de gcc et make :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;&#xD;&#xA;root@ip-192-1-1-201:~# apt install make&#xD;&#xA;root@ip-192-1-1-201:~# apt-get install gcc&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;p&gt;On effectue ensuite un git clone du projet :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;&#xD;&#xA;root@ip-192-1-1-201:~# git clone https://github.com/pgvector/pgvector.git&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;p&gt;Et une fois que c&amp;#8217;est fait, on l&amp;#8217;installe avec make :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;&#xD;&#xA;root@ip-192-1-1-201:~# cd pgvector&#xD;&#xA;root@ip-192-1-1-201:~# make &amp;amp;amp;&amp;amp;amp; sudo make install&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;h3&gt;Etape 2 :&lt;/h3&gt;&#xA;&lt;p&gt;On se connecte à PostgreSQL pour créer l&amp;#8217;extension. Au passage, on créé aussi une base de données pour faire nos test.&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;&#xD;&#xA;root@ip-192-1-1-201:~# su - postgres&#xD;&#xA;postgres@ip-192-1-1-201:~$ psql&#xD;&#xA;psql (14.13 (Ubuntu 14.13-0ubuntu0.22.04.1))&#xD;&#xA;Type &amp;quot;help&amp;quot; for help.&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;pre class=&#34;brush: sql; title: ; notranslate&#34;&gt;&#xD;&#xA;postgres=# create database test_vector;&#xD;&#xA;CREATE DATABASE&#xD;&#xA;postgres=# \c test_vector&#xD;&#xA;You are now connected to database &amp;quot;test_vector&amp;quot; as user &amp;quot;postgres&amp;quot;.&#xD;&#xA;test_vector=# CREATE EXTENSION vector;&#xD;&#xA;CREATE EXTENSION&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;p&gt;Et dans la foulée, on crée une table qui contient les vecteurs sur lesquels nous allons faire les test&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: sql; title: ; notranslate&#34;&gt;&#xD;&#xA;test_vector=# CREATE TABLE documents (&#xD;&#xA;id SERIAL PRIMARY KEY,&#xD;&#xA;title TEXT,&#xD;&#xA;embedding vector(3) -- vecteur de dimension 3 pour cet exemple&#xD;&#xA;);&#xD;&#xA;CREATE TABLE&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;p&gt;Insertion des données d&amp;#8217;exemple :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: sql; title: ; notranslate&#34;&gt;&#xD;&#xA;test_vector=# INSERT INTO documents (title, embedding) VALUES&#xD;&#xA;(&#39;Document 1&#39;, &#39;[0.1, 0.2, 0.3]&#39;),&#xD;&#xA;(&#39;Document 2&#39;, &#39;[0.4, 0.5, 0.6]&#39;),&#xD;&#xA;(&#39;Document 3&#39;, &#39;[0.9, 0.8, 0.7]&#39;);&#xD;&#xA;INSERT 0 3&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;h3&gt;Etape 3 :&lt;/h3&gt;&#xA;&lt;p&gt;Nous avons deux types de choses à tester pour montrer l&amp;#8217;efficacité de notre extension. En effet, pour rechercher un vecteur, deux modes s&amp;#8217;offrent à nous :&lt;/p&gt;&#xA;&lt;ol&gt;&#xA;&lt;li&gt;&#xA;&lt;h4&gt;La distance cosinus&lt;/h4&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&lt;p&gt;La distance cosinus mesure non pas combien deux vecteurs sont éloignés, mais l&amp;#8217;angle entre eux. C’est un peu comme comparer la direction dans laquelle pointent deux vecteurs plutôt que la distance réelle entre eux.&lt;/p&gt;&#xA;&lt;p&gt;Imaginons que nous sommes en train de lancer deux flèches. La distance cosinus nous dira si les deux flèches pointent dans la même direction (sont similaires) ou si elles pointent dans des directions très différentes (sont moins similaires).&lt;/p&gt;&#xA;&lt;p&gt;Dans le cadre de l’IA, cette mesure est souvent utilisée pour comparer des embeddings (représentations numériques complexes), car elle se concentre sur la relation entre les éléments, indépendamment de leur taille exacte.&lt;/p&gt;&#xA;&lt;p&gt;Exemple simple :&lt;/p&gt;&#xA;&lt;p&gt;Prenons les deux films :&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Film A : &lt;code&gt;[1, 5, 50, 120]&lt;/code&gt;&lt;/li&gt;&#xA;&lt;li&gt;Film B : &lt;code&gt;[2, 4, 45, 110]&lt;/code&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;La distance cosinus ne va pas se soucier de la différence de valeur entre chaque composant, mais va regarder si les deux films ont des proportions similaires. Autrement dit, est-ce que leur &amp;#8220;profil&amp;#8221; général est proche ou éloigné ?&lt;/p&gt;&#xA;&lt;p&gt;Pour tester cette distance, dans notre pg vector, on utilise la méthode suivante :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: sql; title: ; notranslate&#34;&gt;&#xD;&#xA;test_vector=# SELECT title, embedding, embedding &amp;amp;lt;=&amp;amp;gt; &#39;[0.2, 0.1, 0.3]&#39; AS distance&#xD;&#xA;FROM documents&#xD;&#xA;ORDER BY embedding &amp;amp;lt;=&amp;amp;gt; &#39;[0.2, 0.1, 0.3]&#39; ASC&#xD;&#xA;LIMIT 3;&#xD;&#xA;title | embedding | distance&#xD;&#xA;------------+---------------+---------------------&#xD;&#xA;Document 2 | [0.4,0.5,0.6] | 0.05582537807240784&#xD;&#xA;Document 1 | [0.1,0.2,0.3] | 0.07142855242198809&#xD;&#xA;Document 3 | [0.9,0.8,0.7] | 0.09815280896106982&#xD;&#xA;(3 rows)&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;p&gt;Le symbole &amp;lt;=&amp;gt; représente une distance cosinus.&lt;/p&gt;&#xA;&lt;h4&gt;2. La distance Euclidienne&lt;/h4&gt;&#xA;&lt;p&gt;Imaginons que nous sommes sur une carte avec deux points : le point A et le point B. La distance euclidienne, c&amp;#8217;est la façon la plus intuitive de mesurer la distance entre ces deux points, comme si nous tracions une ligne droite entre eux. Pour parler en terme simple, c’est la &amp;#8220;distance à vol d&amp;#8217;oiseau&amp;#8221;.&lt;/p&gt;&#xA;&lt;p&gt;Dans le cadre des vecteurs, la distance euclidienne mesure la différence entre deux vecteurs, un peu comme si chaque vecteur était un point sur une carte en plusieurs dimensions. Plus cette distance est petite, plus les deux vecteurs (et donc les objets qu’ils représentent) sont similaires.&lt;/p&gt;&#xA;&lt;p&gt;Exemple simple :&lt;/p&gt;&#xA;&lt;p&gt;Imaginons deux films représentés par les vecteurs suivants :&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;strong&gt;Film A&lt;/strong&gt; : &lt;code&gt;[1, 5, 50, 120]&lt;/code&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;strong&gt;Film B&lt;/strong&gt; : &lt;code&gt;[2, 4, 45, 110]&lt;/code&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;La distance euclidienne va calculer la différence entre chaque nombre des deux vecteurs et déterminer à quel point ces films sont proches en termes de caractéristiques (genre, nombre d’acteurs, budget, etc.).&lt;/p&gt;&#xA;&lt;p&gt;Dans pg_vector on peut le tester ainsi :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: sql; title: ; notranslate&#34;&gt;&#xD;&#xA;test_vector=# SELECT title, embedding, embedding &amp;amp;lt;-&amp;amp;gt; &#39;[0.2, 0.1, 0.3]&#39; AS distance&#xD;&#xA;FROM documents&#xD;&#xA;ORDER BY embedding &amp;amp;lt;-&amp;amp;gt; &#39;[0.2, 0.1, 0.3]&#39; ASC&#xD;&#xA;LIMIT 3;&#xD;&#xA;title | embedding | distance&#xD;&#xA;------------+---------------+--------------------&#xD;&#xA;Document 1 | [0.1,0.2,0.3] | 0.1414213612422477&#xD;&#xA;Document 2 | [0.4,0.5,0.6] | 0.5385165006363984&#xD;&#xA;Document 3 | [0.9,0.8,0.7] | 1.0677078185041473&#xD;&#xA;(3 rows)&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;p&gt;Elle est représentée par le cigle &amp;lt;-&amp;gt; dans pg_vector.&lt;/p&gt;&#xA;&lt;h4&gt;3. Quand choisir l&amp;#8217;une ou l&amp;#8217;autre des distances ?&lt;/h4&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;La distance euclidienne est utile quand tu veux mesurer la différence globale entre deux objets. Elle est facile à comprendre et à utiliser pour des comparaisons directes.&lt;/li&gt;&#xA;&lt;li&gt;La distance cosinus est utile quand tu veux savoir si deux objets sont globalement similaires dans leur profil, indépendamment de leur taille ou de leur échelle. Elle est souvent utilisée pour comparer des documents textuels ou des données complexes en IA&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h2&gt;Conclusion&lt;/h2&gt;&#xA;&lt;p&gt;L&amp;#8217;extension pg_vector apporte une fonctionnalité puissante à PostgreSQL, permettant de manipuler des données complexes sous forme de vecteurs. Que ce soit pour des systèmes de recommandation, des moteurs de recherche ou toute autre application liée à l’intelligence artificielle, elle offre un moyen simple et efficace d&amp;#8217;intégrer l&amp;#8217;IA dans les bases de données. Et tout cela, sans avoir besoin de comprendre des mathématiques avancées : il suffit de savoir que ces vecteurs permettent de traiter des informations complexes de manière très efficace.&lt;strong&gt;Continuez votre lecture sur le blog :&lt;/strong&gt;&lt;/p&gt;&#xA;&lt;ul class=&#34;similar-posts&#34;&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://blog.capdata.fr/index.php/pg_recursively_delete-simplifier-les-suppressions-recursives/&#34; rel=&#34;bookmark&#34; title=&#34;3 avril 2024&#34;&gt;pg_recursively_delete : Simplifier les suppressions récursives&lt;/a&gt; (Sarah FAVEERE) [PostgreSQL]&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://blog.capdata.fr/index.php/pyrseas-et-postgresql-comparer-facilement-des-schema-de-base-de-donnees/&#34; rel=&#34;bookmark&#34; title=&#34;3 janvier 2023&#34;&gt;Pyrseas et Postgresql : Comparer facilement des schémas de base de données&lt;/a&gt; (Sarah FAVEERE) [PostgreSQL]&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://blog.capdata.fr/index.php/postgresql-planifier-une-tache-avec-pg_cron/&#34; rel=&#34;bookmark&#34; title=&#34;24 septembre 2019&#34;&gt;PostgreSQL : planifier une tâche avec pg_cron&lt;/a&gt; (Emmanuel RAMI) [Non classéPostgreSQL]&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://blog.capdata.fr/index.php/transparent-data-encryption-pour-postgresql/&#34; rel=&#34;bookmark&#34; title=&#34;13 mai 2022&#34;&gt;Transparent Data Encryption pour PostgreSQL&lt;/a&gt; (Sarah FAVEERE) [PostgreSQL]&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://blog.capdata.fr/index.php/pg_dirtyread-ou-comment-reparer-facilement-un-delete-sauvage/&#34; rel=&#34;bookmark&#34; title=&#34;27 mars 2024&#34;&gt;pg_dirtyread où comment réparer facilement un delete sauvage&lt;/a&gt; (Sarah FAVEERE) [PostgreSQL]&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;&lt;!-- Similar Posts took 1.906 ms --&gt;&lt;/p&gt;&#xA;&lt;a class=&#34;synved-social-button synved-social-button-share synved-social-size-24 synved-social-resolution-single synved-social-provider-twitter nolightbox&#34; data-provider=&#34;twitter&#34; target=&#34;_blank&#34; rel=&#34;nofollow&#34; title=&#34;Share on Twitter&#34; href=&#34;https://twitter.com/intent/tweet?url=https%3A%2F%2Fblog.capdata.fr%2F%3Fp%3D10620&amp;#038;text=Article%20sur%20le%20blog%20de%20la%20Capdata%20Tech%20Team%20%3A%20&#34; style=&#34;font-size: 0px;width:24px;height:24px;margin:0;margin-bottom:5px;margin-right:5px&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; alt=&#34;twitter&#34; title=&#34;Share on Twitter&#34; class=&#34;synved-share-image synved-social-image synved-social-image-share&#34; width=&#34;24&#34; height=&#34;24&#34; style=&#34;display: inline;width:24px;height:24px;margin: 0;padding: 0;border: none;box-shadow: none&#34; src=&#34;https://blog.capdata.fr/wp-content/plugins/social-media-feather/synved-social/image/social/regular/48x48/twitter.png&#34; /&gt;&lt;/a&gt;&lt;a class=&#34;synved-social-button synved-social-button-share synved-social-size-24 synved-social-resolution-single synved-social-provider-linkedin nolightbox&#34; data-provider=&#34;linkedin&#34; target=&#34;_blank&#34; rel=&#34;nofollow&#34; title=&#34;Share on Linkedin&#34; href=&#34;https://www.linkedin.com/shareArticle?mini=true&amp;#038;url=https%3A%2F%2Fblog.capdata.fr%2F%3Fp%3D10620&amp;#038;title=pg_vector%20%3A%20l%E2%80%99IA%20et%20PostgreSQL&#34; style=&#34;font-size: 0px;width:24px;height:24px;margin:0;margin-bottom:5px;margin-right:5px&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; alt=&#34;linkedin&#34; title=&#34;Share on Linkedin&#34; class=&#34;synved-share-image synved-social-image synved-social-image-share&#34; width=&#34;24&#34; height=&#34;24&#34; style=&#34;display: inline;width:24px;height:24px;margin: 0;padding: 0;border: none;box-shadow: none&#34; src=&#34;https://blog.capdata.fr/wp-content/plugins/social-media-feather/synved-social/image/social/regular/48x48/linkedin.png&#34; /&gt;&lt;/a&gt;&lt;a class=&#34;synved-social-button synved-social-button-share synved-social-size-24 synved-social-resolution-single synved-social-provider-mail nolightbox&#34; data-provider=&#34;mail&#34; rel=&#34;nofollow&#34; title=&#34;Share by email&#34; href=&#34;mailto:?subject=pg_vector%20%3A%20l%E2%80%99IA%20et%20PostgreSQL&amp;#038;body=Article%20sur%20le%20blog%20de%20la%20Capdata%20Tech%20Team%20%3A%20:%20https%3A%2F%2Fblog.capdata.fr%2F%3Fp%3D10620&#34; style=&#34;font-size: 0px;width:24px;height:24px;margin:0;margin-bottom:5px&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; alt=&#34;mail&#34; title=&#34;Share by email&#34; class=&#34;synved-share-image synved-social-image synved-social-image-share&#34; width=&#34;24&#34; height=&#34;24&#34; style=&#34;display: inline;width:24px;height:24px;margin: 0;padding: 0;border: none;box-shadow: none&#34; src=&#34;https://blog.capdata.fr/wp-content/plugins/social-media-feather/synved-social/image/social/regular/48x48/mail.png&#34; /&gt;&lt;/a&gt;&lt;p&gt;L’article &lt;a rel=&#34;nofollow&#34; href=&#34;https://blog.capdata.fr/index.php/pg_vector-lia-et-postgresql/&#34;&gt;pg_vector : l&amp;#8217;IA et PostgreSQL&lt;/a&gt; est apparu en premier sur &lt;a rel=&#34;nofollow&#34; href=&#34;https://blog.capdata.fr&#34;&gt;Capdata TECH BLOG&lt;/a&gt;.&lt;/p&gt;&#xA;</content>
    <link href="https://blog.capdata.fr/index.php/pg_vector-lia-et-postgresql/" rel="alternate"></link>
    <summary type="html">&lt;p&gt;1. Introduction : L&amp;#8217;intelligence artificielle et le rôle des bases de données L&amp;#8217;intelligence artificielle (IA) connaît une popularité croissante, des assistants virtuels aux voitures autonomes, en passant par les recommandations de films et de produits. Mais pour que ces technologies&amp;#8230; &lt;a href=&#34;https://blog.capdata.fr/index.php/pg_vector-lia-et-postgresql/&#34; class=&#34;more-link&#34;&gt;Continuer la lecture &lt;span class=&#34;meta-nav&#34;&gt;&amp;#8594;&lt;/span&gt;&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;L’article &lt;a rel=&#34;nofollow&#34; href=&#34;https://blog.capdata.fr/index.php/pg_vector-lia-et-postgresql/&#34;&gt;pg_vector : l&amp;#8217;IA et PostgreSQL&lt;/a&gt; est apparu en premier sur &lt;a rel=&#34;nofollow&#34; href=&#34;https://blog.capdata.fr&#34;&gt;Capdata TECH BLOG&lt;/a&gt;.&lt;/p&gt;&#xA;</summary>
    <author>
      <name>Sarah FAVEERE</name>
    </author>
  </entry>
  <entry>
    <title>PostgreSQL 17 : des sauvegardes incrémentales avec pg_basebackup</title>
    <updated>2024-07-16T11:24:05Z</updated>
    <id>tag:blog.capdata.fr,2024-07-16:/index.php/postgresql-17-sauvegardes-incrementales/</id>
    <content type="html">&lt;a class=&#34;synved-social-button synved-social-button-share synved-social-size-24 synved-social-resolution-single synved-social-provider-twitter nolightbox&#34; data-provider=&#34;twitter&#34; target=&#34;_blank&#34; rel=&#34;nofollow&#34; title=&#34;Share on Twitter&#34; href=&#34;https://twitter.com/intent/tweet?url=https%3A%2F%2Fblog.capdata.fr%2F%3Fp%3D10584&amp;#038;text=Article%20sur%20le%20blog%20de%20la%20Capdata%20Tech%20Team%20%3A%20&#34; style=&#34;font-size: 0px;width:24px;height:24px;margin:0;margin-bottom:5px;margin-right:5px&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; alt=&#34;twitter&#34; title=&#34;Share on Twitter&#34; class=&#34;synved-share-image synved-social-image synved-social-image-share&#34; width=&#34;24&#34; height=&#34;24&#34; style=&#34;display: inline;width:24px;height:24px;margin: 0;padding: 0;border: none;box-shadow: none&#34; src=&#34;https://blog.capdata.fr/wp-content/plugins/social-media-feather/synved-social/image/social/regular/48x48/twitter.png&#34; /&gt;&lt;/a&gt;&lt;a class=&#34;synved-social-button synved-social-button-share synved-social-size-24 synved-social-resolution-single synved-social-provider-linkedin nolightbox&#34; data-provider=&#34;linkedin&#34; target=&#34;_blank&#34; rel=&#34;nofollow&#34; title=&#34;Share on Linkedin&#34; href=&#34;https://www.linkedin.com/shareArticle?mini=true&amp;#038;url=https%3A%2F%2Fblog.capdata.fr%2F%3Fp%3D10584&amp;#038;title=PostgreSQL%2017%20%3A%20des%20sauvegardes%20incr%C3%A9mentales%20avec%20pg_basebackup&#34; style=&#34;font-size: 0px;width:24px;height:24px;margin:0;margin-bottom:5px;margin-right:5px&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; alt=&#34;linkedin&#34; title=&#34;Share on Linkedin&#34; class=&#34;synved-share-image synved-social-image synved-social-image-share&#34; width=&#34;24&#34; height=&#34;24&#34; style=&#34;display: inline;width:24px;height:24px;margin: 0;padding: 0;border: none;box-shadow: none&#34; src=&#34;https://blog.capdata.fr/wp-content/plugins/social-media-feather/synved-social/image/social/regular/48x48/linkedin.png&#34; /&gt;&lt;/a&gt;&lt;a class=&#34;synved-social-button synved-social-button-share synved-social-size-24 synved-social-resolution-single synved-social-provider-mail nolightbox&#34; data-provider=&#34;mail&#34; rel=&#34;nofollow&#34; title=&#34;Share by email&#34; href=&#34;mailto:?subject=PostgreSQL%2017%20%3A%20des%20sauvegardes%20incr%C3%A9mentales%20avec%20pg_basebackup&amp;#038;body=Article%20sur%20le%20blog%20de%20la%20Capdata%20Tech%20Team%20%3A%20:%20https%3A%2F%2Fblog.capdata.fr%2F%3Fp%3D10584&#34; style=&#34;font-size: 0px;width:24px;height:24px;margin:0;margin-bottom:5px&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; alt=&#34;mail&#34; title=&#34;Share by email&#34; class=&#34;synved-share-image synved-social-image synved-social-image-share&#34; width=&#34;24&#34; height=&#34;24&#34; style=&#34;display: inline;width:24px;height:24px;margin: 0;padding: 0;border: none;box-shadow: none&#34; src=&#34;https://blog.capdata.fr/wp-content/plugins/social-media-feather/synved-social/image/social/regular/48x48/mail.png&#34; /&gt;&lt;/a&gt;&lt;p&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; class=&#34;alignnone size-full wp-image-10592&#34; src=&#34;https://blog.capdata.fr/wp-content/uploads/2024/07/SalesGrowth.jpg&#34; alt=&#34;&#34; width=&#34;279&#34; height=&#34;180&#34; /&gt;&lt;/p&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;p&gt;Bonjour&lt;/p&gt;&#xA;&lt;p&gt;Les 11 et 12 juin derniers, nous étions aux journées PGDAY à Lille pour découvrir les nouveautés autour de PostgreSQL.&lt;br /&gt;&#xA;Cette conférence regroupe différents professionnels, de la communauté francophone, qui agissent en contribuant sur des sujets techniques mais aussi sur les bonnes pratiques afin d&amp;#8217;utiliser PostgreSQL dans les meilleurs conditions.&lt;/p&gt;&#xA;&lt;p&gt;Un article m&amp;#8217;a particulièrement intéressé cette année, c&amp;#8217;est celui de &lt;a href=&#34;https://www.linkedin.com/in/stefan-fercot/?originalSubdomain=be&#34;&gt;Stefan Fercot&lt;/a&gt; Senior DBA PostgreSQL qui vit en Belgique, et travaille pour une société allemande experte dans les solutions PostgreSQL. Sa présentation portait sur le sujet &amp;#8220;démystifier les sauvegardes incrémentales sous PostgreSQL&amp;#8221;.&lt;/p&gt;&#xA;&lt;p&gt;J&amp;#8217;ai écouté sa conférence tout en ayant hâte de tester sa mise en place dès mon retour de Lille.&lt;/p&gt;&#xA;&lt;p&gt;Je tiens à remercier Stefan pour son travail sur ce sujet sauvegardes PostgreSQL.&lt;/p&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;p&gt;Tout d&amp;#8217;abord, il faut savoir que les sujets sauvegardes incrémentales ont été déjà abordés avec des outils comme &lt;strong&gt;Barman&lt;/strong&gt; ou &lt;strong&gt;Pg_BackRest&lt;/strong&gt;, et que certaines instances PostgreSQL de production sont sauvegardées via ces mécanismes depuis quelques années maintenant.&lt;/p&gt;&#xA;&lt;p&gt;Ici, nous parlons de la solution &amp;#8220;backup incremental&amp;#8221; inclu nativement dans le moteur PostgreSQL, et disponible avec l&amp;#8217;outil &amp;#8220;&lt;strong&gt;pg_basebackup&lt;/strong&gt;&amp;#8220;. C&amp;#8217;est d&amp;#8217;ailleurs ce point que Stefan a souligné durant la journée PGDAY du 11 juin dernier.&lt;/p&gt;&#xA;&lt;p&gt;Cette nouvelle fonctionnalité fait partie de la version &lt;strong&gt;PostgreSQL 17&lt;/strong&gt; qui est pour le moment, en version&lt;strong&gt; Beta 2&lt;/strong&gt;.&lt;br /&gt;&#xA;Celle ci devrait sortir, comme à l&amp;#8217;accoutumé, au cour de l&amp;#8217;automne prochain.&lt;/p&gt;&#xA;&lt;p&gt;Preuve que PostgreSQL est en perpétuel évolution, et rejoint la liste des SGBD étant capable, comme peuvent le faire Oracle et SQL Server, de proposer nativement des sauvegardes incrémentales.&lt;/p&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;h2&gt;Installation de PostgreSQL 17&lt;/h2&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;p&gt;Pour tester cette fonctionnalité, nous devons installer la toute dernière version de PostgreSQL , la 17 beta 2. Attention, celle ci n&amp;#8217;étant pas disponible dans les dépôts PGDG, nous devons nous charger d&amp;#8217;installer cette version via le site postgresql.org&lt;/p&gt;&#xA;&lt;p&gt;&lt;a href=&#34;https://download.postgresql.org/pub/repos/yum/testing/17/redhat/rhel-8-x86_64/&#34;&gt;https://download.postgresql.org/pub/repos/yum/testing/17/redhat/rhel-8-x86_64/&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;Nous disposons d&amp;#8217;un serveur Linux fork Red Hat 8 (Rocky Linux). Il nous faut donc télécharger les &amp;#8220;rpm&amp;#8221; liés à cette version.&lt;/p&gt;&#xA;&lt;p&gt;Les packages dont nous avons besoin sont les suivants&lt;/p&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;# ls -lrt postgresql1* | awk &#39;{print$9}&#39;&#xD;&#xA;postgresql17-contrib-17-beta2_1PGDG.rhel8.x86_64.rpm&#xD;&#xA;postgresql17-17-beta2_1PGDG.rhel8.x86_64.rpm&#xD;&#xA;postgresql17-libs-17-beta2_1PGDG.rhel8.x86_64.rpm&#xD;&#xA;postgresql17-server-17-beta2_1PGDG.rhel8.x86_64.rpm&lt;/pre&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;p&gt;Nous les installons avec le compte &lt;strong&gt;root&lt;/strong&gt; de notre serveur.&lt;/p&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;[root@ tmp]# rpm -i postgresql17-libs-17-beta2_1PGDG.rhel8.x86_64.rpm&#xD;&#xA;[root@ tmp]# rpm -i postgresql17-17-beta2_1PGDG.rhel8.x86_64.rpm&#xD;&#xA;[root@ tmp]# rpm -i postgresql17-server-17-beta2_1PGDG.rhel8.x86_64.rpm&#xD;&#xA;[root@ tmp]# rpm -i postgresql17-contrib-17-beta2_1PGDG.rhel8.x86_64.rpm&lt;/pre&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;p&gt;Comme nous sommes sur un environnement &amp;#8220;Red Hat like&amp;#8221;, la création d&amp;#8217;une première instance via &amp;#8220;initdb&amp;#8221; est nécessaire.&lt;br /&gt;&#xA;Surtout, ne pas oublier d&amp;#8217;activer les &amp;#8220;data checksums&amp;#8221; (option -k), nous verrons pourquoi dans la suite de cet article. La suite est à faire avec le compte &lt;strong&gt;postgres&lt;/strong&gt;.&lt;/p&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;[postgres ~]$ initdb -D /data/postgres/17/pg_data -k&#xD;&#xA;The files belonging to this database system will be owned by user &amp;quot;postgres&amp;quot;.&#xD;&#xA;This user must also own the server process.&#xD;&#xA;&#xD;&#xA;The database cluster will be initialized with locale &amp;quot;en_US.UTF-8&amp;quot;.&#xD;&#xA;The default database encoding has accordingly been set to &amp;quot;UTF8&amp;quot;.&#xD;&#xA;The default text search configuration will be set to &amp;quot;english&amp;quot;.&#xD;&#xA;&#xD;&#xA;Data page checksums are enabled.&#xD;&#xA;&#xD;&#xA;creating directory /data/postgres/17/pg_data ... ok&#xD;&#xA;creating subdirectories ... ok&#xD;&#xA;selecting dynamic shared memory implementation ... posix&#xD;&#xA;selecting default &amp;quot;max_connections&amp;quot; ... 100&#xD;&#xA;selecting default &amp;quot;shared_buffers&amp;quot; ... 128MB&#xD;&#xA;selecting default time zone ... UTC&#xD;&#xA;creating configuration files ... ok&#xD;&#xA;running bootstrap script ... ok&#xD;&#xA;performing post-bootstrap initialization ... ok&#xD;&#xA;syncing data to disk ... ok&#xD;&#xA;&#xD;&#xA;initdb: warning: enabling &amp;quot;trust&amp;quot; authentication for local connections&#xD;&#xA;initdb: hint: You can change this by editing pg_hba.conf or using the option -A, or --auth-local and --auth-host, the next time you run initdb.&#xD;&#xA;&#xD;&#xA;Success. You can now start the database server using:&#xD;&#xA;&#xD;&#xA;pg_ctl -D /data/postgres/17/pg_data -l logfile start&lt;/pre&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;p&gt;Démarrer cette instance pour s&amp;#8217;assurer que tout fonctionne&lt;/p&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;[postgres ~]$ pg_ctl -D /data/postgres/17/pg_data -l logfile start&#xD;&#xA;waiting for server to start.... done&#xD;&#xA;server started&lt;/pre&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;p&gt;Notre version enregistrée est bien une Beta 2. Version qui ne doit pas être mise sur un environnement de production comme le rappelle le site de la communauté PostgreSQL.&lt;/p&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;[postgres ~]$ psql&#xD;&#xA;(postgres@[local]:5437) [postgres] &amp;gt; select * from version();&#xD;&#xA;version&#xD;&#xA;------------------------------------------------------------------------------------------------------------&#xD;&#xA;PostgreSQL 17beta2 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 8.5.0 20210514 (Red Hat 8.5.0-22), 64-bit&#xD;&#xA;(1 row)&lt;/pre&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;h3&gt;Upgrade de version&lt;/h3&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;p&gt;Comme nous disposions deja d&amp;#8217;une version PostgreSQL15 sur ce serveur, nous passons par un upgrade via l&amp;#8217;outil &amp;#8220;pg_upgrade&amp;#8221; toujours disponible dans cette nouvelle version.&lt;/p&gt;&#xA;&lt;p&gt;Lancer pg_upgrade en mode check&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;[postgres ~]$ pg_upgrade -b /usr/pgsql-15/bin/ -B /usr/pgsql-17/bin/ -c -d /data/postgres/15/pg_data/ -D /data/postgres/17/pg_data/ -p 5434 -P 5437&#xD;&#xA;.....&#xD;&#xA;.....&#xD;&#xA;&#xD;&#xA;*Clusters are compatible*&#xD;&#xA;&amp;quot;/usr/pgsql-17/bin/pg_ctl&amp;quot; -w -D &amp;quot;/data/postgres/17/pg_data&amp;quot; -o &amp;quot;&amp;quot; -m smart stop  &amp;quot;/data/postgres/17/pg_data/pg_upgrade_output.d/20240708T085906.955/log/pg_upgrade_server.log&amp;quot; &lt;/pre&gt;&#xA;&lt;p&gt;la log est générée dans le $PGDATA de la version 17.&lt;/p&gt;&#xA;&lt;p&gt;Puis lancer l&amp;#8217;exécution de pg_upgrade&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;[postgres ~]$ pg_upgrade -b /usr/pgsql-15/bin/ -B /usr/pgsql-17/bin/ -d /data/postgres/15/pg_data/ -D /data/postgres/17/pg_data/ -p 5434 -P 5437&lt;/pre&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;h2&gt;Effectuer une sauvegarde&lt;/h2&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;h3&gt;Prérequis&lt;/h3&gt;&#xA;&lt;p&gt;Avant de pouvoir effectuer une première sauvegarde avec l&amp;#8217;outil &amp;#8220;&lt;strong&gt;pg_basebackup&lt;/strong&gt;&amp;#8221; natif, il est primordial de respecter certains prérequis important.&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;L&amp;#8217;instance PostgreSQL doit être créée avec les &amp;#8216;data checksums&amp;#8217; activés. Si ce n&amp;#8217;est pas le cas, utiliser l&amp;#8217;outil &amp;#8220;&lt;strong&gt;pg_checksums&lt;/strong&gt;&amp;#8221; avec l&amp;#8217;option &amp;#8220;&lt;strong&gt;-e&lt;/strong&gt;&amp;#8220;.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Si vous lancez une sauvegarde full puis une incrémentale immédiatement, vous avez toutes les chances de tomber sur cette erreur&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;pg_basebackup: error: could not initiate base backup: ERROR: incremental backups cannot be taken unless WAL summarization is enabled&lt;/pre&gt;&#xA;&lt;p&gt;En effet, pour avoir toutes les informations concernant les blocks modifiés, PostgreSQL a besoin de tracer dans les WALs toutes les modifications sur les objets en base.&lt;br /&gt;&#xA;Pour les DBA Oracle, le &amp;#8220;block change tracking&amp;#8221; de la version Enterprise Edition vous parlera très certainement&amp;#8230;.&lt;br /&gt;&#xA;Il s&amp;#8217;agit ici de la même fonctionnalité, c&amp;#8217;est à dire, tracer les modifications effectuées dans les blocks de données.&lt;br /&gt;&#xA;Cette option est le &amp;#8220;&lt;strong&gt;summarize_wal&lt;/strong&gt;&amp;#8220;.&lt;/p&gt;&#xA;&lt;p&gt;Pour activer l&amp;#8217;option, nous aurons 2 paramètres à modifier, soit via un ALTER SYSTEM directement sous psql, ou bien dans le fichier &amp;#8220;postgresql.conf&amp;#8221;.&lt;/p&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;[postgres backup]$ vi $PGDATA/postgresql.conf&#xD;&#xA;...&#xD;&#xA;&#xD;&#xA;# - WAL Summarization -&#xD;&#xA;&#xD;&#xA;#summarize_wal = off # run WAL summarizer process?&#xD;&#xA;#wal_summary_keep_time = &#39;10d&#39; # when to remove old summary files, 0 = never&lt;/pre&gt;&#xA;&lt;p&gt;Le premier paramètre permet d&amp;#8217;activer cette option.&lt;br /&gt;&#xA;Le second définit un temps de conservation des informations concernant les blocks modifiés entre une sauvegarde FULL et un incrémentale.&lt;/p&gt;&#xA;&lt;p&gt;Nous activons donc l&amp;#8217;option &amp;#8220;&lt;strong&gt;summarize_wal&lt;/strong&gt;&amp;#8221; et la passons à &lt;strong&gt;ON&lt;/strong&gt; et laissons à 10 jours le &amp;#8220;&lt;strong&gt;wal_summary_keep_time&lt;/strong&gt;&amp;#8220;.&lt;/p&gt;&#xA;&lt;p&gt;Attention, activez ces deux paramètres avant votre première sauvegarde FULL. Si vous le faites après, vous risquez de rencontrer l&amp;#8217;erreur suivante&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;pg_basebackup: error: could not initiate base backup: ERROR: WAL summaries are required on timeline 1 from 1/AA000028 to 1/AC000060, but the summaries for that timeline and LSN range are incomplete&#xD;&#xA;DETAIL: The first unsummarized LSN in this range is 1/AA000028.&lt;/pre&gt;&#xA;&lt;p&gt;Le LSN pris lors de la première sauvegarde FULL n&amp;#8217;est pas reconnu, et donc la sauvegarde incrémentale ne peut s&amp;#8217;appuyer dessus.&lt;/p&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;p&gt;Redémarrer l&amp;#8217;instance une fois les modifications effectuées&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;[postgres ~]$ pg_ctl -D /data/postgres/17/pg_data/ restart&lt;/pre&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;h3&gt;Lancer une sauvegarde FULL&lt;/h3&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;p&gt;Voici la nouvelle option présente pour l&amp;#8217;outil &amp;#8220;&lt;strong&gt;pg_basebackup&lt;/strong&gt;&amp;#8221;&lt;/p&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;[postgres -]$ pg_basebackup --help&#xD;&#xA;pg_basebackup takes a base backup of a running PostgreSQL server.&#xD;&#xA;&#xD;&#xA;Usage:&#xD;&#xA;pg_basebackup [OPTION]...&#xD;&#xA;&#xD;&#xA;Options controlling the output:&#xD;&#xA;-D, --pgdata=DIRECTORY receive base backup into directory&#xD;&#xA;-F, --format=p|t output format (plain (default), tar)&#xD;&#xA;-i, --incremental=OLDMANIFEST&#xD;&#xA;take incremental backup&#xD;&#xA;-r, --max-rate=RATE maximum transfer rate to transfer data directory&#xD;&#xA;(in kB/s, or use suffix &amp;quot;k&amp;quot; or &amp;quot;M&amp;quot;)&#xD;&#xA;&#xD;&#xA;.... &lt;/pre&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;p&gt;Depuis la &lt;a href=&#34;https://blog.capdata.fr/index.php/postgresql-13-les-nouveautes-interessantes/&#34;&gt;version 13&lt;/a&gt; de PostgreSQL, nous disposons pour chaque sauvegarde, d&amp;#8217;un fichier nommé &amp;#8220;backup_manifest&amp;#8221;. Il s&amp;#8217;agit d&amp;#8217;un fichier json qui recense entièrement les objets bases de données sauvegardés avec leur emplacement, leur taille, leur date de modification et leur &amp;#8220;checksum&amp;#8221;.&lt;/p&gt;&#xA;&lt;p&gt;Celui ci est essentiel pour vérifier l&amp;#8217;intégrité de notre sauvegarde avec &amp;#8220;&lt;strong&gt;pg_verifybackup&lt;/strong&gt;&amp;#8220;.&lt;/p&gt;&#xA;&lt;p&gt;Nous pouvons à présent faire une première sauvegarde FULL de notre instance PG17.&lt;/p&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;[postgres -]$ pg_basebackup -D /data/postgres/backup/pg_basebackup/PG17 -F p -l &amp;quot;Full Backup PG17&amp;quot; -P -v&#xD;&#xA;pg_basebackup: initiating base backup, waiting for checkpoint to complete&#xD;&#xA;pg_basebackup: checkpoint completed&#xD;&#xA;pg_basebackup: write-ahead log start point: 1/AD000028 on timeline 1&#xD;&#xA;pg_basebackup: starting background WAL receiver&#xD;&#xA;pg_basebackup: created temporary replication slot &amp;quot;pg_basebackup_8048&amp;quot;&#xD;&#xA;3097788/3097788 kB (100%), 1/1 tablespace&#xD;&#xA;pg_basebackup: write-ahead log end point: 1/AD000158&#xD;&#xA;pg_basebackup: waiting for background process to finish streaming ...&#xD;&#xA;pg_basebackup: syncing data to disk ...&#xD;&#xA;pg_basebackup: renaming backup_manifest.tmp to backup_manifest&#xD;&#xA;pg_basebackup: base backup completed&lt;/pre&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;p&gt;Puis on effectue quelques transactions : création d&amp;#8217;une table et insertions de données sur cette table de test&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: sql; title: ; notranslate&#34;&gt;(postgres@[local]:5437) [manu] $ &amp;gt; create table backup (nom varchar(20), type varchar(20), date_backup date);&#xD;&#xA;CREATE TABLE&#xD;&#xA;Time: 3.344 ms&#xD;&#xA;&#xD;&#xA;(postgres@[local]:5437) [manu] $ &amp;gt; insert into backup values (&#39;sauvegarde&#39;,&#39;FULL&#39;,&#39;2024-07-08 12:00:00&#39;);&#xD;&#xA;INSERT 0 1&#xD;&#xA;Time: 3.612 ms&#xD;&#xA;(postgres@[local]:5437) [manu] $ &amp;gt; insert into backup values (&#39;sauvegarde&#39;,&#39;incremental&#39;,&#39;2024-07-08 13:00:00&#39;);&#xD;&#xA;INSERT 0 1&#xD;&#xA;Time: 1.461 ms&#xD;&#xA;&#xD;&#xA;(postgres@[local]:5437) [manu] $ &amp;gt; select * from backup;&#xD;&#xA;nom | type | date_backup&#xD;&#xA;------------+-------------+-------------&#xD;&#xA;sauvegarde | FULL | 2024-07-08&#xD;&#xA;sauvegarde | incremental | 2024-07-08&#xD;&#xA;(2 rows)&lt;/pre&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;p&gt;Repérer le fichier &amp;#8220;backup_manifest&amp;#8221; de la sauvegarde FULL réalisée dans le dossier &amp;#8220;&lt;strong&gt;/data/postgres/backup/pg_basebackup/PG17&lt;/strong&gt;&amp;#8221;&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;[postgres PG17]$ ls -lrt backup*&#xD;&#xA;-rw-------. 1 postgres postgres 218 Jul 8 09:19 backup_label&#xD;&#xA;-rw-------. 1 postgres postgres 433295 Jul 8 09:20 backup_manifest&lt;/pre&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;h3&gt;Effectuer une sauvegarde incrémentale&lt;/h3&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;p&gt;A partir de là, lancer une sauvegarde incrémentale. Nous utilisons l&amp;#8217;option &amp;#8220;&lt;strong&gt;-i&lt;/strong&gt;&amp;#8221; pour indiquer à &lt;strong&gt;pg_basebackup&lt;/strong&gt; ou est situé le &amp;#8220;backup_manifest&amp;#8221; de la dernière sauvegarde FULL.&lt;/p&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;[postgres - ]$ pg_basebackup -D /data/postgres/backup/pg_basebackup/PG17_incr -l &amp;quot;Incremental Backup PG17&amp;quot; -P -v -i /data/postgres/backup/pg_basebackup/PG17/backup_manifest&#xD;&#xA;pg_basebackup: initiating base backup, waiting for checkpoint to complete&#xD;&#xA;pg_basebackup: checkpoint completed&#xD;&#xA;pg_basebackup: write-ahead log start point: 1/AF000028 on timeline 1&#xD;&#xA;pg_basebackup: starting background WAL receiver&#xD;&#xA;pg_basebackup: created temporary replication slot &amp;quot;pg_basebackup_8139&amp;quot;&#xD;&#xA;12485/3097787 kB (100%), 1/1 tablespace&#xD;&#xA;pg_basebackup: write-ahead log end point: 1/AF000120&#xD;&#xA;pg_basebackup: waiting for background process to finish streaming ...&#xD;&#xA;pg_basebackup: syncing data to disk ...&#xD;&#xA;pg_basebackup: renaming backup_manifest.tmp to backup_manifest&#xD;&#xA;pg_basebackup: base backup completed&lt;/pre&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;p&gt;S&amp;#8217;il l&amp;#8217;on compare les deux répertoires de sauvegardes &amp;#8220;&lt;strong&gt;/data/postgres/backup/pg_basebackup/PG17&lt;/strong&gt;&amp;#8221; et &amp;#8220;&lt;strong&gt;/data/postgres/backup/pg_basebackup/PG17_incr&lt;/strong&gt;&amp;#8220;, nous voyons que les tailles sont bien différentes&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;[postgres - ]$ du -h /data/postgres/backup/pg_basebackup/PG17&#xD;&#xA;......&#xD;&#xA;3.0G /data/postgres/backup/pg_basebackup/PG17&#xD;&#xA;&#xD;&#xA;[postgres - ]$ du -h /data/postgres/backup/pg_basebackup/PG17_incr&#xD;&#xA;......&#xD;&#xA;35M /data/postgres/backup/pg_basebackup/PG17_incr&lt;/pre&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;p&gt;Un volume de 3Go pour la sauvegarde FULL de l&amp;#8217;instance contre 35Mo pour l&amp;#8217;incrémentale.&lt;br /&gt;&#xA;La taille occupée par les objets dans chacune des bases est bien plus faible dans la sauvegarde incrémentale.&lt;/p&gt;&#xA;&lt;p&gt;Nous continuons à insérer des données :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: sql; title: ; notranslate&#34;&gt; [postgres - ]$ psql -d manu&#xD;&#xA;&#xD;&#xA;(postgres@[local]:5437) [manu] $ &amp;gt; select * from backup;&#xD;&#xA;nom | type | date_backup&#xD;&#xA;------------+-------------+-------------&#xD;&#xA;sauvegarde | FULL | 2024-07-08&#xD;&#xA;sauvegarde | incremental | 2024-07-08&#xD;&#xA;(2 rows)&#xD;&#xA;&#xD;&#xA;Time: 0.614 ms&#xD;&#xA;(postgres@[local]:5437) [manu] $ &amp;gt; insert into backup values (&#39;sauvegarde&#39;,&#39;incremental 2&#39;,&#39;2024-07-08 14:00:00&#39;);&#xD;&#xA;INSERT 0 1&#xD;&#xA;Time: 1.436 ms&#xD;&#xA;(postgres@[local]:5437) [manu] $ &amp;gt; select * from backup;&#xD;&#xA;nom | type | date_backup&#xD;&#xA;------------+---------------+-------------&#xD;&#xA;sauvegarde | FULL | 2024-07-08&#xD;&#xA;sauvegarde | incremental | 2024-07-08&#xD;&#xA;sauvegarde | incremental 2 | 2024-07-08&#xD;&#xA;(3 rows)&lt;/pre&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;p&gt;Puis on lance une seconde sauvegarde incrémentale :&lt;/p&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;[postgres - ]$ pg_basebackup -D /data/postgres/backup/pg_basebackup/PG17_incr_2 -l &amp;quot;Incremental 2 Backup PG17&amp;quot; -P -v -i /data/postgres/backup/pg_basebackup/PG17_incr/backup_manifest&#xD;&#xA;pg_basebackup: initiating base backup, waiting for checkpoint to complete&#xD;&#xA;pg_basebackup: checkpoint completed&#xD;&#xA;pg_basebackup: write-ahead log start point: 1/B1000028 on timeline 1&#xD;&#xA;pg_basebackup: starting background WAL receiver&#xD;&#xA;pg_basebackup: created temporary replication slot &amp;quot;pg_basebackup_8313&amp;quot;&#xD;&#xA;12260/3097787 kB (100%), 1/1 tablespace&#xD;&#xA;pg_basebackup: write-ahead log end point: 1/B1000120&#xD;&#xA;pg_basebackup: waiting for background process to finish streaming ...&#xD;&#xA;pg_basebackup: syncing data to disk ...&#xD;&#xA;pg_basebackup: renaming backup_manifest.tmp to backup_manifest&#xD;&#xA;pg_basebackup: base backup completed&lt;/pre&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;p&gt;Nous remarquons l&amp;#8217;appel au &amp;#8220;backup manifest&amp;#8221; de la dernière sauvegarde incrémentale présente dans le répertoire &amp;#8220;&lt;strong&gt;/data/postgres/backup/pg_basebackup/PG17_incr&lt;/strong&gt;&amp;#8221;&lt;/p&gt;&#xA;&lt;p&gt;Si l&amp;#8217;on regarde la taille de ce nouveau backup&lt;/p&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;[postgres pg_basebackup]$ du -h PG17_incr_2&#xD;&#xA;.......&#xD;&#xA;35M PG17_incr_2&lt;/pre&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;p&gt;A nouveau 35 Mo, mais vu le peu de modifications effectuées, la taille n&amp;#8217;est pas très représentative.&lt;/p&gt;&#xA;&lt;p&gt;Ce qu&amp;#8217;il faut retenir, c&amp;#8217;est qu&amp;#8217;en fonction du fichier &amp;#8220;backup manifest&amp;#8221; pris lors de l&amp;#8217;appel à &lt;strong&gt;pg_basebackup&lt;/strong&gt;, vous pourrez faire soit&lt;br /&gt;&#xA;&amp;#8211; une sauvegarde incrémentale qui prendra les dernières modifications depuis la dernière sauvegarde incrémentale effectuée.&lt;br /&gt;&#xA;&amp;#8211; une sauvegarde différentielle qui prendra les modifications faites depuis la dernière sauvegarde FULL si vous vous appuyez toujours sur le &amp;#8220;backup manifest&amp;#8221; de votre sauvegarde FULL.&lt;/p&gt;&#xA;&lt;p&gt;C&amp;#8217;est donc ce fichier json &amp;#8220;backup manifest&amp;#8221; qui a un rôle essentiel dans l&amp;#8217;élaboration de votre stratégie de sauvegarde au fur et à mesure du temps.&lt;/p&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;h2&gt;Et la restauration , comment ca se passe ?&lt;/h2&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;p&gt;Si l&amp;#8217;on souhaite restaurer tous ces jeux de sauvegardes, nous utilisons un nouvel outil qui est &amp;#8220;&lt;strong&gt;pg_combinebackup&lt;/strong&gt;&amp;#8220;.&lt;br /&gt;&#xA;Cet outil permet de &amp;#8220;merger&amp;#8221; les différentes sauvegardes dans un et un seul dossier que l&amp;#8217;on restaurera par la suite.&lt;/p&gt;&#xA;&lt;p&gt;Dans notre exemple, nous avons fait 1 sauvegarde FULL puis 2 incrémentales.&lt;br /&gt;&#xA;Nous allons donc restaurer ces 3 jeux de sauvegardes afin de retrouver les données. A noter qu&amp;#8217;il existe une option &amp;#8220;&amp;#8211;dry-run&amp;#8221; pour tester la commande&lt;/p&gt;&#xA;&lt;p&gt;Exécuter la commande en prenant en paramètre les dossiers de sauvegardes dans l&amp;#8217;ordre chronologique.&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;[postgres - ]$ pg_combinebackup -n -o /data/postgres/backup/pg_basebackup/PG17_ALL /data/postgres/backup/pg_basebackup/PG17 /data/postgres/backup/pg_basebackup/PG17_incr /data/postgres/backup/pg_basebackup/PG17_incr_2 &lt;/pre&gt;&#xA;&lt;p&gt;Si aucune erreur en sortie, on exécute sans l&amp;#8217;option &amp;#8220;dry run&amp;#8221;.&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt; [postgres - ]$ pg_combinebackup -o /data/postgres/backup/pg_basebackup/PG17_ALL /data/postgres/backup/pg_basebackup/PG17 /data/postgres/backup/pg_basebackup/PG17_incr /data/postgres/backup/pg_basebackup/PG17_incr_2 &lt;/pre&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;p&gt;Le répertoire &amp;#8220;&lt;strong&gt;/data/postgres/backup/pg_basebackup/PG17_ALL&lt;/strong&gt;&amp;#8221; ainsi généré, doit avoir une taille très légèrement supérieure au dossier de la sauvegarde FULL.&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;[postgres - ]$ du -h PG17_ALL&#xD;&#xA;....&#xD;&#xA;3.0G PG17_ALL&lt;/pre&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;p&gt;Dernière étape, nous passons à la restauration des données.&lt;/p&gt;&#xA;&lt;p&gt;Nous arrêtons l&amp;#8217;instance PG17&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;[postgres - ]$ pg_ctl -D /data/postgres/17/pg_data/ stop&#xD;&#xA;waiting for server to shut down.... done&#xD;&#xA;server stopped&lt;/pre&gt;&#xA;&lt;p&gt;Nous supprimons les données dans $PGDATA&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;[postgres - ]$ rm -rf /data/postgres/17/pg_data/* &lt;/pre&gt;&#xA;&lt;p&gt;Puis nous restaurons ce jeu complet de données avec une simple copie.&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;[postgres - ]$ cp -r /data/postgres/backup/pg_basebackup/PG17_ALL/* /data/postgres/17/pg_data/ &lt;/pre&gt;&#xA;&lt;p&gt;Enfin redémarrons l&amp;#8217;instance&lt;/p&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;[postgres - ]$ pg_ctl -D /data/postgres/17/pg_data/ start&#xD;&#xA;waiting for server to start....2024-07-08 10:51:45.671 UTC [8909] LOG: redirecting log output to logging collector process&#xD;&#xA;2024-07-08 10:51:45.671 UTC [8909] HINT: Future log output will appear in directory &amp;quot;log&amp;quot;.&#xD;&#xA;done&#xD;&#xA;server started&lt;/pre&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;p&gt;Puis contrôler que nous récupérons bien toutes les lignes de notre table &amp;#8220;backup&amp;#8221;.&lt;/p&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;[postgres@ip-172-44-2-96 pg_basebackup]$ psql -d manu&#xD;&#xA;(postgres@[local]:5437) [manu] primaire $ &amp;gt; select * from backup;&#xD;&#xA;nom | type | date_backup&#xD;&#xA;------------+---------------+-------------&#xD;&#xA;sauvegarde | FULL | 2024-07-08&#xD;&#xA;sauvegarde | incremental | 2024-07-08&#xD;&#xA;sauvegarde | incremental 2 | 2024-07-08&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;h3&gt;&lt;/h3&gt;&#xA;&lt;h3&gt;&lt;/h3&gt;&#xA;&lt;h3&gt;Remarques&lt;/h3&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Attention, toujours vérifier les sauvegardes à chaque étape avec l&amp;#8217;outil &lt;strong&gt;pg_verifybackup &lt;/strong&gt;car rien ne garantit qu&amp;#8217;au moment de l&amp;#8217;appel à &lt;strong&gt;pg_combinebackup&lt;/strong&gt; les différents jeux de sauvegardes FULL et/ou incrémentales ne soient pas corrompus.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Assurez vous d&amp;#8217;être en mode &amp;#8220;data_checksum&amp;#8221; activé et ne pas changer de mode entre les jeux de backup. Le &amp;#8220;backup manifest&amp;#8221; s&amp;#8217;appuie sur ce paramétrage pour valider les checksums de chaque fichier.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Le mode TAR pour &lt;strong&gt;pg_basebackup&lt;/strong&gt; n&amp;#8217;est pas compatible pour les sauvegardes full et incrémentales même si celui ci est possible. Mais c&amp;#8217;est à vous de détarer les fichiers &amp;#8220;&lt;strong&gt;base.tar.gz&lt;/strong&gt;&amp;#8221; Et au moment de la restauration  avec &amp;#8220;&lt;strong&gt;pg_combinebackup&lt;/strong&gt;&amp;#8220;, une possible corruption est rencontrée.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;[postgres - ]$ pg_combinebackup -o /data/postgres/backup/pg_basebackup/PG17_all_tar /data/postgres/backup/pg_basebackup/PG17_TAR /data/postgres/backup/pg_basebackup/PG17_incr_TAR&#xD;&#xA;pg_combinebackup: error: could not write to file &amp;quot;/data/postgres/backup/pg_basebackup/PG17_all_tar/base/25284/25332&amp;quot;, offset 122470400: wrote 380928 of 409600&#xD;&#xA;pg_combinebackup: removing output directory &amp;quot;/data/postgres/backup/pg_basebackup/PG17_all_tar&amp;quot; &lt;/pre&gt;&#xA;&lt;p&gt;La compression a potentiellement ajoutée une corruption ne rendant pas possible l&amp;#8217;opération de &amp;#8220;merge&amp;#8221; des données.&lt;/p&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;La restauration PITR est possible bien entendu. N&amp;#8217;oubliez pas de créer le &amp;#8220;&lt;strong&gt;recovery.signal&lt;/strong&gt;&amp;#8221; dans $PGDATA et de définir dans le fichier &amp;#8220;postgresql.conf&amp;#8221; les quelques paramètres suivants&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;span style=&#34;color: #3366ff;&#34;&gt;recovery_target_name &lt;/span&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;span style=&#34;color: #3366ff;&#34;&gt;recovery_target_time &lt;/span&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;span style=&#34;color: #3366ff;&#34;&gt;recovery_target_xid &lt;/span&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;span style=&#34;color: #3366ff;&#34;&gt;recovery_target_lsn &lt;/span&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;span style=&#34;color: #808000;&#34;&gt;recovery_target_inclusive = off ou on&lt;/span&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;span style=&#34;color: #808000;&#34;&gt;recovery_target_timeline = &amp;#8216;latest&amp;#8217; &lt;/span&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;span style=&#34;color: #808000;&#34;&gt;recovery_target_action = &amp;#8216;pause&amp;#8217; &lt;/span&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;https://s.w.org/images/core/emoji/16.0.1/72x72/1f642.png&#34; alt=&#34;🙂&#34; class=&#34;wp-smiley&#34; style=&#34;height: 1em; max-height: 1em;&#34; /&gt;&lt;/p&gt;&#xA;&lt;p&gt;&amp;nbsp;&lt;strong&gt;Continuez votre lecture sur le blog :&lt;/strong&gt;&lt;/p&gt;&#xA;&lt;ul class=&#34;similar-posts&#34;&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://blog.capdata.fr/index.php/postgresql-la-streaming-replication-en-12/&#34; rel=&#34;bookmark&#34; title=&#34;19 novembre 2019&#34;&gt;PostgreSQL : la streaming replication en 12.&lt;/a&gt; (Emmanuel RAMI) [PostgreSQL]&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://blog.capdata.fr/index.php/postgresql-13-les-nouveautes-interessantes/&#34; rel=&#34;bookmark&#34; title=&#34;30 octobre 2020&#34;&gt;PostgreSQL 13 : présentation&lt;/a&gt; (Emmanuel RAMI) [PostgreSQL]&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://blog.capdata.fr/index.php/oracle-rds-effectuer-des-backup-rman-en-mode-paas/&#34; rel=&#34;bookmark&#34; title=&#34;25 juin 2019&#34;&gt;Oracle RDS : effectuer des backup RMAN en mode PaaS.&lt;/a&gt; (Emmanuel RAMI) [AWSNon classéOracle]&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://blog.capdata.fr/index.php/postgresql-comparatif-entre-barman-et-pgbackrest/&#34; rel=&#34;bookmark&#34; title=&#34;4 février 2020&#34;&gt;PostgreSQL : Comparatif entre Barman et pgBackRest&lt;/a&gt; (Capdata team) [PostgreSQL]&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://blog.capdata.fr/index.php/haute-disponibilite-de-postgresql-avec-patroni/&#34; rel=&#34;bookmark&#34; title=&#34;2 février 2022&#34;&gt;Haute disponibilité de PostgreSQL avec Patroni&lt;/a&gt; (Ludovic AUGEREAU) [PostgreSQL]&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;&lt;!-- Similar Posts took 2.587 ms --&gt;&lt;/p&gt;&#xA;&lt;a class=&#34;synved-social-button synved-social-button-share synved-social-size-24 synved-social-resolution-single synved-social-provider-twitter nolightbox&#34; data-provider=&#34;twitter&#34; target=&#34;_blank&#34; rel=&#34;nofollow&#34; title=&#34;Share on Twitter&#34; href=&#34;https://twitter.com/intent/tweet?url=https%3A%2F%2Fblog.capdata.fr%2F%3Fp%3D10584&amp;#038;text=Article%20sur%20le%20blog%20de%20la%20Capdata%20Tech%20Team%20%3A%20&#34; style=&#34;font-size: 0px;width:24px;height:24px;margin:0;margin-bottom:5px;margin-right:5px&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; alt=&#34;twitter&#34; title=&#34;Share on Twitter&#34; class=&#34;synved-share-image synved-social-image synved-social-image-share&#34; width=&#34;24&#34; height=&#34;24&#34; style=&#34;display: inline;width:24px;height:24px;margin: 0;padding: 0;border: none;box-shadow: none&#34; src=&#34;https://blog.capdata.fr/wp-content/plugins/social-media-feather/synved-social/image/social/regular/48x48/twitter.png&#34; /&gt;&lt;/a&gt;&lt;a class=&#34;synved-social-button synved-social-button-share synved-social-size-24 synved-social-resolution-single synved-social-provider-linkedin nolightbox&#34; data-provider=&#34;linkedin&#34; target=&#34;_blank&#34; rel=&#34;nofollow&#34; title=&#34;Share on Linkedin&#34; href=&#34;https://www.linkedin.com/shareArticle?mini=true&amp;#038;url=https%3A%2F%2Fblog.capdata.fr%2F%3Fp%3D10584&amp;#038;title=PostgreSQL%2017%20%3A%20des%20sauvegardes%20incr%C3%A9mentales%20avec%20pg_basebackup&#34; style=&#34;font-size: 0px;width:24px;height:24px;margin:0;margin-bottom:5px;margin-right:5px&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; alt=&#34;linkedin&#34; title=&#34;Share on Linkedin&#34; class=&#34;synved-share-image synved-social-image synved-social-image-share&#34; width=&#34;24&#34; height=&#34;24&#34; style=&#34;display: inline;width:24px;height:24px;margin: 0;padding: 0;border: none;box-shadow: none&#34; src=&#34;https://blog.capdata.fr/wp-content/plugins/social-media-feather/synved-social/image/social/regular/48x48/linkedin.png&#34; /&gt;&lt;/a&gt;&lt;a class=&#34;synved-social-button synved-social-button-share synved-social-size-24 synved-social-resolution-single synved-social-provider-mail nolightbox&#34; data-provider=&#34;mail&#34; rel=&#34;nofollow&#34; title=&#34;Share by email&#34; href=&#34;mailto:?subject=PostgreSQL%2017%20%3A%20des%20sauvegardes%20incr%C3%A9mentales%20avec%20pg_basebackup&amp;#038;body=Article%20sur%20le%20blog%20de%20la%20Capdata%20Tech%20Team%20%3A%20:%20https%3A%2F%2Fblog.capdata.fr%2F%3Fp%3D10584&#34; style=&#34;font-size: 0px;width:24px;height:24px;margin:0;margin-bottom:5px&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; alt=&#34;mail&#34; title=&#34;Share by email&#34; class=&#34;synved-share-image synved-social-image synved-social-image-share&#34; width=&#34;24&#34; height=&#34;24&#34; style=&#34;display: inline;width:24px;height:24px;margin: 0;padding: 0;border: none;box-shadow: none&#34; src=&#34;https://blog.capdata.fr/wp-content/plugins/social-media-feather/synved-social/image/social/regular/48x48/mail.png&#34; /&gt;&lt;/a&gt;&lt;p&gt;L’article &lt;a rel=&#34;nofollow&#34; href=&#34;https://blog.capdata.fr/index.php/postgresql-17-sauvegardes-incrementales/&#34;&gt;PostgreSQL 17 : des sauvegardes incrémentales avec pg_basebackup&lt;/a&gt; est apparu en premier sur &lt;a rel=&#34;nofollow&#34; href=&#34;https://blog.capdata.fr&#34;&gt;Capdata TECH BLOG&lt;/a&gt;.&lt;/p&gt;&#xA;</content>
    <link href="https://blog.capdata.fr/index.php/postgresql-17-sauvegardes-incrementales/" rel="alternate"></link>
    <summary type="html">&lt;p&gt;&amp;#160; Bonjour Les 11 et 12 juin derniers, nous étions aux journées PGDAY à Lille pour découvrir les nouveautés autour de PostgreSQL. Cette conférence regroupe différents professionnels, de la communauté francophone, qui agissent en contribuant sur des sujets techniques mais&amp;#8230; &lt;a href=&#34;https://blog.capdata.fr/index.php/postgresql-17-sauvegardes-incrementales/&#34; class=&#34;more-link&#34;&gt;Continuer la lecture &lt;span class=&#34;meta-nav&#34;&gt;&amp;#8594;&lt;/span&gt;&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;L’article &lt;a rel=&#34;nofollow&#34; href=&#34;https://blog.capdata.fr/index.php/postgresql-17-sauvegardes-incrementales/&#34;&gt;PostgreSQL 17 : des sauvegardes incrémentales avec pg_basebackup&lt;/a&gt; est apparu en premier sur &lt;a rel=&#34;nofollow&#34; href=&#34;https://blog.capdata.fr&#34;&gt;Capdata TECH BLOG&lt;/a&gt;.&lt;/p&gt;&#xA;</summary>
    <author>
      <name>Sarah FAVEERE</name>
    </author>
  </entry>
  <entry>
    <title>PGO : la suite</title>
    <updated>2024-05-29T08:58:17Z</updated>
    <id>tag:blog.capdata.fr,2024-05-29:/index.php/pgo-la-suite/</id>
    <content type="html">&lt;a class=&#34;synved-social-button synved-social-button-share synved-social-size-24 synved-social-resolution-single synved-social-provider-twitter nolightbox&#34; data-provider=&#34;twitter&#34; target=&#34;_blank&#34; rel=&#34;nofollow&#34; title=&#34;Share on Twitter&#34; href=&#34;https://twitter.com/intent/tweet?url=https%3A%2F%2Fblog.capdata.fr%2F%3Fp%3D10562&amp;#038;text=Article%20sur%20le%20blog%20de%20la%20Capdata%20Tech%20Team%20%3A%20&#34; style=&#34;font-size: 0px;width:24px;height:24px;margin:0;margin-bottom:5px;margin-right:5px&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; alt=&#34;twitter&#34; title=&#34;Share on Twitter&#34; class=&#34;synved-share-image synved-social-image synved-social-image-share&#34; width=&#34;24&#34; height=&#34;24&#34; style=&#34;display: inline;width:24px;height:24px;margin: 0;padding: 0;border: none;box-shadow: none&#34; src=&#34;https://blog.capdata.fr/wp-content/plugins/social-media-feather/synved-social/image/social/regular/48x48/twitter.png&#34; /&gt;&lt;/a&gt;&lt;a class=&#34;synved-social-button synved-social-button-share synved-social-size-24 synved-social-resolution-single synved-social-provider-linkedin nolightbox&#34; data-provider=&#34;linkedin&#34; target=&#34;_blank&#34; rel=&#34;nofollow&#34; title=&#34;Share on Linkedin&#34; href=&#34;https://www.linkedin.com/shareArticle?mini=true&amp;#038;url=https%3A%2F%2Fblog.capdata.fr%2F%3Fp%3D10562&amp;#038;title=PGO%20%3A%20la%20suite&#34; style=&#34;font-size: 0px;width:24px;height:24px;margin:0;margin-bottom:5px;margin-right:5px&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; alt=&#34;linkedin&#34; title=&#34;Share on Linkedin&#34; class=&#34;synved-share-image synved-social-image synved-social-image-share&#34; width=&#34;24&#34; height=&#34;24&#34; style=&#34;display: inline;width:24px;height:24px;margin: 0;padding: 0;border: none;box-shadow: none&#34; src=&#34;https://blog.capdata.fr/wp-content/plugins/social-media-feather/synved-social/image/social/regular/48x48/linkedin.png&#34; /&gt;&lt;/a&gt;&lt;a class=&#34;synved-social-button synved-social-button-share synved-social-size-24 synved-social-resolution-single synved-social-provider-mail nolightbox&#34; data-provider=&#34;mail&#34; rel=&#34;nofollow&#34; title=&#34;Share by email&#34; href=&#34;mailto:?subject=PGO%20%3A%20la%20suite&amp;#038;body=Article%20sur%20le%20blog%20de%20la%20Capdata%20Tech%20Team%20%3A%20:%20https%3A%2F%2Fblog.capdata.fr%2F%3Fp%3D10562&#34; style=&#34;font-size: 0px;width:24px;height:24px;margin:0;margin-bottom:5px&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; alt=&#34;mail&#34; title=&#34;Share by email&#34; class=&#34;synved-share-image synved-social-image synved-social-image-share&#34; width=&#34;24&#34; height=&#34;24&#34; style=&#34;display: inline;width:24px;height:24px;margin: 0;padding: 0;border: none;box-shadow: none&#34; src=&#34;https://blog.capdata.fr/wp-content/plugins/social-media-feather/synved-social/image/social/regular/48x48/mail.png&#34; /&gt;&lt;/a&gt;&lt;p&gt;La gestion efficace des clusters PostgreSQL dans un environnement Kubernetes est un défi complexe auquel sont confrontées de nombreuses entreprises aujourd&amp;#8217;hui. PGO offre une solution déclarative qui automatise la gestion des clusters PostgreSQL, simplifiant ainsi le déploiement, la mise à l&amp;#8217;échelle et la gestion des bases de données PostgreSQL dans un environnement Kubernetes.&lt;/p&gt;&#xA;&lt;p&gt;Pour faire suite à l&amp;#8217;article de David sur PGO et à la demande d&amp;#8217;un de nos clients, j&amp;#8217;ai réalisé une étude approfondie de plusieurs fonctionnalités de PGO.&lt;br /&gt;&#xA;Cet article va faire un petit tour d&amp;#8217;horizon des outils principaux inclus dans l&amp;#8217;implémentation de PGO. Que ce soit pour la sauvegarde avec pgbackrest, pour la balance des connexion avec pgbouncer ou pour le monitoring avec prometheus, PGO ne manque pas d&amp;#8217;utilitaire dont l&amp;#8217;utilisation est facilitée par la solution tout embarqué.&lt;/p&gt;&#xA;&lt;h3&gt;Pgbackrest :&lt;/h3&gt;&#xA;&lt;h4&gt;Utilité :&lt;/h4&gt;&#xA;&lt;p&gt;PgBackRest est une solution de sauvegarde et de restauration pour les bases de données PostgreSQL qui propose plusieurs fonctionnalités, telles que la sauvegarde et la restauration parallèles, la compression, les sauvegardes complètes, différentielles et incrémentielles, la rotation des sauvegardes et l&amp;#8217;expiration des archives, l&amp;#8217;intégrité des sauvegardes, etc. Il prend en charge plusieurs référentiels, qui peuvent être situés localement ou à distance via TLS/SSH, ou être des stockages fournis par le cloud comme S3/GCS/Azure.&lt;br /&gt;&#xA;L&amp;#8217;architecture de pgbackrest pour PGO est la suivante :&lt;/p&gt;&#xA;&lt;p&gt;&lt;a href=&#34;https://blog.capdata.fr/wp-content/uploads/2024/05/Image1.png&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; class=&#34;alignnone size-medium wp-image-10564&#34; src=&#34;https://blog.capdata.fr/wp-content/uploads/2024/05/Image1-300x168.png&#34; alt=&#34;&#34; width=&#34;300&#34; height=&#34;168&#34; srcset=&#34;https://blog.capdata.fr/wp-content/uploads/2024/05/Image1-300x168.png 300w, https://blog.capdata.fr/wp-content/uploads/2024/05/Image1.png 605w&#34; sizes=&#34;auto, (max-width: 300px) 100vw, 300px&#34; /&gt;&lt;/a&gt;&lt;/p&gt;&#xA;&lt;h4&gt;Mise en place :&lt;/h4&gt;&#xA;&lt;p&gt;On peut imaginer plusieurs moyens de mettre en place le pgbackrest. Dans un premier temps, nous avons la sauvegarde classique en système de fichier, comme dans notre exemple sur le blog :&lt;/p&gt;&#xA;&lt;h5&gt;1) La sauvegarde sur volume persistant Kubernetes :&lt;/h5&gt;&#xA;&lt;pre class=&#34;brush: yaml; title: ; notranslate&#34;&gt;&#xD;&#xA;- name: repo1&#xD;&#xA;  volume:&#xD;&#xA;    volumeClaimSpec:&#xD;&#xA;      accessModes:&#xD;&#xA;      - &amp;quot;ReadWriteOnce&amp;quot;&#xD;&#xA;      resources:&#xD;&#xA;        requests:&#xD;&#xA;          storage: 1Gi&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;p&gt;Ce type de sauvegarde utilise un volume persistant de Kubernetes pour recueillir nos sauvegardes et les garder.&lt;br /&gt;&#xA;Une PersistentVolumeClaim (PVC) est une demande de stockage faite par un utilisateur. Elle est similaire à un Pod. Les Pods consomment des ressources de nœud et les PVC consomment des ressources de PV (PersistentVolume). Les Pods peuvent demander des niveaux spécifiques de ressources (CPU et mémoire). Les revendications peuvent demander une taille spécifique et des modes d&amp;#8217;accès spécifiques (par exemple, elles peuvent être montées en ReadWriteOnce, ReadOnlyMany, ReadWriteMany, ou ReadWriteOncePod, voir AccessModes).&lt;/p&gt;&#xA;&lt;h5&gt;2) Le stockage pour S3 :&lt;/h5&gt;&#xA;&lt;p&gt;Pour pouvoir faire du stockage dans S3, il faut rajouter un fichier de configuration dans notre dossier de déploiement. Le fichier doit s’appeler s3.conf. Ce fichier contient les crédential de connexion à un AWS S3 :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;&#xD;&#xA;repo1-s3-key=$YOUR_AWS_S3_KEY&#xD;&#xA;repo1-s3-key-secret=$YOUR_AWS_S3_KEY_SECRET&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;p&gt;Une fois que c’est configuré dans votre fichier, il ne reste plus qu’à modifier le postgresql.yaml, et configurer dans la partie backup :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: yaml; title: ; notranslate&#34;&gt;&#xD;&#xA;backups:&#xD;&#xA;    pgbackrest:&#xD;&#xA;      image: registry.developers.crunchydata.com/crunchydata/crunchy-pgbackrest:ubi8-2.49-0&#xD;&#xA;      configuration:&#xD;&#xA;      - secret:&#xD;&#xA;          name: pgo-s3-creds&#xD;&#xA;      global:&#xD;&#xA;        repo1-path: /pgbackrest/postgres-operator/pgcluster1/repo1&#xD;&#xA;      repos:&#xD;&#xA;      - name: repo1&#xD;&#xA;        s3:&#xD;&#xA;          bucket: &amp;quot;&amp;lt;YOUR_AWS_S3_BUCKET_NAME&amp;gt;&amp;quot;&#xD;&#xA;          endpoint: &amp;quot;&amp;lt;YOUR_AWS_S3_ENDPOINT&amp;gt;&amp;quot;&#xD;&#xA;          region: &amp;quot;&amp;lt;YOUR_AWS_S3_REGION&amp;gt;&amp;quot;&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;p&gt;Une fois configuré, et le job mis dans le cron, vous devriez voir apparaitre les sauvegardes sur le volume S3.&lt;/p&gt;&#xA;&lt;h5&gt;3) Le stockage GCS :&lt;/h5&gt;&#xA;&lt;p&gt;Comme pour Amazon S3 on peut sauvegarder nos backups dans Google Cloud Storage. Pour pouvoir le faire fonctionner il vous faut copier votre GCS key secret (qui est un fichier JSON) dans un gcs.conf que vous allez placer dans votre dossier Kustomize.&lt;br /&gt;&#xA;Il vous suffit ensuite de modifier votre fichier postgres.yaml pour ajouter dans la partie backup la configuration pour une sauvegarde gcs :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: yaml; title: ; notranslate&#34;&gt;&#xD;&#xA;backups:&#xD;&#xA;    pgbackrest:&#xD;&#xA;      image: registry.developers.crunchydata.com/crunchydata/crunchy-pgbackrest:ubi8-2.49-0&#xD;&#xA;      configuration:&#xD;&#xA;      - secret:&#xD;&#xA;          name: pgo-gcs-creds&#xD;&#xA;      global:&#xD;&#xA;        repo1-path: /pgbackrest/postgres-operator/pgcluster1/repo1&#xD;&#xA;      repos:&#xD;&#xA;      - name: repo1&#xD;&#xA;        gcs:&#xD;&#xA;          bucket: &amp;quot;&amp;lt;YOUR_GCS_BUCKET_NAME&amp;gt;&amp;quot;&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;p&gt;Il ne vous reste plus qu’à regénérer vos pods, et votre sauvegarde arrivera directement dans votre Google Cloud Service.&lt;/p&gt;&#xA;&lt;h5&gt;4) Le stockage Azur Blob Storage :&lt;/h5&gt;&#xA;&lt;p&gt;Comme pour les deux points précédents, vous pouvez également stocker vos sauvegardes sur le blob storage d’Azure. Pour cela il vous faut créer un fichier dans votre kustomize, avec à l’intérieur la configuration pour votre point de sauvegarde Azure. Il vous faut l’appeler azure.conf et il devra contenir les lignes suivantes :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;&#xD;&#xA;repo1-azure-account=$YOUR_AZURE_ACCOUNT&#xD;&#xA;repo1-azure-key=$YOUR_AZURE_KEY&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;p&gt;Il faut ensuite intégrer ces modifications dans votre fichier postgres.yaml :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: yaml; title: ; notranslate&#34;&gt;&#xD;&#xA;backups:&#xD;&#xA;    pgbackrest:&#xD;&#xA;      image: registry.developers.crunchydata.com/crunchydata/crunchy-pgbackrest:ubi8-2.49-0&#xD;&#xA;      configuration:&#xD;&#xA;      - secret:&#xD;&#xA;          name: pgo-azure-creds&#xD;&#xA;      global:&#xD;&#xA;        repo1-path: /pgbackrest/postgres-operator/pgcluster/repo1&#xD;&#xA;      repos:&#xD;&#xA;      - name: repo1&#xD;&#xA;        azure:&#xD;&#xA;          container: &amp;quot;&amp;lt;YOUR_AZURE_CONTAINER&amp;gt;&amp;quot;&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;p&gt;Bien sur rien ne vous interdit, et c’est même conseillé, de joindre plusieurs moyens de sauvegarde. Cela permet notamment de s’assurer une plus grande fiabilité du système de sauvegarde, en s’assurant qu’elles sont disponibles à plusieurs endroits.&lt;br /&gt;&#xA;Une fois que vous avez décidé d’où vous allez stocker vos sauvegardes, et que vous l’avez configuré, il faut maintenant décider des différents paramètres de ces sauvegardes : la programmation, la rétention…&lt;/p&gt;&#xA;&lt;h5&gt;5) La programmation des sauvegardes :&lt;/h5&gt;&#xA;&lt;p&gt;Il faut savoir que par défaut, PGO sauvegarde automatiquement les WAL dans la méthode de sauvegarde que vous lui avez configuré. C’est donc une forme de sauvegarde en soit.&lt;br /&gt;&#xA;Mais dans le cadre d’une récupération après incident majeur, il peut aussi être utilise d’avoir des sauvegardes full programmées. Pgbackrest, qui est l’outil utilisé par PGO permet de mettre en place trois types de sauvegarde : les incrémentales, les différentielles et les fulls.&lt;br /&gt;&#xA;Chaque type de sauvegarde peut être programmée en suivant une notation identique à celle des crontab. Par exemple :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: yaml; title: ; notranslate&#34;&gt;&#xD;&#xA;backups:&#xD;&#xA;    pgbackrest:&#xD;&#xA;      repos:&#xD;&#xA;      - name: repo1&#xD;&#xA;        schedules:&#xD;&#xA;          full: &amp;quot;0 1 * * 0&amp;quot;&#xD;&#xA;          differential: &amp;quot;0 1 * * 1-6&amp;quot;&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;p&gt;Le fait d’implémenter ces planifications créera des CronJobs dans Kubernetes.&lt;/p&gt;&#xA;&lt;h5&gt;6) La rétention des backups :&lt;/h5&gt;&#xA;&lt;p&gt;Vous pouvez définir une rétention maximum pour vos backups sur le support de backup de votre choix. Une fois que cette rétention sera atteinte, pgbackrest fera le ménage tout seul des sauvegardes et des WAL qui lui sont reliées.&lt;br /&gt;&#xA;Il y a deux types de rétentions que l’on peut définir : les rétentions « count » basées sur le nombre de backup que l’on souhaite garder et les rétentions « time » basées sur le nombre de jours ou vous souhaitez garder votre sauvegarde.&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: yaml; title: ; notranslate&#34;&gt;&#xD;&#xA;backups:&#xD;&#xA;    pgbackrest:&#xD;&#xA;      global:&#xD;&#xA;        repo1-retention-full: &amp;quot;14&amp;quot;&#xD;&#xA;        repo1-retention-full-type: time&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;h5&gt;7) La sauvegarde unique :&lt;/h5&gt;&#xA;&lt;p&gt;Si dans le cadre d’un besoin particuliers, une grosse modification ou une migration par exemple, vous avez besoin de prendre une sauvegarde immédiate sans forcément attendre que le cron n’arrive, vous pouvez le faire.&lt;br /&gt;&#xA;Pour la configuration de cette sauvegarde, il faudra l’annoter comme « manuelle » :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: yaml; title: ; notranslate&#34;&gt;&#xD;&#xA;  backups:&#xD;&#xA;    pgbackrest:&#xD;&#xA;      manual:&#xD;&#xA;        repoName: repo1&#xD;&#xA;        options:&#xD;&#xA;         - --type=full&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;p&gt;Il vous faudra ensuite déclencher cette sauvegarde avec une commande manuelle. Dans le cadre de notre cluster exemple pgcluster1 :&lt;br /&gt;&#xA;kubectl annotate -n postgres-operator postgrescluster pgcluster1 \ postgres-operator.crunchydata.com/pgbackrest-backup=&amp;#8221;$(date)&amp;#8221;&lt;/p&gt;&#xA;&lt;h5&gt;8) Faire un clone à partir d’un repo :&lt;/h5&gt;&#xA;&lt;p&gt;Quand on a configuré un repo sur notre instance primaire, on peut facilement créer un clone de notre instance à l’aide de notre sauvegarde. Ainsi, on créer un tout nouveau Pods à partir des informations stockées à propos du pod que l’on possède déjà. Ici, nous allons créer un nouveau pod à partir de notre pod pgcluster1 :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: yaml; title: ; notranslate&#34;&gt;&#xD;&#xA;apiVersion: postgres-operator.crunchydata.com/v1beta1&#xD;&#xA;kind: PostgresCluster&#xD;&#xA;metadata:&#xD;&#xA;  name: pgcluster2&#xD;&#xA;spec:&#xD;&#xA;  dataSource:&#xD;&#xA;    postgresCluster:&#xD;&#xA;      clusterName: pgcluster1&#xD;&#xA;      repoName: repo1&#xD;&#xA;  image: registry.developers.crunchydata.com/crunchydata/crunchy-postgres:ubi8-16.2-0&#xD;&#xA;  postgresVersion: 16&#xD;&#xA;  instances:&#xD;&#xA;    - dataVolumeClaimSpec:&#xD;&#xA;        accessModes:&#xD;&#xA;        - &amp;quot;ReadWriteOnce&amp;quot;&#xD;&#xA;        resources:&#xD;&#xA;          requests:&#xD;&#xA;            storage: 1Gi&#xD;&#xA;  backups:&#xD;&#xA;    pgbackrest:&#xD;&#xA;      image: registry.developers.crunchydata.com/crunchydata/crunchy-pgbackrest:ubi8-2.49-0&#xD;&#xA;      repos:&#xD;&#xA;      - name: repo1&#xD;&#xA;        volume:&#xD;&#xA;          volumeClaimSpec:&#xD;&#xA;            accessModes:&#xD;&#xA;            - &amp;quot;ReadWriteOnce&amp;quot;&#xD;&#xA;            resources:&#xD;&#xA;              requests:&#xD;&#xA;                storage: 1Gi&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;p&gt;Ici on peut noter entre autres la partie spec de la configuration, qui est le morceau de yaml nous permettant de dire qu’on s’appuie sur le cluster existant pour créer un clone indépendant :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: yaml; title: ; notranslate&#34;&gt;&#xD;&#xA;spec:&#xD;&#xA;  dataSource:&#xD;&#xA;    postgresCluster:&#xD;&#xA;      clusterName: pgcluster1&#xD;&#xA;      repoName: repo1&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;h5&gt;9) Point in Time Recovery :&lt;/h5&gt;&#xA;&lt;p&gt;De la même façon, si l’on veut faire une restauration PITR, nous allons remplir la balise spec de notre yaml. Attention cependant, pour faire une restauration PITR, nous avons besoin de posséder encore la sauvegarde. On ne peut pas faire une restauration PITR sur une sauvegarde lointaine qu’on ne possèderait plus. Imaginons que je souhaite repartir d’une sauvegarde datant d’hier soir à 20h30 de mon instance pgcluster1 sur mon instance pgcluster2, la configuration serait la suivante :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: yaml; title: ; notranslate&#34;&gt;&#xD;&#xA;apiVersion: postgres-operator.crunchydata.com/v1beta1&#xD;&#xA;kind: PostgresCluster&#xD;&#xA;metadata:&#xD;&#xA;  name: pgcluster2&#xD;&#xA;spec:&#xD;&#xA;  dataSource:&#xD;&#xA;    postgresCluster:&#xD;&#xA;      clusterName: pgcluster1&#xD;&#xA;      repoName: repo1&#xD;&#xA;      options:&#xD;&#xA;      - --type=time&#xD;&#xA;      - --target=&amp;quot;2024-04-09 20:30:00-00&amp;quot;&#xD;&#xA;  image: registry.developers.crunchydata.com/crunchydata/crunchy-postgres:ubi8-16.2-0&#xD;&#xA;  postgresVersion: 16&#xD;&#xA;  instances:&#xD;&#xA;    - dataVolumeClaimSpec:&#xD;&#xA;        accessModes:&#xD;&#xA;        - &amp;quot;ReadWriteOnce&amp;quot;&#xD;&#xA;        resources:&#xD;&#xA;          requests:&#xD;&#xA;            storage: 1Gi&#xD;&#xA;  backups:&#xD;&#xA;    pgbackrest:&#xD;&#xA;      image: registry.developers.crunchydata.com/crunchydata/crunchy-pgbackrest:ubi8-2.49-0&#xD;&#xA;      repos:&#xD;&#xA;      - name: repo1&#xD;&#xA;        volume:&#xD;&#xA;          volumeClaimSpec:&#xD;&#xA;            accessModes:&#xD;&#xA;            - &amp;quot;ReadWriteOnce&amp;quot;&#xD;&#xA;            resources:&#xD;&#xA;              requests:&#xD;&#xA;                storage: 1Gi&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;p&gt;La partie qui nous intéresse ici est la partie spec, ou nous avons rajouter un type de restauration (ici time) et une heure target. Cela indique à pgbackrest qu’il doit aller chercher tous les fichiers de sauvegarde et WAL sur notre point de sauvegarde repo1 venant de l’instance pgcluster1 pour les réappliquer sur notre nouveau cluster pgcluster2.&lt;br /&gt;&#xA;Vous pouvez également vouloir réaliser une restauration In Place, c’est-à-dire écraser l’instance présente pour la remplacer par la restauration. Auquel cas, plutôt que de préciser comment s’appellera notre nouveau cluster, il faut alors passer par la balise restore :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: yaml; title: ; notranslate&#34;&gt;&#xD;&#xA;spec:&#xD;&#xA;  backups:&#xD;&#xA;    pgbackrest:&#xD;&#xA;      restore:&#xD;&#xA;        enabled: true&#xD;&#xA;        repoName: repo1&#xD;&#xA;        options:&#xD;&#xA;        - --type=time&#xD;&#xA;        - --target=&amp;quot;2024-04-09 20:30:00-00&amp;quot;&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;p&gt;Ici, comme précédemment, nous restaurons à l’heure de 20 :30 hier soir, et cela sur notre propre instance. Ne reste plus qu’à lancer la restauration :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;kubectl annotate -n postgres-operator postgrescluster pgcluster1 --overwrite \ postgres-operator.crunchydata.com/pgbackrest-restore=&amp;quot;$(date)&amp;quot;&lt;/pre&gt;&#xA;&lt;p&gt;A noter qu’il ne faut pas oublier de désactiver ensuite le restore en le passant à false si vous ne souhaitez pas qu’il soit de nouveau écrasé au prochain changement de configuration.&lt;/p&gt;&#xA;&lt;h5&gt;10) Restaurer une base de données spécifique :&lt;/h5&gt;&#xA;&lt;p&gt;Si votre besoin est de restaurer une base de données spécifique plutôt que l’intégralité de l’instance, vous pouvez le préciser dans les paramètres de votre restauration.&lt;br /&gt;&#xA;Attention cependant, ce n’est pas une restauration comme le serais un pg_dump. Ici si vous restaurez simplement une seule base de données et pas le reste du cluster, les autres bases que vous n’avez pas choisit de restaurer deviendront inaccessibles.&lt;br /&gt;&#xA;Si nous voulons restaurer une base de données, et uniquement elle, voici la procédure :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: yaml; title: ; notranslate&#34;&gt;&#xD;&#xA;spec:&#xD;&#xA;backups:&#xD;&#xA;  pgbackrest:&#xD;&#xA;    restore:&#xD;&#xA;      enabled: true&#xD;&#xA;      repoName: repo1&#xD;&#xA;      options:&#xD;&#xA;        - --db-include=capdata&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;p&gt;Ici, on ne restaurera que la base de données capdata, et aucunes autres bases à partir de notre repo1.&lt;/p&gt;&#xA;&lt;h3&gt;PgBouncer :&lt;/h3&gt;&#xA;&lt;h4&gt;Utilité :&lt;/h4&gt;&#xA;&lt;p&gt;PgBouncer est un pooler de connexion pour PostgreSQL. Un pooler de connexion permet de maintenir ouvertes des sessions entre lui-même et le serveur, ce qui rend plus rapide l&amp;#8217;ouverture de sessions depuis les clients, une application Web par exemple.&lt;br /&gt;&#xA;PgBouncer permet aussi de mutualiser les sessions dans le serveur, économisant ainsi des ressources. PgBouncer propose plusieurs modes de partage : par requête (default), par transaction ou par session.&lt;/p&gt;&#xA;&lt;h4&gt;Mise en place :&lt;/h4&gt;&#xA;&lt;p&gt;Pour ajouter un bouncer à notre configuration c’est une réalité très simple. Il suffit d’ajouter dans notre fichier postgres.yaml la rubrique proxy :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: yaml; title: ; notranslate&#34;&gt;&#xD;&#xA;proxy:&#xD;&#xA;  pgBouncer:&#xD;&#xA;    image: registry.developers.crunchydata.com/crunchydata/crunchy-pgbouncer:ubi8-1.21-3&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;p&gt;Une fois que vous avez rajouté cela dans la configuration, il n’y a plus qu’à appliquer celle-ci :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt; kubectl apply -k kustomize/keycloak &lt;/pre&gt;&#xA;&lt;p&gt;Quand PGO créé un nouveau connexion pooler sur notre instance déployée, il modifier le fichier secrets de l’utilisateur.&lt;br /&gt;&#xA;On voit que plusieurs champs qui concerne pg_bouncer sont apparus. Ils constituent les informations qui vont vous permettre de vous connecter sur votre bouncer nouvellement créé :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: yaml; title: ; notranslate&#34;&gt;&#xD;&#xA;{&#xD;&#xA;    &amp;quot;apiVersion&amp;quot;: &amp;quot;v1&amp;quot;,&#xD;&#xA;    &amp;quot;data&amp;quot;: {&#xD;&#xA;        &amp;quot;dbname&amp;quot;: &amp;quot;cGdjbHVzdGVyMQ==&amp;quot;,&#xD;&#xA;        &amp;quot;host&amp;quot;: &amp;quot;cGdjbHVzdGVyMS1wcmltYXJ5LnBvc3RncmVzLW9wZXJhdG9yLnN2Yw==&amp;quot;,&#xD;&#xA;        &amp;quot;jdbc-uri&amp;quot;: &amp;quot;amRiYzpwb3N0Z3Jlc3FsOi8vcGdjbHVzdGVyMS1wcmltYXJ5LnBvc3RncmVzLW9wZXJhdG9yLnN2Yzo1NDMyL3BnY2x1c3RlcjE/cGFzc3dvcmQ9NXNSaSUzRCU1QmZZbSUzQ2lSSGslMkElNUIlM0VuWGhqaiU3Q1EmdXNlcj1wZ2NsdXN0ZXIx&amp;quot;,&#xD;&#xA;        &amp;quot;password&amp;quot;: &amp;quot;NXNSaT1bZlltPGlSSGsqWz5uWGhqanxR&amp;quot;,&#xD;&#xA;        &amp;quot;pgbouncer-host&amp;quot;: &amp;quot;cGdjbHVzdGVyMS1wZ2JvdW5jZXIucG9zdGdyZXMtb3BlcmF0b3Iuc3Zj&amp;quot;,&#xD;&#xA;        &amp;quot;pgbouncer-jdbc-uri&amp;quot;: &amp;quot;amRiYzpwb3N0Z3Jlc3FsOi8vcGdjbHVzdGVyMS1wZ2JvdW5jZXIucG9zdGdyZXMtb3BlcmF0b3Iuc3ZjOjU0MzIvcGdjbHVzdGVyMT9wYXNzd29yZD01c1JpJTNEJTVCZlltJTNDaVJIayUyQSU1QiUzRW5YaGpqJTdDUSZwcmVwYXJlVGhyZXNob2xkPTAmdXNlcj1wZ2NsdXN0ZXIx&amp;quot;,&#xD;&#xA;        &amp;quot;pgbouncer-port&amp;quot;: &amp;quot;NTQzMg==&amp;quot;,&#xD;&#xA;        &amp;quot;pgbouncer-uri&amp;quot;: &amp;quot;cG9zdGdyZXNxbDovL3BnY2x1c3RlcjE6NXNSaT0lNUJmWW0lM0NpUkhrJTJBJTVCJTNFblhoamolN0NRQHBnY2x1c3RlcjEtcGdib3VuY2VyLnBvc3RncmVzLW9wZXJhdG9yLnN2Yzo1NDMyL3BnY2x1c3RlcjE=&amp;quot;,&#xD;&#xA;        &amp;quot;port&amp;quot;: &amp;quot;NTQzMg==&amp;quot;,&#xD;&#xA;        &amp;quot;uri&amp;quot;: &amp;quot;cG9zdGdyZXNxbDovL3BnY2x1c3RlcjE6NXNSaT0lNUJmWW0lM0NpUkhrJTJBJTVCJTNFblhoamolN0NRQHBnY2x1c3RlcjEtcHJpbWFyeS5wb3N0Z3Jlcy1vcGVyYXRvci5zdmM6NTQzMi9wZ2NsdXN0ZXIx&amp;quot;,&#xD;&#xA;        &amp;quot;user&amp;quot;: &amp;quot;cGdjbHVzdGVyMQ==&amp;quot;,&#xD;&#xA;        &amp;quot;verifier&amp;quot;: &amp;quot;U0NSQU0tU0hBLTI1NiQ0MDk2OlgyQ3NQRU1FZjh3QkVlc05McDFJTkE9PSRKcDhKakl5Q0o1ZEpFRVhia1ptUERTNE5rR3d0V00rczdrMElsQmx0YkpvPTpEaHg3VzNCOE5vNDRYSHJ1Qm1RdENMQW9jNEtnSUZQa2dIeStUMkVWUUowPQ==&amp;quot;&#xD;&#xA;    },&#xD;&#xA;    &amp;quot;kind&amp;quot;: &amp;quot;Secret&amp;quot;,&#xD;&#xA;    &amp;quot;metadata&amp;quot;: {&#xD;&#xA;        &amp;quot;creationTimestamp&amp;quot;: &amp;quot;2024-04-09T16:37:36Z&amp;quot;,&#xD;&#xA;        &amp;quot;labels&amp;quot;: {&#xD;&#xA;            &amp;quot;postgres-operator.crunchydata.com/cluster&amp;quot;: &amp;quot;pgcluster1&amp;quot;,&#xD;&#xA;            &amp;quot;postgres-operator.crunchydata.com/pguser&amp;quot;: &amp;quot;pgcluster1&amp;quot;,&#xD;&#xA;            &amp;quot;postgres-operator.crunchydata.com/role&amp;quot;: &amp;quot;pguser&amp;quot;&#xD;&#xA;        },&#xD;&#xA;        &amp;quot;name&amp;quot;: &amp;quot;pgcluster1-pguser-pgcluster1&amp;quot;,&#xD;&#xA;        &amp;quot;namespace&amp;quot;: &amp;quot;postgres-operator&amp;quot;,&#xD;&#xA;        &amp;quot;ownerReferences&amp;quot;: [&#xD;&#xA;            {&#xD;&#xA;                &amp;quot;apiVersion&amp;quot;: &amp;quot;postgres-operator.crunchydata.com/v1beta1&amp;quot;,&#xD;&#xA;                &amp;quot;blockOwnerDeletion&amp;quot;: true,&#xD;&#xA;                &amp;quot;controller&amp;quot;: true,&#xD;&#xA;                &amp;quot;kind&amp;quot;: &amp;quot;PostgresCluster&amp;quot;,&#xD;&#xA;                &amp;quot;name&amp;quot;: &amp;quot;pgcluster1&amp;quot;,&#xD;&#xA;                &amp;quot;uid&amp;quot;: &amp;quot;7260b882-116f-4b02-b51a-18d4fe3a8038&amp;quot;&#xD;&#xA;            }&#xD;&#xA;        ],&#xD;&#xA;        &amp;quot;resourceVersion&amp;quot;: &amp;quot;9495&amp;quot;,&#xD;&#xA;        &amp;quot;uid&amp;quot;: &amp;quot;1fbdf1d2-48ea-4a45-b7d6-01248317dbee&amp;quot;&#xD;&#xA;    },&#xD;&#xA;    &amp;quot;type&amp;quot;: &amp;quot;Opaque&amp;quot;&#xD;&#xA;}&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;p&gt;Pour se connecter à notre pgbouncer, il suffit d’utiliser les informations fournies par le fichier de secret à la place de nos infos de connexion habituelles, et cela nous permet d’accéder directement au bouncer et non plus à l’instance elle-même.&lt;/p&gt;&#xA;&lt;p&gt;Cette connexion peut être facilement modifiée en utilisant la documentation de pgbouncer afin de pouvoir configurer à notre guise notre pgbouncer. Un exemple de configuration qu’on pourrais rencontrer serait :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: yaml; title: ; notranslate&#34;&gt;&#xD;&#xA;  proxy:&#xD;&#xA;    pgBouncer:&#xD;&#xA;      image: {{.Values.image.pgBouncer }}&#xD;&#xA;      config:&#xD;&#xA;        global:&#xD;&#xA;          default_pool_size: &amp;quot;100&amp;quot;&#xD;&#xA;          max_client_conn: &amp;quot;10000&amp;quot;&#xD;&#xA;          pool_mode: transaction&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;p&gt;Pour cet exemple on voit qu’on a définit un nombre de client maximum, la taille du pool à 100 et un mode transaction pour notre pool.&lt;/p&gt;&#xA;&lt;h3&gt;PGO et Prometheus&lt;/h3&gt;&#xA;&lt;h4&gt;Utilité :&lt;/h4&gt;&#xA;&lt;p&gt;Prometheus est une trousse à outils de surveillance et d&amp;#8217;alerte des systèmes en open source.&lt;br /&gt;&#xA;Prometheus collecte et stocke ses métriques sous forme de données de séries temporelles, c&amp;#8217;est-à-dire que les informations de métriques sont stockées avec le timestamp auquel elles ont été enregistrées, aux côtés de paires clé-valeur optionnelles appelées labels.&lt;br /&gt;&#xA;&amp;#8211; Un modèle de données multidimensionnel avec des données de séries temporelles identifiées par le nom de la métrique et des paires clé-valeur&lt;br /&gt;&#xA;&amp;#8211; PromQL, un langage de requête flexible pour exploiter cette dimensionnalité&lt;br /&gt;&#xA;&amp;#8211; Aucune dépendance sur le stockage distribué ; les nœuds de serveur individuels sont autonomes&lt;br /&gt;&#xA;&amp;#8211; La collecte de séries temporelles se fait via un modèle de tirage sur HTTP&lt;br /&gt;&#xA;&amp;#8211; La poussée de séries temporelles est prise en charge via une passerelle intermédiaire&lt;br /&gt;&#xA;&amp;#8211; Les cibles sont découvertes via la découverte de service ou la configuration statique&lt;br /&gt;&#xA;&amp;#8211; Prise en charge de plusieurs modes de graphiques et de tableaux de bord&lt;/p&gt;&#xA;&lt;h4&gt;Mise en place :&lt;/h4&gt;&#xA;&lt;p&gt;Pour pouvoir mettre en place une surveillance pour notre cluster, il est plus simple de télécharger et compléter le modèle fournit dans les exemples de pgo.&lt;br /&gt;&#xA;Ainsi, on peut récupérer les exemples à l’aide de git :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;&#xD;&#xA;YOUR_GITHUB_UN=&amp;quot;$YOUR_GITHUB_USERNAME&amp;quot;&#xD;&#xA;git clone --depth 1 &amp;quot;git@github.com:${YOUR_GITHUB_UN}/postgres-operator-examples.git&amp;quot;&#xD;&#xA;cd postgres-operator-examples&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;p&gt;Les différentes configurations se trouvent dans le dossier kustomize/monitoring.&lt;br /&gt;&#xA;Pour activer le monitoring de notre instance, il faut ajouter la balise monitoring à notre fichier postgres.yaml :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: yaml; title: ; notranslate&#34;&gt;&#xD;&#xA;monitoring:&#xD;&#xA;  pgmonitor:&#xD;&#xA;    exporter:&#xD;&#xA;      image: registry.developers.crunchydata.com/crunchydata/crunchy-postgres-exporter:ubi8-5.5.1-0&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;p&gt;Une fois notre configuration modifiée, on l’applique afin que PGO détecte les changements et configure tout seul l’exporter pour qu’il puisse se connecter à nos bases de données et récupérer les métriques.&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;&#xD;&#xA;kubectl apply -k kustomize/postgres&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;p&gt;Il faut ensuite appliquer la configuration de base de pgmonitor pour qu’il créé lui-même les fichiers de configuration pour prometheus (il le fera en même temps pour Grafana et Alertmanager qui sont deux autres outils de surveillance). Pour cela on applique le kustomize présent dans le dossier monitoring :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;&#xD;&#xA;$kubectl apply -k kustomize\postgres&#xD;&#xA;postgrescluster.postgres-operator.crunchydata.com/pgcluster1 configured&#xD;&#xA;$kubectl apply -k kustomize\monitoring&#xD;&#xA;serviceaccount/alertmanager created&#xD;&#xA;serviceaccount/grafana created&#xD;&#xA;serviceaccount/prometheus created&#xD;&#xA;clusterrole.rbac.authorization.k8s.io/prometheus created&#xD;&#xA;clusterrolebinding.rbac.authorization.k8s.io/prometheus created&#xD;&#xA;configmap/alert-rules-config created&#xD;&#xA;configmap/alertmanager-config created&#xD;&#xA;configmap/crunchy-prometheus created&#xD;&#xA;configmap/grafana-dashboards created&#xD;&#xA;configmap/grafana-datasources created&#xD;&#xA;secret/grafana-admin created&#xD;&#xA;service/crunchy-alertmanager created&#xD;&#xA;service/crunchy-grafana created&#xD;&#xA;service/crunchy-prometheus created&#xD;&#xA;persistentvolumeclaim/alertmanagerdata created&#xD;&#xA;persistentvolumeclaim/grafanadata created&#xD;&#xA;persistentvolumeclaim/prometheusdata created&#xD;&#xA;deployment.apps/crunchy-alertmanager created&#xD;&#xA;deployment.apps/crunchy-grafana created&#xD;&#xA;deployment.apps/crunchy-prometheus created&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;p&gt;Nos services ont été correctement déployés, il ne nous reste plus qu’à utiliser celui qui nous intéresse, ici service/crunchy-prometheus et lui indiquer de commencer à envoyer les informations sur notre prometheus :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;&#xD;&#xA;$kubectl -n postgres-operator port-forward service/crunchy-prometheus 9090:9090&#xD;&#xA;Forwarding from 127.0.0.1:9090 -&amp;gt; 9090&#xD;&#xA;Forwarding from [::1]:9090 -&amp;gt; 9090&#xD;&#xA;Handling connection for 9090&#xD;&#xA;Handling connection for 9090&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;p&gt;Afin d’accéder à notre service prometheus, il ne nous reste plus qu’à se connecter avec l’adresse de notre machine, sur le port 9090 préalablement ouvert, pour voir apparaitre le dashboard de prometheus :&lt;/p&gt;&#xA;&lt;p&gt;&lt;a href=&#34;https://blog.capdata.fr/wp-content/uploads/2024/05/Image2.jpg&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; class=&#34;alignnone size-medium wp-image-10567&#34; src=&#34;https://blog.capdata.fr/wp-content/uploads/2024/05/Image2-300x66.jpg&#34; alt=&#34;&#34; width=&#34;300&#34; height=&#34;66&#34; srcset=&#34;https://blog.capdata.fr/wp-content/uploads/2024/05/Image2-300x66.jpg 300w, https://blog.capdata.fr/wp-content/uploads/2024/05/Image2-1024x226.jpg 1024w, https://blog.capdata.fr/wp-content/uploads/2024/05/Image2-768x170.jpg 768w, https://blog.capdata.fr/wp-content/uploads/2024/05/Image2.jpg 1386w&#34; sizes=&#34;auto, (max-width: 300px) 100vw, 300px&#34; /&gt;&lt;/a&gt;&lt;/p&gt;&#xA;&lt;h3&gt;PGO Client :&lt;/h3&gt;&#xA;&lt;h4&gt;Utilité :&lt;/h4&gt;&#xA;&lt;p&gt;Pour pouvoir gérer plus facilement le cluster créé par PGO, CrunchyData à développé une surcouche à kubectl qui permet de faciliter les commandes que nous pouvons réaliser sur le cluster.&lt;br /&gt;&#xA;Cela permet de ne pas avoir à taper les longues lignes de commandes qui permettent par exemple de démarrer les sauvegardes unitaires.&lt;/p&gt;&#xA;&lt;h4&gt;Mise en place :&lt;/h4&gt;&#xA;&lt;p&gt;Pour pouvoir installer cette surcouche, il faut télécharger la version qui correspond au système d’exploitation à partir du GIT de pgo client :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;&#xD;&#xA;# wget https://github.com/CrunchyData/postgres-operator-client/releases/download/v0.4.1/kubectl-pgo-linux-arm64&#xD;&#xA;--2024-04-11 12:07:45--  https://github.com/CrunchyData/postgres-operator-client/releases/download/v0.4.1/kubectl-pgo-linux-arm64&#xD;&#xA;Resolving github.com (github.com)... 140.82.121.4&#xD;&#xA;Connecting to github.com (github.com)|140.82.121.4|:443... connected.&#xD;&#xA;HTTP request sent, awaiting response... 302 Found&#xD;&#xA;Resolving objects.githubusercontent.com (objects.githubusercontent.com)... 185.199.109.133, 185.199.111.133, 185.199.110.133, ...&#xD;&#xA;Connecting to objects.githubusercontent.com (objects.githubusercontent.com)|185.199.109.133|:443... connected.&#xD;&#xA;HTTP request sent, awaiting response... 200 OK&#xD;&#xA;Length: 47895849 (46M) [application/octet-stream]&#xD;&#xA;Saving to: ‘kubectl-pgo-linux-arm64’&#xD;&#xA;&#xD;&#xA;kubectl-pgo-linux-arm64                                     100%[========================================================================================================================================&amp;gt;]  45.68M  --.-KB/s    in 0.1s&#xD;&#xA;&#xD;&#xA;2024-04-11 12:07:45 (373 MB/s) - ‘kubectl-pgo-linux-arm64’ saved [47895849/47895849]&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;p&gt;On renome le fichier téléchargé en kubectl-pgo et on le déplace dans nos bin pour pouvoir les utiliser :&lt;/p&gt;&#xA;&lt;pre class=&#34;brush: bash; title: ; notranslate&#34;&gt;&#xD;&#xA;# mv kubectl-pgo-linux-arm64 kubectl-pgo&#xD;&#xA;# sudo mv kubectl-pgo /usr/local/bin/kubectl-pgo&#xD;&#xA;# sudo chmod +x /usr/local/bin/kubectl-pgo&#xD;&#xA;Une fois que ces actions sont réalisées, on peut tester le fonctionnement :&#xD;&#xA;# kubectl pgo version&#xD;&#xA;Client Version: v0.4.1&#xD;&#xA;Operator Version: v5.5.1&#xD;&#xA;&lt;/pre&gt;&#xA;&lt;p&gt;Les commandes disponibles avec cette extension sont les suivantes :&lt;br /&gt;&#xA;&amp;#8211; backup : Backup cluster&lt;br /&gt;&#xA;&amp;#8211; create : Create a resource&lt;br /&gt;&#xA;&amp;#8211; delete : Delete a resource&lt;br /&gt;&#xA;&amp;#8211; help : Help about any command&lt;br /&gt;&#xA;&amp;#8211; restore : Restore cluster&lt;br /&gt;&#xA;&amp;#8211; show Show : PostgresCluster details&lt;br /&gt;&#xA;&amp;#8211; start : Start cluster&lt;br /&gt;&#xA;&amp;#8211; stop : Stop cluster&lt;br /&gt;&#xA;&amp;#8211; support : Crunchy Support commands for PGO&lt;br /&gt;&#xA;&amp;#8211; version : PGO client&lt;strong&gt;Continuez votre lecture sur le blog :&lt;/strong&gt;&lt;/p&gt;&#xA;&lt;ul class=&#34;similar-posts&#34;&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://blog.capdata.fr/index.php/pgo-operateurs-kubernetes-pour-postgresql-la-suite/&#34; rel=&#34;bookmark&#34; title=&#34;6 juin 2023&#34;&gt;PGO : opérateurs kubernetes pour PostgreSQL, la suite !&lt;/a&gt; (David Baffaleuf) [ContainerDevopsPostgreSQL]&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://blog.capdata.fr/index.php/kubegres-loperateur-kubernetes-cle-en-main-pour-postgresql/&#34; rel=&#34;bookmark&#34; title=&#34;26 avril 2023&#34;&gt;Kubegres : l&amp;#8217;opérateur Kubernetes clé en main pour PostgreSQL&lt;/a&gt; (David Baffaleuf) [ContainerDevopsPostgreSQL]&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://blog.capdata.fr/index.php/postgresql-comparatif-entre-barman-et-pgbackrest/&#34; rel=&#34;bookmark&#34; title=&#34;4 février 2020&#34;&gt;PostgreSQL : Comparatif entre Barman et pgBackRest&lt;/a&gt; (Capdata team) [PostgreSQL]&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://blog.capdata.fr/index.php/postgresql-sur-la-solution-kubernetes-locale-minikube/&#34; rel=&#34;bookmark&#34; title=&#34;29 mars 2023&#34;&gt;PostgreSQL sur la solution Kubernetes locale Minikube&lt;/a&gt; (Emmanuel RAMI) [ContainerPostgreSQL]&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://blog.capdata.fr/index.php/sauvegardes-sql-server-dans-un-azure-blob-storage/&#34; rel=&#34;bookmark&#34; title=&#34;21 août 2018&#34;&gt;Sauvegardes SQL Server dans un Azure Blob Storage&lt;/a&gt; (Capdata team) [AzureSQL Server]&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;&lt;!-- Similar Posts took 3.189 ms --&gt;&lt;/p&gt;&#xA;&lt;a class=&#34;synved-social-button synved-social-button-share synved-social-size-24 synved-social-resolution-single synved-social-provider-twitter nolightbox&#34; data-provider=&#34;twitter&#34; target=&#34;_blank&#34; rel=&#34;nofollow&#34; title=&#34;Share on Twitter&#34; href=&#34;https://twitter.com/intent/tweet?url=https%3A%2F%2Fblog.capdata.fr%2F%3Fp%3D10562&amp;#038;text=Article%20sur%20le%20blog%20de%20la%20Capdata%20Tech%20Team%20%3A%20&#34; style=&#34;font-size: 0px;width:24px;height:24px;margin:0;margin-bottom:5px;margin-right:5px&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; alt=&#34;twitter&#34; title=&#34;Share on Twitter&#34; class=&#34;synved-share-image synved-social-image synved-social-image-share&#34; width=&#34;24&#34; height=&#34;24&#34; style=&#34;display: inline;width:24px;height:24px;margin: 0;padding: 0;border: none;box-shadow: none&#34; src=&#34;https://blog.capdata.fr/wp-content/plugins/social-media-feather/synved-social/image/social/regular/48x48/twitter.png&#34; /&gt;&lt;/a&gt;&lt;a class=&#34;synved-social-button synved-social-button-share synved-social-size-24 synved-social-resolution-single synved-social-provider-linkedin nolightbox&#34; data-provider=&#34;linkedin&#34; target=&#34;_blank&#34; rel=&#34;nofollow&#34; title=&#34;Share on Linkedin&#34; href=&#34;https://www.linkedin.com/shareArticle?mini=true&amp;#038;url=https%3A%2F%2Fblog.capdata.fr%2F%3Fp%3D10562&amp;#038;title=PGO%20%3A%20la%20suite&#34; style=&#34;font-size: 0px;width:24px;height:24px;margin:0;margin-bottom:5px;margin-right:5px&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; alt=&#34;linkedin&#34; title=&#34;Share on Linkedin&#34; class=&#34;synved-share-image synved-social-image synved-social-image-share&#34; width=&#34;24&#34; height=&#34;24&#34; style=&#34;display: inline;width:24px;height:24px;margin: 0;padding: 0;border: none;box-shadow: none&#34; src=&#34;https://blog.capdata.fr/wp-content/plugins/social-media-feather/synved-social/image/social/regular/48x48/linkedin.png&#34; /&gt;&lt;/a&gt;&lt;a class=&#34;synved-social-button synved-social-button-share synved-social-size-24 synved-social-resolution-single synved-social-provider-mail nolightbox&#34; data-provider=&#34;mail&#34; rel=&#34;nofollow&#34; title=&#34;Share by email&#34; href=&#34;mailto:?subject=PGO%20%3A%20la%20suite&amp;#038;body=Article%20sur%20le%20blog%20de%20la%20Capdata%20Tech%20Team%20%3A%20:%20https%3A%2F%2Fblog.capdata.fr%2F%3Fp%3D10562&#34; style=&#34;font-size: 0px;width:24px;height:24px;margin:0;margin-bottom:5px&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; alt=&#34;mail&#34; title=&#34;Share by email&#34; class=&#34;synved-share-image synved-social-image synved-social-image-share&#34; width=&#34;24&#34; height=&#34;24&#34; style=&#34;display: inline;width:24px;height:24px;margin: 0;padding: 0;border: none;box-shadow: none&#34; src=&#34;https://blog.capdata.fr/wp-content/plugins/social-media-feather/synved-social/image/social/regular/48x48/mail.png&#34; /&gt;&lt;/a&gt;&lt;p&gt;L’article &lt;a rel=&#34;nofollow&#34; href=&#34;https://blog.capdata.fr/index.php/pgo-la-suite/&#34;&gt;PGO : la suite&lt;/a&gt; est apparu en premier sur &lt;a rel=&#34;nofollow&#34; href=&#34;https://blog.capdata.fr&#34;&gt;Capdata TECH BLOG&lt;/a&gt;.&lt;/p&gt;&#xA;</content>
    <link href="https://blog.capdata.fr/index.php/pgo-la-suite/" rel="alternate"></link>
    <summary type="html">&lt;p&gt;La gestion efficace des clusters PostgreSQL dans un environnement Kubernetes est un défi complexe auquel sont confrontées de nombreuses entreprises aujourd&amp;#8217;hui. PGO offre une solution déclarative qui automatise la gestion des clusters PostgreSQL, simplifiant ainsi le déploiement, la mise à&amp;#8230; &lt;a href=&#34;https://blog.capdata.fr/index.php/pgo-la-suite/&#34; class=&#34;more-link&#34;&gt;Continuer la lecture &lt;span class=&#34;meta-nav&#34;&gt;&amp;#8594;&lt;/span&gt;&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;L’article &lt;a rel=&#34;nofollow&#34; href=&#34;https://blog.capdata.fr/index.php/pgo-la-suite/&#34;&gt;PGO : la suite&lt;/a&gt; est apparu en premier sur &lt;a rel=&#34;nofollow&#34; href=&#34;https://blog.capdata.fr&#34;&gt;Capdata TECH BLOG&lt;/a&gt;.&lt;/p&gt;&#xA;</summary>
    <author>
      <name>Sarah FAVEERE</name>
    </author>
  </entry>
  <entry>
    <title>Index &#34;Skip Scan&#34; avec PostgreSQL 18</title>
    <updated>2025-04-06T10:30:00Z</updated>
    <id>tag:pgphil.ovh,2025-04-06:/index_composite_18_01.php</id>
    <link href="https://pgphil.ovh/index_composite_18_01.php" rel="alternate"></link>
    <summary type="html">Mise à jour de la page sur les index composites et les requêtes dont la clause de filtrage comprend des colonnes de l&#39;index mais pas la première colonne. PostgreSQL 18 est à présent capable d&#39;effectuer des &#34;skip scan&#34;, de sauter la première colonne et de tirer parti bien plus efficacement de l&#39;index composite b-tree dans certains cas.</summary>
    <author>
      <name>pgphil.ovh</name>
    </author>
  </entry>
  <entry>
    <title>Mesurer facilement la latence I/O avec PostgreSQL 16</title>
    <updated>2023-09-02T16:30:00Z</updated>
    <id>tag:pgphil.ovh,2023-09-02:/traqueur_16_01.php</id>
    <link href="http://pgphil.ovh/traqueur_16_01.php" rel="alternate"></link>
    <summary type="html">Démonstration avec le traqueur d&#39;une nouvelle fonctionnalité PostgreSQL 16 facilitant le suivi des performances et le diagnostic des ralentissements</summary>
    <author>
      <name>pgphil.ovh</name>
    </author>
  </entry>
  <entry>
    <title>Mettre à jour PostgreSQL pour améliorer les performances</title>
    <updated>2023-05-21T09:00:00Z</updated>
    <id>tag:pgphil.ovh,2023-05-21:/migration_performance_14_15_01.php</id>
    <link href="http://pgphil.ovh/migration_performance_14_15_01.php" rel="alternate"></link>
    <summary type="html">Pagination, ex aequo...obtenez vos résultats triés bien plus rapidement avec PostgreSQL 15</summary>
    <author>
      <name>pgphil.ovh</name>
    </author>
  </entry>
  <entry>
    <title>PostgreSQL inspire les autres SGBD ?</title>
    <updated>2023-04-12T09:00:00Z</updated>
    <id>tag:pgphil.ovh,2023-04-12:/oracle23c_ou_oracle23p_comme_postgresql.php</id>
    <link href="http://pgphil.ovh/oracle23c_ou_oracle23p_comme_postgresql.php" rel="alternate"></link>
    <summary type="html">Oracle 23c ou 23p comme PostgreSQL ?</summary>
    <author>
      <name>pgphil.ovh</name>
    </author>
  </entry>
  <entry>
    <title>CYCLE</title>
    <updated>2022-12-03T15:00:00Z</updated>
    <id>tag:pgphil.ovh,2022-12-03:/nocycle_15_01.php</id>
    <link href="http://pgphil.ovh/nocycle_15_01.php" rel="alternate"></link>
    <summary type="html">Nouveautés autour des requêtes hiérarchiques avec PostgreSQL 14 et versions supérieures</summary>
    <author>
      <name>pgphil.ovh</name>
    </author>
  </entry>
  <entry>
    <title>MERGE</title>
    <updated>2022-03-29T17:30:00Z</updated>
    <id>tag:pgphil.ovh,2022-03-29:/upsert_15_devel_01.php</id>
    <link href="http://pgphil.ovh/upsert_15_devel_01.php" rel="alternate"></link>
    <summary type="html">Introduction de la commande MERGE par PostgreSQL 15</summary>
    <author>
      <name>pgphil.ovh</name>
    </author>
  </entry>
  <entry>
    <title>PostgreSQL… Python… ça fait PL/Python !</title>
    <updated>2025-02-15T19:00:00Z</updated>
    <id>tag:blog.arthurbazin.com,2025-02-15:/programmation/postgresql-python-ca-fait-pl-python</id>
    <content type="html">&#xA;&lt;p&gt;Imaginez, vous utilisez PostgreSQL au quotidien pour stocker et traiter vos données. Comme vous êtes curieux, vous avez essayé Python pour faire quelques traitements et vous vous êtes rendus compte que c&amp;rsquo;était pas mal quand même&amp;#8230; Malheureusement vos scripts sont complètement dissociés de la base de données et vous vous dites qu&amp;rsquo;il serait pratique que ces scripts soient directement pilotés depuis PostgreSQL.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Et bien vous pouvez mélanger les deux technologies grâce au PL/Python. « Sorcellerie » me direz-vous&amp;#8230;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;blockquote class=&#34;wp-block-quote is-layout-flow wp-block-quote-is-layout-flow&#34;&gt;&#xA;&lt;p&gt;Si, si, c&amp;rsquo;est possible !&lt;/p&gt;&#xA;&lt;cite&gt;Hassan Cehef &amp;#8211; Les Nuls&lt;/cite&gt;&lt;/blockquote&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Le PL/Python est un langage de PostgreSQL permettant d&amp;rsquo;écrire des fonctions en langage Python directement au sein d&amp;rsquo;une base de données.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Notez qu&amp;rsquo;il s&amp;rsquo;agit d&amp;rsquo;une langage dit « untrusted » (« sans confiance ») car il permet de faire tout et n&amp;rsquo;importe quoi (comme modifier des fichiers sur le serveur par exemple). C&amp;rsquo;est pour cela que seul un superutilisateur peut créer des fonctions avec ce langage.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 class=&#34;wp-block-heading&#34;&gt;Introduction&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Cet article présuppose que vous avez déjà utilisé Python et PostgreSQL et que vous possédez une version de Python sur votre machine en parallèle d&amp;rsquo;une installation de PostgreSQL.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Vous devez par ailleurs avoir des notions sur les variables d&amp;rsquo;environnement et le fonctionnement des services.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 class=&#34;wp-block-heading&#34;&gt;Installation du langage&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Sous Linux, il faut installer le package en lien avec l&amp;rsquo;extension : &lt;code&gt;postgresql-plpythonY-Z&lt;/code&gt; (avec &lt;code&gt;Y&lt;/code&gt; = 3 pour Python 3.X et &lt;code&gt;Z&lt;/code&gt; = version de PostgreSQL). Par exemple :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;bash&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;sudo apt install postgresql-plpython3-16&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Sous Windows, le PL/Python est préinstallé avec PostgreSQL.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Il suffit ensuite de lancer la requête suivante pour l&amp;rsquo;activer :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;CREATE EXTENSION plpython3u;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Vous pouvez maintenant utiliser le PL/Python pour vos fonctions et procédures. Voici un exemple :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;DO &#xA;$function$&#xA;&#xA;&#x9;import sys&#xA;&#x9;plpy.notice(sys.version)&#xA;&#xA;$function$&#xA;LANGUAGE plpython3u;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Ce bloc de code anonyme (oui, il n&amp;rsquo;est pas encapsulé dans une fonction ou un procédure) ne retourne rien mais un message contenant la version de Python utilisé est renvoyé dans la sortie console.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 class=&#34;wp-block-heading&#34;&gt;Fonctionnement&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Si l&amp;rsquo;étape précédente a fonctionné du premier coup, félicitation ! Sinon, cette partie devrait vous aider.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Version de Python&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Sous Windows, PostgreSQL est compatible avec une version spécifique de Python qui est définie lors de sa compilation. Cette information est disponible dans les notes d&amp;rsquo;installations présentes dans &lt;em&gt;C:\Emplacement\de\PostgreSQL\XX\doc\installation-notes.html&lt;/em&gt;.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voici un tableau résumant la compatibilité avec l&amp;rsquo;installeur PostgreSQL fournit par EDB.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure class=&#34;wp-block-table&#34;&gt;&lt;table class=&#34;has-fixed-layout&#34;&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;Version de PostgreSQL&lt;/th&gt;&lt;th&gt;Version de Python compatible&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;PostgreSQL 17&lt;/td&gt;&lt;td&gt;Python 3.13.x&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;PostgreSQL 16&lt;/td&gt;&lt;td&gt;Python 3.12.x&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;PostgreSQL 15&lt;/td&gt;&lt;td&gt;Python 3.11.x&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;PostgreSQL 14&lt;/td&gt;&lt;td&gt;Python 3.9.x&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;PostgreSQL 13&lt;/td&gt;&lt;td&gt;Python 3.8.x&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;PostgreSQL 12 et avant&lt;/td&gt;&lt;td&gt;Python 2.7&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Tableau issu du site : &lt;a href=&#34;https://postgresapp.com/documentation/plpython.html&#34; data-type=&#34;link&#34; data-id=&#34;https://postgresapp.com/documentation/plpython.html&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;postgresapp.com&lt;/a&gt;&lt;/figcaption&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Sous Linux, je n&amp;rsquo;ai pas explicitement trouvé l&amp;rsquo;information mais il semble que le tableau précédent soit valable (en tout cas d&amp;rsquo;après mes quelques tests c&amp;rsquo;est le cas).&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Si vous n&amp;rsquo;utilisez pas la bonne version de Python, PostgreSQL vous renverra un message d&amp;rsquo;erreur de ce type lors de l’exécution d&amp;rsquo;une procédure Python :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;raw&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;SQL Error [58P01]: ERREUR: n&#39;a pas pu charger la bibliothèque « C:/Program Files/PostgreSQL/16/lib/plpython3.dll » : The specified module could not be found.&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Choix de l&amp;rsquo;interpréteur&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;L&amp;rsquo;exécution du code Python se fait au travers d&amp;rsquo;un interpréteur. Pour cela, PostgreSQL utilise l&amp;rsquo;interpréteur disponible « par défaut » sur la machine et donc celui disponible à travers la variable d&amp;rsquo;environnement &lt;code&gt;PATH&lt;/code&gt;.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Définir un autre interpréteur n&amp;rsquo;est pas simple&amp;#8230;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Sur Linux, c&amp;rsquo;est l&amp;rsquo;installation d&amp;rsquo;une version de Python autre que celle fourni par défaut, qui est complexe ; il faut en général compiler l&amp;rsquo;interpréteur. En revanche il est relativement simple de redéfinir la variable &lt;code&gt;PATH&lt;/code&gt; directement dans la configuration du service (&lt;a href=&#34;https://serverfault.com/a/413408&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;décrit ici&lt;/a&gt;).&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Sous Windows, c&amp;rsquo;est l&amp;rsquo;inverse&amp;#8230; Différentes versions de Python peuvent être installées très facilement mais la redéfinition de la variable &lt;code&gt;PATH&lt;/code&gt; pour un service spécifique est relativement complexe (mais &lt;a href=&#34;https://serverfault.com/a/1103091&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;décrite ici&lt;/a&gt;).&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;En lien avec le sujet, voici &lt;a href=&#34;https://stackoverflow.com/questions/67852675/postgresql-13-python-3-7-9-plpython3u-psql-server-closed-the-connection-u&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;un thread stackoverflow&lt;/a&gt;.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Installation de modules et environnements&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Vous aurez très probablement besoin d&amp;rsquo;installer des modules. Il est peu recommandé de le faire directement dans l&amp;rsquo;environnement Python de base et il vaut mieux utiliser des environnements spécifiques à chaque projet.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Il en est de même pour PostgreSQL, vous pouvez créer et utiliser des environnements pour vos projets.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Pour cela il faut utiliser le module &lt;code&gt;virtualenv&lt;/code&gt; car l&amp;rsquo;activation d&amp;rsquo;un environnement peut être fait directement depuis Python avec cet outil :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;bash&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;pip install virtualenv&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Vous devez ensuite créer votre environnement dans un dossier spécifique. Vous pouvez créer un répertoire spécifique dans l&amp;rsquo;installation de PostgreSQL par exemple :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;python&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;virtualenv &#34;C:\Program Files\PostgreSQL\16\envs_python\mon_environnement&#34;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Vous pouvez ensuite accéder à cet environnement et y installer tous les modules souhaités :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;raw&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;&#34;C:\Program Files\PostgreSQL\16\envs_python\mon_environnement\Scripts\activate.bat&#34;&#xA;pip install geopandas&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Comme ce n&amp;rsquo;est pas vous mais le service qui contrôle le démarrage de PostgreSQL, il ne vous ai pas possible de démarrer l&amp;rsquo;environnement avant PostgreSQL (encore que en modifiant le service mais ce n&amp;rsquo;est pas des plus simple). Nous allons donc créer une fonction en PL/Python permettant de démarrer l&amp;rsquo;environnement :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;CREATE OR REPLACE PROCEDURE py_activate_venv(venv text)&#xA;RETURNS boolean AS&#xA;$BODY$&#xA;&#x9;import os&#xA;&#x9;import sys&#xA;&#xA;&#x9;if sys.platform in (&#39;win32&#39;, &#39;win64&#39;, &#39;cygwin&#39;):&#xA;&#x9;&#x9;activate_this = os.path.join(venv, &#39;Scripts&#39;, &#39;activate_this.py&#39;)&#xA;&#x9;else:&#xA;&#x9;&#x9;activate_this = os.path.join(venv, &#39;bin&#39;, &#39;activate_this.py&#39;)&#xA;&#xA;&#x9;try:&#xA;&#x9;&#x9;exec(open(activate_this).read(), dict(__file__=activate_this))&#xA;&#x9;except FileNotFoundError:&#xA;&#x9;&#x9;plpy.error(&#39;Virtual environment {} does not exist.&#39;.format(name))&#xA;&#x9;&#xA;&#x9;return True&#xA;$BODY$&#xA;LANGUAGE plpython3u&#xA;;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Pour activer l&amp;rsquo;environnement, il suffit de lancer la requête suivante :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;SELECT py_activate_venv(&#39;C:\Program Files\PostgreSQL\16\envs_python\mon_environnement&#39;);&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Pour aller plus loin, vous pouvez utiliser ce superbe projet GitHub qui automatise toute la gestion des environnements sous Python :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-buttons is-content-justification-center is-layout-flex wp-container-core-buttons-is-layout-16018d1d wp-block-buttons-is-layout-flex&#34;&gt;&#xA;&lt;div class=&#34;wp-block-button&#34;&gt;&lt;a class=&#34;wp-block-button__link wp-element-button&#34; href=&#34;https://github.com/dpage/plpy_venv&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;GitHub &amp;#8211; plpy_venv&lt;/a&gt;&lt;/div&gt;&#xA;&lt;/div&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 class=&#34;wp-block-heading&#34;&gt;Module plpy&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Le langage PL/Python apporte un module python automatiquement chargé : &lt;code&gt;plpy&lt;/code&gt; qui apporte quelques fonctions utiles.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Fonctions&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Pour retourner des message, utilisez les fonctions suivantes :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;&lt;code&gt;plpy.debug(msg, **kwargs)&lt;/code&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;plpy.log(msg, **kwargs)&lt;/code&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;plpy.info(msg, **kwargs)&lt;/code&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;plpy.notice(msg, **kwargs)&lt;/code&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;plpy.warning(msg, **kwargs)&lt;/code&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;plpy.error(msg, **kwargs)&lt;/code&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;plpy.fatal(msg, **kwargs)&lt;/code&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Les arguments suivants peuvent être utilisés pour ajouter des informations de contexte au message renvoyé :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;&lt;code&gt;detail&lt;/code&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;hint&lt;/code&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;sqlstate&lt;/code&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;schema_name&lt;/code&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;table_name&lt;/code&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;column_name&lt;/code&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;datatype_name&lt;/code&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;constraint_name&lt;/code&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Pour exécuter une requête SQL au sein de la base de données, utilisez &lt;code&gt;plpy.execute(&#34;query&#34; [, limit])&lt;/code&gt; avec :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;&lt;code&gt;query&lt;/code&gt; : la requête.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;limit&lt;/code&gt; : un entier permettant de limiter le nombre de résultat.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;L&amp;rsquo;objet résultant est une liste (les lignes) de dictionnaires (ensemble de colonnes). Par exemple pour renvoyer une colonne de la 4ème ligne :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;python&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;result = plpy.execute(&#34;SELECT * FROM ma_table&#34;, 25)&#xA;return result[4][&#34;ma_colonne&#34;]&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Il existe trois fonctions équivalentes à leurs homonyme au sein de PostgreSQL : &lt;code&gt;plpy.quote_literal(&lt;em&gt;string&lt;/em&gt;)&lt;/code&gt;, &lt;code&gt;plpy.quote_nullable(&lt;em&gt;string&lt;/em&gt;)&lt;/code&gt; et &lt;code&gt;plpy.quote_ident(&lt;em&gt;string&lt;/em&gt;)&lt;/code&gt;.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Gestion des erreurs&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Les fonctions &lt;code&gt;plpy.execute&lt;/code&gt; et &lt;code&gt;plpy.cursor&lt;/code&gt; (non décrite dans cet article), renvoient une exception dans le cas où la requête SQL passée en argument échoue. L&amp;rsquo;exception est une instance de la classe &lt;code&gt;plpy.SPIError&lt;/code&gt; qui peut être récupérée via la construction &lt;code&gt;try&lt;/code&gt;/&lt;code&gt;except&lt;/code&gt;. Voici un exemple :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;CREATE FUNCTION test_plpython() &#xA;RETURNS text AS &#xA;$BODY$&#xA;&#xA;    try:&#xA;        plpy.execute(&#34;UPDATE ma_table SET &#34;ma_colonne&#34; = 12&#34;)&#xA;&#xA;    except plpy.SPIError:&#xA;        return &#34;La mise à jour a échouée&#34;&#xA;&#xA;    else:&#xA;        return &#34;La mise à jour a fonctionnée&#34;&#xA;&#xA;$BODY$&#xA;LANGUAGE plpython3u;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Il est possible de cibler une erreur spécifique retournée par PostgreSQL. Pour cela, vous pouvez vérifier la valeur de l&amp;rsquo;attribut &lt;code&gt;sqlstate&lt;/code&gt; de la classe &lt;code&gt;SPIError&lt;/code&gt; ou utiliser le module &lt;code&gt;plpy.spiexceptions&lt;/code&gt; qui définit une classe d&amp;rsquo;exception pour chaque condition PostgreSQL.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Pour spécifier une erreur avec &lt;code&gt;spiexception&lt;/code&gt;, il suffit de se référer à &lt;a href=&#34;https://www.postgresql.org/docs/current/errcodes-appendix.html&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;la liste des erreurs de PostgreSQL&lt;/a&gt; et de convertir le nom de l&amp;rsquo;erreur comme suivant : retirer les soulignés (« _ ») + mettre en majuscule la première lettre de chaque mot. Ainsi :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;&lt;code&gt;privilege_not_granted&lt;/code&gt; devient &lt;code&gt;PrivilegeNotGranted&lt;/code&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;data_exception&lt;/code&gt; devient &lt;code&gt;DataException&lt;/code&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;division_by_zero&lt;/code&gt; devient &lt;code&gt;DivisionByZero&lt;/code&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Pour attraper une erreur spécifique il suffit d&amp;rsquo;utiliser la syntaxe suivante :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;CREATE FUNCTION test_plpython() &#xA;RETURNS text AS &#xA;$BODY$&#xA;&#xA;    try:&#xA;        plpy.execute(&#34;UPDATE ma_table SET &#34;ma_colonne&#34; = 12&#34;)&#xA;&#xA;    except plpy.spiexceptions.UniqueViolation:&#xA;        return &#34;La mise à jour a échouée en raison d&#39;une erreur d&#39;unicité&#34;&#xA;&#xA;    except plpy.SPIError as e:&#xA;        return &#34;Une erreur s&#39;est produite : SQLSTATE %s&#34; % e.sqlstate&#xA;&#xA;    else:&#xA;        return &#34;La mise à jour a fonctionnée&#34;&#xA;&#xA;$BODY$&#xA;LANGUAGE plpython3u;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Gestion des transactions&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;L’exécution d&amp;rsquo;une fonction en PL/Python se fait toujours au sein d&amp;rsquo;une transaction. Ainsi, lorsqu&amp;rsquo;une requête est exécutée via &lt;code&gt;plpy.execute&lt;/code&gt;, une sous-transaction est automatiquement démarrée. Il devient alors possible de contrôler l&amp;rsquo;issue de cette sous-transaction via les fonctions suivantes :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;&lt;code&gt;plpy.commit()&lt;/code&gt; : valider la sous-transaction&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;plpy.rollback()&lt;/code&gt; : annuler la sous-transaction&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Après la fin d&amp;rsquo;une sous-transaction, une nouvelle sous-transaction est automatiquement démarrée.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Dans le cas où plusieurs requêtes doivent être exécutées et que l&amp;rsquo;intégralité de ces requêtes doivent être validées ou non, il est possible de démarrer une sous-transaction grâce à  &lt;code&gt;plpy.subtransaction()&lt;/code&gt;. Pour cela, il faudra l&amp;rsquo;utiliser de la façon suivante :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;python&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;with plpy.subtransaction():&#xA;  plpy.execute(&#34;DELETE FROM ma_table WHERE colonne = &#39;xxx&#39;&#34;)&#xA;  plpy.execute(&#34;INSERT INTO autre_table (col_1, col_2) VALUES (&#39;valeur1&#39;, &#39;valeur2&#39;)&#34;)&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Notez qu&amp;rsquo;une erreur lors de l&amp;rsquo;une des requête entraine donc l&amp;rsquo;annulation de l&amp;rsquo;ensemble des requêtes de la sous-transaction mais engendre également une exception qui stoppera l’exécution de la fonction et annulera la transaction en cours. Pour limiter la propagation de l&amp;rsquo;exception, il est possible d&amp;rsquo;encapsuler le tout au sein d&amp;rsquo;un &lt;code&gt;try&lt;/code&gt;/&lt;code&gt;catch&lt;/code&gt; :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;python&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;try:&#xA;  with plpy.subtransaction():&#xA;    plpy.execute(&#34;DELETE FROM ma_table WHERE colonne = &#39;xxx&#39;&#34;)&#xA;    plpy.execute(&#34;INSERT INTO autre_table (col_1, col_2) VALUES (&#39;valeur1&#39;, &#39;valeur2&#39;)&#34;)&#xA;except plpy.SPIError as e:&#xA;  result = &#34;Erreur de requête : %s&#34; % e.args&#xA;else:&#xA;  result = &#34;Opération effectuée&#34;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 class=&#34;wp-block-heading&#34;&gt;Pour allez plus loin&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Lq &lt;a href=&#34;https://www.postgresql.org/docs/current/plpython.html&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;documentation de PostgreSQL sur le langage PL/Python&lt;/a&gt; vous permettra d&amp;rsquo;approfondir le sujet maintenant que vous avez les éléments clés en main.&lt;/p&gt;&#xA;</content>
    <link href="https://blog.arthurbazin.com/programmation/postgresql-python-ca-fait-pl-python" rel="alternate"></link>
    <summary type="html">Imaginez, vous utilisez PostgreSQL au quotidien pour stocker et traiter vos données. Comme vous êtes curieux, vous avez essayé Python pour faire quelques traitements et vous vous êtes rendus compte que c&amp;#8217;était pas mal quand même&amp;#8230; Malheureusement vos scripts sont complètement dissociés de la base de données et vous vous dites qu&amp;#8217;il serait pratique que [&amp;#8230;]</summary>
    <author>
      <name>Arthur Bazin</name>
    </author>
  </entry>
  <entry>
    <title>Soyons précis avec PostGIS</title>
    <updated>2025-02-09T20:26:53Z</updated>
    <id>tag:blog.arthurbazin.com,2025-02-09:/bdd/postgresql/soyons-precis-avec-postgis</id>
    <content type="html">&#xA;&lt;p&gt;Vous êtes vous déjà demandé quelle était la précision de PostGIS ? Moi oui&amp;#8230; Alors étudions cela ensemble.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;La documentation de PostGIS n&amp;rsquo;est pas très claire sur la question de la précision mais il faut savoir que toutes les coordonnées sont stockées sous forme d&amp;rsquo;entiers à virgule flottante en double précision. La précision de PostGIS est donc liée à ce format de stockage des numériques.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 class=&#34;wp-block-heading&#34;&gt;Virgule flottante et double précision&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Ce paragraphe est une simplification de la norme IEEE 754 pour vous aidez à comprendre le fonctionnement des nombres à virgules flottantes en double precision. Des imprécisions sont donc volontairement présentes.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;La &lt;strong&gt;virgule flottante&lt;/strong&gt; est une méthode de représentation d&amp;rsquo;un nombre en informatique qui s&amp;rsquo;apparente à la notation scientifique (par exemple &lt;code&gt;1,234 * 10&lt;sup&gt;123&lt;/sup&gt;&lt;/code&gt;). Elle repose ainsi sur les éléments suivants :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;un signe : + ou -.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Une mantisse : une valeur binaire qui définie une fraction entre 0 et 1.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Une base : un nombre entier (par exemple 2 ou 10).&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Un exposant : un nombre entier.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;On obtient la valeur finale grâce à l&amp;rsquo;opération suivante : &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;&lt;code&gt;x&lt;/code&gt; = &lt;code&gt;signe * 1,mantisse * base&lt;sup&gt;exposant&lt;/sup&gt;&lt;/code&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Quand on parle de &lt;strong&gt;double précision&lt;/strong&gt;, on fait alors référence à un format particulier de nombre à virgule flottante :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;L&amp;rsquo;encodage se fait sur 64 bits :&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;1 bit pour le signe (&lt;code&gt;0&lt;/code&gt; = &lt;code&gt;+&lt;/code&gt; et &lt;code&gt;1&lt;/code&gt; = &lt;code&gt;-&lt;/code&gt;)&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;11 bits pour l&amp;rsquo;exposant&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;53 bits pour la mantisse dont :&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;1 bit pour le décalage (voir le paragraphe sur la dénormalisation)&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;52 bits pour la valeur&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;La base est 2 car le stockage se fait sous forme binaire.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;L&amp;rsquo;exposant est décalé, par convention on ajoute 1023 a sa valeur réelle.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;Le calcul d&amp;rsquo;un nombre en double précision est alors le suivant :&lt;br&gt;&lt;code&gt;x&lt;/code&gt; = &lt;code&gt;-1&lt;sup&gt;signe&lt;/sup&gt; * (1 + mantisse) * 2&lt;sup&gt;exposant-1023&lt;/sup&gt;&lt;/code&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Dans le cas d&amp;rsquo;un nombre dénormalisé (voir le paragraphe dédié), le calcul est le suivant :&lt;br&gt;&lt;code&gt;x&lt;/code&gt; = &lt;code&gt;-1&lt;sup&gt;signe&lt;/sup&gt; * (0 + mantisse) * 2&lt;sup&gt;1-1023&lt;/sup&gt;&lt;/code&gt; = &lt;code&gt;-1&lt;sup&gt;signe&lt;/sup&gt; * 0,mantisse * 2&lt;sup&gt;-1022&lt;/sup&gt;&lt;/code&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Exposant&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;L&amp;rsquo;exposant est codé sur 11 bits ce qui permet les valeurs suivantes :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;&lt;code&gt;0&lt;/code&gt; : &lt;code&gt;00000000000&lt;/code&gt; : valeur minimum&lt;br&gt;Valeur spécifique réservée pour représenter le 0 ou un nombre dénormalisé (voir plus bas).&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;1&lt;/code&gt; : &lt;code&gt;00000000001&lt;/code&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;2046&lt;/code&gt; : &lt;code&gt;11111111110&lt;/code&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;2047&lt;/code&gt; : &lt;code&gt;11111111111&lt;/code&gt; : valeur maximum&lt;br&gt;Valeur spécifique réservée pour représenté les valeurs &lt;code&gt;infini&lt;/code&gt; ou &lt;code&gt;NaN&lt;/code&gt; (Not A Number : pas un nombre)&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Cette valeur d&amp;rsquo;exposant est non signée. Afin de permettre le stockage d&amp;rsquo;exposants négatifs, un décalage est introduit. Dans le cas du double précision, ce décalage est de &lt;code&gt;1023&lt;/code&gt;.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Ainsi, avec un exposant décalé de 1023, la plage d&amp;rsquo;exposants utilisables est la suivante :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;De &lt;code&gt;0 - 1023&lt;/code&gt; = &lt;code&gt;-1022&lt;/code&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;À &lt;code&gt;2046 - 1023&lt;/code&gt; = &lt;code&gt;1023&lt;/code&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Mantisse&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;La mantisse est codée sur 52 bits et représente une fraction comprise entre 0 et 1 sous la forme d&amp;rsquo;un nombre binaire. La mantisse peut ainsi avoir 2&lt;sup&gt;52&lt;/sup&gt; (4 503 599 627 370 496 = 4,503599627370496 × 10&lt;sup&gt;15&lt;/sup&gt;) valeurs différentes.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Le calcul de la valeur décimale de la mantisse à partir de la valeur binaire se fait comme suivant :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Valeur binaire : &lt;code&gt;10100...00101&lt;/code&gt; (la partie tronquée n&amp;rsquo;est composée que de zéros).&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;La valeur décimale est égale à la somme des puissances de deux multipliées par la valeur du bit correspondant :&lt;br&gt;&lt;code&gt;(&lt;strong&gt;1&lt;/strong&gt;*2&lt;sup&gt;-1&lt;/sup&gt;) + (&lt;strong&gt;0&lt;/strong&gt;*2&lt;sup&gt;-2&lt;/sup&gt;) + (&lt;strong&gt;1&lt;/strong&gt;*2&lt;sup&gt;-3&lt;/sup&gt;) + (&lt;strong&gt;0&lt;/strong&gt;*2&lt;sup&gt;-4&lt;/sup&gt;) + (&lt;strong&gt;0&lt;/strong&gt;*2&lt;sup&gt;-5&lt;/sup&gt;) + ... + (&lt;strong&gt;0&lt;/strong&gt;*2&lt;sup&gt;-48&lt;/sup&gt;) + (&lt;strong&gt;0&lt;/strong&gt;*2&lt;sup&gt;-49&lt;/sup&gt;) + (&lt;strong&gt;1&lt;/strong&gt;*2&lt;sup&gt;-50&lt;/sup&gt;) + (&lt;strong&gt;0&lt;/strong&gt;*2&lt;sup&gt;-51&lt;/sup&gt;) + (&lt;strong&gt;1&lt;/strong&gt;*2&lt;sup&gt;-52&lt;/sup&gt;)&lt;/code&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Le résultat pour notre exemple est ainsi &lt;code&gt;0,6250000000000011102230246251565404236316680908203125&lt;/code&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Combinaison exposant + mantisse&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Une explication plus simple du fonctionnement de l&amp;rsquo;exposant combinée à la mantisse est de parler de fenêtres et de paliers. Imaginez que l&amp;rsquo;amplitude maximum permise par le type double précision soit découpée en fenêtres elles mêmes sous découpées en paliers avec :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;&lt;code&gt;2045&lt;/code&gt; fenêtres : 2047 exposants disponibles moins les exposants 0 et 2047 qui sont réservés.&lt;br&gt;Une fenêtre est donc bornée entre deux puissances de 2 : &#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;La première fenêtre (exposant 1) débute à 2&lt;sup&gt;-1022&lt;/sup&gt; (2&lt;sup&gt;1-1023&lt;/sup&gt;) et s&amp;rsquo;étend jusqu’à 2&lt;sup&gt;-1021&lt;/sup&gt;.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;La dernière fenêtre (exposant 2046) débute à 2&lt;sup&gt;1023&lt;/sup&gt; (2&lt;sup&gt;2046-1023&lt;/sup&gt;) et s&amp;rsquo;étend jusqu&amp;rsquo;à 2&lt;sup&gt;1024&lt;/sup&gt;.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;2&lt;sup&gt;52&lt;/sup&gt;&lt;/code&gt; paliers (&lt;code&gt;4 503 599 627 370 496&lt;/code&gt;) par fenêtre : le nombre de valeurs de mantisse disponibles.&lt;br&gt;Pour chaque fenêtre, un nombre de valeurs limité est ainsi disponible, la valeur d&amp;rsquo;incrémentation du palier (et donc la précision) dépend de la fenêtre à laquelle il se rattache.&lt;br&gt;Le calcul de la précision est le suivant : &lt;code&gt;(Taille de la fenêtre)/(nombre de valeurs de la mantisse)&lt;/code&gt;&lt;br&gt;Par exemple &lt;code&gt;(2&lt;sup&gt;-1021&lt;/sup&gt; - 2&lt;sup&gt;-1022&lt;/sup&gt;) / 2&lt;sup&gt;52&lt;/sup&gt;&lt;/code&gt; pour la première fenêtre.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Calcul de la mantisse et de l&amp;rsquo;exposant depuis une valeur réelle&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Il est possible de calculer la mantisse et l&amp;rsquo;exposant d&amp;rsquo;une valeur réelle en suivant les étapes suivantes. la valeur d&amp;rsquo;exemple sera 1234,56789.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;&lt;strong&gt;Étape 1 &amp;#8211; Convertir le nombre en binaire :&lt;/strong&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;&lt;strong&gt;1.&lt;/strong&gt; Diviser la partie entière par 2 puis noter le reste (0 ou 1), répéter l&amp;rsquo;opération jusqu’à ce que l&amp;rsquo;opération soit égale à 0.&lt;br&gt;Le reste est noté en commençant par la droite.&lt;br&gt;Dans notre exemple, divisons successivement 1234 par 2 en récupérant le reste :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ol class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;1234 ÷ 2 = 617 reste&amp;nbsp;0&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;617 ÷ 2 = 308 reste&amp;nbsp;1&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;308 ÷ 2 = 154 reste&amp;nbsp;0&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;154 ÷ 2 = 77 reste&amp;nbsp;0&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;77 ÷ 2 = 38 reste&amp;nbsp;1&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;38 ÷ 2 = 19 reste&amp;nbsp;0&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;19 ÷ 2 = 9 reste&amp;nbsp;1&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;9 ÷ 2 = 4 reste&amp;nbsp;1&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;4 ÷ 2 = 2 reste&amp;nbsp;0&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;2 ÷ 2 = 1 reste&amp;nbsp;0&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;1 ÷ 2 = 0 reste&amp;nbsp;1&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Donc, &lt;code&gt;1234&lt;sub&gt;10&lt;/sub&gt; ​= 10011010010&lt;sub&gt;2&lt;/sub&gt;​&lt;/code&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;&lt;strong&gt;2.&lt;/strong&gt; Multiplier la partie décimale par 2 puis noter la partie entière (0 ou 1), répéter l&amp;rsquo;opération un grand nombre de fois (voir l&amp;rsquo;étape 2 pour déterminer ce nombre).&lt;br&gt;La partie entière est notée en commençant par la gauche.&lt;br&gt;Dans notre exemple, multiplions successivement 0,56789 par 2, en prenant la partie entière de chaque produit :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ol class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt; 0,56789 × 2 = 1,13578 (partie&amp;nbsp;entière&amp;nbsp;1)&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;0,13578 × 2 = 0,27156 (partie&amp;nbsp;entière&amp;nbsp;0)&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;0,27156 × 2 = 0,54312 (partie&amp;nbsp;entière&amp;nbsp;0)&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;0,54312 × 2 = 1,08624 (partie&amp;nbsp;entière&amp;nbsp;1)&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;0,08624 × 2 = 0,17248 (partie&amp;nbsp;entière&amp;nbsp;0)&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;0,17248 × 2 = 0,34496 (partie&amp;nbsp;entière&amp;nbsp;0)&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;0,34496 × 2 = 0,68992 (partie&amp;nbsp;entière&amp;nbsp;0)&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;0,68992 × 2 = 1,37984 (partie&amp;nbsp;entière&amp;nbsp;1)&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&amp;#8230; on répète l&amp;rsquo;opération un nombre important de fois&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;En continuant, &lt;code&gt;0,56789&lt;sub&gt;10&lt;/sub&gt;​ = 100100010110000100111101001100011011100111...&lt;sub&gt;2&lt;/sub&gt;&lt;/code&gt; (il s&amp;rsquo;agit d&amp;rsquo;une approximation)&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;La valeur totale approximée est ainsi : &lt;code&gt;10011010010,100100010110000100111101001100011011100111&lt;sub&gt;2&lt;/sub&gt;&lt;/code&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;&lt;strong&gt;Étape 2 &amp;#8211; Normaliser le nombre&lt;/strong&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Normaliser le nombre sous la forme &lt;code&gt;1,xyz x 2&lt;sup&gt;abc&lt;/sup&gt;&lt;/code&gt;&lt;br&gt;Si le nombre débute par &lt;code&gt;0,x&lt;/code&gt;, il faudra alors utiliser une puissance négative.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;La valeur normalisée doit avoir 52 décimales car la mantisse possède 52 bits. Il vous faudra ajuster le nombre de calculs nécessaires à l&amp;rsquo;étape 2. S&amp;rsquo;il ne vous est pas possible d&amp;rsquo;effectuer autant de calculs, complétez la mantisse par la valeur 0 (des bits nuls).&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Pour notre exemple :&lt;br&gt;&lt;code&gt;10011010010,100100010110000100111101001100011011100111&lt;sub&gt;2&lt;/sub&gt;&lt;/code&gt; = &lt;code&gt;1,0011010010100100010110000100111101001100011011100111 x 2&lt;sup&gt;10&lt;/sup&gt;&lt;/code&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Dans le cas du nombre &lt;code&gt;0,0003&lt;/code&gt;, la valeur binaire est &lt;code&gt;0,000000000000001010001101101110001011101011000111000100001100101101&lt;/code&gt;. &lt;br&gt;La valeur normalisée est donc &lt;code&gt;1,010001101101110001011101011000111000100001100101101 x 2&lt;sup&gt;-14&lt;/sup&gt;&lt;/code&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Si votre valeur normalisée n&amp;rsquo;a pas 52 décimales, complétez avec des 0 : &lt;code&gt;1,010011&lt;em&gt;0000000000000000000000000000000000000000000000&lt;/em&gt; x 2&lt;sup&gt;y&lt;/sup&gt;&lt;/code&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;&lt;strong&gt;Étape 3 &amp;#8211; Extraire les informations&lt;/strong&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Les informations sont disponibles presque immédiatement :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;L&amp;rsquo;exposant vous est donné par l&amp;rsquo;exposant de la valeur normalisée. &lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;La mantisse est constituée de l&amp;rsquo;ensemble des valeurs suivant le « 1. ».&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Dans notre exemple : &lt;code&gt;1,0011010010100100010110000100111101001100011011100111 x 2&lt;sup&gt;10&lt;/sup&gt;&lt;/code&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;L&amp;rsquo;exposant est &lt;code&gt;10&lt;/code&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;L&amp;rsquo;exposant décalé est &lt;code&gt;1033&lt;/code&gt; (&lt;code&gt;10 + 1023&lt;/code&gt;).&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;La fenêtre d&amp;rsquo;exposant est &lt;code&gt;2&lt;sup&gt;10&lt;/sup&gt;&lt;/code&gt; à &lt;code&gt;2&lt;sup&gt;11&lt;/sup&gt;&lt;/code&gt;.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;La valeur d&amp;rsquo;incrémentation et donc la précision est &lt;code&gt;(2&lt;sup&gt;11&lt;/sup&gt; - 2&lt;sup&gt;10&lt;/sup&gt;) / 2&lt;sup&gt;52&lt;/sup&gt;&lt;/code&gt; = &lt;code&gt;2,27373675443232059478759765625 × 10&lt;sup&gt;-13&lt;/sup&gt;&lt;/code&gt;.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;La mantisse est : &lt;code&gt;0011010010100100010110000100111101001100011011100111&lt;/code&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;La valeur approchée stockée est &lt;code&gt;1234,567890000000033978722058236598968505859375&lt;/code&gt; (calcul fait sur &lt;a href=&#34;https://www.wolframalpha.com/input?i=1.0011010010100100010110000100111101001100011011100111+base+2+x+2%5E10&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;Wolfram Alpha&lt;/a&gt;).&lt;br&gt;La valeur n&amp;rsquo;est précise qu&amp;rsquo;a &lt;code&gt;2,27 x 10&lt;sup&gt;-13&lt;/sup&gt;&lt;/code&gt; donc peut être arrondie à &lt;code&gt;1234,5678900000000&lt;/code&gt; soit &lt;code&gt;1234,56789&lt;/code&gt;.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Valeurs spécifiques&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;La combinaison de valeurs spécifiques de la mantisse et de l&amp;rsquo;exposant permet de représenter certaines valeurs :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;&lt;code&gt;Exposant = 0&lt;/code&gt; &amp;amp; &lt;code&gt;mantisse = 0&lt;/code&gt; : la valeur est &lt;code&gt;0&lt;/code&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;Exposant = 0&lt;/code&gt; &amp;amp; &lt;code&gt;mantisse != 0&lt;/code&gt; : la valeur est dénormalisé&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;Exposant = 2047&lt;/code&gt; &amp;amp; &lt;code&gt;mantisse = 0&lt;/code&gt; : la valeur est &lt;code&gt;infini&lt;/code&gt;.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;Exposant = 2047&lt;/code&gt; &amp;amp; &lt;code&gt;mantisse != 0&lt;/code&gt; : &lt;code&gt;NaN&lt;/code&gt;, la valeur n&amp;rsquo;est pas un nombre&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Dénormalisation&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;La dénormalisation permet de stocker des nombres plus petits que &lt;code&gt;2&lt;sup&gt;-1022&lt;/sup&gt;&lt;/code&gt; (exposant le plus petit disponible). Pour cela, la méthode permettant de calculer la valeur finale change comme exposé plus haut :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;Un nombre normalisé se calcule de la façon suivante :&lt;br&gt;&lt;code&gt;x&lt;/code&gt; = &lt;code&gt;-1&lt;sup&gt;signe&lt;/sup&gt; * (1 + mantisse) * 2&lt;sup&gt;exposant-1023&lt;/sup&gt;&lt;/code&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Alors qu&amp;rsquo;un nombre dénormalisé se calcule comme suivant : &lt;br&gt;&lt;code&gt;x&lt;/code&gt; = &lt;code&gt;-1&lt;sup&gt;signe&lt;/sup&gt; * (0 + mantisse) * 2&lt;sup&gt;1-1023&lt;/sup&gt;&lt;/code&gt; = &lt;code&gt;-1&lt;sup&gt;signe&lt;/sup&gt; * 0,mantisse * 2&lt;sup&gt;-1022&lt;/sup&gt;&lt;/code&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Sans entrer dans les détails, le principe est de dire que dans ce mode de calcul, la valeur la plus haute de la mantisse (&lt;code&gt;2&lt;sup&gt;52&lt;/sup&gt;&lt;/code&gt;) est alors égale à la valeur immédiatement avant la plus petite valeur en mode normalisé. Il devient ainsi possible d&amp;rsquo;augmenter l&amp;rsquo;amplitude.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;D&amp;rsquo;un point de vue technique, le bit de décalage de la mantisse est alors défini à 0 et les programmes traitent la valeur de la mantisse comme dénormalisée.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Amplitude de valeurs&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;La combinaison de la mantisse et de l&amp;rsquo;exposant permet ainsi de calculer un ensemble de nombres avec une certaine précision. Cependant il n&amp;rsquo;est pas possible de représenter la totalité des nombres réels.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Une explication plus simple du fonctionnement est de parler de fenêtres et de paliers. La plage de valeurs utilisables est découpée en fenêtres elles mêmes sous découpées en paliers avec :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;&lt;code&gt;2045&lt;/code&gt; fenêtres : 2047 exposants disponibles moins les exposants 0 et 2047 réservés.&lt;br&gt;Une fenêtre est donc bornée entre deux puissances de 2 :&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;La première fenêtre (exposant 1) débute à 2&lt;sup&gt;-1022&lt;/sup&gt; (2&lt;sup&gt;1-1023&lt;/sup&gt;) et s&amp;rsquo;étend jusqu’à 2&lt;sup&gt;-1021&lt;/sup&gt;.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;La dernière fenêtre (exposant 2046) débute à 2&lt;sup&gt;1023&lt;/sup&gt; (2&lt;sup&gt;2046-1023&lt;/sup&gt;) et s&amp;rsquo;étend jusqu&amp;rsquo;à 2&lt;sup&gt;1024&lt;/sup&gt;.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;2&lt;sup&gt;52&lt;/sup&gt;&lt;/code&gt; paliers (&lt;code&gt;4 503 599 627 370 496&lt;/code&gt;) par fenêtre : le nombre de valeurs de mantisses disponibles.&lt;br&gt;Pour chaque fenêtre, un nombre de valeurs limité est ainsi disponible, la valeur d&amp;rsquo;incrémentation du palier (et donc la précision) dépend de la fenêtre auquel le palier se rattache.&lt;br&gt;Le calcul de la précision est le suivant : &lt;code&gt;(Taille de la fenêtre)/(nombre de valeurs de la mantisse)&lt;/code&gt;&lt;br&gt;Par exemple &lt;code&gt;(2&lt;sup&gt;-1021&lt;/sup&gt; - 2&lt;sup&gt;-1022&lt;/sup&gt;) / 2&lt;sup&gt;52&lt;/sup&gt;&lt;/code&gt; pour la première fenêtre.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Partant de ce constat, voici un tableau de plusieurs valeurs intéressantes :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure class=&#34;wp-block-table&#34;&gt;&lt;table class=&#34;has-fixed-layout&#34;&gt;&lt;thead&gt;&lt;tr&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Exposant&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Fenêtre d&amp;rsquo;exposant&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Valeur d&amp;rsquo;incrémentation d&amp;rsquo;un palier&lt;br&gt;= &lt;strong&gt;Précision&lt;/strong&gt;&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Mantisse&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Valeur approchée&lt;/th&gt;&lt;th&gt;Commentaire&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;de 2&lt;sup&gt;-1022&lt;/sup&gt; à 2&lt;sup&gt;-1021&lt;/sup&gt; : &lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4,940656458 x 10&lt;sup&gt;−324&lt;/sup&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2,2250738585072013 x 10&lt;sup&gt;-308&lt;/sup&gt;&lt;/td&gt;&lt;td&gt;Plus petit nombre normalisé&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;de 2&lt;sup&gt;-1022&lt;/sup&gt; à 2&lt;sup&gt;-1021&lt;/sup&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4,940656458 x 10&lt;sup&gt;−324&lt;/sup&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2,2250738585072018 x 10&lt;sup&gt;−308&lt;/sup&gt;&lt;/td&gt;&lt;td&gt;Nombre immédiatement après le précédent&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1023&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;de 2&lt;sup&gt;0&lt;/sup&gt; à 2&lt;sup&gt;1&lt;/sup&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2,2204460492 × 10&lt;sup&gt;−16&lt;/sup&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1,0&lt;/td&gt;&lt;td&gt;Valeur 1&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1023&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;de 2&lt;sup&gt;0&lt;/sup&gt; à 2&lt;sup&gt;1&lt;/sup&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2,2204460492 × 10&lt;sup&gt;−16&lt;/sup&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1,0000000000000002220446&lt;/td&gt;&lt;td&gt;Nombre immédiatement après le précédent&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1023&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;de 2&lt;sup&gt;0&lt;/sup&gt; à 2&lt;sup&gt;1&lt;/sup&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2,2204460492 × 10&lt;sup&gt;−16&lt;/sup&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;450 359 962 737 050&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1,10000000000000008881784197001&lt;/td&gt;&lt;td&gt;Plus proche palier de 1.1&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1074&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;de 2&lt;sup&gt;51&lt;/sup&gt; à 2&lt;sup&gt;52&lt;/sup&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0,5&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1075&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;de 2&lt;sup&gt;52&lt;/sup&gt; à 2&lt;sup&gt;53&lt;/sup&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4 503 599 627 370 496&lt;/td&gt;&lt;td&gt;Le nombre suivant sera l&amp;rsquo;entier suivant&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1076&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;de 2&lt;sup&gt;53&lt;/sup&gt; à 2&lt;sup&gt;54&lt;/sup&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2046&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;de 2&lt;sup&gt;1023&lt;/sup&gt; à 2&lt;sup&gt;1024&lt;/sup&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1,99584030953 × 10&lt;sup&gt;292&lt;/sup&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1,79769313486231550856 x 10&lt;sup&gt;308&lt;/sup&gt;&lt;/td&gt;&lt;td&gt;Nombre immédiatement avant le plus grand nombre normalisé&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2046&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;de 2&lt;sup&gt;1023&lt;/sup&gt; à 2&lt;sup&gt;1024&lt;/sup&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1,99584030953 × 10&lt;sup&gt;292&lt;/sup&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;(1 + (1 − 2&lt;sup&gt;−52&lt;/sup&gt;))&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1,79769313486231570814 x 10&lt;sup&gt;308&lt;/sup&gt;&lt;/td&gt;&lt;td&gt;Plus grand nombre normalisé&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Ce tableau nous permet de voir plusieurs éléments :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;tous les nombres ne peuvent être représentés exactement, c&amp;rsquo;est le cas de 1,1 qui est approximé à 1,100 000 000 000 000 088 817 841 970 01. &lt;br&gt;Si un calcul est réalisé et qu&amp;rsquo;une valeur intermédiaire est trouvée, alors la valeur sera arrondie au palier le plus proche (voir la partie sur la précision).&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Le passage d&amp;rsquo;une valeur à celle immédiatement après n&amp;rsquo;est pas régulier et dépend de l&amp;rsquo;ordre de grandeur d&amp;rsquo;un nombre.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Le point précédent implique que la précision d&amp;rsquo;un nombre dépend de son ordre de grandeur et peut aller de plusieurs centaines de chiffres après la virgule à plusieurs centaines de milliers en passant par un.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Les valeurs étant extrêmes, vous pouvez effectuer le calcul sur le site &lt;a href=&#34;https://www.wolframalpha.com&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;Wolfram Alpha&lt;/a&gt;.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voici un tableau de quelques nombres dénormalisés :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure class=&#34;wp-block-table&#34;&gt;&lt;table class=&#34;has-fixed-layout&#34;&gt;&lt;thead&gt;&lt;tr&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Exposant&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Mantisse&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Valeur d&amp;rsquo;incrémentation d&amp;rsquo;un palier&lt;br&gt;= &lt;strong&gt;Précision&lt;/strong&gt;&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Valeur approchée&lt;/th&gt;&lt;th&gt;Commentaire&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4,940656458 × 10&lt;sup&gt;-324&lt;/sup&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4,940656458 × 10&lt;sup&gt;-324&lt;/sup&gt;&lt;/td&gt;&lt;td&gt;Plus petit nombre dénormalisé&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4,940656458 × 10&lt;sup&gt;-324&lt;/sup&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;9,881 x 10&lt;sup&gt;-324&lt;/sup&gt;&lt;/td&gt;&lt;td&gt;Nombre dénormalisé suivant&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;sup&gt;53&lt;/sup&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4,940656458 × 10&lt;sup&gt;-324&lt;/sup&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2,2250738585072008 x 10&lt;sup&gt;-308&lt;/sup&gt;&lt;/td&gt;&lt;td&gt;Plus grand nombre dénormalisé&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Ce tableau nous permet de voir que :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;la valeur d&amp;rsquo;incrémentation des nombres dénormalisés est la même que le premier palier des nombres normalisé car le calcul se base sur le même exposant (la même fenêtre) : &lt;code&gt;-1022&lt;/code&gt; et la mantisse possède toujours le même nombre de valeurs (même nombre de paliers)&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Le plus grand nombre dénormalisé est immédiatement avant la plus petite valeur normalisée ce qui permet une continuité des valeurs.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voici enfin un dernier tableau présentant certains nombres spécifiques :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure class=&#34;wp-block-table&#34;&gt;&lt;table class=&#34;has-fixed-layout&#34;&gt;&lt;thead&gt;&lt;tr&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Exposant&lt;/th&gt;&lt;th&gt;Mantisse&lt;/th&gt;&lt;th&gt;Valeur approchée&lt;/th&gt;&lt;th&gt;Commentaire&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td&gt;0&lt;/td&gt;&lt;td&gt;0,0&lt;/td&gt;&lt;td&gt;Zéro&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2047&lt;/td&gt;&lt;td&gt;0&lt;/td&gt;&lt;td&gt;Infini&lt;/td&gt;&lt;td&gt;Infini&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2047&lt;/td&gt;&lt;td&gt;1&lt;/td&gt;&lt;td&gt;&lt;em&gt;NaN&lt;/em&gt;&lt;/td&gt;&lt;td&gt;Première valeur de NaN&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2047&lt;/td&gt;&lt;td&gt;2&lt;sup&gt;53&lt;/sup&gt;&lt;/td&gt;&lt;td&gt;&lt;em&gt;NaN&lt;/em&gt;&lt;/td&gt;&lt;td&gt;Dernière valeur de NaN&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Précision et chiffres significatifs&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;La précision représente la plus petite différence pouvant être calculée entre deux valeurs consécutives. Cette précision varie selon l&amp;rsquo;ordre de grandeur de la valeur d&amp;rsquo;où le terme de « nombre à virgule flottante ».&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Chaque valeur étant liée à une plage d&amp;rsquo;exposant (une fenêtre) et chaque plage d&amp;rsquo;exposant pouvant être découpée par 2&lt;sup&gt;52&lt;/sup&gt; valeurs de mantisse (les paliers), la précision de chaque plage peut être estimée par l&amp;rsquo;approximation suivante :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;&lt;code&gt;précision&lt;/code&gt; &lt;strong&gt;≃&lt;/strong&gt; &lt;code&gt;(valeur / 2&lt;sup&gt;52&lt;/sup&gt;)&lt;/code&gt; &lt;strong&gt;≃&lt;/strong&gt; &lt;code&gt;(valeur / (4,5 x 10&lt;sup&gt;15&lt;/sup&gt;))&lt;/code&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voici quelques ordres de grandeur de précision :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;Plus petit nombre normalisé : 2,225 x 10&lt;sup&gt;-308&lt;/sup&gt; : &lt;code&gt;10&lt;sup&gt;-324&lt;/sup&gt;&lt;/code&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Valeur 1,0 : &lt;code&gt;10&lt;sup&gt;-16&lt;/sup&gt;&lt;/code&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Valeur 1,0 x 10&lt;sup&gt;16&lt;/sup&gt; : &lt;code&gt;1&lt;/code&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Plus grand nombre normalisé : 1,798 x 10&lt;sup&gt;308&lt;/sup&gt; : &lt;code&gt;10&lt;sup&gt;292&lt;/sup&gt;&lt;/code&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Le terme de « nombre de chiffres significatifs » est également utilisé et représente le nombre de chiffre maximum qu&amp;rsquo;il faut pour percevoir une différence entre deux nombres en notation scientifique. Le nombre de chiffres significatifs est ici entre 15 et 16 car il faut au maximum 16 chiffres pour percevoir une différence entre deux nombres :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;Plus petit nombre normalisé : &#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;2,225 073 858 507 201 &lt;strong&gt;3&lt;/strong&gt; x 10&lt;sup&gt;-308&lt;/sup&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;2,225 073 858 507 201 &lt;strong&gt;8&lt;/strong&gt; x 10&lt;sup&gt;−308&lt;/sup&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Valeur 1,0 : &#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;1,000 000 000 000 000 &lt;strong&gt;0&lt;/strong&gt; x 10&lt;sup&gt;0&lt;/sup&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;1,000 000 000 000 000 &lt;strong&gt;2&lt;/strong&gt; x 10&lt;sup&gt;0&lt;/sup&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Valeur dont l&amp;rsquo;incrémentation est de 1 à chaque palier :&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;4,503 599 627 370 49&lt;strong&gt;6&lt;/strong&gt; x 10&lt;sup&gt;15&lt;/sup&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;4,503 599 627 370 49&lt;strong&gt;7&lt;/strong&gt; x 10&lt;sup&gt;16&lt;/sup&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Plus grand nombre normalisé : 1,798 x 10&lt;sup&gt;308&lt;/sup&gt; :&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;1,797 693 134 862 315 &lt;strong&gt;5&lt;/strong&gt; x 10&lt;sup&gt;308&lt;/sup&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;1,797 693 134 862 315 &lt;strong&gt;7&lt;/strong&gt; x 10&lt;sup&gt;308&lt;/sup&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Dans le cas de PostgreSQL (et d&amp;rsquo;autres programmes) la valeur exacte stockée est arrondie selon la précision permise pour celle-ci (grâce à &lt;a href=&#34;https://github.com/postgres/postgres/blob/master/src/common/d2s.c#L346&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;cette fonction dans le code source&lt;/a&gt;). &lt;br&gt;Ainsi, pour la valeur &lt;code&gt;1,1&lt;/code&gt;, le stockage en double précision donne la valeur exacte &lt;code&gt;1,10000000000000008881784197001&lt;/code&gt; ce qui est précis à 10&lt;sup&gt;-29&lt;/sup&gt;. Comme la précision permise pour l&amp;rsquo;ordre de grandeur de la valeur est de &lt;code&gt;2,22 x 10&lt;sup&gt;-16&lt;/sup&gt;&lt;/code&gt; près, la valeur renvoyée est arrondie selon cette précision donc &lt;code&gt;1,1000000000000000&lt;/code&gt; soit &lt;code&gt;1,1&lt;/code&gt;.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Pour aller plus loin&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voici quelques ressources pour aller plus loin :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;Des calculateurs de valeur en double précision :&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.omnicalculator.com/other/floating-point&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;https://www.omnicalculator.com/other/floating-point&lt;/a&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.binaryconvert.com/result_double.html?hexadecimal=0000000000000000&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;https://www.binaryconvert.com/&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Un outil de calcul surpuissant pour rapidement convertir des données : &lt;a href=&#34;https://www.wolframalpha.com/&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;Wolfra Alpha&lt;/a&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;L&amp;rsquo;article Wikipédia sur les nombre à virgule flottante : &lt;a href=&#34;https://fr.wikipedia.org/wiki/Virgule_flottante&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;https://fr.wikipedia.org/wiki/Virgule_flottante&lt;/a&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Un article intéressant sur les nombres à virgule flottante : &lt;a href=&#34;https://docs.oracle.com/cd/E19957-01/806-3568/ncg_goldberg.html&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;What Every Computer Scientist Should Know About Floating-Point Arithmetic&lt;/a&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;La documentation de PostgreSQL sur les nombres à virgule flottante : &lt;a href=&#34;https://www.postgresql.org/docs/current/datatype-numeric.html#DATATYPE-FLOAT&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;https://www.postgresql.org/docs/current/datatype-numeric.html#DATATYPE-FLOAT&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 class=&#34;wp-block-heading&#34;&gt;Précision sous PostGIS&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Précision globale&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Les coordonnées sous PostGIS sont stockées en utilisant le type double précision de PostgreSQL. La précision des valeurs dépend donc de l&amp;rsquo;ordre de grandeur et varie selon :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;le système de projection.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;la valeur de la coordonnée (et donc la position).&lt;br&gt;En règle générale, il est possible d&amp;rsquo;appliquer la formule suivante pour avoir une idée de la précision possible : &lt;code&gt;10&lt;sup&gt;-16&lt;/sup&gt; x la valeur&lt;/code&gt;.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voici quelques éléments de précision en lien avec différents systèmes de coordonnées :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;&lt;strong&gt;WGS84 (EPSG:4326) :&lt;/strong&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;Coordonnées X :&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;Amplitude : de -180 à 180&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Précision : de 10&lt;sup&gt;-16&lt;/sup&gt; à 10&lt;sup&gt;-14&lt;/sup&gt; (sauf pour les coordonnées entre -1 et 1 qui peuvent atteindre une précision de 10&lt;sup&gt;-324&lt;/sup&gt;).&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Coordonnées Y :&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;Amplitude de -90 à 90&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Précision : de 10&lt;sup&gt;-16&lt;/sup&gt; à 10&lt;sup&gt;-14&lt;/sup&gt; (sauf pour les coordonnées entre -1 et 1 qui peuvent atteindre une précision de 10&lt;sup&gt;-324&lt;/sup&gt;).&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;&lt;strong&gt;WGS 84 / Pseudo-Mercator (EPSG:3857) :&lt;/strong&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;Coordonnées X :&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;Amplitude : de -20037508,34 à 20037508,34&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Précision : de 10&lt;sup&gt;-16&lt;/sup&gt; à 10&lt;sup&gt;-9&lt;/sup&gt; (sauf pour les coordonnées entre -1 et 1 qui peuvent atteindre une précision de 10&lt;sup&gt;-324&lt;/sup&gt;).&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Coordonnées Y :&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;Amplitude de -20048966,1 à 20048966,1&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Précision : de 10&lt;sup&gt;-16&lt;/sup&gt; à 10&lt;sup&gt;-9&lt;/sup&gt; (sauf pour les coordonnées entre -1 et 1 qui peuvent atteindre une précision de 10&lt;sup&gt;-324&lt;/sup&gt;).&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;&lt;strong&gt;Lambert 93 (EPSG:2154) :&lt;/strong&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;Coordonnées X :&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;Amplitude : de -378305,81 à 1320649,57 (entre environ 100 000 et 1 100 000 pour la France métropolitaine)&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Précision : de 10&lt;sup&gt;-16&lt;/sup&gt; à 10&lt;sup&gt;-10&lt;/sup&gt; (sauf pour les coordonnées entre -1 et 1 qui peuvent atteindre une précision de 10&lt;sup&gt;-324&lt;/sup&gt; mais qui ne sont presque jamais utilisées).&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Coordonnées Y :&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;Amplitude de 6005281,2 à 7235612,72  (entre environ 6 033 000 et 7 130 000 pour la France métropolitaine)&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Précision : 10&lt;sup&gt;-10&lt;/sup&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Pour le Lambert 93, la précision est entre 10&lt;sup&gt;-10&lt;/sup&gt; soit 0,1 nanomètres (1 ångström, la taille d&amp;rsquo;une molécule) et 10&lt;sup&gt;-16&lt;/sup&gt; soit 0,1 femtomètre (la taille d&amp;rsquo;un nucléon : proton ou neutron) ce qui suffit largement à positionner n&amp;rsquo;importe quoi&amp;#8230;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Pour mieux visualiser la précision, il est possible de tester quelques requêtes dans PostGIS. Dirigeons nous vers Chamonix en Haute Savoie où se trouve un point possédant les coordonnées suivantes en Lambert 93 : X = 1000000 et Y = 6543210. Il s&amp;rsquo;agit de la terrasse d&amp;rsquo;un hôtel.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;SELECT &#xA;&#x9;id,&#xA;&#x9;geom_text,&#xA;&#x9;ST_AsText(geom_text::geometry(point, 2154)) AS geom&#xA;FROM (&#xA;&#x9;VALUES &#xA;&#x9;(1, &#39;POINT (1000000 6543210)&#39;),&#xA;&#x9;(2, &#39;POINT (1000000.0000000001 6543210.000000001)&#39;),&#xA;&#x9;(3, &#39;POINT (1000000.00000000001 6543210.0000000001)&#39;),&#xA;&#x9;(4, &#39;POINT (1000000.00000000008 6543210.0000000008)&#39;)&#xA;) AS t (id, geom_text)&#xA;;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voici le résultat :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure class=&#34;wp-block-table&#34;&gt;&lt;table class=&#34;has-fixed-layout&#34;&gt;&lt;thead&gt;&lt;tr&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;id&lt;/th&gt;&lt;th&gt;geom_text&lt;/th&gt;&lt;th&gt;geom&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td&gt;POINT (1000000 6543210)&lt;/td&gt;&lt;td&gt;POINT(1000000 6543210)&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td&gt;POINT (1000000.0000000001 6543210.000000001)&lt;/td&gt;&lt;td&gt;POINT(1000000.0000000001 6543210.000000001)&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td&gt;POINT (1000000.00000000001 6543210.0000000001)&lt;/td&gt;&lt;td&gt;POINT(1000000 6543210)&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td&gt;POINT (1000000.00000000008 6543210.0000000008)&lt;/td&gt;&lt;td&gt;POINT(1000000.0000000001 6543210.000000001)&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Ce que l&amp;rsquo;on observe c&amp;rsquo;est que lorsqu&amp;rsquo;une coordonnée dont la précision est supérieure à ce qui est permis par le type double précision, alors celle-ci est automatiquement arrondie :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;Dans le cas de la ligne 2, la valeur des coordonnées est permise par le type double précision, les coordonnées sont conservées telles quelles avec une précision « à la molécule près ».&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Dans le cas de la ligne 3, les coordonnées X et Y possèdent une valeur dont l&amp;rsquo;ordre de grandeur est 10&lt;sup&gt;6&lt;/sup&gt;. La précision maximum est donc de 10&lt;sup&gt;-10&lt;/sup&gt; (&lt;code&gt;10&lt;sup&gt;6&lt;/sup&gt; x 10&lt;sup&gt;-16&lt;/sup&gt;&lt;/code&gt;). Les valeurs sont donc arrondies à 10&lt;sup&gt;-10&lt;/sup&gt;. Notez que pour la valeur de Y, la valeur de la partie entière impose un arrondi à 10&lt;sup&gt;-9&lt;/sup&gt; plutôt que 10&lt;sup&gt;-10&lt;/sup&gt;.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Pour la ligne 4, le principe est le même mais l&amp;rsquo;arrondi se faisant au plus proche, nous récupérons la valeur au dessus.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Notez que la transformation des coordonnées dans le système WGS 84 (EPSG:4326) permet d&amp;rsquo;utiliser plus de décimales car les valeurs possèdent un ordre de grandeur plus faible :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;SELECT &#xA;&#x9;ST_AsText(&#xA;&#x9;&#x9;ST_Transform(&#xA;&#x9;&#x9;&#x9;&#39;POINT (1000000 6543210)&#39;::geometry(point, 2154), &#xA;&#x9;&#x9;&#x9;4326&#xA;&#x9;&#x9;)&#xA;&#x9;) AS geom&#xA;;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Le résultat est &lt;code&gt;POINT(6.87241320435217 45.92236395248839)&lt;/code&gt; : la précision est de 10&lt;sup&gt;-14&lt;/sup&gt; pour les coordonnées X et Y. Ici aussi vous pouvez voir que selon la valeur de la partie entière, la précision autorisée oscille entre 10&lt;sup&gt;-16&lt;/sup&gt; et 10&lt;sup&gt;-15&lt;/sup&gt; multipliée par l&amp;rsquo;ordre de grandeur.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 class=&#34;wp-block-heading&#34;&gt;Précision lors des calculs&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Les calculs sous PostGIS sont réalisés en double précision et donc avec la précision détaillée précédemment. Par exemple, une distance entre deux objets aura une précision qui dépendra de l&amp;rsquo;ordre de grandeur de la valeur elle-même.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Lorsqu&amp;rsquo;il s&amp;rsquo;agit de comparer des géométries, le cas est plus complexe. Nous allons étudier la fonction &lt;code&gt;ST_Intersects&lt;/code&gt; mais le principe est le même pour les autres fonctions de relation spatiale.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Relation sommet à sommet : il s&amp;rsquo;agit simplement de comparer les coordonnées entres-elles.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;SELECT &#xA;&#x9;id,&#xA;&#x9;geom_text,&#xA;&#x9;ST_AsText(geom_text::geometry(point, 2154)) AS geom,&#xA;&#x9;ST_Intersects(&#xA;&#x9;&#x9;geom_text::geometry(point, 2154),&#xA;&#x9;&#x9;&#39;POINT(1000000 6543210)&#39;::geometry(geometry, 2154)&#xA;&#x9;) AS st_intersects&#xA;FROM (&#xA;&#x9;VALUES &#xA;&#x9;(1, &#39;POINT (1000000 6543210)&#39;),&#xA;&#x9;(2, &#39;POINT (1000000.0000000001 6543210)&#39;),&#xA;&#x9;(3, &#39;POINT (1000000.00000000001 6543210)&#39;),&#xA;&#x9;(4, &#39;POINT (1000000.00000000008 6543210)&#39;),&#xA;&#x9;(5, &#39;POINT (999999.99999999990 6543210)&#39;),&#xA;&#x9;(6, &#39;POINT (999999.99999999997 6543210)&#39;)&#xA;) AS t (id, geom_text)&#xA;;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure class=&#34;wp-block-table&#34;&gt;&lt;table class=&#34;has-fixed-layout&#34;&gt;&lt;thead&gt;&lt;tr&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;id&lt;/th&gt;&lt;th&gt;geom_text&lt;/th&gt;&lt;th&gt;geom&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;st_intersects&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td&gt;POINT (1000000 6543210)&lt;/td&gt;&lt;td&gt;POINT(1000000 6543210)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td&gt;POINT (1000000.0000000001 6543210.000000001)&lt;/td&gt;&lt;td&gt;POINT(1000000.0000000001 6543210.000000001)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Non&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td&gt;POINT (1000000.00000000001 6543210.0000000001)&lt;/td&gt;&lt;td&gt;POINT(1000000 6543210)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td&gt;POINT (1000000.00000000008 6543210.0000000008)&lt;/td&gt;&lt;td&gt;POINT(1000000.0000000001 6543210.000000001)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Non&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;5&lt;/td&gt;&lt;td&gt;POINT (999999.99999999990 6543210)&lt;/td&gt;&lt;td&gt;POINT(999999.9999999999 6543210)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Non&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;6&lt;/td&gt;&lt;td&gt;POINT (999999.99999999997 6543210)&lt;/td&gt;&lt;td&gt;POINT(1000000 6543210)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Ainsi, la requête précédente permet de visualiser que la correspondance doit être exacte. Lorsqu&amp;rsquo;une coordonnées est « trop précise », elle est simplement arrondie afin de pouvoir être traitée puis comparée.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Notez que dans le cas du type &lt;code&gt;geography&lt;/code&gt;, deux géométries s&amp;rsquo;intersectent si elles sont distantes de moins de 0,00001 mètre.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Relation sommet à segment : ce cas est plus complexe car il faut calculer la distance entre un sommet réel et un point virtuel situé sur le segment. Pour faire cela, plusieurs calculs sont réalisés, tous en double précision. Ainsi, la distance doit être inférieur à la précision permise par les coordonnées des objets comparés.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Ces opérations peuvent d&amp;rsquo;ailleurs entrainer des erreurs en raison de la nature imprécise des nombre en double précision. Il est donc possible d&amp;rsquo;avoir de faux négatifs : deux objets considérés comme ne s&amp;rsquo;intersectant pas alors qu&amp;rsquo;ils le sont ou inversement.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voici une requête qui compare un point avec des lignes très proches de celui-ci :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;SELECT &#xA;&#x9;id,&#xA;&#x9;geom_line AS geom_text,&#xA;&#x9;ST_AsText(geom_line::geometry(linestring, 2154)),&#xA;&#x9;ST_Distance(&#xA;&#x9;&#x9;geom_pt::geometry(point, 2154),&#xA;&#x9;&#x9;geom_line::geometry(linestring, 2154)&#xA;&#x9;) AS st_distance,&#xA;&#x9;ST_Intersects(&#xA;&#x9;&#x9;geom_pt::geometry(point, 2154),&#xA;&#x9;&#x9;geom_line::geometry(linestring, 2154)&#xA;&#x9;) AS st_intersects&#xA;FROM (&#xA;&#x9;VALUES &#xA;&#x9;(1, &#39;POINT (1000000 6543210)&#39;, &#39;LINESTRING(999999 6543210, 1000001 6543210)&#39;),&#xA;&#x9;(2, &#39;POINT (1000000 6543210)&#39;, &#39;LINESTRING(999999 6543210, 1000001 6543210.0000000001)&#39;),&#xA;&#x9;(3, &#39;POINT (1000000 6543210)&#39;, &#39;LINESTRING(999999 6543210, 1000001 6543210.000000001)&#39;),&#xA;&#x9;(4, &#39;POINT (1000000 6543210)&#39;, &#39;LINESTRING(999999 6543210, 1000001 6543210.00000001)&#39;)&#xA;) AS t (id, geom_pt, geom_line)&#xA;;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Les objets sont alignés selon un axe globalement Est-Ouest. La variation de la coordonnée Y du sommet le plus à l&amp;rsquo;Est de la ligne permet de décaler légèrement celle-ci par rapport au point testé pour vérifier l&amp;rsquo;intersection des deux.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Le résultat est le suivant :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure class=&#34;wp-block-table&#34;&gt;&lt;table class=&#34;has-fixed-layout&#34;&gt;&lt;thead&gt;&lt;tr&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;id&lt;/th&gt;&lt;th&gt;geom_text&lt;/th&gt;&lt;th&gt;geom&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;st_distance&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;st_intersects&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td&gt;LINESTRING(999999 6543210, 1000001 6543210)&lt;/td&gt;&lt;td&gt;LINESTRING (999999 6543210, 1000001 6543210)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0.0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td&gt;LINESTRING(999999 6543210, 1000001 6543210.0000000001)&lt;/td&gt;&lt;td&gt;LINESTRING (999999 6543210, 1000001 6543210)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0.0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td&gt;LINESTRING(999999 6543210, 1000001 6543210.000000001)&lt;/td&gt;&lt;td&gt;LINESTRING (999999 6543210, 1000001 6543210.000000001)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0.0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Non&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td&gt;LINESTRING(999999 6543210, 1000001 6543210.00000001)&lt;/td&gt;&lt;td&gt;LINESTRING (999999 6543210, 1000001 6543210.00000001)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0.0000000055879354&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Non&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;La ligne 1 est une intersection parfaite. Vous pouvez observer que les géométries trop précises dans le cas de la ligne 2 sont ici aussi arrondies. En revanche, la ligne 3 met en valeur le fait que les arrondis de calcul entrainent une distance nulle alors que les objets ne s&amp;rsquo;intersectent pas ; en réalité, la distance est infinitésimale et est donc arrondie à 0. La ligne 4 montre un écart très petit.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Dernier exemple intéressant :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;generic&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;SELECT &#xA;&#x9;id,&#xA;&#x9;geom_line AS geom_text,&#xA;&#x9;ST_AsText(geom_line::geometry(linestring, 2154)) AS geom_line,&#xA;&#x9;ST_Distance(&#xA;&#x9;&#x9;geom_pt::geometry(point, 2154),&#xA;&#x9;&#x9;geom_line::geometry(linestring, 2154)&#xA;&#x9;) AS st_distance,&#xA;&#x9;ST_Distance(&#xA;&#x9;&#x9;geom_pt::geometry(point, 2154),&#xA;&#x9;&#x9;geom_line::geometry(linestring, 2154)&#xA;&#x9;) * 1e100 AS st_distance_xe100,&#xA;&#x9;ST_Distance(&#xA;&#x9;&#x9;geom_pt::geometry(point, 2154),&#xA;&#x9;&#x9;geom_line::geometry(linestring, 2154)&#xA;&#x9;) * 1e308 AS st_distance_xe308,&#xA;&#x9;ST_Intersects(&#xA;&#x9;&#x9;geom_pt::geometry(point, 2154),&#xA;&#x9;&#x9;geom_line::geometry(linestring, 2154)&#xA;&#x9;) AS st_intersects,&#xA;&#x9;st_astext(&#xA;&#x9;&#x9;ST_LineInterpolatePoint(&#xA;&#x9;&#x9;&#x9;geom_line::geometry(linestring, 2154),&#xA;&#x9;&#x9;&#x9;ST_LineLocatePoint(&#xA;&#x9;&#x9;&#x9;&#x9;geom_line::geometry(linestring, 2154),&#xA;&#x9;&#x9;&#x9;&#x9;geom_pt::geometry(point, 2154)&#xA;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;)&#xA;&#x9;) AS geom_point_proj,&#xA;&#x9;ST_Intersects(&#xA;&#x9;&#x9;ST_LineInterpolatePoint(&#xA;&#x9;&#x9;&#x9;geom_line::geometry(linestring, 2154),&#xA;&#x9;&#x9;&#x9;ST_LineLocatePoint(&#xA;&#x9;&#x9;&#x9;&#x9;geom_line::geometry(linestring, 2154),&#xA;&#x9;&#x9;&#x9;&#x9;geom_pt::geometry(point, 2154)&#xA;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;),&#xA;&#x9;&#x9;geom_line::geometry(linestring, 2154)&#xA;&#x9;) AS st_intersects_proj&#xA;FROM (&#xA;&#x9;VALUES &#xA;&#x9;(1, &#39;POINT (1 0)&#39;, &#39;LINESTRING(0 0, 10 1e-100)&#39;),&#xA;&#x9;(2, &#39;POINT (1 0)&#39;, &#39;LINESTRING(0 0, 10 1e-323)&#39;),&#xA;&#x9;(3, &#39;POINT (1 0)&#39;, &#39;LINESTRING(0 0, 10 1e-324)&#39;)&#xA;) AS t (id, geom_pt, geom_line)&#xA;;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;J&amp;rsquo;ai repris l&amp;rsquo;exemple d&amp;rsquo;une ligne avec un point mais l&amp;rsquo;ai amplifié : une ligne qui débute en X = 0 et finie en X = 10 est comparée à un point positionné en X = 2. Pour décaler la ligne du point, la fin de la ligne est déplacée selon l&amp;rsquo;axe Y d&amp;rsquo;une distance très petite (en limite du type double précision).&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Je calcule la distance, ainsi que la distance multipliée par 10&lt;sup&gt;100&lt;/sup&gt; et 10&lt;sup&gt;300&lt;/sup&gt; pour éviter de passer sous la tolérance d&amp;rsquo;affichage des double précision de PostgreSQL.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Je détermine également un point projeté sur la ligne à partir du point testé.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure class=&#34;wp-block-table&#34;&gt;&lt;table class=&#34;has-fixed-layout&#34;&gt;&lt;thead&gt;&lt;tr&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;id&lt;/th&gt;&lt;th&gt;geom_text&lt;/th&gt;&lt;th&gt;geom_line&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;st_distance&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;st_distance_xe100&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;st_distance_xe300&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;st_intersects&lt;/th&gt;&lt;th&gt;geom_point_proj&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;st_intersects_proj&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td&gt;LINESTRING(0 0, 10 0)&lt;/td&gt;&lt;td&gt;LINESTRING(0 0, 10 0)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;true&lt;/td&gt;&lt;td&gt;POINT(1 0)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;true&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td&gt;LINESTRING(0 0, 10 1e-100)&lt;/td&gt;&lt;td&gt;LINESTRING(0 0,10 1e-100)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0.1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;10&lt;sup&gt;99&lt;/sup&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;false&lt;/td&gt;&lt;td&gt;POINT(1 1e-101)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;false&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td&gt;LINESTRING(0 0, 10 1e-323)&lt;/td&gt;&lt;td&gt;LINESTRING(0 0,10 1e-323)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;false&lt;/td&gt;&lt;td&gt;POINT(1 0)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;false&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td&gt;LINESTRING(0 0, 10 1e-324)&lt;/td&gt;&lt;td&gt;LINESTRING(0 0,10 0)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;true&lt;/td&gt;&lt;td&gt;POINT(1 0)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;false&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Vous pouvez voir que le point projeté n&amp;rsquo;intersecte la ligne sur laquelle il est censé être positionné que dans le premier cas. Dans le cas d&amp;rsquo;un décalage, même infinitésimale (dans le cas de la ligne 2, la distance entre la ligne et le point projeté est tellement infime qu&amp;rsquo;il n&amp;rsquo;est pas calculable avec PostGIS), il n&amp;rsquo;y a pas intersection.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Vous pouvez essayer avec des décalages plus importants (de l&amp;rsquo;ordre de 1 m par exemple) mais très souvent il n&amp;rsquo;y aura pas d&amp;rsquo;intersection car un point projeté sur un segment de ligne n&amp;rsquo;est qu&amp;rsquo;une approximation.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;&lt;strong&gt;Pour avoir une intersection fiable, il doit y avoir une correspondance topologique : un sommet avec un sommet.&lt;/strong&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Réduire la précision&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Comme avoir une cohérence topologique ne vous intéresse pas&amp;#8230; vous voulez réduire la précision. Soit !&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Il n&amp;rsquo;est pas possible de spécifier une précision à utiliser pour une base de données avec PostGIS. D&amp;rsquo;ailleurs le simple fait de vouloir contraindre la précision des coordonnées doit amener à réfléchir sur les propositions suivantes :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;Il ne faut pas confondre précision de la mesure et précision des coordonnées : une mesure effectuée avec un GPS ayant une précision de ± 10 mètres doit être stockée telle que mesurée. &lt;br&gt;Par exemple X = 33,5 m, alors la valeur réelle est comprise entre 23,5 et 43,5 m, réduire la précision à 10 mètres près entrainerait alors une perte d&amp;rsquo;information.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Lorsque les coordonnées d&amp;rsquo;un point sont calculées par interpolation, la valeur peut avoir plus de décimales que les valeurs utilisées dans l&amp;rsquo;interpolation. &lt;br&gt;Par exemple, deux points distants dont les coordonnées sont au mètre près (pas de décimales) peuvent entrainer le calcul d&amp;rsquo;un point médian avec des coordonnées à décimales.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;La réduction de la précision au niveau des coordonnées implique une perte de précision des valeurs issues de calculs à partir des coordonnées (aire, périmètre&amp;#8230;).&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;La reprojection des coordonnées peut impliquer un changement du nombre de décimales. &lt;br&gt;Par exemple, les coordonnées en WGS 84 (en degrés) impliquent un nombre plus important de décimales que les coordonnées en Lambert 93 (en mètres).&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Il existe cependant plusieurs méthodes pour réduire la précision des coordonnées ou des calculs associés aux coordonnées.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h4 class=&#34;wp-block-heading&#34;&gt;Précision des coordonnées&lt;/h4&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;&lt;code&gt;&lt;a href=&#34;https://postgis.net/docs/ST_SnapToGrid.html&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;ST_SnapToGrid&lt;/a&gt;&lt;/code&gt; : déplace les sommets de géométries en entrée sur une grille dont le pas est défini. Les points consécutifs déplacés au même endroit ainsi que les géométries nulles sont supprimés. Attention, des géométries invalides peuvent être créées.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;&lt;code&gt;&lt;a href=&#34;https://postgis.net/docs/ST_ReducePrecision.html&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;ST_ReducePrecision&lt;/a&gt;&lt;/code&gt; : réduit la précision des coordonnées en les arrondissant selon la précision choisie. Les géométries créées sont toutes valides.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;&lt;code&gt;&lt;a href=&#34;https://postgis.net/docs/ST_QuantizeCoordinates.html&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;ST_QuantizeCoordinates&lt;/a&gt;&lt;/code&gt; : réduit la précision des coordonnées tout en opérant un traitement spécifique sur leur stockage afin d&amp;rsquo;en augmenter la compressibilité. Pour cela, les valeurs des bits non significatifs de la mantisse sont définies à zéro. Il s&amp;rsquo;agit de la meilleure méthode pour réduire le poids d&amp;rsquo;une géométrie.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h4 class=&#34;wp-block-heading&#34;&gt;Précision des calculs&lt;/h4&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Pour la précision des calculs, c&amp;rsquo;est différents. En effet, PostGIS utilise toujours la précision permise par le type double précision et seules quelques fonctions permettent d&amp;rsquo;utiliser une tolérance. &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voici les fonctions qui permettent de spécifier une tolérance (le paramètre gridsize) :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;ST_Union&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;ST_UnaryUnion&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;ST_Difference&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;ST_Intersection&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;ST_SymDifference&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;ST_Subdivide&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Cependant, dans la plupart des cas c&amp;rsquo;est la méthode qu&amp;rsquo;il faut adapter. Il s&amp;rsquo;agit ainsi d&amp;rsquo;utiliser une fonction réduisant la précision des coordonnées en conjonction d&amp;rsquo;une fonction classique ou d&amp;rsquo;utiliser une autre méthode que celle habituelle. Voici quelques cas et adaptations possibles.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h5 class=&#34;wp-block-heading&#34;&gt;ST_Intersects&lt;/h5&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Pour tester si deux géométries s&amp;rsquo;intersectent avec une certaine tolérance, il faut utiliser la fonction &lt;code&gt;ST_DWithin()&lt;/code&gt; qui permet de déterminer si deux géométries sont situées à une certaine distance l&amp;rsquo;une de l&amp;rsquo;autre.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h5 class=&#34;wp-block-heading&#34;&gt;ST_Covers&lt;/h5&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Pour tester le recouvrement de deux géométries, vous pouvez appliquer une zone tampon à la géométrie « englobante » avec la fonction &lt;code&gt;ST_Buffer()&lt;/code&gt;. Par exemple, une zone tampon de 5 mètres permet de savoir si une géométrie englobe une autre à 5 mètres près.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h5 class=&#34;wp-block-heading&#34;&gt;ST_Touches&lt;/h5&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Deux géométries se touchent si elle s&amp;rsquo;intersectent mais pas leurs « intérieurs ». Introduire une tolérance implique alors d&amp;rsquo;autoriser un léger chevauchement des intérieurs. Il faudra alors utiliser la fonction &lt;code&gt;ST_DWithin&lt;/code&gt; pour valider que les géométries soient proches l&amp;rsquo;une de l’autre. Il faut ensuite valider que l&amp;rsquo;intersection des deux géométries soit minime en calculant l&amp;rsquo;aire d&amp;rsquo;intersection avec &lt;code&gt;ST_Area(ST_Intersection())&lt;/code&gt; et en la comparant à l&amp;rsquo;aire de chacune des géométries. Il conviendra de définir un pourcentage maximum (par exemple « moins de 1% d&amp;rsquo;intersection »).&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h5 class=&#34;wp-block-heading&#34;&gt;Relation topologique : cas général&lt;/h5&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Pour le calcul des relations topologiques de manière générale, tout va dépendre du résultat voulu. Selon les cas, il faudra réduire la précision des coordonnées avant d&amp;rsquo;utiliser la fonction ou encore combiner plusieurs autres fonctions permettant de déterminer la relation voulue.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h5 class=&#34;wp-block-heading&#34;&gt;ST_Distance&lt;/h5&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Le calcul d&amp;rsquo;une distance n&amp;rsquo;est pas à proprement parlé lié à une tolérance mais la précision du résultat peut être modifié avec la fonction &lt;code&gt;round()&lt;/code&gt;.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Pour aller plus loin&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voici quelques liens pour approfondir le sujet :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;Un excellent article de Loïc Bartoletti sur Geotribu sur le sujet de la tolérance dans PostGIS : &lt;a href=&#34;https://geotribu.fr/articles/2024/2024-07-16_de-la-tolerance-en-sig-geometrie-00-annonce/&#34;&gt;https://geotribu.fr/articles/2024/2024-07-16_de-la-tolerance-en-sig-geometrie-00-annonce/&lt;/a&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Le type PostGIS &lt;code&gt;geometry&lt;/code&gt; : &lt;a href=&#34;https://postgis.net/docs/using_postgis_dbmanagement.html#PostGIS_Geometry&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;https://postgis.net/docs/using_postgis_dbmanagement.html#PostGIS_Geometry&lt;/a&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Discussion sur l&amp;rsquo;implémentation (future) d&amp;rsquo;une tolérance dans PostGIS : &lt;a href=&#34;https://trac.osgeo.org/postgis/wiki/ToleranceDiscussion#no1&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;https://trac.osgeo.org/postgis/wiki/ToleranceDiscussion#no1&lt;/a&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Un article sur l&amp;rsquo;origine de &lt;code&gt;ST_QuantizeCoordinates()&lt;/code&gt; : &lt;a href=&#34;http://www.danbaston.com/posts/2018/02/15/optimizing-postgis-geometries.html&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;http://www.danbaston.com/posts/2018/02/15/optimizing-postgis-geometries.html&lt;/a&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Une discussion sur la possibilité de définir une résolution spatiale : &lt;a href=&#34;https://gis.stackexchange.com/questions/424798/is-it-possible-to-define-a-spatial-resolution-for-a-geometry-column-in-postgis&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;https://gis.stackexchange.com/questions/424798/is-it-possible-to-define-a-spatial-resolution-for-a-geometry-column-in-postgis&lt;/a&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Une discussion sur la précision des fonctions dans PostGIS : &lt;a href=&#34;https://stackoverflow.com/questions/70258656/postgis-precision-of-functions&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;https://stackoverflow.com/questions/70258656/postgis-precision-of-functions&lt;/a&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Une discussion sur la mailing list PostGIS à propos de la précision du WKT : &lt;a href=&#34;https://lists.osgeo.org/pipermail/postgis-users/2008-May/019606.html&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;https://lists.osgeo.org/pipermail/postgis-users/2008-May/019606.html&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;</content>
    <link href="https://blog.arthurbazin.com/bdd/postgresql/soyons-precis-avec-postgis" rel="alternate"></link>
    <summary type="html">Vous êtes vous déjà demandé quelle était la précision de PostGIS ? Moi oui... Alors étudions cela ensemble.</summary>
    <author>
      <name>Arthur Bazin</name>
    </author>
  </entry>
  <entry>
    <title>Monitorer PostgreSQL avec Prometheus et Grafana</title>
    <updated>2024-05-21T19:35:50Z</updated>
    <id>tag:blog.arthurbazin.com,2024-05-21:/it/monitorer-postgresql-avec-prometheus-et-grafana</id>
    <content type="html">&#xA;&lt;p&gt;Plus une instance PostgreSQL est utilisée et plus il devient crucial de la monitorer. De nombreuses solutions existent, je vais vous en présenter une que j&amp;rsquo;utilise régulièrement et qui repose sur Prometheus et Grafana et qui permet de faire de beaux tableaux de bord.&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure class=&#34;aligncenter size-large is-resized&#34;&gt;&lt;img fetchpriority=&#34;high&#34; decoding=&#34;async&#34; width=&#34;1024&#34; height=&#34;542&#34; src=&#34;https://blog.arthurbazin.com/wp-content/uploads/grafana_dashboard-1-1024x542.png&#34; alt=&#34;&#34; class=&#34;wp-image-3303&#34; style=&#34;width:768px;height:auto&#34; srcset=&#34;https://blog.arthurbazin.com/wp-content/uploads/grafana_dashboard-1-1024x542.png 1024w, https://blog.arthurbazin.com/wp-content/uploads/grafana_dashboard-1-300x159.png 300w, https://blog.arthurbazin.com/wp-content/uploads/grafana_dashboard-1-768x407.png 768w, https://blog.arthurbazin.com/wp-content/uploads/grafana_dashboard-1-1536x813.png 1536w, https://blog.arthurbazin.com/wp-content/uploads/grafana_dashboard-1.png 1611w&#34; sizes=&#34;(max-width: 1024px) 100vw, 1024px&#34; /&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Voila un très beau tableau de bord &lt;img src=&#34;https://s.w.org/images/core/emoji/16.0.1/72x72/1f609.png&#34; alt=&#34;😉&#34; class=&#34;wp-smiley&#34; style=&#34;height: 1em; max-height: 1em;&#34; /&gt;&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p&gt;Pourquoi cette solution ? Car il est possible de monitorer d&amp;rsquo;autres programmes ainsi que des serveurs. Il s&amp;rsquo;agit donc d&amp;rsquo;une solution très modulaire.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;&lt;strong&gt;Grafana&lt;/strong&gt; est un logiciel libre de visualisation de données. Il permet notamment la réalisation de tableaux de bord et s&amp;rsquo;interface parfaitement avec Prometheus.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;&lt;strong&gt;Prometheus &lt;/strong&gt;est un logiciel libre d’enregistrement de métriques en temps réel. Il permet l&amp;rsquo;interrogation des données à l&amp;rsquo;aide d&amp;rsquo;un langage simple (PromQL) et de générer des alertes si besoin.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;&lt;strong&gt;Exporters&lt;/strong&gt; : il s&amp;rsquo;agit de petits logiciels qui permettent de récupérer des données en temps réel dans un format compréhensible par Prometheus. Il en existe de toutes sortes dont celui pour PostgreSQL : &lt;strong&gt;Postgres Exporter&lt;/strong&gt;.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 class=&#34;wp-block-heading&#34;&gt;Exporters&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Postgres Exporter&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Postgres Exporter est l&amp;rsquo;outil qui va interroger votre instance PostgreSQL est récupérer les métriques nécessaires. Il est en général installé sur le serveur sur lequel se trouve l&amp;rsquo;instance PostgreSQL mais il peut être installer ailleurs, il doit simplement pouvoir accéder à la base de données.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Notez que Postgres Exporter gère le multi-instance mais ce n&amp;rsquo;est pour l&amp;rsquo;instant pas recommandé de l&amp;rsquo;utiliser. Il faudra donc autant de processus que d&amp;rsquo;instance PostgreSQL (pour rappel, une instance de PostgreSQL peut posséder plusieurs bases de données).&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Attention, il n&amp;rsquo;est pas possible de sécuriser l&amp;rsquo;accès aux données exportées par Postgres Exporter directement. L&amp;rsquo;outil ne gère pas l&amp;rsquo;authentification, il faut donc utiliser des règle de pare-feu ou un serveur web frontal pour éviter que n&amp;rsquo;importe qui puisse voir les données.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h4 class=&#34;wp-block-heading&#34;&gt;Installation sur Windows&lt;/h4&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Commencez par télécharger le logiciel depuis &lt;a href=&#34;https://github.com/prometheus-community/postgres_exporter&#34; data-type=&#34;link&#34; data-id=&#34;https://github.com/prometheus-community/postgres_exporter&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;le projet GitHub&lt;/a&gt; (dans les Releases).&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Il suffit ensuite de le dézipper puis de la placer là où vous le souhaitez.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Créez ensuite un fichier &lt;code&gt;start_127.0.0.1_5432.bat&lt;/code&gt; dans le répertoire de Postgres Exporter avec le contenu suivant (en remplaçant l&amp;rsquo;url d&amp;rsquo;accès à votre base de données dans le fichier et dans son nom) :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;bat&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;@echo off&#xA;&#xA;REM Déclaration d&#39;une variable pour identifier la source de données&#xA;set DATA_SOURCE_NAME=postgresql://postgres:postgres@127.0.0.1:5432/postgres?sslmode=disable&#xA;&#xA;REM Lancement du processus postgres_exporter.exe avec différentes options&#xA;postgres_exporter.exe ^&#xA;  --web.listen-address=:9187 \&#xA;  --collector.database_wraparound ^&#xA;  --collector.locks ^&#xA;  --collector.long_running_transactions ^&#xA;  --collector.postmaster ^&#xA;  --collector.stat_activity_autovacuum ^&#xA;  --collector.stat_bgwriter ^&#xA;  --collector.stat_database ^&#xA;  --collector.stat_statements ^&#xA;  --collector.stat_user_tables ^&#xA;  --collector.statio_user_indexes ^&#xA;  --collector.statio_user_tables ^&#xA;  --collector.wal&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Ce script permet deux choses :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;de gérer la variable &lt;code&gt;DATA_SOURCE_NAME&lt;/code&gt; qui permet de déclarer la base de données à surveiller.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;de déclarer et éventuellement modifier facilement les options de surveillance (&lt;a href=&#34;https://github.com/prometheus-community/postgres_exporter?tab=readme-ov-file#flags&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;détaillées ici&lt;/a&gt;).&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;L&amp;rsquo;une des options est &lt;code&gt;web.listen-adress=:9187&lt;/code&gt;, il s&amp;rsquo;agit du port sur lequel les données pourront être récupérées via HTTP.&lt;br&gt;9187 est le port par défaut mais vous pouvez en attribuer un autre si celui-ci est déjà utilisé ou si vous avez plusieurs instances à surveiller.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;La surveillance peut ensuite démarrer en lançant le fichier &lt;code&gt;bat&lt;/code&gt;. &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Vous pouvez tester le fonctionnement en récupérant les données collectées en vous rendant à l&amp;rsquo;adresse suivante : &lt;code&gt;http://serveur:9187&lt;/code&gt;, vous devriez récupérer quelques chose qui ressemble à ceci :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;raw&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;# HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.&#xA;# TYPE go_gc_duration_seconds summary&#xA;go_gc_duration_seconds{quantile=&#34;0&#34;} 0&#xA;go_gc_duration_seconds{quantile=&#34;0.25&#34;} 0&#xA;go_gc_duration_seconds{quantile=&#34;0.5&#34;} 0&#xA;go_gc_duration_seconds{quantile=&#34;0.75&#34;} 0.0005124&#xA;go_gc_duration_seconds{quantile=&#34;1&#34;} 0.00158&#xA;go_gc_duration_seconds_sum 8.0821208&#xA;go_gc_duration_seconds_count 30800&#xA;# HELP go_goroutines Number of goroutines that currently exist.&#xA;# TYPE go_goroutines gauge&#xA;go_goroutines 16&#xA;# HELP go_info Information about the Go environment.&#xA;# TYPE go_info gauge&#xA;go_info{version=&#34;go1.21.3&#34;} 1&#xA;...&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Un service peut ainsi être créé pour automatiser le processus. Pour cela vous aurez besoin du logiciel gratuit &lt;a href=&#34;http://nssm.cc/download&#34; data-type=&#34;link&#34; data-id=&#34;http://nssm.cc/download&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;NSSM&lt;/a&gt; qui permet de créer des service Windows pour tout et n&amp;rsquo;importe quoi. Notez que Grafana embarque NSSM, si vous avez prévu d&amp;rsquo;installer Grafana, vous pouvez attendre de l&amp;rsquo;avoir fait plutôt que de télécharger NSSM.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Une fois récupérer, vous pourrez créer un service avec la ligne de commande suivante :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;bat&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;&#34;C:\emplacement\nssm.exe&#34; install &#34;Prometheus - Postgres Exporter - 127.0.0.1:5432&#34; &#34;C:\chemin\vers\start_127.0.0.1_5432.bat&#34; Start Automatic&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Vous pourrez supprimer le service avec la ligne de commande suivante :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;bat&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;&#34;C:\emplacement\nssm.exe&#34; remove &#34;Prometheus - Postgres Exporter - 127.0.0.1:5432&#34; confirm&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;h4 class=&#34;wp-block-heading&#34;&gt;Installation sur Linux&lt;/h4&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;L&amp;rsquo;installation sous Linux (Ubuntu/Debian) démarre avec les commandes suivantes :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;shell&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;# Création d&#39;un utilisateur dédié (si vous avez déjà PostgreSQL installé il est probable que l&#39;utilisateur existe déjà)&#xA;sudo useradd postgres --shell /bin/bash&#xA;&#xA;# Création d&#39;un répertoire dédié&#xA;sudo mkdir /opt/postgres_exporter&#xA;&#xA;# Téléchargement de Postgres_exporter&#xA;# Attention à la verion, dans le doute RDV sur le projet GitHub : https://github.com/prometheus-community/postgres_exporter&#xA;sudo wget -P /opt/postgres_exporter https://github.com/prometheus-community/postgres_exporter/releases/download/v0.15.0/postgres_exporter-0.15.0.linux-amd64.tar.gz&#xA;&#xA;# Décrompression&#xA;sudo tar xvzf /opt/postgres_exporter/postgres_exporter-0.15.0.linux-amd64.tar.gz -C /opt/postgres_exporter&#xA;&#xA;# Nettoyage&#xA;sudo rm /opt/postgres_exporter/postgres_exporter-0.15.0.linux-amd64.tar.gz&#xA;&#xA;# Retrait du numero de version dans le nom du répertoire&#xA;sudo mv /opt/postgres_exporter/postgres_exporter-0.15.0.linux-amd64 /opt/postgres_exporter/postgres_exporter&#xA;&#xA;# Gestion du propriétaire des fichiers&#xA;sudo chown postgres:postgres -R /opt/postgres_exporter&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Créons le fichier de configuration des variables d&amp;rsquo;environnement :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;shell&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;sudo nano /opt/postgres_exporter/postgres_exporter_127.0.0.1_5432.env&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Ajoutez alors la configuration suivante :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;shell&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;# BDD à monitorer&#xA;DATA_SOURCE_NAME=&#34;postgresql://postgres:postgres@127.0.0.1:5432/?sslmode=disable&#34;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Il faut maintenant mettre en place le service qui gèrera Postgres Exporter. Ajoutez une information sur l&amp;rsquo;instance monitorée car postgres_exporter ne gère pas correctement le multi-instance.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;shell&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;sudo nano /etc/systemd/system/postgres_exporter_127.0.0.1_5432.service&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Puis renseignez les éléments suivants :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;shell&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;[Unit] &#xA;Description=Prometheus exporter for Postgresql&#xA;Wants=network-online.target &#xA;After=network-online.target &#xA;&#xA;[Service] &#xA;User=postgres&#xA;Group=postgres&#xA;Type=simple&#xA;Restart=always&#xA;RestartSec=1&#xA;&#xA;WorkingDirectory=/opt/postgres_exporter&#xA;EnvironmentFile=/opt/postgres_exporter/postgres_exporter_127.0.0.1_5432.env&#xA;ExecStart=/opt/postgres_exporter/postgres_exporter/postgres_exporter \&#xA;    --web.listen-address=:9187 \&#xA;    --collector.database_wraparound \&#xA;    --collector.locks \&#xA;    --collector.long_running_transactions \&#xA;    --collector.postmaster \&#xA;    --collector.stat_activity_autovacuum \&#xA;    --collector.stat_bgwriter \&#xA;    --collector.stat_database \&#xA;    --collector.stat_statements \&#xA;    --collector.stat_user_tables \&#xA;    --collector.statio_user_indexes \&#xA;    --collector.statio_user_tables \&#xA;    --collector.wal&#xA;&#xA;&#xA;[Install]&#xA;WantedBy=multi-user.target&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Nous intégrons dans la ligne de commande différentes options de surveillance (&lt;a href=&#34;https://github.com/prometheus-community/postgres_exporter?tab=readme-ov-file#flags&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;détaillées ici&lt;/a&gt;).&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34; id=&#34;block-013a31d6-fbb5-4dd0-8c9a-f05ee7df2cad&#34;&gt;&#xA;&lt;li&gt;L&amp;rsquo;une des options est &lt;code&gt;web.listen-adress=:9187&lt;/code&gt;, il s&amp;rsquo;agit du port sur lequel les données pourront être récupérées via HTTP.&lt;br&gt;9187 est le port par défaut mais vous pouvez en attribuer un autre si celui-ci est déjà utilisé ou si vous avez plusieurs instances à surveiller.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Utilisez les commandes suivantes pour créer et lancer le service :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;shell&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;# Recharger les paramètres des services&#xA;sudo systemctl daemon-reload&#xA;&#xA;# Activer le service au démarrage&#xA;sudo systemctl enable postgres_exporter_127.0.0.1_5432.service&#xA;&#xA;# Démarrer le service&#xA;sudo systemctl start postgres_exporter_127.0.0.1_5432&#xA;&#xA;# Tester le démarrage du service&#xA;sudo systemctl status postgres_exporter_127.0.0.1_5432&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Pour voir les logs, vous pouvez utiliser la commande suivante :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;shell&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;sudo journalctl -u postgres_exporter_127.0.0.1_5432.service -f&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Vous pouvez tester le fonctionnement en récupérant les données collectées en vous rendant à l&amp;rsquo;adresse suivante : &lt;code&gt;http://serveur:9187&lt;/code&gt;. Vous devriez récupérer quelques chose qui ressemble à ceci :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;raw&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;# HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.&#xA;# TYPE go_gc_duration_seconds summary&#xA;go_gc_duration_seconds{quantile=&#34;0&#34;} 0&#xA;go_gc_duration_seconds{quantile=&#34;0.25&#34;} 0&#xA;go_gc_duration_seconds{quantile=&#34;0.5&#34;} 0&#xA;go_gc_duration_seconds{quantile=&#34;0.75&#34;} 0.0005124&#xA;go_gc_duration_seconds{quantile=&#34;1&#34;} 0.00158&#xA;go_gc_duration_seconds_sum 8.0821208&#xA;go_gc_duration_seconds_count 30800&#xA;# HELP go_goroutines Number of goroutines that currently exist.&#xA;# TYPE go_goroutines gauge&#xA;go_goroutines 16&#xA;# HELP go_info Information about the Go environment.&#xA;# TYPE go_info gauge&#xA;go_info{version=&#34;go1.21.3&#34;} 1&#xA;...&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Node Exporter&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Node Exporter est l&amp;rsquo;outil qui va collecter les métriques du système Linux.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Attention, il n&amp;rsquo;est pas possible de sécuriser l&amp;rsquo;accès aux données exportées par Node Exporter directement. L&amp;rsquo;outil ne gère pas l&amp;rsquo;authentification, il faut donc utiliser des règle de pare-feu ou un serveur web frontal pour éviter que n&amp;rsquo;importe qui puisse voir les données.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;L&amp;rsquo;installation sous Linux (Ubuntu/Debian) démarre avec les commandes suivantes :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;shell&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;# Création d&#39;un utilisateur dédié&#xA;sudo useradd node_exporter --shell /bin/bash&#xA;&#xA;# Création d&#39;un répertoire dédié&#xA;sudo mkdir /opt/node_exporter&#xA;&#xA;# Téléchargement de Node_exporter&#xA;# Attention à la verion, dans le doute RDV sur le site de Prometheus : https://prometheus.io/download/#node_exporter&#xA;sudo wget -P /opt/node_exporter https://github.com/prometheus/node_exporter/releases/download/v1.8.1/node_exporter-1.8.1.linux-amd64.tar.gz&#xA;&#xA;# Décrompression&#xA;sudo tar xvzf /opt/node_exporter/node_exporter-1.8.1.linux-amd64.tar.gz -C /opt/node_exporter&#xA;&#xA;# Nettoyage&#xA;sudo rm /opt/node_exporter/node_exporter-1.8.1.linux-amd64.tar.gz&#xA;&#xA;# Retrait du numero de version dans le nom du répertoire&#xA;sudo mv /opt/node_exporter/node_exporter-1.8.1.linux-amd64 /opt/node_exporter/node_exporter&#xA;&#xA;# Gestion du propriétaire des fichiers&#xA;sudo chown node_exporter:node_exporter -R /opt/node_exporter&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Il faut maintenant mettre en place le service qui gèrera Node Exporter. Ajoutez une information sur l&amp;rsquo;instance monitorée car postgres_exporter ne gère pas correctement le multi-instance.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;shell&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;sudo nano /etc/systemd/system/node_exporter.service&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Puis renseignez les éléments suivants :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;shell&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;[Unit] &#xA;Description=Prometheus exporter for Linux&#xA;Wants=network-online.target &#xA;After=network-online.target &#xA;&#xA;[Service] &#xA;User=node_exporter&#xA;Group=node_exporter&#xA;Type=simple&#xA;Restart=always&#xA;RestartSec=1&#xA;&#xA;WorkingDirectory=/opt/node_exporter&#xA;ExecStart=/opt/node_exporter/node_exporter/node_exporter \&#xA;    --web.listen-address=:9100 &#xA;&#xA;&#xA;[Install]&#xA;WantedBy=multi-user.target&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Nous pouvons intégrer dans la ligne de commande différentes options de surveillance (&lt;a href=&#34;https://github.com/prometheus/node_exporter&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;détaillées ici&lt;/a&gt;).&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34; id=&#34;block-013a31d6-fbb5-4dd0-8c9a-f05ee7df2cad&#34;&gt;&#xA;&lt;li&gt;L&amp;rsquo;une des options est &lt;code&gt;web.listen-adress=:9100&lt;/code&gt;, il s&amp;rsquo;agit du port sur lequel les données pourront être récupérées via HTTP.&lt;br&gt;9100 est le port par défaut mais vous pouvez en attribuer un autre si celui-ci est déjà utilisé.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Utilisez les commandes suivantes pour créer et lancer le service :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;shell&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;# Recharger les paramètres des services&#xA;sudo systemctl daemon-reload&#xA;&#xA;# Activer le service au démarrage&#xA;sudo systemctl enable node_exporter.service&#xA;&#xA;# Démarrer le service&#xA;sudo systemctl start node_exporter&#xA;&#xA;# Tester le démarrage du service&#xA;sudo systemctl status node_exporter&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Pour voir les logs, vous pouvez utiliser la commande suivante :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;shell&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;sudo journalctl -u node_exporter.service -f&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Vous pouvez tester le fonctionnement en récupérant les données collectées en vous rendant à l&amp;rsquo;adresse suivante : &lt;code&gt;http://serveur:9100&lt;/code&gt;. Vous devriez récupérer quelques chose qui ressemble à ceci :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;raw&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;# HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.&#xA;# TYPE go_gc_duration_seconds summary&#xA;go_gc_duration_seconds{quantile=&#34;0&#34;} 0&#xA;go_gc_duration_seconds{quantile=&#34;0.25&#34;} 0&#xA;go_gc_duration_seconds{quantile=&#34;0.5&#34;} 0&#xA;go_gc_duration_seconds{quantile=&#34;0.75&#34;} 0&#xA;go_gc_duration_seconds{quantile=&#34;1&#34;} 0&#xA;go_gc_duration_seconds_sum 0&#xA;go_gc_duration_seconds_count 0&#xA;# HELP go_goroutines Number of goroutines that currently exist.&#xA;# TYPE go_goroutines gauge&#xA;go_goroutines 7&#xA;# HELP go_info Information about the Go environment.&#xA;# TYPE go_info gauge&#xA;go_info{version=&#34;go1.22.3&#34;} 1&#xA;...&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Windows Exporter&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Windows Exporter est l&amp;rsquo;outil qui va collecter les métriques du système Windows.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;La procédure d&amp;rsquo;installation de cet exporter est bien détaillée sur la page du projet GitHub. Je ne la détaillerai donc pas entièrement ici.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-buttons is-vertical is-content-justification-center is-layout-flex wp-container-core-buttons-is-layout-9a7cdcfd wp-block-buttons-is-layout-flex&#34;&gt;&#xA;&lt;div class=&#34;wp-block-button has-custom-width wp-block-button__width-50&#34;&gt;&lt;a class=&#34;wp-block-button__link wp-element-button&#34; href=&#34;https://github.com/prometheus-community/windows_exporter?tab=readme-ov-file#installation&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;Procédure d&amp;rsquo;installation de Windows Exporter&lt;/a&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-button has-custom-width wp-block-button__width-50&#34;&gt;&lt;a class=&#34;wp-block-button__link wp-element-button&#34; href=&#34;https://github.com/prometheus-community/windows_exporter/releases&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;Téléchargement de Windows Exporter&lt;/a&gt;&lt;/div&gt;&#xA;&lt;/div&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voici la ligne de commande utilisée pour installer l&amp;rsquo;exporter :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;generic&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;msiexec /i &#34;C:\chemin_vers\windows_exporter-0.25.1-amd64.msi&#34; LISTEN_PORT=9182 EXTRA_FLAGS=&#34;--config.file=&#34;&#34;C:\Program Files\windows_exporter\config.yml&#34;&#34;&#34;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Cela permet de configurer Windows Exporter avec un fichier de configuration afin de pouvoir facilement modifier certains paramètres si besoin (il suffit ensuite de relancer le service pour prendre en compte le nouveau paramétrage).&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Vous pouvez tester le fonctionnement en récupérant les données collectées en vous rendant à l&amp;rsquo;adresse suivante : &lt;code&gt;http://serveur:9182&lt;/code&gt;. Vous devriez récupérer quelques chose qui ressemble à ceci :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;raw&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;# HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.&#xA;# TYPE go_gc_duration_seconds summary&#xA;go_gc_duration_seconds{quantile=&#34;0&#34;} 0&#xA;go_gc_duration_seconds{quantile=&#34;0.25&#34;} 0&#xA;go_gc_duration_seconds{quantile=&#34;0.5&#34;} 0&#xA;go_gc_duration_seconds{quantile=&#34;0.75&#34;} 0.0005129&#xA;go_gc_duration_seconds{quantile=&#34;1&#34;} 0.0005364&#xA;go_gc_duration_seconds_sum 0.0058283&#xA;go_gc_duration_seconds_count 37&#xA;# HELP go_goroutines Number of goroutines that currently exist.&#xA;# TYPE go_goroutines gauge&#xA;go_goroutines 15&#xA;# HELP go_info Information about the Go environment.&#xA;# TYPE go_info gauge&#xA;go_info{version=&#34;go1.21.5&#34;} 1&#xA;...&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 class=&#34;wp-block-heading&#34;&gt;Prometheus&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Prometheus est l&amp;rsquo;outil qui va stocker les données récupérées par Postgres Exporter. Pour cela, il doit pouvoir contacter Postgres Exporter via HTTP.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Prometheus gère l&amp;rsquo;authentification basique, il faut pour cela suivre la procédure indiquée sur le site officiel : &lt;a href=&#34;https://prometheus.io/docs/guides/basic-auth&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;https://prometheus.io/docs/guides/basic-auth&lt;/a&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Installation sur Windows&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Commencez par télécharger le logiciel depuis &lt;a href=&#34;https://prometheus.io/download/&#34; data-type=&#34;link&#34; data-id=&#34;https://github.com/prometheus-community/postgres_exporter&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;le site de Prometheus&lt;/a&gt;.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Il suffit ensuite de le dézipper puis de la placer là où vous le souhaitez.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;La configuration de Prometheus se fait au travers d&amp;rsquo;un fichier YAML. Un fichier de configuration de base est fournit, ouvrez le et complétez le avec les informations suivantes :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;yaml&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;# Configuration globale&#xA;global:&#xA;  # Interval global de récupération (défaut 1 min)&#xA;  scrape_interval: 15s&#xA;  # Interval global d&#39;évaluation des règles (défaut 1 min)&#xA;  evaluation_interval: 15s&#xA;  # Interval global de timeout (défaut 10s)&#xA;  scrape_timeout: 10s&#xA;&#xA;# Gestionnaire d&#39;alertes&#xA;alerting:&#xA;  alertmanagers:&#xA;    - static_configs:&#xA;        - targets:&#xA;          # - alertmanager:9093&#xA;&#xA;# Règles&#xA;rule_files:&#xA;  # - &#34;first_rules.yml&#34;&#xA;  # - &#34;second_rules.yml&#34;&#xA;&#xA;# Configuration des data scraper (récupérateurs de données)&#xA;scrape_configs:&#xA;  # Prometheus lui-même&#xA;  # &#34;job_name&#34; est ajouté à chaque donnée récupérée via cette configuration&#xA;  - job_name: &#34;Prometheus - Local&#34;&#xA;    static_configs:&#xA;      # Cible à atteindre&#xA;      - targets: [&#34;localhost:9090&#34;]&#xA;&#xA;    # Identifiant et mot de passe pour accéder à Prometheus&#xA;    basic_auth:&#xA;      username: identifiant&#xA;      password: mdp&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Nous allons ensuite sécuriser l&amp;rsquo;accès à Prometheus. Créez un fichier web.yml avec les éléments suivants (pensez à utiliser les mêmes identifiant/mdp dans le fichier précédent : Prometheus doit pouvoir accéder à lui-même pour s&amp;rsquo;auto-monitorer) :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;yaml&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;basic_auth_users:&#xA;  # Utilisateur 1 : identifiant: mdp_encrypté&#xA;  identifiant: $2a$12$P63ADVOo///fo4HiMm4sYuogjceHfzT3vfShmgAYvEw8v28Bt4GBq&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Vous pouvez ajouter autant d&amp;rsquo;utilisateurs que vous le souhaitez. Le mot de passe doit être spécifié de façon crypté avec bcrypt. Vous pouvez utiliser un crypteur sur le web &lt;a href=&#34;https://bcrypt-generator.com/&#34;&gt;comme celui-ci&lt;/a&gt;.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Créez ensuite un fichier &lt;code&gt;start.bat&lt;/code&gt; dans le répertoire de Prometheus avec le contenu suivant (en remplaçant l&amp;rsquo;url d&amp;rsquo;accès à votre base de données dans le fichier et dans son nom) :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;bat&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;@echo off&#xA;&#xA;REM Lancement du processus prometheus.exe avec différentes options&#xA;prometheus.exe ^&#xA;  --web.listen-address=:9090 ^&#xA;  --web.config.file=web.yml&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Ce script permet de déclarer et éventuellement modifier facilement les options de Prometheus.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;L&amp;rsquo;option &lt;code&gt;web.listen-adress=:9090&lt;/code&gt; permet de définir le port d&amp;rsquo;écoute. &lt;br&gt;La valeur 9090 est la valeur par défaut, cette option n&amp;rsquo;est donc pas indispensable dans notre cas.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;L&amp;rsquo;option &lt;code&gt;web.config.file=web.yml&lt;/code&gt; permet d&amp;rsquo;activer l&amp;rsquo;authentification.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;La surveillance peut ensuite démarrer en lançant le fichier &lt;code&gt;bat&lt;/code&gt;. &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Vous pouvez tester le fonctionnement en vous rendant sur l&amp;rsquo;interface de Prometheus à l&amp;rsquo;adresse suivante : &lt;code&gt;http://serveur:9090&lt;/code&gt;. Vous devriez obtenir la page suivante :&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure class=&#34;aligncenter size-large is-resized&#34;&gt;&lt;img decoding=&#34;async&#34; width=&#34;1024&#34; height=&#34;440&#34; src=&#34;https://blog.arthurbazin.com/wp-content/uploads/prometheus_accueil-1024x440.png&#34; alt=&#34;&#34; class=&#34;wp-image-3323&#34; style=&#34;width:696px;height:auto&#34; srcset=&#34;https://blog.arthurbazin.com/wp-content/uploads/prometheus_accueil-1024x440.png 1024w, https://blog.arthurbazin.com/wp-content/uploads/prometheus_accueil-300x129.png 300w, https://blog.arthurbazin.com/wp-content/uploads/prometheus_accueil-768x330.png 768w, https://blog.arthurbazin.com/wp-content/uploads/prometheus_accueil.png 1041w&#34; sizes=&#34;(max-width: 1024px) 100vw, 1024px&#34; /&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p&gt;Un service peut ainsi être créé pour automatiser le processus. Pour cela vous aurez besoin du logiciel gratuit &lt;a href=&#34;http://nssm.cc/download&#34; data-type=&#34;link&#34; data-id=&#34;http://nssm.cc/download&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;NSSM&lt;/a&gt; qui permet de créer des service Windows pour tout et n&amp;rsquo;importe quoi. Notez que Grafana embarque NSSM, si vous avez prévu d&amp;rsquo;installer Grafana, vous pouvez attendre de l&amp;rsquo;avoir fait plutôt que de télécharger NSSM.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Une fois récupérer, vous pourrez créer un service avec la ligne de commande suivante :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;bat&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;&#34;C:\emplacement\nssm.exe&#34; install &#34;Prometheus&#34; &#34;C:\chemin\vers\start.exe&#34; Start Automatic&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Vous pourrez supprimer le service avec la ligne de commande suivante :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;bat&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;&#34;C:\emplacement\nssm.exe&#34; remove &#34;Prometheus&#34; confirm&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Installation sur Linux&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;L&amp;rsquo;installation sous Linux (Ubuntu/Debian) démarre avec les commandes suivantes :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;shell&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;# Création d&#39;un utilisateur dédié&#xA;sudo useradd prometheus --shell /bin/bash&#xA;&#xA;# Création d&#39;un répertoire dédié et d&#39;un répertoire pour stocker les données&#xA;sudo mkdir /opt/prometheus&#xA;sudo mkdir /opt/prometheus/data&#xA;&#xA;# Téléchargement de Prometheus&#xA;# Attention à la version qu&#39;il vous faudra adapter&#xA;sudo wget -P /opt/prometheus https://github.com/prometheus/prometheus/releases/download/v2.51.1/prometheus-2.51.1.linux-amd64.tar.gz&#xA;&#xA;# Décrompression&#xA;sudo tar xvzf /opt/prometheus/prometheus-2.51.1.linux-amd64.tar.gz -C /opt/prometheus&#xA;&#xA;# Nettoyage&#xA;sudo rm /opt/prometheus/prometheus-2.51.1.linux-amd64.tar.gz&#xA;&#xA;# Retrait du numero de version dans le nom du répertoire&#xA;sudo mv /opt/prometheus/prometheus-2.51.1.linux-amd64 /opt/prometheus/prometheus&#xA;&#xA;# Gestion du propriétaire des fichiers&#xA;sudo chown prometheus:prometheus -R /opt/prometheus&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;La configuration de Prometheus se fait au travers d&amp;rsquo;un fichier YAML. Un fichier de configuration de base est fournit, ouvrez le :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;shell&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;sudo nano /opt/prometheus/prometheus/prometheus.yml&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;yaml&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;# Configuration globale&#xA;global:&#xA;  # Interval global de récupération (défaut 1 min)&#xA;  scrape_interval: 15s&#xA;  # Interval global d&#39;évaluation des règles (défaut 1 min)&#xA;  evaluation_interval: 15s&#xA;  # Interval global de timeout (défaut 10s)&#xA;  scrape_timeout: 10s&#xA;&#xA;# Gestionnaire d&#39;alertes&#xA;alerting:&#xA;  alertmanagers:&#xA;    - static_configs:&#xA;        - targets:&#xA;          # - alertmanager:9093&#xA;&#xA;# Règles&#xA;rule_files:&#xA;  # - &#34;first_rules.yml&#34;&#xA;  # - &#34;second_rules.yml&#34;&#xA;&#xA;# Configuration des data scraper (récupérateurs de données)&#xA;scrape_configs:&#xA;  # Prometheus lui-même&#xA;  # &#34;job_name&#34; est ajouté à chaque donnée récupérée via cette configuration&#xA;  - job_name: &#34;Prometheus - Local&#34;&#xA;    static_configs:&#xA;      # Cible à atteindre&#xA;      - targets: [&#34;localhost:9090&#34;]&#xA;&#xA;    # Identifiant et mot de passe pour accéder à Prometheus&#xA;    basic_auth:&#xA;      username: identifiant&#xA;      password: mdp&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Nous allons ensuite sécuriser l&amp;rsquo;accès à Prometheus. Créez un fichier web.yml avec les éléments suivants (pensez à utiliser les mêmes identifiant/mdp dans le fichier précédent : Prometheus doit pouvoir accéder à lui-même pour s&amp;rsquo;auto-monitorer) :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;shell&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;sudo nano /opt/prometheus/prometheus/web.yml&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;yaml&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;basic_auth_users:&#xA;  # Utilisateur 1 : identifiant: mdp_encrypté&#xA;  identifiant: $2a$12$P63ADVOo///fo4HiMm4sYuogjceHfzT3vfShmgAYvEw8v28Bt4GBq&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Vous pouvez ajouter autant d&amp;rsquo;utilisateurs que vous le souhaitez. Le mot de passe doit être spécifié de façon crypté avec bcrypt. Vous pouvez utiliser un crypteur sur le web &lt;a href=&#34;https://bcrypt-generator.com/&#34;&gt;comme celui-ci&lt;/a&gt;.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;La récupération des données peut ensuite démarrer en lançant le programme Prometheus via la commande suivante :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;shell&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;/opt/prometheus/prometheus/prometheus --config.file=prometheus.yml --web.config.file=web.yml&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Vous pouvez tester le fonctionnement en vous rendant sur l&amp;rsquo;interface de Prometheus à l&amp;rsquo;adresse suivante : &lt;code&gt;http://serveur:9090&lt;/code&gt;. Vous devriez obtenir la page suivante :&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure class=&#34;aligncenter size-large is-resized&#34;&gt;&lt;img decoding=&#34;async&#34; width=&#34;1024&#34; height=&#34;440&#34; src=&#34;https://blog.arthurbazin.com/wp-content/uploads/prometheus_accueil-1024x440.png&#34; alt=&#34;&#34; class=&#34;wp-image-3323&#34; style=&#34;width:696px;height:auto&#34; srcset=&#34;https://blog.arthurbazin.com/wp-content/uploads/prometheus_accueil-1024x440.png 1024w, https://blog.arthurbazin.com/wp-content/uploads/prometheus_accueil-300x129.png 300w, https://blog.arthurbazin.com/wp-content/uploads/prometheus_accueil-768x330.png 768w, https://blog.arthurbazin.com/wp-content/uploads/prometheus_accueil.png 1041w&#34; sizes=&#34;(max-width: 1024px) 100vw, 1024px&#34; /&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p&gt;Notez que le port sur lequel Prometheus est disponible peut être modifier avec l&amp;rsquo;argument &lt;code&gt;--web.listen-address&lt;/code&gt; a ajouter lors du démarrage du programme (comme avec Postgres Exporter).&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Il faut maintenant mettre en place le service qui gèrera Prometheus.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;shell&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;sudo nano /etc/systemd/system/prometheus.service&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Puis renseignez les éléments suivants :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;shell&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;[Unit] &#xA;Description=Prometheus &#xA;Wants=network-online.target &#xA;After=network-online.target &#xA;&#xA;[Service] &#xA;User=prometheus &#xA;Group=prometheus &#xA;Type=simple&#xA;Restart=always&#xA;RestartSec=1&#xA;ExecStart=/opt/prometheus/prometheus/prometheus \&#xA;    --config.file=/opt/prometheus/prometheus/prometheus.yml \&#xA;    --web.config.file=/opt/prometheus/prometheus/web.yml \&#xA;    --web.listen-address=:9090 \&#xA;    --storage.tsdb.path=/opt/prometheus/data \&#xA;    --storage.tsdb.retention.time=30d&#xA;&#xA;&#xA;[Install]&#xA;WantedBy=multi-user.target&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Utilisez les commandes suivantes pour créer et lancer le service :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;shell&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;# Recharger les paramètres des services&#xA;sudo systemctl daemon-reload&#xA;&#xA;# Activer le service au démarrage&#xA;sudo systemctl enable prometheus.service&#xA;&#xA;# Démarrer le service&#xA;sudo systemctl start prometheus&#xA;&#xA;# Tester le démarrage du service&#xA;sudo systemctl status prometheus&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Pour voir les logs, vous pouvez utiliser la commande suivante :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;shell&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;sudo journalctl -u prometheus.service -f&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Liaison Prometheus &amp;#8211; Exporter&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Pour que Prometheus récupère les données d&amp;rsquo;un Exporter que vous avez installé, il vous faut éditer le fichier de configuration YAML.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Ajoutez un nouveau « job » dans la partie &lt;code&gt;scrape_configs&lt;/code&gt;.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Pour PostgreSQL :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;yaml&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;  # PostgreSQL Monitoring avec postgres_exporter&#xA;  - job_name: &#39;PostgreSQL Exporter&#39;&#xA;    scrape_interval: 5s&#xA;    static_configs:&#xA;      # Cible à atteindre&#xA;      - targets: [&#39;127.0.0.1:9187&#39;]&#xA;        labels:&#xA;          # &#34;instance&#34; est ajouté à chaque donnée récupérée et prend la valeur du paramètre &amp;lt;targets&gt;, comme on sait qu&#39;il n&#39;y a qu&#39;un PG derrière, on renomme l&#39;instance&#xA;          &#34;instance&#34;: &#34;127.0.0.1:5431&#34;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Pour Node Exporter :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;yaml&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt; # Linux Monitoring with node_exporter&#xA;  - job_name: &#39;Node Exporter&#39;&#xA;    scrape_interval: 15s&#xA;    static_configs:&#xA;      - targets: [&#39;127.0.0.1:9100&#39;]&#xA;        labels:&#xA;          &#34;instance&#34;: &#34;Mon serveur XYZ&#34;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Pour Windows Exporter :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;yaml&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt; # Windows Monitoring with windows_exporter&#xA;  - job_name: &#39;Windows Exporter&#39;&#xA;    scrape_interval: 15s&#xA;    static_configs:&#xA;      - targets: [&#39;127.0.0.1:9182&#39;]&#xA;        labels:&#xA;          &#34;instance&#34;: &#34;Mon serveur ABC&#34;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Vous pouvez ajouter autant de job que nécessaire, afin que votre Prometheus récupère des données de divers services.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Redémarrez le service de Prometheus et rendez-vous dans la page « Status » =&amp;gt; « Target » de l&amp;rsquo;interface, vous devriez voir la connexion avec Postgres Exporter et Node Exporter&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure class=&#34;aligncenter size-large is-resized&#34;&gt;&lt;img decoding=&#34;async&#34; width=&#34;1024&#34; height=&#34;520&#34; src=&#34;https://blog.arthurbazin.com/wp-content/uploads/prometheus_target-1024x520.png&#34; alt=&#34;&#34; class=&#34;wp-image-3324&#34; style=&#34;width:757px;height:auto&#34; srcset=&#34;https://blog.arthurbazin.com/wp-content/uploads/prometheus_target-1024x520.png 1024w, https://blog.arthurbazin.com/wp-content/uploads/prometheus_target-300x152.png 300w, https://blog.arthurbazin.com/wp-content/uploads/prometheus_target-768x390.png 768w, https://blog.arthurbazin.com/wp-content/uploads/prometheus_target.png 1036w&#34; sizes=&#34;(max-width: 1024px) 100vw, 1024px&#34; /&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;h2 class=&#34;wp-block-heading&#34;&gt;Grafana&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Installation sur Windows&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Commencez par télécharger le logiciel depuis &lt;a href=&#34;https://grafana.com/grafana/download?platform=windows&#34; data-type=&#34;link&#34; data-id=&#34;https://github.com/prometheus-community/postgres_exporter&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;le site de Grafana&lt;/a&gt;.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Il suffit ensuite de le dézipper puis de la placer là où vous le souhaitez.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Le logiciel se lance simplement en démarrant le programme &lt;code&gt;grafana-server.exe&lt;/code&gt; situé dans le répertoire &lt;code&gt;bin&lt;/code&gt;.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Vous pouvez tester le fonctionnement en vous rendant sur l&amp;rsquo;interface de Grafana à l&amp;rsquo;adresse suivante : &lt;code&gt;http://serveur:3000&lt;/code&gt;.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Notez que le port sur lequel Grafana est disponible peut être modifier dans le fichier de configuration &lt;code&gt;conf/defaults.ini&lt;/code&gt;.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Un service peut ainsi être créé pour automatiser le processus. Pour cela vous aurez besoin du logiciel gratuit &lt;a href=&#34;http://nssm.cc/download&#34; data-type=&#34;link&#34; data-id=&#34;http://nssm.cc/download&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;NSSM&lt;/a&gt; qui permet de créer des service Windows pour tout et n&amp;rsquo;importe quoi. Notez que Grafana embarque NSSM dans le répertoire &lt;code&gt;svc-x&lt;/code&gt;.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Une fois récupérer, vous pourrez créer un service avec la ligne de commande suivante :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;generic&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;&#34;C:\emplacement\nssm.exe&#34; install &#34;Grafana&#34; &#34;C:\chemin\vers\grafana-server.exe&#34; Start Automatic&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Vous pourrez supprimer le service avec la ligne de commande suivante :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;generic&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;&#34;C:\emplacement\nssm.exe&#34; remove &#34;Grafana&#34; confirm&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Installation sur Linux&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Il existe une multitude de façon d&amp;rsquo;installer Grafana sur Linux (Ubuntu/Debian).&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;L&amp;rsquo;installation sous Linux démarre avec les commandes suivantes :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;generic&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;# Création d&#39;un utilisateur dédié&#xA;sudo useradd grafana --shell /bin/bash&#xA;&#xA;# Création d&#39;un répertoire dédié&#xA;sudo mkdir /opt/grafana&#xA;&#xA;# Téléchargement de Prometheus&#xA;# Attention à la version qu&#39;il vous faudra adapter&#xA;sudo wget -P /opt/grafana https://dl.grafana.com/enterprise/release/grafana-enterprise-11.0.0.linux-amd64.tar.gz&#xA;&#xA;# Décrompression&#xA;sudo tar xvzf /opt/grafana/grafana-enterprise-11.0.0.linux-amd64.tar.gz -C /opt/grafana&#xA;&#xA;# Nettoyage&#xA;sudo rm /opt/grafana/grafana-enterprise-11.0.0.linux-amd64.tar.gz&#xA;&#xA;# Retrait du numero de version dans le nom du répertoire&#xA;sudo mv /opt/grafana/grafana-v11.0.0 /opt/grafana/grafana&#xA;&#xA;# Gestion du propriétaire des fichiers&#xA;sudo chown grafana:grafana -R /opt/grafana&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Le logiciel se lance simplement en démarrant le programme &lt;code&gt;grafana&lt;/code&gt; situé dans le répertoire &lt;code&gt;bin&lt;/code&gt; :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;shell&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;grafana server&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Vous pouvez tester le fonctionnement en vous rendant sur l&amp;rsquo;interface de Grafana à l&amp;rsquo;adresse suivante : &lt;code&gt;http://serveur:3000&lt;/code&gt;.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Notez que le port sur lequel Grafana est disponible peut être modifier dans le fichier de configuration &lt;code&gt;conf/defaults.ini&lt;/code&gt;.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Il faut maintenant mettre en place le service qui gèrera Grafana.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;generic&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;sudo nano /etc/systemd/system/grafana.service&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Puis renseignez les éléments suivants :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;shell&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;[Unit] &#xA;Description=Grafana&#xA;Wants=network-online.target &#xA;After=network-online.target &#xA;&#xA;[Service] &#xA;User=grafana&#xA;Group=grafana&#xA;Type=simple&#xA;Restart=always&#xA;RestartSec=1&#xA;WorkingDirectory=/opt/grafana/grafana&#xA;ExecStart=/opt/grafana/grafana/bin/grafana server&#xA;&#xA;&#xA;[Install]&#xA;WantedBy=multi-user.target&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Utilisez les commandes suivantes pour créer et lancer le service :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;generic&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;# Recharger les paramètres des services&#xA;sudo systemctl daemon-reload&#xA;&#xA;# Activer le service au démarrage&#xA;sudo systemctl enable grafana.service&#xA;&#xA;# Démarrer le service&#xA;sudo systemctl start grafana&#xA;&#xA;# Tester le démarrage du service&#xA;sudo systemctl status grafana&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Pour voir les logs, vous pouvez utiliser la commande suivante :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;generic&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;sudo journalctl -u grafana.service -f&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Paramétrages&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Vous pouvez maintenant accéder à Grafana sur l&amp;rsquo;adresse &lt;code&gt;http://serveur:3000&lt;/code&gt;.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Le premier écran vous demande de vous connecter, utilisez l&amp;rsquo;identifiant &lt;code&gt;admin&lt;/code&gt; avec &lt;code&gt;admin&lt;/code&gt; pour mot de passe. L&amp;rsquo;écrans suivant vous demandera de définir un nouveau mot de passe.&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure class=&#34;aligncenter size-large is-resized&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; width=&#34;1024&#34; height=&#34;594&#34; src=&#34;https://blog.arthurbazin.com/wp-content/uploads/grafana_sign_in-1024x594.png&#34; alt=&#34;&#34; class=&#34;wp-image-3293&#34; style=&#34;width:604px;height:auto&#34; srcset=&#34;https://blog.arthurbazin.com/wp-content/uploads/grafana_sign_in-1024x594.png 1024w, https://blog.arthurbazin.com/wp-content/uploads/grafana_sign_in-300x174.png 300w, https://blog.arthurbazin.com/wp-content/uploads/grafana_sign_in-768x446.png 768w, https://blog.arthurbazin.com/wp-content/uploads/grafana_sign_in.png 1034w&#34; sizes=&#34;auto, (max-width: 1024px) 100vw, 1024px&#34; /&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p&gt;Dans l&amp;rsquo;interface suivante, cliquer sur l&amp;rsquo;icone pour ouvrir le menu de gauche puis sur « Add new connection » :&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure class=&#34;aligncenter size-full is-resized&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; width=&#34;772&#34; height=&#34;462&#34; src=&#34;https://blog.arthurbazin.com/wp-content/uploads/grafana_new_connexion.png&#34; alt=&#34;&#34; class=&#34;wp-image-3294&#34; style=&#34;width:590px;height:auto&#34; srcset=&#34;https://blog.arthurbazin.com/wp-content/uploads/grafana_new_connexion.png 772w, https://blog.arthurbazin.com/wp-content/uploads/grafana_new_connexion-300x180.png 300w, https://blog.arthurbazin.com/wp-content/uploads/grafana_new_connexion-768x460.png 768w&#34; sizes=&#34;auto, (max-width: 772px) 100vw, 772px&#34; /&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p&gt;Vous pouvez maintenant ajouter une connexion vers Prometheus en renseignant son url d&amp;rsquo;accès &lt;code&gt;http://serveur:9090&lt;/code&gt; puis en choisissant le type d&amp;rsquo;authentification « basique ».&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Il ne vous reste plus qu&amp;rsquo;a créer votre tableau de bord ou en récupérer un déjà créé depuis &lt;a href=&#34;https://grafana.com/grafana/dashboards/&#34; data-type=&#34;link&#34; data-id=&#34;https://grafana.com/grafana/dashboards/&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;le site de Grafana&lt;/a&gt;.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voici un exemple de tableau de bord :&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure class=&#34;aligncenter size-large&#34;&gt;&lt;img loading=&#34;lazy&#34; decoding=&#34;async&#34; width=&#34;1024&#34; height=&#34;542&#34; src=&#34;https://blog.arthurbazin.com/wp-content/uploads/grafana_dashboard-1-1024x542.png&#34; alt=&#34;&#34; class=&#34;wp-image-3303&#34; srcset=&#34;https://blog.arthurbazin.com/wp-content/uploads/grafana_dashboard-1-1024x542.png 1024w, https://blog.arthurbazin.com/wp-content/uploads/grafana_dashboard-1-300x159.png 300w, https://blog.arthurbazin.com/wp-content/uploads/grafana_dashboard-1-768x407.png 768w, https://blog.arthurbazin.com/wp-content/uploads/grafana_dashboard-1-1536x813.png 1536w, https://blog.arthurbazin.com/wp-content/uploads/grafana_dashboard-1.png 1611w&#34; sizes=&#34;auto, (max-width: 1024px) 100vw, 1024px&#34; /&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p&gt;Voici le code json à télécharger pour importer ce tableau de bord dans votre Grafana : &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-buttons is-content-justification-center is-layout-flex wp-container-core-buttons-is-layout-16018d1d wp-block-buttons-is-layout-flex&#34;&gt;&#xA;&lt;div class=&#34;wp-block-button&#34;&gt;&lt;a class=&#34;wp-block-button__link wp-element-button&#34; href=&#34;https://blog.arthurbazin.com/wp-content/uploads/tdb_postgresql.zip&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;Tableau de bord PostgreSQL &amp;#8211; 7ko&lt;/a&gt;&lt;/div&gt;&#xA;&lt;/div&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 class=&#34;wp-block-heading&#34;&gt;Métriques importantes&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Quelles sont les métriques importantes à surveiller ? &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Tout dépends des usages mais en voici quelques unes que j&amp;rsquo;ai pu choisir pour PostgreSQL :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;&lt;code&gt;pg_up&lt;/code&gt; : l&amp;rsquo;état actif ou non de l&amp;rsquo;instance.&lt;br&gt;C&amp;rsquo;est un peu la base de tout le monitoring&amp;#8230;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;process_start_time_seconds&lt;/code&gt; : le délais d&amp;rsquo;activité (depuis quand la base est-elle démarrée ?)&lt;br&gt;Cela permet de repérer les redémarrages de la base.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;pg_stat_activity_count&lt;/code&gt; et &lt;code&gt;pg_settings_max_connections&lt;/code&gt; : le nombre de connexions par rapport au nombre total de connexions possibles.&lt;br&gt;Pour savoir s&amp;rsquo;il faut augmenter le pool de connexions disponibles.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;pg_database_size_bytes&lt;/code&gt; : la taille totale des bases de l&amp;rsquo;instance&lt;br&gt;Pour identifier celle qui pourrait poser problème et/ou anticiper une augmentation de la capacité du serveur.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;pg_stat_database_xact_commit&lt;/code&gt; et &lt;code&gt;pg_stat_database_xact_rollback&lt;/code&gt; : le taux de COMMIT et de ROLLBACK.&lt;br&gt;S&amp;rsquo;il y a beaucoup de ROLLBACK, il y a peut être un problème avec certaines requêtes.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;process_resident_memory_bytes&lt;/code&gt; et &lt;code&gt;process_cpu_seconds_total&lt;/code&gt; : les consommations RAM et CPU.&lt;br&gt;Il s&amp;rsquo;agit plus de valeur indicatives de la charge de la base, il n&amp;rsquo;y a pas de mise en rapport avec la puissance du serveur et donc pas d&amp;rsquo;information sur l&amp;rsquo;état de charge de la machine.&lt;br&gt;Il faudra plutot surveiller le serveur en lui-même.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;pg_stat_database_tup_fetched&lt;/code&gt; et &lt;code&gt;pg_stat_database_tup_returned&lt;/code&gt; : le rapport entre le nombre de tuples lus directement dans le stockage (returned) par rapport au nombre de tuples réellement nécessaires (fetched). Cela permet de déceler un manque d&amp;rsquo;indexation.&lt;br&gt;Par exemple, sur une table de 1000 lignes sans index, une requête avec une clause ne renvoyant que 100 lignes aura un nombre de tuples « returned » de 1000 et un nombre de tuples « fetched » de 100 car il aura fallu scanner toutes les lignes pour récupérer le résultat. Avec un index, la valeur de returned aurait été bien moindre (probablement légèrement supérieur à 100).&lt;br&gt;Attention, le nombre de tuples « fetched » ne correspond pas forcément au nombre de tuples retournés au clients ce qui est interessant ici c&amp;rsquo;est bien le rapport entre les deux valeurs.&lt;br&gt;Attention, la valeur porte sur la base entière, il conviendra ensuite d&amp;rsquo;auditer les requêtes pour identifier l&amp;rsquo;origine du manque d&amp;rsquo;indexation.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;pg_stat_database_blks_hit&lt;/code&gt; et &lt;code&gt;pg_stat_database_blks_read&lt;/code&gt; : le nombre de blocs lu sur le disque (read) par rapport au nombre de bloc lu dans la mémoire tampon (hit).&lt;br&gt;Cela permet de détecter un éventuel manque de ressources pour la mémoire tampon (paramètre shared buffer).&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;pg_stat_user_tables_n_dead_tup&lt;/code&gt; : le nombre de tuples mort (dead tuple).&lt;br&gt;Cela permet de surveiller le bon fonctionnement du processus de VACUUM.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Attention, Postgres Exporter se focalise sur une seule base de données et ne permet donc pas d&amp;rsquo;avoir certaines métriques en « multibase », sur l&amp;rsquo;instance complète (en fait si mais « c&amp;rsquo;est compliqué » et non recommandé). Il faudrait ainsi avoir plusieurs Postgres Exporter en parallèle, un pour chaque base d&amp;rsquo;une instance&amp;#8230; Je complèterai cet article lorsque j&amp;rsquo;aurai identifié une solution (sous peu j&amp;rsquo;espère)&amp;#8230;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;D&amp;rsquo;autres métriques sont intéressantes, notamment si vous avez mis en place de la réplication. Voici quelques ressources utiles :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;Une liste détaillée de métriques : &lt;a href=&#34;https://www.datadoghq.com/blog/postgresql-monitoring&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;https://www.datadoghq.com/blog/postgresql-monitoring&lt;/a&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Une autre liste de métriques : &lt;a href=&#34;https://sysdig.com/blog/postgresql-monitoring/&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;https://sysdig.com/blog/postgresql-monitoring/&lt;/a&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Des exemples de tableaux de bord : &lt;a href=&#34;https://promcat.io/apps/postgresql/latest&#34;&gt;https://promcat.io/apps/postgresql/latest&lt;/a&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Les tableau de bord préconstruits pour Grafana : &lt;a href=&#34;https://grafana.com/grafana/dashboards/?search=postgresql&#34;&gt;https://grafana.com/grafana/dashboards/?search=postgresql&lt;/a&gt;&lt;br&gt;On y trouve beaucoup d&amp;rsquo;exemples et de bonnes idées.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Retrouvez également quelques éléments dans l&amp;rsquo;article suivant :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure class=&#34;wp-block-embed is-type-wp-embed is-provider-bazinga-039-s wp-block-embed-bazinga-039-s&#34;&gt;&lt;div class=&#34;wp-block-embed__wrapper&#34;&gt;&#xA;&lt;blockquote class=&#34;wp-embedded-content&#34; data-secret=&#34;2qLbf2cgdB&#34;&gt;&lt;a href=&#34;https://blog.arthurbazin.com/programmation/postgresql-vade-mecum-7&#34;&gt;PostgreSQL &amp;#8211; Vade-mecum SQL &amp;#8211; 7/8 &amp;#8211; Administration serveur&lt;/a&gt;&lt;/blockquote&gt;&lt;iframe loading=&#34;lazy&#34; class=&#34;wp-embedded-content&#34; sandbox=&#34;allow-scripts&#34; security=&#34;restricted&#34;  title=&#34;« PostgreSQL &amp;#8211; Vade-mecum SQL &amp;#8211; 7/8 &amp;#8211; Administration serveur » &amp;#8212; BazinGa&amp;#039;s&#34; src=&#34;https://blog.arthurbazin.com/programmation/postgresql-vade-mecum-7/embed#?secret=hIDLWEJ0Nz#?secret=2qLbf2cgdB&#34; data-secret=&#34;2qLbf2cgdB&#34; width=&#34;600&#34; height=&#34;338&#34; frameborder=&#34;0&#34; marginwidth=&#34;0&#34; marginheight=&#34;0&#34; scrolling=&#34;no&#34;&gt;&lt;/iframe&gt;&#xA;&lt;/div&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Pour les serveurs Windows et Linux, cela dépendra également ce que vous faites avec ceux-ci. Voici ce que je surveille à minima :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;La charge CPU&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;La consommation de mémoire RAM&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;La consommation d&amp;rsquo;espace disque&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;La quantité d&amp;rsquo;écriture et de lecture sur le disque et leur rapidité (i/o).&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Eventuellement le nombre d&amp;rsquo;utilisateur connectés pour un Windows.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;</content>
    <link href="https://blog.arthurbazin.com/it/monitorer-postgresql-avec-prometheus-et-grafana" rel="alternate"></link>
    <summary type="html">Monitorez votre instance PostgreSQL avec Postgres Exporter, Prometheus et Grafana.</summary>
    <author>
      <name>Arthur Bazin</name>
    </author>
  </entry>
  <entry>
    <title>Stockage physique, gestion des données et VACUUM</title>
    <updated>2024-02-03T13:32:02Z</updated>
    <id>tag:blog.arthurbazin.com,2024-02-03:/bdd/postgresql/stockage-physique-gestion-des-donnees-et-vacuum</id>
    <content type="html">&#xA;&lt;p&gt;En SIG, on oppose souvent le stockage sous forme de fichiers plats au stockage en base de données. Mais comment fait PostgreSQL pour stocker réellement les données ? Et bien il utilise des fichiers plats&amp;#8230; (le serpent se mort la queue). Nous allons donc démystifier un peu ce fonctionnement.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Autre question que j&amp;rsquo;ai pu avoir en lien avec le stockage : pourquoi après avoir fait du nettoyage dans une base de données, l&amp;rsquo;espace disque n&amp;rsquo;avait pas franchement diminué, y compris après avoir utilisé la commande &lt;code&gt;VACUUM&lt;/code&gt; ? Nous allons voir d&amp;rsquo;où provient ce comportement.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Notez que je prendrais parfois quelques raccourcis pour pour simplifier les explications. Nous ne parlerons également que des tables et non des index.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 class=&#34;wp-block-heading&#34;&gt;Fonctions personnalisées&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Pour nous aider dans notre quête, nous allons avoir besoin d&amp;rsquo;extensions spécifiques et de fonctions créées pour l&amp;rsquo;occasion. Les voici, vous pourrez les décortiquer une fois que vous aurez lu l&amp;rsquo;article :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;extension&#34; data-enlighter-group=&#34;install&#34;&gt;-- Ajout des extensions&#xA;CREATE EXTENSION pgstattuple;&#xA;CREATE EXTENSION pageinspect;&#xA;CREATE EXTENSION pg_freespacemap;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;table_info()&#34; data-enlighter-group=&#34;install&#34;&gt;-- Fonction de récupération des informations sur les pages d&#39;une table&#xA;DROP FUNCTION IF EXISTS public.get_table_info(relname TEXT);&#xA;&#xA;CREATE OR REPLACE FUNCTION public.get_table_info(relname TEXT)&#xA;RETURNS TABLE(&#xA;  &#34;schema&#34; text,&#xA;  &#34;table&#34; text,&#xA;  &#34;tablespace&#34; text,&#xA;  oid_table oid,&#xA;  numero_heap_file oid,&#xA;  heap_file_segment_0_location text,&#xA;  nb_page bigint,&#xA;  tuple_count bigint,&#xA;  dead_tuple_count bigint,&#xA;  table_length bigint,&#xA;  table_length_human text,&#xA;  tuple_length bigint,&#xA;  tuple_percent numeric,&#xA;  dead_tuple_length bigint,&#xA;  dead_tuple_percent numeric,&#xA;  free_space_length bigint,&#xA;  free_space_percent numeric,&#xA;  max_frozen_txid xid,&#xA;  n_tup_ins bigint,&#xA;  n_tup_upd bigint,&#xA;  n_tup_del bigint,&#xA;  n_mod_since_analyze bigint,&#xA;  n_ins_since_vacuum bigint,&#xA;  last_vacuum timestamp with time zone, &#xA;  last_autovacuum timestamp with time zone, &#xA;  last_analyze timestamp with time zone,&#xA;  last_autoanalyze timestamp with time zone,&#xA;  toast_oid oid,&#xA;  toast_table text,&#xA;  toast_heap_file_segment_0_location text,&#xA;  toast_nb_page bigint,&#xA;  toast_nb_tuple bigint,&#xA;  toast_length bigint,&#xA;  toast_length_human text&#xA;)&#xA;AS $function$&#xA;/*&#xA; * FUNCTION table_info(relname TEXT)&#xA; * Renvoi différentes informations sur une table et son stockage&#xA; * &#xA; * PARAMETERS&#xA; *  relname TEXT : objet à analyser au choix :&#xA; *    - &#39;schema.Table&#39; : pour analyser une table en particulier.&#xA; *    - &#39;schema&#39; : pour analyser toutes les tables d&#39;un schéma.&#xA; *    Les noms d&#39;objet n&#39;ont pas besoin d&#39;être quotés.&#xA; * &#xA; */&#xA;DECLARE &#xA;  var_requete TEXT;&#xA;  schemaname TEXT;&#xA;  table_schema record;&#xA;  schema_check boolean DEFAULT FALSE;&#xA;  where_clause TEXT;&#xA;&#xA;BEGIN&#xA;  &#xA;  -- Nettoyage du nom d&#39;objet&#xA;  relname := replace(relname, &#39;&#34;&#39;, &#39;&#39;);&#xA;  &#xA;&#xA;&#xA;  -- L&#39;analyse porte-elle sur un schéma ?&#xA;  var_requete := &#xA;    $a$SELECT &#xA;      TRUE&#xA;    FROM &#xA;      information_schema.schemata&#xA;    WHERE &#xA;      schema_name = $a$ || quote_literal(relname)&#xA;  ;&#xA;&#xA;  EXECUTE &#xA;    var_requete&#xA;  INTO &#xA;    schema_check&#xA;  ;&#xA;  &#xA;&#xA;  &#xA;  -- Action selon si schema/table&#xA;  IF schema_check THEN&#xA;  &#xA;    RAISE NOTICE USING message = &#39;ANALYZE for schema&#39;;&#xA;    &#xA;    -- Clause de récupération des données d&#39;un schéma&#xA;    where_clause := &#xA;      $a$pgc.relnamespace = $a$ || quote_literal(relname) || $a$::regnamespace $a$&#xA;    ;&#xA;  &#xA;    -- Boucle sur toutes les tables d&#39;un schema&#xA;    var_requete := &#xA;      $a$SELECT&#xA;        pgc.relname::TEXT AS &#34;table&#34;&#xA;      FROM&#xA;        pg_class AS pgc&#xA;      WHERE &#xA;        $a$ || where_clause&#xA;    ;&#xA;  &#xA;    --RAISE NOTICE USING MESSAGE = var_requete;&#xA;  &#xA;    FOR table_schema IN EXECUTE var_requete&#xA;        &#xA;    LOOP&#xA;      &#xA;      var_requete := &#xA;        $a$ANALYZE $a$ || quote_ident(relname) || &#39;.&#39; || quote_ident(table_schema.&#34;table&#34;)&#xA;      ;&#xA;      &#xA;      --RAISE NOTICE USING MESSAGE = var_requete;&#xA;&#xA;        -- Analyse de la table&#xA;      EXECUTE &#xA;        var_requete&#xA;      ;&#xA;      &#xA;      &#xA;    END LOOP;&#xA;    &#xA;  &#xA;  ELSE &#xA;  &#xA;    RAISE NOTICE USING message = &#39;ANALYZE for table&#39;;&#xA;  &#xA;    -- Quotation du schema.table&#xA;    relname := &#xA;      quote_ident((regexp_match(relname, &#39;(.*)\..+&#39;))[1]) || &#xA;      &#39;.&#39; || &#xA;      quote_ident((regexp_match(relname, &#39;.*\.(.+)&#39;))[1])&#xA;    ;&#xA;  &#xA;    -- Clause de récuépration d&#39;une table&#xA;    where_clause :=&#xA;      $a$pgc.oid = $a$ || quote_literal(relname) || $a$::regclass $a$&#xA;    ;&#xA;&#xA;    -- Analyse de la table&#xA;    EXECUTE &#xA;      $a$ANALYZE $a$ || relname&#xA;    ;&#xA;  &#xA;  END IF;&#xA;&#xA;&#xA;  &#xA;  -- Renvoi des statistiques&#xA;  var_requete := &#xA;    $a$SELECT &#xA;      pgc.relnamespace::regnamespace::text AS &#34;schema&#34;,&#xA;      pgc.relname::text AS &#34;table&#34;,&#xA;      COALESCE (pgt.spcname, &#39;pg_default&#39;)::TEXT AS &#34;tablespace&#34;,&#xA;      pgc.oid AS oid_table,&#xA;      pg_relation_filenode(pgc.oid) AS numero_heap_file,&#xA;      current_setting(&#39;data_directory&#39;) || &#39;/&#39; || pg_relation_filepath(pgc.oid) AS &#34;heap_file_segment_0_location&#34;,&#xA;      pgc.relpages::int AS nb_page,&#xA;      pst.tuple_count::bigint,&#xA;      pst.dead_tuple_count::bigint,&#xA;      pst.table_len::bigint AS table_length,&#xA;      pg_size_pretty(pst.table_len) AS table_length_human,&#xA;      pst.tuple_len::bigint AS tuple_length,&#xA;      pst.tuple_percent::numeric,&#xA;      pst.dead_tuple_len::bigint AS dead_tuple_length,&#xA;      pst.dead_tuple_percent::numeric,&#xA;      pst.free_space::bigint AS free_space_length,&#xA;      pst.free_percent::NUMERIC AS free_space_percent,&#xA;      pgc.relfrozenxid AS max_frozen_txid,&#xA;      psut.n_tup_ins::bigint,&#xA;      psut.n_tup_upd::bigint,&#xA;      psut.n_tup_del::bigint,&#xA;      psut.n_mod_since_analyze::bigint,&#xA;      psut.n_ins_since_vacuum::bigint,&#xA;      psut.last_vacuum, &#xA;      psut.last_autovacuum, &#xA;      psut.last_analyze,&#xA;      psut.last_autoanalyze,&#xA;      pgc.reltoastrelid AS toast_oid,&#xA;      pgct.relname::text AS toast_table,&#xA;      current_setting(&#39;data_directory&#39;) || &#39;/&#39; || pg_relation_filepath(pgct.oid) AS &#34;toast_heap_file_segment_0_location&#34;,&#xA;      pgct.relpages::int AS toast_nb_page,&#xA;      pgct.reltuples::int AS toast_nb_tuple,&#xA;      pg_relation_size(pgc.reltoastrelid)::bigint AS toast_length,&#xA;      pg_size_pretty(pg_relation_size(pgc.reltoastrelid))::text AS toast_length_human&#xA;    FROM &#xA;      pg_class AS pgc&#xA;    LEFT JOIN &#xA;      pg_tablespace AS pgt &#xA;      ON pgt.oid = pgc.reltablespace &#xA;    LEFT JOIN &#xA;      pg_class AS pgct &#xA;      ON pgct.oid = pgc.reltoastrelid&#xA;    LEFT JOIN&#xA;      pg_stat_user_tables AS psut&#xA;      ON psut.relid = pgc.oid&#xA;    LEFT JOIN LATERAL&#xA;      pgstattuple(pgc.oid::regclass::text) AS pst&#xA;      ON TRUE&#xA;    WHERE &#xA;      $a$ || where_clause&#xA;    ;&#xA;  &#xA;    --RAISE NOTICE USING MESSAGE = var_requete;&#xA;    &#xA;    RETURN QUERY EXECUTE &#xA;      var_requete&#xA;    ;&#xA;&#xA;    RETURN;&#xA;END&#xA;$function$&#xA;LANGUAGE PLPGSQL&#xA;;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;table_info() (PG &lt; 12)&#34; data-enlighter-group=&#34;install&#34;&gt;-- Fonction de récupération des informations sur les pages d&#39;une table&#xA;DROP FUNCTION IF EXISTS public.get_table_info(relname TEXT);&#xA;&#xA;CREATE OR REPLACE FUNCTION public.get_table_info(relname TEXT)&#xA;RETURNS TABLE(&#xA;  &#34;schema&#34; text,&#xA;  &#34;table&#34; text,&#xA;  &#34;tablespace&#34; text,&#xA;  oid_table oid,&#xA;  numero_heap_file oid,&#xA;  heap_file_segment_0_location text,&#xA;  nb_page bigint,&#xA;  tuple_count bigint,&#xA;  dead_tuple_count bigint,&#xA;  table_length bigint,&#xA;  table_length_human text,&#xA;  tuple_length bigint,&#xA;  tuple_percent numeric,&#xA;  dead_tuple_length bigint,&#xA;  dead_tuple_percent numeric,&#xA;  free_space_length bigint,&#xA;  free_space_percent numeric,&#xA;  max_frozen_txid xid,&#xA;  n_tup_ins bigint,&#xA;  n_tup_upd bigint,&#xA;  n_tup_del bigint,&#xA;  n_mod_since_analyze bigint,&#xA;  last_vacuum timestamp with time zone, &#xA;  last_autovacuum timestamp with time zone, &#xA;  last_analyze timestamp with time zone,&#xA;  last_autoanalyze timestamp with time zone,&#xA;  toast_oid oid,&#xA;  toast_table text,&#xA;  toast_heap_file_segment_0_location text,&#xA;  toast_nb_page bigint,&#xA;  toast_nb_tuple bigint,&#xA;  toast_length bigint,&#xA;  toast_length_human text&#xA;)&#xA;AS $function$&#xA;/*&#xA; * FUNCTION table_info(relname TEXT)&#xA; * Renvoi différentes informations sur une table et son stockage&#xA; * &#xA; * PARAMETERS&#xA; *  relname TEXT : objet à analyser au choix :&#xA; *    - &#39;schema.Table&#39; : pour analyser une table en particulier.&#xA; *    - &#39;schema&#39; : pour analyser toutes les tables d&#39;un schéma.&#xA; *    Les noms d&#39;objet n&#39;ont pas besoin d&#39;être quotés.&#xA; * &#xA; */&#xA;DECLARE &#xA;  var_requete TEXT;&#xA;  schemaname TEXT;&#xA;  table_schema record;&#xA;  schema_check boolean DEFAULT FALSE;&#xA;  where_clause TEXT;&#xA;&#xA;BEGIN&#xA;  &#xA;  -- Nettoyage du nom d&#39;objet&#xA;  relname := replace(relname, &#39;&#34;&#39;, &#39;&#39;);&#xA;  &#xA;&#xA;&#xA;  -- L&#39;analyse porte-elle sur un schéma ?&#xA;  var_requete := &#xA;    $a$SELECT &#xA;      TRUE&#xA;    FROM &#xA;      information_schema.schemata&#xA;    WHERE &#xA;      schema_name = $a$ || quote_literal(relname)&#xA;  ;&#xA;&#xA;  EXECUTE &#xA;    var_requete&#xA;  INTO &#xA;    schema_check&#xA;  ;&#xA;  &#xA;&#xA;  &#xA;  -- Action selon si schema/table&#xA;  IF schema_check THEN&#xA;  &#xA;    RAISE NOTICE USING message = &#39;ANALYZE for schema&#39;;&#xA;    &#xA;    -- Clause de récupération des données d&#39;un schéma&#xA;    where_clause := &#xA;      $a$pgc.relnamespace = $a$ || quote_literal(relname) || $a$::regnamespace $a$&#xA;    ;&#xA;  &#xA;    -- Boucle sur toutes les tables d&#39;un schema&#xA;    var_requete := &#xA;      $a$SELECT&#xA;        pgc.relname::TEXT AS &#34;table&#34;&#xA;      FROM&#xA;        pg_class AS pgc&#xA;      WHERE &#xA;        $a$ || where_clause&#xA;    ;&#xA;  &#xA;    --RAISE NOTICE USING MESSAGE = var_requete;&#xA;  &#xA;    FOR table_schema IN EXECUTE var_requete&#xA;        &#xA;    LOOP&#xA;      &#xA;      var_requete := &#xA;        $a$ANALYZE $a$ || quote_ident(relname) || &#39;.&#39; || quote_ident(table_schema.&#34;table&#34;)&#xA;      ;&#xA;      &#xA;      --RAISE NOTICE USING MESSAGE = var_requete;&#xA;&#xA;        -- Analyse de la table&#xA;      EXECUTE &#xA;        var_requete&#xA;      ;&#xA;      &#xA;      &#xA;    END LOOP;&#xA;    &#xA;  &#xA;  ELSE &#xA;  &#xA;    RAISE NOTICE USING message = &#39;ANALYZE for table&#39;;&#xA;  &#xA;    -- Quotation du schema.table&#xA;    relname := &#xA;      quote_ident((regexp_match(relname, &#39;(.*)\..+&#39;))[1]) || &#xA;      &#39;.&#39; || &#xA;      quote_ident((regexp_match(relname, &#39;.*\.(.+)&#39;))[1])&#xA;    ;&#xA;  &#xA;    -- Clause de récuépration d&#39;une table&#xA;    where_clause :=&#xA;      $a$pgc.oid = $a$ || quote_literal(relname) || $a$::regclass $a$&#xA;    ;&#xA;&#xA;    -- Analyse de la table&#xA;    EXECUTE &#xA;      $a$ANALYZE $a$ || relname&#xA;    ;&#xA;  &#xA;  END IF;&#xA;&#xA;&#xA;  &#xA;  -- Renvoi des statistiques&#xA;  var_requete := &#xA;    $a$SELECT &#xA;      pgc.relnamespace::regnamespace::text AS &#34;schema&#34;,&#xA;      pgc.relname::text AS &#34;table&#34;,&#xA;      COALESCE (pgt.spcname, &#39;pg_default&#39;)::TEXT AS &#34;tablespace&#34;,&#xA;      pgc.oid AS oid_table,&#xA;      pg_relation_filenode(pgc.oid) AS numero_heap_file,&#xA;      current_setting(&#39;data_directory&#39;) || &#39;/&#39; || pg_relation_filepath(pgc.oid) AS &#34;heap_file_segment_0_location&#34;,&#xA;      pgc.relpages::int AS nb_page,&#xA;      pst.tuple_count::bigint,&#xA;      pst.dead_tuple_count::bigint,&#xA;      pst.table_len::bigint AS table_length,&#xA;      pg_size_pretty(pst.table_len) AS table_length_human,&#xA;      pst.tuple_len::bigint AS tuple_length,&#xA;      pst.tuple_percent::numeric,&#xA;      pst.dead_tuple_len::bigint AS dead_tuple_length,&#xA;      pst.dead_tuple_percent::numeric,&#xA;      pst.free_space::bigint AS free_space_length,&#xA;      pst.free_percent::NUMERIC AS free_space_percent,&#xA;      pgc.relfrozenxid AS max_frozen_txid,&#xA;      psut.n_tup_ins::bigint,&#xA;      psut.n_tup_upd::bigint,&#xA;      psut.n_tup_del::bigint,&#xA;      psut.n_mod_since_analyze::bigint,&#xA;      psut.last_vacuum, &#xA;      psut.last_autovacuum, &#xA;      psut.last_analyze,&#xA;      psut.last_autoanalyze,&#xA;      pgc.reltoastrelid AS toast_oid,&#xA;      pgct.relname::text AS toast_table,&#xA;      current_setting(&#39;data_directory&#39;) || &#39;/&#39; || pg_relation_filepath(pgct.oid) AS &#34;toast_heap_file_segment_0_location&#34;,&#xA;      pgct.relpages::int AS toast_nb_page,&#xA;      pgct.reltuples::int AS toast_nb_tuple,&#xA;      pg_relation_size(pgc.reltoastrelid)::bigint AS toast_length,&#xA;      pg_size_pretty(pg_relation_size(pgc.reltoastrelid))::text AS toast_length_human&#xA;    FROM &#xA;      pg_class AS pgc&#xA;    LEFT JOIN &#xA;      pg_tablespace AS pgt &#xA;      ON pgt.oid = pgc.reltablespace &#xA;    LEFT JOIN &#xA;      pg_class AS pgct &#xA;      ON pgct.oid = pgc.reltoastrelid&#xA;    LEFT JOIN&#xA;      pg_stat_user_tables AS psut&#xA;      ON psut.relid = pgc.oid&#xA;    LEFT JOIN LATERAL&#xA;      pgstattuple(pgc.oid::regclass::text) AS pst&#xA;      ON TRUE&#xA;    WHERE &#xA;      $a$ || where_clause&#xA;    ;&#xA;  &#xA;    --RAISE NOTICE USING MESSAGE = var_requete;&#xA;    &#xA;    RETURN QUERY EXECUTE &#xA;      var_requete&#xA;    ;&#xA;&#xA;    RETURN;&#xA;END&#xA;$function$&#xA;LANGUAGE PLPGSQL&#xA;;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;heap_page_info()&#34; data-enlighter-group=&#34;install&#34;&gt;-- Fonction de récupération des informations sur les pages d&#39;une table&#xA;DROP FUNCTION IF EXISTS public.get_heap_page_info(relname TEXT, page_number INT);&#xA;&#xA;CREATE OR REPLACE FUNCTION public.get_heap_page_info(relname TEXT, page_number INT DEFAULT -1)&#xA;RETURNS TABLE(&#xA;  page_num int,&#xA;  lsn pg_lsn, &#xA;  nb_pointer int,&#xA;  nb_tuple int,&#xA;  nb_tuple_visible int,&#xA;  length_header int,&#xA;  length_pointer int,&#xA;  length_free_space int,&#xA;  length_tuple int,&#xA;  length_meta int,&#xA;  length_data int,&#xA;  length_empty int,&#xA;  length_special int,&#xA;  offset_pointer int,&#xA;  offset_free_space int,&#xA;  offset_data int,&#xA;  offset_special int,&#xA;  offset_page_end int,&#xA;  unused_line_pointer bool,&#xA;  no_free_space bool,&#xA;  all_visible bool&#xA;)&#xA;AS $function$&#xA;/*&#xA; * FUNCTION heap_page_info(relname TEXT, page_number INT)&#xA; * Renvoi différentes informations sur les pages d&#39;une table&#xA; * &#xA; * PARAMETERS&#xA; *  relname TEXT : table à analyser préfixée par son schéma.&#xA; *    Les noms d&#39;objet n&#39;ont pas besoin d&#39;être quotés.&#xA; *  page_number INT : (facultatif) numéro de page à analyser.&#xA; *    Sans ce paramètre, toutes les pages sont remontées&#xA; * &#xA; */&#xA;BEGIN&#xA;  -- Quotation du schema.table&#xA;  relname := replace(relname, &#39;&#34;&#39;, &#39;&#39;);&#xA;  relname := &#xA;    quote_ident((regexp_match(relname, &#39;(.*)\..+&#39;))[1]) || &#xA;    &#39;.&#39; || &#xA;    quote_ident((regexp_match(relname, &#39;.*\.(.+)&#39;))[1])&#xA;  ;&#xA;  &#xA;  &#xA;  -- Analyse de la table&#xA;  EXECUTE &#xA;    $a$ANALYZE $a$ || relname ;&#xA;&#xA;&#xA;  &#xA;  -- Renvoi des statistiques&#xA;  RETURN QUERY EXECUTE &#xA;    $a$SELECT&#xA;      pages.page_num,&#xA;      -- Identifiant xlog de la dernière opération effectuée sur la page.&#xA;      ph.lsn,&#xA;      tm.count_pointer::int AS nb_pointer,&#xA;      tm.count_tuple::int AS nb_tuple,&#xA;      tm.count_tuple_visible::int AS nb_tuple_visible,&#xA;      24::int AS length_header,&#xA;      (ph.lower - 24)::int AS length_pointer,&#xA;      (ph.upper - ph.lower)::int AS length_free_space,&#xA;      (ph.special - ph.upper)::int AS length_tuple,&#xA;      (tm.length_meta)::int,&#xA;      (tm.length_data)::int,&#xA;      (tm.length_empty)::int,&#xA;      (ph.pagesize - ph.special)::int AS length_special,&#xA;      24::int AS offset_pointer,&#xA;      (ph.lower)::int AS offset_free_space,&#xA;      (ph.upper)::int AS offset_data,&#xA;      (ph.special)::int AS offset_special,&#xA;      (ph.pagesize)::int AS offset_page_end,&#xA;      CASE &#xA;        WHEN (ph.flags::int::bit(16) &amp;amp; x&#39;0001&#39;) = (x&#39;0001&#39;)&#xA;          THEN TRUE&#xA;        ELSE FALSE&#xA;      END AS unused_line_pointer,&#xA;      CASE &#xA;        WHEN (ph.flags::int::bit(16) &amp;amp; x&#39;0002&#39;) = (x&#39;0002&#39;)&#xA;          THEN TRUE&#xA;        ELSE FALSE&#xA;      END AS no_free_space,&#xA;      CASE &#xA;        WHEN (ph.flags::int::bit(16) &amp;amp; x&#39;0004&#39;) = (x&#39;0004&#39;)&#xA;          THEN TRUE&#xA;        ELSE FALSE&#xA;      END AS all_visible&#xA;    FROM &#xA;      pg_catalog.pg_class AS pgc&#xA;    LEFT JOIN LATERAL &#xA;        generate_series(0, pgc.relpages - 1) AS pages(page_num)&#xA;        ON TRUE&#xA;    LEFT JOIN LATERAL&#xA;        page_header(&#xA;          get_raw_page(pgc.oid::regclass::text, pages.page_num)&#xA;        ) AS ph&#xA;        ON TRUE&#xA;    LEFT JOIN LATERAL (&#xA;        SELECT&#xA;          -- Nombre de pointeur&#xA;          count(1) AS count_pointer,&#xA;          -- Nombre de tuples&#xA;          count(&#xA;            CASE &#xA;              WHEN hpi.lp_len &gt; 0 THEN 1&#xA;            END&#xA;          ) AS count_tuple,&#xA;          -- Nombre de tuples visibles&#xA;          count(&#xA;            CASE &#xA;              WHEN (t_infomask::int::bit(16) &amp;amp; x&#39;0F00&#39;) = (x&#39;0100&#39;)  &#xA;              OR   (t_infomask::int::bit(16) &amp;amp; x&#39;0F00&#39;) = (x&#39;0100&#39; | x&#39;0800&#39;)&#xA;              OR   (t_infomask::int::bit(16) &amp;amp; x&#39;0F00&#39;) = (x&#39;0100&#39; | x&#39;0200&#39; | x&#39;0800&#39;)&#xA;                THEN 1&#xA;            END&#xA;          ) AS count_tuple_visible,&#xA;          -- Longueur des métadonnées&#xA;          sum(hpi.t_hoff::int) AS length_meta,&#xA;          -- Longueur des données&#xA;          sum((hpi.lp_len - hpi.t_hoff)::int) AS length_data,&#xA;          -- Longueur des espaces vides&#xA;          sum(((ceil((hpi.lp_off + hpi.lp_len)::numeric / 8) * 8) - (hpi.lp_off + hpi.lp_len))::int) AS length_empty&#xA;        FROM&#xA;          heap_page_items(&#xA;            get_raw_page(pgc.oid::regclass::text, pages.page_num)&#xA;          ) AS hpi &#xA;        ) AS tm&#xA;        ON TRUE&#xA;    WHERE &#xA;      pgc.oid = $a$ || quote_literal(relname) || $a$::regclass &#xA;    AND (&#xA;      (&#xA;        $a$ || page_number || $a$ &amp;lt;&gt; -1&#xA;        AND&#xA;        $a$ || page_number || $a$ = pages.page_num&#xA;      )OR &#xA;      $a$ || page_number || $a$ = - 1&#xA;    ) $a$&#xA;    ;&#xA;&#xA;    RETURN;&#xA;END&#xA;$function$&#xA;LANGUAGE PLPGSQL&#xA;;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;heap_tuple_info()&#34; data-enlighter-group=&#34;install&#34;&gt;-- Fonction de récupération des informations sur les tuples&#xA;DROP FUNCTION IF EXISTS public.get_heap_tuple_info(relname text);&#xA;&#xA;CREATE OR REPLACE FUNCTION public.get_heap_tuple_info(relname TEXT, page_number INT DEFAULT -1)&#xA;RETURNS TABLE(&#xA;  ctid tid, &#xA;  page_num int,&#xA;  page_index int, &#xA;  offset_start int,&#xA;  offset_end int,&#xA;  offset_next int,&#xA;  length_tuple int,&#xA;  length_meta int,&#xA;  length_data int,&#xA;  length_empty int,&#xA;  xmin text, &#xA;  xmax text, &#xA;  state text,&#xA;  visible bool,&#xA;  &#34;update&#34; bool,&#xA;  direction text,&#xA;  hot bool,&#xA;  &#34;delete&#34; bool, &#xA;  &#34;freeze&#34; bool,&#xA;  info text[]&#xA;)&#xA;AS $function$&#xA;/*&#xA; * FUNCTION heap_tuple_info(relname TEXT, page_number INT)&#xA; * Renvoi différentes informations sur les tuples présents dans les pages d&#39;une table&#xA; * &#xA; * PARAMETERS&#xA; *  relname TEXT : table à analyser préfixée par son schéma.&#xA; *    Les noms d&#39;objet n&#39;ont pas besoin d&#39;être quotés.&#xA; *  page_number INT : (facultatif) numéro de page à analyser.&#xA; *    Sans ce paramètre, tous les tuples de toutes les pages sont remontés&#xA; * &#xA; */&#xA;BEGIN&#xA;  -- Quotation du schema.table&#xA;  relname := replace(relname, &#39;&#34;&#39;, &#39;&#39;);&#xA;  relname := &#xA;    quote_ident((regexp_match(relname, &#39;(.*)\..+&#39;))[1]) || &#xA;    &#39;.&#39; || &#xA;    quote_ident((regexp_match(relname, &#39;.*\.(.+)&#39;))[1])&#xA;  ;&#xA;  &#xA;  -- Analyse de la table&#xA;  EXECUTE &#xA;    $a$ANALYZE $a$ || relname ;&#xA;  &#xA;&#xA;  &#xA;  -- Renvoi des statistiques&#xA;  RETURN QUERY EXECUTE &#xA;    $a$SELECT&#xA;      -- Indentifiant du tuple&#xA;      hpi.t_ctid AS ctid,&#xA;      -- Numéro de page&#xA;      pages.page_num,&#xA;      -- Index dans la page&#xA;      hpi.lp::int AS page_index,&#xA;      -- Début du tuple dans la page&#xA;      hpi.lp_off::int AS offset_start,&#xA;      -- Fin du tuple dans la page&#xA;      (hpi.lp_off + hpi.lp_len)::int AS offset_end,&#xA;      -- Début du tuple suivant dans la page&#xA;      (ceil((hpi.lp_off + hpi.lp_len)::numeric / 8) * 8)::int AS offset_next,&#xA;      -- Longueur du tuple&#xA;      hpi.lp_len::int AS length_tuple,&#xA;      -- Longueur des métadonnées&#xA;      hpi.t_hoff::int AS length_meta,&#xA;      -- Longueur des données&#xA;      (hpi.lp_len - hpi.t_hoff)::int AS length_data,&#xA;      -- Longueur de l&#39;espacement avant le tuple suivant&#xA;      ((ceil((hpi.lp_off + hpi.lp_len)::numeric / 8) * 8) - (hpi.lp_off + hpi.lp_len))::int AS length_empty,&#xA;      -- ID de transaction de début de vie&#xA;      --    c : transaction commitée&#xA;      --    a : transaction annulée&#xA;      concat(&#xA;        hpi.t_xmin,&#xA;        CASE &#xA;          WHEN ((t_infomask::int::bit(16) &amp;amp; x&#39;0F00&#39;) &amp;amp; (x&#39;0100&#39; | x&#39;0200&#39;)) = (x&#39;0100&#39; | x&#39;0200&#39;) THEN &#39; - f&#39;&#xA;          WHEN (t_infomask::int::bit(16) &amp;amp; x&#39;0100&#39;) = x&#39;0100&#39; THEN &#39; - c&#39;&#xA;          WHEN (t_infomask::int::bit(16) &amp;amp; x&#39;0200&#39;) = x&#39;0200&#39; THEN &#39; - a&#39;&#xA;        END&#xA;      ) AS xmin,&#xA;      -- ID de transaction de fin de vie&#xA;      --    c : transaction commitée&#xA;      --    a : transaction annulée&#xA;      NULLIF(&#xA;        concat(&#xA;          hpi.t_xmax,&#xA;          CASE &#xA;            WHEN (t_infomask::int::bit(16) &amp;amp; x&#39;0400&#39;) = x&#39;0400&#39; THEN &#39; - c&#39;&#xA;            WHEN (t_infomask::int::bit(16) &amp;amp; x&#39;0800&#39;) = x&#39;0800&#39; THEN &#39; - a&#39;&#xA;          END&#xA;        ),&#xA;        &#39;0 - a&#39;&#xA;      ) AS xmax,&#xA;      -- Etat de la ligne&#xA;      CASE lp_flags&#xA;        WHEN 0 THEN &#39;unused&#39;&#xA;        WHEN 1 THEN &#39;normal&#39;&#xA;        WHEN 2 THEN &#39;redirect to &#39;||lp_off&#xA;        WHEN 3 THEN &#39;dead&#39;&#xA;      END AS state,&#xA;      -- Visibilité actuelle du tuple&#xA;      CASE &#xA;        WHEN (t_infomask::int::bit(16) &amp;amp; x&#39;0F00&#39;) = (x&#39;0100&#39;)  &#xA;        OR   (t_infomask::int::bit(16) &amp;amp; x&#39;0F00&#39;) = (x&#39;0100&#39; | x&#39;0800&#39;)&#xA;          THEN TRUE&#xA;        WHEN (t_infomask::int::bit(16) &amp;amp; x&#39;0F00&#39;) = (x&#39;0200&#39;) &#xA;        OR   (t_infomask::int::bit(16) &amp;amp; x&#39;0F00&#39;) = (x&#39;0100&#39; | x&#39;0200&#39; | x&#39;0800&#39;)  &#xA;        OR   (t_infomask::int::bit(16) &amp;amp; x&#39;0F00&#39;) = (x&#39;0000&#39;) &#xA;        OR   (t_infomask::int::bit(16) &amp;amp; x&#39;0F00&#39;) = (x&#39;0100&#39; | x&#39;0400&#39;) &#xA;          THEN FALSE&#xA;        ELSE FALSE&#xA;      END AS visible,&#xA;      -- Tuple concerné par un UPDATE&#xA;      CASE &#xA;        WHEN (t_infomask::int::bit(16) &amp;amp; x&#39;F000&#39;) = (x&#39;2000&#39;)&#xA;        OR t_infomask IS NULL &#xA;        OR ((t_infomask2::int::bit(16) &amp;amp; x&#39;F000&#39;) &amp;amp; (x&#39;4000&#39;)) = (x&#39;4000&#39;)&#xA;        OR ((t_infomask::int::bit(16) &amp;amp; x&#39;0F00&#39;) = (x&#39;0100&#39; | x&#39;0400&#39;) AND NOT (t_infomask2::int::bit(16) &amp;amp; x&#39;F000&#39;) = (x&#39;2000&#39;))&#xA;          THEN TRUE&#xA;        ELSE FALSE&#xA;      END AS &#34;update&#34;,&#xA;      -- Si concerné par un UPDATE, tuple initial (to) ou final (from)&#xA;      NULLIF(&#xA;        concat_ws(&#xA;          &#39; and &#39;,&#xA;          CASE &#xA;            WHEN (t_infomask::int::bit(16) &amp;amp; x&#39;F000&#39;) = (x&#39;2000&#39;)&#xA;              THEN &#39;from&#39;&#xA;          END,&#xA;          CASE &#xA;            WHEN t_infomask IS NULL &#xA;            OR ((t_infomask2::int::bit(16) &amp;amp; x&#39;F000&#39;) &amp;amp; (x&#39;4000&#39;)) = (x&#39;4000&#39;)&#xA;              THEN &#39;to&#39;&#xA;          END&#xA;        ),&#xA;        &#39;&#39;&#xA;      ) || &#39; another line&#39; AS direction,&#xA;      -- Tuple hot updated &#xA;      --    le tuple actuel et son ancienne version sont sur la même page&#xA;      CASE &#xA;        WHEN (t_infomask2::int::bit(16) &amp;amp; x&#39;F000&#39;) = (x&#39;4000&#39;)&#xA;        OR (t_infomask2::int::bit(16) &amp;amp; x&#39;F000&#39;) = (x&#39;8000&#39;)&#xA;        OR (t_infomask2::int::bit(16) &amp;amp; x&#39;F000&#39;) = (x&#39;4000&#39; | x&#39;8000&#39;)&#xA;          THEN TRUE&#xA;        ELSE FALSE&#xA;      END AS hot,&#xA;      -- Tuple supprimé (ou attribut clé mis à jour)&#xA;      CASE &#xA;        WHEN ((t_infomask2::int::bit(16) &amp;amp; x&#39;F000&#39;) &amp;amp; (x&#39;2000&#39;)) = (x&#39;2000&#39;)&#xA;          THEN TRUE &#xA;        ELSE FALSE&#xA;      END AS &#34;delete&#34;,&#xA;      -- Identifiant de transaction xmin gelé&#xA;      CASE &#xA;        WHEN ((t_infomask::int::bit(16) &amp;amp; x&#39;0F00&#39;) &amp;amp; (x&#39;0100&#39; | x&#39;0200&#39;)) = (x&#39;0100&#39; | x&#39;0200&#39;)&#xA;          THEN TRUE&#xA;        ELSE FALSE &#xA;      END AS &#34;freeze&#34;,&#xA;      -- Drapeaux d&#39;information&#xA;      ARRAY(&#xA;        SELECT&#xA;          array_to_string(&#xA;            regexp_matches(&#xA;              heap_tuple_infomask_flags(t_infomask, t_infomask2)::TEXT,&#xA;              &#39;[A-Za-z0-9_\-]+&#39;,&#xA;              &#39;g&#39;&#xA;            ),&#xA;            &#39;&#39;&#xA;          )&#xA;      )::text[] AS info&#xA;    FROM &#xA;      pg_catalog.pg_class AS pgc,&#xA;      LATERAL &#xA;        generate_series(0, pgc.relpages - 1) AS pages(page_num),&#xA;      LATERAL&#xA;        heap_page_items(&#xA;          get_raw_page(pgc.oid::regclass::text, pages.page_num)&#xA;        ) AS hpi&#xA;    WHERE &#xA;      pgc.oid = $a$ || quote_literal(relname) || $a$::regclass &#xA;    AND (&#xA;      (&#xA;        $a$ || page_number || $a$ &amp;lt;&gt; -1&#xA;        AND&#xA;        $a$ || page_number || $a$ = pages.page_num&#xA;      )OR &#xA;      $a$ || page_number || $a$ = - 1&#xA;    ) $a$&#xA;    ;&#xA;&#xA;    RETURN;&#xA;END&#xA;$function$&#xA;LANGUAGE PLPGSQL&#xA;;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 class=&#34;wp-block-heading&#34;&gt;Stockage physique&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Côté base, les données sont structurées de la façon suivante :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;Base de données&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Schéma&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Table&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Ligne&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Attribut&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Mais dans le système de fichiers, les données sont structurées différemment :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;Un répertoire racine par tablespace.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Un répertoire par base de données.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Des fichiers spécifiques pour chaque table.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Tablespace&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Le lien entre les données et le système de fichier se matérialise en base via le tablespace. Cet objet permet aux administrateurs de définir l&amp;#8217;emplacement des données. Par défaut deux tablespaces existent et pointent vers le répertoire &lt;code&gt;$PGDATA/base&lt;/code&gt; du répertoire (sur Windows, il s&amp;rsquo;agit par défaut de « C:\Program Files\PostgreSQL\16\data\base »). Il s&amp;rsquo;se nomment :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;&lt;code&gt;pg_default&lt;/code&gt; : emplacement de stockage par défaut.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;pg_global&lt;/code&gt; : emplacement de stockage des objets contenant le &lt;a href=&#34;https://www.postgresql.org/docs/current/catalogs.html&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;catalogue système&lt;/a&gt; (données sur le cluster).&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Il est possible créer un nouveau tablespace pour stocker des données sur un stockage spécifique (un disque dur plus rapide par exemple) :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;CREATE TABLESPACE pgraster_data&#xA;&#x9;OWNER postgres&#xA;&#x9;LOCATION &#39;C:\mon_repertoire\de_stockage&#39;&#xA;;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Notez que :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;Un tablespace est lié à une instance PostgreSQL et ne peut pas être ouvert par une instance autre que celle qui l&amp;rsquo;a créée.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Un tablespace non trouvable (défaillance du disque dur, déplacement&amp;#8230;) peut empêcher le démarrage de l&amp;rsquo;instance PostgreSQL.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;un tablespace peut être utilisé par n&amp;rsquo;importe qu&amp;rsquo;elle base de donnée de l&amp;rsquo;instance à laquelle il appartient.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;un tablespace ne peut être supprimé tant qu&amp;rsquo;un objet est stocké dedans.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Lorsque vous créez un tablespace, un lien symbolique est créé dans le répertoire &lt;code&gt;$PGDATE/pg_tblspc&lt;/code&gt; et pointe vers le répertoire définit pour stocker les données du tablespace.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Vous pouvez lister les différents tablespaces ainsi que leurs emplacements de stockage grâce à la commande suivante :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;SELECT &#xA;  pt.spcname AS nom,&#xA;  pa.rolname AS proprietaire,&#xA;  pg_tablespace_location(pt.oid) AS emplacement,&#xA;  pg_size_pretty(pg_tablespace_size(pt.oid)) AS poids&#xA;FROM &#xA;  pg_tablespace AS pt&#xA;LEFT JOIN&#xA;  pg_authid AS pa&#xA;  ON pa.oid = pt.spcowner&#xA;;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Fichiers&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Dans le système de fichier, les données sont stockées dans le répertoire du tablespace et s&amp;rsquo;organise assez simplement : &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;Un répertoire par base de données, dont le nom correspond à l&amp;rsquo;OID de la base au sein de l&amp;rsquo;instance PostgreSQL.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Un ensemble de fichiers par table.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Pour chaque table il existe un ou plusieurs fichiers dont le nom débute toujours par un numéro nommé &lt;em&gt;filenode&lt;/em&gt; qui correspond souvent à l&amp;rsquo;OID de la table (mais pas toujours, par exemple lorsqu&amp;rsquo;une table est réécrite, un nouveau fichier est créé avec un nouveau numéro ; voir &lt;a href=&#34;#vacuum&#34;&gt;la partir sur les VACUUM&lt;/a&gt;).&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Vous pourrez trouver les fichiers suivants pour chaque table (exemple pour un filenode = 112233 ) : &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;Le &lt;strong&gt;heap file&lt;/strong&gt; : ensemble de fichiers contenant les données.&lt;br&gt;Chaque fichier du &lt;em&gt;heap file&lt;/em&gt; est appelé segment et ne peut exéder 1 Go, il y a donc un nombre de segments différent selon la taille de la table.&lt;br&gt;Le premier segment est nommé &lt;code&gt;filenode&lt;/code&gt; sans extension (&lt;code&gt;112233&lt;/code&gt; dans notre exemple), le second se voit ajouter l&amp;rsquo;extension « 1 » (&lt;code&gt;112233.1&lt;/code&gt;), le troisième l&amp;rsquo;extension « 2 » (&lt;code&gt;11223.2&lt;/code&gt;) et ainsi de suite&amp;#8230;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;La &lt;strong&gt;free space map&lt;/strong&gt; : liste l&amp;rsquo;espace disponible dans chaque page.&lt;br&gt;Le fichier est nommé  &lt;code&gt;filenode_fsm&lt;/code&gt; (&lt;code&gt;112233_fsm&lt;/code&gt;).&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;La &lt;strong&gt;visibility map&lt;/strong&gt; : liste indiquant pour chaque page si toutes les lignes sont visibles pour toutes les transactions et si tous les tuples sont gelés. Cela permet au VACUUM de ne pas avoir à scanner ces pages afin d&amp;rsquo;aller plus vite.&lt;br&gt;Le fichier est nommé &lt;code&gt;filenode_vm&lt;/code&gt; (&lt;code&gt;112233_vm&lt;/code&gt;).&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Même si c&amp;rsquo;est très rare, les fichiers fsm et vm peuvent se voir attribuer des extensions « 1 », « 2 »&amp;#8230; s&amp;rsquo;ils dépassent 1 Go et que d&amp;rsquo;autres fichiers doivent être créés.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voici un graphique pour vous représenter la répartition des données :&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure class=&#34;aligncenter size-full&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://blog.arthurbazin.com/wp-content/uploads/tuto_vacuum_filesystem.svg&#34; alt=&#34;&#34; class=&#34;wp-image-3002&#34;/&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p&gt;Exemple d&amp;rsquo;une carte de visibilité :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure class=&#34;wp-block-table&#34;&gt;&lt;table class=&#34;has-fixed-layout&#34;&gt;&lt;thead&gt;&lt;tr&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Numéro de page&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Only visible&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Only frozen&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;La première page ne contient que des tuples visibles, en revanche, les pages d&amp;rsquo;après contiennent des tuples non visibles : il s&amp;rsquo;agit de tuples supprimés qui sont encore présents dans la base et en attente de suppression par le &lt;code&gt;VACUUM&lt;/code&gt;. Ce dernier n&amp;rsquo;a donc pas besoin de travailler sur la première page pour le nettoyage. Nous allons voir dans le paragraphe suivant ce qu&amp;rsquo;est un tuple.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Page&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Pour faciliter la gestion des données, leur stockage au sein des segments du &lt;em&gt;heap file&lt;/em&gt; se fait sous la forme de paquets de 8 ko de données (paramétrable mais par défaut 8 ko). Un paquet de données est appelé &lt;strong&gt;page&lt;/strong&gt; (ou bloc). Un segment peut donc contenir plusieurs pages.&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure class=&#34;aligncenter size-full&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://blog.arthurbazin.com/wp-content/uploads/tuto_vacuum_page-2.svg&#34; alt=&#34;&#34; class=&#34;wp-image-3007&#34;/&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p&gt;Les pages sont toujours structurées de la même façon :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;différentes métadonnées sur la page (24 octets).&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;strong&gt;Les pointeurs :&lt;/strong&gt; il s&amp;rsquo;agit de données contenant l&amp;#8217;emplacement de chaque tuple stocké dans la page (4 octets chacun).&lt;br&gt;Les index référencent ces pointeurs.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;L&amp;rsquo;espace restant disponible dans la page.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;strong&gt;Les tuples :&lt;/strong&gt; un tuple équivaut à une ligne dans la table. &lt;br&gt;Il s&amp;rsquo;agit d&amp;rsquo;un ensemble de métadonnées associées aux valeurs des attributs de la ligne les unes à la suite des autres.&lt;br&gt;Les éléments sont positionnés dans l&amp;rsquo;ordre inverse : du dernier au premier et accolés à la fin de la page.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Des données spécifiques (uniquement pour les table d&amp;rsquo;index).&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure class=&#34;aligncenter size-full&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://blog.arthurbazin.com/wp-content/uploads/tuto_vacuum_page_content-1.svg&#34; alt=&#34;&#34; class=&#34;wp-image-3097&#34;/&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p&gt;La page est considérée comme complète lorsque l&amp;rsquo;espace disponible vient à manquer : au fur et à mesure du remplissage, les pointeurs rejoignent les tuples et l&amp;rsquo;espace entre les deux devient insuffisant pour stocker un nouvel élément.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Notez que les tuples sont toujours placés de façon à être alignés sur des multiples de 8 octets. Ce positionnement entraine la présence d&amp;rsquo;espace entre les tuples lorsque ceux-ci ne possèdent pas une longueur multiple de 8.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Avec une telle structure, vous pouvez donc voir que lorsque PostgreSQL créé une nouvelle page, celle-ci occupe immédiatement 8 ko, même si elle est presque vide car il s&amp;rsquo;agit d&amp;rsquo;un conteneur de taille fixe. Ainsi, une base PostgreSQL grossit par multiple de 8 ko.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Pour la lecture des données, il y a deux cas :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;Le scan séquentiel : lors d&amp;rsquo;un parcours complet de la table, PostgreSQL lit chaque pointeur ce qui lui permet ensuite d&amp;rsquo;aller lire chaque tuple.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Le scan indexé : lors d&amp;rsquo;un parcours via un index, ce dernier contient le numéro de page ainsi que l&amp;#8217;emplacement du pointeur de chaque donnée indexée. &lt;br&gt;PostgreSQL n&amp;rsquo;a plus qu&amp;rsquo;a parcourir les pointeurs pour récupérer la donnée sans avoir à lire tous les tuples (scan séquentiel). &lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Tuple&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Les données de toutes les colonnes d&amp;rsquo;une ligne sont stockées au sein d&amp;rsquo;un tuple (en français « uplet »). Pour faire simple, il s&amp;rsquo;agit d&amp;rsquo;une liste de données.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Les tuples sont organisés de la façon suivante :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;Un en-tête contenant l&amp;rsquo;identifiant du tuple (ctid), des données de visibilité de transaction (t_xmin et t_xmax) et d&amp;rsquo;autres éléments que nous verrons plus tard.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Une carte des valeurs &lt;code&gt;NULL&lt;/code&gt; au sein de la ligne. &lt;br&gt;Cette carte n&amp;rsquo;est présente que si la ligne contient des valeurs &lt;code&gt;NULL&lt;/code&gt;.&lt;br&gt;Il s&amp;rsquo;agit d&amp;rsquo;une suite de valeurs booléenne représentant chaque colonne (dans l&amp;rsquo;ordre donc) avec « 1 » indiquant la présence d&amp;rsquo;une valeur &lt;code&gt;NULL&lt;/code&gt;, « 0 » dans le cas contraire.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Les données les unes à la suite des autres.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;L&amp;rsquo;en-tête d&amp;rsquo;un tuple mesurant 23 octets, il y a donc 1 octet ajouté pour l&amp;rsquo;alignement si aucune carte de valeurs &lt;code&gt;NULL&lt;/code&gt; n&amp;rsquo;existe : c&amp;rsquo;est la taille minimum d&amp;rsquo;un tuple.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Le placement des données au sein du tuple se fait dans l&amp;rsquo;ordre de définition des colonnes en respectant deux règles : &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;L&amp;rsquo;espace occupé dépend du type :&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;L&amp;rsquo;espace peut être fixe (smallint, integer, bigint&amp;#8230;)&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;L&amp;rsquo;espace peut être variable et dépend donc de la donnée (varchar, text&amp;#8230;).&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;L&amp;#8217;emplacement d&amp;rsquo;une donnée par rapport à la précédente dépend du type :&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;L&amp;#8217;emplacement peut être aligné (smallint, integer, bigint&amp;#8230;) (même principe que l&amp;rsquo;alignement des tuples dans la page sauf qu&amp;rsquo;ici la longueur est variable).&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;L&amp;#8217;emplacement peut être non aligné (booléen, varchar&amp;#8230;)&lt;br&gt;Si ce type de donnée est en première position et qu&amp;rsquo;aucune carte de valeurs NULL n&amp;rsquo;est présente, un alignement sur le 24&lt;sup&gt;ème&lt;/sup&gt; octet est tout de même réalisé.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voici quelques cas de figure pour les types les plus utilisés :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;&lt;strong&gt;Booléen :&lt;/strong&gt;&lt;br&gt;Pas d&amp;rsquo;alignement : se place directement après la donnée de la colonne précédente.&lt;br&gt;Espace occupé de 1 octet.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;strong&gt;Smallint &amp;#8211; int2 :&lt;/strong&gt; &lt;br&gt;Alignement sur un multiple de 2 octets.&lt;br&gt;Espace occupé de 2 octets.&lt;br&gt;Attention à ne pas confondre l&amp;rsquo;alignement et l&amp;rsquo;espace occupé qui sont les mêmes pour ce type.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;strong&gt;Integer &amp;#8211; int4 :&lt;/strong&gt;  &lt;br&gt;Alignement sur un multiple de 4 octets.&lt;br&gt;Espace occupé de 4 octets.&lt;br&gt;Attention à ne pas confondre l&amp;rsquo;alignement et l&amp;rsquo;espace occupé qui sont les mêmes pour ce type.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;strong&gt;Biginteger &amp;#8211; int8 :&lt;/strong&gt;&lt;br&gt;Alignement sur un multiple de 8 octets.&lt;br&gt;Espace occupé de 8 octets.&lt;br&gt;Attention à ne pas confondre l&amp;rsquo;alignement et l&amp;rsquo;espace occupé qui sont les mêmes pour ce type.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;strong&gt;Text, Varchar :&lt;/strong&gt;&lt;br&gt;Alignement variable : aucun alignement en dessous d&amp;rsquo;une certaine taille ; au dela, les données peuvent être compressée et/ou TOASTées et un header aligné sur un multiple de 4 octets est ajouté.&lt;br&gt;Espace occupé variable : 1 octet de header plus les données en dessous d&amp;rsquo;une certaine taille ; au dela, 4 octets de header plus les données.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voici une requête permettant de connaitre la taille fixée pour les types de données (pour les types variables, l&amp;rsquo;alignement se fait pour le header éventuellement présent) :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;SELECT &#xA;&#x9;typname AS type,&#xA;&#x9;concat(&#xA;&#x9;&#x9;typcategory,&#xA;&#x9;&#x9;&#39; - &#39; || &#xA;&#x9;&#x9;CASE typcategory&#xA;&#x9;&#x9;&#x9;WHEN &#39;A&#39; THEN &#39;Array types&#39;&#xA;&#x9;&#x9;&#x9;WHEN &#39;B&#39; THEN &#39;Boolean types&#39;&#xA;&#x9;&#x9;&#x9;WHEN &#39;C&#39; THEN &#39;Composite types&#39;&#xA;&#x9;&#x9;&#x9;WHEN &#39;D&#39; THEN &#39;Date/time types&#39;&#xA;&#x9;&#x9;&#x9;WHEN &#39;E&#39; THEN &#39;Enum types&#39;&#xA;&#x9;&#x9;&#x9;WHEN &#39;G&#39; THEN &#39;Geometric types&#39;&#xA;&#x9;&#x9;&#x9;WHEN &#39;I&#39; THEN &#39;Network address types&#39;&#xA;&#x9;&#x9;&#x9;WHEN &#39;N&#39; THEN &#39;Numeric types&#39;&#xA;&#x9;&#x9;&#x9;WHEN &#39;P&#39; THEN &#39;Pseudo-types&#39;&#xA;&#x9;&#x9;&#x9;WHEN &#39;R&#39; THEN &#39;Range types&#39;&#xA;&#x9;&#x9;&#x9;WHEN &#39;S&#39; THEN &#39;String types&#39;&#xA;&#x9;&#x9;&#x9;WHEN &#39;T&#39; THEN &#39;Timespan types&#39;&#xA;&#x9;&#x9;&#x9;WHEN &#39;U&#39; THEN &#39;User-defined types&#39;&#xA;&#x9;&#x9;&#x9;WHEN &#39;V&#39; THEN &#39;Bit-string types&#39;&#xA;&#x9;&#x9;&#x9;WHEN &#39;X&#39; THEN &#39;unknown type&#39;&#xA;&#x9;&#x9;&#x9;WHEN &#39;Z&#39; THEN &#39;Internal-use types&#39;&#xA;&#x9;&#x9;END&#xA;&#x9;) AS category,&#xA;&#x9;CASE &#xA;&#x9;&#x9;WHEN typlen = -1 THEN &#39;variable&#39;&#xA;&#x9;&#x9;ELSE typlen::text&#xA;&#x9;END AS longueur,&#xA;&#x9;concat(&#xA;&#x9;&#x9;typalign,&#xA;&#x9;&#x9;&#39; - &#39; || &#xA;&#x9;&#x9;CASE typalign&#xA;&#x9;&#x9;&#x9;WHEN &#39;c&#39; THEN &#39;char alignment, i.e., no alignment needed&#39;&#xA;&#x9;&#x9;&#x9;WHEN &#39;s&#39; THEN &#39;short alignment (2 bytes on most machines)&#39;&#xA;&#x9;&#x9;&#x9;WHEN &#39;i&#39; THEN &#39;int alignment (4 bytes on most machines)&#39;&#xA;&#x9;&#x9;&#x9;WHEN &#39;d&#39; THEN &#39;double alignment (8 bytes on many machines, but by no means all)&#39;&#xA;&#x9;&#x9;END&#xA;&#x9;) AS alignement,&#xA;&#x9;concat(&#xA;&#x9;&#x9;typstorage,&#xA;&#x9;&#x9;&#39; - &#39; || &#xA;&#x9;&#x9;CASE typstorage&#xA;&#x9;&#x9;&#x9;WHEN &#39;p&#39; THEN &#39;plain: Values must always be stored plain (non-varlena types always use this value)&#39;&#xA;&#x9;&#x9;&#x9;WHEN &#39;e&#39; THEN &#39;external: Values can be stored in a secondary “TOAST” relation&#39;&#xA;&#x9;&#x9;&#x9;WHEN &#39;m&#39; THEN &#39;main: Values can be compressed and stored inline&#39;&#xA;&#x9;&#x9;&#x9;WHEN &#39;x&#39; THEN &#39;extended: Values can be compressed and/or moved to a secondary relation&#39;&#xA;&#x9;&#x9;END&#xA;&#x9;) AS stockage&#xA;FROM &#xA;&#x9;pg_type&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Cette valeur d&amp;rsquo;alignement implique donc une potentielle perte d&amp;rsquo;espace entre les valeurs de chaque colonne. Ainsi, l&amp;rsquo;ordre des colonnes a une forte incidence sur le poids d&amp;rsquo;une table. &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voici un exemple concret pour mieux situer le problème. Voila deux tables avec les mêmes colonnes mais des agencements différents et l&amp;rsquo;impact que cela a :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;CREATE TABLE public.test_non_optimise (&#xA;  a int2,&#xA;  b int8,&#xA;  c int2,&#xA;  d int8&#xA;)&#xA;;&#xA;&#xA;INSERT INTO public.test_non_optimise&#xA;VALUES (1, 1, 1, 1)&#xA;;&#xA;&#xA;SELECT &#xA;  pg_column_size(test_non_optimise.*) &#xA;FROM &#xA;  public.test_non_optimise&#xA;;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;La ligne insérée pèse 56 octets que l&amp;rsquo;on peut décomposer ainsi :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;position &amp;#8211; longueur : commentaire&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;0  - 23 o&lt;/code&gt; : Métadonnées.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;23 -  1 o&lt;/code&gt; : Espacement.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;24 -  2 o&lt;/code&gt; : Données integer (alignée sur un multiple de 2).&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;26 -  6 o&lt;/code&gt; : Espacement.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;32 -  8 o&lt;/code&gt; : Données biginteger (alignée sur un multiple de 8).&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;40 -  2 o&lt;/code&gt; : Données integer (alignée sur un multiple de 2).&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;42 -  6 o&lt;/code&gt; : Espacement.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;48 -  8 o&lt;/code&gt; : Données biginteger (alignée sur un multiple de 8).&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;On note beaucoup d&amp;rsquo;octets d&amp;rsquo;espacement.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;CREATE TABLE public.test_optimise (&#xA;  b int8,&#xA;  d int8,&#xA;  a int2,&#xA;  c int2&#xA;)&#xA;;&#xA;&#xA;INSERT INTO public.test_optimise &#xA;VALUES (1, 1, 1, 1)&#xA;;&#xA;&#xA;SELECT &#xA;  pg_column_size(test_optimise.*) &#xA;FROM &#xA;  public.test_optimise&#xA;;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;La ligne insérée pèse 44 octets que l&amp;rsquo;on peut décomposer ainsi :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;position &amp;#8211; longueur : commentaire&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;0  - 23 o&lt;/code&gt; : Métadonnées.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;23 -  1 o&lt;/code&gt; : Espacement.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;24 -  8 o&lt;/code&gt; : Données biginteger (alignée sur un multiple de 8).&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;32 -  8 o&lt;/code&gt; : Données biginteger (alignée sur un multiple de 8).&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;40 -  2 o&lt;/code&gt; : Données integer (alignée sur un multiple de 2).&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;42 -  2 o&lt;/code&gt; : Données integer (alignée sur un multiple de 2).&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;L&amp;rsquo;optimisation du placement des colonnes permet de gagner 22% d&amp;rsquo;espace disque : c&amp;rsquo;est non négligeable sur des tables de grande taille.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Toast&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Les données d&amp;rsquo;un tuple ne peuvent dépasser une page. Ainsi, pour contourner cette limite avec des données lourdes, un mécanisme spécifique appelé TOAST est utilisé.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;TOAST signifie « The Oversized-Attribute Storage Technique » et se déclenche de façon automatisée et totalement transparente pour l&amp;rsquo;utilisateur lorsqu&amp;rsquo;une ligne est trop lourde pour le stockage « standard ».&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Le fonctionnement est le suivant : &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;Jusqu’à 2 ko (par défaut, définit via la variable &lt;code&gt;TOAST_TUPLE_THRESHOLD&lt;/code&gt;), un tuple est stocké normalement, directement dans la page.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;A partir de 2 ko, le système compresse le tuple, puis deux cas de figures se présentent :&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;Le poids du tuple compressé est inférieur à 2 ko (par défaut, définit via la variable &lt;code&gt;TOAST_TUPLE_TARGET&lt;/code&gt;), alors ce dernier est stocké compressé dans la page.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Le poids du tuple compressé est supérieur à 2 ko, alors le système transfert les données colonne par colonne dans une table annexe appelée table TOAST.&lt;br&gt;Le transfert commence par les colonnes les plus lourdes et s&amp;rsquo;arrête lorsque les colonnes restantes peuvent être stockées dans la page (lorsqu&amp;rsquo;il reste moins de 2 ko).&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure class=&#34;aligncenter size-full&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://blog.arthurbazin.com/wp-content/uploads/tuto_vacuum_toast_diagram-2.svg&#34; alt=&#34;&#34; class=&#34;wp-image-3183&#34;/&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p&gt;Les tables TOAST sont stockées dans le schéma système &lt;code&gt;pg_toast&lt;/code&gt; et sont nommées d&amp;rsquo;après l&amp;rsquo;OID de la table d&amp;rsquo;origine sous la forme &lt;code&gt;pg_toast_oidorigine&lt;/code&gt;. &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Il s&amp;rsquo;agit de tables standards (et donc qui peuvent être lues via un simple &lt;code&gt;SELECT&lt;/code&gt;) à la structure suivante :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;&lt;code&gt;chunk_id&lt;/code&gt; : identifiant de bloc (permettant la correspondance avec un tuple spécifique de la table source).&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;chunk_seq&lt;/code&gt; : numéro d&amp;rsquo;ordre du bloc (une donnée importante peut être découpée en plusieurs blocs qu&amp;rsquo;il faut pouvoir ordonnancer).&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;chunk_data&lt;/code&gt; : donnée au format binaire.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Les données y sont stockées à raison d&amp;rsquo;un bloc par ligne, chaque bloc étant un morceau de 2 ko (par défaut, définit via la variable &lt;code&gt;TOAST_MAX_CHUNK_SIZE&lt;/code&gt;) de la donnée d&amp;rsquo;origine qui a donc été découpée.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Cette division permet de répartir le poids des données et de les stocker de façon classique (dans un &lt;em&gt;heap file&lt;/em&gt;), sans dépasser la taille limite d’une page. Voici un exemple schématisé du contenu de deux pages d&amp;rsquo;une table TOAST :&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure class=&#34;aligncenter size-full&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://blog.arthurbazin.com/wp-content/uploads/tuto_vacuum_toast_page.svg&#34; alt=&#34;&#34; class=&#34;wp-image-3186&#34;/&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p&gt;Notez que lorsque vous requêtez une table, la récupération des données TOASTées possède un certain coût car PostgreSQL doit lire la table TOAST, récupérer les morceaux de données, les assembler puis retourner la données consolidée. C&amp;rsquo;est une des raisons pour lesquelles le sélecteur &lt;code&gt;*&lt;/code&gt; est souvent déconseillé.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Autre point, depuis PostgreSQL 14, vous pouvez choisir l&amp;rsquo;algorithme de compression via la variable &lt;code&gt;default_toast_compression&lt;/code&gt; qui permet de choisir entre &lt;em&gt;pglz&lt;/em&gt; (format compression par défaut) et &lt;em&gt;lz4 (nouveau format jusqu’à&lt;/em&gt; 80% plus rapide pour un taux de compression similaire).&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Quelques requêtes&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voici quelques requêtes pour récupérer des informations sur vos tables et mieux appréhender la structure des pages.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Commencez par créer une table :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;CREATE TABLE public.table_test (&#xA;  id int4,&#xA;  commentaire_1 char(1955),&#xA;  commentaire_2 text&#xA;)&#xA;;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Vous pouvez maintenant récupérer quelques données grâce à la première fonction &lt;code&gt;get_table_info()&lt;/code&gt; :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;SELECT * FROM public.get_table_info(&#39;public.table_test&#39;);&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voici les résultats (tronqué, je n&amp;rsquo;ai pas mis toutes les colonnes) avec en gras les valeurs qui m’intéressent :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure class=&#34;wp-block-table&#34;&gt;&lt;table class=&#34;has-fixed-layout&#34;&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;Paramètre&lt;/th&gt;&lt;th&gt;Valeur&lt;/th&gt;&lt;th&gt;Commentaire&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;schema&lt;/td&gt;&lt;td&gt;public&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;table&lt;/td&gt;&lt;td&gt;table_test&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;tablespace&lt;/td&gt;&lt;td&gt;pg_default&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;strong&gt;oid_table&lt;/strong&gt;&lt;/td&gt;&lt;td&gt;&lt;strong&gt;350934&lt;/strong&gt;&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;strong&gt;numero_heap_file&lt;/strong&gt;&lt;/td&gt;&lt;td&gt;&lt;strong&gt;350934&lt;/strong&gt;&lt;/td&gt;&lt;td&gt;Le numéro du fichier peut être différent de l&amp;rsquo;oid de la table&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;strong&gt;heap_file_segment_0_location&lt;/strong&gt;&lt;/td&gt;&lt;td&gt;&lt;strong&gt;C:/&amp;#8230;/PG16-data/base/246510/350934&lt;/strong&gt;&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;strong&gt;nb_page&lt;/strong&gt;&lt;/td&gt;&lt;td&gt;&lt;strong&gt;0&lt;/strong&gt;&lt;/td&gt;&lt;td&gt;La table vient d&amp;rsquo;être créée et ne contient aucune donnée donc aucune page n&amp;rsquo;a été créée.&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;strong&gt;tuple_count&lt;/strong&gt;&lt;/td&gt;&lt;td&gt;&lt;strong&gt;0&lt;/strong&gt;&lt;/td&gt;&lt;td&gt;Aucune données.&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;strong&gt;table_length&lt;/strong&gt;&lt;/td&gt;&lt;td&gt;&lt;strong&gt;0&lt;/strong&gt;&lt;/td&gt;&lt;td&gt;La table venant d&amp;rsquo;être créée, elle ne pèse encore rien&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;strong&gt;table_length_human&lt;/strong&gt;&lt;/td&gt;&lt;td&gt;&lt;strong&gt;0 bytes&lt;/strong&gt;&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;tuple_length&lt;/td&gt;&lt;td&gt;0&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;dead_tuple_length&lt;/td&gt;&lt;td&gt;0&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;free_space_length&lt;/td&gt;&lt;td&gt;0&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;strong&gt;toast_oid&lt;/strong&gt;&lt;/td&gt;&lt;td&gt;&lt;strong&gt;350937&lt;/strong&gt;&lt;/td&gt;&lt;td&gt;La table TOAST est déjà créée dans le SGBD bien qu&amp;rsquo;il n&amp;rsquo;y ait pas encore eu besoin du système TOAST..&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;strong&gt;toast_table&lt;/strong&gt;&lt;/td&gt;&lt;td&gt;&lt;strong&gt;pg_toast_350934&lt;/strong&gt;&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;toast_heap_file_segment_0_location&lt;/td&gt;&lt;td&gt;C:/&amp;#8230;/PG16-data/base/246510/350937&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;toast_nb_page&lt;/td&gt;&lt;td&gt;0&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;toast_nb_tuple&lt;/td&gt;&lt;td&gt;-1&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;toast_length&lt;/td&gt;&lt;td&gt;0&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;toast_length_human&lt;/td&gt;&lt;td&gt;0 bytes&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Ajoutez une ligne de données puis recalculez les statistiques :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;-- Insertion de la donnée&#xA;INSERT INTO &#xA;  public.table_test (id, commentaire_1, commentaire_2)&#xA;VALUES &#xA;  (1, &#39;A&#39;, &#39;un commentaire&#39;),&#xA;  (2, &#39;B&#39;, &#39;un commentaire vraiment très très très long&#39;)&#xA;;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;SELECT * FROM public.get_table_info(&#39;public.table_test&#39;);&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voici les résultats (tronqués) :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure class=&#34;wp-block-table&#34;&gt;&lt;table class=&#34;has-fixed-layout&#34;&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;Paramètre&lt;/th&gt;&lt;th&gt;Valeur&lt;/th&gt;&lt;th&gt;Commentaire&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;nb_page&lt;/td&gt;&lt;td&gt;1&lt;/td&gt;&lt;td&gt;Une page a été créée&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;tuple_count&lt;/td&gt;&lt;td&gt;2&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;table_length_human&lt;/td&gt;&lt;td&gt;8192 bytes&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;tuple_length&lt;/td&gt;&lt;td&gt;2113&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;free_space_length&lt;/td&gt;&lt;td&gt;6036&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Il est intéressant de constater que les données pèsent 2113 octets (tuple_length) et que la page pèse 8,192 ko. En effet, les pages font toujours la même taille.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Vous pouvez voir qu&amp;rsquo;il reste 6036 octets d&amp;rsquo;espace disponible dans la page avant la création d&amp;rsquo;une seconde.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Regardez maintenant un peu plus en détail le stockage des données grâce à cette seconde fonction &lt;code&gt;get_heap_page_info()&lt;/code&gt; qui remonte des statistiques sur le contenu des pages d&amp;rsquo;une table :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;SELECT * FROM public.get_heap_page_info(&#39;public.table_test&#39;);&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voici les résultats :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure class=&#34;wp-block-table&#34;&gt;&lt;table class=&#34;has-fixed-layout&#34;&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;Paramètre&lt;/th&gt;&lt;th&gt;Valeur&lt;/th&gt;&lt;th&gt;Commentaire&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;page_num&lt;/td&gt;&lt;td&gt;0&lt;/td&gt;&lt;td&gt;Numéro de page&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;lsn&lt;/td&gt;&lt;td&gt;4/1D111198&lt;/td&gt;&lt;td&gt;Identifiant xlog de la dernière opération effectuée sur la page.&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;nb_pointer&lt;/td&gt;&lt;td&gt;2&lt;/td&gt;&lt;td&gt;Nombre de pointeurs.&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;nb_tuple&lt;/td&gt;&lt;td&gt;2&lt;/td&gt;&lt;td&gt;Nombre de tuple.&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;nb_tuple_visible&lt;/td&gt;&lt;td&gt;2&lt;/td&gt;&lt;td&gt;Nombre de tuples visibles.&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;length_header&lt;/td&gt;&lt;td&gt;24&lt;/td&gt;&lt;td&gt;Taille des métadonnées de la page.&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;length_pointer&lt;/td&gt;&lt;td&gt;8&lt;/td&gt;&lt;td&gt;Taille de l&amp;rsquo;ensemble des pointeurs.&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;length_free_space&lt;/td&gt;&lt;td&gt;6036&lt;/td&gt;&lt;td&gt;Taille de l&amp;rsquo;espace libre.&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;length_tuple&lt;/td&gt;&lt;td&gt;2120&lt;/td&gt;&lt;td&gt;Taille occupée par les tuples.&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;length_meta&lt;/td&gt;&lt;td&gt;48&lt;/td&gt;&lt;td&gt;Taille des métadonnées des tuples.&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;length_data&lt;/td&gt;&lt;td&gt;2065&lt;/td&gt;&lt;td&gt;Taille des données des tuples.&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;length_empty&lt;/td&gt;&lt;td&gt;7&lt;/td&gt;&lt;td&gt;Taille des espaces laissés par l&amp;rsquo;alignement des tuples.&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;length_special&lt;/td&gt;&lt;td&gt;0&lt;/td&gt;&lt;td&gt;Taille des données spécifiques.&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;offset_pointer&lt;/td&gt;&lt;td&gt;24&lt;/td&gt;&lt;td&gt;Positionnement du début des pointeurs.&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;offset_free_space&lt;/td&gt;&lt;td&gt;32&lt;/td&gt;&lt;td&gt;Positionnement du début de l&amp;rsquo;espace disponible.&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;offset_data&lt;/td&gt;&lt;td&gt;6072&lt;/td&gt;&lt;td&gt;Positionnement du début des données.&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;offset_special&lt;/td&gt;&lt;td&gt;8192&lt;/td&gt;&lt;td&gt;Positionnement du début des données spécifique.&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;offset_page_end&lt;/td&gt;&lt;td&gt;8192&lt;/td&gt;&lt;td&gt;Positionnement de la fin de la page.&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voici un schéma de l&amp;rsquo;état actuel de la page, vous remarquerez qu&amp;rsquo;il n&amp;rsquo;y a pas de bloc spécifique car il s&amp;rsquo;agit d&amp;rsquo;une table classique et non pas d&amp;rsquo;une table d&amp;rsquo;index :&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure class=&#34;aligncenter size-full&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://blog.arthurbazin.com/wp-content/uploads/tuto_vacuum_page_content_test-1.svg&#34; alt=&#34;&#34; class=&#34;wp-image-3099&#34;/&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p&gt;Bon nous voyons déjà pas mal de chose mais nous ne savons pas comment se répartissent les tuples, leurs métadonnées ainsi que les espaces vides. &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Allez donc un peu plus loin (puisque vous êtes là pour ça), grâce à une troisième fonction &lt;code&gt;get_heap_tuple_info()&lt;/code&gt; qui permet de récupérer toutes les informations disponibles sur les tuples présents dans la page.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;SELECT * FROM public.get_heap_tuple_info(&#39;public.table_test&#39;);&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voici les résultats (attention, j&amp;rsquo;ai plusieurs lignes donc mon tableau est maintenant dans l&amp;rsquo;autre sens).&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure class=&#34;wp-block-table&#34;&gt;&lt;table class=&#34;has-fixed-layout&#34;&gt;&lt;thead&gt;&lt;tr&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;ctid&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;page_num&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;page_index&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;offset_start&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;offset_end&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;offset_next&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;length_tuple&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;length_meta&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;length_data&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;length_empty&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;Identifiant de la ligne : numéro de page, numéro d&amp;rsquo;index dans la page&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;Numéro de page&lt;/em&gt;.&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;Numéro d&amp;rsquo;index du tuple dans la page.&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;Position du début du tuple.&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Position de la fin du tuple.&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Position du début du tuple précédent.&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;Longueur du tuple.&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;Longueur des métadonnées du tuple&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;Longueur des données en elle-même&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;Espace vide&lt;/em&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;(0,1)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;6184&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;8186&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;8192&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2002&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;24&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1978&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;6&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;(0,2)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;6072&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;6183&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;6184&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;111&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;24&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;87&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voici la représentation exacte de la page (avec en jaune l&amp;rsquo;espace perdu à cause de l&amp;rsquo;alignement) :&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure class=&#34;aligncenter size-full&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://blog.arthurbazin.com/wp-content/uploads/tuto_vacuum_page_content_test_accurate-1.svg&#34; alt=&#34;&#34; class=&#34;wp-image-3101&#34;/&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p&gt;Vous pouvez voir que le premier tuple possède un peu moins de 2000 octets de données : c&amp;rsquo;est à cause du champ &lt;code&gt;commentaire_2&lt;/code&gt;. En effet, le type de données &lt;code&gt;char(2000)&lt;/code&gt; limite les données à 2000 caractères maximum. Cependant, ce type de données est en fait le type &lt;code&gt;bpchar(2000)&lt;/code&gt; comme &lt;em&gt;blank padded caractère&lt;/em&gt; : PostgreSQL ajoute des espaces au texte jusqu’à ce qu&amp;rsquo;il atteigne 2000 caractères ce qui force la ligne à prendre plus de place que nécessaire.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Autre élément, le second tuple ne possède que 87 octets de données. C&amp;rsquo;est à cause du système TOAST qui s&amp;rsquo;est déclenché car les données pesaient plus que 2 ko, elles ont donc été compressées. Comme le résultat pèse moins de 2 ko, aucune colonne n&amp;rsquo;a été transférée dans la table TOAST.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Notez également que les pointeurs renseignent sur l&amp;#8217;emplacement des tuples.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Ajoutez encore des données :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;INSERT INTO &#xA;  public.table_test (id, commentaire_1, commentaire_2)&#xA;VALUES &#xA;  (3, &#39;C&#39;, &#39;un commentaire&#39;),&#xA;  (4, &#39;D&#39;, &#39;un commentaire&#39;),&#xA;  (5, &#39;E&#39;, &#39;un commentaire&#39;),&#xA;  (6, &#39;F&#39;, &#39;un commentaire&#39;)&#xA;;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Analysez la table :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;SELECT * FROM public.get_heap_tuple_info(&#39;public.table_test&#39;);&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure class=&#34;wp-block-table&#34;&gt;&lt;table class=&#34;has-fixed-layout&#34;&gt;&lt;thead&gt;&lt;tr&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;ctid&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;page_num&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;page_index&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;offset_start&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;offset_end&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;Identifiant de la ligne : numéro de page, numéro d&amp;rsquo;index dans la page&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;Numéro de page&lt;/em&gt;.&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;Numéro d&amp;rsquo;index du tuple dans la page.&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;Position du début du tuple.&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Position de la fin du tuple.&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;(0,1)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;6184&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;8186&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;(0,2)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;6072&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;6183&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;(0,3)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4064&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;6066&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;(0,4)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2056&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4058&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;(0,5)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;5&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;48&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2050&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;(1,1)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;6184&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;8186&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Une page supplémentaire a été créée, la table pèse maintenant 2 x 8 ko : 16 ko (vous pouvez le vérifier avec &lt;code&gt;get_table_info()&lt;/code&gt;).&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 class=&#34;wp-block-heading&#34;&gt;Gestion des données&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Colonnes système&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Des colonnes système sont présentes dans chacune des tables. Il suffit de les spécifier dans vos requêtes pour y accéder, les voici :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;&lt;code&gt;tableoid&lt;/code&gt; : l&amp;rsquo;OID de la table, utilisez &lt;code&gt;tableoid::regclass&lt;/code&gt; pour obtenir le nom de la table.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;ctid&lt;/code&gt; : emplacement physique de la ligne.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;xmin&lt;/code&gt; : identifiant de la transaction d&amp;rsquo;insertion.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;cmin&lt;/code&gt;&lt;a href=&#34;https://www.postgresql.org/docs/current/ddl-system-columns.html#DDL-SYSTEM-COLUMNS-CMIN&#34;&gt;&lt;/a&gt; : identifiant de commande au sein de la transaction d&amp;rsquo;insertion.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;xmax&lt;/code&gt; : identifiant de la transaction de supression.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;cmax&lt;/code&gt; : identifiant de commande au sein de la transaction de suppression.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voici un exemple avec notre table :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;SELECT &#xA;  tableoid::regclass,&#xA;  tableoid,&#xA;  ctid,&#xA;  xmin,&#xA;  xmax,&#xA;  *&#xA;FROM &#xA;  public.table_test&#xA;;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voici le résultat :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure class=&#34;wp-block-table&#34;&gt;&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;tableoid&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;tableoid&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;ctid&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;xmin&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;xmax&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;id&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;commentaire_1&lt;/th&gt;&lt;th&gt;commentaire_2&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;table_test&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;350934&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;(0,1)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4432&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A&lt;/td&gt;&lt;td&gt;un commentaire&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;table_test&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;350934&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;(0,2)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4432&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B&lt;/td&gt;&lt;td&gt;un commentaire vraiment très très très long&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;table_test&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;350934&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;(0,3)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4435&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C&lt;/td&gt;&lt;td&gt;un commentaire&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;table_test&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;350934&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;(0,4)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4435&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;D&lt;/td&gt;&lt;td&gt;un commentaire&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;table_test&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;350934&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;(0,4)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4435&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;5&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;E&lt;/td&gt;&lt;td&gt;un commentaire&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;table_test&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;350934&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;(1,1)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4435&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;6&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;F&lt;/td&gt;&lt;td&gt;un commentaire&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Si besoin, n&amp;rsquo;hésitez pas à utiliser cette requête pour voir à quelles lignes correspondent les tuples que nous allons analyser.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Fonctionnement&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Maintenant que nous connaissons un peu mieux la façon dont les données sont stockées physiquement, regardons comment les mouvements sont gérés.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Dans une base PostgreSQL, l&amp;rsquo;accès aux données peut se faire de façon concurrentielle (en même temps) depuis différents clients. Il faut donc gérer correctement l&amp;rsquo;ordonnancement des transactions. &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Pour cela, il existe le MVCC : Multiversion Concurrency Control ou contrôle d&amp;rsquo;accès simultané, il s&amp;rsquo;agit d&amp;rsquo;un système permettant la conservation des différents états de la donnée afin de permettre à chaque transaction de travailler sur un instantané de la base. &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Le fonctionnement repose sur le principe suivant : chaque transaction possède un identifiant unique et incrémentale, lorsqu&amp;rsquo;elle effectue une opération, les lignes modifiées se voient attribuer son identifiant ce qui permet de ressituer l&amp;rsquo;état des données par rapport à toute autre transaction.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Par exemple :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure class=&#34;wp-block-table&#34;&gt;&lt;table class=&#34;has-fixed-layout&#34;&gt;&lt;thead&gt;&lt;tr&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Horaire&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Transaction 1&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Transaction 2&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;10h00&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Démarrage transaction&lt;br&gt;Début UPDATE sur la table X&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;10h05&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Démarrage transaction&lt;br&gt;Début INSERT sur la table Y&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;10h06&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Fin INSERT sur la table Y&lt;br&gt;Fin transaction&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;10h08&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Fin UPDATE sur la table X&lt;br&gt;Début UPDATE sur la table Y&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;10h09&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Fin UPDATE sur la table Y&lt;br&gt;Fin transaction&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Lorsque la transaction 1 effectue sa seconde opération, l&amp;rsquo;état des données doit être celui qui existait lors du démarrage de la transaction. Cependant, pour éviter de bloquer tous les utilisateurs, PostgreSQL a déjà effectué l&amp;rsquo;INSERT de la transaction 2. Ainsi, pour conserver l&amp;rsquo;isolation de chaque transaction, une version de la table telle qu&amp;rsquo;elle était lors de démarrage de la transaction 1 existe toujours après la finalisation de la transaction 2, le temps que la transaction 1 puisse se terminer.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Notez que si la transaction 2 avait effectué une opération modifiant des données de la table Y concernées par la transaction 1, PostgreSQL aurait attendu la fin de la transaction grâce à un système de verrous placés sur les lignes concernées.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Notez que selon le niveau d&amp;rsquo;isolation, il est possible pour une transaction de « voir » les lignes modifiées par d&amp;rsquo;autres transactions. Il s&amp;rsquo;agit du réglage de la variable &lt;code&gt;default_transaction_isolation&lt;/code&gt; qui peut prendre l&amp;rsquo;une des valeurs suivantes :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;&lt;code&gt;READ COMMITTED&lt;/code&gt; : une requête n&amp;rsquo;a accès qu&amp;rsquo;aux lignes commitées avant qu&amp;rsquo;elle ne commence, c&amp;rsquo;est donc le démarrage de la requête qui fait foi. &lt;br&gt;Ainsi, les dernières requêtes d&amp;rsquo;une transaction peuvent opérer sur des données ayant été modifiées par d&amp;rsquo;autres transactions par rapport aux premières requêtes.&lt;br&gt;Il s&amp;rsquo;agit de la valeur par défaut.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;REPEATABLE READ&lt;/code&gt; : une transaction ne peut voir que les lignes commitées avant que la première requête de la transaction ne soit exécutée.&lt;br&gt;Deux transactions concurrentes peuvent modifier des données différentes mais appartenant à la même table ce qui peut conduire à des données inconsistantes (car calculées sur une base qui n&amp;rsquo;existe plus par exemple).&lt;br&gt;En revanche, si une seconde transaction modifie les mêmes données que la première, une erreur &lt;code&gt;serialization_failure&lt;/code&gt; est remontée.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;SERIALIZABLE&lt;/code&gt; : une transaction ne peut voir que les lignes commitées avant que la première requête de la transaction ne soit exécutée. &lt;br&gt;Si deux transactions concurrentes modifient les mêmes données, la première transaction à commiter « gagne » et la seconde est annulée (&lt;code&gt;ROLLBACK&lt;/code&gt;) et une erreur &lt;code&gt;serialization_failure&lt;/code&gt; est remontée.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Mais comment cela fonctionne en détail ? Pour voir cela, nous allons devoir utiliser un exemple concret.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;INSERT &amp;#8211; UPDATE &amp;#8211; DELETE&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Pour démarrer nos test, nous allons repartir de la table précédente (disponible dans l&amp;rsquo;onglet « initialisation »).&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Démarrez une transaction et affichez son identifiant :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW gestion_data_insert_delete_udpate&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;txid_current()&#34; data-enlighter-group=&#34;gestion_data_insert_delete_udpate&#34;&gt;BEGIN;&#xA;&#xA;SELECT txid_current();&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;Initialisation&#34; data-enlighter-group=&#34;gestion_data_insert_delete_udpate&#34;&gt;-- !!!&#xA;-- Attention à bien exécuter chaque requête dans une transaction spécifique&#xA;-- Ce que permet le COMMIT à la suite de chaque requête si vous lancez tout d&#39;un seul bloc&#xA;-- !!!&#xA;&#xA;-- Création d&#39;une table de test&#xA;CREATE TABLE public.table_test (&#xA;  id int4,&#xA;  commentaire_1 char(1955),&#xA;  commentaire_2 text&#xA;)&#xA;;&#xA;COMMIT;&#xA;&#xA;-- Insertion de données&#xA;INSERT INTO &#xA;  public.table_test (id, commentaire_1, commentaire_2)&#xA;VALUES &#xA;  (1, &#39;A&#39;, &#39;un commentaire&#39;),&#xA;  (2, &#39;B&#39;, &#39;un commentaire vraiment très très très long&#39;)&#xA;;&#xA;COMMIT;&#xA;&#xA;-- Insertion de données&#xA;INSERT INTO &#xA;  public.table_test (id, commentaire_1, commentaire_2)&#xA;VALUES &#xA;  (3, &#39;C&#39;, &#39;un commentaire&#39;),&#xA;  (4, &#39;D&#39;, &#39;un commentaire&#39;),&#xA;  (5, &#39;E&#39;, &#39;un commentaire&#39;),&#xA;  (6, &#39;F&#39;, &#39;un commentaire&#39;)&#xA;;&#xA;COMMIT;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Ma transaction porte le numéro d&amp;rsquo;identifiant &lt;strong&gt;4440&lt;/strong&gt;.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Modifiez des données :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;-- Mise à jour de la ligne 3&#xA;UPDATE public.table_test&#xA;SET commentaire_2 = &#39;Un autre commentaire&#39;&#xA;WHERE id = 3&#xA;;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Validez la transaction :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;COMMIT;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Tant qu&amp;rsquo;a faire, faites la suppression suivante suivit d&amp;rsquo;une insertion :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;DELETE FROM public.table_test&#xA;WHERE id = 4&#xA;;&#xA;&#xA;-- Ajout d&#39;une ligne&#xA;INSERT INTO &#xA;  public.table_test (id, commentaire_1, commentaire_2)&#xA;VALUES &#xA;  (7, &#39;G&#39;, &#39;un commentaire&#39;)&#xA;;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Analysez les données : &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;SELECT * FROM public.get_heap_tuple_info(&#39;public.table_test&#39;);&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure class=&#34;wp-block-table&#34;&gt;&lt;table class=&#34;has-fixed-layout&#34;&gt;&lt;thead&gt;&lt;tr&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;ctid&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;page_index&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;xmin&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;xmax&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;state&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;visible&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;update&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;direction&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;hot&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;delete&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;freeze&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;Identifiant de la ligne : numéro de page, numéro d&amp;rsquo;index dans la page&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;Numéro d&amp;rsquo;index du tuple dans la page.&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;ID de la transaction à partir de laquelle le tuple est visible&lt;/em&gt;.&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;&lt;em&gt;ID de la transaction au delà de laquelle le tuple n&amp;rsquo;est plus visible&lt;/em&gt;.&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;État du tuple.&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;Visibilité du tuple.&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;Le tuple a-t-il été mis à jour&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;to : vers un autre tuple.&lt;br&gt;from : depuis unautre tuple&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;HOT UPDATE&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;Tuple supprimé&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;xmin gelé&lt;/em&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;(0,1)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4432 &amp;#8211; c&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;normal&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;(0,2)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4432 &amp;#8211; c&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;normal&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;dead&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Non&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;to another line&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;(0,4)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4435 &amp;#8211; c&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4442 &amp;#8211; c&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;normal&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Non&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;(0,5)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;5&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4435 &amp;#8211; c&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;normal&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;(1,1)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4435 &amp;#8211; c&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;normal&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;(1,2)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4440 &amp;#8211; c&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;normal&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;from another line&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;(1,3)&lt;br&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4453 &amp;#8211; c&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;normal&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Vous découvrez les colonnes &lt;code&gt;xmin&lt;/code&gt; et &lt;code&gt;xmax&lt;/code&gt; qui indiquent « à partir de » et « jusqu’à » quelle transaction un tuple est visible. J&amp;rsquo;ai ajouté un petit drapeau à côté de chaque valeur :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;c : la transaction a été validée (&lt;code&gt;COMMIT&lt;/code&gt;).&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;a : la transaction a été annulée (&lt;code&gt;ROLLBACK&lt;/code&gt;).&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Vous noterez donc que PostgreSQL garde en mémoire les données qui ont été modifiées lors des transactions abandonnées.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Vous pouvez voir plusieurs éléments :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;Les lignes visibles ne possèdent pas de &lt;em&gt;xmax&lt;/em&gt; (en vrai il est égal à 0).&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;La ligne &lt;code&gt;id = 3&lt;/code&gt; a été mise à jour.&lt;br&gt;Son ancien emplacement avec les données d&amp;rsquo;origine est toujours présent et correspond à la troisième ligne. Elle est identifiée comme « morte » et devra être nettoyée.&lt;br&gt;La nouvelle version est présente à la dernière ligne (&lt;code&gt;ctid = (1,2)&lt;/code&gt;).&lt;br&gt;PostgreSQL a réalisé un &lt;code&gt;INSERT&lt;/code&gt;.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;La ligne &lt;code&gt;ctid = (0,4)&lt;/code&gt; correspond à la ligne &lt;code&gt;id = 4&lt;/code&gt; que nous avons supprimée.&lt;br&gt;Ici aussi la donnée n&amp;rsquo;est pas supprimée mais simplement « tagguée » comme non visible.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;La ligne &lt;code&gt;ctid = (1,3)&lt;/code&gt; correspond à la ligne que nous venons d&amp;rsquo;ajouter : elle est située en dernière position.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Un &lt;code&gt;UPDATE&lt;/code&gt; est en réalité la même opération qu&amp;rsquo;un &lt;code&gt;DELETE&lt;/code&gt; suivi d&amp;rsquo;un &lt;code&gt;INSERT&lt;/code&gt;, d&amp;rsquo;ailleurs son coût est assez similaire.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Ce fonctionnement nous montre également pourquoi les lignes peuvent paraitre désordonnées lors d&amp;rsquo;un &lt;code&gt;SELECT&lt;/code&gt;. En effet, PostgreSQL remonte les lignes dans l&amp;rsquo;ordre dans lequel elles sont stockées. Dans notre cas, un simple &lt;code&gt;SELECT&lt;/code&gt; sur la table nous aurait donné :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;initialement 1, 2, 3, 4, 5, 6.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Après l&amp;rsquo;&lt;code&gt;UPDATE&lt;/code&gt; 1, 2, 4, 5, 6, 3.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Après le &lt;code&gt;DELETE&lt;/code&gt; 1, 2, 5, 6, 3.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;HOT UPDATE&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Le Heap Only Tuple UPDATE (ou simplement &lt;code&gt;HOT UPDATE&lt;/code&gt;) un processus particulier de PostgreSQL qui se produit lorsqu&amp;rsquo;il reste suffisamment de place dans une page pour que l&amp;rsquo;ancienne et la nouvelle version d&amp;rsquo;un tuple y soient stockées.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Lancez maintenant la requête suivante :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;-- Mise à jour de la ligne 3 (oui encore)&#xA;UPDATE public.table_test&#xA;SET commentaire_2 = &#39;Un commentaire&#39;&#xA;WHERE id = 3&#xA;;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Analysez les données de la deuxième page :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;SELECT * FROM public.get_heap_tuple_info(&#39;public.table_test&#39;, 1);&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure class=&#34;wp-block-table&#34;&gt;&lt;table class=&#34;has-fixed-layout&#34;&gt;&lt;thead&gt;&lt;tr&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;ctid&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;page_index&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;offset_start&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;xmin&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;xmax&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;state&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;visible&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;update&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;direction&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;hot&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;delete&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;freeze&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;Identifiant de la ligne : numéro de page, numéro d&amp;rsquo;index dans la page&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;Numéro d&amp;rsquo;index du tuple dans la page.&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;Position du début du tuple.&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;ID de la transaction à partir de laquelle le tuple est visible&lt;/em&gt;.&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;&lt;em&gt;ID de la transaction au delà de laquelle le tuple n&amp;rsquo;est plus visible&lt;/em&gt;.&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;État du tuple.&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;Visibilité du tuple.&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;Le tuple a-t-il été mis à jour&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;to : vers un autre tuple.&lt;br&gt;from : depuis unautre tuple&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;HOT UPDATE&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;Tuple supprimé&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;xmin gelé&lt;/em&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;(1,1)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;6184&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4435 &amp;#8211; c&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;normal&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;(1,4)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4176&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4440 &amp;#8211; c&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4454 &amp;#8211; c&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;normal&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Non&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;from and to another line&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;(1,3)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2168&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4453 &amp;#8211; c&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;normal&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;(1,4)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;160&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4454 &amp;#8211; c&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;normal&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;from another line&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Cette fois-ci vous pouvez voir :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;L&amp;rsquo;&lt;code&gt;INSERT&lt;/code&gt; est fait en fin de données (&lt;code&gt;ctid = (1,2)&lt;/code&gt;).&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;L&amp;rsquo;&lt;code&gt;UPDATE&lt;/code&gt; de la ligne &lt;code&gt;id = 3&lt;/code&gt; est ici un &lt;code&gt;HOT UPDATE&lt;/code&gt;.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voici le processus en image :&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure class=&#34;aligncenter size-full&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://blog.arthurbazin.com/wp-content/uploads/tuto_vacuum_page_content_hot_1-1.svg&#34; alt=&#34;&#34; class=&#34;wp-image-3104&#34;/&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Voici la table dans son état initial&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure class=&#34;aligncenter size-full&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://blog.arthurbazin.com/wp-content/uploads/tuto_vacuum_page_content_hot_2.svg&#34; alt=&#34;&#34; class=&#34;wp-image-3106&#34;/&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;&lt;br&gt;Première étape du HOT UPDATE&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p&gt;La nouvelle version du tuple est insérée en dernière position avec le &lt;code&gt;ctid = (1,4)&lt;/code&gt; et porte de tag « HOT UPDATE ».&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;L&amp;rsquo;ancienne version est « désactivée » : son &lt;code&gt;ctid&lt;/code&gt; devient &lt;code&gt;(1,4)&lt;/code&gt; et les tags « HOT UPDATE » et « HEAP ONLY TUPLE » sont ajoutés. Ceci permet à PostgreSQL de comprendre, lors de la lecture du tuple 2, qu&amp;rsquo;il doit aller lire le tuple 4.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Le &lt;code&gt;HOT UPDATE&lt;/code&gt; n&amp;rsquo;est en réalité pas terminé, une seconde opération va être menée par la base.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Faites la requête SELECT suivante puis réanalysez la table :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;generic&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;-- SELECT&#xA;SELECT * FROM public.table_test;&#xA;&#xA;-- Analyse&#xA;SELECT * FROM public.get_heap_tuple_info(&#39;public.table_test&#39;, 1);&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voici les données de la 2ème page : &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure class=&#34;wp-block-table&#34;&gt;&lt;table class=&#34;has-fixed-layout&#34;&gt;&lt;thead&gt;&lt;tr&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;ctid&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;page_index&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;offset_start&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;xmin&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;xmax&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;state&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;visible&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;update&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;direction&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;hot&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;delete&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;freeze&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;Identifiant de la ligne : numéro de page, numéro d&amp;rsquo;index dans la page&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;Numéro d&amp;rsquo;index du tuple dans la page.&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;Position du début du tuple.&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;ID de la transaction à partir de laquelle le tuple est visible&lt;/em&gt;.&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;&lt;em&gt;ID de la transaction au delà de laquelle le tuple n&amp;rsquo;est plus visible&lt;/em&gt;.&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;État du tuple.&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;Visibilité du tuple.&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;Le tuple a-t-il été mis à jour&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;to : vers un autre tuple.&lt;br&gt;from : depuis unautre tuple&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;HOT UPDATE&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;Tuple supprimé&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;xmin gelé&lt;/em&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;(1,1)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;6184&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4435 &amp;#8211; c&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;normal&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;redirect to 4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Non&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;from and to another line&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;(1,3)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4176&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4453 &amp;#8211; c&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;normal&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;(1,4)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2168&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4454 &amp;#8211; c&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;normal&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;from another line&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Le tuple 2, qui contient l&amp;rsquo;ancienne version de la ligne &lt;code&gt;id = 3&lt;/code&gt;, a été « nettoyée » et sont pointeur redirige vers le pointeur 4. L&amp;rsquo;offset des tuples a été modifié à cause d&amp;rsquo;une défragmentation de la page : c&amp;rsquo;est la seconde opération du &lt;code&gt;HOT UPDATE&lt;/code&gt;.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voici le processus imagé :&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure class=&#34;aligncenter size-full&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://blog.arthurbazin.com/wp-content/uploads/tuto_vacuum_page_content_hot_3-1.svg&#34; alt=&#34;&#34; class=&#34;wp-image-3107&#34;/&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Pruning : mise à jour du pointeur ce qui tue le tuple 2&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p&gt;Lors de la première requête qui suit l&amp;rsquo;&lt;code&gt;UPDATE&lt;/code&gt; et qui lit les données de la table (un &lt;code&gt;SELECT&lt;/code&gt; par exemple), PostgreSQL opère un processus de pruning :&lt;br&gt;il met à jour le pointeur du tuple 2 et remplace la valeur de position du tuple 2 par celle du pointeur de la nouvelle version (ici le pointeur 4).&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Ainsi, lors d&amp;rsquo;une lecture de la donnée, c&amp;rsquo;est toujours le pointeur 2 qui sera lu en premier mais PostgreSQL est directement redirigé vers le nouveau pointeur (le 4) qui l&amp;rsquo;envoi ainsi vers le nouveau tuple (le 4 donc). Ceci permet de ne pas avoir à modifier les index dans ce type de situation.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Notez que dans le cas d&amp;rsquo;une lecture séquentiel, cette opération (de redirection) est similaire en temps et en coût que de lire directement le pointeur 4.&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure class=&#34;aligncenter size-full&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://blog.arthurbazin.com/wp-content/uploads/tuto_vacuum_page_content_hot_4-1.svg&#34; alt=&#34;&#34; class=&#34;wp-image-3108&#34;/&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p&gt;PostgreSQL effectue ensuite une défragmentation de la page en supprimant physiquement le tuple 2 (ce qui entraine un « décalage » des tuples pour combler l&amp;rsquo;espace vide). Cette défragmentation ne concerne pas les pointeurs, le 2&lt;sup&gt;ème&lt;/sup&gt; reste donc présent, référençant toujours le pointeur 4 (toujours pour ne pas avoir à toucher aux index).&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Le processus de lecture est donc identique à l&amp;rsquo;étape précédente mais de l&amp;rsquo;espace est rendu disponible.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Notez que si un second &lt;code&gt;HOT UPDATE&lt;/code&gt; est réalisé sur le même tuple et ceci juste après le premier &lt;code&gt;HOT UPDATE&lt;/code&gt;, la nouvelle version est insérée dans l&amp;rsquo;espace qui aurait du être nettoyé par la défragmentation, le pointeur qui redirigeait vers un autre pointeur (pt&lt;sub&gt;1-2&lt;/sub&gt; dans notre exemple) est alors rétabli. La défragmentation nettoiera alors le tuple intermédiaire ainsi que son pointeur (pt&lt;sub&gt;1-4&lt;/sub&gt;, tuple 4).&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Le &lt;code&gt;HOT UPDATE&lt;/code&gt; est ainsi plus rapide à executer qu&amp;rsquo;un &lt;code&gt;UPDATE&lt;/code&gt; classique et permet de libérer de l&amp;rsquo;espace en évitant de conserver l&amp;rsquo;ancien tuple.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Vous savez maintenant plus précisément comment fonctionne le stockage physique. Vous voyez ainsi que lorsque beaucoup d&amp;rsquo;opérations sont faites, des lignes mortes ainsi que des pointeurs supplémentaires sont présents dans vos tables ce qui entraine une grande perte d&amp;rsquo;espace.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Heureusement, un outil spécifique existe pour nettoyer tout cela : le &lt;code&gt;VACUUM&lt;/code&gt;.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34; id=&#34;vacuum&#34;&gt;VACUUM&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Passons l&amp;rsquo;aspirateur ! Ce n&amp;rsquo;est pas pour rien que le mot &lt;em&gt;VACUUM&lt;/em&gt; a été choisi pour cette opération&amp;#8230;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Le VACUUM consiste en le nettoyage d&amp;rsquo;une table afin d&amp;rsquo;en retirer tous les éléments qui ne sont plus utiles (lignes mortes) ainsi que de réarranger les éléments pour gagner de la place.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Deux types de VACUUM existent :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;Le Plain VACUUM (standard) : nettoyage rapide et défragmentation partielle de la table.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Le VACUUM FULL (complet) : nettoyage et défragmentation complets de la table.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;L&amp;rsquo;opération de VACUUM est lancée automatiquement par PostgreSQL via l&amp;rsquo;autovacuum.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h4 class=&#34;wp-block-heading&#34;&gt;VACUUM standard&lt;/h4&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Le VACUUM standard (ou VACUUM concurrentiel ou Plain VACUUM) peut être exécuter sans verrouiller la table sur laquelle il porte.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Il opère les actions suivantes :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ol class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;Analyse des pages pour identifier les tuples morts (issus d&amp;rsquo;un &lt;code&gt;UPDATE&lt;/code&gt;, d&amp;rsquo;un &lt;code&gt;DELETE&lt;/code&gt; ou d&amp;rsquo;une transaction abandonnée).&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;FREEZE des tuples si nécessaire (voir le chapitre VACUUM FREEZE)&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Suppression des entrées des index correspondant à des tuples morts.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Pour chaque page :&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;Suppression des tuples morts&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Défragmentation de la page pour récupérer l&amp;rsquo;espace des tuples morts.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Mise à jour de la &lt;em&gt;free space map&lt;/em&gt; et de la &lt;em&gt;visibility map&lt;/em&gt;.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Suppression de la dernière page si possible (si aucun tuple vivant dedans).&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Mise à jour des statistiques de la table dans les tables système.&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;L&amp;rsquo;étape 1 commence par un listing des tuples mort, cette lsite est créée en mémoire. C&amp;rsquo;est pour cette étape que la variable de configuration &lt;code&gt;maintenance_work_mem&lt;/code&gt; est importante. En effet, si sa valeur est trop faible, PostgreSQL devra itérer plusieurs fois sur la table jusqu’à ce qu&amp;rsquo;il ne trouve plus de tuple mort.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;L&amp;rsquo;étape 2 est un FREEZE des valeurs &lt;em&gt;xmin&lt;/em&gt; des tuples. Cette opération est détaillée dans le chapitre &lt;a href=&#34;#vacuum_freeze&#34;&gt;VACUUM FREEZE&lt;/a&gt;.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;L&amp;rsquo;étape 4 se déroule de la façon suivante :&lt;/p&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure class=&#34;aligncenter size-full&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://blog.arthurbazin.com/wp-content/uploads/tuto_vacuum_vac_plain_1.svg&#34; alt=&#34;&#34; class=&#34;wp-image-3114&#34;/&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;État initial : un tuple est considéré comme mort&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure class=&#34;aligncenter size-full&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://blog.arthurbazin.com/wp-content/uploads/tuto_vacuum_vac_plain_2.svg&#34; alt=&#34;&#34; class=&#34;wp-image-3115&#34;/&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Les données sont effacées et le pointeur du tuple est réinitialisé&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure class=&#34;aligncenter size-full&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://blog.arthurbazin.com/wp-content/uploads/tuto_vacuum_vac_plain_3.svg&#34; alt=&#34;&#34; class=&#34;wp-image-3117&#34;/&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;La défragmentation réorganise les données mais conserve le pointeur 2&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p&gt;Voici un exemple, repartez de notre table d&amp;rsquo;exemple utilisée précédemment (disponible dans l&amp;rsquo;onglet « initialisation ») puis supprimez quelques lignes et analysezla :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;get_heap_tuple_info()&#34; data-enlighter-group=&#34;start_vacuum_plain&#34;&gt;DELETE FROM public.table_test&#xA;WHERE id IN (6, 3)&#xA;;&#xA;&#xA;SELECT * FROM public.get_heap_tuple_info(&#39;public.table_test&#39;);&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;Initialisation&#34; data-enlighter-group=&#34;start_vacuum_plain&#34;&gt;-- !!!&#xA;-- Attention à bien exécuter chaque requête dans une transaction spécifique&#xA;-- Ce que permet le COMMIT à la suite de chaque requête si vous lancez tout d&#39;un seul bloc&#xA;-- !!!&#xA;&#xA;-- Création de la table&#xA;CREATE TABLE public.table_test (&#xA;  id int4,&#xA;  commentaire_1 char(1955),&#xA;  commentaire_2 text&#xA;)&#xA;;&#xA;COMMIT;&#xA;&#xA;-- Insertion de données&#xA;INSERT INTO &#xA;  public.table_test (id, commentaire_1, commentaire_2)&#xA;VALUES &#xA;  (1, &#39;A&#39;, &#39;un commentaire&#39;),&#xA;  (2, &#39;B&#39;, &#39;un commentaire vraiment très très très long&#39;)&#xA;;&#xA;COMMIT;&#xA;&#xA;-- Insertion de données&#xA;INSERT INTO &#xA;  public.table_test (id, commentaire_1, commentaire_2)&#xA;VALUES &#xA;  (3, &#39;C&#39;, &#39;un commentaire&#39;),&#xA;  (4, &#39;D&#39;, &#39;un commentaire&#39;),&#xA;  (5, &#39;E&#39;, &#39;un commentaire&#39;),&#xA;  (6, &#39;F&#39;, &#39;un commentaire&#39;)&#xA;;&#xA;COMMIT;&#xA;&#xA;-- Mise à jour de la ligne 2&#xA;UPDATE public.table_test&#xA;SET commentaire_2 = &#39;Un autre commentaire&#39;&#xA;WHERE id = 3&#xA;;&#xA;COMMIT;&#xA;&#xA;-- Suppression de la ligne 4&#xA;DELETE FROM public.table_test&#xA;WHERE id = 4&#xA;;&#xA;COMMIT;&#xA;&#xA;-- Ajout d&#39;une ligne&#xA;INSERT INTO &#xA;  public.table_test (id, commentaire_1, commentaire_2)&#xA;VALUES &#xA;  (7, &#39;G&#39;, &#39;un commentaire&#39;)&#xA;;&#xA;COMMIT;&#xA;&#xA;-- Mise à jour de la ligne 3 (oui encore)&#xA;UPDATE public.table_test&#xA;SET commentaire_2 = &#39;Un commentaire&#39;&#xA;WHERE id = 3&#xA;;&#xA;COMMIT;&#xA;&#xA;-- Sélection des données pour finalisation HOT UPDATE&#xA;SELECT * FROM public.table_test&#xA;;&#xA;COMMIT;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Vous devriez avoir la structure suivante :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure class=&#34;wp-block-table&#34;&gt;&lt;table class=&#34;has-fixed-layout&#34;&gt;&lt;thead&gt;&lt;tr&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;ctid&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;page_num&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;page_index&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;offset_start&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;xmin&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;xmax&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;state&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;visible&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;update&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;delete&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;freeze&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;Identifiant de la ligne : numéro de page, numéro d&amp;rsquo;index dans la page&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;Numéro de page&lt;/em&gt;.&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;Numéro d&amp;rsquo;index du tuple dans la page.&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;Position du début du tuple.&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;ID de la transaction à partir de laquelle le tuple est visible&lt;/em&gt;.&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;&lt;em&gt;ID de la transaction au delà de laquelle le tuple n&amp;rsquo;est plus visible&lt;/em&gt;.&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;État du tuple.&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;Visibilité du tuple.&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;Le tuple a-t-il été mis à jour&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;Tuple supprimé&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;xmin gelé&lt;/em&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;(0,1)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;6184&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4527 &amp;#8211; c&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;normal&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;(0,2)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;6072&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4527 &amp;#8211; c&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;normal&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;dead&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Non&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;(0,4)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4064&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4528 &amp;#8211; c&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4530 &amp;#8211; c&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;normal&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Non&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;(0,5)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;5&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2056&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4528 &amp;#8211; c&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;normal&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;(1,1)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;6184&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4528 &amp;#8211; c&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4533 &amp;#8211; c&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;normal&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Non&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;redirect to 4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Non&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;(1,3)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4176&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4531 &amp;#8211; c&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;normal&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;(1,4)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2168&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4532 &amp;#8211; c&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4533 &amp;#8211; c&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;normal&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Non&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Notez la différence entre les tuples non visibles qui ont été mis à jour et les tuples non visibles qui ont été supprimés :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;Les premiers ont déjà été nettoyés des tables, leurs pointeurs sont toujours présents mais ne pointent vers rien ou redirigent vers un autre pointeur.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Les seconds en revanche sont toujours présents mais simplement non visibles.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Regardez également le résultat de la requête suivante :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;SELECT * FROM public.get_heap_page_info(&#39;public.table_test&#39;);&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voici les résultats :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure class=&#34;wp-block-table&#34;&gt;&lt;table class=&#34;has-fixed-layout&#34;&gt;&lt;thead&gt;&lt;tr&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;page_num&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;nb_pointer&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;nb_tuple&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;nb_tuple_visible&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;length_pointer&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;length_free_space&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;length_tuple&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Numéro de page&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Nombre de pointeur.&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Nombre de tuple.&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Nombre de tuples visibles.&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Taille de l&amp;rsquo;ensemble des pointeurs.&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Taille de l&amp;rsquo;espace libre.&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Taille occupée par les tuples.&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;5&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;20&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2012&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;6136&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;16&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2128&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;6024&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Lancez un VACUUM puis analysez les données :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;VACUUM public.table_test;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;SELECT * FROM public.get_heap_tuple_info(&#39;public.table_test&#39;);&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voici les résultats :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure class=&#34;wp-block-table&#34;&gt;&lt;table class=&#34;has-fixed-layout&#34;&gt;&lt;thead&gt;&lt;tr&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;ctid&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;page_num&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;page_index&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;offset_start&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;xmin&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;xmax&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;state&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;visible&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;update&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;delete&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;freeze&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;Identifiant de la ligne : numéro de page, numéro d&amp;rsquo;index dans la page&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;Numéro de page&lt;/em&gt;.&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;Numéro d&amp;rsquo;index du tuple dans la page.&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;Position du début du tuple.&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;ID de la transaction à partir de laquelle le tuple est visible&lt;/em&gt;.&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;&lt;em&gt;ID de la transaction au delà de laquelle le tuple n&amp;rsquo;est plus visible&lt;/em&gt;.&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;État du tuple.&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;Visibilité du tuple.&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;Le tuple a-t-il été mis à jour&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;Tuple supprimé&lt;/em&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;em&gt;xmin gelé&lt;/em&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;(0,1)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;6184&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4527 &amp;#8211; f&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;normal&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;(0,2)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;6072&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4527 &amp;#8211; f&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;normal&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;unused&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Non&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;unused&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Non&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;(0,5)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;5&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4064&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4528 &amp;#8211; f&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;normal&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;unused&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Non&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;unused&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Non&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;(1,3)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;6184&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4531 &amp;#8211; f&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;normal&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Vous pouvez voir que les tuples vivants ont été réorganisés (modification des offsets), quand aux morts, ils ont été supprimés mais leurs pointeurs sont toujours présents dans un état « inutilisé ».&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Regardez les statistiques au niveau de chaque page :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;SELECT * FROM public.get_heap_page_info(&#39;public.table_test&#39;);&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voici les résultats :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure class=&#34;wp-block-table&#34;&gt;&lt;table class=&#34;has-fixed-layout&#34;&gt;&lt;thead&gt;&lt;tr&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;page_num&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;nb_pointeur&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;nb_tuple&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;nb_tuple_visible&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;length_pointer&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;length_free_space&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;length_tuple&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Numéro de page&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Nombre de pointeur.&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Nombre de tuple.&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Nombre de tuples visibles.&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Taille de l&amp;rsquo;ensemble des pointeurs.&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Taille de l&amp;rsquo;espace libre.&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Taille occupée par les tuples.&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;5&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;20&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4020&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4128&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;12&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;6148&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2008&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Vous pouvez voir immédiatement que l&amp;rsquo;espace précédemment occupé par les tuples morts a pu être récupéré. Les prochaines insertions se feront alors d&amp;rsquo;abord dans la première page puis dans la seconde avant de créer une éventuelle troisième page.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;En revanche, vous pouvez voir que les pointeurs n&amp;rsquo;ont pas disparus.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Notez également que les données présentes dans la page 2 pourraient tout à fait être transférées dans la page 1 maintenant qu&amp;rsquo;il y a suffisamment de place., c&amp;rsquo;est le &lt;code&gt;VACUUM FULL&lt;/code&gt; qui permet de faire cela.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h4 class=&#34;wp-block-heading&#34;&gt;VACUUM FULL&lt;/h4&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Le VACUUM FULL permet d&amp;rsquo;aller au delà du VACUUM standard. En effet, ce dernier ne permet pas de réduire la taille des tables.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Le VACUUM FULL réécrit complètement le &lt;em&gt;heap file&lt;/em&gt; afin de réorganiser les tuples et d&amp;rsquo;éliminer les pages en trop. L&amp;rsquo;avantage est un gain de place qui peut être conséquent.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;L&amp;rsquo;inconvénient est que pendant la réécriture, la table n&amp;rsquo;est plus accessible. Un autre inconvénient est que deux versions de la table seront présentes sur le disque lors de la phase de réécriture ce qui peut entrainer des problèmes d&amp;rsquo;espace disque si les données sont très volumineuses.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Reprenez notre exemple (disponible dans l&amp;rsquo;onglet « initialisation ») et analysez la table avec la fonction &lt;code&gt;get_heap_page_info()&lt;/code&gt; :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;get_heap_tuple_info()&#34; data-enlighter-group=&#34;start_vacuum_full&#34;&gt;-- Quelques statistiques&#xA;SELECT * FROM public.get_heap_page_info(&#39;public.table_test&#39;);&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;Initialisation&#34; data-enlighter-group=&#34;start_vacuum_full&#34;&gt;-- !!!&#xA;-- Attention à bien exécuter chaque requête dans une transaction spécifique&#xA;-- Ce que permet le COMMIT à la suite de chaque requête si vous lancez tout d&#39;un seul bloc&#xA;-- !!!&#xA;&#xA;-- Création de la table&#xA;CREATE TABLE public.table_test (&#xA;  id int4,&#xA;  commentaire_1 char(1955),&#xA;  commentaire_2 text&#xA;)&#xA;;&#xA;COMMIT;&#xA;&#xA;-- Insertion de données&#xA;INSERT INTO &#xA;  public.table_test (id, commentaire_1, commentaire_2)&#xA;VALUES &#xA;  (1, &#39;A&#39;, &#39;un commentaire&#39;),&#xA;  (2, &#39;B&#39;, &#39;un commentaire vraiment très très très long&#39;)&#xA;;&#xA;COMMIT;&#xA;&#xA;-- Insertion de données&#xA;INSERT INTO &#xA;  public.table_test (id, commentaire_1, commentaire_2)&#xA;VALUES &#xA;  (3, &#39;C&#39;, &#39;un commentaire&#39;),&#xA;  (4, &#39;D&#39;, &#39;un commentaire&#39;),&#xA;  (5, &#39;E&#39;, &#39;un commentaire&#39;),&#xA;  (6, &#39;F&#39;, &#39;un commentaire&#39;)&#xA;;&#xA;COMMIT;&#xA;&#xA;-- Mise à jour de la ligne 2&#xA;UPDATE public.table_test&#xA;SET commentaire_2 = &#39;Un autre commentaire&#39;&#xA;WHERE id = 3&#xA;;&#xA;COMMIT;&#xA;&#xA;-- Suppression de la ligne 4&#xA;DELETE FROM public.table_test&#xA;WHERE id = 4&#xA;;&#xA;COMMIT;&#xA;&#xA;-- Ajout d&#39;une ligne&#xA;INSERT INTO &#xA;  public.table_test (id, commentaire_1, commentaire_2)&#xA;VALUES &#xA;  (7, &#39;G&#39;, &#39;un commentaire&#39;)&#xA;;&#xA;COMMIT;&#xA;&#xA;-- Mise à jour de la ligne 3 (oui encore)&#xA;UPDATE public.table_test&#xA;SET commentaire_2 = &#39;Un commentaire&#39;&#xA;WHERE id = 3&#xA;;&#xA;COMMIT;&#xA;&#xA;-- Sélection des données pour finalisation HOT UPDATE&#xA;SELECT * FROM public.table_test&#xA;;&#xA;COMMIT;&#xA;&#xA;-- VACUUM Standard&#xA;VACUUM public.table_test&#xA;;&#xA;COMMIT;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voici les résultats :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure class=&#34;wp-block-table&#34;&gt;&lt;table class=&#34;has-fixed-layout&#34;&gt;&lt;thead&gt;&lt;tr&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;page_num&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;nb_pointeur&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;nb_tuple&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;length_free_space&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;unused_line_pointer&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Numéro de page&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Nombre de pointeur.&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Nombre de tuple.&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Taille de l&amp;rsquo;espace libre.&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Présence de pointeurs non utilisés.&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;5&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4020&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;6148&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Oui&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Maintenant, réalisez un VACUUM FULL :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;-- VACUUM FULL&#xA;VACUUM FULL public.table_test&#xA;;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Réanalysons la table :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;SELECT * FROM public.get_heap_page_info(&#39;public.table_test&#39;);&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voici le retour :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure class=&#34;wp-block-table&#34;&gt;&lt;table class=&#34;has-fixed-layout&#34;&gt;&lt;thead&gt;&lt;tr&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;page_num&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;nb_pointeur&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;nb_tuple&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;length_free_space&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;unused_line_pointer&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Numéro de page&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Nombre de pointeur.&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Nombre de tuple.&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Taille de l&amp;rsquo;espace libre.&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Présence de pointeurs non utilisés.&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2016&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Non&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Les tuples ont été réorganisés sur la première page du nouveau fichier. D&amp;rsquo;ailleurs dans l&amp;rsquo;exemple, mon filenode était &lt;strong&gt;350934&lt;/strong&gt; (l&amp;rsquo;OID de la table). Grâce à la fonction &lt;code&gt;get_table_info()&lt;/code&gt; je vois maintenant qu&amp;rsquo;il est égal à &lt;strong&gt;351418&lt;/strong&gt; : le fichier heap a bien été réécrit.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Notez que le VACUUM FULL réécrit également les index, la visibility map ainsi que la free space map.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h4 class=&#34;wp-block-heading&#34; id=&#34;vacuum_freeze&#34;&gt;FREEZE des données&lt;/h4&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Le VACUUM possède une option : &lt;code&gt;FREEZE&lt;/code&gt; qui permet de geler les données. Mais à quoi ça sert ?&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h5 class=&#34;wp-block-heading&#34;&gt;ID de transaction&lt;/h5&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Comme vous l&amp;rsquo;avez vu, le système de contrôle d&amp;rsquo;accès simultané (MVCC) utilise l&amp;rsquo;identifiant des transactions pour déterminer la visibilité des tuples. Cet identifiant est nommé &lt;strong&gt;txid&lt;/strong&gt; et est assigné par le gestionnaire de transaction. Il s&amp;rsquo;agit d&amp;rsquo;un nombre entier non signé de 32 bit (soit 2&lt;sup&gt;32&lt;/sup&gt; = 4 294 967 295 valeurs différentes).&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Ainsi, lorsqu&amp;rsquo;une transaction est en cours, tous les éléments portant un &lt;em&gt;txid&lt;/em&gt; inférieur à celui de la transaction sont considérés comme dans le passé et donc modifiables par la transaction. Tous ceux qui ont un &lt;em&gt;txid&lt;/em&gt; supérieur, sont dans le futur et donc non modifiables par la transaction (cela dépend du mode de transaction utilisé mais ne compliquons pas les choses).&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Notez qu&amp;rsquo;une seule transaction peut contenir plusieurs instructions SQL, chaque instruction se voit alors assigner un identifiant de commande (&lt;strong&gt;cid&lt;/strong&gt;), nombre entier non signé de 32 bits également ; permettant de comparer les résultats des instructions les uns par rapport aux autres, exactement comme avec les &lt;em&gt;txid&lt;/em&gt;, au sein de la transaction. Ceci contraint d&amp;rsquo;ailleurs le système à ne pouvoir exécuter « que » 4,2 milliard d&amp;rsquo;instructions SQL par transaction (on est large&amp;#8230;)&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Les &lt;em&gt;txid&lt;/em&gt; suivants sont spéciaux :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;0 : &lt;em&gt;txid&lt;/em&gt; invalide.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;1 : &lt;em&gt;txid&lt;/em&gt; d&amp;rsquo;initialisation du cluster.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;2 : avant PG 9.4, il s&amp;rsquo;agit de la valeur &lt;em&gt;xmin&lt;/em&gt; gelée, maintenant c&amp;rsquo;est un drapeau qui est ajouté au tuple.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;L&amp;rsquo;assignement du &lt;em&gt;txid&lt;/em&gt; se produit lorsque la transaction commence à écrire et n&amp;rsquo;indique donc pas l&amp;rsquo;ordre de démarrage des transactions. Ceci implique qu&amp;rsquo;une transaction peut « doubler » une autre. &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Par exemple :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure class=&#34;wp-block-table&#34;&gt;&lt;table class=&#34;has-fixed-layout&#34;&gt;&lt;thead&gt;&lt;tr&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Horaire&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Transaction 1&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Transaction 2&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;10h00&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Démarrage transaction&lt;br&gt;Début &lt;code&gt;SELECT&lt;/code&gt; sur la table X&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;10h05&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Démarrage transaction&lt;br&gt;Début &lt;code&gt;INSERT&lt;/code&gt; sur la table Y&lt;br&gt;&lt;strong&gt;=&amp;gt; Assignation d&amp;rsquo;un txid&lt;/strong&gt; : 1000&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;10h06&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Fin &lt;code&gt;INSERT&lt;/code&gt; sur la table Y&lt;br&gt;Fin transaction&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;10h08&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Fin &lt;code&gt;SELECT&lt;/code&gt; sur la table X&lt;br&gt;Début &lt;code&gt;UPDATE&lt;/code&gt; sur la table Y&lt;br&gt;&lt;strong&gt;=&amp;gt; Assignation d&amp;rsquo;un txid&lt;/strong&gt; : 1001&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;10h09&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Fin &lt;code&gt;UPDATE&lt;/code&gt; sur la table Y&lt;br&gt;Fin transaction&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Les actions de la transaction 1 sont considérées comme ayant été réalisées après la transaction 2 bien que cette dernière ait démarrée après&lt;/figcaption&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;h5 class=&#34;wp-block-heading&#34;&gt;Bouclage ou wraparound&lt;/h5&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Le problème, c&amp;rsquo;est que 4,2 milliards de valeurs ce n&amp;rsquo;est pas forcément assez dans la vie d&amp;rsquo;une base de données. Lorsqu&amp;rsquo;il y a plusieurs milliers de transactions par minutes, le compteur peut être dépassé en moins de 8 ans (ok on est large mais une base avec plusieurs millions de transactions par jour cela peut arriver).&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Pour résoudre ceci, PostgreSQL utilise le bouclage (wraparround) : lorsque les 4,2 milliards de valeurs sont atteintes, le compteur redémarre à 0. Le problème c&amp;rsquo;est qu&amp;rsquo;au moment du bouclage, la transaction portant le &lt;code&gt;txid = 4,1 milliards&lt;/code&gt; qui était dans le passé se retrouve alors dans le futur (le &lt;em&gt;txid&lt;/em&gt; courant étant maintenant inférieur). Pour éviter ce phénomène, PostgreSQL considère que les 2,1 milliards de transactions précédentes sont dans le passé et les 2,1 milliards suivantes dans le futur en tenant compte de ce bouclage.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Par exemple, ma transaction porte le &lt;code&gt;txid = 1000&lt;/code&gt;, la « boucle du temps » serait la suivante :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure class=&#34;wp-block-table is-style-regular&#34;&gt;&lt;table class=&#34;has-fixed-layout&#34;&gt;&lt;thead&gt;&lt;tr&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;txid&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Temporalité&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&amp;lt;- Passé&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;999&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&amp;lt;- Passé&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-bleu-dodger-color&#34;&gt;&lt;strong&gt;1000&lt;/strong&gt;&lt;/mark&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-bleu-dodger-color&#34;&gt;&lt;strong&gt;Présent&lt;/strong&gt;&lt;/mark&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1001&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Futur -&amp;gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;sup&gt;31&lt;/sup&gt; + 999&lt;br&gt;2 147 484 647&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Futur -&amp;gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;sup&gt;31&lt;/sup&gt; + 1000&lt;br&gt;2 147 484 648&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&amp;lt;- Passé&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;sup&gt;32&lt;/sup&gt;&lt;br&gt;4 294 967 295&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&amp;lt;- Passé&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-image&#34;&gt;&#xA;&lt;figure class=&#34;aligncenter size-full&#34;&gt;&lt;img decoding=&#34;async&#34; src=&#34;https://blog.arthurbazin.com/wp-content/uploads/tuto_vacuum_freeze_wraparround-2.svg&#34; alt=&#34;&#34; class=&#34;wp-image-3132&#34;/&gt;&lt;/figure&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&lt;p&gt;Voici une requête pour connaitre les limites de votre passé et de votre futur :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;SELECT &#xA;  txid_current() AS &#34;txid_current&#34;,&#xA;  CASE &#xA;    WHEN txid_current() &amp;lt; 2^31 THEN txid_current() + 2^31 - 1&#xA;    ELSE txid_current() + 2^31 - 2^32 - 1&#xA;  END AS &#34;limite_futur&#34;,&#xA;  CASE &#xA;    WHEN txid_current() &gt; 2^31 THEN txid_current() - 2^31&#xA;    ELSE txid_current() - 2^31 + 2^32&#xA;  END AS &#34;limite_passé&#34;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;h5 class=&#34;wp-block-heading&#34;&gt;Gel des données : Freeze&lt;/h5&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Le problème qui peut survenir c&amp;rsquo;est que lorsqu&amp;rsquo;il y a eu plus de 2,1 (exactement 2&lt;sup&gt;21&lt;/sup&gt;) milliards de transactions, PostgreSQL va considérer d&amp;rsquo;anciennes transactions comme étant dans le futur. Pas très pratique&amp;#8230;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;C&amp;rsquo;est pour résoudre ce problème que le FREEZE a été inventé. Il permet d&amp;rsquo;ajouter un drapeau sur un tuple indiquant que son &lt;em&gt;xmin &lt;/em&gt;est « gelé », c&amp;rsquo;est à dire que peu importe la valeur du &lt;em&gt;xmin&lt;/em&gt;, il doit être considéré comme inférieur au &lt;em&gt;txid&lt;/em&gt; actuel, même si ce n&amp;rsquo;est pas le cas.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Pour cela, le VACUUM se charge de geler les lignes adéquates selon les cas suivants :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;&lt;strong&gt;VACUUM standard :&lt;/strong&gt; tous les tuples dont le &lt;em&gt;xmin&lt;/em&gt; est inférieur de la valeur à : &lt;code&gt;oldest_current_txid&lt;/code&gt; &amp;#8211; &lt;code&gt;vacuum_freeze_min_age&lt;/code&gt;&lt;br&gt;Le FREEZE n&amp;rsquo;est opéré que sur les pages pour lesquelles le VACUUM opère : les pages contenant des tuples morts. On parle alors de lazy FREEZE (FREEZE paresseux).&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;La valeur de &lt;code&gt;vacuum_freeze_min_age&lt;/code&gt; est définie dans le fichier &lt;em&gt;postgresql.com&lt;/em&gt; et est fixée par défaut fixée à 50 000 000.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;oldest_current_txid&lt;/code&gt; correspond au plus vieux txid des transaction en cours.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;strong&gt;VACUUM FREEZE :&lt;/strong&gt; tous les tuples dont le &lt;em&gt;xmin&lt;/em&gt; est inférieur à &lt;code&gt;oldest_current_txid&lt;/code&gt;.&lt;br&gt;Le FREEZE est opéré sur toutes les pages de la table. On parle de FREEZE aggressif.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;strong&gt;VACUUM FULL :&lt;/strong&gt; équivalent du VACUUM FREEZE, les opérations de nettoyage sont différentes mais les opérations de FREEZE intégrée sont équivalentes.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Si l&amp;rsquo;age de la table (age du plus vieux tuple) dépasse la valeur de la variable &lt;code&gt;vacuum_freeze_table_age&lt;/code&gt; (par défaut 150 000 000) alors le prochain VACUUM lancé s&amp;rsquo;accompagnera d&amp;rsquo;un FREEZE aggressif.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Attention car le gel des tuples d&amp;rsquo;une page implique de réécrire entièrement cette dernière et a donc un coût important. Si le VACUUM prend trop de temps, il est possible de le stopper, le travail déjà accompli en sera pas perdu (notamment sur le gel des données).&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;A la fin du VACUUM, des statistiques sont calculées et les valeurs suivantes renseignées :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;&lt;code&gt;pg_catalog.pg_class.relfrozenxid&lt;/code&gt; : &lt;em&gt;txid&lt;/em&gt; le plus récent ayant été gelé dans la table.&lt;br&gt;Il s&amp;rsquo;agit de la valeur ayant été utilisée pour geler les tuples (&lt;code&gt;txid&lt;/code&gt; ou &lt;code&gt;txid&lt;/code&gt; &amp;#8211; &lt;code&gt;vacuum_freeze_min_age&lt;/code&gt;), pas forcément du &lt;em&gt;txid&lt;/em&gt; gelé le plus récent ; ce dernier est en effet plus ancien ou égal à cette valeur.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;pg_catalog.pg_database.datfrozenxid&lt;/code&gt; : &lt;em&gt;txid&lt;/em&gt; le plus récent ayant été gelé dans toute la base.&lt;br&gt;Il s&amp;rsquo;agit du &lt;code&gt;pg_catalog.pg_class.relfrozenxid&lt;/code&gt; le plus ancien.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Dans le cas de notre exemple, la colonne &lt;code&gt;max_frozen_txid&lt;/code&gt; de la fonction &lt;code&gt;get_table_info()&lt;/code&gt; vaut &lt;code&gt;pg_catalog.pg_class.relfrozenxid&lt;/code&gt;.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h4 class=&#34;wp-block-heading&#34;&gt;AUTOVACUUM&lt;/h4&gt;&#xA;&#xA;&#xA;&#xA;&lt;blockquote class=&#34;wp-block-quote is-layout-flow wp-block-quote-is-layout-flow&#34;&gt;&#xA;&lt;p&gt;Vacuuming is like exercising. If it hurts, you’re not doing it enough!&lt;/p&gt;&#xA;&lt;cite&gt;Robert Haas, PGConf.EU 2023, Prague, 13 décembre 2023&lt;/cite&gt;&lt;/blockquote&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Un VACUUM cela peut être très rapide mais cela peut aussi être très lourd et c&amp;rsquo;est pour cela qu&amp;rsquo;il faut le lancer régulièrement. C&amp;rsquo;est justement le rôle de l&amp;rsquo;autovacuum.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Toutes les minutes (interval paramétrable via le paramètre &lt;code&gt;autovacuum_naptime&lt;/code&gt;), l&amp;rsquo;autovacuum se lance, analyse les données de la vue &lt;code&gt;pg_stat_all_tables&lt;/code&gt; afin de déterminer s&amp;rsquo;il doit lancer un &lt;code&gt;VACUUM&lt;/code&gt; et ou un &lt;code&gt;ANALYSE&lt;/code&gt; sur les différentes tables de la base.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Plusieurs tables peuvent être nettoyées en même temps : un processus de VACUUM sur une table utilise un worker et par défaut jusqu’à trois peuvent être lancés (variable &lt;code&gt;autovacuum_max_workers&lt;/code&gt;).&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Le déclenchement de l&amp;rsquo;autovacuum sur une table se fait si au moins l&amp;rsquo;une des conditions suivantes est remplie :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt; Le &lt;em&gt;txid&lt;/em&gt; courant est plus récent que :&lt;br&gt;&lt;code&gt;pg_catalog.pg_class.relfrozenxid&lt;/code&gt; + &lt;code&gt;autovacuum_freeze_max_age&lt;/code&gt;&lt;br&gt;Le tuple le plus vieux de la table est plus ancien que la valeur de la variable &lt;code&gt;autovacuum_freeze_max_age&lt;/code&gt; (par défaut 200 000 000).&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Le nombre de tuples morts est plus important que :&lt;br&gt;&lt;code&gt;autovacuum_vacuum_threshold&lt;/code&gt; + ( &lt;code&gt;autovacuum_vacuum_scale_factor&lt;/code&gt; × &lt;code&gt;nombre_tuples_relation&lt;/code&gt; )&lt;br&gt;Avec les valeurs par défaut cela correspond à 250 tuples morts pour 1000 tuples dans la table ou 2050 pour 10 000.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Le nombre de tuples insérés est plus important que :&lt;br&gt;&lt;code&gt;autovacuum_vacuum_insert_threshold&lt;/code&gt; + ( &lt;code&gt;autovacuum_vacuum_insert_scale_factor&lt;/code&gt; × &lt;code&gt;nombre_tuples_relation&lt;/code&gt; )&lt;br&gt;Avec les valeurs par défaut cela correspond à 3000 tuples insérés pour 10 000 tuples dans la table.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;La valeur par défaut de &lt;code&gt;autovacuum_vacuum_scale_factor&lt;/code&gt; est trop importante pour les grosses tables. Par exemple, une table qui contient 1 000 000 d&amp;rsquo;enregistrements ne se verra nettoyée qu&amp;rsquo;après 200 050 mouvements ce qui est très important. D&amp;rsquo;autant plus que le VACUUM qui sera déclenché risque d&amp;rsquo;être très lourds en raison de la taille importante de la table.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Les paramètres suivants sont intéressants :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;&lt;code&gt;maintenance_work_mem&lt;/code&gt; / &lt;code&gt;autovacuum_work_mem&lt;/code&gt; : quantité de mémoire allouée pour les processus de maintenance. N&amp;rsquo;hésitez pas à le pousser jusqu’à 1 Go (au delà, le VACUUM n&amp;rsquo;en a pas l&amp;rsquo;utilité).&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;autovacuum_vacuum_scale_factor&lt;/code&gt; : pourcentage de tuples modifiés au delà duquel l&amp;rsquo;autovacuum se lance. Il est intéressant de le définir spécifiquement pour les tables de grande taille.&lt;br&gt;Par exemple pour le passer à 5% : &lt;code&gt;ALTER TABLE table_name SET (autovacuum_vacuum_scale_factor = 0.05);&lt;/code&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;autovacuum_vacuum_insert_scale_factor&lt;/code&gt; : pourcentage de tuples insérés au delà duquel l&amp;rsquo;autovacuum se lance. Il est intéressant de le définir spécifiquement pour les tables de grande taille.&lt;br&gt;Par exemple pour le passer à 5% : &lt;code&gt;ALTER TABLE table_name SET (autovacuum_vacuum_insert_scale_factor = 0.05);&lt;/code&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;autovacuum_max_workers&lt;/code&gt; : nombre de workers pouvant être lancés simultanément durant le processus d&amp;rsquo;autovacuum.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voici les statistiques que nous avons actuellement pour la table de notre exemple :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;SELECT * FROM public.get_table_info(&#39;public.table_test&#39;);&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure class=&#34;wp-block-table&#34;&gt;&lt;table class=&#34;has-fixed-layout&#34;&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;Paramètre&lt;/th&gt;&lt;th&gt;Valeur&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;schema&lt;/td&gt;&lt;td&gt;public&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;table&lt;/td&gt;&lt;td&gt;table_test&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;nb_page&lt;/td&gt;&lt;td&gt;1&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;tuple_count&lt;/td&gt;&lt;td&gt;4&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;dead_tuple_count&lt;/td&gt;&lt;td&gt;0&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;max_frozen_txid&lt;/td&gt;&lt;td&gt;4644&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;n_tup_ins&lt;/td&gt;&lt;td&gt;7&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;n_tup_upd&lt;/td&gt;&lt;td&gt;2&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;n_tup_del&lt;/td&gt;&lt;td&gt;3&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;n_mod_since_analyze&lt;/td&gt;&lt;td&gt;0&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;n_ins_since_vacuum&lt;/td&gt;&lt;td&gt;0&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;last_vacuum&lt;/td&gt;&lt;td&gt;2024-01-01 01:01:01.000 +0100&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;last_autovacuum&lt;/td&gt;&lt;td&gt;0&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;last_analyze&lt;/td&gt;&lt;td&gt;2024-01-01 01:01:01.000 +0100&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;last_autoanalyze&lt;/td&gt;&lt;td&gt;0&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 class=&#34;wp-block-heading&#34;&gt;Pour en savoir plus&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voila un très gros résumé de comment PostgreSQL gère les données physiquement. Vous pouvez pousser le sujet en consultant les ressources suivantes.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Sur le stockage physique :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.postgresql.org/docs/current/storage.html&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;https://www.postgresql.org/docs/current/storage.html&lt;/a&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.postgresql.org/docs/current/storage-page-layout.htm&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;https://www.postgresql.org/docs/current/storage-page-layout.html&lt;/a&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.postgresql.org/docs/current/pageinspect.html&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;https://www.postgresql.org/docs/current/pageinspect.html&lt;/a&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.postgresql.org/docs/current/pgstattuple.html&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;https://www.postgresql.org/docs/current/pgstattuple.html&lt;/a&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.postgresql.org/docs/current/ddl-system-columns.html&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;https://www.postgresql.org/docs/current/ddl-system-columns.html&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Sur le système de contrôle concurrentiel :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.postgresql.org/docs/current/transaction-id.html&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;https://www.postgresql.org/docs/current/transaction-id.html&lt;/a&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.interdb.jp/pg/pgsql05.html&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;https://www.interdb.jp/pg/pgsql05.html&lt;/a&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.thenile.dev/blog/transaction-isolation-postgres&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;https://www.thenile.dev/blog/transaction-isolation-postgres&lt;/a&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;a href=&#34;https://medium.com/quadcode-life/structure-of-heap-table-in-postgresql-d44c94332052&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;https://medium.com/quadcode-life/structure-of-heap-table-in-postgresql-d44c94332052&lt;/a&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;a href=&#34;https://postgrespro.com/blog/pgsql/5967892&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;https://postgrespro.com/blog/pgsql/5967892&lt;/a&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;a href=&#34;https://idrawone.github.io/2020/10/09/Heap-Page-in-details/&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;https://idrawone.github.io/2020/10/09/Heap-Page-in-details/&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Sur les TOAST :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.postgresql.org/docs/current/storage-toast.html&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;https://www.postgresql.org/docs/current/storage-toast.html&lt;/a&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;a href=&#34;https://blog.anayrat.info/en/2022/02/14/postgresql-toast-compression-and-toast_tuple_target/&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;https://blog.anayrat.info/en/2022/02/14/postgresql-toast-compression-and-toast_tuple_target/&lt;/a&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.postgresql.fastware.com/blog/what-is-the-new-lz4-toast-compression-in-postgresql-14&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;https://www.postgresql.fastware.com/blog/what-is-the-new-lz4-toast-compression-in-postgresql-14&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Sur le VACUUM :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.postgresql.org/docs/current/maintenance.html&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;https://www.postgresql.org/docs/current/maintenance.html&lt;/a&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.interdb.jp/pg/pgsql05/10.html&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;https://www.interdb.jp/pg/pgsql05/10.html&lt;/a&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.interdb.jp/pg/pgsql06.html&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;https://www.interdb.jp/pg/pgsql06.html&lt;/a&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;a href=&#34;https://public.dalibo.com/exports/formation/manuels/modules/m5/m5.handout.html#param%C3%A9trage-de-vacuum-autovacuum&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;https://public.dalibo.com/exports/formation/manuels/modules/m5/m5.handout.html#param%C3%A9trage-de-vacuum-autovacuum&lt;/a&gt;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;a href=&#34;https://pankajconnect.medium.com/vacuum-and-vacuum-full-postgresql-4c9da30a1500&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;https://pankajconnect.medium.com/vacuum-and-vacuum-full-postgresql-4c9da30a1500&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;</content>
    <link href="https://blog.arthurbazin.com/bdd/postgresql/stockage-physique-gestion-des-donnees-et-vacuum" rel="alternate"></link>
    <summary type="html">Base de données ou fichiers plats ? Saviez-vous que PostgreSQL stockait les données dans des fichiers plats ? Démystifions un peu ce fonctionnement.</summary>
    <author>
      <name>Arthur Bazin</name>
    </author>
  </entry>
  <entry>
    <title>Ouvrez les fenêtres de PostgreSQL – Guide complet sur le fenêtrage</title>
    <updated>2024-01-04T16:39:54Z</updated>
    <id>tag:blog.arthurbazin.com,2024-01-04:/bdd/postgresql/ouvrez-les-fenetres-de-postgresql-guide-complet-sur-le-fenetrage</id>
    <content type="html">&#xA;&lt;p&gt;Sous PostgreSQL, il est possible d&amp;rsquo;effectuer des opérations de statistique (de type agrégat) sur un ensemble de lignes sans avoir à les agréger grâce aux fonctions de fenêtrage. Il devient ainsi possible de calculer des valeurs cumulées ou encore des sommes par unité de temps (dans le cas de données datées)&amp;#8230;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Le fenêtrage permet en outre de définir la porté de la fonction, c&amp;rsquo;est à dire de spécifier les limites des regroupements de lignes utilisés dans la fonction.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voici un exemple de ce qu&amp;rsquo;il est possible de calculer : les deux dernières colonnes se basent sur des fonctions de fenêtrage.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure class=&#34;wp-block-table&#34;&gt;&lt;table class=&#34;has-fixed-layout&#34;&gt;&lt;thead&gt;&lt;tr&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Identifiant&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Date&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Valeur&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Cumul&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Moyenne par mois&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;01/01/2024&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;10&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;10&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;9&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;10/01/2024&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;7&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;17&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;9&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;20/01/2024&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;10&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;27&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;9&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;D&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;01/02/2024&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;20&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;47&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;21&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;E&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;10/02/2024&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;23&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;70&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;21&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;F&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;20/02/2024&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;20&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;90&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;21&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;G&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;01/03/2024&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;10&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;100&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;11&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;H&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;10/03/2024&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;13&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;113&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;11&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;I&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;20/03/2024&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;10&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;123&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;11&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 class=&#34;wp-block-heading&#34;&gt;Syntaxe&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Clause WINDOW&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;La syntaxe est relativement simple : il suffit d&amp;rsquo;utiliser une fonction de fenêtrage dans la clause &lt;code&gt;SELECT&lt;/code&gt; puis définir la fenêtre à utiliser dans la clause &lt;code&gt;WINDOW&lt;/code&gt;.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;SELECT&#xA;&#x9;colonne_1,&#xA;&#x9;colonne_2,&#xA;&#x9;fonction_fenetre(colonne_3) OVER ma_fenetre&#xA;FROM&#xA;&#x9;mon_schema.ma_table&#xA;WINDOW&#xA;&#x9;ma_fenetre as (&#xA;&#x9;&#x9;--definition&#xA;&#x9;)&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Notez qu&amp;rsquo;il est possible de définir la fenêtre directement après la fonction de fenêtrage :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;SELECT&#xA;&#x9;colonne_1,&#xA;&#x9;colonne_2,&#xA;&#x9;fonction_fenetre(colonne_3) OVER (&#xA;&#x9;&#x9;--definition&#xA;&#x9;)&#xA;FROM&#xA;&#x9;mon_schema.ma_table&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Il est tout à fait possible de définir plusieurs fenêtres dans la clause &lt;code&gt;WINDOW&lt;/code&gt; afin d&amp;rsquo;utiliser des portées différentes dans chaque fonction.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Attention les lignes vues par la fenêtre dépendent des clauses présentes dans votre requête :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;La clause &lt;code&gt;WHERE&lt;/code&gt; restreint le nombre de lignes dans le résultat de la requête mais également dans la fenêtre.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Avec la clause &lt;code&gt;GROUP BY&lt;/code&gt;, les lignes vues par la fenêtre sont les lignes regroupées et non les lignes d&amp;rsquo;origines.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;La clause &lt;code&gt;HAVING&lt;/code&gt; restreint le nombre de lignes groupées visibles par la fenêtre.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Définition&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;La définition d&amp;rsquo;une fenêtre peut faire appel à différents éléments, tous optionnels :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;La clause &lt;code&gt;PARTITION BY&lt;/code&gt; : comment regrouper les lignes ?&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;La clause &lt;code&gt;ORDER BY&lt;/code&gt; : comment ordonnancer les lignes ?&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;La limite de la fenêtre : quelles lignes du groupe faut-il utiliser ?&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;WINDOW&#xA;&#x9;ma_fenetre as (&#xA;&#x9;&#x9;-- Regroupement&#xA;&#x9;&#x9;PARTITION BY &#xA;&#x9;&#x9;&#x9;ma_colonne_1&#xA;&#x9;&#x9;-- Ordonnancement&#xA;&#x9;&#x9;ORDER BY &#xA;&#x9;&#x9;&#x9;ma_colonne_2&#xA;&#x9;&#x9;-- Limites&#xA;&#x9;&#x9;ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING&#xA;&#x9;)&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;h4 class=&#34;wp-block-heading&#34;&gt;PARTITION BY : regroupement&lt;/h4&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;La clause de regroupement &lt;code&gt;PARTITION BY&lt;/code&gt; permet de grouper les lignes issues de la requêtes en partitions. Chacune de ces partitions est traitée individuellement par la fonction de fenêtrage. Ainsi, chaque ligne se voit attribuer une valeur calculée par la fonction de fenêtrage en fonction de la partition à laquelle elle appartient. Par exemple la somme ou encore la valeur moyenne de toutes les valeurs d&amp;rsquo;une partition.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Cette clause attend une expression pouvant contenir une ou plusieurs colonnes ainsi que des expressions SQL (fonction, calcul&amp;#8230;).&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Si cette clause n&amp;rsquo;est pas spécifiée alors toutes les lignes de la requête sont considérées comme faisant partie de la même partition.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voici deux exemples de regroupement.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure class=&#34;wp-block-table&#34;&gt;&lt;table class=&#34;has-fixed-layout&#34;&gt;&lt;thead&gt;&lt;tr&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Identifiant&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;pays&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Groupe calculé par &lt;code&gt;PARTITION BY&lt;/code&gt;&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;France&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Groupe 1&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;France&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Groupe 1&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Suisse&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Groupe 2&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Suisse&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Groupe 2&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;5&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;france&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Groupe 3&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Regroupement basé sur une colonne : &lt;code&gt;PARTITION BY pays&lt;/code&gt;&lt;/figcaption&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure class=&#34;wp-block-table&#34;&gt;&lt;table class=&#34;has-fixed-layout&#34;&gt;&lt;thead&gt;&lt;tr&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Identifiant&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;ma_colonne_date&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Groupe calculé par &lt;code&gt;PARTITION BY&lt;/code&gt;&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;01/01/2024&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Groupe 1&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;22/03/2024&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Groupe 2&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;08/04/2024&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Groupe 3&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;14/03/2024&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Groupe 2&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;5&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;15/01/2024&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Groupe 1&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Regroupement basé sur une expression : &lt;code&gt;PARTITION BY extract(MONTH FROM ma_colonne_date)&lt;/code&gt;&lt;/figcaption&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Notez que le regroupement des valeurs entraine un ordonnancement de celles-ci qui influe sur l&amp;rsquo;ordre des lignes dans les résultats de la requête. Il pourra être nécessaire d&amp;rsquo;utiliser la clause &lt;code&gt;ORDER BY&lt;/code&gt; (dans la requête, pas le &lt;code&gt;ORDER BY&lt;/code&gt; de la fenêtre) pour spécifier un ordre particulier des résultats.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h4 class=&#34;wp-block-heading&#34;&gt;ORDER BY : l&amp;rsquo;ordonnancement&lt;/h4&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Selon le calcul réalisé, il peut être intéressant d&amp;rsquo;ordonnancer les valeurs de la fenêtre. Par exemple dans le cas d&amp;rsquo;une somme cumulée (croissante ou décroissante), il est important que les valeurs au sein d&amp;rsquo;une partition soient triées.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Cette clause attend une expression permettant d&amp;rsquo;ordonnancer les lignes, cela peut être une ou plusieurs colonnes ainsi que des expressions SQL (fonction, calcul…).&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure class=&#34;wp-block-table&#34;&gt;&lt;table class=&#34;has-fixed-layout&#34;&gt;&lt;thead&gt;&lt;tr&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Identifiant&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;ma_colonne_date&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;Rang calculé par &lt;code&gt;ORDER BY&lt;/code&gt;&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;01/01/2024&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;22/03/2024&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;01/01/2024&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;14/03/2024&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;5&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;15/01/2024&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;figcaption class=&#34;wp-element-caption&#34;&gt;Ordonnancement basé sur une colonne, &lt;code&gt;ma_colonne_date&lt;/code&gt;&lt;/figcaption&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Les options suivantes peuvent être utilisées :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;&lt;code&gt;ASC&lt;/code&gt; ou &lt;code&gt;DESC&lt;/code&gt; : pour spécifier un tri ascendant ou descendant.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;NULLS { FIRST | LAST }&lt;/code&gt;  pour gérer l&amp;rsquo;ordre des valeurs nulles (en premier ou en dernier).&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Lorsque plusieurs fonctions de fenêtrage sont utilisées, les valeurs peuvent être triées plusieurs fois de suites.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;Les fenêtre ayant des clauses &lt;code&gt;PARTITION BY&lt;/code&gt; et &lt;code&gt;ORDER BY&lt;/code&gt; équivalente seront évaluées en même temps et auront donc exactement le même ordre de tri (même si &lt;code&gt;ORDER BY&lt;/code&gt; ne définit pas une façon unique de trier les lignes).&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Les fenêtres ayant des clauses &lt;code&gt;PARTITION BY&lt;/code&gt; et &lt;code&gt;ORDER BY&lt;/code&gt; différentes seront évaluées séparément. Il en résulte un tri potentiellement différent entre deux fenêtres ayant des partions différentes mais un ordre de tri identique (lorsque &lt;code&gt;ORDER BY&lt;/code&gt; ne définit pas une façon unique de trier les lignes).&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Notez que l&amp;rsquo;ordonnancement des valeurs influe sur l&amp;rsquo;ordre des lignes dans les résultats de la requête. Il pourra être nécessaire d&amp;rsquo;utiliser la clause &lt;code&gt;ORDER BY&lt;/code&gt; (dans la requête, pas le &lt;code&gt;ORDER BY&lt;/code&gt; de la fenêtre) pour spécifier un ordre particulier des résultats.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h4 class=&#34;wp-block-heading&#34;&gt;Clause de portée : les limites de la fenêtre&lt;/h4&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Les fonctions ne portent pas directement sur toutes les ligne de la partition qu&amp;rsquo;elles sont en train de traiter. En fait, leur calcul est dépendant de la ligne en cour de traitement. En effet, chaque fenêtre possède un portée limitée au sein de la partition définie (par &lt;code&gt;PARTITION BY&lt;/code&gt;).&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Par défaut, cette limite s&amp;rsquo;étend à toute la partition sauf dans le cas où une clause &lt;code&gt;ORDER BY&lt;/code&gt; est définie pour la fenêtre. Dans ce dernier cas, la limite est comprise entre « toutes les lignes précédentes » et « la ligne actuelle ». Donc la fonction ne « voient » pas les lignes qui « suivent » au sein de la même partition.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Les limites se définissent de la façon suivante : &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;Le mode de définition&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;La limite de début&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;La limite de fin&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Les exclusions&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;{ROWS | RANGE | GROUPS}&#xA;BETWEEN&#xA;&#x9;{UNBOUNDED PRECEDING | n PRECEDING | CURRENT ROW | n FOLLOWING}&#xA;AND&#xA;&#x9;{n PRECEDING | CURRENT ROW | n FOLLOWING | UNBOUNDED FOLLOWING}&#xA;EXCLUDE &#xA;&#x9;{CURRENT ROW | EXCLUDE GROUP | EXCLUDE TIES | EXCLUDE NO OTHERS}&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Il existe trois modes de définition des limites :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;&lt;code&gt;ROWS&lt;/code&gt; : que je traduis par ligne.&lt;br&gt;On définit un nombre spécifique de lignes avant ou après la ligne courante.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;GROUPS&lt;/code&gt; : que je traduis par rang.&lt;br&gt;On définit un nombre de rangs séparant la limite de la ligne courante.&lt;br&gt;Le rang de chaque ligne est définit avec la clause &lt;code&gt;ORDER BY&lt;/code&gt;.&lt;br&gt;Plusieurs lignes peuvent avoir le même rang, on parle alors de « groupe de lignes équivalentes » dans le tri ce qui équivaut à « groupe de ligne ayant le même rang » dans le tri.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;RANGE&lt;/code&gt; : (mode par défaut) que je traduis par intervalle.&lt;br&gt;On définit un intervalle d&amp;rsquo;écart entre la ligne courante et la limite&lt;br&gt;L&amp;rsquo;intervalle est calculé sur une colonne unique définie dans la clause &lt;code&gt;ORDER BY&lt;/code&gt;.&lt;br&gt;Le type de l&amp;rsquo;intervalle dépend de la colonne spécifiée (numérique, date&amp;#8230;).&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;La définition des limites peut utiliser les éléments suivants :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;&lt;code&gt;UNBOUNDED PRECEDING&lt;/code&gt; : toutes les lignes précédentes (limite inférieur par défaut)&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;n PRECEDING&lt;/code&gt; : &#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;&lt;code&gt;ROWS&lt;/code&gt; : n = nombre de ligne.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;GROUPS&lt;/code&gt; : n = nombre de rang/groupe.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;RANGE&lt;/code&gt; : n = intervalle avec la ligne actuelle.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;CURRENT ROW&lt;/code&gt; : (limite supérieur par défaut)&lt;br&gt;Équivalent à &lt;code&gt;0 PRECEDING&lt;/code&gt; ou &lt;code&gt;0 FOLLOWING&lt;/code&gt;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;&lt;code&gt;ROWS&lt;/code&gt; : la ligne courante.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;GROUPS&lt;/code&gt; : la ligne courante ainsi que toutes les lignes ayant le même rang selon la clause &lt;code&gt;ORDER BY&lt;/code&gt;.&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;En début de portée, la ligne utilisée sera la première ligne retournée ayant un rang équivalent à la ligne courante.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;En fin de portée, la ligne utilisée sera la dernière ligne retournée ayant un rang équivalent à la ligne courante.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;RANGE&lt;/code&gt; : la ligne courante ainsi que toutes les lignes ayant le même rang selon la clause &lt;code&gt;ORDER BY&lt;/code&gt;.&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;En début de portée, la ligne utilisée sera la première ligne retournée ayant un rang équivalent à la ligne courante.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;En fin de portée, la ligne utilisée sera la dernière ligne retournée ayant un rang équivalent à la ligne courante.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;n FOLLOWING&lt;/code&gt; :&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;&lt;code&gt;ROWS&lt;/code&gt; : n = nombre de ligne.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;GROUPS&lt;/code&gt; : n = nombre de rang/groupe.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;RANGE&lt;/code&gt; : n = intervalle avec la ligne courante.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;UNDOUNDED FOLLOWING&lt;/code&gt; : toutes les lignes suivantes.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Attention aux restrictions suivantes :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;le début de la portée ne peut valoir &lt;code&gt;UNBOUNDED FOLLOWING&lt;/code&gt;.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;La fin de la portée ne peut valoir &lt;code&gt;UNBOUNDED PRECEDING&lt;/code&gt;.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Le début de la portée doit toujours être inférieur à la fin de la portée (&lt;code&gt;ROWS BETWEEN 7 PRECEDING AND 8 PRECEDING&lt;/code&gt; ne donne aucune ligne et &lt;code&gt;RANGE BETWEEN CURRENT ROW AND &lt;em&gt;n&lt;/em&gt; PRECEDING&lt;/code&gt; renvoie une erreur).&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Notez que lorsque la clause &lt;code&gt;ORDER BY&lt;/code&gt; n&amp;rsquo;est pas spécifiée, toutes les lignes sont considérées comme ayant le même rang. Ainsi, il est important de tenir compte de cet élément dans les modes &lt;code&gt;GROUPS&lt;/code&gt; et &lt;code&gt;RANGE&lt;/code&gt; et par conséquent avec la limite par défaut qui est la suivante :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;RANGE BETWEEN&#xA;&#x9;UNBOUNDED PRECEDING&#xA;AND&#xA;&#x9;CURRENT ROW&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;En effet, avec la limite par défaut, toutes les lignes entre la première de la partition et la ligne courante incluant les lignes de même rang sont utilisées. Ainsi, deux cas de figure se présentes :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;Une clause &lt;code&gt;ORDER BY&lt;/code&gt; est spécifiée : une partie seulement des lignes de la partition est utilisée.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Aucune clause &lt;code&gt;ORDER BY&lt;/code&gt; n&amp;rsquo;est spécifiée : toutes les lignes possèdent le même rang, ainsi elles sont toutes incluses dans la fenêtre.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Dans tous les cas, la distance jusqu&amp;rsquo;à la fin de la portée est limitée par la distance jusqu&amp;rsquo;à la fin de la partition. Si la limite dépasse la fin de la partition, alors la dernière ligne est la dernière de la partition.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Il est enfin possible de définir un ensemble de lignes à exclure de la fenêtre avec la clause &lt;code&gt;EXCLUDE&lt;/code&gt; qui peut prendre les valeurs suivantes :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;&lt;code&gt;EXCLUDE NO OTHERS&lt;/code&gt; : ne rien exclure (comportement par défaut).&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;CURRENT ROW&lt;/code&gt; : exclure la ligne courante.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;EXCLUDE GROUP&lt;/code&gt; : exclure la ligne courante ainsi que toutes les lignes de même rang selon la clause &lt;code&gt;ORDER BY&lt;/code&gt;.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;EXCLUDE TIES&lt;/code&gt; : conserver la ligne courante mais exclure toutes les lignes de même rang selon la clause &lt;code&gt;ORDER BY&lt;/code&gt;.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Fenêtres de fenêtre&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Lorsqu&amp;rsquo;une fenêtre est définie sans clause de portée, il est possible d&amp;rsquo;en définir une seconde à partir de celle-ci.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Dans ce cas :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;La seconde reprend le partitionnement de la fenêtre source.&lt;br&gt;Il est impossible de spécifier une clause &lt;code&gt;PARTITION BY&lt;/code&gt;.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;La seconde reprend l&amp;rsquo;ordonnancement de la fenêtre source si la clause &lt;code&gt;ORDER BY&lt;/code&gt; existe.&lt;br&gt;Dans ce cas, il est impossible de spécifier une clause &lt;code&gt;ORDER BY&lt;/code&gt;.&lt;br&gt;Sinon, la seconde peut se voir définir un clause &lt;code&gt;ORDER BY&lt;/code&gt; qui lui sera spécifique.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;La seconde peut avoir ses propres limites de fenêtre via sa propre clause de portée.&lt;br&gt;Si les limites ne sont pas définies, les limites par défaut s&amp;rsquo;appliquent (&lt;code&gt;RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW&lt;/code&gt;).&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voici un exemple :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;WINDOW&#xA;&#x9;ma_fenetre as (&#xA;&#x9;&#x9;-- Regroupement&#xA;&#x9;&#x9;PARTITION BY &#xA;&#x9;&#x9;&#x9;ma_colonne_1&#xA;&#x9;),&#xA;&#xA;&#x9;ma_seconde_fenetre as (&#xA;&#x9;&#x9;-- Fenêtre source&#xA;&#x9;&#x9;ma_fenetre&#xA;&#x9;&#x9;-- Ordonnancement (car la fenêtre source ne spécifie pas de clause ORDER BY)&#xA;&#x9;&#x9;ORDER BY &#xA;&#x9;&#x9;&#x9;ma_colonne_2&#xA;&#x9;&#x9;-- Limites spécifiques&#xA;&#x9;&#x9;ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING&#xA;&#x9;)&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 class=&#34;wp-block-heading&#34;&gt;Les fonctions&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Les fonctions de fenêtrage peuvent être utilisées dans les clauses &lt;code&gt;SELECT&lt;/code&gt; et &lt;code&gt;ORDER BY&lt;/code&gt; uniquement.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Ces fonctions regroupent à la fois les fonctions spécifiques au fenêtrage (&lt;a href=&#34;https://www.postgresql.org/docs/current/functions-window.html&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;documentées ici&lt;/a&gt;) ainsi que certaines fonctions d&amp;rsquo;agrégation : celles à but général (&lt;a href=&#34;https://www.postgresql.org/docs/current/functions-aggregate.html#FUNCTIONS-AGGREGATE-TABLE&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;documentées ici&lt;/a&gt;) et celles à but statistique (&lt;a href=&#34;https://www.postgresql.org/docs/current/functions-aggregate.html#FUNCTIONS-AGGREGATE-STATISTICS-TABLE&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;documentées ici&lt;/a&gt;) mais pas les autres.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;La syntaxe est la suivante :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;SELECT&#xA;&#x9;fonction_fenetre(colonne) OVER ma_fenetre&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Lors de l&amp;rsquo;utilisation de fonctions d&amp;rsquo;agrégation avec une fenêtre, il n&amp;rsquo;est pas possible d&amp;rsquo;utiliser les clauses &lt;code&gt;DISTINCT&lt;/code&gt; et &lt;code&gt;ORDER BY&lt;/code&gt; dans les arguments de la fonction comme habituellement avec les fonctions d&amp;rsquo;agrégation.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;En revanche, ces fonctions d&amp;rsquo;agrégation autorisent le filtrage des lignes utilisées par celles-ci grâce à la clause &lt;code&gt;FILTER&lt;/code&gt; de la façon suivante :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;SELECT&#xA;&#x9;fonction_fenetre(colonne) FILTER ( WHERE ma_clause_where ) OVER ma_fenetre&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Il est ainsi possible d&amp;rsquo;utiliser n&amp;rsquo;importe quelle condition qui sera testée sur chaque ligne de la fenêtre avant de fournir celles-ci à la fonction. Les lignes ne satisfaisant pas la conditions seront ignorées.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voici les principales fonctions de fenêtrage :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure class=&#34;wp-block-table alignwide has-fixed-layout is-style-stripes&#34;&gt;&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;Fonction&lt;/th&gt;&lt;th&gt;Description&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;code&gt;row_number()&lt;/code&gt;&lt;/td&gt;&lt;td&gt;Numéro de ligne&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;code&gt;rank()&lt;/code&gt;&lt;/td&gt;&lt;td&gt;Rang de l&amp;rsquo;objet avec trou. &lt;br&gt;Comme row_number() mais deux objets peuvent avoir le même rang.&lt;br&gt;Par exemple : &lt;code&gt;1&lt;/code&gt;, &lt;code&gt;2&lt;/code&gt;, &lt;code&gt;2&lt;/code&gt;, &lt;code&gt;2&lt;/code&gt;, &lt;code&gt;5&lt;/code&gt;, &lt;code&gt;6&lt;/code&gt;, &lt;code&gt;7&lt;/code&gt;, &lt;code&gt;7&lt;/code&gt;, &lt;code&gt;9&lt;/code&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;code&gt;dense_rank()&lt;/code&gt;&lt;/td&gt;&lt;td&gt;Rang de l&amp;rsquo;objet sans trou. &lt;br&gt;Comme rank() mais si plusieurs objets ont le même rang, l&amp;rsquo;objet d&amp;rsquo;après possède le rang suivant.&lt;br&gt;Par exemple : &lt;code&gt;1&lt;/code&gt;, &lt;code&gt;2&lt;/code&gt;, &lt;code&gt;2&lt;/code&gt;, &lt;code&gt;2&lt;/code&gt;, &lt;code&gt;3&lt;/code&gt;, &lt;code&gt;4&lt;/code&gt;, &lt;code&gt;5&lt;/code&gt;, &lt;code&gt;5&lt;/code&gt;, &lt;code&gt;6&lt;/code&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;code&gt;percent_rank()&lt;/code&gt;&lt;/td&gt;&lt;td&gt;Rang en pourcentage (de 0% à 100%) : (rang -1) / (nb_ligne_total &amp;#8211; 1).&lt;br&gt;Par exemple (pour 4 valeurs) : &lt;code&gt;0%&lt;/code&gt;, &lt;code&gt;33%&lt;/code&gt;, &lt;code&gt;66%&lt;/code&gt;, &lt;code&gt;100%&lt;/code&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;code&gt;cume_dist()&lt;/code&gt;&lt;/td&gt;&lt;td&gt;Rang en pourcentage (de n% à 100%) : (nb_lignes_précédentes + nb_ligne_même_rang + 1) / (nb_ligne_total).&lt;br&gt;Par exemple (pour 4 valeurs) : &lt;code&gt;25%&lt;/code&gt;, &lt;code&gt;50%&lt;/code&gt;, &lt;code&gt;75%&lt;/code&gt;, &lt;code&gt;100%&lt;/code&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;code&gt;first_value(colonne_1)&lt;/code&gt;&lt;/td&gt;&lt;td&gt;Première valeur issue de la fenêtre pour la colonne indiquée.&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;code&gt;last_value(colonne_1)&lt;/code&gt;&lt;/td&gt;&lt;td&gt;Dernière valeur issue de la fenêtre pour la colonne indiquée.&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;code&gt;nth_value(colonne_1,n)&lt;/code&gt;&lt;/td&gt;&lt;td&gt;Valeur &amp;lsquo;n&amp;rsquo; issue de la fenêtre pour la colonne indiquée.&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;code&gt;lag(colonne_1,n,&#39;text&#39;)&lt;/code&gt;&lt;/td&gt;&lt;td&gt;Valeur issue de la fenêtre pour la colonne indiquée située n lignes (defaut = &lt;code&gt;1&lt;/code&gt;) avant la ligne évaluée. &lt;br&gt;Si aucune valeur n&amp;rsquo;existe, &amp;lsquo;text&amp;rsquo; (défaut = &lt;code&gt;NULL&lt;/code&gt;) est renvoyée.&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;code&gt;lead(colonne_1,n,&#39;text&#39;)&lt;/code&gt;&lt;/td&gt;&lt;td&gt;Valeur issue de la fenêtre pour la colonne indiquée située n lignes (defaut = &lt;code&gt;1&lt;/code&gt;) après la ligne évaluée. &lt;br&gt;Si aucune valeur n&amp;rsquo;existe, &amp;lsquo;text&amp;rsquo; (défaut = &lt;code&gt;NULL&lt;/code&gt;) est renvoyée.&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 class=&#34;wp-block-heading&#34;&gt;Exemples&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Exemple basique&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;h4 class=&#34;wp-block-heading&#34;&gt;Données d&amp;rsquo;exemple&lt;/h4&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Pour réaliser nos exemples, nous allons utiliser les données suivantes :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure class=&#34;wp-block-table&#34;&gt;&lt;table class=&#34;has-fixed-layout&#34;&gt;&lt;thead&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;identifiant&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;groupe&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;ordre&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;valeur&lt;/td&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;10&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;11&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;12&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;13&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;20&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;21&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;22&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;23&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;30&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;31&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;32&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;33&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voici la requête qui permet de créer une table contenant ces données, notez que les lignes sont dans le désordre (pour mieux apprécier le fonctionnement des fenêtres) :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;-- DROP TABLE public.test_fenetrage;&#xA;&#xA;CREATE TABLE public.test_fenetrage AS &#xA;SELECT&#xA;&#x9;*&#xA;FROM (&#xA;&#x9;VALUES&#xA;&#x9;&#x9;(&#39;C-3&#39;, &#39;C&#39;, 2, 32),&#xA;&#x9;&#x9;(&#39;A-1&#39;, &#39;A&#39;, 1, 10),&#xA;&#x9;&#x9;(&#39;C-1&#39;, &#39;C&#39;, 4, 30),&#xA;&#x9;&#x9;(&#39;B-4&#39;, &#39;B&#39;, 3, 23),&#xA;&#x9;&#x9;(&#39;B-3&#39;, &#39;B&#39;, 2, 22),&#xA;&#x9;&#x9;(&#39;A-2&#39;, &#39;A&#39;, 2, 11),&#xA;&#x9;&#x9;(&#39;C-4&#39;, &#39;C&#39;, 1, 33),&#xA;&#x9;&#x9;(&#39;B-1&#39;, &#39;B&#39;, 1, 20),&#xA;&#x9;&#x9;(&#39;C-2&#39;, &#39;C&#39;, 3, 31),&#xA;&#x9;&#x9;(&#39;A-3&#39;, &#39;A&#39;, 3, 12),&#xA;&#x9;&#x9;(&#39;A-4&#39;, &#39;A&#39;, 4, 13),&#xA;&#x9;&#x9;(&#39;B-2&#39;, &#39;B&#39;, 2, 21)&#xA;) as t1 (identifiant, groupe, ordre, valeur)&#xA;;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;h4 class=&#34;wp-block-heading&#34;&gt;Fenêtre par défaut&lt;/h4&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voici un premier test avec la fenêtre par défaut :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;SELECT&#xA;&#x9;identifiant,&#xA;&#x9;row_number() OVER ma_fenetre,&#xA;&#x9;rank() OVER ma_fenetre,&#xA;&#x9;lag(identifiant, 1) OVER ma_fenetre,&#xA;&#x9;first_value(identifiant) OVER ma_fenetre,&#xA;&#x9;lead(identifiant, 1) OVER ma_fenetre,&#xA;&#x9;last_value(identifiant) OVER ma_fenetre&#xA;FROM &#xA;&#x9;public.test_fenetrage&#xA;WINDOW&#xA;&#x9;ma_fenetre AS (&#xA;&#x9;&#x9;RANGE&#xA;&#x9;&#x9;&#x9;BETWEEN&#xA;&#x9;&#x9;&#x9;&#x9;UNBOUNDED PRECEDING&#xA;&#x9;&#x9;&#x9;AND&#xA;&#x9;&#x9;&#x9;&#x9;CURRENT ROW&#xA;&#x9;)&#xA;;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voici le résultat :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure class=&#34;wp-block-table&#34;&gt;&lt;table class=&#34;has-fixed-layout&#34;&gt;&lt;thead&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;identifiant&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;row_number&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;rank&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;lag&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;first_value&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;lead&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;last_value&lt;/td&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;5&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;6&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;7&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;8&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;9&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;10&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;11&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;12&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Nous avons le numéro de ligne (&lt;code&gt;row_number&lt;/code&gt;) qui correspond au numéro d&amp;rsquo;ordre des lignes dans la fenêtre. Cette dernière n&amp;rsquo;ayant pas de clause &lt;code&gt;ORDER BY&lt;/code&gt;, il s&amp;rsquo;agit du numéro d&amp;rsquo;ordre dans la table (dans le stockage physique).&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Nous pouvons voir que toutes les lignes possèdent le même rang (&lt;code&gt;rank&lt;/code&gt;) car nous n&amp;rsquo;avons pas utilisé la clause &lt;code&gt;ORDER BY&lt;/code&gt; dans la fenêtre. &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Nous avons également une information sur les valeurs immédiatement précédentes (&lt;code&gt;lag&lt;/code&gt;) et suivantes (&lt;code&gt;lead&lt;/code&gt;) de chaque ligne ainsi que la première (&lt;code&gt;first_value&lt;/code&gt;) et la dernière (&lt;code&gt;last_value&lt;/code&gt;) valeur de la partition (et donc de la table).&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Nous allons utiliser la même fenêtre mais avec une clause &lt;code&gt;ORDER BY&lt;/code&gt; au niveau de la requête :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;SELECT&#xA;&#x9;identifiant,&#xA;&#x9;row_number() OVER ma_fenetre,&#xA;&#x9;rank() OVER ma_fenetre,&#xA;&#x9;lag(identifiant, 1) OVER ma_fenetre,&#xA;&#x9;first_value(identifiant) OVER ma_fenetre,&#xA;&#x9;lead(identifiant, 1) OVER ma_fenetre,&#xA;&#x9;last_value(identifiant) OVER ma_fenetre&#xA;FROM &#xA;&#x9;public.test_fenetrage&#xA;WINDOW&#xA;&#x9;ma_fenetre AS (&#xA;&#x9;&#x9;RANGE&#xA;&#x9;&#x9;&#x9;BETWEEN&#xA;&#x9;&#x9;&#x9;&#x9;UNBOUNDED PRECEDING&#xA;&#x9;&#x9;&#x9;AND&#xA;&#x9;&#x9;&#x9;&#x9;CURRENT ROW&#xA;&#x9;)&#xA;ORDER BY&#xA;&#x9;identifiant&#xA;;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Vous devriez avoir les résultats suivants :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure class=&#34;wp-block-table&#34;&gt;&lt;table class=&#34;has-fixed-layout&#34;&gt;&lt;thead&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;identifiant&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;row_number&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;rank&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;lag&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;first_value&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;lead&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;last_value&lt;/td&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;6&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;10&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;11&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;8&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;12&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;5&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;9&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;7&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Nous avons exactement les mêmes données que précédemment mais l&amp;rsquo;ordre des lignes n&amp;rsquo;est pas le même. Ceci démontre que le fenêtrage permet de calculer des données sur des ensembles bien spécifiques avec un ordre bien spécifique.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h4 class=&#34;wp-block-heading&#34;&gt;Fonctionnement du CURRENT ROW&lt;/h4&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Testez la requête suivante :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;SELECT&#xA;&#x9;identifiant,&#xA;&#x9;row_number() OVER fenetre_range,&#xA;&#x9;rank() OVER fenetre_range,&#xA;&#x9;first_value(identifiant) OVER fenetre_range as first_value_range,&#xA;&#x9;last_value(identifiant) OVER fenetre_range as last_value_range,&#xA;&#x9;first_value(identifiant) OVER fenetre_row as first_value_row,&#xA;&#x9;last_value(identifiant) OVER fenetre_row as last_value_row&#xA;FROM &#xA;&#x9;public.test_fenetrage&#xA;WINDOW&#xA;&#x9;fenetre_range AS (&#xA;&#x9;&#x9;RANGE&#xA;&#x9;&#x9;&#x9;BETWEEN&#xA;&#x9;&#x9;&#x9;&#x9;CURRENT ROW&#xA;&#x9;&#x9;&#x9;AND&#xA;&#x9;&#x9;&#x9;&#x9;CURRENT ROW&#xA;&#x9;),&#xA;&#x9;fenetre_row AS (&#xA;&#x9;&#x9;ROWS&#xA;&#x9;&#x9;&#x9;BETWEEN&#xA;&#x9;&#x9;&#x9;&#x9;CURRENT ROW&#xA;&#x9;&#x9;&#x9;AND&#xA;&#x9;&#x9;&#x9;&#x9;CURRENT ROW&#xA;&#x9;)&#xA;;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Elle renvoie ces résultats :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure class=&#34;wp-block-table&#34;&gt;&lt;table class=&#34;has-fixed-layout&#34;&gt;&lt;thead&gt;&lt;tr&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;identifiant&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;row_number&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;rank&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;first_value_range&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;last_value_range&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;first_value_row&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;last_value_row&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-1&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-1&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-4&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;5&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-3&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;6&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-2&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;7&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-4&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;8&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-1&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;9&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-2&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;10&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-3&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;11&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-4&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;12&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voyez la différence entre les modes &lt;code&gt;RANGE&lt;/code&gt; (ou &lt;code&gt;GROUPS&lt;/code&gt;) et &lt;code&gt;ROWS&lt;/code&gt;. Avec les deux premiers modes, &lt;code&gt;CURRENT ROW&lt;/code&gt; inclut toutes les lignes de même rang que la ligne courante. La première ligne correspond alors à la première ligne de même rang que la ligne courante remontée par la requête. C&amp;rsquo;est la même chose pour la dernière ligne.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Comme il n&amp;rsquo;y a pas de sous ordre définit au sein d&amp;rsquo;un même rang, c&amp;rsquo;est l&amp;rsquo;ordre de stockage des lignes qui est utilisé. Ainsi, la première ligne d&amp;rsquo;un rang donné correspond à la première ligne de ce rang rencontré lors du parcours de la table.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h4 class=&#34;wp-block-heading&#34;&gt;Fenêtre partitionnée&lt;/h4&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Utilisons maintenant les partitions avec &lt;code&gt;PARTITION BY&lt;/code&gt; :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;SELECT&#xA;&#x9;identifiant,&#xA;&#x9;groupe,&#xA;&#x9;row_number() OVER ma_fenetre,&#xA;&#x9;rank() OVER ma_fenetre,&#xA;&#x9;lag(identifiant, 1) OVER ma_fenetre,&#xA;&#x9;first_value(identifiant) OVER ma_fenetre,&#xA;&#x9;lead(identifiant, 1) OVER ma_fenetre,&#xA;&#x9;last_value(identifiant) OVER ma_fenetre&#xA;FROM &#xA;&#x9;public.test_fenetrage&#xA;WINDOW&#xA;&#x9;ma_fenetre AS (&#xA;&#x9;&#x9;PARTITION BY&#xA;&#x9;&#x9;&#x9;groupe&#xA;&#x9;&#x9;RANGE&#xA;&#x9;&#x9;&#x9;BETWEEN&#xA;&#x9;&#x9;&#x9;&#x9;UNBOUNDED PRECEDING&#xA;&#x9;&#x9;&#x9;AND&#xA;&#x9;&#x9;&#x9;&#x9;CURRENT ROW&#xA;&#x9;)&#xA;;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voici le résultat :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure class=&#34;wp-block-table&#34;&gt;&lt;table class=&#34;has-fixed-layout&#34;&gt;&lt;thead&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;identifiant&lt;/td&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;groupe&lt;/th&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;row_number&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;rank&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;lag&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;first_value&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;lead&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;last_value&lt;/td&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-3&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-3&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-3&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-3&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-4&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-4&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-4&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-4&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-2&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-2&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-2&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-2&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Les calculs sont maintenant effectués « par partition ».&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Il est intéressant de constater que les lignes ont été réordonnées, c&amp;rsquo;est à cause du &lt;code&gt;PARTITION BY&lt;/code&gt; qui implique une réorganisation des lignes lors du calcul. Notez cependant que les lignes conservent leur positionnement d&amp;rsquo;origine au sein de chaque partition (A-4 est avant A-2 qui est avant A-1 qui est avant A-3 comme dans la table d&amp;rsquo;origine).&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h4 class=&#34;wp-block-heading&#34;&gt;Fenêtre ordonnancée&lt;/h4&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Remplaçons les partitions par &lt;code&gt;ORDER BY&lt;/code&gt; afin d’ordonnancer nos valeurs :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;SELECT&#xA;&#x9;identifiant,&#xA;&#x9;ordre,&#xA;&#x9;row_number() OVER ma_fenetre,&#xA;&#x9;rank() OVER ma_fenetre,&#xA;&#x9;dense_rank() OVER ma_fenetre,&#xA;&#x9;lag(identifiant, 1) OVER ma_fenetre,&#xA;&#x9;first_value(identifiant) OVER ma_fenetre,&#xA;&#x9;lead(identifiant, 1) OVER ma_fenetre,&#xA;&#x9;last_value(identifiant) OVER ma_fenetre&#xA;FROM &#xA;&#x9;public.test_fenetrage&#xA;WINDOW&#xA;&#x9;ma_fenetre AS (&#xA;&#x9;&#x9;ORDER BY&#xA;&#x9;&#x9;&#x9;ordre ASC&#xA;&#x9;&#x9;RANGE&#xA;&#x9;&#x9;&#x9;BETWEEN&#xA;&#x9;&#x9;&#x9;&#x9;UNBOUNDED PRECEDING&#xA;&#x9;&#x9;&#x9;AND&#xA;&#x9;&#x9;&#x9;&#x9;CURRENT ROW&#xA;&#x9;)&#xA;;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Les données suivantes sont renvoyées :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure class=&#34;wp-block-table&#34;&gt;&lt;table class=&#34;has-fixed-layout&#34;&gt;&lt;thead&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;identifiant&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;ordre&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;row_number&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;rank&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;dense_rank&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;lag&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;first_value&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;lead&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;last_value&lt;/td&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-1&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-1&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-1&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;5&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;6&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;7&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;8&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;8&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-4&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;9&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;8&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-4&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;10&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;8&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-4&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;11&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;11&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-4&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;12&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;11&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-4&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;La partition s&amp;rsquo;étend maintenant à toute la table.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Il est intéressant de constater que les lignes ont ici aussi été réordonnées, c&amp;rsquo;est à cause du &lt;code&gt;ORDER BY&lt;/code&gt; qui implique une réorganisation des lignes lors du calcul.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Intéressons nous aux colonnes &lt;code&gt;row_number&lt;/code&gt;, &lt;code&gt;rank&lt;/code&gt; et &lt;code&gt;dense_rank&lt;/code&gt;. Nous pouvons maintenant voir la différence entre ces fonctions :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;&lt;code&gt;row_number&lt;/code&gt; indique le numéro de ligne après le réordonnancement effectué par la fenêtre. &lt;br&gt;A-1, B-1 et C-4 possède le numéro d&amp;rsquo;ordre 1, il est donc logique de les retrouver en 1&lt;sup&gt;ère&lt;/sup&gt;, 2&lt;sup&gt;ème&lt;/sup&gt; et 3&lt;sup&gt;ème&lt;/sup&gt; place.&lt;br&gt;Notez que C-4 est avant A-1 qui est avant B-1 ce qui correspond à leurs positionnements dans la table d&amp;rsquo;origine.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;rank&lt;/code&gt; permet de définir le rang de chaque ligne. &lt;br&gt;A-1, B-1 et C-4 possède le numéro d&amp;rsquo;ordre 1, il possèdent donc tous les trois le rang 1. A-2, B-2, B-3 et C-3 possède la valeur d&amp;rsquo;ordre 2, il sont donc au rang suivant : 4. &lt;br&gt;Le numéro de rang correspond au premier numéro de ligne (&lt;code&gt;row_number&lt;/code&gt;) du groupe de lignes équivalentes.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;&lt;code&gt;dense_rank&lt;/code&gt; permet de définir le rang de chaque ligne mais sans trous.&lt;br&gt;A-1, B-1 et C-4 sont au rang 1 puis A-2, B-2, B-3 et C-3 sont au rang 2.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;h4 class=&#34;wp-block-heading&#34;&gt;Fenêtre partitionnée et ordonnancée&lt;/h4&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Combinons le &lt;code&gt;PARTITION BY&lt;/code&gt; avec le &lt;code&gt;ORDER BY&lt;/code&gt; :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;SELECT&#xA;&#x9;identifiant,&#xA;&#x9;groupe,&#xA;&#x9;ordre,&#xA;&#x9;row_number() OVER ma_fenetre,&#xA;&#x9;rank() OVER ma_fenetre,&#xA;&#x9;dense_rank() OVER ma_fenetre,&#xA;&#x9;lag(identifiant, 1) OVER ma_fenetre,&#xA;&#x9;first_value(identifiant) OVER ma_fenetre,&#xA;&#x9;lead(identifiant, 1) OVER ma_fenetre,&#xA;&#x9;last_value(identifiant) OVER ma_fenetre&#xA;FROM &#xA;&#x9;public.test_fenetrage&#xA;WINDOW&#xA;&#x9;ma_fenetre AS (&#xA;&#x9;&#x9;PARTITION BY&#xA;&#x9;&#x9;&#x9;groupe&#xA;&#x9;&#x9;ORDER BY&#xA;&#x9;&#x9;&#x9;ordre ASC&#xA;&#x9;&#x9;RANGE&#xA;&#x9;&#x9;&#x9;BETWEEN&#xA;&#x9;&#x9;&#x9;&#x9;UNBOUNDED PRECEDING&#xA;&#x9;&#x9;&#x9;AND&#xA;&#x9;&#x9;&#x9;&#x9;CURRENT ROW&#xA;&#x9;)&#xA;;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voici le résultat :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure class=&#34;wp-block-table&#34;&gt;&lt;table class=&#34;has-fixed-layout&#34;&gt;&lt;thead&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;identifiant&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;groupe&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;ordre&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;row_number&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;rank&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;dense_rank&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;lag&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;first_value&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;lead&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;last_value&lt;/td&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-1&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-2&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-3&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;A-4&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-1&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;B-4&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-4&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-2&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-1&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;C-1&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Nous avons maintenant des données calculées pour chaque partition en utilisant un ordre d&amp;rsquo;affichage spécifique.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Statistiques sur mon dernier voyage&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Nous allons maintenant voir un cas légèrement plus concret. Il s&amp;rsquo;agit d&amp;rsquo;un petit tour que j&amp;rsquo;ai fait en Europe et dont j&amp;rsquo;aimerais calculer quelques statistiques.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p class=&#34;has-bleu-dodger-color has-text-color has-link-color wp-elements-3c6d8cfd14dcc1cdeb3ec9c6ac006d7c&#34;&gt;Notez que vous aurez besoin de PostGIS pour cet exemple.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voici les données :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;-- DROP TABLE public.voyage_fenetrage;&#xA;&#xA;CREATE TABLE public.voyage_fenetrage AS &#xA;SELECT&#xA;  *&#xA;FROM (&#xA;  VALUES&#xA;    (&#39;2023-07-01&#39;::date, &#39;Maison&#39;, &#39;Maison&#39;, &#39;SRID=4326;POINT(6.3183 46.19)&#39;::geometry(point, 4326)),&#xA;    (&#39;2023-07-01&#39;::date, &#39;Suisse&#39;, &#39;Genève&#39;, &#39;SRID=4326;POINT(6.14 46.20)&#39;::geometry(point, 4326)),&#xA;    (&#39;2023-07-03&#39;::date, &#39;Suisse&#39;, &#39;Berne&#39;, &#39;SRID=4326;POINT(7.44 46.95)&#39;::geometry(point, 4326)),&#xA;    (&#39;2023-07-07&#39;::date, &#39;Suisse&#39;, &#39;Zurich&#39;, &#39;SRID=4326;POINT(8.54 47.37)&#39;::geometry(point, 4326)),&#xA;    (&#39;2023-07-10&#39;::date, &#39;Autriche&#39;, &#39;Innsbruck&#39;, &#39;SRID=4326;POINT(11.39 47.26)&#39;::geometry(point, 4326)),&#xA;    (&#39;2023-07-12&#39;::date, &#39;Allemagne&#39;, &#39;Munich&#39;, &#39;SRID=4326;POINT(11.58 48.14)&#39;::geometry(point, 4326)),&#xA;    (&#39;2023-07-17&#39;::date, &#39;Allemagne&#39;, &#39;Francfort&#39;, &#39;SRID=4326;POINT(8.68 50.11)&#39;::geometry(point, 4326)),&#xA;    (&#39;2023-07-21&#39;::date, &#39;Allemagne&#39;, &#39;Berlin&#39;, &#39;SRID=4326;POINT(13.41 52.52)&#39;::geometry(point, 4326)),&#xA;    (&#39;2023-07-25&#39;::date, &#39;Allemagne&#39;, &#39;Hambourg&#39;, &#39;SRID=4326;POINT(9.99 53.55)&#39;::geometry(point, 4326)),&#xA;    (&#39;2023-07-29&#39;::date, &#39;Danemark&#39;, &#39;Copenhague&#39;, &#39;SRID=4326;POINT(12.58 55.68)&#39;::geometry(point, 4326)),&#xA;    (&#39;2023-08-01&#39;::date, &#39;Royaume-Uni&#39;, &#39;Édimbourg&#39;, &#39;SRID=4326;POINT(-3.20 55.95)&#39;::geometry(point, 4326)),&#xA;    (&#39;2023-08-05&#39;::date, &#39;Royaume-Uni&#39;, &#39;Glasgow&#39;, &#39;SRID=4326;POINT(-4.25 55.86)&#39;::geometry(point, 4326)),&#xA;    (&#39;2023-08-09&#39;::date, &#39;Royaume-Uni&#39;, &#39;Manchester&#39;, &#39;SRID=4326;POINT(-2.24 53.48)&#39;::geometry(point, 4326)),&#xA;    (&#39;2023-08-13&#39;::date, &#39;Royaume-Uni&#39;, &#39;Londres&#39;, &#39;SRID=4326;POINT(0 51.51)&#39;::geometry(point, 4326)),&#xA;    (&#39;2023-08-16&#39;::date, &#39;France&#39;, &#39;Paris&#39;, &#39;SRID=4326;POINT(2.35 48.85)&#39;::geometry(point, 4326)),&#xA;    (&#39;2023-08-20&#39;::date, &#39;France&#39;, &#39;Nantes&#39;, &#39;SRID=4326;POINT(-1.55 47.21)&#39;::geometry(point, 4326)),&#xA;    (&#39;2023-08-22&#39;::date, &#39;France&#39;, &#39;Toulouse&#39;, &#39;SRID=4326;POINT(1.44 43.60)&#39;::geometry(point, 4326)),&#xA;    (&#39;2023-08-25&#39;::date, &#39;France&#39;, &#39;Marseille&#39;, &#39;SRID=4326;POINT(5.37 43.29)&#39;::geometry(point, 4326)),&#xA;    (&#39;2023-08-28&#39;::date, &#39;France&#39;, &#39;Annecy&#39;, &#39;SRID=4326;POINT(6.13 45.90)&#39;::geometry(point, 4326)),&#xA;    (&#39;2023-08-31&#39;::date, &#39;Maison&#39;, &#39;Maison&#39;, &#39;SRID=4326;POINT(6.3183 46.19)&#39;::geometry(point, 4326))&#xA;) as t1 (date_arrive, pays, ville, geom)&#xA;;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Je considère que la date d&amp;rsquo;arrivée quelque part correspond à la date d&amp;rsquo;arrivée à l&amp;rsquo;étape suivante.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Le but est d&amp;rsquo;avoir des informations tout au long du trajet : distance parcourue, pourcentage d&amp;rsquo;avancement, avancement par pays&amp;#8230;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Nous allons utiliser plusieurs fenêtres en parallèle afin de calculer ce dont nous avons besoin.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;SELECT&#xA;  -- Localisation étape&#xA;  concat(ville, &#39; (&#39;, pays, &#39;)&#39;) AS etape,&#xA;  -- Date d&#39;arrivée&#xA;  date_arrive,&#xA;  -- Date de départ : date d&#39;arrivée de la ligne suivante&#xA;  lead(date_arrive, 1) OVER toutes_lignes AS date_depart,&#xA;  -- Durée de l&#39;étape&#xA;  lead(date_arrive, 1) OVER toutes_lignes - date_arrive AS duree_etape,&#xA;  -- Durée totale du voyage trajet depuis la première localisation&#xA;  -- Fonction first_value permettant de récupérer la première ligne de la fenêtre&#xA;  date_arrive - first_value(date_arrive) OVER toutes_lignes AS duree_voyage,&#xA;  -- Distance parcourue depuis la localisation précédente&#xA;  -- Fonction lag permettant de récupérer la ligne précédente&#xA;  -- ST_DistanceSpheroid pour obtenir la distance entre deux coordonnées en WGS84&#xA;  ST_DistanceSpheroid(&#xA;    geom, &#xA;    lag(geom, 1) OVER toutes_lignes,&#xA;    &#39;SPHEROID[&#34;WGS 84&#34;,6378137,298.257223563]&#39;&#xA;  )::integer/1000 AS distance_depuis_loc_precedente,&#xA;  -- Distance totale parcourue depuis la première localisation&#xA;  -- Fonction ST_MakeLine permettant de créer une ligne constituée de l&#39;ensemble des points de la fenêtre&#xA;  -- L&#39;ordre des point est assuré par la fenêtre&#xA;  -- ST_DistanceSpheroid pour obtenir la longueur d&#39;une ligne en WGS84&#xA;  ST_LengthSpheroid(&#xA;    ST_MakeLine(geom) OVER lignes_precedentes,&#xA;    &#39;SPHEROID[&#34;WGS 84&#34;,6378137,298.257223563]&#39;&#xA;  )::integer/1000 AS distance_parcourue,&#xA;  -- Calcul d&#39;un pourcentage de parcours en comparant les valeurs issues de calculs sur deux fenêtres différentes&#xA;  round(&#xA;    ST_LengthSpheroid(&#xA;      ST_MakeLine(geom) OVER lignes_precedentes,&#xA;      &#39;SPHEROID[&#34;WGS 84&#34;,6378137,298.257223563]&#39;&#xA;    )::numeric /&#xA;    ST_LengthSpheroid(&#xA;      ST_MakeLine(geom) OVER toutes_lignes,&#xA;      &#39;SPHEROID[&#34;WGS 84&#34;,6378137,298.257223563]&#39;&#xA;    )::numeric *&#xA;    100,&#xA;    2&#xA;  ) AS pourcentage_trajet,&#xA;  -- Calcul d&#39;un pourcentage de parcours par pays en comparant les valeurs issues de calculs sur deux fenêtres différentes&#xA;  -- La fonction nullif permet d&#39;éliminer les divisions par 0&#xA;  round(&#xA;    ST_LengthSpheroid(&#xA;      ST_MakeLine(geom) OVER lignes_precedentes_pays,&#xA;      &#39;SPHEROID[&#34;WGS 84&#34;,6378137,298.257223563]&#39;&#xA;    )::numeric /&#xA;    nullif(ST_LengthSpheroid(&#xA;      ST_MakeLine(geom) OVER toutes_lignes_pays,&#xA;      &#39;SPHEROID[&#34;WGS 84&#34;,6378137,298.257223563]&#39;&#xA;    )::numeric,0) *&#xA;    100,&#xA;    2&#xA;  ) AS pourcentage_trajet_pays&#xA;FROM &#xA;  public.voyage_fenetrage&#xA;WINDOW&#xA;  toutes_lignes AS (&#xA;    ORDER BY&#xA;      date_arrive&#xA;    ROWS&#xA;      BETWEEN&#xA;        UNBOUNDED PRECEDING&#xA;      AND&#xA;        UNBOUNDED FOLLOWING&#xA;  ),&#xA;  lignes_precedentes AS (&#xA;    ORDER BY&#xA;      date_arrive&#xA;    ROWS&#xA;      BETWEEN&#xA;        UNBOUNDED PRECEDING&#xA;      AND&#xA;        CURRENT ROW&#xA;  ),&#xA;  toutes_lignes_pays AS (&#xA;    PARTITION BY &#xA;      pays&#xA;    ORDER BY&#xA;      date_arrive&#xA;    ROWS&#xA;      BETWEEN&#xA;        UNBOUNDED PRECEDING&#xA;      AND&#xA;        UNBOUNDED FOLLOWING&#xA;  ),&#xA;  lignes_precedentes_pays AS (&#xA;    PARTITION BY &#xA;      pays&#xA;    ORDER BY&#xA;      date_arrive&#xA;    ROWS&#xA;      BETWEEN&#xA;        UNBOUNDED PRECEDING&#xA;      AND&#xA;        CURRENT ROW&#xA;  )&#xA;;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voici le résultat :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure class=&#34;wp-block-table&#34;&gt;&lt;table class=&#34;has-fixed-layout&#34;&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;etape&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;date_arrive&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;date_depart&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;duree_etape&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;duree_voyage&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;distance_depuis_loc_precedente&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;distance_parcourue&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;pourcentage_trajet&lt;/th&gt;&lt;th class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;pourcentage_trajet_pays&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;Maison (Maison)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2023-07-01&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2023-07-01&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&amp;nbsp;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&amp;nbsp;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;Genève (Suisse)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2023-07-01&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2023-07-03&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;14&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;14&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0,28&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;Berne (Suisse)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2023-07-03&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2023-07-07&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;129&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;144&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2,76&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;57,61&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;Zurich (Suisse)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2023-07-07&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2023-07-10&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;6&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;95&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;240&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4,58&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;100&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;Innsbruck (Autriche)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2023-07-10&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2023-07-12&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;9&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;215&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;456&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;8,69&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&amp;nbsp;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;Munich (Allemagne)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2023-07-12&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2023-07-17&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;5&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;11&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;98&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;554&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;10,58&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;Francfort (Allemagne)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2023-07-17&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2023-07-21&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;16&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;304&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;859&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;16,38&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;30,89&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;Berlin (Allemagne)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2023-07-21&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2023-07-25&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;20&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;424&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1 284&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;24,48&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;73,99&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;Hambourg (Allemagne)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2023-07-25&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2023-07-29&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;24&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;256&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1 540&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;29,37&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;100&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;Copenhague (Danemark)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2023-07-29&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2023-08-01&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;28&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;290&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;1 830&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;34,9&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&amp;nbsp;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;Édimbourg (Royaume-Uni)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2023-08-01&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2023-08-05&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;31&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;987&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2 818&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;53,72&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;Glasgow (Royaume-Uni)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2023-08-05&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2023-08-09&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;35&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;66&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2 884&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;54,99&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;10,58&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;Manchester (Royaume-Uni)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2023-08-09&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2023-08-13&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;39&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;294&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3 179&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;60,61&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;57,53&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;Londres (Royaume-Uni)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2023-08-13&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2023-08-16&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;43&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;266&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3 446&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;65,7&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;100&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;Paris (France)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2023-08-16&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2023-08-20&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;46&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;340&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3 786&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;72,18&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;0&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;Nantes (France)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2023-08-20&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2023-08-22&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;50&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;343&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4 130&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;78,72&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;24,11&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;Toulouse (France)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2023-08-22&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2023-08-25&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;52&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;464&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4 594&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;87,57&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;56,72&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;Marseille (France)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2023-08-25&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2023-08-28&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;55&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;319&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;4 914&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;93,67&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;79,19&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;Annecy (France)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2023-08-28&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2023-08-31&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;3&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;58&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;296&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;5 210&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;99,32&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;100&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;Maison (Maison)&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;2023-08-31&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&amp;nbsp;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&amp;nbsp;&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;61&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;35&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;5 246&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;100&lt;/td&gt;&lt;td class=&#34;has-text-align-center&#34; data-align=&#34;center&#34;&gt;&amp;nbsp;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Vous voyez qu&amp;rsquo;avec le fenêtrage il devient simple de réaliser tout un tas de calculs divers et variés sur vos données.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Un excellent exemple est également fournit dans l&amp;rsquo;article suivant où je me sers du fenêtrage pour déterminer le parcours du Père Noël dans la nuit du 24 au 25.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;figure class=&#34;wp-block-embed aligncenter is-type-wp-embed is-provider-bazinga-039-s wp-block-embed-bazinga-039-s&#34;&gt;&lt;div class=&#34;wp-block-embed__wrapper&#34;&gt;&#xA;&lt;blockquote class=&#34;wp-embedded-content&#34; data-secret=&#34;1XkVFCGu98&#34;&gt;&lt;a href=&#34;https://blog.arthurbazin.com/bdd/postgresql/suivons-le-pere-noel-avec-postgis&#34;&gt;Suivons le Père Noël avec PostGIS (Nouvelle version)&lt;/a&gt;&lt;/blockquote&gt;&lt;iframe loading=&#34;lazy&#34; class=&#34;wp-embedded-content&#34; sandbox=&#34;allow-scripts&#34; security=&#34;restricted&#34;  title=&#34;« Suivons le Père Noël avec PostGIS (Nouvelle version) » &amp;#8212; BazinGa&amp;#039;s&#34; src=&#34;https://blog.arthurbazin.com/bdd/postgresql/suivons-le-pere-noel-avec-postgis/embed#?secret=31T1XinWsi#?secret=1XkVFCGu98&#34; data-secret=&#34;1XkVFCGu98&#34; width=&#34;600&#34; height=&#34;338&#34; frameborder=&#34;0&#34; marginwidth=&#34;0&#34; marginheight=&#34;0&#34; scrolling=&#34;no&#34;&gt;&lt;/iframe&gt;&#xA;&lt;/div&gt;&lt;/figure&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 class=&#34;wp-block-heading&#34;&gt;Pour aller plus loin&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Cet article fait parti du cours sur PostgreSQL, parties 3 et 4 du Vade-mecum.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-buttons is-vertical is-content-justification-center is-layout-flex wp-container-core-buttons-is-layout-9a7cdcfd wp-block-buttons-is-layout-flex&#34;&gt;&#xA;&lt;div class=&#34;wp-block-button has-custom-width wp-block-button__width-50&#34;&gt;&lt;a class=&#34;wp-block-button__link wp-element-button&#34; href=&#34;https://blog.arthurbazin.com/programmation/sql/postgresql-tout-comprendre-1&#34;&gt;Cours sur PostgreSQL&lt;/a&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-button has-custom-width wp-block-button__width-50&#34;&gt;&lt;a class=&#34;wp-block-button__link wp-element-button&#34; href=&#34;https://blog.arthurbazin.com/programmation/sql/postgresql-vade-mecum-3#le_fenetrage&#34;&gt;Vade-mecum &amp;#8211; 3 &amp;#8211; Gérer la donnée&lt;/a&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-button has-custom-width wp-block-button__width-50&#34;&gt;&lt;a class=&#34;wp-block-button__link wp-element-button&#34; href=&#34;https://blog.arthurbazin.com/programmation/postgresql-vade-mecum-4#fonction_de_fenetrage&#34;&gt;Vade-mecum &amp;#8211; 4 &amp;#8211; Fonctions et opérateurs&lt;/a&gt;&lt;/div&gt;&#xA;&lt;/div&gt;&#xA;</content>
    <link href="https://blog.arthurbazin.com/bdd/postgresql/ouvrez-les-fenetres-de-postgresql-guide-complet-sur-le-fenetrage" rel="alternate"></link>
    <summary type="html">Voici un guide complet sur l&#39;utilisation du fenêtrage sous PostgreSQL. Ces fonctionnalités sont particulièrement pratique lors de l&#39;analyse de données continues.</summary>
    <author>
      <name>Arthur Bazin</name>
    </author>
  </entry>
  <entry>
    <title>Suivons le Père Noël avec PostGIS (Nouvelle version)</title>
    <updated>2023-12-14T13:23:01Z</updated>
    <id>tag:blog.arthurbazin.com,2023-12-14:/bdd/postgresql/suivons-le-pere-noel-avec-postgis</id>
    <content type="html">&#xA;&lt;p&gt;Cette année pour Noël, j&amp;rsquo;ai eu l&amp;rsquo;idée de monter une application de suivi du Père Noël en temps réel. &lt;a href=&#34;https://santatracker.google.com/&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener nofollow&#34;&gt;Google&lt;/a&gt; le fait déjà et le &lt;a href=&#34;https://www.noradsanta.org/fr/index.html&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener nofollow&#34;&gt;NORAD&lt;/a&gt; aussi alors pourquoi pas un frenchy ?&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Comme j&amp;rsquo;ai « quelques notions » de SQL et que je travaille chez &lt;a href=&#34;https://www.business-geografic.com/fr/&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener nofollow&#34;&gt;Business Geografic&lt;/a&gt; (&lt;a href=&#34;https://www.cirilgroup.com/fr/&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener nofollow&#34;&gt;Ciril GROUP&lt;/a&gt;) (éditeur français de solutions cartographiques web) qui a accepter de suivre ma démarche, j&amp;rsquo;ai tous les outils nécessaires à une telle application sous la main. &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Pour la suite des explications, c&amp;rsquo;est juste en dessous de l&amp;rsquo;appli (que vous pouvez consulter en plein écran sur &lt;a href=&#34;https://noel.cirilgroup.com&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;noel.cirilgroup.com&lt;/a&gt;).&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;iframe loading=&#34;lazy&#34; id=&#34;iframe_santa_tracker&#34; title=&#34;Le voyage du Père Noël&#34; src=&#34;https://geoservices.business-geografic.com/adws/app/c2d0e97d-6c09-11ed-9a76-19bfa8332a84/&#34; width=&#34;100%&#34; height=&#34;650px&#34;&gt;&#xA;&lt;/iframe&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Notez que cet article s’intéresse surtout à la partie donnée (PostgreSQL + PostGIS) et moins à la partie conception de l&amp;rsquo;application qui repose sur &lt;a href=&#34;https://www.business-geografic.com/fr/geo-software/geo-technologies.html&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;GEO Software de Business Geografic (Ciril GROUP)&lt;/a&gt;.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr class=&#34;wp-block-separator has-alpha-channel-opacity is-style-default&#34;/&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Pour le suivi, j&amp;rsquo;ai un peu étudier la chose et il s&amp;rsquo;avère qu&amp;rsquo;un traineau magique, ça n’apparait pas sur les radars. Il est donc compliqué de suivre le bonhomme. &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Malgré mes nombreux courriers, le Père Noël refuse également de m&amp;rsquo;envoyer son itinéraire détaillé, un petit GPX aurait pourtant bien fait mon affaire mais il semble qu&amp;rsquo;il n&amp;rsquo;utilise pas de GPS&amp;#8230;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Il faut donc un peu ruser pour suivre Santa à la trace et voici comment j&amp;rsquo;ai procédé.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Le principe est de partir d&amp;rsquo;une liste de destinations que le Père Noël va visiter. On calcule ensuite le trajet pour rejoindre toutes ces destinations en tenant compte du fait que le passage doit s&amp;rsquo;effectuer durant la nuit du 24 au 25 décembre et que la terre tourne donc que l&amp;rsquo;heure de passage s&amp;rsquo;étale de GMT+12 à GMT-12 (d&amp;rsquo;est en ouest). Plus facile à dire qu&amp;rsquo;a faire mais essayons.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;L&amp;rsquo;application repose sur PostgreSQL 11 + PostGIS 2.5 (je sais, c&amp;rsquo;est oldschool mais ça tourne bien) mais vous pouvez utiliser les requêtes suivantes dans PostgreSQL 15 + PostGIS 3.x.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Nous serons dans le schéma suivant :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;CREATE SCHEMA IF NOT EXISTS santa_tracker;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 class=&#34;wp-block-heading&#34;&gt;Destination&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;A priori, le Père Noël visite toutes les maisons du monde. Ceci dit, « toutes les maisons du monde » c&amp;rsquo;est complexe à cartographier : un igloo doit il être considéré comme une maison même s&amp;rsquo;il n&amp;rsquo;a pas de cheminée ? &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Alors simplifions un peu la chose et basons nous sur l&amp;rsquo;ensemble des villes du monde. Bon là aussi c&amp;rsquo;est complexe car il y a vraiment beaucoup de villes et ça risque d&amp;rsquo;être difficile de suivre tous les déplacements. &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Simplifions encore et prenons environ 500 destinations parmi les plus connues dans le monde (avec une sur représentation des villes de l’hexagone ;-).&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Pour récupérer ces données, une petite recherche sur internet et nous voila avec &lt;a rel=&#34;noreferrer noopener nofollow&#34; href=&#34;https://public.opendatasoft.com/explore/dataset/geonames-all-cities-with-a-population-1000/&#34; target=&#34;_blank&#34;&gt;un magnifique jeu de données&lt;/a&gt; du monde entier dont la population est supérieure à 1000 habitants.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Quelques traitements plus tard (rien de bien sorcier, juste des formules magiques pour récupérer les villes qui m&amp;rsquo;intéressent) nous voici avec la table suivante :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;CREATE TABLE santa_tracker.destination (&#xA;&#x9;-- Un identifiant numérique&#xA;&#x9;id_destination int8 PRIMARY KEY,&#xA;&#x9;-- La région de la destination&#xA;&#x9;region text,&#xA;&#x9;-- Le nom de la destination&#xA;&#x9;ville text,&#xA;&#x9;-- Le nombre d&#39;habitant dans cette destination&#xA;&#x9;population int8,&#xA;&#x9;-- L&#39;interval de temps entre le fuseau horaire de la destination et GMT&#xA;&#x9;utc_offset interval,&#xA;&#x9;-- L&#39;emplacement de la destination&#xA;&#x9;geom public.geometry(point, 4326)&#xA;);&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Problème, cette table ne possède pas l&amp;#8217;emplacement du Père Noël&amp;#8230; Nous allons rusé pour cela.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 class=&#34;wp-block-heading&#34;&gt;Quelques variables&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Pour les différents calculs que nous allons mener, je vais avoir besoin de définir certains paramètres. &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Pour cela, nous allons créer une vue dans laquelle nous stockerons des variables que nous pourrons utiliser dans nos différentes requêtes.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;DROP VIEW IF EXISTS santa_tracker.v_00_variable CASCADE;&#xA;&#xA;CREATE OR REPLACE VIEW santa_tracker.v_00_variable as (&#xA;&#xA;&#x9;SELECT &#xA;&#x9;&#x9;-- Population&#xA;&#x9;&#x9;-- Le nombre total d&#39;être humain sur Terre&#xA;&#x9;&#x9;8000000000 as pop_total,&#xA;&#x9;&#x9;-- Le pourcentage de personne recevant des cadeaux (oui, certains ont été méchants cette année)&#xA;&#x9;&#x9;0.95 as cadeau_par_pop,&#xA;&#x9;&#x9;-- Le nombre de cadeau par personnes&#xA;&#x9;&#x9;1 as cadeau_par_pers,&#xA;&#x9;&#x9;&#xA;&#x9;&#x9;-- Autres données&#xA;&#x9;&#x9;-- Largeur d&#39;une zone de longitude (ce qui permet de diviser le globe en secteurs de passage)&#xA;&#x9;&#x9;10 as largeur_zone_longitude,&#xA;&#x9;&#x9;-- Le pourcentage de temps total passé à voler de maison en maison (ici 90% de temps de vol donc 10% du temps passé dans les maisons)&#xA;&#x9;&#x9;90::numeric as pourcent_temps_de_vol,&#xA;&#x9;&#x9;-- Les informations sur l&#39;emplacement de la maison du Père Noël&#xA;&#x9;&#x9;jsonb_build_object(&#xA;&#x9;&#x9;&#x9;&#39;id&#39;, 0,&#xA;&#x9;&#x9;&#x9;&#39;region&#39;, &#39;Svalbard&#39;,&#xA;&#x9;&#x9;&#x9;&#39;ville&#39;, &#39;Maison de la famille Noël&#39;,&#xA;&#x9;&#x9;&#x9;&#39;population&#39;, 2,&#xA;&#x9;&#x9;&#x9;&#39;utc_offset&#39;, 1,&#xA;&#x9;&#x9;&#x9;&#39;geom_4326&#39;, &#39;SRID=4326;POINT(24 80)&#39;&#xA;&#x9;&#x9;) as maison_pere_noel,&#xA;&#x9;&#x9;&#xA;&#x9;&#x9;-- Dates et horaire&#xA;&#x9;&#x9;-- Les dates contiennent toujours les heures&#xA;&#x9;&#x9;-- Le temps est exprimé en temps UTC&#xA;&#x9;&#x9;-- L&#39;heure exacte du début de la distribution (le 24 décembre à 19h sur le premier fuseau horaire)&#xA;&#x9;&#x9;(extract(year from now()) || &#39;-12-24 19:00:00 +12&#39;)::timestamp with time zone as debut_distrib,&#xA;&#x9;&#x9;-- L&#39;heure exacte de la fin de la distribution (le 25 décembre à 5h sur le dernier fuseau horaire)&#xA;&#x9;&#x9;(extract(year from now()) || &#39;-12-25 05:00:00 -12&#39;)::timestamp with time zone as fin_distrib,&#xA;&#x9;&#x9;-- Durée du trajet pour rejoindre la première destination depuis la maison du Père Noël&#xA;&#x9;&#x9;-- Durée également pour rejoindre la maison du Père Noël depuis la dernière maison&#xA;&#x9;&#x9;&#39;2 minutes&#39;::interval as delai_dest_santa_house,&#xA;&#xA;&#x9;&#x9;-- Heure du début de la transaction&#xA;&#x9;&#x9;--transaction_timestamp() as &#34;now&#34;&#x9;-- Maintenant&#xA;&#xA;)&#xA;;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Notez l&amp;rsquo;utilisation des heures avec fuseau horaire car il faut tenir compte des différents emplacements sur Terre.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Pour le calcul des dates, on utilise une extraction de l&amp;rsquo;année depuis la fonction &lt;code&gt;transaction_timestamp()&lt;/code&gt; afin de rendre la vue valide tous les ans.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;On définit également une variable &lt;code&gt;now&lt;/code&gt; que l&amp;rsquo;on utilisera lors des calculs à un instant t car cela permet de faire des tests en fixant cette valeur. Cette dernière peut être modifiée pour vos tests, voila quelques moments possibles :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;generic&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;-- Heure du début de la transaction&#xA;transaction_timestamp() as &#34;now&#34;&#x9;-- Maintenant&#xA;&#39;2023-07-03 08:00:00 +0100&#39;::timestamp WITH time zone as &#34;now&#34; -- Fabrication&#xA;&#39;2023-12-24 07:59:00 +0100&#39;::timestamp WITH time zone as &#34;now&#34; -- Voyage aller&#xA;&#39;2023-12-24 19:00:10 +1200&#39;::timestamp WITH time zone as &#34;now&#34; -- Distribution 1ère destination&#xA;&#39;2023-12-24 19:00:45 +1200&#39;::timestamp WITH time zone as &#34;now&#34; -- Voyage depuis 1ère destination&#xA;&#39;2023-12-25 00:29:25 +0100&#39;::timestamp WITH time zone as &#34;now&#34; -- Distribution à Genève&#xA;&#39;2023-12-25 00:30:00 +0100&#39;::timestamp WITH time zone as &#34;now&#34; -- Voyage depuis Genève&#xA;&#39;2023-12-25 05:01:00 -1200&#39;::timestamp WITH time zone as &#34;now&#34; -- Voyage retour&#xA;&#39;2023-12-27 08:00:00 +0100&#39;::timestamp WITH time zone as &#34;now&#34; -- Repos&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 class=&#34;wp-block-heading&#34;&gt;Trajet&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Nous devons maintenant calculer le trajet.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Ce trajet doit répondre au critères suivants :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;Passer par toutes les destinations&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Démarrer et finir par la maison du Père Noël&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Chaque destination doit être visitée la nuit&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Nous allons donc devoir découper la Terre en zones de passage dans lesquelles le Père Noël aura un timing bien spécifique à respecter. Le principe est de déterminer l&amp;rsquo;intervalle de temps pendant lequel le Père Noël effectue sa tournée puis de diviser cet intervalle par le nombre de zones de passage.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Dans la vue &lt;code&gt;v_00_variable&lt;/code&gt; j&amp;rsquo;avais indiqué un découpage en zone de 10 degrés mais notez que si aucune destination n’existe dans une zone, il ne faudra alors pas en tenir compte.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;L&amp;rsquo;intervalle est définit par les dates de début et de fin de la tournée spécifiées dans la vue &lt;code&gt;v_00_variable&lt;/code&gt; : du 24 décembre à 19h (+12) jusqu&amp;rsquo;au 25 décembre à 5h (-12) : 1j et 10h soit 34h.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Pour calculer le trajet et pouvoir relancer le calcul facilement, je vais me baser sur plusieurs vues.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Calcul du rang longitudinal&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Le principe est d&amp;rsquo;attribuer à chaque destination un numéro de rang correspondant au numéro d&amp;rsquo;ordre de la zone de longitude à laquelle appartient la destination.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Une zone de longitude est une portion de la surface terrestre comprise entre deux bornes de longitudes. Ces bornes sont définies par rapport à un découpage du globe tous les x degrés ; x étant défini dans la vue &lt;code&gt;v_00_variable&lt;/code&gt;.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;DROP VIEW IF EXISTS santa_tracker.v_01_destination_rang_longitudeCASCADE;&#xA;&#xA;CREATE OR REPLACE VIEW santa_tracker.v_01_destination_rang_longitude as (&#xA;&#xA;&#x9;SELECT &#xA;&#x9;&#x9;id_destination,&#xA;&#x9;&#x9;region,&#xA;&#x9;&#x9;ville,&#xA;&#x9;&#x9;population,&#xA;&#x9;&#x9;utc_offset,&#xA;&#x9;&#x9;-- Récupération du rang de chaque zone de longitude (plage de x degré définit dans la vue v_00_variable)&#xA;&#x9;&#x9;-- Le fenêtrage permet d&#39;éliminer les zones sans destination&#xA;&#x9;&#x9;dense_rank() OVER zone_longitude as rang_longitude,&#xA;&#x9;&#x9;geom&#xA;&#x9;FROM &#xA;&#x9;&#x9;santa_tracker.destination &#xA;&#x9;CROSS JOIN &#xA;&#x9;&#x9;santa_tracker.v_00_variable as var&#xA;&#x9;WINDOW &#xA;&#x9;&#x9;zone_longitude AS (&#xA;&#x9;&#x9;&#x9;ORDER BY &#xA;&#x9;&#x9;&#x9;&#x9;floor(&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;(-ST_X(geom) + 180)::numeric &#xA;&#x9;&#x9;&#x9;&#x9;&#x9;/ var.largeur_zone_longitude&#xA;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;+ 1&#xA;&#x9;&#x9;&#x9;ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING&#xA;&#x9;&#x9;)&#xA;&#xA;)&#xA;;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Ordonnancement par latitude&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Au sein de chaque zone de longitude, les destinations sont ordonnancées afin d&amp;rsquo;avoir un trajet cohérent allant du nord au sud dans une zone puis du sud au nord dans la zone suivante dans un mouvement à l&amp;rsquo;effet « yoyo ».&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;DROP VIEW IF EXISTS santa_tracker.v_02_destination_rang_latitude CASCADE;&#xA;&#xA;CREATE VIEW santa_tracker.v_02_destination_rang_latitude as (&#xA;&#xA;&#x9;SELECT &#xA;&#x9;&#x9;id_destination,&#xA;&#x9;&#x9;region,&#xA;&#x9;&#x9;ville,&#xA;&#x9;&#x9;population,&#xA;&#x9;&#x9;utc_offset,&#xA;&#x9;&#x9;rang_longitude,&#xA;&#x9;&#x9;-- Récupération du rang de chaque destination au sein de sa zone de longitude&#xA;&#x9;&#x9;-- Le rang est déterminé par la latitude de l&#39;objet&#xA;&#x9;&#x9;-- Pour faire un effet &#34;yoyo&#34;, on inverse l&#39;ordonnancement des latitudes une zone de longitude sur deux&#xA;&#x9;&#x9;row_number() OVER zone_latitude as rang_latitude,&#xA;&#x9;&#x9;last_value(rang_longitude) OVER all_zone_longitude as nb_zone_longitude,&#xA;&#x9;&#x9;count(id_destination) OVER part_by_zone_longitude as nb_destination_in_zone,&#xA;&#x9;&#x9;geom&#xA;&#x9;FROM &#xA;&#x9;&#x9;santa_tracker.v_01_destination_rang_longitude&#xA;&#x9;WINDOW &#xA;&#x9;&#x9;zone_latitude AS (&#xA;&#x9;&#x9;&#x9;PARTITION BY &#xA;&#x9;&#x9;&#x9;&#x9;rang_longitude&#xA;&#x9;&#x9;&#x9;ORDER BY &#xA;&#x9;&#x9;&#x9;&#x9;rang_longitude,&#xA;&#x9;&#x9;&#x9;&#x9;CASE &#xA;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN rang_longitude % 2 = 0 THEN ST_Y(geom)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE -ST_Y(geom)&#xA;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING&#xA;&#x9;&#x9;),&#xA;&#x9;&#x9;part_by_zone_longitude AS (&#xA;&#x9;&#x9;&#x9;PARTITION BY rang_longitude&#xA;&#x9;&#x9;&#x9;ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING&#xA;&#x9;&#x9;),&#xA;&#x9;&#x9;all_zone_longitude AS (&#xA;&#x9;&#x9;&#x9;ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING&#xA;&#x9;&#x9;)&#xA;&#xA;)&#xA;;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Consolidation des destinations&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Pour chaque destination, on va calculer plusieurs valeurs, notamment des cumuls par rapport aux destination précédentes. &lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Cette vue est une sorte de version améliorée de la table &lt;code&gt;destination&lt;/code&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;DROP VIEW IF EXISTS santa_tracker.v_03_destination CASCADE;&#xA;&#xA;CREATE OR REPLACE VIEW santa_tracker.v_03_destination as (&#xA;&#xA;&#x9;SELECT &#xA;&#x9;&#x9;id_destination,&#xA;&#x9;&#x9;region,&#xA;&#x9;&#x9;ville,&#xA;&#x9;&#x9;-- Le fenêtrage permet de récupérer la prochaine destination&#xA;&#x9;&#x9;first_value(id_destination) OVER next_etape as id_destination_next,&#xA;&#x9;&#x9;first_value(region) OVER next_etape as region_next,&#xA;&#x9;&#x9;first_value(ville) OVER next_etape as ville_next,&#xA;&#x9;&#x9;population,&#xA;&#x9;&#x9;-- Création d&#39;une valeur de population fictive&#xA;&#x9;&#x9;-- pour qu&#39;une fois toutes destination visitées, le Père Noël ait vu toute la population mondiale&#xA;&#x9;&#x9;round( &#xA;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;(population / sum(population) OVER ()) &#xA;&#x9;&#x9;&#x9;&#x9;* var.pop_total::NUMERIC&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;0&#xA;&#x9;&#x9;) as pop_fictive,&#xA;&#x9;&#x9;utc_offset,&#xA;&#x9;&#x9;rang_longitude,&#xA;&#x9;&#x9;rang_latitude,&#xA;&#x9;&#x9;-- Rang de l&#39;étape&#xA;&#x9;&#x9;row_number() OVER all_etape as rang_etape,&#xA;&#x9;&#x9;nb_zone_longitude,&#xA;&#x9;&#x9;nb_destination_in_zone,&#xA;&#x9;&#x9;-- Temps de passage dans chaque zone&#xA;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;(var.fin_distrib - var.debut_distrib) &#xA;&#x9;&#x9;&#x9;/ nb_zone_longitude &#xA;&#x9;&#x9;) AS duree_zone,&#xA;&#x9;&#x9;-- Temps de passage dans chaque destination (distribution + trajet pour la suivante)&#xA;&#x9;&#x9;-- Durée totale / nb zone longitude = durée par zone&#xA;&#x9;&#x9;-- Durée par zone / nb étape dans zone = temps par étape&#xA;&#x9;&#x9;-- Pour la dernière zone, on retire le temps du dernier trajet (retour à la maison du Père Noël)&#xA;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;WHEN rang_longitude = nb_zone_longitude THEN &#xA;&#x9;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;(var.fin_distrib - var.debut_distrib) &#xA;&#x9;&#x9;&#x9;&#x9;&#x9;/ nb_zone_longitude &#xA;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;/ (&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;((nb_destination_in_zone - 1) * (var.pourcent_temps_de_vol/100))&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;+ (nb_destination_in_zone * ((100 - var.pourcent_temps_de_vol)/100))&#xA;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;ELSE &#xA;&#x9;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;(var.fin_distrib - var.debut_distrib) &#xA;&#x9;&#x9;&#x9;&#x9;&#x9;/ nb_zone_longitude &#xA;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;/ nb_destination_in_zone&#xA;&#x9;&#x9;END as duree_destination,&#xA;&#x9;&#x9;-- On reprojete les données pour travailler en coordonnées projetées&#xA;&#x9;&#x9;ST_Transform(geom, 3857) as geom,&#xA;&#x9;&#x9;-- Le fenêtrage permet de récupérer la géométrie de la prochaine destination&#xA;&#x9;&#x9;ST_Transform(&#xA;&#x9;&#x9;&#x9;first_value(geom) OVER next_etape,&#xA;&#x9;&#x9;&#x9;3857&#xA;&#x9;&#x9;) as geom_next&#xA;&#x9;FROM &#xA;&#x9;&#x9;santa_tracker.v_02_destination_rang_latitude&#xA;&#x9;CROSS JOIN &#xA;&#x9;&#x9;santa_tracker.v_00_variable as var&#xA;&#x9;WINDOW &#xA;&#x9;&#x9;all_etape AS (&#xA;&#x9;&#x9;&#x9;ORDER BY &#xA;&#x9;&#x9;&#x9;&#x9;rang_longitude, &#xA;&#x9;&#x9;&#x9;&#x9;rang_latitude&#xA;&#x9;&#x9;),&#xA;&#x9;&#x9;next_etape AS (&#xA;&#x9;&#x9;&#x9;ORDER BY&#xA;&#x9;&#x9;&#x9;&#x9;rang_longitude, &#xA;&#x9;&#x9;&#x9;&#x9;rang_latitude&#xA;&#x9;&#x9;&#x9;ROWS BETWEEN 1 FOLLOWING AND 1 FOLLOWING&#xA;&#x9;&#x9;)&#xA;&#xA;)&#xA;;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Étapes de distribution&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;A partir des données des destination, on génère des étapes de distribution des cadeaux.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Pendant ces étapes, le Père Noël s&amp;rsquo;arrête dans la destination et distribue les présents.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;DROP VIEW IF EXISTS santa_tracker.v_04_etape_distribution CASCADE;&#xA;&#xA;CREATE OR REPLACE VIEW santa_tracker.v_04_etape_distribution as (&#xA;&#xA;&#x9;SELECT &#xA;&#x9;&#x9;id_destination,&#xA;&#x9;&#x9;region,&#xA;&#x9;&#x9;ville,&#xA;&#x9;&#x9;-- Le fenêtrage permet de récupérer la prochaine destination&#xA;&#x9;&#x9;-- S&#39;il n&#39;y a pas de prochaine destination, alors on retourne chez le Père Noël&#xA;&#x9;&#x9;COALESCE(&#xA;&#x9;&#x9;&#x9;first_value(id_destination) OVER next_etape,&#xA;&#x9;&#x9;&#x9;(maison_pere_noel -&gt;&gt; &#39;id&#39;)::int&#xA;&#x9;&#x9;) as id_destination_next,&#xA;&#x9;&#x9;COALESCE(&#xA;&#x9;&#x9;&#x9;first_value(region) OVER next_etape,&#xA;&#x9;&#x9;&#x9;var.maison_pere_noel -&gt;&gt; &#39;region&#39;&#xA;&#x9;&#x9;) as region_next,&#xA;&#x9;&#x9;COALESCE(&#xA;&#x9;&#x9;&#x9;first_value(ville) OVER next_etape,&#xA;&#x9;&#x9;&#x9;var.maison_pere_noel -&gt;&gt; &#39;ville&#39;&#xA;&#x9;&#x9;) as ville_next,&#xA;&#x9;&#x9;population,&#xA;&#x9;&#x9;-- Création d&#39;une valeur de population fictive&#xA;&#x9;&#x9;-- pour qu&#39;une fois toutes destination visitées, le Père Noël ait vu toute la population mondiale&#xA;&#x9;&#x9;round( &#xA;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;population * var.pop_total::NUMERIC&#xA;&#x9;&#x9;&#x9;&#x9;/ sum(population) OVER ()&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;0&#xA;&#x9;&#x9;) as pop_fictive,&#xA;&#x9;&#x9;utc_offset,&#xA;&#x9;&#x9;COALESCE(&#xA;&#x9;&#x9;&#x9;first_value(utc_offset) OVER next_etape,&#xA;&#x9;&#x9;&#x9;(var.maison_pere_noel -&gt;&gt; &#39;utc_offset&#39;)::interval&#xA;&#x9;&#x9;) as utc_offset_next,&#xA;&#x9;&#x9;rang_longitude,&#xA;&#x9;&#x9;rang_latitude,&#xA;&#x9;&#x9;rang_etape,&#xA;&#x9;&#x9;nb_zone_longitude,&#xA;&#x9;&#x9;nb_destination_in_zone,&#xA;&#x9;&#x9;duree_destination,&#xA;&#x9;&#x9;(1 - (var.pourcent_temps_de_vol / 100)) * (duree_destination) AS duree_etape,&#xA;&#x9;&#x9;-- Le fenêtrage permet de récupérer l&#39;heure de début de l&#39;étape&#xA;&#x9;&#x9;var.debut_distrib + &#xA;&#x9;&#x9;coalesce(&#xA;&#x9;&#x9;&#x9;sum(duree_destination) OVER all_preceding_step,&#xA;&#x9;&#x9;&#x9;&#39;0&#39;::interval&#xA;&#x9;&#x9;)&#xA;&#x9;&#x9;as date_debut,&#xA;&#x9;&#x9;-- Le fenêtrage permet de récupérer l&#39;heure de fin de l&#39;étape&#xA;&#x9;&#x9;var.debut_distrib &#xA;&#x9;&#x9;+ (1 - (var.pourcent_temps_de_vol / 100)) * (duree_destination) &#xA;&#x9;&#x9;+ coalesce(&#xA;&#x9;&#x9;&#x9;sum(duree_destination) OVER all_preceding_step,&#xA;&#x9;&#x9;&#x9;&#39;0&#39;::interval&#xA;&#x9;&#x9;)&#xA;&#x9;&#x9;as date_fin,&#xA;&#x9;&#x9;-- Trajet effectué (ici ce sera un point)&#xA;&#x9;&#x9;-- On utilise une géométrie de type ligne pour homogénéïser les types de géométrie avec les trajets&#xA;&#x9;&#x9;ST_MakeLine(geom, geom) as geom,&#xA;&#x9;&#x9;geom AS geom_etape,&#xA;&#x9;&#x9;-- Le fenêtrage permet de récupérer la géométrie de la prochaine destination&#xA;&#x9;&#x9;-- S&#39;il n&#39;y a pas de prochaine destination, alors on retourne chez le Père Noël&#xA;&#x9;&#x9;ST_Transform(&#xA;&#x9;&#x9;&#x9;COALESCE(&#xA;&#x9;&#x9;&#x9;&#x9;first_value(geom) OVER next_etape,&#xA;&#x9;&#x9;&#x9;&#x9;(var.maison_pere_noel -&gt;&gt; &#39;geom_4326&#39;)::geometry(point,4326)&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;3857&#xA;&#x9;&#x9;) as geom_etape_next&#xA;&#x9;FROM &#xA;&#x9;&#x9;santa_tracker.v_03_destination&#xA;&#x9;CROSS JOIN &#xA;&#x9;&#x9;santa_tracker.v_00_variable as var&#xA;&#x9;WINDOW &#xA;&#x9;&#x9;next_etape AS (&#xA;&#x9;&#x9;&#x9;ORDER BY rang_etape&#xA;&#x9;&#x9;&#x9;ROWS BETWEEN 1 FOLLOWING AND 1 FOLLOWING&#xA;&#x9;&#x9;),&#xA;&#x9;&#x9;all_preceding_step AS (&#xA;&#x9;&#x9;&#x9;ORDER BY rang_etape&#xA;&#x9;&#x9;&#x9;ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING&#xA;&#x9;&#x9;)&#xA;&#xA;)&#xA;;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Étapes de trajet&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;A partir des données des destination, on génère également des étapes de trajet.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Pendant ces étapes, le Père Noël vol à bord de son traineau de destination en destination.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;DROP VIEW IF EXISTS santa_tracker.v_05_trajet CASCADE;&#xA;&#xA;CREATE OR REPLACE VIEW santa_tracker.v_05_trajet as (&#xA;&#xA;&#x9;SELECT &#xA;&#x9;&#x9;id_destination,&#xA;&#x9;&#x9;region,&#xA;&#x9;&#x9;ville,&#xA;&#x9;&#x9;id_destination_next,&#xA;&#x9;&#x9;region_next,&#xA;&#x9;&#x9;ville_next,&#xA;&#x9;&#x9;-- Il n&#39;y a aucune population lors du vol&#xA;&#x9;&#x9;0 AS population,&#xA;&#x9;&#x9;0 AS pop_fictive,&#xA;&#x9;&#x9;utc_offset,&#xA;&#x9;&#x9;utc_offset_next,&#xA;&#x9;&#x9;rang_longitude,&#xA;&#x9;&#x9;rang_latitude,&#xA;&#x9;&#x9;rang_etape,&#xA;&#x9;&#x9;nb_zone_longitude,&#xA;&#x9;&#x9;nb_destination_in_zone,&#xA;&#x9;&#x9;duree_destination,&#xA;&#x9;&#x9;-- La durée du trajet est égale à la durée totale de la destination moins la durée de l&#39;étape&#xA;&#x9;&#x9;duree_destination - duree_etape AS duree_trajet,&#xA;&#x9;&#x9;-- La date de début du trajet est identique à la date de fin de l&#39;étape&#xA;&#x9;&#x9;date_fin AS date_debut,&#xA;&#x9;&#x9;-- La date de fin correspond à la date de début de l&#39;étape + la durée sur la destination&#xA;&#x9;&#x9;date_debut + duree_destination AS date_fin,&#xA;&#x9;&#x9;-- Trajet effectué&#xA;&#x9;&#x9;ST_MakeLine(geom_etape, geom_etape_next) as geom&#xA;&#x9;FROM &#xA;&#x9;&#x9;santa_tracker.v_04_etape_distribution&#xA;&#x9;CROSS JOIN &#xA;&#x9;&#x9;santa_tracker.v_00_variable as var&#xA;&#x9;-- On ne calcul pas de trajet pour le retour à la maison du Père Noël&#xA;&#x9;WHERE &#xA;&#x9;&#x9;id_destination_next &amp;lt;&gt; 0&#xA;&#xA;)&#xA;;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Construction du voyage&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Pour créer le voyage, les étapes suivantes sont associées (via des &lt;code&gt;UNION ALL&lt;/code&gt;) :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;Le trajet de la maison du Père Noël jusqu&amp;rsquo;à la première destination (créé dans la requête).&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Les étapes de distribution des cadeaux.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Les étapes de trajet entre destinations.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Le trajet de dernière destination jusqu&amp;rsquo;à la la maison du Père Noël (créé dans la requête).&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Les éléments sont ensuite réagencés selon l&amp;rsquo;ordre de passage afin de pouvoir calculer certains cumuls (population visitée, cadeaux distribués, distance parcourue&amp;#8230;)&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;DROP VIEW IF EXISTS santa_tracker.v_06_voyage CASCADE;&#xA;&#xA;CREATE OR REPLACE VIEW santa_tracker.v_06_voyage as (&#xA;&#xA;WITH &#xA;&#x9;all_steps AS (&#xA;&#x9;&#x9;-- Trajet de la maison du Père Noël à la première destination&#xA;&#x9;&#x9;SELECT &#xA;&#x9;&#x9;&#x9;(var.maison_pere_noel -&gt;&gt; &#39;id&#39;)::int AS id_destination,&#xA;&#x9;&#x9;&#x9;var.maison_pere_noel -&gt;&gt; &#39;region&#39; AS region,&#xA;&#x9;&#x9;&#x9;var.maison_pere_noel -&gt;&gt; &#39;ville&#39; AS ville,&#xA;&#x9;&#x9;&#x9;etp.id_destination AS id_destination_next,&#xA;&#x9;&#x9;&#x9;etp.region AS region_next,&#xA;&#x9;&#x9;&#x9;etp.ville AS ville_next,&#xA;&#x9;&#x9;&#x9;-- Il n&#39;y a aucune population lors du vol&#xA;&#x9;&#x9;&#x9;0 AS population,&#xA;&#x9;&#x9;&#x9;0 AS pop_fictive,&#xA;&#x9;&#x9;&#x9;0 AS cadeau_distribue,&#xA;&#x9;&#x9;&#x9;(var.maison_pere_noel -&gt;&gt; &#39;utc_offset&#39;)::interval AS utc_offset,&#xA;&#x9;&#x9;&#x9;etp.utc_offset AS utc_offset_next,&#xA;&#x9;&#x9;&#x9;0 AS rang_longitude,&#xA;&#x9;&#x9;&#x9;0 AS rang_latitude,&#xA;&#x9;&#x9;&#x9;0 AS rang_etape,&#xA;&#x9;&#x9;&#x9;1 AS rang_voyage,&#xA;&#x9;&#x9;&#x9;&#39;Trajet&#39; AS type_etape,&#xA;&#x9;&#x9;&#x9;0 AS nb_zone_longitude,&#xA;&#x9;&#x9;&#x9;0 AS nb_destination_in_zone,&#xA;&#x9;&#x9;&#x9;-- La durée totale pour la destination est uniquement la durée du trajet (pas de distribution)&#xA;&#x9;&#x9;&#x9;var.delai_dest_santa_house AS duree_destination,&#xA;&#x9;&#x9;&#x9;-- La durée du trajet est fixée dans les variables&#xA;&#x9;&#x9;&#x9;var.delai_dest_santa_house AS duree_etape,&#xA;&#x9;&#x9;&#x9;-- La date de début du trajet est calculée par rapport aux variables&#xA;&#x9;&#x9;&#x9;var.debut_distrib - var.delai_dest_santa_house AS date_debut,&#xA;&#x9;&#x9;&#x9;-- La date de fin est fixée dans les variables&#xA;&#x9;&#x9;&#x9;var.debut_distrib AS date_fin,&#xA;&#x9;&#x9;&#x9;-- Trajet effectué&#xA;&#x9;&#x9;&#x9;ST_MakeLine(&#xA;&#x9;&#x9;&#x9;&#x9;ST_Transform(&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;(var.maison_pere_noel -&gt;&gt; &#39;geom_4326&#39;)::geometry(point,4326),&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;3857&#xA;&#x9;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;&#x9;etp.geom_etape&#xA;&#x9;&#x9;&#x9;) AS geom&#x9;&#xA;&#x9;&#x9;FROM &#xA;&#x9;&#x9;&#x9;santa_tracker.v_00_variable AS var&#xA;&#x9;&#x9;LEFT JOIN &#xA;&#x9;&#x9;&#x9;santa_tracker.v_04_etape_distribution AS etp&#xA;&#x9;&#x9;&#x9;ON etp.rang_etape = 1&#xA;&#x9;&#x9;UNION ALL &#xA;&#x9;&#x9;-- Etapes de distribution des cadeaux&#xA;&#x9;&#x9;SELECT &#xA;&#x9;&#x9;&#x9;id_destination,&#xA;&#x9;&#x9;&#x9;region,&#xA;&#x9;&#x9;&#x9;ville,&#xA;&#x9;&#x9;&#x9;id_destination_next,&#xA;&#x9;&#x9;&#x9;region_next,&#xA;&#x9;&#x9;&#x9;ville_next,&#xA;&#x9;&#x9;&#x9;population,&#xA;&#x9;&#x9;&#x9;pop_fictive,&#xA;&#x9;&#x9;&#x9;-- Nombre de cadeau distribué&#xA;&#x9;&#x9;&#x9;round( var.cadeau_par_pop * pop_fictive::numeric, 0) AS cadeau_distribue,&#xA;&#x9;&#x9;&#x9;utc_offset,&#xA;&#x9;&#x9;&#x9;utc_offset_next,&#xA;&#x9;&#x9;&#x9;rang_longitude,&#xA;&#x9;&#x9;&#x9;rang_latitude,&#xA;&#x9;&#x9;&#x9;rang_etape,&#xA;&#x9;&#x9;&#x9;2 AS rang_voyage,&#xA;&#x9;&#x9;&#x9;&#39;Distribution&#39; AS type_etape,&#xA;&#x9;&#x9;&#x9;nb_zone_longitude,&#xA;&#x9;&#x9;&#x9;nb_destination_in_zone,&#xA;&#x9;&#x9;&#x9;duree_destination,&#xA;&#x9;&#x9;&#x9;duree_etape,&#xA;&#x9;&#x9;&#x9;date_debut,&#xA;&#x9;&#x9;&#x9;date_fin,&#xA;&#x9;&#x9;&#x9;geom&#xA;&#x9;&#x9;FROM &#xA;&#x9;&#x9;&#x9;santa_tracker.v_04_etape_distribution&#xA;&#x9;&#x9;CROSS JOIN &#xA;&#x9;&#x9;&#x9;santa_tracker.v_00_variable as var&#xA;&#x9;&#x9;UNION ALL &#xA;&#x9;&#x9;-- Trajets entre les étapes de distribution&#xA;&#x9;&#x9;SELECT &#xA;&#x9;&#x9;&#x9;id_destination,&#xA;&#x9;&#x9;&#x9;region,&#xA;&#x9;&#x9;&#x9;ville,&#xA;&#x9;&#x9;&#x9;id_destination_next,&#xA;&#x9;&#x9;&#x9;region_next,&#xA;&#x9;&#x9;&#x9;ville_next,&#xA;&#x9;&#x9;&#x9;population,&#xA;&#x9;&#x9;&#x9;pop_fictive,&#xA;&#x9;&#x9;&#x9;0 AS cadeau_distribue,&#xA;&#x9;&#x9;&#x9;utc_offset,&#xA;&#x9;&#x9;&#x9;utc_offset_next,&#xA;&#x9;&#x9;&#x9;rang_longitude,&#xA;&#x9;&#x9;&#x9;rang_latitude,&#xA;&#x9;&#x9;&#x9;rang_etape,&#xA;&#x9;&#x9;&#x9;2 AS rang_voyage,&#xA;&#x9;&#x9;&#x9;&#39;Trajet&#39; AS type_etape,&#xA;&#x9;&#x9;&#x9;nb_zone_longitude,&#xA;&#x9;&#x9;&#x9;nb_destination_in_zone,&#xA;&#x9;&#x9;&#x9;duree_destination,&#xA;&#x9;&#x9;&#x9;duree_trajet AS duree_etape,&#xA;&#x9;&#x9;&#x9;date_debut,&#xA;&#x9;&#x9;&#x9;date_fin,&#xA;&#x9;&#x9;&#x9;geom&#xA;&#x9;&#x9;FROM &#xA;&#x9;&#x9;&#x9;santa_tracker.v_05_trajet&#xA;&#x9;&#x9;UNION ALL&#xA;&#x9;&#x9;-- Trajet de la dernière destination à la maison du Père Noël&#xA;&#x9;&#x9;SELECT &#xA;&#x9;&#x9;&#x9;etp.id_destination AS id_destination,&#xA;&#x9;&#x9;&#x9;etp.region AS region,&#xA;&#x9;&#x9;&#x9;etp.ville AS ville,&#xA;&#x9;&#x9;&#x9;(var.maison_pere_noel -&gt;&gt; &#39;id&#39;)::int AS id_destination_next,&#xA;&#x9;&#x9;&#x9;var.maison_pere_noel -&gt;&gt; &#39;region&#39; AS region_next,&#xA;&#x9;&#x9;&#x9;var.maison_pere_noel -&gt;&gt; &#39;ville&#39; AS ville_next,&#xA;&#x9;&#x9;&#x9;-- Il n&#39;y a aucune population lors du vol&#xA;&#x9;&#x9;&#x9;0 AS population,&#xA;&#x9;&#x9;&#x9;0 AS pop_fictive,&#xA;&#x9;&#x9;&#x9;0 AS cadeau_distribue,&#xA;&#x9;&#x9;&#x9;etp.utc_offset AS utc_offset,&#xA;&#x9;&#x9;&#x9;(var.maison_pere_noel -&gt;&gt; &#39;utc_offset&#39;)::interval AS utc_offset_next,&#xA;&#x9;&#x9;&#x9;0 AS rang_longitude,&#xA;&#x9;&#x9;&#x9;0 AS rang_latitude,&#xA;&#x9;&#x9;&#x9;0 AS rang_etape,&#xA;&#x9;&#x9;&#x9;3 AS rang_voyage,&#xA;&#x9;&#x9;&#x9;&#39;Trajet&#39; AS type_etape,&#xA;&#x9;&#x9;&#x9;0 AS nb_zone_longitude,&#xA;&#x9;&#x9;&#x9;0 AS nb_destination_in_zone,&#xA;&#x9;&#x9;&#x9;-- La durée totale pour la destination est uniquement la durée du trajet (pas de distribution)&#xA;&#x9;&#x9;&#x9;var.delai_dest_santa_house AS duree_destination,&#xA;&#x9;&#x9;&#x9;-- La durée du trajet est fixée dans les variables&#xA;&#x9;&#x9;&#x9;var.delai_dest_santa_house AS duree_etape,&#xA;&#x9;&#x9;&#x9;-- La date de début du trajet est calculée par rapport aux variables&#xA;&#x9;&#x9;&#x9;var.fin_distrib AS date_debut,&#xA;&#x9;&#x9;&#x9;-- La date de fin est fixée dans les variables&#xA;&#x9;&#x9;&#x9;var.fin_distrib + var.delai_dest_santa_house AS date_fin,&#xA;&#x9;&#x9;&#x9;-- Trajet effectué&#xA;&#x9;&#x9;&#x9;ST_MakeLine(&#xA;&#x9;&#x9;&#x9;&#x9;etp.geom_etape,&#xA;&#x9;&#x9;&#x9;&#x9;ST_Transform(&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;(var.maison_pere_noel -&gt;&gt; &#39;geom_4326&#39;)::geometry(point,4326),&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;3857&#xA;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;) AS geom&#x9;&#xA;&#x9;&#x9;FROM &#xA;&#x9;&#x9;&#x9;santa_tracker.v_00_variable AS var&#xA;&#x9;&#x9;LEFT JOIN &#xA;&#x9;&#x9;&#x9;santa_tracker.v_04_etape_distribution AS etp&#xA;&#x9;&#x9;&#x9;ON etp.rang_etape = 440&#xA;&#x9;)&#xA;&#x9;SELECT &#xA;&#x9;&#x9;concat_ws(&#xA;&#x9;&#x9;&#x9;&#39;-&#39;,&#xA;&#x9;&#x9;&#x9;rang_voyage::text,&#xA;&#x9;&#x9;&#x9;rang_longitude::text,&#xA;&#x9;&#x9;&#x9;rang_latitude::text,&#xA;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;WHEN type_etape = &#39;Distribution&#39; THEN &#39;d&#39;&#xA;&#x9;&#x9;&#x9;&#x9;ELSE &#39;t&#39;&#xA;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;) AS id_voyage,&#xA;&#x9;&#x9;id_destination,&#xA;&#x9;&#x9;region,&#xA;&#x9;&#x9;ville,&#xA;&#x9;&#x9;id_destination_next,&#xA;&#x9;&#x9;region_next,&#xA;&#x9;&#x9;ville_next,&#xA;&#x9;&#x9;population,&#xA;&#x9;&#x9;pop_fictive,&#xA;&#x9;&#x9;-- Le fenêtrage permet de récupérer le cumul de population visitée&#xA;&#x9;&#x9;coalesce(&#xA;&#x9;&#x9;&#x9;sum(pop_fictive) OVER all_preceding_step,&#xA;&#x9;&#x9;&#x9;0&#xA;&#x9;&#x9;) as pop_fictive_cumul,&#xA;&#x9;&#x9;cadeau_distribue,&#xA;&#x9;&#x9;-- Le fenêtrage permet de récupérer le cumul de population visitée&#xA;&#x9;&#x9;coalesce(&#xA;&#x9;&#x9;&#x9;sum(cadeau_distribue) OVER all_preceding_step,&#xA;&#x9;&#x9;&#x9;0&#xA;&#x9;&#x9;) as cadeau_distribue_cumul,&#xA;&#x9;&#x9;utc_offset,&#xA;&#x9;&#x9;utc_offset_next,&#xA;&#x9;&#x9;rang_longitude,&#xA;&#x9;&#x9;rang_latitude,&#xA;&#x9;&#x9;rang_etape,&#xA;&#x9;&#x9;rang_voyage,&#xA;&#x9;&#x9;type_etape,&#xA;&#x9;&#x9;nb_zone_longitude,&#xA;&#x9;&#x9;nb_destination_in_zone,&#xA;&#x9;&#x9;duree_destination,&#xA;&#x9;&#x9;duree_etape,&#xA;&#x9;&#x9;-- Le fenêtrage permet de récupérer le cumul de temps de voyage&#xA;&#x9;&#x9;coalesce(&#xA;&#x9;&#x9;&#x9;sum(duree_etape) OVER all_preceding_step,&#xA;&#x9;&#x9;&#x9;&#39;0 second&#39;::interval&#xA;&#x9;&#x9;) as duree_etape_cumul,&#xA;&#x9;&#x9;date_debut,&#xA;&#x9;&#x9;date_fin,&#xA;&#x9;&#x9;-- Distance parcourue durant le trajet&#xA;&#x9;&#x9;round(&#xA;&#x9;&#x9;&#x9;ST_Length(geom)::NUMERIC,&#xA;&#x9;&#x9;&#x9;0&#xA;&#x9;&#x9;) as distance_to_next,&#xA;&#x9;&#x9;-- Le fenêtrage permet de récupérer le cumul de distance parcourue&#xA;&#x9;&#x9;coalesce(&#xA;&#x9;&#x9;&#x9;round(&#xA;&#x9;&#x9;&#x9;&#x9;(sum(ST_Length(geom)) OVER all_preceding_step)::NUMERIC,&#xA;&#x9;&#x9;&#x9;&#x9;0&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;0&#xA;&#x9;&#x9;) as distance_cumul,&#xA;&#x9;&#x9;-- Azimuth du symbole sur la carte&#xA;&#x9;&#x9;Degrees(ST_Azimuth(ST_StartPoint(geom),ST_EndPoint(geom))) as azimuth,&#xA;&#x9;&#x9;-- Orientation du symbole sur la carte&#xA;&#x9;&#x9;CASE &#xA;&#x9;&#x9;&#x9;WHEN Degrees(ST_Azimuth(ST_StartPoint(geom),ST_EndPoint(geom))) &amp;lt; 180 THEN &#39;Est&#39; &#xA;&#x9;&#x9;&#x9;ELSE &#39;Ouest&#39;&#xA;&#x9;&#x9;END as orientation,&#xA;&#x9;&#x9;geom::geometry(linestring,3857)&#xA;&#x9;FROM &#xA;&#x9;&#x9;all_steps&#xA;&#x9;WINDOW &#xA;&#x9;&#x9;all_preceding_step AS (&#xA;&#x9;&#x9;&#x9;ORDER BY &#xA;&#x9;&#x9;&#x9;&#x9;rang_voyage,&#xA;&#x9;&#x9;&#x9;&#x9;rang_etape,&#xA;&#x9;&#x9;&#x9;&#x9;type_etape&#xA;&#x9;&#x9;&#x9;ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING&#xA;&#x9;&#x9;)&#xA;&#xA;)&#xA;;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;On fixe ensuite les données du voyage dans une vue matérialisée pour améliorer les performance lors de la consultation :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;DROP MATERIALIZED VIEW IF EXISTS santa_tracker.vm_06_voyage CASCADE;&#xA;&#xA;CREATE MATERIALIZED VIEW santa_tracker.vm_06_voyage as (&#xA;&#x9;SELECT * &#xA;&#x9;FROM santa_tracker.v_06_voyage&#xA;)&#xA;WITH DATA&#xA;;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 class=&#34;wp-block-heading&#34;&gt;L&#39; »instant t »&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Avoir un trajet c&amp;rsquo;est bien mais connaitre toutes les infos sur le trajet à un « instant t », c&amp;rsquo;est mieux.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Données&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Nous allons créer une nouvelle vue qui va se baser sur la vue matérialisée &lt;code&gt;vm_06_voyage&lt;/code&gt; pour calculer la position du Père Noël et divers les paramètres au moment de la consultation de cette vue.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Cette vue définies trois grands temps dans l&amp;rsquo;année :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;ul class=&#34;wp-block-list&#34;&gt;&#xA;&lt;li&gt;Du 1er janvier au 24 décembre : le Père Noël se trouve chez lui et fabrique les cadeaux&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;Du 24 au 25 décembre : le Père Noël distribue les cadeaux selon les données présentes dans la vue matérialisée &lt;code&gt;vm_06_voyage&lt;/code&gt;.&lt;/li&gt;&#xA;&#xA;&#xA;&#xA;&lt;li&gt;A partir du 25 décembre : le Père Noël se repose chez lui après tout ce travail.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;&#xA;&#xA;&#xA;DROP VIEW IF EXISTS santa_tracker.v_instant_t CASCADE;&#xA;&#xA;CREATE OR REPLACE VIEW santa_tracker.v_instant_t as (&#xA;&#xA;WITH &#xA;&#x9;voyage_instant_t as (&#xA;&#x9;&#x9;-- Etape de préparation des cadeaux&#xA;&#x9;&#x9;-- Cette étape sera visible du 1er janvier au début de la tournée&#xA;&#x9;&#x9;SELECT &#xA;&#x9;&#x9;&#x9;&#39;Préparatifs&#39; as type_trajet,&#xA;&#x9;&#x9;&#x9;&#39;0-0-0-p&#39; AS id_voyage,&#xA;&#x9;&#x9;&#x9;(var.maison_pere_noel -&gt;&gt; &#39;id&#39;)::int AS id_destination,&#xA;&#x9;&#x9;&#x9;NULL AS id_destination_next,&#xA;&#x9;&#x9;&#x9;var.maison_pere_noel -&gt;&gt; &#39;region&#39; AS region,&#xA;&#x9;&#x9;&#x9;NULL as region_next,&#xA;&#x9;&#x9;&#x9;var.maison_pere_noel -&gt;&gt; &#39;ville&#39; AS ville,&#xA;&#x9;&#x9;&#x9;NULL as ville_next,&#xA;&#x9;&#x9;&#x9;(var.maison_pere_noel -&gt;&gt; &#39;population&#39;)::integer AS population,&#xA;&#x9;&#x9;&#x9;NULL as pop_fictive,&#xA;&#x9;&#x9;&#x9;NULL as pop_fictive_cumul,&#xA;&#x9;&#x9;&#x9;-- Nombre total de cadeau total à fabriquer&#xA;&#x9;&#x9;&#x9;(var.pop_total * var.cadeau_par_pop) as cadeau_distribue,&#xA;&#x9;&#x9;&#x9;0 as cadeau_distribue_cumul,&#xA;&#x9;&#x9;&#x9;(var.maison_pere_noel -&gt;&gt; &#39;utc_offset&#39;)::interval AS utc_offset,&#xA;&#x9;&#x9;&#x9;NULL AS utc_offset_next,&#xA;&#x9;&#x9;&#x9;((extract(year from now()) || &#39;-01-01 00:00:00 +01&#39;)::timestamp with time ZONE - var.debut_distrib)::interval as duree_etape,&#xA;&#x9;&#x9;&#x9;&#39;0 second&#39;::interval as duree_etape_cumul,&#xA;&#x9;&#x9;&#x9;-- Début de fabrication le 1er janvier (fuseau horaire du Père Noël)&#xA;&#x9;&#x9;&#x9;(extract(year from now()) || &#39;-01-01 00:00:00 +01&#39;)::timestamp with time zone as date_debut,&#xA;&#x9;&#x9;&#x9;-- Fin de fabrication lors du début de la distribution&#xA;&#x9;&#x9;&#x9;var.debut_distrib as date_fin,&#xA;&#x9;&#x9;&#x9;-- Calcul du pourcentage d&#39;avancement sur l&#39;étape&#xA;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;extract(&#39;epoch&#39; from var.&#34;now&#34;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;- extract(&#39;epoch&#39; from ((extract(year from now()) || &#39;-01-01 00:00:00 +01&#39;)::timestamp with time zone))&#xA;&#x9;&#x9;&#x9;&#x9;) / (&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;extract(&#39;epoch&#39; from var.debut_distrib)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;- extract(&#39;epoch&#39; from ((extract(year from now()) || &#39;-01-01 00:00:00 +01&#39;)::timestamp with time zone))&#xA;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;)::NUMERIC as avancement,&#xA;&#x9;&#x9;&#x9;NULL as distance_to_next,&#xA;&#x9;&#x9;&#x9;NULL as distance_cumul,&#xA;&#x9;&#x9;&#x9;0 AS azimuth,&#xA;&#x9;&#x9;&#x9;NULL AS orientation,&#xA;&#x9;&#x9;&#x9;ST_MakeLine(&#xA;&#x9;&#x9;&#x9;&#x9;ST_Transform(&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;(var.maison_pere_noel -&gt;&gt; &#39;geom_4326&#39;)::geometry(point,4326), &#xA;&#x9;&#x9;&#x9;&#x9;&#x9;3857&#xA;&#x9;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;&#x9;ST_Transform(&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;(var.maison_pere_noel -&gt;&gt; &#39;geom_4326&#39;)::geometry(point,4326),&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;3857&#xA;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;) as geom &#xA;&#x9;&#x9;FROM &#xA;&#x9;&#x9;&#x9;santa_tracker.v_00_variable as var&#xA;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;var.&#34;now&#34; &amp;lt; (var.debut_distrib - var.delai_dest_santa_house)&#xA;&#x9;&#x9;UNION ALL&#xA;&#x9;&#x9;-- Récupération des étapes du voyage&#xA;&#x9;&#x9;SELECT &#xA;&#x9;&#x9;&#x9;type_etape,&#xA;&#x9;&#x9;&#x9;id_voyage,&#xA;&#x9;&#x9;&#x9;id_destination,&#xA;&#x9;&#x9;&#x9;id_destination_next,&#xA;&#x9;&#x9;&#x9;region,&#xA;&#x9;&#x9;&#x9;region_next,&#xA;&#x9;&#x9;&#x9;ville,&#xA;&#x9;&#x9;&#x9;ville_next,&#xA;&#x9;&#x9;&#x9;population,&#xA;&#x9;&#x9;&#x9;pop_fictive,&#xA;&#x9;&#x9;&#x9;pop_fictive_cumul,&#xA;&#x9;&#x9;&#x9;cadeau_distribue,&#xA;&#x9;&#x9;&#x9;cadeau_distribue_cumul,&#xA;&#x9;&#x9;&#x9;utc_offset,&#xA;&#x9;&#x9;&#x9;utc_offset_next,&#xA;&#x9;&#x9;&#x9;duree_etape,&#xA;&#x9;&#x9;&#x9;duree_etape_cumul,&#xA;&#x9;&#x9;&#x9;date_debut,&#xA;&#x9;&#x9;&#x9;date_fin,&#xA;&#x9;&#x9;&#x9;-- Calcul du pourcentage d&#39;avancement sur l&#39;étape&#xA;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;extract(&#39;epoch&#39; from var.&#34;now&#34;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;- extract(&#39;epoch&#39; from date_debut)&#xA;&#x9;&#x9;&#x9;&#x9;) / (&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;extract(&#39;epoch&#39; from date_fin)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;- extract(&#39;epoch&#39; from date_debut)&#xA;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;)::NUMERIC as avancement,&#xA;&#x9;&#x9;&#x9;distance_to_next,&#xA;&#x9;&#x9;&#x9;distance_cumul,&#xA;&#x9;&#x9;&#x9;azimuth,&#xA;&#x9;&#x9;&#x9;orientation,&#xA;&#x9;&#x9;&#x9;geom &#xA;&#x9;&#x9;FROM &#xA;&#x9;&#x9;&#x9;santa_tracker.vm_06_voyage as t&#xA;&#x9;&#x9;CROSS JOIN &#xA;&#x9;&#x9;&#x9;santa_tracker.v_00_variable as var&#xA;&#x9;&#x9;WHERE &#xA;&#x9;&#x9;&#x9;var.&#34;now&#34; &gt;= date_debut&#xA;&#x9;&#x9;AND &#xA;&#x9;&#x9;&#x9;var.&#34;now&#34; &amp;lt; date_fin&#xA;&#x9;&#x9;UNION ALL&#xA;&#x9;&#x9;-- Ajout d&#39;une étape de repos&#xA;&#x9;&#x9;-- Cette étape sera visible après la fin de la tournée &#xA;&#x9;&#x9;SELECT &#xA;&#x9;&#x9;&#x9;&#39;Repos&#39; as type_trajet,&#xA;&#x9;&#x9;&#x9;&#39;0-0-0-r&#39; AS id_voyage,&#xA;&#x9;&#x9;&#x9;(var.maison_pere_noel -&gt;&gt; &#39;id&#39;)::int AS id_destination,&#xA;&#x9;&#x9;&#x9;NULL AS id_destination_next,&#xA;&#x9;&#x9;&#x9;var.maison_pere_noel -&gt;&gt; &#39;region&#39; AS region,&#xA;&#x9;&#x9;&#x9;NULL as region_next,&#xA;&#x9;&#x9;&#x9;var.maison_pere_noel -&gt;&gt; &#39;ville&#39; AS ville,&#xA;&#x9;&#x9;&#x9;NULL as ville_next,&#xA;&#x9;&#x9;&#x9;(var.maison_pere_noel -&gt;&gt; &#39;population&#39;)::integer AS population,&#xA;&#x9;&#x9;&#x9;NULL as pop_fictive,&#xA;&#x9;&#x9;&#x9;var.pop_total as pop_fictive_cumul,&#xA;&#x9;&#x9;&#x9;(var.pop_total * var.cadeau_par_pop) as cadeau_distribue,&#xA;&#x9;&#x9;&#x9;(var.pop_total * var.cadeau_par_pop) as cadeau_distribue_cumul,&#xA;&#x9;&#x9;&#x9;(var.maison_pere_noel -&gt;&gt; &#39;utc_offset&#39;)::interval AS utc_offset,&#xA;&#x9;&#x9;&#x9;NULL AS utc_offset_next,&#xA;&#x9;&#x9;&#x9;((extract(year from now()) || &#39;-12-31 23:59:59 +01&#39;)::timestamp with time ZONE - var.fin_distrib)::interval as duree_etape,&#xA;&#x9;&#x9;&#x9;&#39;0 second&#39;::interval as duree_etape_cumul,&#xA;&#x9;&#x9;&#x9;-- Début du repos à la fin de la distribution&#xA;&#x9;&#x9;&#x9;var.fin_distrib as date_debut,&#xA;&#x9;&#x9;&#x9;-- Fin du repos le 1er janvier à 00h00 (fuseau horaire du Père Noël)&#xA;&#x9;&#x9;&#x9;((extract(year from now()) + 1)::text || &#39;-01-01 00:00:00 +01&#39;)::timestamp with time zone as date_fin,&#xA;&#x9;&#x9;&#x9;-- Calcul du pourcentage d&#39;avancement sur l&#39;étape&#xA;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;extract(&#39;epoch&#39; from var.&#34;now&#34;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;- extract(&#39;epoch&#39; from var.fin_distrib)&#xA;&#x9;&#x9;&#x9;&#x9;) / (&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;extract(&#39;epoch&#39; from var.fin_distrib)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;- extract(&#39;epoch&#39; from ((extract(year from now()) || &#39;-01-01 00:00:00 +01&#39;)::timestamp with time zone))&#xA;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;)::NUMERIC as avancement,&#xA;&#x9;&#x9;&#x9;NULL as distance_to_next,&#xA;&#x9;&#x9;&#x9;NULL as distance_cumul,&#xA;&#x9;&#x9;&#x9;0 AS azimuth,&#xA;&#x9;&#x9;&#x9;NULL AS orientation,&#xA;&#x9;&#x9;&#x9;ST_MakeLine(&#xA;&#x9;&#x9;&#x9;&#x9;ST_Transform(&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;(var.maison_pere_noel -&gt;&gt; &#39;geom_4326&#39;)::geometry(point,4326), &#xA;&#x9;&#x9;&#x9;&#x9;&#x9;3857&#xA;&#x9;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;&#x9;ST_Transform(&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;(var.maison_pere_noel -&gt;&gt; &#39;geom_4326&#39;)::geometry(point,4326),&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;3857&#xA;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;) as geom &#xA;&#x9;&#x9;FROM &#xA;&#x9;&#x9;&#x9;santa_tracker.v_00_variable as var&#xA;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;var.&#34;now&#34; &gt; (var.fin_distrib + var.delai_dest_santa_house)&#xA;&#x9;)&#xA;SELECT &#xA;&#x9;type_trajet,&#xA;&#x9;id_voyage,&#xA;&#x9;id_destination,&#xA;&#x9;id_destination_next,&#xA;&#x9;region,&#xA;&#x9;region_next,&#xA;&#x9;ville,&#xA;&#x9;ville_next,&#xA;&#x9;population,&#xA;&#x9;pop_fictive,&#xA;&#x9;pop_fictive_cumul,&#xA;&#x9;-- Calcul du nombre de personnes visitées au moment de la visualisation&#xA;&#x9;round(&#xA;&#x9;&#x9;pop_fictive_cumul + &#xA;&#x9;&#x9;(pop_fictive * avancement)::numeric,&#xA;&#x9;&#x9;0&#xA;&#x9;) as pop_fictive_cumul_actuel,&#xA;&#x9;cadeau_distribue,&#xA;&#x9;cadeau_distribue_cumul,&#xA;&#x9;-- Calcul du nombre de cadeau distribué au moment de la visualisation&#xA;&#x9;round(&#xA;&#x9;&#x9;cadeau_distribue_cumul + &#xA;&#x9;&#x9;(cadeau_distribue * avancement)::numeric,&#xA;&#x9;&#x9;0&#xA;&#x9;) as cadeau_cumul_actuel,&#xA;&#x9;utc_offset,&#xA;&#x9;utc_offset_next,&#xA;&#x9;duree_etape,&#xA;&#x9;date_debut,&#xA;&#x9;date_fin,&#xA;&#x9;avancement,&#xA;&#x9;distance_to_next,&#xA;&#x9;distance_cumul,&#xA;&#x9;-- Calcul de la distance parcourue au moment de la visualisation&#xA;&#x9;round(&#xA;&#x9;&#x9;distance_cumul + &#xA;&#x9;&#x9;(distance_to_next * avancement)::numeric,&#xA;&#x9;&#x9;0&#xA;&#x9;) as distance_cumul_actuel,&#xA;&#x9;azimuth,&#xA;&#x9;orientation,&#xA;&#x9;-- Calcul de l&#39;emplacement au moment de la visualisation&#xA;&#x9;ST_LineInterpolatePoint(geom, avancement)::geometry(point,3857) as geom&#xA;FROM &#xA;&#x9;voyage_instant_t&#xA;&#xA;)&#xA;;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 class=&#34;wp-block-heading&#34;&gt;Affichage&lt;/h3&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Selon le moment de l&amp;rsquo;année, nous n&amp;rsquo;allons pas afficher les mêmes données. Dans le cadre de l&amp;rsquo;application, j&amp;rsquo;ai mis en forme les données avec beaucoup de HTML, c&amp;rsquo;est peu lisible et nous allons donc ici générer quelque chose de beaucoup plus simple mais avec les mêmes informations.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Créons une vue qui récupère les données et les mets en forme :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;DROP VIEW IF EXISTS santa_tracker.v_instant_t_affichage CASCADE;&#xA;&#xA;CREATE OR REPLACE VIEW santa_tracker.v_instant_t_affichage as (&#xA;&#xA;SELECT &#xA;&#x9;id_voyage,&#xA;&#x9;type_trajet,&#xA;&#x9;-- On génère des paroles du Père Noël.&#xA;&#x9;-- Le texte varie selon le moment de l&#39;année et change toutes les 10 secondes&#xA;&#x9;jsonb_extract_path_text(&#xA;&#x9;&#x9;$${&#xA;&#x9;&#x9;&#x9;&#34;Préparatifs&#34;:[&#xA;&#x9;&#x9;&#x9;&#x9;&#34;Vive le vent d&#34;,&#34;hiver !&#34;,&#xA;&#x9;&#x9;&#x9;&#x9;&#34;Et un cadeau de plus !&#34;,&#xA;&#x9;&#x9;&#x9;&#x9;&#34;Hum ?!&#34;,&#xA;&#x9;&#x9;&#x9;&#x9;&#34;Quel beau camion !&#34;,&#xA;&#x9;&#x9;&#x9;&#x9;&#34;Ah, une belle poupée !&#34;,&#xA;&#x9;&#x9;&#x9;&#x9;&#34;Oh Oh Oh !&#34;&#xA;&#x9;&#x9;&#x9;],&#xA;&#x9;&#x9;&#x9;&#34;Trajet&#34;:[&#xA;&#x9;&#x9;&#x9;&#x9;&#34;Oh Oh Oh !&#34;,&#xA;&#x9;&#x9;&#x9;&#x9;&#34;Joyeux Noël !&#34;,&#xA;&#x9;&#x9;&#x9;&#x9;&#34;Mon beau sapin !&#34;,&#xA;&#x9;&#x9;&#x9;&#x9;&#34;Hue tornade !&#34;,&#xA;&#x9;&#x9;&#x9;&#x9;&#34;Allez comète !&#34;,&#xA;&#x9;&#x9;&#x9;&#x9;&#34;Il fait frais cette nuit !&#34;&#xA;&#x9;&#x9;&#x9;],&#xA;&#x9;&#x9;&#x9;&#34;Distribution&#34;:[&#xA;&#x9;&#x9;&#x9;&#x9;&#34;Oh hisse !&#34;,&#xA;&#x9;&#x9;&#x9;&#x9;&#34;Serrée cette cheminée !&#34;,&#xA;&#x9;&#x9;&#x9;&#x9;&#34;Et un cadeau de plus !&#34;,&#xA;&#x9;&#x9;&#x9;&#x9;&#34;Chut, pas un bruit !&#34;,&#xA;&#x9;&#x9;&#x9;&#x9;&#34;Hum un petit biscuit...&#34;,&#xA;&#x9;&#x9;&#x9;&#x9;&#34;Oh Oh Oh !&#34;&#xA;&#x9;&#x9;&#x9;],&#xA;&#x9;&#x9;&#x9;&#34;Repos&#34;:[&#xA;&#x9;&#x9;&#x9;&#x9;&#34;ZZZ&#34;,&#xA;&#x9;&#x9;&#x9;&#x9;&#34;ZZZ ZZZ&#34;,&#xA;&#x9;&#x9;&#x9;&#x9;&#34;ZZZ&#34;,&#xA;&#x9;&#x9;&#x9;&#x9;&#34;ZZZ ZZZ&#34;,&#xA;&#x9;&#x9;&#x9;&#x9;&#34;ZZZ&#34;,&#xA;&#x9;&#x9;&#x9;&#x9;&#34;RONFFFFFFFLE&#34;&#xA;&#x9;&#x9;&#x9;]&#xA;&#x9;&#x9;}$$::jsonb,&#xA;&#x9;&#x9;type_trajet,&#xA;&#x9;&#x9;FLOOR(EXTRACT(second from transaction_timestamp()) / 10)::text&#xA;&#x9;) as parole,&#xA;&#x9;CASE &#xA;&#x9;&#x9;WHEN type_trajet = &#39;Préparatifs&#39; THEN &#39;Le Père Noël prépare les cadeaux&#39;&#xA;&#x9;&#x9;WHEN type_trajet = &#39;Trajet&#39; THEN &#39;Le Père Noël voyage vers un nouveau lieu de distribution&#39;&#xA;&#x9;&#x9;WHEN type_trajet = &#39;Distribution&#39; THEN &#39;Le Père Noël est en cours de distribution&#39;&#xA;&#x9;&#x9;WHEN type_trajet = &#39;Repos&#39; THEN &#39;Le Père Noël a terminé et prend un repos bien mérité&#39;&#xA;&#x9;END AS titre,&#xA;&#x9;ville || &#39; (&#39; || region || &#39;)&#39; AS ville,&#xA;&#x9;ville_next || &#39; (&#39; || region_next || &#39;)&#39; AS ville_next,&#xA;&#x9;concat(&#xA;&#x9;&#x9;NULLIF(extract(day from (date_fin - var.&#34;now&#34;)), 0) || &#39; jours, &#39;,&#xA;&#x9;&#x9;NULLIF(extract(hour from (date_fin - var.&#34;now&#34;)), 0) || &#39; heures, &#39;,&#xA;&#x9;&#x9;NULLIF(extract(minute from (date_fin - var.&#34;now&#34;)), 0) || &#39; minutes et &#39;,&#xA;&#x9;&#x9;NULLIF(round(extract(second from (date_fin - var.&#34;now&#34;))::numeric, 0), 0) || &#39; secondes&#39;&#xA;&#x9;) AS timer,&#xA;&#x9;to_char(date_debut,&#39;DD TMmon YYYY&#39;) AS date_debut,&#xA;&#x9;to_char(date_debut,&#39;HH24:MI:SS&#39;) AS heure_debut,&#xA;&#x9;to_char(date_debut AT TIME ZONE utc_offset,&#39;DD TMmon YYYY&#39;) AS date_debut_local,&#xA;&#x9;to_char(date_debut AT TIME ZONE utc_offset,&#39;HH24:MI:SS&#39;) AS heure_debut_local,&#xA;&#x9;to_char(date_fin,&#39;DD TMmon YYYY&#39;) AS date_fin,&#xA;&#x9;to_char(date_fin,&#39;HH24:MI:SS&#39;) AS heure_fin,&#xA;&#x9;to_char(date_fin AT TIME ZONE utc_offset,&#39;DD TMmon YYYY&#39;) AS date_fin_local,&#xA;&#x9;to_char(date_fin AT TIME ZONE utc_offset,&#39;HH24:MI:SS&#39;) AS heure_fin_local,&#xA;&#x9;trim(to_char(cadeau_cumul_actuel, &#39;999 999 999 999&#39;)) AS cadeau,&#xA;&#x9;trim(to_char(pop_fictive_cumul_actuel, &#39;999 999 999 999&#39;)) AS population,&#xA;&#x9;trim(to_char(distance_cumul_actuel/1000, &#39;999 999 999 999 km&#39;)) AS distance&#xA;FROM&#xA;&#x9;santa_tracker.v_instant_t&#xA;CROSS JOIN&#xA;&#x9;santa_tracker.v_00_variable as var &#xA;&#x9;&#xA;)&#xA;;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Il est maintenant possible d&amp;rsquo;appeler la vue avec un SELECT qui finalise la mise en forme. N&amp;rsquo;hésitez pas à utiliser du HTML.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;SELECT &#xA;&#x9;id_voyage,&#xA;&#x9;CASE &#xA;&#x9;&#x9;WHEN type_trajet = &#39;Préparatifs&#39; THEN &#xA;&#x9;&#x9;&#x9;concat_ws(&#xA;&#x9;&#x9;&#x9;&#x9;chr(10),&#xA;&#x9;&#x9;&#x9;&#x9;titre,&#xA;&#x9;&#x9;&#x9;&#x9;&#39;Petit mot du Père Noël : &#39; || parole,&#xA;&#x9;&#x9;&#x9;&#x9;&#39;Emplacement actuel : &#39; || ville ,&#xA;&#x9;&#x9;&#x9;&#x9;&#39;Départ prévu dans &#39; || timer,&#xA;&#x9;&#x9;&#x9;&#x9;&#39;&#x9;le &#39; || date_fin || &#39; à &#39; || heure_fin,&#xA;&#x9;&#x9;&#x9;&#x9;&#39;Cadeaux fabriqués : &#39; || cadeau&#xA;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;WHEN type_trajet = &#39;Trajet&#39; THEN&#xA;&#x9;&#x9;&#x9;concat_ws(&#xA;&#x9;&#x9;&#x9;&#x9;chr(10),&#xA;&#x9;&#x9;&#x9;&#x9;titre,&#xA;&#x9;&#x9;&#x9;&#x9;&#39;Petit mot du Père Noël : &#39; || parole,&#xA;&#x9;&#x9;&#x9;&#x9;&#39;Décollage : &#39; || ville ,&#xA;&#x9;&#x9;&#x9;&#x9;&#39;&#x9;le &#39; || date_debut || &#39; à &#39; || heure_debut,&#xA;&#x9;&#x9;&#x9;&#x9;&#39;&#x9;(&#39; || date_debut_local || &#39; à &#39; || heure_debut_local || &#39; heure locale)&#39;,&#xA;&#x9;&#x9;&#x9;&#x9;&#39;Arrivée prévue dans &#39; || timer,&#xA;&#x9;&#x9;&#x9;&#x9;&#39;Atterissage : &#39; || ville_next ,&#xA;&#x9;&#x9;&#x9;&#x9;&#39;&#x9;le &#39; || date_fin || &#39; à &#39; || heure_fin,&#xA;&#x9;&#x9;&#x9;&#x9;&#39;&#x9;(&#39; || date_fin_local || &#39; à &#39; || heure_fin_local || &#39; heure locale)&#39;,&#xA;&#x9;&#x9;&#x9;&#x9;&#39;Cadeaux distribués : &#39; || cadeau,&#xA;&#x9;&#x9;&#x9;&#x9;&#39;Population visitée : &#39; || population,&#xA;&#x9;&#x9;&#x9;&#x9;&#39;Distance parcourue : &#39; || distance&#xA;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;WHEN type_trajet = &#39;Distribution&#39; THEN&#xA;&#x9;&#x9;&#x9;concat_ws(&#xA;&#x9;&#x9;&#x9;&#x9;chr(10),&#xA;&#x9;&#x9;&#x9;&#x9;titre,&#xA;&#x9;&#x9;&#x9;&#x9;&#39;Petit mot du Père Noël : &#39; || parole,&#xA;&#x9;&#x9;&#x9;&#x9;&#39;Emplacement actuel : &#39; || ville ,&#xA;&#x9;&#x9;&#x9;&#x9;&#39;Arrivé sur place le &#39; || date_debut || &#39; à &#39; || heure_debut,&#xA;&#x9;&#x9;&#x9;&#x9;&#39;&#x9;(&#39; || date_debut_local || &#39; à &#39; || heure_debut_local || &#39; heure locale)&#39;,&#xA;&#x9;&#x9;&#x9;&#x9;&#39;Prochain départ le &#39; || date_fin || &#39; à &#39; || heure_fin,&#xA;&#x9;&#x9;&#x9;&#x9;&#39;&#x9;(&#39; || date_fin_local || &#39; à &#39; || heure_fin_local || &#39; heure locale)&#39;,&#xA;&#x9;&#x9;&#x9;&#x9;&#39;Dans &#39; || timer,&#xA;&#x9;&#x9;&#x9;&#x9;&#39;Prochaine destination : &#39; || ville_next ,&#xA;&#x9;&#x9;&#x9;&#x9;&#39;Cadeaux distribués : &#39; || cadeau,&#xA;&#x9;&#x9;&#x9;&#x9;&#39;Population visitée : &#39; || population,&#xA;&#x9;&#x9;&#x9;&#x9;&#39;Distance parcourue : &#39; || distance&#xA;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;WHEN type_trajet = &#39;Repos&#39; THEN&#xA;&#x9;&#x9;&#x9;concat_ws(&#xA;&#x9;&#x9;&#x9;&#x9;chr(10),&#xA;&#x9;&#x9;&#x9;&#x9;titre,&#xA;&#x9;&#x9;&#x9;&#x9;&#39;Petit mot du Père Noël : &#39; || parole,&#xA;&#x9;&#x9;&#x9;&#x9;&#39;Emplacement actuel : &#39; || ville ,&#xA;&#x9;&#x9;&#x9;&#x9;&#39;Prochaine fabrication de cadeau dans &#39; || timer,&#xA;&#x9;&#x9;&#x9;&#x9;&#39;Le &#39; || date_fin || &#39; à &#39; || heure_fin,&#xA;&#x9;&#x9;&#x9;&#x9;&#39;Cadeaux distribués : &#39; || cadeau,&#xA;&#x9;&#x9;&#x9;&#x9;&#39;Population visitée : &#39; || population&#xA;&#x9;&#x9;&#x9;)&#xA;&#x9;END as informations&#xA;FROM&#xA;&#x9;santa_tracker.v_instant_t_affichage&#xA;;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Voila un exemple de réponse :&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-columns is-layout-flex wp-container-core-columns-is-layout-9d6595d7 wp-block-columns-is-layout-flex&#34;&gt;&#xA;&lt;div class=&#34;wp-block-column is-layout-flow wp-block-column-is-layout-flow&#34;&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-column is-layout-flow wp-block-column-is-layout-flow&#34;&gt;&#xA;&lt;p class=&#34;has-text-align-center&#34;&gt;&lt;strong&gt;Le Père Noël est en cours de distribution&lt;/strong&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Petit mot du Père Noël : Oh hisse !&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Emplacement actuel : Anadyr (Russie)&lt;br&gt;Arrivé sur place le 24 déc. 2023 à 08:00:00&lt;br&gt;(24 déc. 2023 à 19:00:00 heure locale)&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Prochaine destination : Majuro Atoll (Îles Marshall)&lt;br&gt;Départ dans 36 secondes&lt;br&gt;Le 24 déc. 2023 à 08:00:37&lt;br&gt;(24 déc. 2023 à 19:00:37 heure locale)&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Cadeaux distribués : 7 222&lt;br&gt;Population visitée : 7 602&lt;br&gt;Distance parcourue : 18 108 km&lt;/p&gt;&#xA;&lt;/div&gt;&#xA;&#xA;&#xA;&#xA;&lt;div class=&#34;wp-block-column is-layout-flow wp-block-column-is-layout-flow&#34;&gt;&lt;/div&gt;&#xA;&lt;/div&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 class=&#34;wp-block-heading&#34;&gt;L&amp;rsquo;état des lieux&lt;/h2&gt;&#xA;&#xA;&#xA;&#xA;&lt;p&gt;Pour chaque destination, il est possible de voir en temps réel si le Père Noël est passé ou non. Pour cela nous allons nous appuyer sur la table des destinations ainsi que la vue matérialisée &lt;code&gt;vm_06_voyage&lt;/code&gt;.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;pre class=&#34;EnlighterJSRAW&#34; data-enlighter-language=&#34;sql&#34; data-enlighter-theme=&#34;&#34; data-enlighter-highlight=&#34;&#34; data-enlighter-linenumbers=&#34;&#34; data-enlighter-lineoffset=&#34;&#34; data-enlighter-title=&#34;&#34; data-enlighter-group=&#34;&#34;&gt;-- Vue contenant toutes les destinations&#xA;DROP VIEW IF EXISTS santa_tracker.v_destination CASCADE;&#xA;&#xA;CREATE OR REPLACE VIEW santa_tracker.v_destination AS &#xA;&#xA;WITH &#xA;&#x9;all_destinations AS (&#xA;&#x9;&#x9;-- Récupération de toutes les destinations&#xA;&#x9;&#x9;SELECT &#xA;&#x9;&#x9;&#x9;id_destination,&#xA;&#x9;&#x9;&#x9;region,&#xA;&#x9;&#x9;&#x9;ville,&#xA;&#x9;&#x9;&#x9;population,&#xA;&#x9;&#x9;&#x9;utc_offset,&#xA;&#x9;&#x9;&#x9;geom&#xA;&#x9;&#x9;FROM &#xA;&#x9;&#x9;&#x9;santa_tracker.destination&#xA;&#x9;&#x9;UNION&#xA;&#x9;&#x9;-- Ajout de la maison du Père Noël&#xA;&#x9;&#x9;SELECT &#xA;&#x9;&#x9;&#x9;(maison_pere_noel -&gt;&gt; &#39;id&#39;)::integer AS id_destination,&#xA;&#x9;&#x9;&#x9;maison_pere_noel -&gt;&gt; &#39;region&#39; AS region,&#xA;&#x9;&#x9;&#x9;maison_pere_noel -&gt;&gt; &#39;ville&#39; AS ville,&#xA;&#x9;&#x9;&#x9;(maison_pere_noel -&gt;&gt; &#39;population&#39;)::integer AS population,&#xA;&#x9;&#x9;&#x9;(maison_pere_noel -&gt;&gt; &#39;utc_offset&#39;)::interval AS utc_offset,&#xA;&#x9;&#x9;&#x9;(maison_pere_noel -&gt;&gt; &#39;geom_4326&#39;)::geometry(Point,4326) AS geom&#xA;&#x9;&#x9;FROM &#xA;&#x9;&#x9;&#x9;santa_tracker.v_00_variable&#xA;&#x9;)&#xA;&#x9;SELECT &#xA;&#x9;&#x9;t1.id_destination,&#xA;&#x9;&#x9;t1.region,&#xA;&#x9;&#x9;t1.ville,&#xA;&#x9;&#x9;t1.population,&#xA;&#x9;&#x9;t1.utc_offset,&#xA;&#x9;&#x9;-- Génération d&#39;un message d&#39;information sur l&#39;état de passage&#xA;&#x9;&#x9;CASE &#xA;&#x9;&#x9;&#x9;-- S&#39;il n&#39;y a pas de date de début (pas de distribution) alors il s&#39;agit de la maison du Père Noël&#xA;&#x9;&#x9;&#x9;WHEN voy.date_debut IS NULL THEN &#xA;&#x9;&#x9;&#x9;&#x9;CASE &#xA;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN var.&#34;now&#34; &amp;lt; var.debut_distrib THEN &#39;Le Père Noël prépare les cadeaux&#39;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN var.&#34;now&#34; &amp;lt; var.fin_distrib THEN &#39;Le Père Noël est absent&#39;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE &#39;Le Père Noël se repose&#39;&#xA;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;-- Sinon on détermine si la visite est réalisée en fonction de l&#39;heure de passage&#xA;&#x9;&#x9;&#x9;WHEN var.&#34;now&#34; &gt; voy.date_fin  THEN &#39;A reçu la visite du Père Noël&#39;&#xA;&#x9;&#x9;&#x9;WHEN var.&#34;now&#34; &gt; voy.date_debut  THEN &#39;Le Père Noël est ici, Youpi !&#39;&#xA;&#x9;&#x9;&#x9;ELSE &#39;Attend la visite du Père Noël&#39;&#xA;&#x9;&#x9;END AS informations,&#xA;&#x9;&#x9;t1.geom&#xA;&#x9;FROM &#xA;&#x9;&#x9;all_destinations AS t1&#xA;&#x9;CROSS JOIN &#xA;&#x9;&#x9;santa_tracker.v_00_variable AS var&#xA;&#x9;LEFT JOIN &#xA;&#x9;&#x9;santa_tracker.vm_06_voyage as voy&#xA;&#x9;&#x9;ON voy.id_destination = t1.id_destination&#xA;&#x9;&#x9;AND voy.type_etape = &#39;Distribution&#39;&#xA;;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;hr class=&#34;wp-block-separator has-alpha-channel-opacity&#34;/&gt;&#xA;&#xA;&#xA;&#xA;&lt;p class=&#34;has-text-align-center&#34;&gt;Voila ! J&amp;rsquo;espère que ça vous a plu et n&amp;rsquo;hésitez pas à suivre le Père Noël !!&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p class=&#34;has-text-align-center has-rouge-color has-text-color&#34;&gt;&lt;a href=&#34;https://noel.cirilgroup.com/index.html&#34; target=&#34;_blank&#34; rel=&#34;noreferrer noopener&#34;&gt;&lt;strong&gt;noel.cirilgroup.com&lt;/strong&gt;&lt;/a&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&lt;p class=&#34;has-text-align-center has-rouge-color has-text-color has-large-font-size&#34;&gt;&lt;img src=&#34;https://s.w.org/images/core/emoji/16.0.1/72x72/1f384.png&#34; alt=&#34;🎄&#34; class=&#34;wp-smiley&#34; style=&#34;height: 1em; max-height: 1em;&#34; /&gt; &lt;strong&gt;Joyeux Noël !!&lt;/strong&gt; &lt;img src=&#34;https://s.w.org/images/core/emoji/16.0.1/72x72/1f384.png&#34; alt=&#34;🎄&#34; class=&#34;wp-smiley&#34; style=&#34;height: 1em; max-height: 1em;&#34; /&gt;&lt;/p&gt;&#xA;</content>
    <link href="https://blog.arthurbazin.com/bdd/postgresql/suivons-le-pere-noel-avec-postgis" rel="alternate"></link>
    <summary type="html">Découvrez ce qui se cache derrière une application de suivi du Père Noël. Une liste de destination, quelques requêtes SQL et le tour est joué ? Ce n&#39;est pas aussi simple que ça, vous allez le voir...&#xA;En partenariat avec Ciril GROUP.</summary>
    <author>
      <name>Arthur Bazin</name>
    </author>
  </entry>
  <entry>
    <title>On analyse la nouvelle collation de PostgreSQL 17</title>
    <updated>2024-06-07T11:40:12Z</updated>
    <id>tag:blog-postgresql.verite.pro,2024-06-07:/2024/06/07/pg17-utf8-collation.html</id>
    <link href="https://blog-postgresql.verite.pro/2024/06/07/pg17-utf8-collation.html" rel="alternate"></link>
    <summary type="html">&lt;p&gt;PostgreSQL 17 est sorti en version bêta le 23 mai dernier, et dans ce billet on&#xA;va détailler une de ses nouveautés: une collation interne gérant l’UTF-8 avec des&#xA;comparaisons de texte en binaire.&lt;/p&gt;</summary>
  </entry>
  <entry>
    <title>Les rapports de bugs de Postgres en 2023</title>
    <updated>2024-01-24T10:23:10Z</updated>
    <id>tag:blog-postgresql.verite.pro,2024-01-24:/2024/01/24/pgsql-bugs-annee-2023.html</id>
    <link href="https://blog-postgresql.verite.pro/2024/01/24/pgsql-bugs-annee-2023.html" rel="alternate"></link>
    <summary type="html">Une revue quantitative des rapports de bugs de Postgres en 2023</summary>
  </entry>
  <entry>
    <title>Classification des caractères avec ICU</title>
    <updated>2023-06-11T14:32:00Z</updated>
    <id>tag:blog-postgresql.verite.pro,2023-06-11:/2023/06/11/caracteres-icu.html</id>
    <link href="https://blog-postgresql.verite.pro/2023/06/11/caracteres-icu.html" rel="alternate"></link>
    <summary type="html">Avec PostgreSQL 16 où ICU devient le fournisseur de collations par défaut, il y a quelques différences sémantiques à anticiper dans la classification des caractères. Cet article en détaille quelques-unes.</summary>
  </entry>
  <entry>
    <title>Isolation Repeatable Read avec PostgreSQL versus MySQL</title>
    <updated>2020-02-10T17:50:00Z</updated>
    <id>tag:blog-postgresql.verite.pro,2020-02-10:/2020/02/10/isolation-postgresql-vs-mysql.html</id>
    <link href="https://blog-postgresql.verite.pro/2020/02/10/isolation-postgresql-vs-mysql.html" rel="alternate"></link>
    <summary type="html">&lt;p&gt;Les moteurs SQL permettent aux transactions concurrentes d’être&#xA;isolées les unes des autres pour éviter les interférences.&#xA;Cette propriété d’isolation correspond à la lettre I de l’acronyme&#xA;bien connu &lt;a href=&#34;https://fr.wikipedia.org/wiki/Propri%C3%A9t%C3%A9s_ACID&#34;&gt;“ACID”&lt;/a&gt;,&#xA;les autres propriétés étant Atomicité, Cohérence&#xA;(&lt;em&gt;Consistency&lt;/em&gt; en anglais) et Durabilité.&lt;/p&gt;</summary>
  </entry>
  <entry>
    <title>Recherche et remplacement multiple avec plperl</title>
    <updated>2020-01-22T09:05:14Z</updated>
    <id>tag:blog-postgresql.verite.pro,2020-01-22:/2020/01/22/multi-replace.html</id>
    <link href="https://blog-postgresql.verite.pro/2020/01/22/multi-replace.html" rel="alternate"></link>
    <summary type="html">&lt;p&gt;Remplacer une chaîne par une autre dans une chaîne plus large est simple&#xA;en SQL, avec la fonction &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;replace&lt;/code&gt;:&lt;/p&gt;</summary>
  </entry>
  <entry>
    <title>Les collations non déterministes</title>
    <updated>2019-10-16T16:32:15Z</updated>
    <id>tag:blog-postgresql.verite.pro,2019-10-16:/2019/10/16/collations-non-deterministes.html</id>
    <link href="https://blog-postgresql.verite.pro/2019/10/16/collations-non-deterministes.html" rel="alternate"></link>
    <summary type="html">&lt;p&gt;Depuis la version 12, les collations de PostgreSQL peuvent être créées&#xA;avec un paramètre nommé &lt;strong&gt;deterministic&lt;/strong&gt;, qui peut être vrai&#xA;ou faux, si bien que les collations  sont maintenant&#xA;soit &lt;strong&gt;déterministes&lt;/strong&gt; (ce qu’elles sont par défaut), soit&#xA;&lt;strong&gt;non déterministes&lt;/strong&gt;.&lt;/p&gt;</summary>
  </entry>
  <entry>
    <title>De retour du pgDay Paris 2024.</title>
    <updated>2024-03-18T09:39:28Z</updated>
    <id>tag:blog.anayrat.info,2024-03-18:/2024/03/18/de-retour-du-pgday-paris-2024./</id>
    <link href="https://blog.anayrat.info/2024/03/18/de-retour-du-pgday-paris-2024./" rel="alternate"></link>
    <summary type="html">&lt;p&gt;Me voilà rentré du pgDay Paris. J’ai beaucoup aimé cette édition. J’étais déjà venu à celle de &lt;a href=&#34;https://www.postgresql.eu/events/pgdayparis2019/schedule/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;2019&lt;/a&gt; et je dois dire que je n’ai pas été déçu. Pour rappel, le pgDay Paris est une conférence internationale. Les présentations sont en anglais et permettent d’attirer des orateurs et un public plus anglophone.&lt;/p&gt;&#xA;&lt;p&gt;Je vois souvent cette conférence comme un petit &lt;a href=&#34;https://www.postgresql.eu/events/series/pgconfeu-1/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;PGConf Europe&lt;/a&gt; : on retrouve un contenu assez riche avec la dimension internationale.&lt;/p&gt;&#xA;&lt;p&gt;On croise des têtes déjà connues : public, orateurs, bénévoles, contributeurs : Tout ce petit monde qui fait vivre la communauté Postgres.&lt;/p&gt;&#xA;&lt;p&gt;Puis, c’est l’occasion de mettre des visages sur des noms que l’on croise en lisant des articles ou les mailing-list Postgres.&lt;/p&gt;&#xA;&lt;p&gt;Voici un petit retour sur les conférences auxquelles j’ai assisté :&lt;/p&gt;&#xA;&lt;h1 id=&#34;elephant-in-a-nutshell---navigating-the-postgres-community-101&#34;&gt;Elephant in a nutshell - Navigating the Postgres community 101&lt;/h1&gt;&#xA;&lt;p&gt;Avec &lt;a href=&#34;https://2024.pgday.paris/organization/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Carole et Stéphanie&lt;/a&gt;, on a pensé que ce serait bien d’avoir cette conférence en introduction.&lt;/p&gt;&#xA;&lt;p&gt;Je l’ai trouvé très complète. Elle parle de Postgres, mais aussi et surtout de sa communauté. C’est ce qui fait sa force.&lt;/p&gt;&#xA;&lt;p&gt;&lt;a href=&#34;https://www.postgresql.eu/events/pgdayparis2024/sessions/session/5293/slides/481/pgDay%20Paris_Valeria%27s%20talk%20-%20Elephant%20in%20a%20nutshell.pdf&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Les slides sont disponibles.&lt;/a&gt;&lt;/p&gt;&#xA;&lt;h1 id=&#34;sustainable-database-performance-profiling-in-postgresql&#34;&gt;Sustainable Database Performance profiling in PostgreSQL&lt;/h1&gt;&#xA;&lt;p&gt;Postgres dispose de nombreuses vues statistiques apportant des informations sur son fonctionnement.&lt;/p&gt;&#xA;&lt;p&gt;Elles peuvent être natives (&lt;em&gt;pg_stat_statements&lt;/em&gt; …) ou via des extensions &lt;em&gt;pg_stat_kcache&lt;/em&gt;, &lt;em&gt;pg_wait_sampling&lt;/em&gt;.&lt;/p&gt;&#xA;&lt;p&gt;Cependant, et c’est ce que souligne cette conférence, elles apportent une vue à un instant T.&lt;/p&gt;&#xA;&lt;p&gt;Pour les exploiter, il faut les historiser. L’orateur présente un outil basé sur ce qui se fait sur Oracle : &lt;a href=&#34;https://github.com/zubkov-andrei/pg_profile&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;pg_profile&lt;/a&gt;.&lt;/p&gt;&#xA;&lt;p&gt;En revanche, il le présente comme l’unique outil permettant d’exploiter ces informations. Une personne dans le public lui a fait remarquer qu’il existait un autre projet : &lt;a href=&#34;https://powa.readthedocs.io/en/latest/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;PoWA&lt;/a&gt;.&lt;/p&gt;&#xA;&lt;p&gt;Les deux outils ne fournissent pas les mêmes fonctions, &lt;em&gt;pg_profile&lt;/em&gt; génère un rapport HTML. Il est plutôt facile à installer, il ne nécessite pas de librairies externe car il est écrit en pl/pgsql.&lt;/p&gt;&#xA;&lt;p&gt;PoWA apporte des graphes, de la suggestion d’index… mais est plus lourd à installer.&lt;/p&gt;&#xA;&lt;p&gt;&lt;a href=&#34;https://www.postgresql.eu/events/pgdayparis2024/sessions/session/5067/slides/482/20240314_dkrautschick_PGdayParis_SustainableDatabasePerformanceProfilingInPostgreSQL.pdf&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Les slides sont disponibles&lt;/a&gt;.&lt;/p&gt;&#xA;&lt;h1 id=&#34;postgresql-without-permanent-local-data-storage&#34;&gt;PostgreSQL without permanent local data storage&lt;/h1&gt;&#xA;&lt;p&gt;Là, on rentre dans une conférence très technique. Matthias travaille sur le projet &lt;a href=&#34;https://neon.tech/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Neon&lt;/a&gt; et il participe régulièrement sur les &lt;a href=&#34;https://www.postgresql.org/list/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;mailing-list Postgres&lt;/a&gt;.&lt;/p&gt;&#xA;&lt;p&gt;Neon est un fork opensource de Postgres visant à séparer le &lt;em&gt;compute&lt;/em&gt; et le &lt;em&gt;storage&lt;/em&gt;. C’est ce qu’a fait AWS avec le projet Aurora.&lt;/p&gt;&#xA;&lt;p&gt;Heikki Linnakangas, un des co-fondateurs de Neon et committer de Postgres a fait plusieurs présentations :&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.youtube.com/watch?v=rES0yzeERns&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Neon: Serverless PostgreSQL! (Heikki Linnakangas)&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://neon.tech/blog/architecture-decisions-in-neon&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Architecture decisions in Neon&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;Matthias a présenté les différents problèmes que cela posait de vouloir séparer le stockage du reste du moteur. C’est clairement un projet très ambitieux. Pour le moment, il est difficile de savoir si ce fork perdurera ou non.&lt;/p&gt;&#xA;&lt;p&gt;Cependant, on peut souligner que les personnes travaillant dessus ont une très grande connaissance du moteur. On peut espérer que ça ait des implications positives dans le projet Postgres.&lt;/p&gt;&#xA;&lt;p&gt;Affaire à suivre…&lt;/p&gt;&#xA;&lt;h1 id=&#34;lightning-talks&#34;&gt;Lightning Talks!&lt;/h1&gt;&#xA;&lt;p&gt;Les Lightning Talks sont une bonne occasion de balayer certains sujets un peu plus légers. Ca passe plutôt bien après le repas. C’est assez divertissant. J’ai bien aimé la présentation de Léo Unbekandt sur l’architecture des instances Postgres à Scalingo. Pas de K8S, une architecture simple et éprouvée.&lt;/p&gt;&#xA;&lt;p&gt;J’ai aussi aimé la présentation de Chris Ellis où il fabrique un objet décoratif lumineux avec de l’ESP32 dedans.&lt;/p&gt;&#xA;&lt;h1 id=&#34;multi-tenant-database-the-good-the-bad-the-ugly&#34;&gt;Multi-tenant database: the good, the bad, the ugly.&lt;/h1&gt;&#xA;&lt;p&gt;Après, les Lightning Talks, on retourne dans le vif du sujet avec cette présentation de Pierre Ducroquet.&lt;/p&gt;&#xA;&lt;p&gt;Je connais bien Pierre, la première fois que je l’ai croisé, c’était au pgDay France 2016. Il avait fait une très bonne présentation sur &lt;a href=&#34;https://2016.pgday.fr/programme.html#comprendre-requete-lente&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Comprendre pourquoi une requête est lente, et comment régler le soucis&lt;/a&gt;. Ensuite, ça a été mon collègue de travail pendant quelques années où on a rencontré les problèmes que pouvaient poser les bases de données &lt;em&gt;multi-tenant&lt;/em&gt;.&lt;/p&gt;&#xA;&lt;p&gt;Il présente différentes façons de faire du &lt;em&gt;multi-tenant&lt;/em&gt; avec les contraintes que cela implique. Il donne des chiffres assez impressionnants comme plus de 200 000 tables!&lt;/p&gt;&#xA;&lt;p&gt;&lt;a href=&#34;https://www.pinaraf.info/2024/03/look-ma-i-wrote-a-new-jit-compiler-for-postgresql/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Quelque chose me dit qu’on ne va pas tarder à le revoir&lt;/a&gt;.&lt;/p&gt;&#xA;&lt;h1 id=&#34;beyond-b-trees-looking-at-columnar-storage-and-lsm-trees&#34;&gt;Beyond B-trees looking at Columnar Storage and LSM trees&lt;/h1&gt;&#xA;&lt;p&gt;Une autre conférence assez bas niveau sur le stockage colonne et les LSM Tree.&lt;/p&gt;&#xA;&lt;p&gt;Ce type de stockage peut effectivement faire partie du futur de Postgres. Le moteur commence à être utilisé pour de plus en plus de projets analytiques où on manipule de gros volumes de données.&lt;/p&gt;&#xA;&lt;p&gt;Il faut donc des méthodes de stockage capable d’encaisse des écritures rapides.&lt;/p&gt;&#xA;&lt;h1 id=&#34;postgres-16-highlight-logical-decoding-on-standby&#34;&gt;Postgres 16 highlight: Logical decoding on standby&lt;/h1&gt;&#xA;&lt;p&gt;Une nouveauté assez attendue sur Postgres 16 : La possibilité de faire du décodage logique sur un secondaire.&lt;/p&gt;&#xA;&lt;p&gt;Qui mieux qu’un des auteurs de cette fonctionnalité pour en parler ?&lt;/p&gt;&#xA;&lt;p&gt;Bertrand présente les difficultés pour faire un décodage logique sur un secondaire, et comment elles ont été résolues.&lt;/p&gt;&#xA;&lt;p&gt;Il a aussi fait une démonstration. C’est vraiment impressionnant, car c’est un sujet assez compliqué.&lt;/p&gt;&#xA;&lt;p&gt;Point bonus, il explique aussi une nouveauté de Postres 17 : la synchronisation des slots de réplication.&lt;/p&gt;&#xA;&lt;p&gt;Actuellement, on peut difficilement “raccrocher” une réplication logique en cas de bascule. Il y a un risque de perte de transaction.&lt;/p&gt;&#xA;&lt;p&gt;Postgres 17 devrait permettre de synchroniser un slot de réplication. En cas de bascule, on peut reprendre la réplication.&#xA;On est chanceux, il vient tout juste d’écrire un article sur le sujet : &lt;a href=&#34;https://bdrouvot.github.io/2024/03/16/postgres-17-highlight-logical-replication-slots-synchronization/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Postgres 17 highlight: Logical replication slots synchronization&lt;/a&gt;.&lt;/p&gt;&#xA;&lt;p&gt;&lt;a href=&#34;https://www.postgresql.eu/events/pgdayparis2024/sessions/session/5122/slides/483/pgdayParis2024.pdf&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Les slides sont disponibles&lt;/a&gt;.&lt;/p&gt;&#xA;&lt;h1 id=&#34;closing&#34;&gt;Closing&lt;/h1&gt;&#xA;&lt;p&gt;C’était la dernière conférence de la journée. On a pu se retrouver pour le social event.&lt;/p&gt;&#xA;&lt;p&gt;C’est un moment que j’affectionne particulièrement. Car au-delà des conférences, c’est surtout une occasion d’échanger entre passionnés. De retrouver des connaissances et amis de longue date.&lt;/p&gt;&#xA;&lt;p&gt;J’ai réalisé que j’avais un peu délaissé les conférences, entre le covid, mon passage en freelance etc… A l’avenir, j’essaierai d’être plus présent sur ce genre d’évènement (si je peux prendre le train).&lt;/p&gt;&#xA;&lt;h1 id=&#34;merci&#34;&gt;Merci&lt;/h1&gt;&#xA;&lt;p&gt;J’en profite aussi pour remercier les &lt;a href=&#34;https://2024.pgday.paris/organization/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;organisateurs et bénévoles&lt;/a&gt;. On a du mal à réaliser l’investissement que ça demande. Un grand merci à eux pour cet évènement !&lt;/p&gt;&#xA;&lt;p&gt;On se verra sûrement au pgDay 2025 !&lt;/p&gt;</summary>
    <author>
      <name>blog.anayrat.info</name>
    </author>
  </entry>
  <entry>
    <title>Recommandations de lectures pour améliorer ses connaissances en base de données et PostgreSQL</title>
    <updated>2024-02-12T08:00:00Z</updated>
    <id>tag:blog.anayrat.info,2024-02-12:/2024/02/12/recommandations-de-lectures-pour-ameliorer-ses-connaissances-en-base-de-donnees-et-postgresql/</id>
    <link href="https://blog.anayrat.info/2024/02/12/recommandations-de-lectures-pour-ameliorer-ses-connaissances-en-base-de-donnees-et-postgresql/" rel="alternate"></link>
    <summary type="html">&lt;details class=&#34;toc-inpage d-print-none  &#34; open&gt;&#xA;  &lt;summary class=&#34;font-weight-bold&#34;&gt;Table des matières&lt;/summary&gt;&#xA;  &lt;nav id=&#34;TableOfContents&#34;&gt;&#xA;  &lt;ul&gt;&#xA;    &lt;li&gt;&lt;a href=&#34;#fondamentaux-des-bases-de-données&#34;&gt;Fondamentaux des bases de données&lt;/a&gt;&#xA;      &lt;ul&gt;&#xA;        &lt;li&gt;&lt;a href=&#34;#the-manga-guide-to-databases&#34;&gt;The Manga Guide to Databases&lt;/a&gt;&lt;/li&gt;&#xA;        &lt;li&gt;&lt;a href=&#34;#database-design-for-mere-mortals&#34;&gt;Database Design for Mere Mortals&lt;/a&gt;&lt;/li&gt;&#xA;        &lt;li&gt;&lt;a href=&#34;#sql-antipatterns&#34;&gt;SQL Antipatterns&lt;/a&gt;&lt;/li&gt;&#xA;        &lt;li&gt;&lt;a href=&#34;#sql-for-smarties&#34;&gt;SQL for Smarties&lt;/a&gt;&lt;/li&gt;&#xA;        &lt;li&gt;&lt;a href=&#34;#the-art-of-sql&#34;&gt;The Art Of SQL&lt;/a&gt;&lt;/li&gt;&#xA;      &lt;/ul&gt;&#xA;    &lt;/li&gt;&#xA;    &lt;li&gt;&lt;a href=&#34;#performance&#34;&gt;Performance&lt;/a&gt;&#xA;      &lt;ul&gt;&#xA;        &lt;li&gt;&lt;a href=&#34;#sql-performance-explained&#34;&gt;SQL Performance Explained&lt;/a&gt;&lt;/li&gt;&#xA;        &lt;li&gt;&lt;a href=&#34;#indexing-beyond-the-basics&#34;&gt;Indexing Beyond the Basics&lt;/a&gt;&lt;/li&gt;&#xA;      &lt;/ul&gt;&#xA;    &lt;/li&gt;&#xA;    &lt;li&gt;&lt;a href=&#34;#postgresql&#34;&gt;PostgreSQL&lt;/a&gt;&#xA;      &lt;ul&gt;&#xA;        &lt;li&gt;&lt;a href=&#34;#practical-sql&#34;&gt;Practical SQL&lt;/a&gt;&lt;/li&gt;&#xA;        &lt;li&gt;&lt;a href=&#34;#postgresql---architecture-et-notions-avancées&#34;&gt;PostgreSQL - Architecture et notions avancées&lt;/a&gt;&lt;/li&gt;&#xA;        &lt;li&gt;&lt;a href=&#34;#learn-postgresql&#34;&gt;Learn PostgreSQL&lt;/a&gt;&lt;/li&gt;&#xA;        &lt;li&gt;&lt;a href=&#34;#postgresql-14-internals&#34;&gt;PostgreSQL 14 Internals&lt;/a&gt;&lt;/li&gt;&#xA;      &lt;/ul&gt;&#xA;    &lt;/li&gt;&#xA;  &lt;/ul&gt;&#xA;&lt;/nav&gt;&#xA;&lt;/details&gt;&#xA;&lt;p&gt;Je ne vais lister que quelques livres, mais je pourrais en citer pleins d&amp;rsquo;autres &amp;#x1f603; . J&amp;rsquo;espère que ça permettra à plus de développeurs, DBA, DEVOPS, CTO &amp;hellip; de mieux comprendre les bases de données et leurs enjeux.&lt;/p&gt;&#xA;&lt;h1 id=&#34;fondamentaux-des-bases-de-données&#34;&gt;Fondamentaux des bases de données&lt;/h1&gt;&#xA;&lt;h2 id=&#34;the-manga-guide-to-databases&#34;&gt;The Manga Guide to Databases&lt;/h2&gt;&#xA;&lt;p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;figure  id=&#34;figure-the-manga-guide-to-databases&#34;&gt;&#xA;  &lt;div class=&#34;d-flex justify-content-center&#34;&gt;&#xA;    &lt;div class=&#34;w-100&#34; &gt;&lt;img alt=&#34;manga&#34; srcset=&#34;&#xA;               /2024/02/12/recommandations-de-lectures-pour-ameliorer-ses-connaissances-en-base-de-donnees-et-postgresql/manga_hu5aa70ea30ae3275c65d27c3d87d1e70c_108868_79a33cb973abaedb22e66948cdc60d80.webp 400w,&#xA;               /2024/02/12/recommandations-de-lectures-pour-ameliorer-ses-connaissances-en-base-de-donnees-et-postgresql/manga_hu5aa70ea30ae3275c65d27c3d87d1e70c_108868_c3accdb2c9ecf2675e6df1dee150cd9e.webp 760w,&#xA;               /2024/02/12/recommandations-de-lectures-pour-ameliorer-ses-connaissances-en-base-de-donnees-et-postgresql/manga_hu5aa70ea30ae3275c65d27c3d87d1e70c_108868_1200x1200_fit_q75_h2_lanczos_2.webp 1200w&#34;&#xA;               src=&#34;https://blog.anayrat.info/2024/02/12/recommandations-de-lectures-pour-ameliorer-ses-connaissances-en-base-de-donnees-et-postgresql/manga_hu5aa70ea30ae3275c65d27c3d87d1e70c_108868_79a33cb973abaedb22e66948cdc60d80.webp&#34;&#xA;               width=&#34;474&#34;&#xA;               height=&#34;626&#34;&#xA;               loading=&#34;lazy&#34; data-zoomable /&gt;&lt;/div&gt;&#xA;  &lt;/div&gt;&lt;figcaption&gt;&#xA;      The Manga Guide to Databases&#xA;    &lt;/figcaption&gt;&lt;/figure&gt;&#xA;&lt;/p&gt;&#xA;&lt;p&gt;Niveau : Débutant&lt;/p&gt;&#xA;&lt;p&gt;&lt;a href=&#34;https://nostarch.com/mg_databases.htm&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;The Manga Guide to Databases&lt;/a&gt; est celui que je recommande dans la plupart de mes rapports d&amp;rsquo;audit.&lt;/p&gt;&#xA;&lt;p&gt;Il est vraiment génial, facile à lire et pour autant, il ne sacrifie pas le fond à la forme.&lt;/p&gt;&#xA;&lt;p&gt;Il couvre un peu tous les aspects importants :&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Modélisation&lt;/li&gt;&#xA;&lt;li&gt;Écriture de requêtes simples&lt;/li&gt;&#xA;&lt;li&gt;Grands principes des bases de données : transaction, isolation&amp;hellip;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h2 id=&#34;database-design-for-mere-mortals&#34;&gt;Database Design for Mere Mortals&lt;/h2&gt;&#xA;&lt;p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;figure  id=&#34;figure-database-design-for-mere-mortals&#34;&gt;&#xA;  &lt;div class=&#34;d-flex justify-content-center&#34;&gt;&#xA;    &lt;div class=&#34;w-100&#34; &gt;&lt;img alt=&#34;design&#34; srcset=&#34;&#xA;               /2024/02/12/recommandations-de-lectures-pour-ameliorer-ses-connaissances-en-base-de-donnees-et-postgresql/design_hue35134dfe8ede24af1874bb4631ce208_182026_721347960fb63df78ab2314199294f15.webp 400w,&#xA;               /2024/02/12/recommandations-de-lectures-pour-ameliorer-ses-connaissances-en-base-de-donnees-et-postgresql/design_hue35134dfe8ede24af1874bb4631ce208_182026_2a81b8ec12f19038971875854feca26c.webp 760w,&#xA;               /2024/02/12/recommandations-de-lectures-pour-ameliorer-ses-connaissances-en-base-de-donnees-et-postgresql/design_hue35134dfe8ede24af1874bb4631ce208_182026_1200x1200_fit_q75_h2_lanczos.webp 1200w&#34;&#xA;               src=&#34;https://blog.anayrat.info/2024/02/12/recommandations-de-lectures-pour-ameliorer-ses-connaissances-en-base-de-donnees-et-postgresql/design_hue35134dfe8ede24af1874bb4631ce208_182026_721347960fb63df78ab2314199294f15.webp&#34;&#xA;               width=&#34;616&#34;&#xA;               height=&#34;760&#34;&#xA;               loading=&#34;lazy&#34; data-zoomable /&gt;&lt;/div&gt;&#xA;  &lt;/div&gt;&lt;figcaption&gt;&#xA;      Database Design for Mere Mortals&#xA;    &lt;/figcaption&gt;&lt;/figure&gt;&#xA;&lt;/p&gt;&#xA;&lt;p&gt;Niveau : Intermédiaire&lt;/p&gt;&#xA;&lt;p&gt;&lt;a href=&#34;https://www.informit.com/store/database-design-for-mere-mortals-25th-anniversary-edition-9780136788041&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Database Design for Mere Mortals&lt;/a&gt; de &lt;em&gt;Michael J. Hernandez&lt;/em&gt; est, comme son nom l&amp;rsquo;indique, orienté sur la modélisation.&lt;/p&gt;&#xA;&lt;p&gt;C&amp;rsquo;est un gros pavé de plus de 600 pages, mais il ne faut pas se laisser impressionner. Il se lit très bien, c&amp;rsquo;est bien vulgarisé et l&amp;rsquo;auteur a fait attention  à éviter de s&amp;rsquo;embarquer dans la théorie qui peut parfois être indigeste.&lt;/p&gt;&#xA;&lt;p&gt;J&amp;rsquo;ai beaucoup aimé le processus d&amp;rsquo;interviews pour construire le modèle de données, l&amp;rsquo;accent mis sur la documentation du modèle. Il  parle peu des formes normales, c&amp;rsquo;est un parti pris. Cependant, si on suit son processus, le modèle respecte bien les formes normales.&lt;/p&gt;&#xA;&lt;h2 id=&#34;sql-antipatterns&#34;&gt;SQL Antipatterns&lt;/h2&gt;&#xA;&lt;p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;figure  id=&#34;figure-sql-antipatterns&#34;&gt;&#xA;  &lt;div class=&#34;d-flex justify-content-center&#34;&gt;&#xA;    &lt;div class=&#34;w-100&#34; &gt;&lt;img alt=&#34;antipatterns&#34; srcset=&#34;&#xA;               /2024/02/12/recommandations-de-lectures-pour-ameliorer-ses-connaissances-en-base-de-donnees-et-postgresql/antipatterns_hu78d2e974f3c547630262f79e552a0ea6_2096124_c320047c4b1f0cff61ce38e7e7f6d3dc.webp 400w,&#xA;               /2024/02/12/recommandations-de-lectures-pour-ameliorer-ses-connaissances-en-base-de-donnees-et-postgresql/antipatterns_hu78d2e974f3c547630262f79e552a0ea6_2096124_0d0faf00cb44ab3739d2b4e20f0b205e.webp 760w,&#xA;               /2024/02/12/recommandations-de-lectures-pour-ameliorer-ses-connaissances-en-base-de-donnees-et-postgresql/antipatterns_hu78d2e974f3c547630262f79e552a0ea6_2096124_1200x1200_fit_q75_h2_lanczos.webp 1200w&#34;&#xA;               src=&#34;https://blog.anayrat.info/2024/02/12/recommandations-de-lectures-pour-ameliorer-ses-connaissances-en-base-de-donnees-et-postgresql/antipatterns_hu78d2e974f3c547630262f79e552a0ea6_2096124_c320047c4b1f0cff61ce38e7e7f6d3dc.webp&#34;&#xA;               width=&#34;633&#34;&#xA;               height=&#34;760&#34;&#xA;               loading=&#34;lazy&#34; data-zoomable /&gt;&lt;/div&gt;&#xA;  &lt;/div&gt;&lt;figcaption&gt;&#xA;      SQL Antipatterns&#xA;    &lt;/figcaption&gt;&lt;/figure&gt;&#xA;&lt;/p&gt;&#xA;&lt;p&gt;&lt;a href=&#34;https://pragprog.com/titles/bksap1/sql-antipatterns-volume-1/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;SQL Antipatterns&lt;/a&gt; est un bon livre pour identifier les &lt;em&gt;anti-patterns&lt;/em&gt; et apporte des solutions.&#xA;Je m&amp;rsquo;en sers régulièrement quand j&amp;rsquo;ai besoin d&amp;rsquo;expliquer ce qui ne va pas dans un modèle ou une requête.&lt;/p&gt;&#xA;&lt;h2 id=&#34;sql-for-smarties&#34;&gt;SQL for Smarties&lt;/h2&gt;&#xA;&lt;p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;figure  id=&#34;figure-sql-for-smarties&#34;&gt;&#xA;  &lt;div class=&#34;d-flex justify-content-center&#34;&gt;&#xA;    &lt;div class=&#34;w-100&#34; &gt;&lt;img alt=&#34;smarties&#34; srcset=&#34;&#xA;               /2024/02/12/recommandations-de-lectures-pour-ameliorer-ses-connaissances-en-base-de-donnees-et-postgresql/smarties_hua93406d09d9e5354756184b8dd00daf0_137495_c6c3d9973032c4ac34459909ff559894.webp 400w,&#xA;               /2024/02/12/recommandations-de-lectures-pour-ameliorer-ses-connaissances-en-base-de-donnees-et-postgresql/smarties_hua93406d09d9e5354756184b8dd00daf0_137495_ca4d66cca791addd71955b48a3f29c2c.webp 760w,&#xA;               /2024/02/12/recommandations-de-lectures-pour-ameliorer-ses-connaissances-en-base-de-donnees-et-postgresql/smarties_hua93406d09d9e5354756184b8dd00daf0_137495_1200x1200_fit_q75_h2_lanczos.webp 1200w&#34;&#xA;               src=&#34;https://blog.anayrat.info/2024/02/12/recommandations-de-lectures-pour-ameliorer-ses-connaissances-en-base-de-donnees-et-postgresql/smarties_hua93406d09d9e5354756184b8dd00daf0_137495_c6c3d9973032c4ac34459909ff559894.webp&#34;&#xA;               width=&#34;616&#34;&#xA;               height=&#34;760&#34;&#xA;               loading=&#34;lazy&#34; data-zoomable /&gt;&lt;/div&gt;&#xA;  &lt;/div&gt;&lt;figcaption&gt;&#xA;      SQL for Smarties&#xA;    &lt;/figcaption&gt;&lt;/figure&gt;&#xA;&lt;/p&gt;&#xA;&lt;p&gt;Niveau : Avancé&lt;/p&gt;&#xA;&lt;p&gt;Comment ne pas mentionner les livres de &lt;a href=&#34;https://en.wikipedia.org/wiki/Joe_Celko&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Joe Celko&lt;/a&gt;.&#xA;Il a participé au standard SQL et écrit de &lt;a href=&#34;https://www.oreilly.com/pub/au/1919&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;nombreux livres&lt;/a&gt;.&lt;/p&gt;&#xA;&lt;p&gt;&lt;a href=&#34;https://www.sciencedirect.com/book/9780128007617/joe-celkos-sql-for-smarties&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;SQL for Smarties&lt;/a&gt; fait partie&#xA;des références en matière de SQL. La première édition date de 1995&amp;hellip; oui&amp;hellip; presque 30 ans quand j&amp;rsquo;écris ces lignes !&#xA;La cinquième édition date de 2015, malgré ces 10 ans, le contenu est toujours d&amp;rsquo;actualité. On trouve même des ordres assez récents comme &lt;code&gt;LATERAL&lt;/code&gt;, les &lt;em&gt;window functions&lt;/em&gt;, &lt;code&gt;CTE&lt;/code&gt;.&lt;/p&gt;&#xA;&lt;p&gt;On est aussi sur un gros pavé de plus de 800 pages, le livre est très complet, assez exhaustif. Je dirai réservé à ceux qui veulent vraiment approfondir leurs connaissances en SQL.&lt;/p&gt;&#xA;&lt;p&gt;À noter qu&amp;rsquo;il existe une version en français basé sur la seconde édition qui date de 2000, elle accuse un peu l&amp;rsquo;age : &lt;a href=&#34;https://www.decitre.fr/livres/sql-avance-9782711786367.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;SQL Avancé&lt;/a&gt;. On peut le trouver &lt;a href=&#34;https://www.momox-shop.fr/joe-celko-sql-avance-taschenbuch-M02841801411.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;d&amp;rsquo;occasion&lt;/a&gt;.&lt;/p&gt;&#xA;&lt;h2 id=&#34;the-art-of-sql&#34;&gt;The Art Of SQL&lt;/h2&gt;&#xA;&lt;p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;figure  id=&#34;figure-the-art-of-sql&#34;&gt;&#xA;  &lt;div class=&#34;d-flex justify-content-center&#34;&gt;&#xA;    &lt;div class=&#34;w-100&#34; &gt;&lt;img alt=&#34;art&#34; srcset=&#34;&#xA;               /2024/02/12/recommandations-de-lectures-pour-ameliorer-ses-connaissances-en-base-de-donnees-et-postgresql/art_hu3e5eba633759e8230aa87338f68d1a3b_220155_2bb5db8f1a45e313260bc7467bf92c17.webp 400w,&#xA;               /2024/02/12/recommandations-de-lectures-pour-ameliorer-ses-connaissances-en-base-de-donnees-et-postgresql/art_hu3e5eba633759e8230aa87338f68d1a3b_220155_ad989b301e7ba70987c52db0c9c535e3.webp 760w,&#xA;               /2024/02/12/recommandations-de-lectures-pour-ameliorer-ses-connaissances-en-base-de-donnees-et-postgresql/art_hu3e5eba633759e8230aa87338f68d1a3b_220155_1200x1200_fit_q75_h2_lanczos.webp 1200w&#34;&#xA;               src=&#34;https://blog.anayrat.info/2024/02/12/recommandations-de-lectures-pour-ameliorer-ses-connaissances-en-base-de-donnees-et-postgresql/art_hu3e5eba633759e8230aa87338f68d1a3b_220155_2bb5db8f1a45e313260bc7467bf92c17.webp&#34;&#xA;               width=&#34;579&#34;&#xA;               height=&#34;760&#34;&#xA;               loading=&#34;lazy&#34; data-zoomable /&gt;&lt;/div&gt;&#xA;  &lt;/div&gt;&lt;figcaption&gt;&#xA;      The Art Of SQL&#xA;    &lt;/figcaption&gt;&lt;/figure&gt;&#xA;&lt;/p&gt;&#xA;&lt;p&gt;Niveau : Avancé&lt;/p&gt;&#xA;&lt;p&gt;Avec &lt;a href=&#34;https://www.oreilly.com/library/view/the-art-of/0596008945/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;The Art of SQL&lt;/a&gt; de &lt;a href=&#34;https://www.oreilly.com/pub/au/2005&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Stephane Faroult&lt;/a&gt;, on change de catégorie. Là, on est sur du SQL plus avancé.&#xA;Le livre va être orienté performances, bonnes pratiques. Malgré ses 18 ans, son contenu est toujours d&amp;rsquo;actualité. C&amp;rsquo;est un livre très puissant, il vous faudra du temps pour le lire et assimiler chaque page.&lt;/p&gt;&#xA;&lt;h1 id=&#34;performance&#34;&gt;Performance&lt;/h1&gt;&#xA;&lt;h2 id=&#34;sql-performance-explained&#34;&gt;SQL Performance Explained&lt;/h2&gt;&#xA;&lt;p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;figure  id=&#34;figure-sql-performance-explained&#34;&gt;&#xA;  &lt;div class=&#34;d-flex justify-content-center&#34;&gt;&#xA;    &lt;div class=&#34;w-100&#34; &gt;&lt;img alt=&#34;luke&#34; srcset=&#34;&#xA;               /2024/02/12/recommandations-de-lectures-pour-ameliorer-ses-connaissances-en-base-de-donnees-et-postgresql/luke_hu753ac19229e8013f92d2513650643829_89166_d25868af42f9fe155d70736822260a43.webp 400w,&#xA;               /2024/02/12/recommandations-de-lectures-pour-ameliorer-ses-connaissances-en-base-de-donnees-et-postgresql/luke_hu753ac19229e8013f92d2513650643829_89166_c361959935046d9adedd33681287b70f.webp 760w,&#xA;               /2024/02/12/recommandations-de-lectures-pour-ameliorer-ses-connaissances-en-base-de-donnees-et-postgresql/luke_hu753ac19229e8013f92d2513650643829_89166_1200x1200_fit_q75_h2_lanczos.webp 1200w&#34;&#xA;               src=&#34;https://blog.anayrat.info/2024/02/12/recommandations-de-lectures-pour-ameliorer-ses-connaissances-en-base-de-donnees-et-postgresql/luke_hu753ac19229e8013f92d2513650643829_89166_d25868af42f9fe155d70736822260a43.webp&#34;&#xA;               width=&#34;480&#34;&#xA;               height=&#34;737&#34;&#xA;               loading=&#34;lazy&#34; data-zoomable /&gt;&lt;/div&gt;&#xA;  &lt;/div&gt;&lt;figcaption&gt;&#xA;      SQL Performance Explained&#xA;    &lt;/figcaption&gt;&lt;/figure&gt;&#xA;&lt;/p&gt;&#xA;&lt;p&gt;Niveau : Intermédiaire&lt;/p&gt;&#xA;&lt;p&gt;Impossible de ne pas mentionner l&amp;rsquo;excellent livre de &lt;a href=&#34;https://winand.at/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Markus Winand&lt;/a&gt;, &lt;a href=&#34;https://sql-performance-explained.com&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;SQL Performance Explained&lt;/a&gt;.&lt;/p&gt;&#xA;&lt;p&gt;Comme son titre l&amp;rsquo;indique, on va parler performance, indexation, écriture de requêtes. À noter qu&amp;rsquo;il a également été traduit en plusieurs langues : Allemand, Espagnol, Japonais et Français grâce à Guillaume Lelarge &lt;a href=&#34;https://sql-au-coeur-des-performances.fr/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;SQL : Au cœur des performances&lt;/a&gt;.&lt;/p&gt;&#xA;&lt;p&gt;Le contenu du livre est également disponible sur son site &lt;a href=&#34;https://use-the-index-luke.com/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Use the Index, Luke !&lt;/a&gt;. Markus est aussi l&amp;rsquo;auteur d&amp;rsquo;un excellent site sur les fonctionnalités avancés du SQL : &lt;a href=&#34;https://modern-sql.com/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Modern SQL&lt;/a&gt;. Lors de l&amp;rsquo;émission &lt;a href=&#34;https://youtu.be/mGqqQg-dG-w?si=he4R6eTC_2VckAVA&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Modern SQL sur Postgres.FM&lt;/a&gt;, il a annoncé la volonté d&amp;rsquo;en faire un livre. J&amp;rsquo;ai hâte ! Il a aussi fait de nombreuses &lt;a href=&#34;https://winand.at/sql-slides-for-developers&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;présentations&lt;/a&gt;.&lt;/p&gt;&#xA;&lt;h2 id=&#34;indexing-beyond-the-basics&#34;&gt;Indexing Beyond the Basics&lt;/h2&gt;&#xA;&lt;p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;figure  id=&#34;figure-indexing-beyond-the-basics&#34;&gt;&#xA;  &lt;div class=&#34;d-flex justify-content-center&#34;&gt;&#xA;    &lt;div class=&#34;w-100&#34; &gt;&lt;img alt=&#34;indexing&#34; srcset=&#34;&#xA;               /2024/02/12/recommandations-de-lectures-pour-ameliorer-ses-connaissances-en-base-de-donnees-et-postgresql/indexing_hu4ec3b1968fb5d81fd5627bea5287bed7_530622_cd04fe528416e6d69ed46ae57835a97e.webp 400w,&#xA;               /2024/02/12/recommandations-de-lectures-pour-ameliorer-ses-connaissances-en-base-de-donnees-et-postgresql/indexing_hu4ec3b1968fb5d81fd5627bea5287bed7_530622_7b7f71022bce674d799dc5af2cfdb5cb.webp 760w,&#xA;               /2024/02/12/recommandations-de-lectures-pour-ameliorer-ses-connaissances-en-base-de-donnees-et-postgresql/indexing_hu4ec3b1968fb5d81fd5627bea5287bed7_530622_1200x1200_fit_q75_h2_lanczos_3.webp 1200w&#34;&#xA;               src=&#34;https://blog.anayrat.info/2024/02/12/recommandations-de-lectures-pour-ameliorer-ses-connaissances-en-base-de-donnees-et-postgresql/indexing_hu4ec3b1968fb5d81fd5627bea5287bed7_530622_cd04fe528416e6d69ed46ae57835a97e.webp&#34;&#xA;               width=&#34;668&#34;&#xA;               height=&#34;760&#34;&#xA;               loading=&#34;lazy&#34; data-zoomable /&gt;&lt;/div&gt;&#xA;  &lt;/div&gt;&lt;figcaption&gt;&#xA;      Indexing Beyond the Basics&#xA;    &lt;/figcaption&gt;&lt;/figure&gt;&#xA;&lt;/p&gt;&#xA;&lt;p&gt;Niveau : Débutant - Intermédiaire&lt;/p&gt;&#xA;&lt;p&gt;&lt;a href=&#34;https://sqlfordevs.com/ebooks/indexing&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Indexing Beyond the Basics&lt;/a&gt; est un e-book orienté sur les index. Un point intéressant est qu&amp;rsquo;il mentionne aussi pourquoi le moteur n&amp;rsquo;utilise pas un index.&lt;/p&gt;&#xA;&lt;h1 id=&#34;postgresql&#34;&gt;PostgreSQL&lt;/h1&gt;&#xA;&lt;h2 id=&#34;practical-sql&#34;&gt;Practical SQL&lt;/h2&gt;&#xA;&lt;p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;figure  id=&#34;figure-practical-sql&#34;&gt;&#xA;  &lt;div class=&#34;d-flex justify-content-center&#34;&gt;&#xA;    &lt;div class=&#34;w-100&#34; &gt;&lt;img alt=&#34;practical&#34; srcset=&#34;&#xA;               /2024/02/12/recommandations-de-lectures-pour-ameliorer-ses-connaissances-en-base-de-donnees-et-postgresql/practical_hu01f19f83ea7b9b959997133246dda201_161098_c3df0446f9f62391d13c57dd10ec2e89.webp 400w,&#xA;               /2024/02/12/recommandations-de-lectures-pour-ameliorer-ses-connaissances-en-base-de-donnees-et-postgresql/practical_hu01f19f83ea7b9b959997133246dda201_161098_f2aecb321cb118f7fb40dddd50422be5.webp 760w,&#xA;               /2024/02/12/recommandations-de-lectures-pour-ameliorer-ses-connaissances-en-base-de-donnees-et-postgresql/practical_hu01f19f83ea7b9b959997133246dda201_161098_1200x1200_fit_q75_h2_lanczos_2.webp 1200w&#34;&#xA;               src=&#34;https://blog.anayrat.info/2024/02/12/recommandations-de-lectures-pour-ameliorer-ses-connaissances-en-base-de-donnees-et-postgresql/practical_hu01f19f83ea7b9b959997133246dda201_161098_c3df0446f9f62391d13c57dd10ec2e89.webp&#34;&#xA;               width=&#34;477&#34;&#xA;               height=&#34;630&#34;&#xA;               loading=&#34;lazy&#34; data-zoomable /&gt;&lt;/div&gt;&#xA;  &lt;/div&gt;&lt;figcaption&gt;&#xA;      Practical SQL&#xA;    &lt;/figcaption&gt;&lt;/figure&gt;&#xA;&lt;/p&gt;&#xA;&lt;p&gt;Niveau : Débutant - intermédiaire&lt;/p&gt;&#xA;&lt;p&gt;&lt;a href=&#34;https://nostarch.com/practical-sql-2nd-edition/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Practical SQL&lt;/a&gt; est un super livre pour quelqu&amp;rsquo;un qui débute sur Postgres. Il parle d&amp;rsquo;un peu de tout, du SQL jusqu&amp;rsquo;aux types avancés. Comment utiliser le SQL pour analyser des données, faire du &lt;em&gt;full text search&lt;/em&gt;, opération d&amp;rsquo;administration&amp;hellip;&lt;/p&gt;&#xA;&lt;h2 id=&#34;postgresql---architecture-et-notions-avancées&#34;&gt;PostgreSQL - Architecture et notions avancées&lt;/h2&gt;&#xA;&lt;p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;figure  id=&#34;figure-postgresql---architecture-et-notions-avancées&#34;&gt;&#xA;  &lt;div class=&#34;d-flex justify-content-center&#34;&gt;&#xA;    &lt;div class=&#34;w-100&#34; &gt;&lt;img alt=&#34;architecture&#34; srcset=&#34;&#xA;               /2024/02/12/recommandations-de-lectures-pour-ameliorer-ses-connaissances-en-base-de-donnees-et-postgresql/architecture_hu4e070f54fbcfe012d689b7262a78d531_408340_8da2fb9ff08beb89b92a47f2af0154cc.webp 400w,&#xA;               /2024/02/12/recommandations-de-lectures-pour-ameliorer-ses-connaissances-en-base-de-donnees-et-postgresql/architecture_hu4e070f54fbcfe012d689b7262a78d531_408340_504568017e4d0ef28b5f0f36871185ec.webp 760w,&#xA;               /2024/02/12/recommandations-de-lectures-pour-ameliorer-ses-connaissances-en-base-de-donnees-et-postgresql/architecture_hu4e070f54fbcfe012d689b7262a78d531_408340_1200x1200_fit_q75_h2_lanczos_3.webp 1200w&#34;&#xA;               src=&#34;https://blog.anayrat.info/2024/02/12/recommandations-de-lectures-pour-ameliorer-ses-connaissances-en-base-de-donnees-et-postgresql/architecture_hu4e070f54fbcfe012d689b7262a78d531_408340_8da2fb9ff08beb89b92a47f2af0154cc.webp&#34;&#xA;               width=&#34;559&#34;&#xA;               height=&#34;760&#34;&#xA;               loading=&#34;lazy&#34; data-zoomable /&gt;&lt;/div&gt;&#xA;  &lt;/div&gt;&lt;figcaption&gt;&#xA;      PostgreSQL - Architecture et notions avancées&#xA;    &lt;/figcaption&gt;&lt;/figure&gt;&#xA;&lt;/p&gt;&#xA;&lt;p&gt;Niveau : Intermédiaire - avancé&lt;/p&gt;&#xA;&lt;p&gt;&lt;a href=&#34;https://www.d-booker.fr/bases-de-donnees/805-1338-postgresql-architecture-et-notions-avancees-5ed.html#/21-option-consultation_en_ligne&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;PostgreSQL - Architecture et notions avancées&lt;/a&gt; par Guillaume Lelarge et Julien Rouhaud est &lt;strong&gt;le&lt;/strong&gt; livre que je recommande pour qui veut comprendre comment fonctionne Postgres. Mon seul regret est qu&amp;rsquo;il ne soit pas traduit en anglais pour en faire profiter plus de lecteurs.&lt;/p&gt;&#xA;&lt;p&gt;À noter aussi qu&amp;rsquo;il est mis à jour tous les ans.&lt;/p&gt;&#xA;&lt;h2 id=&#34;learn-postgresql&#34;&gt;Learn PostgreSQL&lt;/h2&gt;&#xA;&lt;p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;figure  id=&#34;figure-learn-postgresql&#34;&gt;&#xA;  &lt;div class=&#34;d-flex justify-content-center&#34;&gt;&#xA;    &lt;div class=&#34;w-100&#34; &gt;&lt;img alt=&#34;learn&#34; srcset=&#34;&#xA;               /2024/02/12/recommandations-de-lectures-pour-ameliorer-ses-connaissances-en-base-de-donnees-et-postgresql/learn_hu00fe0c0efabc0ae6d85710a22f715230_111765_2e08c564415b06ee6ac817f7ac0914b0.webp 400w,&#xA;               /2024/02/12/recommandations-de-lectures-pour-ameliorer-ses-connaissances-en-base-de-donnees-et-postgresql/learn_hu00fe0c0efabc0ae6d85710a22f715230_111765_c22b1c79c1fe1d43eb51d2ce83b5ee11.webp 760w,&#xA;               /2024/02/12/recommandations-de-lectures-pour-ameliorer-ses-connaissances-en-base-de-donnees-et-postgresql/learn_hu00fe0c0efabc0ae6d85710a22f715230_111765_1200x1200_fit_q75_h2_lanczos.webp 1200w&#34;&#xA;               src=&#34;https://blog.anayrat.info/2024/02/12/recommandations-de-lectures-pour-ameliorer-ses-connaissances-en-base-de-donnees-et-postgresql/learn_hu00fe0c0efabc0ae6d85710a22f715230_111765_2e08c564415b06ee6ac817f7ac0914b0.webp&#34;&#xA;               width=&#34;616&#34;&#xA;               height=&#34;760&#34;&#xA;               loading=&#34;lazy&#34; data-zoomable /&gt;&lt;/div&gt;&#xA;  &lt;/div&gt;&lt;figcaption&gt;&#xA;      Learn PostgreSQL&#xA;    &lt;/figcaption&gt;&lt;/figure&gt;&#xA;&lt;/p&gt;&#xA;&lt;p&gt;&lt;a href=&#34;https://www.packtpub.com/product/learn-postgresql-second-edition/9781837635641&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Learn PostgreSQL&lt;/a&gt; par Lucas Ferrari et Enrico Pirozzi est un livre très complet sur l&amp;rsquo;administration de Postgres. Un &lt;em&gt;must have&lt;/em&gt; pour un DBA.&lt;/p&gt;&#xA;&lt;p&gt;Pour les francophones, vous pouvez vous orienter vers &lt;a href=&#34;https://www.editions-eni.fr/livre/postgresql-administration-et-exploitation-de-vos-bases-de-donnees-4e-edition-9782409011467&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;PostgreSQL Administration et exploitation de vos bases de données&lt;/a&gt; de Sébastien Lardière.&lt;/p&gt;&#xA;&lt;h2 id=&#34;postgresql-14-internals&#34;&gt;PostgreSQL 14 Internals&lt;/h2&gt;&#xA;&lt;p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;figure  id=&#34;figure-postgresql-14-internals&#34;&gt;&#xA;  &lt;div class=&#34;d-flex justify-content-center&#34;&gt;&#xA;    &lt;div class=&#34;w-100&#34; &gt;&lt;img alt=&#34;internals&#34; srcset=&#34;&#xA;               /2024/02/12/recommandations-de-lectures-pour-ameliorer-ses-connaissances-en-base-de-donnees-et-postgresql/internals_hu8a8cf4e0b43f0fa4f74d2b36d2f27852_60433_8639f0d8b0e15fe8fb464f6e5412e100.webp 400w,&#xA;               /2024/02/12/recommandations-de-lectures-pour-ameliorer-ses-connaissances-en-base-de-donnees-et-postgresql/internals_hu8a8cf4e0b43f0fa4f74d2b36d2f27852_60433_3d76ec668fd76ab0113449dbb278d740.webp 760w,&#xA;               /2024/02/12/recommandations-de-lectures-pour-ameliorer-ses-connaissances-en-base-de-donnees-et-postgresql/internals_hu8a8cf4e0b43f0fa4f74d2b36d2f27852_60433_1200x1200_fit_q75_h2_lanczos.webp 1200w&#34;&#xA;               src=&#34;https://blog.anayrat.info/2024/02/12/recommandations-de-lectures-pour-ameliorer-ses-connaissances-en-base-de-donnees-et-postgresql/internals_hu8a8cf4e0b43f0fa4f74d2b36d2f27852_60433_8639f0d8b0e15fe8fb464f6e5412e100.webp&#34;&#xA;               width=&#34;384&#34;&#xA;               height=&#34;552&#34;&#xA;               loading=&#34;lazy&#34; data-zoomable /&gt;&lt;/div&gt;&#xA;  &lt;/div&gt;&lt;figcaption&gt;&#xA;      PostgreSQL 14 Internals&#xA;    &lt;/figcaption&gt;&lt;/figure&gt;&#xA;&lt;/p&gt;&#xA;&lt;p&gt;&lt;a href=&#34;https://postgrespro.com/community/books/internals&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;PostgreSQL 14 Internals&lt;/a&gt; par Egor Rogov est un livre sur les entrailles de Postgres. Il est vraiment très complet. Un grand merci à lui de le mettre à disposition en accès libre.&lt;/p&gt;&#xA;&lt;p&gt;Dans le même style, il existe un site &lt;a href=&#34;https://www.interdb.jp/pg/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;The Internals of PostgreSQL&lt;/a&gt; par Hironobu SUZUKI.&lt;/p&gt;</summary>
    <author>
      <name>blog.anayrat.info</name>
    </author>
  </entry>
  <entry>
    <title>Postgres à nouveau élu SGBD de l&#39;année en 2023, mais je suis inquiet</title>
    <updated>2024-02-05T08:00:00Z</updated>
    <id>tag:blog.anayrat.info,2024-02-05:/2024/02/05/postgres-a-nouveau-elu-sgbd-de-lannee-en-2023-mais-je-suis-inquiet/</id>
    <link href="https://blog.anayrat.info/2024/02/05/postgres-a-nouveau-elu-sgbd-de-lannee-en-2023-mais-je-suis-inquiet/" rel="alternate"></link>
    <summary type="html">&lt;p&gt;Cette année encore, Postgres a été élu SGBD de l&amp;rsquo;année par &lt;a href=&#34;https://db-engines.com/en/blog_post/106&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;DB-Engines&lt;/a&gt;. Même si ce n&amp;rsquo;est qu&amp;rsquo;un classement, cela donne une tendance. Cela fait aussi plusieurs années qu&amp;rsquo;il est reconnu selon&#xA;les sondages de Stackoverflow : &lt;a href=&#34;https://survey.stackoverflow.co/2023/#section-most-popular-technologies-databases&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Most popular Databases&lt;/a&gt;.&#xA;C&amp;rsquo;est un SGBD très apprécié, tant par les développeurs, que par les DBA chevronnés&amp;hellip; Mais aussi par les directeurs qui y trouvent une stabilité&lt;sup id=&#34;fnref:1&#34;&gt;&lt;a href=&#34;#fn:1&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;1&lt;/a&gt;&lt;/sup&gt;.&lt;/p&gt;&#xA;&lt;p&gt;Postgres a tout pour séduire :&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Année après année, de nouvelles fonctionnalités sont rajoutées. Je pense notamment à : la parallélisation, le partitionnement, la réplication logique&amp;hellip;&lt;/li&gt;&#xA;&lt;li&gt;Il a su, depuis toujours, garder sa fiabilité.&lt;/li&gt;&#xA;&lt;li&gt;Sa communauté n&amp;rsquo;a fait que grandir. Les conférences dédiées à Postgres battent des records d&amp;rsquo;affluence tous les ans.&lt;sup id=&#34;fnref:2&#34;&gt;&lt;a href=&#34;#fn:2&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;2&lt;/a&gt;&lt;/sup&gt;&lt;/li&gt;&#xA;&lt;li&gt;C&amp;rsquo;est devenu un standard, même pour les autres logiciels : les éditeurs rajoutent même le support du protocole Postgres pour faciliter leur intégration : Aurora, AlloyDB, QuestDB&amp;hellip;&lt;/li&gt;&#xA;&lt;li&gt;C&amp;rsquo;est un des rares projets de cette envergure à être communautaire. On a pu voir qu&amp;rsquo;il ne suffit pas que le projet soit opensource, il faut aussi compter sur la communauté et son écosystème.&lt;/li&gt;&#xA;&lt;li&gt;Il est supporté par les gros acteurs : les GAFAM emploient de nombreux committers et contributeurs. Ils sponsorisent également les conférences. Par exemple, le prochain &lt;a href=&#34;https://2024.pgday.paris/sponsors/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;pgDay Paris est sponsorisé par Microsoft&lt;/a&gt;.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;Cependant, je suis un peu inquiet pour le futur. Non pas pour PostgreSQL. Bruce Momjian a fait plusieurs présentations sur ce sujet :&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://momjian.us/main/writings/pgsql/challenges.pdf&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Future Postgres Challenges&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://momjian.us/main/writings/pgsql/forever.pdf&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Will Postgres Live Forever?&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://momjian.us/main/writings/pgsql/past_present_future.pdf&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;PostgreSQL: Past, Present, and Future&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;C&amp;rsquo;est même le sujet de la Keynote d&amp;rsquo;ouverture du dernier PGConf Europe : &lt;a href=&#34;https://www.youtube.com/watch?v=8W-J36IxYv4&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Simon Riggs: The Next 20 Years (PGConf.EU 2023)&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;Non, je suis plutôt inquiet sur la perte de connaissance du métier de DBA.&lt;/p&gt;&#xA;&lt;p&gt;&lt;strong&gt;A quoi servira Postgres si on ne sait pas l&amp;rsquo;utiliser correctement ?&lt;/strong&gt;&lt;/p&gt;&#xA;&lt;details class=&#34;toc-inpage d-print-none  &#34; open&gt;&#xA;  &lt;summary class=&#34;font-weight-bold&#34;&gt;Table des matières&lt;/summary&gt;&#xA;  &lt;nav id=&#34;TableOfContents&#34;&gt;&#xA;  &lt;ul&gt;&#xA;    &lt;li&gt;&lt;a href=&#34;#un-peu-dhistoire&#34;&gt;Un peu d&amp;rsquo;histoire&lt;/a&gt;&lt;/li&gt;&#xA;    &lt;li&gt;&lt;a href=&#34;#quest-ce-quon-oublie-&#34;&gt;Qu&amp;rsquo;est-ce qu&amp;rsquo;on oublie ?&lt;/a&gt;&lt;/li&gt;&#xA;    &lt;li&gt;&lt;a href=&#34;#oui-mais-le-cloud&#34;&gt;Oui, mais le cloud!&lt;/a&gt;&lt;/li&gt;&#xA;    &lt;li&gt;&lt;a href=&#34;#on-oublie-le-métier-de-dba&#34;&gt;On oublie le métier de DBA&lt;/a&gt;&lt;/li&gt;&#xA;    &lt;li&gt;&lt;a href=&#34;#on-oublie-le-passé&#34;&gt;On oublie le passé&lt;/a&gt;&lt;/li&gt;&#xA;    &lt;li&gt;&lt;a href=&#34;#le-code-change-la-donnée-reste&#34;&gt;Le code change, la donnée reste&lt;/a&gt;&lt;/li&gt;&#xA;    &lt;li&gt;&lt;a href=&#34;#il-faut-quelques-minutes-pour-prendre-une-mauvaise-décision-sur-une-base-de-donnée&#34;&gt;Il faut quelques minutes pour prendre une mauvaise décision sur une base de donnée&lt;/a&gt;&lt;/li&gt;&#xA;    &lt;li&gt;&lt;a href=&#34;#lusage-du-cloud&#34;&gt;L&amp;rsquo;usage du cloud&lt;/a&gt;&lt;/li&gt;&#xA;    &lt;li&gt;&lt;a href=&#34;#ce-quil-faudrait-changer&#34;&gt;Ce qu&amp;rsquo;il faudrait changer&lt;/a&gt;&lt;/li&gt;&#xA;    &lt;li&gt;&lt;a href=&#34;#pour-conclure&#34;&gt;Pour conclure&lt;/a&gt;&lt;/li&gt;&#xA;  &lt;/ul&gt;&#xA;&lt;/nav&gt;&#xA;&lt;/details&gt;&#xA;&lt;h1 id=&#34;un-peu-dhistoire&#34;&gt;Un peu d&amp;rsquo;histoire&lt;/h1&gt;&#xA;&lt;p&gt;Par le passé, il y avait une spécialisation forte des compétences : développeurs, testeurs, DBA étude, DBA prod, ingénieur système, ingénieur stockage, ingénieur sauvegarde&amp;hellip;&lt;/p&gt;&#xA;&lt;p&gt;Chaque spécialité évoluait un peu dans sa bulle, ce qui compliquait la collaboration avec des cycles de développement longs.&lt;/p&gt;&#xA;&lt;p&gt;Cette organisation a laissé place à une nouvelle façon de travailler : développeurs &lt;em&gt;fullstack&lt;/em&gt;, &lt;em&gt;DEVOPS/SRE&lt;/em&gt;, des data &amp;ldquo;quelque chose&amp;rdquo; (engineer, analyst, steward&amp;hellip;).&lt;/p&gt;&#xA;&lt;p&gt;Les compétences se sont diluées sur les différents métiers. Je croise de plus en plus rarement des DBA.&lt;/p&gt;&#xA;&lt;p&gt;A la place, la base de donnée est &lt;em&gt;gérée&lt;/em&gt; par les développeurs. Ou, si on a un peu de chance, par des &amp;ldquo;data engineer&amp;rdquo; ou &amp;ldquo;data analyst&amp;rdquo;.&lt;/p&gt;&#xA;&lt;p&gt;Après plusieurs années, alors que je baigne dedans, j&amp;rsquo;ai encore du mal à définir ces métiers.&lt;/p&gt;&#xA;&lt;p&gt;Le constat : bonne connaissance du python, monte des pipelines, on assemble en quelque sorte des Legos avec pleins d&amp;rsquo;outils : airflow, dbt&amp;hellip; Puis, on envoie ces données dans du Redshift, Biquery, Snowflake&amp;hellip;&lt;/p&gt;&#xA;&lt;p&gt;Cependant, j&amp;rsquo;ai l&amp;rsquo;impression que la connaissance du SQL s&amp;rsquo;appauvrit à cause des couches d&amp;rsquo;abstraction.&lt;/p&gt;&#xA;&lt;p&gt;&lt;strong&gt;Du moment où on manipule de la donnée, la première des compétences à avoir, devrait être la maitrise du SQL.&lt;/strong&gt;&lt;/p&gt;&#xA;&lt;h1 id=&#34;quest-ce-quon-oublie-&#34;&gt;Qu&amp;rsquo;est-ce qu&amp;rsquo;on oublie ?&lt;/h1&gt;&#xA;&lt;p&gt;J&amp;rsquo;ai le sentiment, qu&amp;rsquo;année après année, on oublie le métier de DBA.&lt;/p&gt;&#xA;&lt;p&gt;Pour rappel, ce dernier va être à la croisée de plusieurs chemins :&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Il a des compétences pures sur la base de données :&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Modélisation.&lt;/li&gt;&#xA;&lt;li&gt;Maitrise du SQL.&lt;/li&gt;&#xA;&lt;li&gt;Maitrise du SGBD : connait le fonctionnement du moteur (&lt;em&gt;vacuum&lt;/em&gt;, &lt;em&gt;checkpoint&lt;/em&gt; &amp;hellip;). Comprend les mécanismes de verrouillages (&lt;em&gt;MVCC&lt;/em&gt;, &lt;em&gt;locks&lt;/em&gt;&amp;hellip;).&lt;/li&gt;&#xA;&lt;li&gt;Conserve une veille technique : le Postgres que j&amp;rsquo;ai connu à mes débuts est très loin du Postgres actuel.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;Mais également des compétences plus transverses :&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Avoir une bonne connaissance système pour investiguer sur les problèmes de performance, dimensionner les ressources.&lt;/li&gt;&#xA;&lt;li&gt;Un vernis en développement pour comprendre les besoins des développeurs et pouvoir les accompagner.&lt;/li&gt;&#xA;&lt;li&gt;De la culture &amp;ldquo;computer science&amp;rdquo;.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h1 id=&#34;oui-mais-le-cloud&#34;&gt;Oui, mais le cloud!&lt;/h1&gt;&#xA;&lt;p&gt;On pourrait penser que le cloud a rebattu les cartes et qu&amp;rsquo;on n&amp;rsquo;a plus besoin de DBA. Dans la liste que j&amp;rsquo;ai donnée ci-dessus, quelles compétences sont couvertes par le cloud ?&lt;/p&gt;&#xA;&lt;p&gt;Le cloud résout une partie des besoins : hébergement, maintenance, réseau, monitoring (qu&amp;rsquo;il faut souvent compléter avec un APM ou un Datadog like).&#xA;Et il rajoute d&amp;rsquo;autres problèmes :&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Il faut rajouter un métier de &lt;a href=&#34;https://lota.cloud/finops-cloud-2/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;FinOps&lt;/a&gt; pour maitriser et optimiser les dépenses.&lt;/li&gt;&#xA;&lt;li&gt;C&amp;rsquo;est parfois une boite noire et il peut être difficile d&amp;rsquo;investiguer sur des problèmes de performance&lt;sup id=&#34;fnref:3&#34;&gt;&lt;a href=&#34;#fn:3&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;3&lt;/a&gt;&lt;/sup&gt;.&lt;/li&gt;&#xA;&lt;li&gt;Cet excellent article de Markus Winand présente aussi d&amp;rsquo;autres inconvénients : &lt;a href=&#34;https://winand.at/newsletter/2024-01/clouds-bring-rain&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Sometimes Clouds Bring Rain&lt;/a&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Changer de cloud provider est difficile. Je dirais même que c&amp;rsquo;est volontaire de leur part.&lt;/li&gt;&#xA;&lt;li&gt;Les coûts peuvent changer &lt;em&gt;Just because it is cheap today doesn’t mean it will be cheap forever&lt;/em&gt;.&lt;/li&gt;&#xA;&lt;li&gt;Il faut prévoir un plan de sortie : éviter les services propriétaires, conserver un faible nombre de services.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;Car une fois dans le cloud, qui s&amp;rsquo;occupe de : la modélisation, l&amp;rsquo;optimisation des requêtes, l&amp;rsquo;indexation, la veille technique sur le SGBD&lt;sup id=&#34;fnref:4&#34;&gt;&lt;a href=&#34;#fn:4&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;4&lt;/a&gt;&lt;/sup&gt;, l&amp;rsquo;investigation sur les performances, comprendre les problèmes de verrouillages, l&amp;rsquo;accompagnement des développeurs ?&lt;/p&gt;&#xA;&lt;p&gt;Ceci est confirmé dans mes audits, je vois régulièrement des problèmes très basiques :&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Absence de clé primaire.&lt;/li&gt;&#xA;&lt;li&gt;Pas d&amp;rsquo;index sur des cas très simples.&lt;/li&gt;&#xA;&lt;li&gt;Aucun respect des formes normales, même les plus basiques. Le JSON n&amp;rsquo;a pas arrangé les choses.&lt;/li&gt;&#xA;&lt;li&gt;Requêtes spaghetti.&lt;/li&gt;&#xA;&lt;li&gt;Des jointures façon SQL-89 alors que ça fait plus de 30 ans que le mot clé &lt;code&gt;JOIN&lt;/code&gt; existe.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;S&amp;rsquo;il faut retenir une chose : &lt;strong&gt;Le cloud ne permet pas de s&amp;rsquo;affranchir du DBA. Ce n&amp;rsquo;est pas parce qu&amp;rsquo;on peut obtenir les clés d&amp;rsquo;un avion, qu&amp;rsquo;on sait le piloter.&lt;/strong&gt;&lt;/p&gt;&#xA;&lt;p&gt;Un article intéressant sur le nombre de DBA dont vous avez besoin : &lt;a href=&#34;https://www.bytebase.com/blog/how-many-dbas-should-a-company-hire/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;How many DBAs should a company hire?&lt;/a&gt;.&lt;/p&gt;&#xA;&lt;h1 id=&#34;on-oublie-le-métier-de-dba&#34;&gt;On oublie le métier de DBA&lt;/h1&gt;&#xA;&lt;p&gt;On pourrait naïvement penser qu&amp;rsquo;on confie ces tâches à des DBA experts, mais j&amp;rsquo;ai de plus en plus de doutes. J&amp;rsquo;ai l&amp;rsquo;impression &amp;ldquo;qu&amp;rsquo;on&amp;rdquo; est en train de perdre la connaissance d&amp;rsquo;un métier.&#xA;J&amp;rsquo;ai déjà croisé des développeurs expérimentés qui ne savaient même pas que le métier de DBA existait.&#xA;Des recruteurs qui me demandaient si en tant que DBA, je savais optimiser des requêtes et si je connaissais le SQL. C&amp;rsquo;est mon métier ! C&amp;rsquo;est un peu comme demander à un plombier s&amp;rsquo;il sait changer un robinet !&lt;/p&gt;&#xA;&lt;p&gt;Ce qui est d&amp;rsquo;autant plus alarmant, c&amp;rsquo;est que je crains qu&amp;rsquo;il y ait aussi des CTO qui ont aussi cette méconnaissance de la donnée.&lt;/p&gt;&#xA;&lt;p&gt;La conséquence est qu&amp;rsquo;en cas de problème de performance, on ne fait qu&amp;rsquo;augmenter les ressources des instances.&#xA;Avec le cloud, la facture croît linéairement avec la taille de l&amp;rsquo;instance.&#xA;Si la croissance de la charge est exponentielle, il faudra scaler la base et la facture qui va avec. On se retrouve avec une facture exponentielle.&lt;/p&gt;&#xA;&lt;p&gt;Quand on n&amp;rsquo;arrive plus à s&amp;rsquo;en sortir, on va accuser l&amp;rsquo;outil ou le modèle, donc on va changer de SGBD ou aller vers du NoSQL. Spoiler : ça ne résoudra pas vos problèmes.&lt;/p&gt;&#xA;&lt;h1 id=&#34;on-oublie-le-passé&#34;&gt;On oublie le passé&lt;/h1&gt;&#xA;&lt;p&gt;Pendant un temps, j&amp;rsquo;ai voulu écrire un livre pour parler optimisation de requête, des erreurs courantes que je rencontre, etc.&lt;/p&gt;&#xA;&lt;p&gt;En regardant ma bibliothèque, elle est pleine de livres de ce genre. Ils ont pour la plupart entre 10 et 30 ans et le contenu est toujours d&amp;rsquo;actualité. A quoi servirait un énième livre s&amp;rsquo;il n&amp;rsquo;est pas connu ?&lt;/p&gt;&#xA;&lt;p&gt;J&amp;rsquo;ai un autre exemple en tête : les data warehouse (DWH). Ce terme devient de plus en plus galvaudé.&#xA;La construction d&amp;rsquo;un DWH est complexe, il faut passer par une phase de modélisation afin de stocker correctement les données. Cela permet de bonnes performances et facilite l&amp;rsquo;écriture&#xA;des requêtes analytiques.&lt;/p&gt;&#xA;&lt;p&gt;Maintenant, je croise régulièrement des &amp;ldquo;data warehouse&amp;rdquo; qui se résument à envoyer toutes les données dans un SGBD spécialisé (redshift, biquery &amp;hellip;). Sans travail de modélisation et avec des requêtes très mal écrites, parfois générées, car les utilisateurs ne savent pas faire du SQL.&lt;/p&gt;&#xA;&lt;p&gt;Ces services coûtent très cher et ne font pas de miracle s&amp;rsquo;il n&amp;rsquo;y a pas eu un travail approfondi de modélisation et d&amp;rsquo;optimisation.&lt;/p&gt;&#xA;&lt;p&gt;Pourtant, les livres sur les DWH et le SQL ont entre 10 et 30 ans. A cette époque, le cloud n&amp;rsquo;existait pas, les SSD non plus, les CPU avec plusieurs coeurs non plus.&#xA;Pourtant, on savait construire des DWH, faire des sites performants&amp;hellip;&lt;/p&gt;&#xA;&lt;p&gt;&lt;strong&gt;Il ne faudrait pas que le cloud nous fasse oublier tout cet héritage. Sinon, on risque de payer la dette technique et la perte de connaissance très cher, avec les intérêts en plus.&lt;/strong&gt;&lt;/p&gt;&#xA;&lt;p&gt;Il faut avoir en tête que même si le SQL a évolué, les SGBD gagnés en fonctionnalités, &lt;strong&gt;les principes fondateurs sont toujours justes&lt;/strong&gt;.&lt;/p&gt;&#xA;&lt;h1 id=&#34;le-code-change-la-donnée-reste&#34;&gt;Le code change, la donnée reste&lt;/h1&gt;&#xA;&lt;p&gt;J&amp;rsquo;ai eu un super manager, ancien DBA, qui expliquait aux développeurs : tu n&amp;rsquo;es pas ici pour &amp;ldquo;produire du code&amp;rdquo; =&amp;gt; yeux écarquillés du développeur.&#xA;&amp;ldquo;tu es là pour produire et manipuler de la donnée.&amp;rdquo;&lt;/p&gt;&#xA;&lt;p&gt;Lorsqu&amp;rsquo;il y avait une décision compliquée. Par exemple, prendre plus de temps pour revoir le code applicatif, faire une migration plus compliquée, plutôt qu&amp;rsquo;une solution&#xA;&amp;ldquo;quick win&amp;rdquo;. Ce même manager expliquait :&amp;quot;&lt;/p&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;D&amp;rsquo;ici 5-10 ans, ton code aura été réécrit plusieurs fois, peut-être même dans un autre langage.&#xA;Nous, la donnée, dans 50 ans, elle sera toujours là. C&amp;rsquo;est notre devoir de nous assurer qu&amp;rsquo;elle sera toujours exploitable.&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;h1 id=&#34;il-faut-quelques-minutes-pour-prendre-une-mauvaise-décision-sur-une-base-de-donnée&#34;&gt;Il faut quelques minutes pour prendre une mauvaise décision sur une base de donnée&lt;/h1&gt;&#xA;&lt;p&gt;&lt;em&gt;Et parfois plusieurs mois / années pour la corriger.&lt;/em&gt;&lt;/p&gt;&#xA;&lt;p&gt;Il m&amp;rsquo;est arrivé de faire des audits où le modèle était catastrophique. Il avait évolué de solutions à court terme en d&amp;rsquo;autres solutions à court terme.&#xA;&amp;ldquo;On corrigera plus tard, il faut faire passer cette fonctionnalité dans le sprint&amp;rdquo;.&lt;/p&gt;&#xA;&lt;p&gt;Un DBA peut corriger le modèle de données à coup de grosses migrations (encore faut-il avoir un DBA, difficile si on ignore que ce métier existe&amp;hellip;).&#xA;Au-delà de ça, le problème va se poser autour : il faut réécrire une grosse partie du code applicatif (qui est souvent dans le même état que la base).&lt;/p&gt;&#xA;&lt;p&gt;Parfois, la complexité est quadratique ou exponentielle. Il vaut mieux tout jeter pour tout recommencer.&lt;/p&gt;&#xA;&lt;p&gt;On se retrouve face à plusieurs dilemmes :&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Augmenter la taille des instances.&lt;/li&gt;&#xA;&lt;li&gt;Parfois, cette solution n&amp;rsquo;est pas suffisante. J&amp;rsquo;explique : &amp;ldquo;là, vous pouvez faire encore fois dix sur la taille de l&amp;rsquo;instance, mais vous ne pourrez jouer cette carte qu&amp;rsquo;une fois&amp;rdquo;. Notez que cette solution est inutile si le traitement ne peut pas être parallélisé.&lt;/li&gt;&#xA;&lt;li&gt;Tout jeter pour tout recommencer. Là aussi, le coût ou la perte peut être démentielle.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;Alors qu&amp;rsquo;il aurait suffi des conseils d&amp;rsquo;un DBA à quelques moments de la vie du projet pour éviter de partir dans une mauvaise direction.&lt;/p&gt;&#xA;&lt;p&gt;&lt;strong&gt;On ne bâtit pas un château sur du sable&lt;/strong&gt;. J&amp;rsquo;ai une anecdote en tête, une personne de mon entourage m&amp;rsquo;a raconté une histoire d&amp;rsquo;un bâtiment qui avait été contrôlé au moment de la livraison :&lt;/p&gt;&#xA;&lt;p&gt;Un prélèvement avait été fait dans les murs et il n&amp;rsquo;y avait pas assez de ciment, le bâtiment, &lt;strong&gt;neuf&lt;/strong&gt;, pouvait s&amp;rsquo;écrouler. Il venait d&amp;rsquo;être totalement terminé, électricité, plomberie, menuiseries&amp;hellip; Tout était terminé.&#xA;Il a dû être rasé complètement. Autant il existe des assurances dans le bâtiment, mais pas pour le développement&amp;hellip;&#xA;Je pense que certaines sociétés ne survivent pas si la dette technique est trop importante.&lt;/p&gt;&#xA;&lt;h1 id=&#34;lusage-du-cloud&#34;&gt;L&amp;rsquo;usage du cloud&lt;/h1&gt;&#xA;&lt;p&gt;Le cloud a de nombreux avantages :&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;On peut rapidement obtenir des bases de données avec une installation relativement propre.&lt;/li&gt;&#xA;&lt;li&gt;Le cloud provider vous obligera à rester sur des versions supportées.&lt;/li&gt;&#xA;&lt;li&gt;&amp;ldquo;Écologiquement&amp;rdquo;, cela permet de mutualiser des ressources physiques. Mais c&amp;rsquo;est aussi une faiblesse. L&amp;rsquo;accès facile à ces ressources peut aussi entrainer un gaspillage. On peut facilement déployer&#xA;une centaine d&amp;rsquo;instances. Là, où avec une infrastructure &lt;em&gt;on-premise&lt;/em&gt;, il faut concilier avec les ressources physiques à disposition : puissance des serveurs, puissance électrique, espace dans les baies&amp;hellip;&lt;/li&gt;&#xA;&lt;li&gt;On paye ce qu&amp;rsquo;on consomme. On peut facilement identifier combien coute un service. Qu&amp;rsquo;une requête est responsable de 80% de la facture. Ce qui peut inciter à l&amp;rsquo;optimiser, le gain financier est immédiat. Encore faut-il qu&amp;rsquo;il y ait des personnes qui s&amp;rsquo;y intéressent.&#xA;Je n&amp;rsquo;ai pas l&amp;rsquo;impression qu&amp;rsquo;il y ait beaucoup de FinOps. S&amp;rsquo;il y en a, est-ce que ces derniers pensent à optimiser la base ?&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;Mais il y a aussi de vrais inconvénients :&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Perte de souveraineté numérique. A cela s&amp;rsquo;ajoute des risques juridiques. Comment garantir que vos données ne sont pas stockées ailleurs ? Si vous avez choisi un service managé, comment en sortir si la législation vous impose d&amp;rsquo;être sur le sol Français ou d&amp;rsquo;un autre pays ?&lt;/li&gt;&#xA;&lt;li&gt;Perte de compétences.&lt;/li&gt;&#xA;&lt;li&gt;Dépendance à un cloud provider : encore que sur ce point, on voit émerger de nouvelles offres &amp;ldquo;cloud agnostique&amp;rdquo; : Des sociétés créent un cloud par-dessus un autre cloud.&#xA;Je pense notamment à &lt;a href=&#34;https://aiven.io/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Aiven&lt;/a&gt;, &lt;a href=&#34;https://www.enterprisedb.com/docs/biganimal/latest/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;EDB BigAnimal&lt;/a&gt;, &lt;a href=&#34;https://www.crunchydata.com/products/crunchy-bridge&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Crunchy Bridge&lt;/a&gt; et j&amp;rsquo;en oublie certainement&amp;hellip;&lt;sup id=&#34;fnref:5&#34;&gt;&lt;a href=&#34;#fn:5&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;5&lt;/a&gt;&lt;/sup&gt;&lt;/li&gt;&#xA;&lt;li&gt;Les couts décollent quand l&amp;rsquo;infrastructure est importante. Certains commencent à quitter le cloud. Je pense notamment à Basecamp :&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://world.hey.com/dhh/why-we-re-leaving-the-cloud-654b47e0&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Why we&amp;rsquo;re leaving the cloud&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://world.hey.com/dhh/we-stand-to-save-7m-over-five-years-from-our-cloud-exit-53996caa&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;We stand to save $7m over five years from our cloud exit&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://world.hey.com/dhh/the-big-cloud-exit-faq-20274010&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;The Big Cloud Exit FAQ&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h1 id=&#34;ce-quil-faudrait-changer&#34;&gt;Ce qu&amp;rsquo;il faudrait changer&lt;/h1&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Redonner de la valeur à la donnée : des sociétés rechignent à faire appel à des DBA ou prendre des contrats de supports sur leur base. Quel est le cout d&amp;rsquo;une indisponibilité de service, d&amp;rsquo;une corruption de donnée, d&amp;rsquo;une perte de la base ?&lt;/li&gt;&#xA;&lt;li&gt;Réinvestir le champ des compétences en base de donnée : SQL, modélisation&lt;sup id=&#34;fnref:6&#34;&gt;&lt;a href=&#34;#fn:6&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;6&lt;/a&gt;&lt;/sup&gt;. A ce sujet, j&amp;rsquo;aime beaucoup le titre de Markus Winand : &lt;a href=&#34;https://winand.at/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;SQL Renaissance Ambassador&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;S&amp;rsquo;attarder un peu plus sur l&amp;rsquo;usage des ressources : la consommation du numérique est importante, si les serveurs et l&amp;rsquo;électricité étaient plus chers, on serait contraint d&amp;rsquo;optimiser.&lt;/li&gt;&#xA;&lt;li&gt;Surveiller les dépenses sur les bases. Que ça soit dans le cloud, mais également on-premise. Pour cela, il faut avoir des indicateurs de couts.&lt;/li&gt;&#xA;&lt;li&gt;Penser pas à faire appel à des DBA pour anticiper les problèmes et investiguer sur les problèmes de performance : J&amp;rsquo;ai audité des bases dans un état catastrophique, ça aurait pu être évité si un DBA était intervenu dans la phase de modélisation. Sur les problèmes de performance, il m&amp;rsquo;est déjà arrivé de diviser des factures de cloud par 10 ou de baisser la charge moyenne de 80% à 5% avec un suivi régulier.&lt;/li&gt;&#xA;&lt;li&gt;Il ne faut pas se résigner à payer de grosses factures cloud plutôt que d&amp;rsquo;investir dans de la compétence de DBA.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h1 id=&#34;pour-conclure&#34;&gt;Pour conclure&lt;/h1&gt;&#xA;&lt;p&gt;C&amp;rsquo;est un article moins technique par rapport à ce que vous avez l&amp;rsquo;habitude de lire sur mon blog.&#xA;Cependant, c&amp;rsquo;est un des plus importants que j&amp;rsquo;ai été amené à écrire.&#xA;Ca fait plus de dix ans que je fais du Postgres et je réalise que la tendance ne va pas dans la bonne direction.&#xA;J&amp;rsquo;espère qu&amp;rsquo;il y aura une prise de conscience pour un avenir plus durable des bases de données.&lt;/p&gt;&#xA;&lt;div class=&#34;footnotes&#34; role=&#34;doc-endnotes&#34;&gt;&#xA;&lt;hr&gt;&#xA;&lt;ol&gt;&#xA;&lt;li id=&#34;fn:1&#34;&gt;&#xA;&lt;p&gt;Ainsi que dans le public, il est dans le &lt;a href=&#34;https://code.gouv.fr/data/sill.pdf&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Socle interministériel de logiciels libres&lt;/a&gt;.&amp;#160;&lt;a href=&#34;#fnref:1&#34; class=&#34;footnote-backref&#34; role=&#34;doc-backlink&#34;&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li id=&#34;fn:2&#34;&gt;&#xA;&lt;p&gt;&lt;a href=&#34;https://twitter.com/pgconfeu/status/1734860251390750980&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;720 personnes à la PGEurope 2023&lt;/a&gt;&amp;#160;&lt;a href=&#34;#fnref:2&#34; class=&#34;footnote-backref&#34; role=&#34;doc-backlink&#34;&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li id=&#34;fn:3&#34;&gt;&#xA;&lt;p&gt;&lt;a href=&#34;https://www.datadoghq.com/blog/aws-ebs-latency-and-iops-the-surprising-truth/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;AWS EBS latency and IOPS: The surprising truth&lt;/a&gt;&lt;/p&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;Ultimately, due to AWS’ opacity, there is simply no way to know how much throughput (from the physical disks and from the network that sits in-between) to expect for a given EBS volume. Provisioned IOPS only offer a partial solution to this issue, at a higher hourly cost.&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&amp;#160;&lt;a href=&#34;#fnref:3&#34; class=&#34;footnote-backref&#34; role=&#34;doc-backlink&#34;&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li id=&#34;fn:4&#34;&gt;&#xA;&lt;p&gt;Le Postgres actuel est très loin du Postgres avec lequel j&amp;rsquo;ai débuté :&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Nouvelles fonctionnalités liées au standard SQL : JSONPath par exemple. &lt;a href=&#34;https://winand.at/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Markus Winand&lt;/a&gt; est l&amp;rsquo;auteur d&amp;rsquo;un super site à ce sujet: &lt;a href=&#34;https://modern-sql.com/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Modern SQL&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;Nouvelles fonctionnalités sur le moteur : parallélisme, partitionnement, nouveaux noeuds d&amp;rsquo;exécution, réplication logique&amp;hellip;&lt;/li&gt;&#xA;&lt;li&gt;La conséquence est un nombre de paramètres qui augmente au fur et à mesure.&lt;/li&gt;&#xA;&lt;li&gt;De nouvelles extensions.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&amp;#160;&lt;a href=&#34;#fnref:4&#34; class=&#34;footnote-backref&#34; role=&#34;doc-backlink&#34;&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li id=&#34;fn:5&#34;&gt;&#xA;&lt;p&gt;Je n&amp;rsquo;ai pas travaillé avec ces offres, je n&amp;rsquo;ai pas de recul dessus. On peut néanmoins souligner que ces sociétés emploient des développeurs qui contribuent à Postgres.&amp;#160;&lt;a href=&#34;#fnref:5&#34; class=&#34;footnote-backref&#34; role=&#34;doc-backlink&#34;&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li id=&#34;fn:6&#34;&gt;&#xA;&lt;p&gt;Il y a quelques années, un article était tiré d&amp;rsquo;une conférence.&lt;/p&gt;&#xA;&lt;p&gt;Le titre est particulièrement juste : &lt;a href=&#34;https://www.citusdata.com/blog/2018/03/19/postgres-database-constraints&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Database constraints in Postgres: The last line of defense&lt;/a&gt;.&#xA;Voici la vidéo de la conférence : &lt;a href=&#34;https://www.youtube.com/watch?v=hWh8QoV8z8k&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Constraints: a Developer&amp;rsquo;s Secret Weapon - Will Leinweber&lt;/a&gt;&#xA;et ses &lt;a href=&#34;https://www.postgresql.eu/events/pgdayparis2018/sessions/session/1835/slides/70/2018-03-15%20constraints%20a%20developers%20secret%20weapon%20pgday%20paris.pdf&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;slides&lt;/a&gt;.&amp;#160;&lt;a href=&#34;#fnref:6&#34; class=&#34;footnote-backref&#34; role=&#34;doc-backlink&#34;&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&lt;/div&gt;</summary>
    <author>
      <name>blog.anayrat.info</name>
    </author>
  </entry>
  <entry>
    <title>Optimisation du GROUP BY</title>
    <updated>2024-01-26T09:00:00Z</updated>
    <id>tag:blog.anayrat.info,2024-01-26:/2024/01/26/optimisation-du-group-by/</id>
    <link href="https://blog.anayrat.info/2024/01/26/optimisation-du-group-by/" rel="alternate"></link>
    <summary type="html">&lt;p&gt;Un commit a attiré mon attention lors de ma veille technique :&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-diff&#34; data-lang=&#34;diff&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;commit 0452b461bc405e6d35d8a14c02813c15e28ae516&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;Author:     Alexander Korotkov &amp;lt;akorotkov@postgresql.org&amp;gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;AuthorDate: Sun Jan 21 22:21:36 2024 +0200&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;Commit:     Alexander Korotkov &amp;lt;akorotkov@postgresql.org&amp;gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;CommitDate: Sun Jan 21 22:21:36 2024 +0200&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    Explore alternative orderings of group-by pathkeys during optimization.&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    When evaluating a query with a multi-column GROUP BY clause, we can minimize&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    sort operations or avoid them if we synchronize the order of GROUP BY clauses&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    with the ORDER BY sort clause or sort order, which comes from the underlying&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    query tree. Grouping does not imply any ordering, so we can compare&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    the keys in arbitrary order, and a Hash Agg leverages this. But for Group Agg,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    we simply compared keys in the order specified in the query. This commit&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    explores alternative ordering of the keys, trying to find a cheaper one.&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    The ordering of group keys may interact with other parts of the query, some of&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    which may not be known while planning the grouping. For example, there may be&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    an explicit ORDER BY clause or some other ordering-dependent operation higher up&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    in the query, and using the same ordering may allow using either incremental&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    sort or even eliminating the sort entirely.&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    The patch always keeps the ordering specified in the query, assuming the user&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    might have additional insights.&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    This introduces a new GUC enable_group_by_reordering so that the optimization&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    may be disabled if needed.&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    Discussion: https://postgr.es/m/7c79e6a5-8597-74e8-0671-1c39d124c9d6%40sigaev.ru&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    Author: Andrei Lepikhov, Teodor Sigaev&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    Reviewed-by: Tomas Vondra, Claudio Freire, Gavin Flower, Dmitry Dolgov&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    Reviewed-by: Robert Haas, Pavel Borisov, David Rowley, Zhihong Yu&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    Reviewed-by: Tom Lane, Alexander Korotkov, Richard Guo, Alena Rybakina&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;On remarque le message du commit assez explicite en mentionnant les personnes impliquées (12 relecteurs!) ainsi que le lien vers la discussion :&#xA;&lt;a href=&#34;https://www.postgresql.org/message-id/flat/7c79e6a5-8597-74e8-0671-1c39d124c9d6%40sigaev.ru&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;POC: GROUP BY optimization&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;Les travaux ont commencé en 2018! Il aura fallu 5 ans et demi pour aboutir à ce commit. C&amp;rsquo;est le fruit de nombreux échanges afin de parvenir à un consensus en prenant en compte les multiples idées.&lt;/p&gt;&#xA;&lt;p&gt;Pour tester ce patch, j&amp;rsquo;ai compilé Postgres depuis les sources. Prenons un exemple tout simple :&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-SQL&#34; data-lang=&#34;SQL&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;create&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;table&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;t1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c2&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c3&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;create&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;index&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;on&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;t1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;insert&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;into&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;t1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;%&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;100&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;%&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1000&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;from&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;generate_series&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;10&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_000_000&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;vacuum&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;analyze&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;t1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;On obtient une table de 422Mo et un index de 66Mo.&#xA;Vous noterez au passage que j&amp;rsquo;ai utilisé une nouveauté de Postgres 16 en utilisant des &amp;ldquo;underscore&amp;rdquo; dans le &lt;em&gt;generate_series&lt;/em&gt;&lt;sup id=&#34;fnref:1&#34;&gt;&lt;a href=&#34;#fn:1&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;1&lt;/a&gt;&lt;/sup&gt;.&lt;/p&gt;&#xA;&lt;p&gt;Si on fait un &lt;code&gt;GROUP BY&lt;/code&gt; sur &lt;em&gt;c1,c2&lt;/em&gt;, on obtient un parcours d&amp;rsquo;index :&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-fallback&#34; data-lang=&#34;fallback&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;explain (settings, analyze,buffers) select count(*),c1,c2 from t1 group by c1,c2 order by c1,c2;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;                                                                    QUERY PLAN&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;--------------------------------------------------------------------------------------------------------------------------------------------------&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; GroupAggregate  (cost=0.43..235342.27 rows=100000 width=16) (actual time=3.605..3501.887 rows=1000 loops=1)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;   Group Key: c1, c2&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;   Buffers: shared hit=10447&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;   -&amp;gt;  Index Only Scan using t1_c1_c2_idx on t1  (cost=0.43..159340.96 rows=10000175 width=8) (actual time=0.070..1900.730 rows=10000000 loops=1)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;         Heap Fetches: 0&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;         Buffers: shared hit=10447&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; Settings: enable_group_by_reordering = &amp;#39;off&amp;#39;, random_page_cost = &amp;#39;1.1&amp;#39;, max_parallel_workers_per_gather = &amp;#39;0&amp;#39;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; Planning:&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;   Buffers: shared hit=1&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; Planning Time: 0.191 ms&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; Execution Time: 3502.036 ms&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;em&gt;Vous remarquerez que j&amp;rsquo;ai volontairement désactivé la fonctionnalité dans un premier temps (enable_group_by_reordering=off). J&amp;rsquo;ai également désactivé la parallélisation pour plus de clarté.&lt;/em&gt;&lt;/p&gt;&#xA;&lt;p&gt;On a le plan attendu, le moteur va lire 10447 blocs avec un parcours &lt;em&gt;Index Only Scan&lt;/em&gt;. Le moteur va chercher le plan qui manipule le moins de blocs possible.&lt;/p&gt;&#xA;&lt;p&gt;En revanche, si on change l&amp;rsquo;ordre du group by :&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-fallback&#34; data-lang=&#34;fallback&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;explain (settings, analyze,buffers) select count(*),c1,c2 from t1 group by c2,c1 order by c1,c2;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;                                                          QUERY PLAN&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;------------------------------------------------------------------------------------------------------------------------------&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; Sort  (cost=602422.32..602672.32 rows=100000 width=16) (actual time=5393.446..5393.503 rows=1000 loops=1)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;   Sort Key: c1, c2&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;   Sort Method: quicksort  Memory: 79kB&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;   Buffers: shared hit=96 read=53959&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;   -&amp;gt;  HashAggregate  (cost=514992.50..594117.50 rows=100000 width=16) (actual time=5392.351..5392.894 rows=1000 loops=1)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;         Group Key: c2, c1&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;         Batches: 1  Memory Usage: 3217kB&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;         Buffers: shared hit=96 read=53959&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;         -&amp;gt;  Seq Scan on t1  (cost=0.00..154055.00 rows=10000000 width=8) (actual time=0.033..1186.171 rows=10000000 loops=1)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;               Buffers: shared hit=96 read=53959&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; Settings: enable_group_by_reordering = &amp;#39;off&amp;#39;, random_page_cost = &amp;#39;1.1&amp;#39;, max_parallel_workers_per_gather = &amp;#39;0&amp;#39;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; Planning:&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;   Buffers: shared hit=1&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; Planning Time: 0.189 ms&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; Execution Time: 5394.566 ms&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Dans ce cas, le moteur va lire toute la table (&lt;em&gt;seqscan&lt;/em&gt;) et faire un tri, alors que le résultat est identique.&lt;/p&gt;&#xA;&lt;p&gt;Le moteur lit 422Mo de données contre 80Mo, soit 5 fois plus. Le résultat peut être désastreux suivant les performances du stockage.&#xA;Là, on a de la &amp;ldquo;chance&amp;rdquo;, mon instance est dans un ramdisk donc la requête n&amp;rsquo;est pas beaucoup plus lente.&#xA;Avec du stockage mécanique ou des disques cloud, le temps de réponse peut augmenter drastiquement.&lt;/p&gt;&#xA;&lt;p&gt;L&amp;rsquo;ordre des colonnes dans un group by est important, c&amp;rsquo;est une optimisation assez simple pour peu qu&amp;rsquo;on connaisse le schéma de la base et qu&amp;rsquo;on maitrise les requêtes exécutées sur le serveur.&lt;/p&gt;&#xA;&lt;p&gt;Malheureusement, avec les ORM, on peut perdre cette maitrise ou rater des corrections.&#xA;C&amp;rsquo;est là où cette fonctionnalité est intéressante. Voyons son effet :&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-fallback&#34; data-lang=&#34;fallback&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;postgres=# set enable_group_by_reordering to on;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;SET&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;postgres=# explain (settings, analyze,buffers) select count(*),c1,c2 from t1 group by c2,c1 order by c1,c2;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;                                                                    QUERY PLAN&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;--------------------------------------------------------------------------------------------------------------------------------------------------&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; GroupAggregate  (cost=0.43..235338.33 rows=100000 width=16) (actual time=4.502..3658.168 rows=1000 loops=1)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;   Group Key: c1, c2&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;   Buffers: shared hit=10447&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;   -&amp;gt;  Index Only Scan using t1_c1_c2_idx on t1  (cost=0.43..159338.33 rows=10000000 width=8) (actual time=0.081..1923.553 rows=10000000 loops=1)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;         Heap Fetches: 0&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;         Buffers: shared hit=10447&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; Settings: random_page_cost = &amp;#39;1.1&amp;#39;, max_parallel_workers_per_gather = &amp;#39;0&amp;#39;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; Planning:&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;   Buffers: shared hit=1&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; Planning Time: 0.230 ms&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; Execution Time: 3658.337 ms&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;On retrouve le premier plan bien plus performant.&lt;/p&gt;&#xA;&lt;p&gt;C&amp;rsquo;est une fonctionnalité assez simple qui devrait améliorer les temps d&amp;rsquo;exécutions de certaines requêtes dont la clause group by n&amp;rsquo;a pas été optimisée.&lt;/p&gt;&#xA;&lt;p&gt;C&amp;rsquo;est une demande assez récurrente d&amp;rsquo;améliorer le planificateur afin de gérer des cas en apparence simple. Il faut avoir en tête que le risque est de d&amp;rsquo;augmenter&#xA;les opérations de calculs dans le planificateur. Or, on veut que cette étape soit la plus rapide possible La réponse est souvent résumée à : &amp;ldquo;on ne veut pas alourdir le planificateur alors qu&amp;rsquo;on peut corriger la requête&amp;rdquo;.&lt;/p&gt;&#xA;&lt;p&gt;Cependant, ce type d&amp;rsquo;optimisation peut être acceptée si on sait que ça ne sera pas couteux pour le planificateur.&lt;/p&gt;&#xA;&lt;p&gt;Il n&amp;rsquo;y a plus qu&amp;rsquo;à espérer que cette fonctionnalité ne soit pas retirée d&amp;rsquo;ici la sortie de Postgres 17 :)&lt;/p&gt;&#xA;&lt;div class=&#34;footnotes&#34; role=&#34;doc-endnotes&#34;&gt;&#xA;&lt;hr&gt;&#xA;&lt;ol&gt;&#xA;&lt;li id=&#34;fn:1&#34;&gt;&#xA;&lt;p&gt;Petite anecdote, pour ajouter cette fonctionnalité, l&amp;rsquo;auteur a fait évoluer le standard SQL : &lt;a href=&#34;http://peter.eisentraut.org/blog/2023/09/20/grouping-digits-in-sql&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Grouping digits in SQL&lt;/a&gt; .&amp;#160;&lt;a href=&#34;#fnref:1&#34; class=&#34;footnote-backref&#34; role=&#34;doc-backlink&#34;&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&lt;/div&gt;</summary>
    <author>
      <name>blog.anayrat.info</name>
    </author>
  </entry>
  <entry>
    <title>PostgreSQL compression du TOAST et toast_tuple_target</title>
    <updated>2022-02-14T07:00:00Z</updated>
    <id>tag:blog.anayrat.info,2022-02-14:/2022/02/14/postgresql-compression-du-toast-et-toast_tuple_target/</id>
    <link href="https://blog.anayrat.info/2022/02/14/postgresql-compression-du-toast-et-toast_tuple_target/" rel="alternate"></link>
    <summary type="html">&lt;p&gt;Quelques rappels sur le TOAST et présentation d&amp;rsquo;un changement apparu avec PostgreSQL 11.&lt;/p&gt;&#xA;&lt;details class=&#34;toc-inpage d-print-none  &#34; open&gt;&#xA;  &lt;summary class=&#34;font-weight-bold&#34;&gt;Table des matières&lt;/summary&gt;&#xA;  &lt;nav id=&#34;TableOfContents&#34;&gt;&#xA;  &lt;ul&gt;&#xA;    &lt;li&gt;&lt;a href=&#34;#quest-ce-que-le-toast-&#34;&gt;Qu&amp;rsquo;est-ce que le TOAST ?&lt;/a&gt;&lt;/li&gt;&#xA;    &lt;li&gt;&lt;a href=&#34;#exemple-avec-le-jsonb&#34;&gt;Exemple avec le JSONB&lt;/a&gt;&lt;/li&gt;&#xA;    &lt;li&gt;&lt;a href=&#34;#paramétrage-avancé&#34;&gt;Paramétrage avancé&lt;/a&gt;&lt;/li&gt;&#xA;    &lt;li&gt;&lt;a href=&#34;#conclusion&#34;&gt;Conclusion&lt;/a&gt;&lt;/li&gt;&#xA;    &lt;li&gt;&lt;a href=&#34;#bonus&#34;&gt;Bonus&lt;/a&gt;&lt;/li&gt;&#xA;  &lt;/ul&gt;&#xA;&lt;/nav&gt;&#xA;&lt;/details&gt;&#xA;&lt;h1 id=&#34;quest-ce-que-le-toast-&#34;&gt;Qu&amp;rsquo;est-ce que le TOAST ?&lt;/h1&gt;&#xA;&lt;p&gt;Vous êtes-vous déjà posé la question sur comment Postgres fait pour stocker des lignes dépassant la taille d&amp;rsquo;un bloc? Pour rappel, la taille par défaut d&amp;rsquo;un bloc est de 8Ko.&lt;/p&gt;&#xA;&lt;p&gt;Postgres utilise un mécanisme appelé TOAST pour &lt;a href=&#34;https://www.postgresql.org/docs/current/storage-toast.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;The Oversized-Attribute Storage Technique&lt;/a&gt;.&lt;/p&gt;&#xA;&lt;p&gt;Lorsqu&amp;rsquo;un enregistrement devient trop gros pour être stocké dans un bloc, le moteur va le stocker &amp;ldquo;à part&amp;rdquo;, dans une table de toast.&#xA;L&amp;rsquo;enregistrement sera découpé en &lt;em&gt;chunks&lt;/em&gt;, ainsi la table principale (appelée &lt;em&gt;heap&lt;/em&gt;) contiendra un pointeur (&lt;em&gt;chunk_id&lt;/em&gt;) pointant vers le bon &lt;em&gt;chunk&lt;/em&gt; dans la table de toast.&lt;/p&gt;&#xA;&lt;p&gt;Ce &lt;em&gt;chunk&lt;/em&gt; sera stocké sur plusieurs lignes, pour un &lt;em&gt;chunk_id&lt;/em&gt; on peut avoir plusieurs lignes dans cette table de toast.&#xA;Ainsi, cette table de toast est composée de 3 colonnes:&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;em&gt;chunk_id&lt;/em&gt; : Numéro du chunk référencé dans la heap&lt;/li&gt;&#xA;&lt;li&gt;&lt;em&gt;chunk_seq&lt;/em&gt; : Numéro de chaque segment d&amp;rsquo;un chunk&lt;/li&gt;&#xA;&lt;li&gt;&lt;em&gt;chunk_data&lt;/em&gt; : Partie données de chaque segment&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;La réalité est un peu plus complexe, en vrai le moteur va tenter d&amp;rsquo;éviter de stocker la donnée dans la table toast.&#xA;Si la ligne dépasse &lt;code&gt;TOAST_TUPLE_THRESHOLD&lt;/code&gt; (2Ko), il va tenter de compresser les colonnes pour essayer de faire rentrer la ligne dans le bloc.&#xA;Plus précisément, il faut que la taille soit inférieure à &lt;code&gt;TOAST_TUPLE_TARGET&lt;/code&gt; (2Ko par défaut, on va en reparler).&lt;/p&gt;&#xA;&lt;p&gt;Si on a de la chance, la ligne compressée rentre dans la heap. Sinon, il va tenter de compresser les colonnes,&#xA;de la plus grande à la plus petite et les stocker dans la partie toast jusqu&amp;rsquo;à ce que les colonnes restantes rentrent dans une ligne de la heap. &lt;sup id=&#34;fnref:1&#34;&gt;&lt;a href=&#34;#fn:1&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;1&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;&#xA;&lt;p&gt;A noter également que si le gain en compression est trop faible, il considère qu&amp;rsquo;il est inutile de dépenser&#xA;de la ressource de calcul à tenter de compresser. Il stocke donc la donnée sans compression. &lt;sup id=&#34;fnref:2&#34;&gt;&lt;a href=&#34;#fn:2&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;2&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;&#xA;&lt;p&gt;Avez-vous déjà prêté attention à la colonne &amp;ldquo;Storage&amp;rdquo; lorsque vous affichez les caractéristiques d&amp;rsquo;une table à l&amp;rsquo;aide de la méta commande &lt;code&gt;\d+ table&lt;/code&gt; ?&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-fallback&#34; data-lang=&#34;fallback&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;stackoverflow=# \d+ posts&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;                   Table &amp;#34;public.posts&amp;#34;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    Column     |  Type   | Collation | Nullable | Default | Storage  |&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;---------------+---------+-----------+----------+---------+----------+&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; id            | integer |           | not null |         | plain    |&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; posttypeid    | integer |           | not null |         | plain    |&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; score         | integer |           |          |         | plain    |&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; viewcount     | integer |           |          |         | plain    |&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; body          | text    |           |          |         | extended |&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Dans cet exemple, la colonne prend comme valeur &lt;em&gt;plain&lt;/em&gt; ou &lt;em&gt;extended&lt;/em&gt;. En réalité, il existe 4 valeurs possibles selon le type de donnée :&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;em&gt;plain&lt;/em&gt; : la colonne est stockée dans la heap uniquement et sans compression.&lt;/li&gt;&#xA;&lt;li&gt;&lt;em&gt;extended&lt;/em&gt; : la colonne peut être compressée et stockée dans le toast si nécessaire.&lt;/li&gt;&#xA;&lt;li&gt;&lt;em&gt;external&lt;/em&gt; : la colonne peut être stockée dans le toast mais uniquement sans compression. Parfois on peut utiliser ce mode pour avoir un gain en performance (évite la compression/décompression)&#xA;au prix d&amp;rsquo;une consommation plus importante de l&amp;rsquo;espace disque.&lt;/li&gt;&#xA;&lt;li&gt;&lt;em&gt;main&lt;/em&gt; : La colonne est stockée dans la heap uniquement mais contrairement au mode &lt;em&gt;plain&lt;/em&gt;, on autorise la compression.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;Au premier abord, on peut penser que l&amp;rsquo;intérêt est surtout sur la possibilité de stocker&#xA;des lignes dépassant la taille d&amp;rsquo;un bloc et de compresser la donnée pour gagner de l&amp;rsquo;espace disque.&lt;/p&gt;&#xA;&lt;p&gt;Il y a un autre intérêt : lors d&amp;rsquo;une mise à jour d&amp;rsquo;une ligne, si les colonnes &amp;ldquo;toastées&amp;rdquo; ne sont pas modifiées, le moteur n&amp;rsquo;a pas besoin de modifier la table toast.&#xA;On va ainsi éviter de devoir décompresser et recompresser le toast et écrire tout ça dans des journaux de transaction.&lt;/p&gt;&#xA;&lt;p&gt;Nous allons voir qu&amp;rsquo;un autre avantage est que le moteur peut éviter de lire le toast si ce n&amp;rsquo;est pas nécessaire.&lt;/p&gt;&#xA;&lt;h1 id=&#34;exemple-avec-le-jsonb&#34;&gt;Exemple avec le JSONB&lt;/h1&gt;&#xA;&lt;p&gt;Pour étudier ça, on va utiliser le type JSONB. De manière générale, je déconseille l&amp;rsquo;usage de ce type :&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;On perd les avantages d&amp;rsquo;avoir un schéma :&#xA;&lt;ul&gt;&#xA;&lt;li&gt;vérification des types&lt;/li&gt;&#xA;&lt;li&gt;contraintes d&amp;rsquo;intégrité&lt;/li&gt;&#xA;&lt;li&gt;pas de clés étrangères&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;L&amp;rsquo;écriture des requêtes devient plus complexe&lt;/li&gt;&#xA;&lt;li&gt;Absence des statistiques sur les clés d&amp;rsquo;un champ json&lt;/li&gt;&#xA;&lt;li&gt;Perte d&amp;rsquo;efficacité du stockage vu qu&amp;rsquo;on stocke les clés pour chaque ligne&lt;/li&gt;&#xA;&lt;li&gt;Pas de mise à jour partielle du JSONB. Si on modifie une clé on est obligé de &lt;em&gt;detoaster&lt;/em&gt; et &lt;em&gt;toaster&lt;/em&gt; tout le JSONB&lt;/li&gt;&#xA;&lt;li&gt;Pas de &lt;em&gt;detoast&lt;/em&gt; partiel : si on souhaite lire une seule clé du JSONB, on est contraint de &lt;em&gt;detoaster&lt;/em&gt; tout le JSONB &lt;sup id=&#34;fnref:3&#34;&gt;&lt;a href=&#34;#fn:3&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;3&lt;/a&gt;&lt;/sup&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;Cependant, il y a quelques exceptions où le JSON peut être utile :&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Lorsqu&amp;rsquo;on n&amp;rsquo;a pas besoin de chercher dans de multiples champs et qu&amp;rsquo;on récupère le json via une autre colonne. (Statistiques sur les clés du json inutiles).&lt;/li&gt;&#xA;&lt;li&gt;Et, lorsqu&amp;rsquo;il serait très difficile de faire rentrer le json dans un schéma relationnel. Certains cas impliqueraient d&amp;rsquo;avoir énormément de colonnes et la plupart à &lt;code&gt;NULL&lt;/code&gt;.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;Par exemple, pour stocker des caractéristiques de produit où une version normalisée entrainerait l&amp;rsquo;usage de beaucoup de colonnes dont la plupart seraient à &lt;code&gt;NULL&lt;/code&gt;.&#xA;Imaginons que vous stockez des produits, une télévision aurait des caractéristiques spécifiques (type d&amp;rsquo;écran, taille etc). Une machine à laver aurait aussi d&amp;rsquo;autre caractéristiques spécifiques (vitesse essorage, poids accepté&amp;hellip;).&lt;/p&gt;&#xA;&lt;p&gt;On pourrait ainsi envisager d&amp;rsquo;avoir des colonnes &amp;ldquo;normales&amp;rdquo; comprenant le modèle, son prix, sa référence etc, et une colonne contenant toutes les caractéristiques.&#xA;On accèderait à la ligne via la référence et ainsi on récupèrerait toutes les caractéristiques du produit stockées dans le json.&lt;/p&gt;&#xA;&lt;p&gt;Je vais réutiliser la table des posts de Stackoverflow en déplaçant quelques colonnes dans une colonne de type jsonb (colonne &lt;em&gt;jsonfield&lt;/em&gt; dans cet exemple):&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-fallback&#34; data-lang=&#34;fallback&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;\d posts&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;                            Unlogged table &amp;#34;public.posts&amp;#34;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        Column         |            Type             | Collation | Nullable | Default&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;-----------------------+-----------------------------+-----------+----------+---------&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; id                    | integer                     |           | not null |&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; posttypeid            | integer                     |           | not null |&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; acceptedanswerid      | integer                     |           |          |&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; parentid              | integer                     |           |          |&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; creationdate          | timestamp without time zone |           | not null |&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; score                 | integer                     |           |          |&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; viewcount             | integer                     |           |          |&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; body                  | text                        |           |          |&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; owneruserid           | integer                     |           |          |&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; lasteditoruserid      | integer                     |           |          |&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; lasteditordisplayname | text                        |           |          |&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; lasteditdate          | timestamp without time zone |           |          |&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; lastactivitydate      | timestamp without time zone |           |          |&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; title                 | text                        |           |          |&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; tags                  | text                        |           |          |&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; answercount           | integer                     |           |          |&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; commentcount          | integer                     |           |          |&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; favoritecount         | integer                     |           |          |&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; closeddate            | timestamp without time zone |           |          |&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; communityowneddate    | timestamp without time zone |           |          |&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; jsonfield             | jsonb                       |           |          |&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Voici une requête toute simple d&amp;rsquo;agrégation :&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;avg&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;viewcount&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;avg&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;answercount&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;avg&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;commentcount&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;avg&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;favoritecount&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;posts&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-fallback&#34; data-lang=&#34;fallback&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;                                                          QUERY PLAN&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;-------------------------------------------------------------------------------------------------------------------------------&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; Aggregate  (cost=10265135.77..10265135.78 rows=1 width=128) (actual time=170221.557..170221.558 rows=1 loops=1)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;   Buffers: shared hit=1 read=9186137&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;   I/O Timings: read=138022.290&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;   -&amp;gt;  Seq Scan on posts  (cost=0.00..9725636.88 rows=53949888 width=16) (actual time=0.014..153665.913 rows=53949886 loops=1)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;         Buffers: shared hit=1 read=9186137&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;         I/O Timings: read=138022.290&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; Planning Time: 0.240 ms&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; Execution Time: 170221.627 ms&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;(8 rows)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;La requête lit 70 Go de données et met environ 2min 50s à s&amp;rsquo;exécuter.&lt;/p&gt;&#xA;&lt;p&gt;Maintenant la même requête, mais cette fois en utilisant les clés présentes dans le json.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;avg&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;jsonfield&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;ViewCount&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;avg&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;jsonfield&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;AnswerCount&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;avg&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;jsonfield&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;CommentCount&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;avg&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;jsonfield&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;FavoriteCount&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;posts&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-fallback&#34; data-lang=&#34;fallback&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;                           QUERY PLAN&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;------------------------------------------------------------------------------&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; Aggregate  (cost=11883632.41..11883632.42 rows=1 width=128)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;            (actual time=520917.028..520917.030 rows=1 loops=1)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;   Buffers: shared hit=241116554 read=13625756&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;   -&amp;gt;  Seq Scan on posts  (cost=0.00..9725636.88 rows=53949888 width=570)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;                          (actual time=0.972..70569.365 rows=53949886 loops=1)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;         Buffers: shared read=9186138&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; Planning Time: 0.118 ms&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; Execution Time: 520945.395 ms&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;(10 rows)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;La requête met environ 8min 40s à s&amp;rsquo;exécuter. En revanche le nombre de blocs lus semble un peu délirant :&lt;/p&gt;&#xA;&lt;p&gt;Le Seq Scan indique comme tout à l&amp;rsquo;heure 70Go. En revanche, le nœud parent indique plus de 1.9 To lus!&lt;/p&gt;&#xA;&lt;p&gt;Voici la taille de la table avec le paramétrage par défaut. Il faut savoir que pour certains enregistrements,&#xA;le moteur va, soit compresser la ligne dans la heap, soit la compresser et la placer dans le toast.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-fallback&#34; data-lang=&#34;fallback&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;SELECT&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  pg_size_pretty(pg_relation_size(oid)) table_size,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  pg_size_pretty(pg_relation_size(reltoastrelid)) toast_size&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;FROM pg_class&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;WHERE relname = &amp;#39;posts&amp;#39;;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; table_size | toast_size&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;------------+-----------&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; 70 GB      | 33 GB&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;(1 row)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Comment expliquer les 1.9 To lus ?&lt;/p&gt;&#xA;&lt;p&gt;Par curiosité, j&amp;rsquo;ai fait la même requête, mais avec une seule agrégation et j&amp;rsquo;obtiens environ 538 Go.&lt;/p&gt;&#xA;&lt;p&gt;On peut se poser plusieurs questions :&lt;/p&gt;&#xA;&lt;ol&gt;&#xA;&lt;li&gt;Comment savoir si le moteur va lire le toast ?&lt;/li&gt;&#xA;&lt;li&gt;Pourquoi un tel écart de temps d&amp;rsquo;exécution entre la version &amp;ldquo;colonne standard&amp;rdquo; et champ jsonb?&lt;/li&gt;&#xA;&lt;li&gt;A quoi correspondent les compteurs dans le nœud &lt;code&gt;Aggregate&lt;/code&gt; ?&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&lt;p&gt;Pour répondre à la première question, il suffit de lire la vue &lt;code&gt;pg_statio_user_tables&lt;/code&gt;.&lt;/p&gt;&#xA;&lt;p&gt;Avant exécution de la requête :&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-fallback&#34; data-lang=&#34;fallback&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;select relid,schemaname,relname,heap_blks_read,heap_blks_hit,toast_blks_read,toast_blks_hit from pg_statio_all_tables where relname in (&amp;#39;posts&amp;#39;,&amp;#39;pg_toast_26180851&amp;#39;);&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  relid   | schemaname |      relname      | heap_blks_read | heap_blks_hit | toast_blks_read | toast_blks_hit&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;----------+------------+-------------------+----------------+---------------+-----------------+----------------&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; 26180851 | public     | posts             |      422018238 |      87673549 |       129785076 |      628153337&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; 26180854 | pg_toast   | pg_toast_26180851 |      129785076 |     628153337 |                 |&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;(2 rows)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Après :&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-fallback&#34; data-lang=&#34;fallback&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  relid   | schemaname |      relname      | heap_blks_read | heap_blks_hit | toast_blks_read | toast_blks_hit&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;----------+------------+-------------------+----------------+---------------+-----------------+----------------&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; 26180851 | public     | posts             |      431204376 |      87673549 |       134156898 |      686299551&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; 26180854 | pg_toast   | pg_toast_26180851 |      134156898 |     686299551 |                 |&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;(2 rows)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Ce qui nous fait :&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pg_size_pretty&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;431204376&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;87673549&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;422018238&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;87673549&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;8&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1024&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;bigint&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;heap_buffers&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pg_size_pretty&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;134156898&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;686299551&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;129785076&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;628153337&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;8&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1024&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;bigint&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;toast_buffers&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;heap_buffers&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;toast_buffers&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;--------------+---------------&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;70&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GB&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;477&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GB&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;row&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Le moteur va bien lire le toast. En revanche les compteurs laissent penser que le moteur va lire plusieurs fois le toast.&lt;/p&gt;&#xA;&lt;p&gt;Si je fais le même calcul, mais cette fois en effectuant l&amp;rsquo;agrégation que sur un seul champ, j&amp;rsquo;obtiens 119 Go (~ 477 Go / 4)&#xA;J&amp;rsquo;imagine que le moteur lit le toast pour chaque fonction.&lt;/p&gt;&#xA;&lt;p&gt;Ensuite, l&amp;rsquo;écart du temps d&amp;rsquo;exécution s&amp;rsquo;explique par plusieurs facteurs :&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Le moteur va devoir lire et &lt;em&gt;detoaster&lt;/em&gt; (décompresser) le toast&lt;/li&gt;&#xA;&lt;li&gt;Faire des opérations supplémentaires sur le jsonb pour accéder à la valeur&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;Avec la première requête, le moteur n&amp;rsquo;avait pas à lire le toast. D&amp;rsquo;une part, il a moins de données à lire,&#xA;d&amp;rsquo;autre part, il n&amp;rsquo;a pas à manipuler le json pour identifier la clé et extraire la valeur à calculer.&lt;/p&gt;&#xA;&lt;p&gt;Enfin, les compteurs du nœud aggregate doivent correspondre aux données décompressées pour chaque fonction qui va lire dans le json.&#xA;En effet, si on prend le total moins le &lt;em&gt;seqscan&lt;/em&gt; de la table, donc que la partie &lt;em&gt;toast&lt;/em&gt;, on a :&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;468 Go pour un seul champ&lt;/li&gt;&#xA;&lt;li&gt;936 Go, le double pour deux champs&lt;/li&gt;&#xA;&lt;li&gt;1873 Go pour les 4 champs (donc environ 4 x 468 Go)&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;C&amp;rsquo;est ce qui explique pourquoi on obtient une valeur aussi élevée.&lt;/p&gt;&#xA;&lt;h1 id=&#34;paramétrage-avancé&#34;&gt;Paramétrage avancé&lt;/h1&gt;&#xA;&lt;p&gt;Maintenant, on va encourager Postgres à placer le maximum de données dans le toast grâce à l&amp;rsquo;option &lt;em&gt;toast_tuple_target&lt;/em&gt; apparue avec la version 11 de Postgres.&lt;/p&gt;&#xA;&lt;p&gt;Cette option permet de manipuler le seuil à partir duquel les données sont stockée dans le &lt;em&gt;toast&lt;/em&gt;.&lt;/p&gt;&#xA;&lt;p&gt;Par ailleurs, étant sous Postgres 14, j&amp;rsquo;en ai profité pour utiliser l&amp;rsquo;algorithme de compression lz4 (paramètre &lt;em&gt;default_toast_compression&lt;/em&gt;).&#xA;Cet algorithme offre un ratio de compression similaire à pglz, cependant, il est beaucoup plus rapide (Voir &lt;a href=&#34;https://www.postgresql.fastware.com/blog/what-is-the-new-lz4-toast-compression-in-postgresql-14&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;What is the new LZ4 TOAST compression in PostgreSQL 14, and how fast is it?&lt;/a&gt;).&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;CREATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;TABLE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;posts_toast&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WITH&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;toast_tuple_target&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;128&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;posts&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Voici la taille de la table obtenue.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-fallback&#34; data-lang=&#34;fallback&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;SELECT&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  pg_size_pretty(pg_relation_size(oid)) table_size,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  pg_size_pretty(pg_relation_size(reltoastrelid)) toast_size&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;FROM pg_class&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;WHERE relname = &amp;#39;posts_toast&amp;#39;;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; table_size | toast_size&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;------------+------------&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; 59 GB      | 52 GB&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Au total, la table avec le toast fait grosso-modo la même taille. Dans l&amp;rsquo;exemple avec la première table,&#xA;il faut savoir que le moteur compresse aussi les données dans la heap.&lt;/p&gt;&#xA;&lt;p&gt;Rejouons notre requête d&amp;rsquo;agrégation :&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;avg&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;viewcount&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;avg&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;answercount&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;avg&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;commentcount&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;avg&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;favoritecount&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;posts_toast&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Cette fois la requête lit 59 Go de données et met 2min 17 secondes.&#xA;On a gagné environ 20% de temps d&amp;rsquo;exécution sur cet exemple.&lt;/p&gt;&#xA;&lt;p&gt;On pourrait gagner beaucoup plus si la partie stockée en toast était plus importante. Le volume de donnée à lire dans la heap serait beaucoup plus réduit.&lt;/p&gt;&#xA;&lt;p&gt;Par curiosité, j&amp;rsquo;ai aussi exécuté la requête qui fait l&amp;rsquo;agrégation depuis les données du champ json. J&amp;rsquo;obtiens un temps d&amp;rsquo;exécution de 7min 17s.&lt;/p&gt;&#xA;&lt;h1 id=&#34;conclusion&#34;&gt;Conclusion&lt;/h1&gt;&#xA;&lt;p&gt;Résumé en quelques chiffres :&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Agrégation type standard, stockage standard : 2min 50s&lt;/li&gt;&#xA;&lt;li&gt;Agrégation type jsonb, stockage standard : 8min 40s&lt;/li&gt;&#xA;&lt;li&gt;Agrégation type standard, stockage avec &lt;em&gt;toast_tuple_target&lt;/em&gt; = 128 : 2min 17s&lt;/li&gt;&#xA;&lt;li&gt;Agrégation type jsonb, stockage avec &lt;em&gt;toast_tuple_target&lt;/em&gt; = 128 : 7min 17s&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;On constate que l&amp;rsquo;usage du JSON est bien plus couteux que d&amp;rsquo;utiliser les types standards. Le moteur doit faire plus d&amp;rsquo;opérations pour accéder à la valeur d&amp;rsquo;une clé json.&lt;/p&gt;&#xA;&lt;p&gt;Par ailleurs, il est obligé de décompresser les données dans le toast pour y accéder. Néanmoins, on peut aussi jouer avec le paramètre &lt;code&gt;toast_tuple_target&lt;/code&gt; pour pousser plus&#xA;d&amp;rsquo;informations dans le toast. Ainsi, dans certains cas, cela peut permettre de réduire la quantité de données lues en évitant de lire le toast.&lt;/p&gt;&#xA;&lt;h1 id=&#34;bonus&#34;&gt;Bonus&lt;/h1&gt;&#xA;&lt;p&gt;Comment souvent dans Postgres, tout évolue au fil des versions. Le TOAST n&amp;rsquo;échappe pas à cette règle.&#xA;Ainsi, quelques nouveautés pourraient apparaitre dans les prochaines versions :&lt;/p&gt;&#xA;&lt;ol&gt;&#xA;&lt;li&gt;Un premier patch a été proposé pour avoir plus de statistiques sur le toast : &lt;a href=&#34;https://commitfest.postgresql.org/37/3457/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;pg_stat_toast&lt;/a&gt;.&#xA;L&amp;rsquo;idée, est d&amp;rsquo;avoir des statistiques sur la compression : gain compression, stockage inline ou séparé dans le toast&amp;hellip;&lt;/li&gt;&#xA;&lt;li&gt;Un second patch appelé &lt;a href=&#34;https://commitfest.postgresql.org/37/3490/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Pluggable toaster&lt;/a&gt;. Celui-ci est beaucoup plus important. Il propose d&amp;rsquo;étendre le &lt;em&gt;&amp;ldquo;toaster&amp;rdquo;&lt;/em&gt;.&#xA;L&amp;rsquo;idée serait de pouvoir proposer différents &lt;em&gt;&amp;ldquo;toaster&amp;rdquo;&lt;/em&gt; selon le type de donnée (notamment le JSONB).&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&lt;div class=&#34;footnotes&#34; role=&#34;doc-endnotes&#34;&gt;&#xA;&lt;hr&gt;&#xA;&lt;ol&gt;&#xA;&lt;li id=&#34;fn:1&#34;&gt;&#xA;&lt;p&gt;Voir &lt;a href=&#34;https://git.postgresql.org/gitweb/?p=postgresql.git;a=blob;f=src/backend/access/heap/heaptoast.c;h=55bbe1d584760a849960871296dfbdd7447b2b67;hb=refs/heads/REL_14_STABLE#l160&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;heap_toast_insert_or_update&lt;/a&gt;&amp;#160;&lt;a href=&#34;#fnref:1&#34; class=&#34;footnote-backref&#34; role=&#34;doc-backlink&#34;&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li id=&#34;fn:2&#34;&gt;&#xA;&lt;p&gt;Il existe deux algorithmes de compression supportés : &lt;em&gt;pglz&lt;/em&gt; (historique et intégré dans Postgres) et &lt;em&gt;lz4&lt;/em&gt; (depuis Postgres 14).&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Pour &lt;em&gt;pglz&lt;/em&gt;, voir &lt;a href=&#34;https://git.postgresql.org/gitweb/?p=postgresql.git;a=blob;f=src/include/common/pg_lzcompress.h;h=3e53fbe97bd0a10e3fbf7ed4396924084f657868;hb=refs/heads/REL_14_STABLE#l25&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;PGLZ_Strategy&lt;/a&gt;&#xA;et &lt;a href=&#34;https://git.postgresql.org/gitweb/?p=postgresql.git;a=blob;f=src/common/pg_lzcompress.c;h=a30a2c2eb83a71725754d8dd680621a02e7557e9;hb=refs/heads/REL_14_STABLE#l223&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;strategy_default_data&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;Pour &lt;em&gt;lz4&lt;/em&gt;, il s&amp;rsquo;agit d&amp;rsquo;une librarie externe. Voir &lt;a href=&#34;https://github.com/lz4/lz4/blob/dev/lib/lz4.h#L145&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;LZ4_compress_default&lt;/a&gt;.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&amp;#160;&lt;a href=&#34;#fnref:2&#34; class=&#34;footnote-backref&#34; role=&#34;doc-backlink&#34;&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li id=&#34;fn:3&#34;&gt;&#xA;&lt;p&gt;Voir les slides de la conférence d&amp;rsquo;Oleg Bartunov et Nikita Glukhov : &lt;a href=&#34;http://www.sai.msu.su/~megera/postgres/talks/jsonb-nizhny-2021.pdf&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;json or not json that is the question&lt;/a&gt;&amp;#160;&lt;a href=&#34;#fnref:3&#34; class=&#34;footnote-backref&#34; role=&#34;doc-backlink&#34;&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&lt;/div&gt;</summary>
    <author>
      <name>blog.anayrat.info</name>
    </author>
  </entry>
  <entry>
    <title>Cas d&#39;usages du partitionnement natif dans PostgreSQL</title>
    <updated>2021-09-01T07:00:00Z</updated>
    <id>tag:blog.anayrat.info,2021-09-01:/2021/09/01/cas-dusages-du-partitionnement-natif-dans-postgresql/</id>
    <link href="https://blog.anayrat.info/2021/09/01/cas-dusages-du-partitionnement-natif-dans-postgresql/" rel="alternate"></link>
    <summary type="html">&lt;p&gt;Après une période d&amp;rsquo;inactivité, je reprends l&amp;rsquo;écriture d&amp;rsquo;articles techniques sur Postgres. C&amp;rsquo;est aussi pour moi l&amp;rsquo;occasion de vous annoncer mon changement d&amp;rsquo;activité. Depuis courant 2021 je suis passé freelance pour permettre aux entreprises de bénéficier de mon expérience sur Postgres.&lt;/p&gt;&#xA;&lt;details class=&#34;toc-inpage d-print-none  &#34; open&gt;&#xA;  &lt;summary class=&#34;font-weight-bold&#34;&gt;Table des matières&lt;/summary&gt;&#xA;  &lt;nav id=&#34;TableOfContents&#34;&gt;&#xA;  &lt;ul&gt;&#xA;    &lt;li&gt;&lt;a href=&#34;#histoire-du-partitionnement-dans-postgresql&#34;&gt;Histoire du partitionnement dans PostgreSQL&lt;/a&gt;&lt;/li&gt;&#xA;    &lt;li&gt;&lt;a href=&#34;#erreurs-courantes&#34;&gt;Erreurs courantes&lt;/a&gt;&#xA;      &lt;ul&gt;&#xA;        &lt;li&gt;&lt;a href=&#34;#il-faut-partitionner-dès-que-la-volumétrie-est-importante&#34;&gt;&amp;ldquo;Il faut partitionner dès que la volumétrie est importante&amp;rdquo;&lt;/a&gt;&lt;/li&gt;&#xA;        &lt;li&gt;&lt;a href=&#34;#il-faut-partitionner-pour-répartir-les-données-sur-plusieurs-disques&#34;&gt;&amp;ldquo;Il faut partitionner pour répartir les données sur plusieurs disques&amp;rdquo;&lt;/a&gt;&lt;/li&gt;&#xA;      &lt;/ul&gt;&#xA;    &lt;/li&gt;&#xA;    &lt;li&gt;&lt;a href=&#34;#cas-dusages-du-partitionnement&#34;&gt;Cas d&amp;rsquo;usages du partitionnement&lt;/a&gt;&#xA;      &lt;ul&gt;&#xA;        &lt;li&gt;&lt;a href=&#34;#partitionner-pour-gérer-la-rétention&#34;&gt;Partitionner pour gérer la rétention&lt;/a&gt;&lt;/li&gt;&#xA;        &lt;li&gt;&lt;a href=&#34;#partitionner-pour-contrôler-la-fragmentation-des-index&#34;&gt;Partitionner pour contrôler la fragmentation des index&lt;/a&gt;&lt;/li&gt;&#xA;        &lt;li&gt;&lt;a href=&#34;#partitionner-pour-faciliter-lexécution-de-requête-lorsque-la-cardinalité-est-faible&#34;&gt;Partitionner pour faciliter l&amp;rsquo;exécution de requête lorsque la cardinalité est faible&lt;/a&gt;&lt;/li&gt;&#xA;        &lt;li&gt;&lt;a href=&#34;#partitionner-pour-obtenir-de-meilleures-statistiques&#34;&gt;Partitionner pour obtenir de meilleures statistiques&lt;/a&gt;&lt;/li&gt;&#xA;        &lt;li&gt;&lt;a href=&#34;#partitionwise-join--partitionwise-aggregate&#34;&gt;partitionwise join &amp;amp; partitionwise aggregate&lt;/a&gt;&lt;/li&gt;&#xA;        &lt;li&gt;&lt;a href=&#34;#stockage-avec-tiering&#34;&gt;Stockage avec tiering&lt;/a&gt;&lt;/li&gt;&#xA;      &lt;/ul&gt;&#xA;    &lt;/li&gt;&#xA;    &lt;li&gt;&lt;a href=&#34;#conclusion&#34;&gt;Conclusion&lt;/a&gt;&lt;/li&gt;&#xA;  &lt;/ul&gt;&#xA;&lt;/nav&gt;&#xA;&lt;/details&gt;&#xA;&lt;h1 id=&#34;histoire-du-partitionnement-dans-postgresql&#34;&gt;Histoire du partitionnement dans PostgreSQL&lt;/h1&gt;&#xA;&lt;p&gt;PostgreSQL permet depuis très longtemps de partitionner des tables en exploitant l&amp;rsquo;héritage de table. Toutefois, cette méthode était assez lourde à mettre en oeuvre : elle impliquait de mettre en place soi-même des triggers pour rediriger les écritures (moins performant que le partitionnement natif), le temps de planification pouvait augmenter fortement au-delà d&amp;rsquo;une centaine de partitions&amp;hellip;&lt;/p&gt;&#xA;&lt;p&gt;Le partitionnement natif est arrivé avec la version 10. C&amp;rsquo;est depuis cette version que le moteur est capable (entre autres) de diriger lui-même les écritures vers les bonnes tables, lire seulement les tables concernées, d&amp;rsquo;utiliser des algorithmes exploitant le partitionnement etc.&#xA;Il offre ainsi de meilleures performances et une facilité d&amp;rsquo;exploitation. On peut entre autres :&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Partitionner :&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Par liste&lt;/li&gt;&#xA;&lt;li&gt;Par hashage&lt;/li&gt;&#xA;&lt;li&gt;Par intervalles&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;Faire des partitionnements à plusieurs niveaux&lt;/li&gt;&#xA;&lt;li&gt;Partitionner sur plusieurs colonnes&lt;/li&gt;&#xA;&lt;li&gt;Utiliser des clés primaires et clés étrangères&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;Toutes ces fonctionnalités sont intéressantes, mais on en vient à se poser une question toute bête : quand mettre en oeuvre le partitionnement?&lt;/p&gt;&#xA;&lt;p&gt;Je vais vous présenter plusieurs cas d&amp;rsquo;usages que j&amp;rsquo;ai pu rencontrer. Mais avant, voici quelques erreurs courantes sur le partitionnement.&lt;/p&gt;&#xA;&lt;h1 id=&#34;erreurs-courantes&#34;&gt;Erreurs courantes&lt;/h1&gt;&#xA;&lt;h2 id=&#34;il-faut-partitionner-dès-que-la-volumétrie-est-importante&#34;&gt;&amp;ldquo;Il faut partitionner dès que la volumétrie est importante&amp;rdquo;&lt;/h2&gt;&#xA;&lt;p&gt;Déjà, qu&amp;rsquo;est-ce qu&amp;rsquo;une volumétrie &amp;ldquo;importante&amp;rdquo;?&lt;/p&gt;&#xA;&lt;p&gt;Certains diront que c&amp;rsquo;est au-delà de plusieurs centaines de Go, d&amp;rsquo;autres au-delà du téraoctet, d&amp;rsquo;autres encore au-delà du pétaoctet&amp;hellip;&lt;/p&gt;&#xA;&lt;p&gt;Il n&amp;rsquo;existe pas vraiment de réponse à cette question et globalement ça va dépendre du type d&amp;rsquo;activité : ratio INSERT/UPDATE/DELETE, type de SELECT (OLTP, OLAP&amp;hellip;).&#xA;Ca dépendra également du matériel. Il y a 10 ans, quand les serveurs n&amp;rsquo;avaient que quelques Go de RAM avec des disques mécaniques, il était probable qu&amp;rsquo;une base de quelques centaines de Go soit perçue comme une grosse base.&#xA;Maintenant il n&amp;rsquo;est pas rare de voir des serveurs avec plus d&amp;rsquo;un téraoctet de RAM, des disques NVMe.&lt;/p&gt;&#xA;&lt;p&gt;Ainsi, une base de quelques centaines de Go n&amp;rsquo;est plus considérée comme une grosse base. Mais plutôt comme une base de taille modeste.&lt;/p&gt;&#xA;&lt;p&gt;Petite anecdote, pour se rassurer, un client m&amp;rsquo;a questionné si Postgres était déjà utilisé pour des volumétries &amp;ldquo;importantes&amp;rdquo;. On parlait alors d&amp;rsquo;une base d&amp;rsquo;une quarantaine de Go sur un serveur qui disposait de 64Go de RAM. Toutes les lectures se faisaient depuis le cache&amp;hellip; :). J&amp;rsquo;ai pu le rassurer sur la taille de sa base qui était relativement modeste.&lt;/p&gt;&#xA;&lt;p&gt;Il peut tout à fait être superflu de partitionner une base de quelques To comme il peut être nécessaire de partitionner une base de quelques centaines de Go. Par exemple, si l&amp;rsquo;activité consiste juste à ajouter des lignes à des tables et que les requêtes se résument à de simple &lt;code&gt;WHERE colonne = 4&lt;/code&gt; qui retournent quelques lignes. Un simple Btree fera l&amp;rsquo;affaire. Et si la requête retourne un nombre assez important de lignes, il est possible d&amp;rsquo;utiliser les index BRIN ou les bloom filter.&lt;/p&gt;&#xA;&lt;p&gt;Les index BRIN présentent des bénéfices proches du partitionnement ou sharding en évitant la complexité de mise en oeuvre&lt;sup id=&#34;fnref:1&#34;&gt;&lt;a href=&#34;#fn:1&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;1&lt;/a&gt;&lt;/sup&gt;.&lt;/p&gt;&#xA;&lt;h2 id=&#34;il-faut-partitionner-pour-répartir-les-données-sur-plusieurs-disques&#34;&gt;&amp;ldquo;Il faut partitionner pour répartir les données sur plusieurs disques&amp;rdquo;&lt;/h2&gt;&#xA;&lt;p&gt;L&amp;rsquo;idée serait de créer des partitions et des tablespaces sur différents disques afin de répartir les opérations d&amp;rsquo;entrées/sorties.&lt;/p&gt;&#xA;&lt;p&gt;Pour PostgreSQL, un tablespace n&amp;rsquo;est ni plus, ni moins qu&amp;rsquo;un chemin vers un répertoire. Il est tout à fait possible&#xA;de gérer le stockage au niveau du système d&amp;rsquo;exploitation et d&amp;rsquo;agréger plusieurs disques (en RAID10) par exemple.&#xA;Ensuite, il suffit de stocker la table sur le volume créé. Ainsi, on peut répartir les I/O sur un ensemble de disques.&lt;/p&gt;&#xA;&lt;p&gt;Dans ce cas, il n&amp;rsquo;est donc pas nécessaire de mettre en oeuvre le partitionnement. Toutefois, nous verrons un cas où il pourrait avoir du sens.&lt;/p&gt;&#xA;&lt;p&gt;Maintenant nous allons nous intéresser à des cas d&amp;rsquo;usage &amp;ldquo;légitimes&amp;rdquo; du partitionnement.&lt;/p&gt;&#xA;&lt;h1 id=&#34;cas-dusages-du-partitionnement&#34;&gt;Cas d&amp;rsquo;usages du partitionnement&lt;/h1&gt;&#xA;&lt;h2 id=&#34;partitionner-pour-gérer-la-rétention&#34;&gt;Partitionner pour gérer la rétention&lt;/h2&gt;&#xA;&lt;p&gt;A cause du modèle MVCC, la suppression massive de données entraine de la fragmentation dans les tables.&lt;/p&gt;&#xA;&lt;p&gt;Un cas d&amp;rsquo;usage possible est de partitionner par date. Supprimer les anciennes données revient à supprimer une partition complète. L&amp;rsquo;opération sera rapide et les tables ne seront pas fragmentées&lt;/p&gt;&#xA;&lt;h2 id=&#34;partitionner-pour-contrôler-la-fragmentation-des-index&#34;&gt;Partitionner pour contrôler la fragmentation des index&lt;/h2&gt;&#xA;&lt;p&gt;L&amp;rsquo;ajout et modification de données dans une table fragmente les index au fil du temps. Pour faire simple, on ne peut pas récupérer l&amp;rsquo;espace libre dans un bloc tant qu&amp;rsquo;il n&amp;rsquo;est pas vide. Avec le temps les splits d&amp;rsquo;index créent du &amp;ldquo;vide&amp;rdquo; dans ce dernier et le seul moyen de récupérer cet espace est de reconstruire l&amp;rsquo;index.&lt;/p&gt;&#xA;&lt;p&gt;On appelle cela le &amp;ldquo;bloat&amp;rdquo;. Il y a eu de nombreuses améliorations sur les dernières versions de Postgres:&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Version 12, on peut lire dans les &lt;a href=&#34;https://www.postgresql.org/docs/12/release-12.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Releases Notes&lt;/a&gt;:&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;Improve performance and space utilization of btree indexes with many duplicates (Peter Geoghegan, Heikki Linnakangas)&lt;/p&gt;&#xA;&lt;p&gt;Previously, duplicate index entries were stored unordered within their duplicate groups. This caused overhead during index inserts, wasted space due to excessive page splits, and it reduced VACUUM&amp;rsquo;s ability to recycle entire pages. Duplicate index entries are now sorted in heap-storage order.&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Version 13, on peut lire dans les &lt;a href=&#34;https://www.postgresql.org/docs/13/release-13.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Releases Notes&lt;/a&gt;:&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;More efficiently store duplicates in B-tree indexes (Anastasia Lubennikova, Peter Geoghegan)&lt;/p&gt;&#xA;&lt;p&gt;This allows efficient B-tree indexing of low-cardinality columns by storing duplicate keys only once. Users upgrading with pg_upgrade will need to use REINDEX to make an existing index use this feature.&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Version 14, on peut lire dans les &lt;a href=&#34;https://www.postgresql.org/docs/14/release-14.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Releases Notes&lt;/a&gt;:&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;Allow btree index additions to remove expired index entries to prevent page splits (Peter Geoghegan)&lt;/p&gt;&#xA;&lt;p&gt;This is particularly helpful for reducing index bloat on tables whose indexed columns are frequently updated.&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;p&gt;Pour contrôler le bloat, on pourrait reconstruire l&amp;rsquo;index à intervalles réguliers (merci &lt;code&gt;REINDEX CONCURRENTLY&lt;/code&gt; arrivé en version 12). Cette solution serait contraignante, car il faudrait régulièrement reconstruire l&amp;rsquo;intégralité de l&amp;rsquo;index.&lt;/p&gt;&#xA;&lt;p&gt;Si la majorité des modifications sont faites sur les données récentes, par exemple: table de logs, commandes clients, rendez-vous&amp;hellip; On pourrait imaginer un partitionnement par mois. Ainsi, à chaque début de mois on part sur une table &amp;ldquo;neuve&amp;rdquo; et on peut ré-indexer la précédente table pour supprimer le bloat.&lt;/p&gt;&#xA;&lt;p&gt;On peut aussi en profiter pour faire un &lt;code&gt;CLUSTER&lt;/code&gt; sur la table pour avoir une bonne corrélation des données avec le stockage.&lt;/p&gt;&#xA;&lt;h2 id=&#34;partitionner-pour-faciliter-lexécution-de-requête-lorsque-la-cardinalité-est-faible&#34;&gt;Partitionner pour faciliter l&amp;rsquo;exécution de requête lorsque la cardinalité est faible&lt;/h2&gt;&#xA;&lt;p&gt;Petit à petit on va voir des cas d&amp;rsquo;usages un peu plus compliqués :)&lt;/p&gt;&#xA;&lt;p&gt;Prenons un exemple : une table de commande comprenant un statut de livraison, au bout de quelques années 99% des commandes sont livrées (on l&amp;rsquo;espère!) et très peu en cours de paiement ou livraison.&lt;/p&gt;&#xA;&lt;p&gt;Imaginons qu&amp;rsquo;on souhaite récupérer 100 commandes en cours de livraison. On va créer un index sur le statut et l&amp;rsquo;utiliser pour récupérer les enregistrements.&#xA;En étant un peu astucieux, on peut créer un index partiel sur ce statut particulier. Problème, cet index va se fragmenter assez vite au fur et à mesure que les commandes seront livrées.&lt;/p&gt;&#xA;&lt;p&gt;Dans ce cas on pourrait faire un partitionnement sur le statut. Ainsi, récupérer 100 commandes en cours de livraison revient à lire 100 enregistrements de la partition.&lt;/p&gt;&#xA;&lt;h2 id=&#34;partitionner-pour-obtenir-de-meilleures-statistiques&#34;&gt;Partitionner pour obtenir de meilleures statistiques&lt;/h2&gt;&#xA;&lt;p&gt;Pour déterminer le meilleur plan d&amp;rsquo;exécution, Postgres prend des décisions à partir des statistiques d&amp;rsquo;une table. Ces statistiques sont obtenues à partir d&amp;rsquo;un échantillon de la table (le &lt;code&gt;default_statistic_target&lt;/code&gt; qui vaut 100 par défaut).&lt;/p&gt;&#xA;&lt;p&gt;Par défaut le moteur va collecter 300 x &lt;code&gt;default_statistic_target&lt;/code&gt; lignes, soit 30 000 lignes. Avec une table de plusieurs centaines de millions de lignes, cet échantillon est parfois trop petit.&lt;/p&gt;&#xA;&lt;p&gt;On peut augmenter de manière drastique la taille de l&amp;rsquo;échantillon, mais cette approche présente quelques inconvénients:&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Ca alourdis le temps de planification&lt;/li&gt;&#xA;&lt;li&gt;Ca alourdis le &lt;code&gt;ANALYZE&lt;/code&gt;&lt;/li&gt;&#xA;&lt;li&gt;Parfois ce n&amp;rsquo;est pas suffisant si les données sont mal réparties. Par exemple si on prend quelques centaines de milliers de lignes sur une table qui comprend plusieurs centaines de millions, on peut rater les lignes dont le statut est en livraison.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;Avec le partitionnement on pourrait avoir un même échantillon, mais par partition, ce qui permet de gagner en précision.&lt;/p&gt;&#xA;&lt;p&gt;Ce serait également utile quand on a des données corrélées entre colonnes. Je vais reprendre l&amp;rsquo;exemple des commandes. On a une année entière de commandes: toutes les commandes qui ont plus d&amp;rsquo;un mois sont livrées, celles du dernier mois sont livrées à 90% (10% sont en cours de livraison).&lt;/p&gt;&#xA;&lt;p&gt;Intuitivement, si je cherche une commande en cours de livraison il y a plus de 6 mois je ne devrais pas avoir de résultat. Inversement, si je cherche des commandes en cours de livraison sur le dernier mois, je devrais obtenir 10% de la table. Or, le moteur ne le sait pas, pour lui les commandes en cours de livraison sont réparties sur toute la table.&lt;/p&gt;&#xA;&lt;p&gt;Avec un partitionnement par date, il peut estimer qu&amp;rsquo;il n&amp;rsquo;y a pas de commande en cours de livraisons de plus d&amp;rsquo;un mois. Ce type d&amp;rsquo;approche permet surtout de réduire une erreur d&amp;rsquo;estimation dans un plan d&amp;rsquo;exécution.&lt;/p&gt;&#xA;&lt;p&gt;Voici un exemple avec cette table de commandes, &lt;code&gt;orders_p&lt;/code&gt; est la version partitionnée par mois de la table &lt;code&gt;orders&lt;/code&gt;. Les données étant identiques dans les deux tables.&lt;/p&gt;&#xA;&lt;p&gt;On peut remarquer que l&amp;rsquo;estimation est bien meilleure dans le cas où la table est partitionnée, le moteur ayant des statistiques par partition.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;&#xA;&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;&#xA;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt; 1&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2&#xA;&lt;/span&gt;&lt;span class=&#34;hl&#34;&gt;&lt;span class=&#34;lnt&#34;&gt; 3&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5&#xA;&lt;/span&gt;&lt;span class=&#34;hl&#34;&gt;&lt;span class=&#34;lnt&#34;&gt; 6&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9&#xA;&lt;/span&gt;&lt;span class=&#34;hl&#34;&gt;&lt;span class=&#34;lnt&#34;&gt;10&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;14&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;15&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;16&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;17&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;18&#xA;&lt;/span&gt;&lt;span class=&#34;hl&#34;&gt;&lt;span class=&#34;lnt&#34;&gt;19&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;20&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;21&#xA;&lt;/span&gt;&lt;span class=&#34;hl&#34;&gt;&lt;span class=&#34;lnt&#34;&gt;22&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;23&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;24&#xA;&lt;/span&gt;&lt;span class=&#34;hl&#34;&gt;&lt;span class=&#34;lnt&#34;&gt;25&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;26&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;27&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;28&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;29&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;30&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;31&#xA;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&#xA;&lt;td class=&#34;lntd&#34;&gt;&#xA;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;EXPLAIN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;ANALYZE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line hl&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;orders_p&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;state&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;pending&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line hl&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AND&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;BETWEEN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;2021-01-01&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AND&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;2021-01-31&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;                                                  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;QUERY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PLAN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;--------------------------------------------------------------------------------------------------------------&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line hl&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;Index&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Scan&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;using&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;orders_13_state_idx&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;on&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;orders_13&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cost&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;42&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;..&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;45&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;width&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;12&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;actual&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;loops&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;   &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;Index&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Cond&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;state&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;pending&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;text&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;   &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Filter&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;2021-01-01&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;date&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AND&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;2021-01-31&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;date&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Planning&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Time&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;120&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ms&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Execution&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Time&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;059&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ms&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;5&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;EXPLAIN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;ANALYZE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line hl&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;orders&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;state&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;pending&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line hl&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AND&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;BETWEEN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;2021-01-01&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AND&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;2021-01-31&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;                                                  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;QUERY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PLAN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;---------------------------------------------------------------------------------------------------------------&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line hl&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;Index&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Scan&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;using&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;orders_state_idx&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;on&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;orders&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cost&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;44&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;..&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;13168&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;25&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3978&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;width&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;12&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;actual&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;loops&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;   &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;Index&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Cond&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;state&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;pending&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;text&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;   &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Filter&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;2021-01-01&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;date&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AND&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;2021-01-31&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;date&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;   &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;Rows&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Removed&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;by&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Filter&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;100161&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Planning&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Time&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;188&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ms&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Execution&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Time&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;141&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;571&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ms&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;6&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&#xA;&lt;/div&gt;&#xA;&lt;/div&gt;&#xA;&lt;p&gt;Maintenant prenons la même requête sur le dernier mois:&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;&#xA;&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;&#xA;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt; 1&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2&#xA;&lt;/span&gt;&lt;span class=&#34;hl&#34;&gt;&lt;span class=&#34;lnt&#34;&gt; 3&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5&#xA;&lt;/span&gt;&lt;span class=&#34;hl&#34;&gt;&lt;span class=&#34;lnt&#34;&gt; 6&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9&#xA;&lt;/span&gt;&lt;span class=&#34;hl&#34;&gt;&lt;span class=&#34;lnt&#34;&gt;10&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;14&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;15&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;16&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;17&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;18&#xA;&lt;/span&gt;&lt;span class=&#34;hl&#34;&gt;&lt;span class=&#34;lnt&#34;&gt;19&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;20&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;21&#xA;&lt;/span&gt;&lt;span class=&#34;hl&#34;&gt;&lt;span class=&#34;lnt&#34;&gt;22&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;23&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;24&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;25&#xA;&lt;/span&gt;&lt;span class=&#34;hl&#34;&gt;&lt;span class=&#34;lnt&#34;&gt;26&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;27&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;28&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;29&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;30&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;31&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;32&#xA;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&#xA;&lt;td class=&#34;lntd&#34;&gt;&#xA;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;EXPLAIN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;ANALYZE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line hl&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;orders_p&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;state&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;pending&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line hl&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AND&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;BETWEEN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;2021-07-01&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AND&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;2021-07-31&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;                                                       &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;QUERY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PLAN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;-------------------------------------------------------------------------------------------------------------------------&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line hl&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;Index&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Scan&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;using&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;orders_19_state_idx&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;on&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;orders_19&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cost&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;43&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;..&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2417&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;50&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;19215&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;width&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;12&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;actual&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;20931&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;loops&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;   &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;Index&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Cond&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;state&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;pending&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;text&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;   &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Filter&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;2021-07-01&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;date&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AND&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;2021-07-31&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;date&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Planning&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Time&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;297&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ms&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Execution&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Time&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;618&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ms&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;5&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;EXPLAIN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;ANALYZE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line hl&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;orders&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;state&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;pending&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line hl&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AND&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;BETWEEN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;2021-07-01&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AND&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;2021-07-31&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;                                                     &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;QUERY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PLAN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;--------------------------------------------------------------------------------------------------------------------&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line hl&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;Index&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Scan&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;using&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;orders_state_idx&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;on&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;orders&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cost&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;44&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;..&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;13168&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;25&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;15008&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;width&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;12&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;actual&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;20931&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;loops&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;   &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;Index&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Cond&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;state&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;pending&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;text&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;   &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Filter&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;2021-07-01&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;date&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AND&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;2021-07-31&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;date&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;   &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;Rows&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Removed&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;by&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Filter&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;79230&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Planning&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Time&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;173&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ms&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Execution&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Time&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;146&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;326&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ms&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;6&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&#xA;&lt;/div&gt;&#xA;&lt;/div&gt;&#xA;&lt;p&gt;Ici aussi on peut remarquer que l&amp;rsquo;estimation est meilleure.&lt;/p&gt;&#xA;&lt;h2 id=&#34;partitionwise-join--partitionwise-aggregate&#34;&gt;partitionwise join &amp;amp; partitionwise aggregate&lt;/h2&gt;&#xA;&lt;p&gt;Un autre intérêt du partitionnement est de bénéficier de meilleurs algorithmes pour les jointures et agrégation.&lt;/p&gt;&#xA;&lt;p&gt;Le &lt;code&gt;partitionwise aggregate&lt;/code&gt; permet de faire une agregation ou un regroupement partition par partition. Un exemple vaut mieux qu&amp;rsquo;un long discours:&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;&#xA;&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;&#xA;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt; 1&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3&#xA;&lt;/span&gt;&lt;span class=&#34;hl&#34;&gt;&lt;span class=&#34;lnt&#34;&gt; 4&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;14&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;15&#xA;&lt;/span&gt;&lt;span class=&#34;hl&#34;&gt;&lt;span class=&#34;lnt&#34;&gt;16&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;17&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;18&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;19&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;20&#xA;&lt;/span&gt;&lt;span class=&#34;hl&#34;&gt;&lt;span class=&#34;lnt&#34;&gt;21&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;22&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;23&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;24&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;25&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;26&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;27&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;28&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;29&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;30&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;31&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;32&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;33&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;34&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;35&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;36&#xA;&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;37&#xA;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&#xA;&lt;td class=&#34;lntd&#34;&gt;&#xA;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;explain&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;analyze&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;timing&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;off&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;select&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;count&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;from&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;orders_p&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;group&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;by&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;                                                  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;QUERY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PLAN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;--------------------------------------------------------------------------------------------------------------&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line hl&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;HashAggregate&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cost&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;508361&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;80&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;..&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;508365&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;45&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;365&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;width&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;12&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;actual&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;365&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;loops&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;   &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;Group&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;Key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;orders_01&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;   &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Append&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cost&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;00&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;..&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;408317&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;35&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;20008890&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;width&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;actual&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;20000000&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;loops&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;         &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Seq&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Scan&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;on&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;orders_01&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cost&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;00&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;..&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;22&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;70&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1270&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;width&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;actual&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;loops&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;         &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Seq&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Scan&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;on&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;orders_02&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cost&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;00&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;..&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;22&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;70&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1270&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;width&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;actual&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;loops&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[...]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;         &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Seq&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Scan&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;on&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;orders_19&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cost&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;00&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;..&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;45308&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;04&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2941004&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;width&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;actual&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2941004&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;loops&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;         &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Seq&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Scan&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;on&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;orders_20&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cost&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;00&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;..&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;131708&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;21&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;8549421&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;width&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;actual&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;8549421&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;loops&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Planning&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Time&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;576&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ms&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Execution&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Time&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;5273&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;217&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ms&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;25&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line hl&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;set&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;enable_partitionwise_aggregate&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;to&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;on&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;explain&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;analyze&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;timing&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;off&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;select&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;count&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;from&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;orders_p&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;group&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;by&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;                                                  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;QUERY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PLAN&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;--------------------------------------------------------------------------------------------------------------&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line hl&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Append&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cost&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;29&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;05&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;..&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;408343&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;83&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1765&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;width&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;12&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;actual&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;365&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;loops&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;   &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;HashAggregate&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cost&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;29&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;05&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;..&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;31&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;05&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;200&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;width&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;12&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;actual&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;loops&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;         &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;Group&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;Key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;orders_01&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;         &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Seq&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Scan&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;on&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;orders_01&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cost&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;00&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;..&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;22&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;70&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1270&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;width&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;actual&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;loops&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;   &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;HashAggregate&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cost&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;29&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;05&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;..&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;31&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;05&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;200&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;width&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;12&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;actual&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;loops&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;         &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;Group&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;Key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;orders_02&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;         &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Seq&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Scan&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;on&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;orders_02&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cost&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;00&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;..&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;22&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;70&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1270&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;width&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;actual&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;loops&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[...]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;   &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;HashAggregate&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cost&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;60013&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;06&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;..&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;60013&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;37&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;31&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;width&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;12&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;actual&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;31&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;loops&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;         &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;Group&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;Key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;orders_19&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;         &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Seq&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Scan&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;on&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;orders_19&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cost&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;00&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;..&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;45308&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;04&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2941004&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;width&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;actual&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2941004&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;loops&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;   &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;HashAggregate&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cost&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;174455&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;..&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;174455&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;55&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;24&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;width&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;12&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;actual&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;24&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;loops&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;         &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;Group&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;Key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;orders_20&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;c1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;         &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Seq&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Scan&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;on&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;orders_20&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cost&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;00&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;..&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;131708&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;21&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;8549421&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;width&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;actual&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;8549421&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;loops&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Planning&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Time&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;461&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ms&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Execution&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Time&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4669&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;315&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ms&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;63&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&#xA;&lt;/div&gt;&#xA;&lt;/div&gt;&#xA;&lt;p&gt;Dans le premier cas l&amp;rsquo;agrégation se fait une fois pour toutes les tables, alors que dans le second exemple, on fait l&amp;rsquo;agrégation par partition.&#xA;On peut également remarquer que le coût total est inférieur dans le plan avec agrégation par partition.&lt;/p&gt;&#xA;&lt;p&gt;Le &lt;code&gt;partitionwise join&lt;/code&gt; fonctionne sur le même principe, on fait une jointure partition par partition. C&amp;rsquo;est utile pour joindre deux tables partitionnées.&lt;/p&gt;&#xA;&lt;h2 id=&#34;stockage-avec-tiering&#34;&gt;Stockage avec tiering&lt;/h2&gt;&#xA;&lt;p&gt;Enfin, un autre cas d&amp;rsquo;usage serait de vouloir stocker une partie de la table sur un stockage différent:&lt;/p&gt;&#xA;&lt;p&gt;On peut stocker une table partitionnée dans des tablespaces différents. Par exemple les données récentes sur un tablespace rapide sur SSD NVMe.&#xA;Puis les données plus rarement accédées sur un autre tablespace, avec des disques mécaniques moins couteux.&lt;/p&gt;&#xA;&lt;p&gt;Cette approche peut aussi avoir du sens à l&amp;rsquo;heure du cloud où le stockage est très onéreux.&lt;/p&gt;&#xA;&lt;h1 id=&#34;conclusion&#34;&gt;Conclusion&lt;/h1&gt;&#xA;&lt;p&gt;Voilà, je pense avoir fait le tour des principaux cas d&amp;rsquo;usages qui me venaient en tête.&lt;/p&gt;&#xA;&lt;p&gt;Evidemment, la mise en oeuvre du partitionnement implique une plus grande complexité (gestion des partitions&amp;hellip;)&#xA;et des limitations qu&amp;rsquo;il faudra étudier en amont.&lt;/p&gt;&#xA;&lt;div class=&#34;footnotes&#34; role=&#34;doc-endnotes&#34;&gt;&#xA;&lt;hr&gt;&#xA;&lt;ol&gt;&#xA;&lt;li id=&#34;fn:1&#34;&gt;&#xA;&lt;p&gt;&amp;ldquo;BRIN indexes provide similar benefits to horizontal partitioning or sharding but without needing to explicitly declare partitions.&amp;rdquo; - &lt;a href=&#34;https://en.wikipedia.org/wiki/Block_Range_Index&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://en.wikipedia.org/wiki/Block_Range_Index&lt;/a&gt;&amp;#160;&lt;a href=&#34;#fnref:1&#34; class=&#34;footnote-backref&#34; role=&#34;doc-backlink&#34;&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&lt;/div&gt;</summary>
    <author>
      <name>blog.anayrat.info</name>
    </author>
  </entry>
  <entry>
    <title>Nouveau dans pg13: Colonne leader_pid dans pg_stat_activity</title>
    <updated>2020-03-08T05:33:26Z</updated>
    <id>tag:rjuju.github.io,2020-03-08:/postgresqlfr/2020/03/08/nouveau-dans-pg13-leader_pid.html</id>
    <content type="html">&lt;h3 id=&#34;nouvelle-colonne-leader_pid-dans-la-vue-pg_stat_activity&#34;&gt;Nouvelle colonne leader_pid dans la vue pg_stat_activity&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;Étonnamment, depuis que les requêtes parallèles ont été ajoutées dans&#xA;PostgreSQL 9.6, il était impossible de savoir à quel processus client était lié&#xA;un worker parallèle.  Ainsi, comme &lt;a href=&#34;https://twitter.com/g_lelarge/status/1209486212190343168&#34;&gt;Guillaume l’a fait&#xA;remarquer&lt;/a&gt;, it makes&#xA;il est assez difficile de construire des outils simples permettant&#xA;d’échantillonner les événements d’attente liés à tous les processus impliqués&#xA;dans une requête.  Une solution simple à ce problème est d’exporter&#xA;l’information de &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;lock group leader&lt;/code&gt; disponible dans le processus client au&#xA;niveau SQL :&lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-plaintext highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;commit b025f32e0b5d7668daec9bfa957edf3599f4baa8&#xA;Author: Michael Paquier &amp;lt;michael@paquier.xyz&amp;gt;&#xA;Date:   Thu Feb 6 09:18:06 2020 +0900&#xA;&#xA;Add leader_pid to pg_stat_activity&#xA;&#xA;This new field tracks the PID of the group leader used with parallel&#xA;query.  For parallel workers and the leader, the value is set to the&#xA;PID of the group leader.  So, for the group leader, the value is the&#xA;same as its own PID.  Note that this reflects what PGPROC stores in&#xA;shared memory, so as leader_pid is NULL if a backend has never been&#xA;involved in parallel query.  If the backend is using parallel query or&#xA;has used it at least once, the value is set until the backend exits.&#xA;&#xA;Author: Julien Rouhaud&#xA;Reviewed-by: Sergei Kornilov, Guillaume Lelarge, Michael Paquier, Tomas&#xA;Vondra&#xA;Discussion: https://postgr.es/m/CAOBaU_Yy5bt0vTPZ2_LUM6cUcGeqmYNoJ8-Rgto+c2+w3defYA@mail.gmail.com&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;Avec cette modification, il est maintenant très simple de trouver tous les&#xA;processus impliqués dans une requête parallèle.  Par exemple :&lt;/p&gt;&#xA;&#xA;&lt;figure class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;o&#34;&gt;=#&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;query&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;leader_pid&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&#xA;  &lt;span class=&#34;n&#34;&gt;array_agg&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pid&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;filter&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;leader_pid&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;!=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;pid&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;AS&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;members&lt;/span&gt;&#xA;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;pg_stat_activity&lt;/span&gt;&#xA;&lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;leader_pid&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;IS&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;NOT&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;NULL&lt;/span&gt;&#xA;&lt;span class=&#34;k&#34;&gt;GROUP&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;BY&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;query&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;leader_pid&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&#xA;       &lt;span class=&#34;n&#34;&gt;query&lt;/span&gt;       &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;leader_pid&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;    &lt;span class=&#34;n&#34;&gt;members&lt;/span&gt;&#xA;&lt;span class=&#34;c1&#34;&gt;-------------------+------------+---------------&lt;/span&gt;&#xA; &lt;span class=&#34;k&#34;&gt;select&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;from&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;t1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;      &lt;span class=&#34;mi&#34;&gt;31630&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;32269&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;32268&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&#xA;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;row&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;&#xA;&#xA;&lt;p&gt;Attention toutefois, comme indiqué dans le message de commit, si la colonne&#xA;&lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;leader_pid&lt;/code&gt; à la même valeur que la colonne &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;pid&lt;/code&gt;, cela ne veut pas forcément&#xA;dire que le processus client est actuellement en train d’effectuer une requête&#xA;parallèle, car une fois que le champ est positionné il n’est jamais&#xA;réinitialisé.  De plus, pour éviter tout surcoût, aucun verrou supplémentaire&#xA;n’est maintenu lors de l’affichage de ces données.  Cela veut dire que chaque&#xA;ligne est traitée indépendamment.  Ainsi, bien que cela soit fort peu probable,&#xA;vous pouvez obtenir des données incohérentes dans certaines circonstances,&#xA;comme par exemple un worker paralèlle pointant vers un pid qui est déjà&#xA;déconnecté.&lt;/p&gt;&#xA;&#xA;    &lt;p&gt;&lt;a href=&#34;https://rjuju.github.io/postgresqlfr/2020/03/08/nouveau-dans-pg13-leader_pid.html&#34;&gt;Nouveau dans pg13: Colonne leader_pid dans pg_stat_activity&lt;/a&gt; was originally published by Julien Rouhaud at &lt;a href=&#34;https://rjuju.github.io&#34;&gt;rjuju&#39;s home&lt;/a&gt; on March 08, 2020.&lt;/p&gt;</content>
    <link href="https://rjuju.github.io/postgresqlfr/2020/03/08/nouveau-dans-pg13-leader_pid.html" rel="alternate"></link>
    <summary type="html"></summary>
    <author>
      <name>Julien Rouhaud</name>
    </author>
  </entry>
  <entry>
    <title>pg qualstats 2: Suggestion d&#39;index globale</title>
    <updated>2020-01-06T12:23:29Z</updated>
    <id>tag:rjuju.github.io,2020-01-06:/postgresqlfr/2020/01/06/pg_qualstats-2-suggestion-index-globale.html</id>
    <content type="html">&lt;p&gt;Parvenir à une suggestion d’index de qualité peut être une tâche complexe.&#xA;Cela nécessite à la fois une connaissance des requêtes applicatives et des&#xA;spécificités de la base de données.  Avec le temps de nombreux projets ont&#xA;essayé de résoudre ce problème, l’un d’entre eux étant &lt;a href=&#34;https://powa.readthedocs.io/&#34;&gt;PoWA version&#xA;3&lt;/a&gt;, avec l’aide de &lt;a href=&#34;https://powa.readthedocs.io/en/latest/components/stats_extensions/pg_qualstats.html&#34;&gt;pg_qualstats&#xA;extension&lt;/a&gt;.&#xA;Cet outil donne de plutôt bonnes suggestions d’index, mais il est nécessaire&#xA;d’installer et configurer PoWA, alors que certains utilisateurs aimeraient&#xA;n’avoir que la suggestion d’index globale.  Pour répondre à ce besoin de&#xA;simplicité, l’algorithme utilisé dans PoWA est maintenant disponible dans&#xA;pg_qualstats version 2, sans avoir besoin d’utiliser des composants&#xA;additionnels.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;EDIT: La fonction &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;pg_qualstats_index\_advisor()&lt;/code&gt; a été changée pour retourner&#xA;du &lt;strong&gt;json&lt;/strong&gt; plutôt que du &lt;strong&gt;jsonb&lt;/strong&gt;, afin de conserver la compatibilité avec PostgreSQL&#xA;9.3.  Les requêtes d’exemples sont donc également modifiées pour utiliser&#xA;&lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;json_array_elements()&lt;/code&gt; plutôt que &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;jsonb_array_elements()&lt;/code&gt;.&lt;/p&gt;&#xA;&#xA;&lt;h3 id=&#34;quest-ce-que-pg_qualstats&#34;&gt;Qu’est-ce que pg_qualstats&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;Une manière simple d’expliquer ce qu’est pg_qualstats serait de dire qu’il&#xA;s’agit d’une extension similaire à&#xA;&lt;a href=&#34;https://www.postgresql.org/docs/current/pgstatstatements.html&#34;&gt;pg_stat_statements&lt;/a&gt;&#xA;mais travaillant au niveaux des prédicats.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Cette extension sauvegarde des statistiques utiles pour les clauses &lt;strong&gt;WHERE&lt;/strong&gt;&#xA;et &lt;strong&gt;JOIN&lt;/strong&gt; : à quelle table et quelle colonne un prédicat fait référénce, le&#xA;nombre de fois qu’un prédicat a été utilisé, le nombre d’exécutions de&#xA;l’opérateur sous-jacent, si le prédicat provient d’un parcours d’index ou non,&#xA;la sélectivité, la valeur des constantes et bien plus encore.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Il est possible de déduire beaucoup de choses depuis ces informations.  Par&#xA;exemple, si vous examinez les prédicats qui contiennent des références à des&#xA;tables différentes, vous pouvez trouver quelles tables sont jointes ensembles,&#xA;et à quel point les conditions de jointures sont sélectives.&lt;/p&gt;&#xA;&#xA;&lt;h3 id=&#34;suggestion-globale-&#34;&gt;Suggestion Globale ?&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;Comment je l’ai mentionné, la suggestion d’index globale ajoutée dans&#xA;pg_qualstats 2 utilise la même approche que celle de PoWA, ainsi cet article&#xA;peut servir à décrire le fonctionnement des deux outils.  La seule différence&#xA;est que vous obtiendrez probablement une suggestion de meilleure qualité avec&#xA;PoWA, puisque plus de prédicats seront disponibles, et que vous pourrez&#xA;également choisir sur quel intervalle de temps vous souhaitez effectuer une&#xA;suggestion d’index manquants.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;La chose importante à retenir ici est qu’il s’agit d’une suggestion effectuée&#xA;de manière &lt;strong&gt;globale&lt;/strong&gt;, c’est-à-dire en prenant en compte tous les prédicats&#xA;intéressant en même temps.  Cette approche est différente de toutes les autres&#xA;dont j’ai connaissance, qui ne prennent en compte qu’une seule requête à la&#xA;fois.  Selon moi, une approche globale est meilleure, car il est possible de&#xA;réduire le nombre total d’index, en maximisant l’efficacité des index&#xA;multi-colonnes.&lt;/p&gt;&#xA;&#xA;&lt;h3 id=&#34;comment-marche-la-suggestion-globale&#34;&gt;Comment marche la suggestion globale&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;La première étape consiste à récupérer tous les prédicats qui pourraient&#xA;bénéficier de nouveaux index.  C’est particulièrement facile à obtenir avec&#xA;pg_qualstats.  En filtrant les prédicats venant d’un parcours séquentiel,&#xA;exécutés de nombreuses fois et qui filtrent de nombreuses lignes (à la fois en&#xA;nombre et en pourcentage), vous obtenez une liste parfaite de prédicats qui&#xA;auraient très probablement besoin d’un index (ou alors dans certains cas une&#xA;liste des requêtes mal écrites).  Voyons regardons par exemple le cas d’une&#xA;applications qui utiliserait ces 4 prédicats:&lt;/p&gt;&#xA;&#xA;&lt;p&gt;&lt;a href=&#34;/images/global_advisor_1_quals.png&#34;&gt;&lt;img src=&#34;/images/global_advisor_1_quals.png&#34; alt=&#34;Liste de tous les prédicats&#xA;trouvés&#34; /&gt;&lt;/a&gt;&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Ensuite, il faut construire l’ensemble entier des chemins de toutes les&#xA;prédicats joints par un AND logique, qui contiennent d’autres prédicats, qui&#xA;peuvent être eux-meme également joints par des AND logiques.  En utilisants les&#xA;même 4 prédicats vus précédemments, nous obtenons ces chemins :&lt;/p&gt;&#xA;&#xA;&lt;p&gt;&lt;a href=&#34;/images/global_advisor_2_graphs.png&#34;&gt;&lt;img src=&#34;/images/global_advisor_2_graphs.png&#34; alt=&#34;Construction de tous les chemins de prédicats&#xA;possibles&#34; /&gt;&lt;/a&gt;&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Une fois tous les chemins construits, il suffit d’obtenir le meilleur chemin&#xA;pour trouver le meilleur index à suggérer.  Le classement de ces chemins est&#xA;pour le moment fait en donnant un poids à chaque nœud de chaque chemin qui&#xA;correspond au nombre de prédicats simple qu’il contient, et en additionnant le&#xA;poids pour chaque chemin.  C’est une approche très simple, et qui permet de&#xA;favoriser un nombre minimal d’index qui optimisent le plus de requêtes&#xA;possible.  Avec nos exemple, nous obtenons :&lt;/p&gt;&#xA;&#xA;&lt;p&gt;&lt;a href=&#34;/images/global_advisor_3_weighted.png&#34;&gt;&lt;img src=&#34;/images/global_advisor_3_weighted.png&#34; alt=&#34;Ajout d&#39;un poids à tous les chemins et choix du score le plus&#xA;haut&#34; /&gt;&lt;/a&gt;&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Bien évidemment, d’autres approches de classement pourraient être utilisée pour&#xA;prendre en compte d’autres paramètres, et potentiellement obtenir une meilleur&#xA;suggestion.  Par exemple, en prenant en compte également le nombre d’exécution&#xA;ou la sélectivité des prédicats.  Si le ratio de lecture/écriture pour chaque&#xA;table est connu (ce qui est disponible avec l’extension&#xA;&lt;a href=&#34;https://github.com/powa-team/powa-archivist&#34;&gt;powa-archivist&lt;/a&gt;), il serait&#xA;également possible d’adapter le classement pour limiter la suggestion d’index&#xA;pour les tables qui ne sont accédées presque exclusivement en écriture.  Avec&#xA;cet algorithme, ces ajustements seraient relativement simples à faire.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Une fois que le meilleur chemin est trouvé, on peut générer l’ordre de création&#xA;de l’index !  Comme l’ordre des colonnes peut être important, l’ordre est&#xA;généré en récupérant les colonnes de chaque nœud par poids croissant.  Avec&#xA;notre exemple, l’index suivant est généré :&lt;/p&gt;&#xA;&#xA;&lt;figure class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;k&#34;&gt;CREATE&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;INDEX&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;ON&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;t1&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;ts&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;val&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;&#xA;&#xA;&lt;p&gt;Une fois que l’index est trouvé, on supprime simplement les prédicats contenus&#xA;de la liste globale de prédicats et on reprendre de zéro jusqu’à ce qu’il n’y&#xA;ait plus de prédicats.&lt;/p&gt;&#xA;&#xA;&lt;h3 id=&#34;un-peu-plus-de-détails-et-mise-en-garde&#34;&gt;Un peu plus de détails et mise en garde&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;Bien évidemment, il s’agit ici d’une version simplifiée de l’algorithme de&#xA;suggestion, car d’autres informations sont nécessaires.  Par exemple, la liste&#xA;des prédicats est en réalité ajustée avec les &lt;a href=&#34;https://www.postgresql.org/docs/current/indexes-opclass.html&#34;&gt;classes d’opérateurs et méthode&#xA;d’acces&lt;/a&gt; en&#xA;fonction du type de la colonne et de sont opérateur, afin de s’assurer&#xA;d’obtenir des index valides.  Si plusieurs méthodes d’accès aux index sont&#xA;trouvées pour un même meilleur chemin, &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;btree&lt;/code&gt; sera choisi en priorité.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Cela nous amène à un autre détail : cette approche est principalement pensée&#xA;pour les index &lt;strong&gt;btree&lt;/strong&gt;, pour lesqules l’ordre des colonnes est critiques.&#xA;D’autres méthodes d’accès ne requièrent pas un ordre spécifique pour les&#xA;colonnes, et pour ces méthodes d’accès il est possible qu’une suggestion plus&#xA;optimale soit possible si l’ordre des colonnes n’était pas pris en compte.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Un autre point important est que les classes d’opérateurs et méthodes d’accès&#xA;ne sont pas gérés en dur mais récupérés à l’exécution en utilisant les&#xA;catalogues locaux.  Par conséquent, vous pouvez obtenir des résultats&#xA;différents (et potentiellement meilleurs) si vous faites en sorte d’avoir&#xA;toutes les classes d’opérateur additionelles disponibles quand vous utilisez la&#xA;suggestion d’index globale.  Cela pourrait être les extensions &lt;strong&gt;btree_gist&lt;/strong&gt;&#xA;et &lt;strong&gt;btree_gist&lt;/strong&gt;, mais également d’autres méthodes d’accès aux index.  Il est&#xA;également possible que certain types / opérateurs n’aient pas de méthode&#xA;d’accès associée dans les catalogues.  Dans ce cas, ces prédicats sont&#xA;retournées séparément dans une liste de prédicats non optimisables&#xA;automatiquement, et pour lequel une analyse manuelle est nécessaire.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Enfin, comme pg_qualstats ne traite pas les prédicats composés d’expressions,&#xA;l’outil ne peut pas suggérer d’index sur des expressions, par exemple en cas&#xA;d’utilisateur de recherche plein texte.&lt;/p&gt;&#xA;&#xA;&lt;h3 id=&#34;exemple-dutilisation&#34;&gt;Exemple d’utilisation&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;Une simple fonction est fournie, avec des paramètres facultatifs, qui retourne&#xA;une valeur de type json :&lt;/p&gt;&#xA;&#xA;&lt;figure class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;k&#34;&gt;CREATE&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;OR&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;REPLACE&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;FUNCTION&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;pg_qualstats_index_advisor&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&#xA;    &lt;span class=&#34;n&#34;&gt;min_filter&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;integer&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;DEFAULT&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;1000&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&#xA;    &lt;span class=&#34;n&#34;&gt;min_selectivity&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;integer&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;DEFAULT&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;30&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&#xA;    &lt;span class=&#34;n&#34;&gt;forbidden_am&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;text&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;DEFAULT&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;{}&#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&#xA;    &lt;span class=&#34;k&#34;&gt;RETURNS&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;json&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;&#xA;&#xA;&lt;p&gt;Les noms de paramètres sont parlants :&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;  &lt;li&gt;&lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;min_filter&lt;/code&gt;: combien de lignes le prédicat doit-il filtrer en moyenne pour&#xA;être pris en compte par la suggestion globale, par défaut &lt;strong&gt;1000&lt;/strong&gt; ;&lt;/li&gt;&#xA;  &lt;li&gt;&lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;min_selectivity&lt;/code&gt;: quelle doit être la sélectivité moyenne d’un prédicat&#xA;pour qu’il soit pris en compte par la suggestion globale, par défaut&#xA;&lt;strong&gt;30%&lt;/strong&gt; ;&lt;/li&gt;&#xA;  &lt;li&gt;&lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;forbidden_am&lt;/code&gt;: liste des méthodes d’accès aux index à ignorer.  Aucune par&#xA;défaut, bien que pour les version 9.6 et inférieures &lt;strong&gt;les index hash sont&#xA;ignoré en interne&lt;/strong&gt;, puisque ceux-ci ne sont sur que depuis la version 10.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;p&gt;Voici un exemple simple, tirés des tests de non régression de pg_qualstats :&lt;/p&gt;&#xA;&#xA;&lt;figure class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;k&#34;&gt;CREATE&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;TABLE&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;pgqs&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;AS&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;a&#39;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;val&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;generate_series&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;100&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&#xA;&lt;span class=&#34;k&#34;&gt;CREATE&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;TABLE&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;adv&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;id1&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;integer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;id2&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;integer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;id3&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;integer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;val&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;text&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&#xA;&lt;span class=&#34;k&#34;&gt;INSERT&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;INTO&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;adv&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;line &#39;&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;||&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;i&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;from&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;generate_series&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;1000&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&#xA;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;pg_qualstats_reset&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;&#xA;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;adv&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;id1&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&#xA;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;count&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;adv&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;id1&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;500&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&#xA;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;adv&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;val&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;meh&#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&#xA;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;adv&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;id1&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;and&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;val&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;meh&#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&#xA;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;adv&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;id1&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;and&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;val&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;meh&#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&#xA;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;adv&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;id1&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;and&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;id2&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;AND&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;val&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;meh&#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&#xA;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;adv&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;id1&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;6&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;and&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;id2&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;6&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;AND&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;id3&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;6&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;AND&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;val&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;meh&#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&#xA;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;adv&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;val&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;ILIKE&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;moh&#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&#xA;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;COUNT&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;pgqs&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;id&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;&#xA;&#xA;&lt;p&gt;Et voici ce que la fonction retourne :&lt;/p&gt;&#xA;&#xA;&lt;figure class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;v&lt;/span&gt;&#xA;  &lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;json_array_elements&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&#xA;    &lt;span class=&#34;n&#34;&gt;pg_qualstats_index_advisor&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;min_filter&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;50&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&#39;indexes&#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;v&lt;/span&gt;&#xA;  &lt;span class=&#34;k&#34;&gt;ORDER&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;BY&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;v&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;text&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;COLLATE&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;&#34;C&#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&#xA;                               &lt;span class=&#34;n&#34;&gt;v&lt;/span&gt;&#xA;&lt;span class=&#34;c1&#34;&gt;---------------------------------------------------------------&lt;/span&gt;&#xA; &lt;span class=&#34;nv&#34;&gt;&#34;CREATE INDEX ON public.adv USING btree (id1)&#34;&lt;/span&gt;&#xA; &lt;span class=&#34;nv&#34;&gt;&#34;CREATE INDEX ON public.adv USING btree (val, id1, id2, id3)&#34;&lt;/span&gt;&#xA; &lt;span class=&#34;nv&#34;&gt;&#34;CREATE INDEX ON public.pgqs USING btree (id)&#34;&lt;/span&gt;&#xA;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;rows&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&#xA;&#xA;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;v&lt;/span&gt;&#xA;  &lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;json_array_elements&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&#xA;    &lt;span class=&#34;n&#34;&gt;pg_qualstats_index_advisor&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;min_filter&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;50&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&#39;unoptimised&#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;v&lt;/span&gt;&#xA;  &lt;span class=&#34;k&#34;&gt;ORDER&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;BY&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;v&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;text&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;COLLATE&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;&#34;C&#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&#xA;        &lt;span class=&#34;n&#34;&gt;v&lt;/span&gt;&#xA;&lt;span class=&#34;c1&#34;&gt;-----------------&lt;/span&gt;&#xA; &lt;span class=&#34;nv&#34;&gt;&#34;adv.val ~~* ?&#34;&lt;/span&gt;&#xA;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;row&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;&#xA;&#xA;&lt;p&gt;La &lt;a href=&#34;https://github.com/powa-team/pg_qualstats/&#34;&gt;version 2 de pg_qualstats&lt;/a&gt;&#xA;n’est pas encore disponible en version stable, mais n’hésitez pas à la tester&#xA;et &lt;a href=&#34;https://github.com/powa-team/pg_qualstats/issues&#34;&gt;rapporter tout problème que vous pourriez&#xA;rencontrer&lt;/a&gt; !&lt;/p&gt;&#xA;&#xA;    &lt;p&gt;&lt;a href=&#34;https://rjuju.github.io/postgresqlfr/2020/01/06/pg_qualstats-2-suggestion-index-globale.html&#34;&gt;pg qualstats 2: Suggestion d&#39;index globale&lt;/a&gt; was originally published by Julien Rouhaud at &lt;a href=&#34;https://rjuju.github.io&#34;&gt;rjuju&#39;s home&lt;/a&gt; on January 06, 2020.&lt;/p&gt;</content>
    <link href="https://rjuju.github.io/postgresqlfr/2020/01/06/pg_qualstats-2-suggestion-index-globale.html" rel="alternate"></link>
    <summary type="html"></summary>
    <author>
      <name>Julien Rouhaud</name>
    </author>
  </entry>
  <entry>
    <title>PoWA 4: Nouveau daemon powa-collector</title>
    <updated>2019-12-10T18:54:17Z</updated>
    <id>tag:rjuju.github.io,2019-12-10:/postgresqlfr/2019/12/10/powa-4-nouveau-powa-collector.html</id>
    <content type="html">&lt;p&gt;Cet article fait partie d’une série d’article sur &lt;a href=&#34;http://powa.readthedocs.io/&#34;&gt;la beta de PoWA&#xA;4&lt;/a&gt;, et décrit le nouveau &lt;a href=&#34;https://powa.readthedocs.io/en/latest/components/powa-collector/index.html&#34;&gt;daemon&#xA;powa-collector&lt;/a&gt;.&lt;/p&gt;&#xA;&#xA;&lt;h3 id=&#34;nouveau-daemon-powa-collector&#34;&gt;Nouveau &lt;a href=&#34;https://powa.readthedocs.io/en/latest/components/powa-collector/index.html&#34;&gt;daemon powa-collector&lt;/a&gt;&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;Ce daemon remplace le précédent &lt;em&gt;background worker&lt;/em&gt; lorsque le nouveau &lt;a href=&#34;https://powa.readthedocs.io/en/latest/remote_setup.html&#34;&gt;mode&#xA;remote&lt;/a&gt; est utilisé.&#xA;Il s’agit d’un simple daemon écrit en python, qui s’occupera de toutes les&#xA;étapes nécessaires pour effectuer des &lt;em&gt;snapshots distants&lt;/em&gt;.  Il est &lt;a href=&#34;https://pypi.org/project/powa-collector/&#34;&gt;disponible&#xA;sur pypi&lt;/a&gt;.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Comme je l’ai expliqué dans mon &lt;a href=&#34;/postgresql/2019/05/17/powa-4-with-remote-mode-beta-is-available.html&#34;&gt;précédent article introduistant PoWA 4&lt;/a&gt;, ce&#xA;daemon est nécessaire  pour la configuration d’un mode remote, en gardant cette&#xA;architecture à l’esprit :&lt;/p&gt;&#xA;&#xA;&lt;p&gt;&lt;a href=&#34;/images/powa_4_remote.svg&#34;&gt;&lt;img src=&#34;/images/powa_4_remote.svg&#34; alt=&#34;Architecture de PoWA 4 en mode distant&#34; /&gt;&lt;/a&gt;&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Sa configuration est très simple.  Il vous suffit tout simplement de renommer&#xA;le fichier &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;powa-collector.conf.sample&lt;/code&gt; fourni, et d’adapter &lt;a href=&#34;https://www.postgresql.org/docs/current/libpq-connect.html#LIBPQ-CONNSTRING&#34;&gt;l’URI de&#xA;connexion&lt;/a&gt;&#xA;pour décrire comment se connecter sur votre &lt;em&gt;serveur repository&lt;/em&gt; dédié, et&#xA;c’est fini.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Une configuration typique devrait ressembler à :&lt;/p&gt;&#xA;&#xA;&lt;figure class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;language-conf&#34; data-lang=&#34;conf&#34;&gt;{&#xA;    &lt;span class=&#34;s2&#34;&gt;&#34;repository&#34;&lt;/span&gt;: {&#xA;        &lt;span class=&#34;s2&#34;&gt;&#34;dsn&#34;&lt;/span&gt;: &lt;span class=&#34;s2&#34;&gt;&#34;postgresql://powa_user@server_dns:5432/powa&#34;&lt;/span&gt;,&#xA;    },&#xA;    &lt;span class=&#34;s2&#34;&gt;&#34;debug&#34;&lt;/span&gt;: &lt;span class=&#34;n&#34;&gt;true&lt;/span&gt;&#xA;}&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;&#xA;&#xA;&lt;p&gt;La liste des &lt;em&gt;serveur distants&lt;/em&gt;, leur configuration ainsi que tout le reste qui&#xA;est nécessaire pour le bon fonctionnement sera automatiquement récupéré depuis&#xA;le &lt;em&gt;serveur repository&lt;/em&gt; que vous ave déjà configuré.  Une fois démarré, il&#xA;démarrera un thread dédié par &lt;em&gt;serveur distant&lt;/em&gt; déclaré, et maintiendra une&#xA;&lt;strong&gt;connexion persistente&lt;/strong&gt; sur ce &lt;em&gt;serveur distant&lt;/em&gt;.  Chaque thread effectuera&#xA;un &lt;em&gt;snapshot distant&lt;/em&gt;, exportant les données sur le &lt;em&gt;serveur repository&lt;/em&gt; en&#xA;utilisant les nouvelles &lt;em&gt;fonctions sources&lt;/em&gt;.  Chaque thread ouvrira et fermera&#xA;une connexion sur le &lt;em&gt;serveur repository&lt;/em&gt; lors de l’exécution du &lt;em&gt;snapshot&#xA;distant&lt;/em&gt;.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Bien évidemment, ce daemon a besoin de pouvoir se connecter sur tous les&#xA;&lt;em&gt;serveurs distants&lt;/em&gt; déclarés ainsi que le &lt;em&gt;serveur repository&lt;/em&gt;.  La table&#xA;&lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;powa_servers&lt;/code&gt;, qui stocke la liste des &lt;em&gt;serveurs distants&lt;/em&gt;, a un champ pour&#xA;stocker les nom d’utilisateur et mot de passe pour se connecter aux &lt;em&gt;serveur&#xA;distants&lt;/em&gt;.  Stocker un mot de passe en clair dans cette table est une hérésie,&#xA;si l’on considère l’aspect sécurité.  Ainsi, comme indiqué dans la&#xA;&lt;a href=&#34;https://powa.readthedocs.io/en/latest/security.html#connection-on-remote-servers&#34;&gt;section sécurité de&#xA;PoWA&lt;/a&gt;,&#xA;vous pouve stocker un mot de passe NULL et &lt;a href=&#34;https://www.postgresql.org/docs/current/auth-methods.html&#34;&gt;utiliser à la place n’importe&#xA;laquelle des autres méthodes d’authentification supportées par la&#xA;libpq&lt;/a&gt; (fichier&#xA;.pgpass, certificat…).  C’est très fortement recommandé pour toute&#xA;installation sérieuse.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;La connexion persistente sur le &lt;em&gt;serveur repository&lt;/em&gt; est utilisée pour&#xA;superviser la daemon :&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;  &lt;li&gt;pour vérifier  que le daemon est bien démarré&lt;/li&gt;&#xA;  &lt;li&gt;pour communiquer au travers de l’UI en utilisant un &lt;a href=&#34;https://powa.readthedocs.io/en/latest/components/powa-collector/protocol.html&#34;&gt;protocole simple&lt;/a&gt;&#xA;afin d’effectuer des actions diverses (recharger la configuration, vérifier&#xA;le status d’un thread dédié à un &lt;em&gt;serveur distant&lt;/em&gt;…)&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;p&gt;Il est à noter que vous pouvez également demander au daemon de recharger sa&#xA;configuration en envoyant un SIGHUP au processus du daemon.  Un rechargement&#xA;est nécessaire pour toute modification effectuée sur la liste des serveurs&#xA;distants (ajout ou suppression d’un &lt;em&gt;serveur distant&lt;/em&gt;, ou mise à jour d’un&#xA;existant).&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Veuillez également noter que, par choix,&#xA;&lt;a href=&#34;https://powa.readthedocs.io/en/latest/components/powa-collector/index.html&#34;&gt;powa-collector&lt;/a&gt;&#xA;n’effectuera pas de &lt;em&gt;snapshot local&lt;/em&gt;.  Si vous voulez utiliser PoWA pour le&#xA;&lt;em&gt;serveur repository&lt;/em&gt;, il vous faudra activer le &lt;em&gt;background worker&lt;/em&gt; original.&lt;/p&gt;&#xA;&#xA;&lt;h5 id=&#34;nouvelle-page-de-configuration&#34;&gt;Nouvelle page de configuration&lt;/h5&gt;&#xA;&#xA;&lt;p&gt;La page de configuration est maintenant modifiée pour donner toutes les&#xA;informations nécessaires sur le status du background worker, le &lt;a href=&#34;https://powa.readthedocs.io/en/latest/components/powa-collector/index.html&#34;&gt;powa-collector&#xA;daemon&lt;/a&gt;&#xA;(incluant tous ses threads dédiés) ainsi que la liste des &lt;em&gt;serveurs distants&lt;/em&gt;&#xA;déclarés.  Voici un exemple de cette nouvelle page racine de configuration :&lt;/p&gt;&#xA;&#xA;&lt;p&gt;&lt;a href=&#34;/images/powa_4_configuration_page.png&#34;&gt;&lt;img src=&#34;/images/powa_4_configuration_page.png&#34; alt=&#34;Nouvelle page de&#xA;configuration&#34; /&gt;&lt;/a&gt;&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Si le &lt;a href=&#34;https://powa.readthedocs.io/en/latest/components/powa-collector/index.html&#34;&gt;daemon&#xA;powa-collector&lt;/a&gt;&#xA;est utilisé, le status de chaque serveur distant sera récupéré en utilisant le&#xA;protocole de communication.  Si le collecteur rencontre des erreurs (lors de la&#xA;connexion à un &lt;em&gt;serveur distant&lt;/em&gt;, durant un &lt;em&gt;snapshot&lt;/em&gt; par exemple), celles-ci&#xA;seront également affichées ici.  À noter également que ces erreurs seront&#xA;également affichées en haut de chaque page de toutes les pages de l’UI, afin&#xA;d’être sûr de ne pas les rater.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;De plus, la section configuration a maintenant une hiérarchie, et vous pourrez&#xA;voir la liste des extensions ainsi que la configuration actuelle de PostgreSQL&#xA;pour le serveur &lt;strong&gt;local&lt;/strong&gt; ou &lt;strong&gt;distant&lt;/strong&gt; en cliquant sur le serveur de votre&#xA;choix!&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Il y a également un nouveau bouton &lt;strong&gt;Reload collector&lt;/strong&gt; sur le bandeau&#xA;d’en-tête qui, comme on pourrait s’y attendre, demandera au collecteur de&#xA;recharger sa configuration.  Cela peut être utile si vous avez déclarés de&#xA;nouveaux serveurs mais n’ave pas d’accès au serveur sur lequel le collecteur&#xA;s’exécute.&lt;/p&gt;&#xA;&#xA;&lt;h3 id=&#34;conclusion&#34;&gt;Conclusion&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;Cette article est le dernier de la séurie concernant la nouvelle version de&#xA;PoWA.  Il est toujours en beta, n’hésitez donc pas à le tester, &lt;a href=&#34;https://powa.readthedocs.io/en/latest/support.html#support&#34;&gt;rapporter&#xA;tout bug rencontré&lt;/a&gt;&#xA;ou donner tout autre retour!&lt;/p&gt;&#xA;&#xA;    &lt;p&gt;&lt;a href=&#34;https://rjuju.github.io/postgresqlfr/2019/12/10/powa-4-nouveau-powa-collector.html&#34;&gt;PoWA 4: Nouveau daemon powa-collector&lt;/a&gt; was originally published by Julien Rouhaud at &lt;a href=&#34;https://rjuju.github.io&#34;&gt;rjuju&#39;s home&lt;/a&gt; on December 10, 2019.&lt;/p&gt;</content>
    <link href="https://rjuju.github.io/postgresqlfr/2019/12/10/powa-4-nouveau-powa-collector.html" rel="alternate"></link>
    <summary type="html"></summary>
    <author>
      <name>Julien Rouhaud</name>
    </author>
  </entry>
  <entry>
    <title>PoWA 4: nouveautés dans powa-archivist !</title>
    <updated>2019-06-05T14:26:17Z</updated>
    <id>tag:rjuju.github.io,2019-06-05:/postgresqlfr/2019/06/05/powa-4-nouveaute-dans-powa-archivist.html</id>
    <content type="html">&lt;p&gt;Cet article fait partie d’une série d’article sur &lt;a href=&#34;http://powa.readthedocs.io/&#34;&gt;la beta de PoWA&#xA;4&lt;/a&gt;, et décrit les changements présents dans&#xA;&lt;a href=&#34;https://powa.readthedocs.io/en/latest/components/powa-archivist/index.html&#34;&gt;powa-archivist&lt;/a&gt;.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Pour plus d’information sur cette version 4, vous pouvez consulter &lt;a href=&#34;/postgresqlfr/2019/05/17/powa-4-avec-mode-remote-disponible-en-beta.html&#34;&gt;l’article&#xA;de présentation général&lt;/a&gt;.&lt;/p&gt;&#xA;&#xA;&lt;h3 id=&#34;aperçu-rapide&#34;&gt;Aperçu rapide&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;Tout d’abord, il faut savoir qu’il n’y a pas d’upgrade possible depuis la v3&#xA;vers la v4, il est donc nécessaire d’effectuer un &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;DROP EXTENSION powa&lt;/code&gt; si vous&#xA;utilisiez déjà PoWA sur vos serveurs.  Cela est du au fait que la v4 apporte&#xA;&lt;strong&gt;de très nombreux&lt;/strong&gt; changements dans la partie SQL de l’extension, ce qui en&#xA;fait le changement le plus significatif dans la suite PoWA pour cette nouvelle&#xA;version.  Au moment où j’écris cet article, la quantité de changements apportés&#xA;dans cette extension est :&lt;/p&gt;&#xA;&#xA;&lt;figure class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;language-diff&#34; data-lang=&#34;diff&#34;&gt; CHANGELOG.md       |   14 +&#xA; powa--4.0.0dev.sql | 2075 +++++++++++++++++++++-------&#xA; powa.c             |   44 +-&#xA; 3 files changed, 1629 insertions(+), 504 deletions(-)&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;&#xA;&#xA;&lt;p&gt;L’absence d’upgrade ne devrait pas être un problème en pratique.  PoWA est un&#xA;outil pour analyser les performances, il est fait pour avoir des données avec&#xA;une grande précision mais un historique très limité.  Si vous cherchez une&#xA;solution de supervision généraliste pour conserver des mois de données, PoWA&#xA;n’est définitivement pas l’outil qu’il vous faut.&lt;/p&gt;&#xA;&#xA;&lt;h3 id=&#34;configurer-la-liste-des-serveurs-distants&#34;&gt;Configurer la liste des &lt;em&gt;serveurs distants&lt;/em&gt;&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;En ce qui concerne les changements à proprement parler, le premier petit&#xA;changement est que le &lt;a href=&#34;https://www.postgresql.org/docs/current/bgworker.html&#34;&gt;background&#xA;worker&lt;/a&gt; n’est plus&#xA;nécessaire pour le fonctionnement de powa-archivist, car il n’est pas utilisé&#xA;pour le mode distant.  Cela signifie qu’un redémarrage de PostgreSQL n’est plus&#xA;nécessaire pour installer PoWA.  Bien évidemment, un redémarrage est toujours&#xA;nécessaire si vous souhaitez utiliser le mode local, en utilisant le background&#xA;worker, or si vous voulez installer des extensions additionelles qui&#xA;nécessitent elles-même un redémarrage.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Ensuite, comme PoWA requiert un peu de configuration (fréquence des snapshot,&#xA;rétention des données et ainsi de suite), certaines nouvelles tables sont&#xA;ajouter pour permettre de configurer tout ça.  La nouvelle table &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;powa_servers&lt;/code&gt;&#xA;stocke la configuration de toutes les instances distantes dont les données&#xA;doivent être stockées sur cette instance.  Cette &lt;em&gt;instance PoWA locale&lt;/em&gt; est&#xA;appelée un &lt;strong&gt;serveur repository&lt;/strong&gt; (qui devrait typiquement être dédiée à&#xA;stocker des données PoWA), en opposition aux &lt;strong&gt;instances distantes&lt;/strong&gt; qui sont&#xA;les instances que vous voulez monitorer.  Le contenu de cette table est tout ce&#xA;qu’il y a de plus simple :&lt;/p&gt;&#xA;&#xA;&lt;figure class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;err&#34;&gt;\&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;d&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;powa_servers&lt;/span&gt;&#xA;                              &lt;span class=&#34;k&#34;&gt;Table&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;&#34;public.powa_servers&#34;&lt;/span&gt;&#xA;  &lt;span class=&#34;k&#34;&gt;Column&lt;/span&gt;   &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;   &lt;span class=&#34;k&#34;&gt;Type&lt;/span&gt;   &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;Collation&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;Nullable&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;                 &lt;span class=&#34;k&#34;&gt;Default&lt;/span&gt;&#xA;&lt;span class=&#34;c1&#34;&gt;-----------+----------+-----------+----------+------------------------------------------&lt;/span&gt;&#xA; &lt;span class=&#34;n&#34;&gt;id&lt;/span&gt;            &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;integer&lt;/span&gt;  &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;           &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;not&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;null&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;nextval&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&#39;powa_servers_id_seq&#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;regclass&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&#xA; &lt;span class=&#34;n&#34;&gt;hostname&lt;/span&gt;      &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;text&lt;/span&gt;     &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;           &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;not&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;null&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&#xA; &lt;span class=&#34;k&#34;&gt;alias&lt;/span&gt;         &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;text&lt;/span&gt;     &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;           &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;          &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&#xA; &lt;span class=&#34;n&#34;&gt;port&lt;/span&gt;          &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;integer&lt;/span&gt;  &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;           &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;not&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;null&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&#xA; &lt;span class=&#34;n&#34;&gt;username&lt;/span&gt;      &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;text&lt;/span&gt;     &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;           &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;not&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;null&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&#xA; &lt;span class=&#34;n&#34;&gt;password&lt;/span&gt;      &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;text&lt;/span&gt;     &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;           &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;          &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&#xA; &lt;span class=&#34;n&#34;&gt;dbname&lt;/span&gt;        &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;text&lt;/span&gt;     &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;           &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;not&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;null&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&#xA; &lt;span class=&#34;n&#34;&gt;frequency&lt;/span&gt;     &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;integer&lt;/span&gt;  &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;           &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;not&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;null&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;300&lt;/span&gt;&#xA; &lt;span class=&#34;n&#34;&gt;powa_coalesce&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;integer&lt;/span&gt;  &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;           &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;not&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;null&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;100&lt;/span&gt;&#xA; &lt;span class=&#34;n&#34;&gt;retention&lt;/span&gt;     &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;interval&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;           &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;not&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;null&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;1 day&#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;interval&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;&#xA;&#xA;&lt;p&gt;Si vous avez déjà utilisé PoWA, vous devriez reconnaître la plupart des options&#xA;de configuration qui sont maintenant stockées ici.  Les nouvelles options sont&#xA;utilisées pour décrire comment se connecter aux &lt;em&gt;instances distances&lt;/em&gt;, et&#xA;peuvent fournir un alias à afficher sur l’UI.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Vous avez également probablement remarqué une colonne &lt;strong&gt;password&lt;/strong&gt;.  Stocker un&#xA;mot de passe en clair dans cette table est une hérésie pour n’importe qui&#xA;désirant un minimum de sécurité.  Ainsi, comme mentionné dans la &lt;a href=&#34;https://powa.readthedocs.io/en/latest/security.html#connection-on-remote-servers&#34;&gt;section&#xA;sécurité de la documentation de PoWA&#xA;&lt;/a&gt;,&#xA;vous pouvez stocker NULL pour le champ password et à la place utiliser&#xA;&lt;a href=&#34;https://www.postgresql.org/docs/current/auth-methods.html&#34;&gt;n’importe laquelle des autres méthodes d’authentification supportée par la&#xA;libpq&lt;/a&gt;&#xA;(fichier .pgpass, certificat…).  Une authentification plus sécurisée est&#xA;chaudement recommandée pour toute installation sérieuse.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Une autre table, la table &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;powa_snapshot_metas&lt;/code&gt;, est également ajoutée pour&#xA;stocker quelques métadonnées concernant les informations de snapshot pour&#xA;chaque &lt;em&gt;serveur distant&lt;/em&gt;.&lt;/p&gt;&#xA;&#xA;&lt;figure class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;                                   &lt;span class=&#34;k&#34;&gt;Table&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;&#34;public.powa_snapshot_metas&#34;&lt;/span&gt;&#xA;    &lt;span class=&#34;k&#34;&gt;Column&lt;/span&gt;    &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;           &lt;span class=&#34;k&#34;&gt;Type&lt;/span&gt;           &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;Collation&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;Nullable&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;                &lt;span class=&#34;k&#34;&gt;Default&lt;/span&gt;&#xA;&lt;span class=&#34;c1&#34;&gt;--------------+--------------------------+-----------+----------+---------------------------------------&lt;/span&gt;&#xA; &lt;span class=&#34;n&#34;&gt;srvid&lt;/span&gt;        &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;integer&lt;/span&gt;                  &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;           &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;not&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;null&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&#xA; &lt;span class=&#34;n&#34;&gt;coalesce_seq&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;bigint&lt;/span&gt;                   &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;           &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;not&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;null&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&#xA; &lt;span class=&#34;n&#34;&gt;snapts&lt;/span&gt;       &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;timestamp&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;with&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;time&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;zone&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;           &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;not&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;null&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;-infinity&#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;timestamp&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;with&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;time&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;zone&lt;/span&gt;&#xA; &lt;span class=&#34;n&#34;&gt;aggts&lt;/span&gt;        &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;timestamp&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;with&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;time&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;zone&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;           &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;not&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;null&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;-infinity&#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;timestamp&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;with&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;time&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;zone&lt;/span&gt;&#xA; &lt;span class=&#34;n&#34;&gt;purgets&lt;/span&gt;      &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;timestamp&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;with&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;time&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;zone&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;           &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;not&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;null&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;-infinity&#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;timestamp&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;with&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;time&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;zone&lt;/span&gt;&#xA; &lt;span class=&#34;n&#34;&gt;errors&lt;/span&gt;       &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;text&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;&#xA;&#xA;&lt;p&gt;Il s’agit tout simplement d’un compteur pour compter le nombre de snapshots&#xA;effectués, un timestamp pour chaque type d’événement survenu (snapshot,&#xA;aggrégation et purge) et un tableau de chaîne de caractères pour stocker toute&#xA;erreur survenant durant le snapshot, afin que l’UI pour l’afficher.&lt;/p&gt;&#xA;&#xA;&lt;h3 id=&#34;api-sql-pour-configurer-les-serveurs-distants&#34;&gt;API SQL pour configurer les &lt;em&gt;serveurs distants&lt;/em&gt;&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;Bien que ces tables soient très simples, une &lt;a href=&#34;https://powa.readthedocs.io/en/latest/remote_setup.html#configure-powa-and-stats-extensions-on-each-remote-server&#34;&gt;API SQL basique est disponible&#xA;pour déclarer de nouveaux serveurs et les&#xA;configurer&lt;/a&gt;.&#xA;6 fonctions de bases sont disponibles :&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;  &lt;li&gt;&lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;powa_register_server()&lt;/code&gt;, pour déclarer un nouveau &lt;em&gt;servuer distant&lt;/em&gt;, ainsi&#xA;que la liste des extensions qui y sont disponibles&lt;/li&gt;&#xA;  &lt;li&gt;&lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;powa_configure_server()&lt;/code&gt; pour mettre à jour un des paramètres pour le&#xA;&lt;em&gt;serveur distant&lt;/em&gt; spécifié (en utilisant un paramètre JSON, où la clé est&#xA;le nom du paramètre à changer et la valeur la nouvelle valeur à utiliser)&lt;/li&gt;&#xA;  &lt;li&gt;&lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;powa_deactivate_server()&lt;/code&gt; pour désactiver les snapshots pour le &lt;em&gt;serveur&#xA;distant&lt;/em&gt; spécifiqué (ce qui concrètement positionnera le paramètre&#xA;&lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;frequency&lt;/code&gt; à &lt;strong&gt;-1&lt;/strong&gt;)&lt;/li&gt;&#xA;  &lt;li&gt;&lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;powa_delete_and_purge_server()&lt;/code&gt; pour supprimer le &lt;em&gt;serveur distant&lt;/em&gt;&#xA;spécifié de la liste des serveurs et supprimer toutes les données associées&#xA;aux snapshots&lt;/li&gt;&#xA;  &lt;li&gt;&lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;powa_activate_extension()&lt;/code&gt;, pour déclarer qu’une nouvelle extension est&#xA;disponible sur le &lt;em&gt;serveur distant&lt;/em&gt; spécifié&lt;/li&gt;&#xA;  &lt;li&gt;&lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;powa_deactivate_extension()&lt;/code&gt;, pour spécifier qu’une extension n’est plus&#xA;disponible sur le &lt;em&gt;serveur distant&lt;/em&gt; spécifié&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;p&gt;Toute action plus compliquée que ça devra être effectuée en utilisant des&#xA;requêtes SQL.  Heureusement, il ne devrait pas y avoir beaucoup d’autres&#xA;besoins, et les tables sont vraiment très simple donc cela ne devrait pas poser&#xA;de soucis.  &lt;a href=&#34;https://github.com/powa-team/powa-archivist/issues&#34;&gt;N’hésitez cependant pas à demander de nouvelles&#xA;fonctions&lt;/a&gt; si vous aviez&#xA;d’autres besoins.  Veuillez également noter que l’UI ne vous permet pas&#xA;d’appeler ces fonctions, puisque celle-ci est pour le moment &lt;strong&gt;entièrement en&#xA;lecture seule&lt;/strong&gt;.&lt;/p&gt;&#xA;&#xA;&lt;h3 id=&#34;effectuer-des-snapshots-distants&#34;&gt;Effectuer des &lt;em&gt;snapshots distants&lt;/em&gt;&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;Puisque les métriques sont maintenant stockées sur une instance PostgreSQL&#xA;différente, nous avons énormément changé la façon dont les &lt;em&gt;snapshots&lt;/em&gt;&#xA;(récupérer les données fournies par une &lt;a href=&#34;https://powa.readthedocs.io/en/latest/components/stats_extensions/index.html&#34;&gt;extensions&#xA;statistique&lt;/a&gt;&#xA;et les stockées dans le catalogue PoWA &lt;a href=&#34;/postgresqlfr/2019/04/06/minimiser-le-surcout-de-stockage-par-ligne.html&#34;&gt;de manière à optimiser le stockage&lt;/a&gt;) sont&#xA;effectués.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;La liste de toutes les extensions statistiques, ou &lt;em&gt;sources de données&lt;/em&gt;, qui&#xA;sont disponibles sur un &lt;strong&gt;serveur&lt;/strong&gt; (soit &lt;em&gt;distant&lt;/em&gt; soit &lt;em&gt;local&lt;/em&gt;) et pour&#xA;lesquelles un &lt;em&gt;snapshot&lt;/em&gt; devrait être effectué est stockée dans une table&#xA;appelée &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;powa_functions&lt;/code&gt;:&lt;/p&gt;&#xA;&#xA;&lt;figure class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;               &lt;span class=&#34;k&#34;&gt;Table&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;&#34;public.powa_functions&#34;&lt;/span&gt;&#xA;     &lt;span class=&#34;k&#34;&gt;Column&lt;/span&gt;     &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;  &lt;span class=&#34;k&#34;&gt;Type&lt;/span&gt;   &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;Collation&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;Nullable&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;Default&lt;/span&gt;&#xA;&lt;span class=&#34;c1&#34;&gt;----------------+---------+-----------+----------+---------&lt;/span&gt;&#xA; &lt;span class=&#34;n&#34;&gt;srvid&lt;/span&gt;          &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;integer&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;           &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;not&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;null&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&#xA; &lt;span class=&#34;n&#34;&gt;module&lt;/span&gt;         &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;text&lt;/span&gt;    &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;           &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;not&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;null&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&#xA; &lt;span class=&#34;k&#34;&gt;operation&lt;/span&gt;      &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;text&lt;/span&gt;    &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;           &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;not&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;null&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&#xA; &lt;span class=&#34;n&#34;&gt;function_name&lt;/span&gt;  &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;text&lt;/span&gt;    &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;           &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;not&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;null&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&#xA; &lt;span class=&#34;n&#34;&gt;query_source&lt;/span&gt;   &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;text&lt;/span&gt;    &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;           &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;          &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&#xA; &lt;span class=&#34;n&#34;&gt;added_manually&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;boolean&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;           &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;not&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;null&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;true&lt;/span&gt;&#xA; &lt;span class=&#34;n&#34;&gt;enabled&lt;/span&gt;        &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;boolean&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;           &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;not&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;null&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;true&lt;/span&gt;&#xA; &lt;span class=&#34;n&#34;&gt;priority&lt;/span&gt;       &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;numeric&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;           &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;not&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;null&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;10&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;&#xA;&#xA;&lt;p&gt;Un nouveau champ &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;query_source&lt;/code&gt; a été rajouté.  Celui-ci fournit le nom de la&#xA;&lt;em&gt;fonction source&lt;/em&gt;, nécessaire pour la compatibilité d’une &lt;a href=&#34;https://powa.readthedocs.io/en/latest/components/stats_extensions/index.html&#34;&gt;extension&#xA;statistique&lt;/a&gt;&#xA;avec les snapshots distants.  Cette fonction est utilisée pour exporter les&#xA;compteurs fournis par cette extension sur un serveur différent, dans une &lt;em&gt;table&#xA;transitoire&lt;/em&gt; dédiée.  La fonction de &lt;em&gt;snapshot&lt;/em&gt; effectuera alors le &lt;em&gt;snapshot&lt;/em&gt;&#xA;en utilisant automatiquement ces données exportées plutôt que celles fournies&#xA;par l’extension statististique locale quand le mode distant est utilisé.  Il&#xA;est à noter que l’export de ces compteurs ainsi que le snapshot distant est&#xA;effectué automatiquement par le nouveau &lt;a href=&#34;https://powa.readthedocs.io/en/latest/components/powa-collector/index.html&#34;&gt;daemon&#xA;powa-collector&lt;/a&gt;&#xA;que je présenterai dans un autre article.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Voici un exemple montant comment PoWA effectue un &lt;em&gt;snapshot distant&lt;/em&gt; d’une&#xA;liste de base données.  Comme vous allez le voir, c’est très simple ce qui&#xA;signifie qu’il est également très simple d’ajouter cette même compatibilité&#xA;pour une nouvelle extension statistique.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;La &lt;em&gt;table transitoire&lt;/em&gt;:&lt;/p&gt;&#xA;&#xA;&lt;figure class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;   &lt;span class=&#34;n&#34;&gt;Unlogged&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;table&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;&#34;public.powa_databases_src_tmp&#34;&lt;/span&gt;&#xA; &lt;span class=&#34;k&#34;&gt;Column&lt;/span&gt;  &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;  &lt;span class=&#34;k&#34;&gt;Type&lt;/span&gt;   &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;Collation&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;Nullable&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;Default&lt;/span&gt;&#xA;&lt;span class=&#34;c1&#34;&gt;---------+---------+-----------+----------+---------&lt;/span&gt;&#xA; &lt;span class=&#34;n&#34;&gt;srvid&lt;/span&gt;   &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;integer&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;           &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;not&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;null&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&#xA; &lt;span class=&#34;n&#34;&gt;oid&lt;/span&gt;     &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;oid&lt;/span&gt;     &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;           &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;not&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;null&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&#xA; &lt;span class=&#34;n&#34;&gt;datname&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;    &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;           &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;not&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;null&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;&#xA;&#xA;&lt;p&gt;Pour de meilleurs performances, toutes les &lt;em&gt;tables transitoires&lt;/em&gt; sont &lt;strong&gt;non&#xA;journalisées (unlogged)&lt;/strong&gt;, puisque leur contenu n’est nécessaire que durant un&#xA;&lt;em&gt;snapshot&lt;/em&gt; et sont supprimées juste après.  Dans cet examlple, la &lt;em&gt;table&#xA;transitoire&lt;/em&gt; ne stocke que l’identifiant du serveur distant correspondant à ces&#xA;données, l’oid ainsi que le nom de chacune des bases de données présentes sur&#xA;le &lt;em&gt;serveur distant&lt;/em&gt;.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Et la &lt;em&gt;fonction source&lt;/em&gt; :&lt;/p&gt;&#xA;&#xA;&lt;figure class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;k&#34;&gt;CREATE&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;OR&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;REPLACE&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;FUNCTION&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;public&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;powa_databases_src&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_srvid&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;integer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&#xA;    &lt;span class=&#34;k&#34;&gt;OUT&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;oid&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;oid&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;OUT&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;datname&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&#xA; &lt;span class=&#34;k&#34;&gt;RETURNS&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;SETOF&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;record&lt;/span&gt;&#xA; &lt;span class=&#34;k&#34;&gt;LANGUAGE&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;plpgsql&lt;/span&gt;&#xA;&lt;span class=&#34;k&#34;&gt;AS&lt;/span&gt; &lt;span class=&#34;err&#34;&gt;$&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;function&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;$&lt;/span&gt;&#xA;&lt;span class=&#34;k&#34;&gt;BEGIN&lt;/span&gt;&#xA;    &lt;span class=&#34;n&#34;&gt;IF&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_srvid&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;THEN&lt;/span&gt;&#xA;        &lt;span class=&#34;k&#34;&gt;RETURN&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;QUERY&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;d&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;oid&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;d&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;datname&lt;/span&gt;&#xA;        &lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;pg_database&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;d&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&#xA;    &lt;span class=&#34;k&#34;&gt;ELSE&lt;/span&gt;&#xA;        &lt;span class=&#34;k&#34;&gt;RETURN&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;QUERY&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;d&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;oid&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;d&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;datname&lt;/span&gt;&#xA;        &lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;powa_databases_src_tmp&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;d&lt;/span&gt;&#xA;        &lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;srvid&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;_srvid&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&#xA;    &lt;span class=&#34;k&#34;&gt;END&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;IF&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&#xA;&lt;span class=&#34;k&#34;&gt;END&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&#xA;&lt;span class=&#34;err&#34;&gt;$&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;function&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;$&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;&#xA;&#xA;&lt;p&gt;Cette fonction retourne simplement le contenu de &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;pg_database&lt;/code&gt; si les données&#xA;locales sont demandées (l’identifiant de serveur &lt;strong&gt;0&lt;/strong&gt; est toujours le serveur&#xA;local), ou alors le contenu de la &lt;em&gt;table transitoire&lt;/em&gt; pour le serveur distant&#xA;spécifié.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;La &lt;em&gt;fonction de snapshot&lt;/em&gt; peut alors facilement effectuer n’importe quel&#xA;traitement avec ces données pour le &lt;em&gt;serveur distant&lt;/em&gt; voulu.  Dans le cas de la&#xA;fonction &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;powa_databases_snapshot()&lt;/code&gt;, il s’agit simplement de synchroniser la&#xA;liste des bases de données, et de stocker le timestamp de suppression si une&#xA;base de données qui existait précédemment n’est plus listée.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Pour plus de détails, vous pouvez consulter la documentation concernant&#xA;&lt;a href=&#34;https://powa.readthedocs.io/en/latest/components/powa-archivist/development.html&#34;&gt;l’ajout d’une source de données dans&#xA;PoWA&lt;/a&gt;,&#xA;qui a été mise à jour pour les spécificités de la version 4.&lt;/p&gt;&#xA;&#xA;    &lt;p&gt;&lt;a href=&#34;https://rjuju.github.io/postgresqlfr/2019/06/05/powa-4-nouveaute-dans-powa-archivist.html&#34;&gt;PoWA 4: nouveautés dans powa-archivist !&lt;/a&gt; was originally published by Julien Rouhaud at &lt;a href=&#34;https://rjuju.github.io&#34;&gt;rjuju&#39;s home&lt;/a&gt; on June 05, 2019.&lt;/p&gt;</content>
    <link href="https://rjuju.github.io/postgresqlfr/2019/06/05/powa-4-nouveaute-dans-powa-archivist.html" rel="alternate"></link>
    <summary type="html"></summary>
    <author>
      <name>Julien Rouhaud</name>
    </author>
  </entry>
  <entry>
    <title>PoWA 4 apporte un mode remote, disponible en beta !</title>
    <updated>2019-05-17T11:04:17Z</updated>
    <id>tag:rjuju.github.io,2019-05-17:/postgresqlfr/2019/05/17/powa-4-avec-mode-remote-disponible-en-beta.html</id>
    <content type="html">&lt;p&gt;&lt;a href=&#34;http://powa.readthedocs.io/&#34;&gt;PoWA 4&lt;/a&gt; est disponible en beta.&lt;/p&gt;&#xA;&#xA;&lt;h3 id=&#34;nouveau-mode-remote-&#34;&gt;Nouveau mode remote !&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;Le &lt;a href=&#34;https://powa.readthedocs.io/en/latest/remote_setup.html&#34;&gt;nouveau mode remote&lt;/a&gt;&#xA;est la plus grosse fonctionnalité ajoutée dans PoWA 4, bien qu’il y ait eu&#xA;d’autres améliorations.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Je vais décrire ici ce que ce nouveau mode implique ainsi que ce qui a changé&#xA;sur l’&lt;a href=&#34;https://powa.readthedocs.io/en/latest/components/powa-web/index.html&#34;&gt;UI&lt;/a&gt;.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Si de plus amples détails sur le reste des changements apportés dans PoWA 4&#xA;vous intéresse, je publierai bientôt d’autres articles sur le sujet.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Pour les plus pressés, n’hésitez pas à aller directement sur la &lt;a href=&#34;https://dev-powa.anayrat.info/&#34;&gt;démo v4 de&#xA;PoWA&lt;/a&gt;, très gentiment hébergée par &lt;a href=&#34;http://blog.anayrat.info/&#34;&gt;Adrien&#xA;Nayrat&lt;/a&gt;.  Aucun authentification n’est requise,&#xA;cliquez simplement sur “Login”.&lt;/p&gt;&#xA;&#xA;&lt;h3 id=&#34;pourquoi-un-mode-remote-est-il-important&#34;&gt;Pourquoi un mode remote est-il important&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;Cette fonctionnalité a probablement été la plus fréquemment demandée depuis que&#xA;PoWA a été publié, en 2014.  Et c’est pour de bonnes raisons, car un mode local&#xA;a quelques inconvénients.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Tout d’abord, voyons comment se présentait l’architecture avec les versions 3&#xA;et antérieures.  Imaginons une instance contenant 2 bases de données (db1 et&#xA;db2), ainsi qu’&lt;strong&gt;une base de données dédiée à PoWA&lt;/strong&gt;.  Cette base de données&#xA;dédiée contient à la fois les &lt;em&gt;extensions statistiques&lt;/em&gt; nécessaires pour&#xA;récupérer compteurs de performances actuels ainsi que pour &lt;strong&gt;les stocker&lt;/strong&gt;.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;&lt;a href=&#34;/images/powa_4_local.svg&#34;&gt;&lt;img src=&#34;/images/powa_4_local.svg&#34; alt=&#34;Architecture en mode local&#34; /&gt;&lt;/a&gt;&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Un &lt;em&gt;&lt;a href=&#34;https://powa.readthedocs.io/en/latest/components/powa-archivist/configuration.html#background-worker-configuration&#34;&gt;background&#xA;worker&lt;/a&gt;&lt;/em&gt;&#xA;est démarré par PoWA, qui est responsable d’effectuer des &lt;em&gt;snapshots&lt;/em&gt; et de les&#xA;stocker dans la base powa dédiée à intervalle réguliers.  Ensuite, en utilisant&#xA;powa-web, vous pouvez consulter l’activité de n’importe laquelle des bases de&#xA;données &lt;strong&gt;locales&lt;/strong&gt; en effectuant des requêtes sur les données stockées dans la&#xA;base dédié, et potentiellement en se connectant sur l’une des autres bases de&#xA;données locales lorsque les données complètes sont nécessaires, par exemple&#xA;lorsque l’outil de suggestion d’index est utilisé.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Avec la version 4, l’architecture avec une configuration distante change de&#xA;manière significative:&lt;/p&gt;&#xA;&#xA;&lt;p&gt;&lt;a href=&#34;/images/powa_4_remote.svg&#34;&gt;&lt;img src=&#34;/images/powa_4_remote.svg&#34; alt=&#34;Architecture en mode distant&#34; /&gt;&lt;/a&gt;&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Vous pouvez voir qu’une base de donnée powa dédiée est toujours nécessaire,&#xA;mais &lt;strong&gt;uniquement pour les extensions statistiques&lt;/strong&gt;.  Les données sont&#xA;maintenant stockées sur une instance différente.  Ensuite, le &lt;em&gt;&lt;a href=&#34;https://powa.readthedocs.io/en/latest/components/powa-archivist/configuration.html#background-worker-configuration&#34;&gt;background&#xA;worker&lt;/a&gt;&lt;/em&gt;&#xA;est remplacé par un &lt;strong&gt;&lt;a href=&#34;https://powa.readthedocs.io/en/latest/components/powa-collector/index.html&#34;&gt;nouveau daemon&#xA;collecteur&lt;/a&gt;&lt;/strong&gt;,&#xA;qui lit les métriques de performance depuis les &lt;em&gt;serveurs distants&lt;/em&gt;, et les&#xA;stocke sur le &lt;em&gt;serveur repository&lt;/em&gt; dédié.  Powa-web pourra présenter les&#xA;données en se connectant sur le &lt;em&gt;serveur repository&lt;/em&gt;, ainsi que sur les&#xA;&lt;strong&gt;serveurs distants&lt;/strong&gt; lorsque des données complètes sont nécessaires.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;En résumé, avec le nouveau mode distant ajouté dans cette version 4&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;  &lt;li&gt;un redémarrage de PostgreSQL n’est plus nécessaire pour installer&#xA;powa-archivist&lt;/li&gt;&#xA;  &lt;li&gt;il n’y a plus de surcoût du au fait de stocker et requêter les données sur&#xA;le même serveur PostgreSQL que vos serveurs de productions (il y a toujours&#xA;certaines partie de l’UI qui nécessitent d’effectuer des requêtes sur le&#xA;serveur d’origine, par exemple pour montrer des plans avec EXPLAIN, mais le&#xA;surcoût est négligeable)&lt;/li&gt;&#xA;  &lt;li&gt;il est maintenant possible d’utiliser PoWA sur un &lt;strong&gt;serveur en&#xA;hot-standby&lt;/strong&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;p&gt;L’UI vous accueillera donc maintenant avec une page initiale afin de choisir&#xA;lequel des serveurs stockés sur la base de données cible vous voulez&#xA;travailler :&#xA;&lt;a href=&#34;/images/powa_4_all_servers.png&#34;&gt;&lt;img src=&#34;/images/powa_4_all_servers.png&#34; alt=&#34;Choix des serveurs&#34; /&gt;&lt;/a&gt;&lt;/p&gt;&#xA;&#xA;&lt;p&gt;La principale raison pour laquelle il a fallu tellement de temps pour apporter&#xA;ce mode distant est parce que cela apporte beaucoup de complexité, nécessitant&#xA;une réécriture majeure de PoWA.  Nous voulions également ajouter d’abord&#xA;d’autres fonctionnalités, comme la &lt;strong&gt;suggestion globale d’index&lt;/strong&gt;, avec une&#xA;&lt;strong&gt;validation grâce à &lt;a href=&#34;http://hypopg.readthedocs.io/&#34;&gt;hypopg&lt;/a&gt;&lt;/strong&gt; introduit avec&#xA;&lt;a href=&#34;https://powa.readthedocs.io/en/latest/releases/v3.0.0.html&#34;&gt;PoWA 3&lt;/a&gt;.&lt;/p&gt;&#xA;&#xA;&lt;h3 id=&#34;changements-dans-powa-web&#34;&gt;Changements dans &lt;a href=&#34;https://powa.readthedocs.io/en/latest/components/powa-web/index.html&#34;&gt;powa-web&lt;/a&gt;&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;L’&lt;em&gt;interface graphique&lt;/em&gt; est le composant qui a le plus de changements visibles&#xA;dans cette version 4.  Voici les plus changements les plus importants.&lt;/p&gt;&#xA;&#xA;&lt;h5 id=&#34;compatibilité-avec-le-mode-distant&#34;&gt;Compatibilité avec le mode distant&lt;/h5&gt;&#xA;&#xA;&lt;p&gt;Le changement le plus important est bien évidemment le support pour le &lt;a href=&#34;https://powa.readthedocs.io/en/latest/remote_setup.html&#34;&gt;nouveau&#xA;mode remote&lt;/a&gt;.  En&#xA;conséquence, la première page affichée est maintenant une page de &lt;strong&gt;sélection&#xA;de serveur&lt;/strong&gt;, affichant tous les &lt;em&gt;serveurs distants&lt;/em&gt; enregistrés.  Après avoir&#xA;choisi le &lt;em&gt;serveur distant&lt;/em&gt; voulu (ou le &lt;em&gt;serveur local&lt;/em&gt; si vous n’utilisez pas&#xA;le mode distant), toutes les autres pages seront similaires à celles&#xA;disponibles jusqu’à la version 3, mais afficheront les données pour un &lt;em&gt;serveur&#xA;distant&lt;/em&gt; spécifique uniquement, et bien entendu en récupérant les données&#xA;depuis la &lt;strong&gt;base de données repository&lt;/strong&gt;, avec en plus de nouvelles&#xA;informations décrites ci-dessous.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Veuillez notez que puisque les données sont maintenant stockées sur un &lt;em&gt;serveur&#xA;repository&lt;/em&gt; dédié quand le mode remote est utilisé, la majorité de l’UI est&#xA;utilisable sans se connecter au &lt;em&gt;serveur distant&lt;/em&gt; sélectionné.  Toutefois,&#xA;powa-web nécessite toujours de pouvoir se connecter sur le &lt;em&gt;serveur distant&lt;/em&gt;&#xA;quand les données originales sont nécessaires (par exemple, pour la suggestion&#xA;d’index ou pour montrer des plans avec &lt;strong&gt;EXPLAIN&lt;/strong&gt;).  Les &lt;a href=&#34;https://powa.readthedocs.io/en/latest/security.html#connection-on-remote-servers&#34;&gt;mêmes considérations&#xA;et possibilités concernant&#xA;l’authentification&lt;/a&gt;&#xA;que pour le nouveau &lt;a href=&#34;https://powa.readthedocs.io/en/latest/components/powa-collector/index.html&#34;&gt;daemon powa-collector&#xA;&lt;/a&gt;&#xA;(qui sera décrit dans un prochain article) s’appliquent ici.&lt;/p&gt;&#xA;&#xA;&lt;h5 id=&#34;pg_track_settings-support&#34;&gt;&lt;a href=&#34;https://github.com/rjuju/pg_track_settings/&#34;&gt;pg_track_settings&lt;/a&gt; support&lt;/h5&gt;&#xA;&#xA;&lt;p&gt;Quand cette extension est correctement configurée, un nouveau widget timeline&#xA;apparaîtra, placé entre chaque graph et son aperçu, affichant différents types&#xA;de changements enregistrés si ceux-ci ont été détectés sur l’intervalle de&#xA;temps sélectionné.  Sur les pages par base de données et par requête, la liste&#xA;sera également filtrée en fonction de la base de données sélectionnée.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;La même timeline sera affichée sur chacun des graphs de chacune des pages, afin&#xA;de facilement vérifier si ces changements ont eu un impact visible en utilisant&#xA;les différents graphs.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Veuillez noter que les détails des changements sont affichés au survol de la&#xA;souris.  Vous pouvez également cliquer sur n’importe lequel des événements de&#xA;la timeline pour figer l’affichage, et tracer une ligne verticale sur le graph&#xA;associé.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Voici un exemple d’un tel changement de configuration en action :&lt;/p&gt;&#xA;&#xA;&lt;p&gt;&lt;a href=&#34;/images/pg_track_settings_powa4.png&#34;&gt;&lt;img src=&#34;/images/pg_track_settings_powa4.png&#34; alt=&#34;Changements de configuration détectés&#34; /&gt;&lt;/a&gt;&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Veuillez également noter qu’il est nécessaire d’avoir au minimum la version&#xA;2.0.0 de &lt;a href=&#34;https://github.com/rjuju/pg_track_settings/&#34;&gt;pg_track_settings&lt;/a&gt;, et&#xA;que l’extension doit être installée &lt;strong&gt;à la fois sur les &lt;em&gt;serveurs distants&lt;/em&gt;&#xA;ainsi que sur le &lt;em&gt;serveur repository&lt;/em&gt;.&lt;/strong&gt;&lt;/p&gt;&#xA;&#xA;&lt;h5 id=&#34;nouveaux-graphs-disponibles&#34;&gt;Nouveaux graphs disponibles&lt;/h5&gt;&#xA;&#xA;&lt;p&gt;Quand&#xA;&lt;a href=&#34;https://powa.readthedocs.io/en/latest/components/stats_extensions/pg_stat_kcache.html&#34;&gt;pg_stat_kcache&lt;/a&gt;&#xA;est configuré, ses informations n’étaient auparavant affichées que sur la page&#xA;par requête.  Les informations sont maintenant également affichées sur les&#xA;pages par serveur et par base, dans deux nouveaux graphs :&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;  &lt;li&gt;dans le graph &lt;strong&gt;Block Access&lt;/strong&gt;, où les métriques &lt;strong&gt;OS cache&lt;/strong&gt; et &lt;strong&gt;disk&#xA;read&lt;/strong&gt; remplaceront la métrique &lt;strong&gt;read&lt;/strong&gt;&lt;/li&gt;&#xA;  &lt;li&gt;dans un nouveau graph &lt;strong&gt;System Resources&lt;/strong&gt; (qui est également ajouté dans&#xA;la page &lt;em&gt;par requête&lt;/em&gt;), montrant les &lt;a href=&#34;/postgresql/2018/07/17/pg_stat_kcache-2-1-is-out.html&#34;&gt;metrics ajoutées dans pg_stat_kcache&#xA;2.1&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;p&gt;Voici un example de ce nouveau graph &lt;strong&gt;System Resources&lt;/strong&gt; :&lt;/p&gt;&#xA;&#xA;&lt;p&gt;&lt;a href=&#34;/images/pg_stat_kcache_system_resources_powa4.png&#34;&gt;&lt;img src=&#34;/images/pg_stat_kcache_system_resources_powa4.png&#34; alt=&#34;Ressources système&#34; /&gt;&lt;/a&gt;&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Il y avait également un graph &lt;strong&gt;Wait Events&lt;/strong&gt; (disponible quand &lt;a href=&#34;https://powa.readthedocs.io/en/v4/components/stats_extensions/pg_wait_sampling.html&#34;&gt;l’extension&#xA;pg_wait_sampling&lt;/a&gt;&#xA;est configuée) disponible uniquement sur la page par requête.  Ce graph est&#xA;maintenant disponible sur les pages par serveur et par base également.&lt;/p&gt;&#xA;&#xA;&lt;h5 id=&#34;documentation-des-métriques-et-liens-vers-la-documentation&#34;&gt;Documentation des métriques et liens vers la documentation&lt;/h5&gt;&#xA;&#xA;&lt;p&gt;Certaines métriques affichées sur l’interface sont assez parlante, mais&#xA;certaines autres peuvent être un peu obscures.  Jusqu’à maintenant, il n’y&#xA;avait malheureusement aucune documentation pour les métriques.  Le problème est&#xA;maintenant réglé, et tous les graphs ont une &lt;em&gt;icône d’information&lt;/em&gt;, qui&#xA;affichent une description des métriques utilisée dans le graph au survol de la&#xA;souris.  Certains graphs incluent également un lien vers la &lt;a href=&#34;https://powa.readthedocs.io/en/latest/components/stats_extensions/index.html&#34;&gt;documentation PoWA&#xA;de extension&#xA;statistiques&lt;/a&gt;&#xA;pour les utilisateurs qui désirent en apprendre plus à leur sujet.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Voici un exemple :&lt;/p&gt;&#xA;&#xA;&lt;p&gt;&lt;a href=&#34;/images/powa_4_metrics_doc.png&#34;&gt;&lt;img src=&#34;/images/powa_4_metrics_doc.png&#34; alt=&#34;Documentation des métriques&#34; /&gt;&lt;/a&gt;&lt;/p&gt;&#xA;&#xA;&lt;h5 id=&#34;et-des-correctifs-de-bugs-divers&#34;&gt;Et des correctifs de bugs divers&lt;/h5&gt;&#xA;&#xA;&lt;p&gt;Certains problèmes de longues dates ont également été rapportés :&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;  &lt;li&gt;la boîte affichée au survol d’un graph montant les valeurs des métriques&#xA;avait une position verticale incorrecte&lt;/li&gt;&#xA;  &lt;li&gt;la sélection temporelle en utilisant l’aperçu des graphs ne montrait pas un&#xA;aperçu correct après avoir appliqué la sélection&lt;/li&gt;&#xA;  &lt;li&gt;les erreurs lors de la création d’index hypothétiques ou dans certains cas&#xA;leur affichage n’était pas correctement gérés sur plusieurs pages&lt;/li&gt;&#xA;  &lt;li&gt;les filtres des tableaux n’était pas réappliqués quand l’intervalle de&#xA;temps sélectionné était changé&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;p&gt;Si un de ces problèmes vous a un jour posé problème, vous serez ravi&#xA;d’apprendre qu’ils sont maintenant tous corrigés !&lt;/p&gt;&#xA;&#xA;&lt;h3 id=&#34;conclusion&#34;&gt;Conclusion&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;Cette 4ème version de PoWA représente un temps de développement très important,&#xA;de nombreuses améliorations sur la documentation et beaucoup de tests.  Nous&#xA;somme maintenant assez satisfaits, mais il est possible que nous ayons ratés&#xA;certains bugs.  Si vous vous intéressez à ce projet, j’espère que vous&#xA;essaierez de tester cette beta, et si besoin n’hésitez pas à &lt;a href=&#34;https://powa.readthedocs.io/en/latest/support.html#support&#34;&gt;nous remonter un&#xA;bug&lt;/a&gt;!&lt;/p&gt;&#xA;&#xA;    &lt;p&gt;&lt;a href=&#34;https://rjuju.github.io/postgresqlfr/2019/05/17/powa-4-avec-mode-remote-disponible-en-beta.html&#34;&gt;PoWA 4 apporte un mode remote, disponible en beta !&lt;/a&gt; was originally published by Julien Rouhaud at &lt;a href=&#34;https://rjuju.github.io&#34;&gt;rjuju&#39;s home&lt;/a&gt; on May 17, 2019.&lt;/p&gt;</content>
    <link href="https://rjuju.github.io/postgresqlfr/2019/05/17/powa-4-avec-mode-remote-disponible-en-beta.html" rel="alternate"></link>
    <summary type="html"></summary>
    <author>
      <name>Julien Rouhaud</name>
    </author>
  </entry>
  <entry>
    <title>Nouveauté pg12: Statistiques sur les erreurs de checkums</title>
    <updated>2019-04-18T11:02:26Z</updated>
    <id>tag:rjuju.github.io,2019-04-18:/postgresqlfr/2019/04/18/nouveau-dans-pg12-statistiques-erreurs-checksums.html</id>
    <content type="html">&lt;h3 id=&#34;data-checksums&#34;&gt;Data checksums&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;Ajoutés dans &lt;a href=&#34;https://git.postgresql.org/gitweb/?p=postgresql.git;a=commitdiff;h=96ef3b8ff1c&#34;&gt;PostgreSQL&#xA;9.3&lt;/a&gt;,&#xA;les &lt;a href=&#34;https://www.postgresql.org/docs/current/app-initdb.html#APP-INITDB-DATA-CHECKSUMS&#34;&gt;data&#xA;checksums&lt;/a&gt;&#xA;peuvent aider à détecter les corruptions de données survenant sur votre&#xA;stockage.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Les checksums sont activés si l’instance a été initialisée en utilisant &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;initdb&#xA;--data-checksums&lt;/code&gt; (ce qui n’est pas le comportement par défaut), ou s’ils ont&#xA;été activés après en utilisant la nouvelle utilitaire&#xA;activated afterwards with the new&#xA;&lt;a href=&#34;https://www.postgresql.org/docs/devel/app-pgchecksums.html&#34;&gt;pg_checksums&lt;/a&gt;&#xA;également &lt;a href=&#34;https://git.postgresql.org/gitweb/?p=postgresql.git;a=commitdiff;h=ed308d783790&#34;&gt;ajouté dans PostgreSQL&#xA;12&lt;/a&gt;.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Quand les checksums sont ativés, ceux-ci sont écrits à chaque fois qu’un bloc&#xA;de données est écrit sur disque, et vérifiés à chaque fois qu’un bloc est lu&#xA;depuis le disque (ou depuis le cache du système d’exploitation).  Si la&#xA;vérification échoue, une erreur est remontée dans les logs.  Si le bloc était&#xA;lu par un processus client, la requête associée échouera bien évidemment, mais&#xA;si le bloc était lu par une opération&#xA;&lt;a href=&#34;https://www.postgresql.org/docs/current/protocol-replication.html#id-1.10.5.9.7.1.8.1.12&#34;&gt;BASE_BACKUP&lt;/a&gt;&#xA;(tel que pg_basebackup), la commande continuera à s’exécuter.  Bien que les&#xA;data checksums ne détecteront qu’un sous ensemble des problèmes possibles, ils&#xA;ont tout de même une certaine utilisé, surtout si vous ne faites pas confiance&#xA;à votre stockage.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Jusqu’à PostgreSQL 11, les erreurs de validation de checksum ne pouvaient être&#xA;trouvées qu’en cherchant dans les logs, ce qui n’est clairement pas pratique si&#xA;vous voulez monitorer de telles erreurs.&lt;/p&gt;&#xA;&#xA;&lt;h3 id=&#34;nouveaux-compteurs-disponibles-dans-pg_stat_database&#34;&gt;Nouveaux compteurs disponibles dans pg_stat_database&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;Pour rendre la supervision des erreurs de checksum plus simple, et pour aider&#xA;les utilisateurs à réagir dès qu’un tel problème survient, PostgreSQL 12 ajoute&#xA;de nouveaux compteurs dans la vue &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;pg_stat_database&lt;/code&gt; :&lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-plaintext highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;commit 6b9e875f7286d8535bff7955e5aa3602e188e436&#xA;Author: Magnus Hagander &amp;lt;magnus@hagander.net&amp;gt;&#xA;Date:   Sat Mar 9 10:45:17 2019 -0800&#xA;&#xA;Track block level checksum failures in pg_stat_database&#xA;&#xA;This adds a column that counts how many checksum failures have occurred&#xA;on files belonging to a specific database. Both checksum failures&#xA;during normal backend processing and those created when a base backup&#xA;detects a checksum failure are counted.&#xA;&#xA;Author: Magnus Hagander&#xA;Reviewed by: Julien Rouhaud&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt; &lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-plaintext highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;commit 77bd49adba4711b4497e7e39a5ec3a9812cbd52a&#xA;Author: Magnus Hagander &amp;lt;magnus@hagander.net&amp;gt;&#xA;Date:   Fri Apr 12 14:04:50 2019 +0200&#xA;&#xA;    Show shared object statistics in pg_stat_database&#xA;&#xA;    This adds a row to the pg_stat_database view with datoid 0 and datname&#xA;    NULL for those objects that are not in a database. This was added&#xA;    particularly for checksums, but we were already tracking more satistics&#xA;    for these objects, just not returning it.&#xA;&#xA;    Also add a checksum_last_failure column that holds the timestamptz of&#xA;    the last checksum failure that occurred in a database (or in a&#xA;    non-dataabase file), if any.&#xA;&#xA;    Author: Julien Rouhaud &amp;lt;rjuju123@gmail.com&amp;gt;&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt; &lt;/p&gt;&#xA;&#xA;&lt;div class=&#34;language-plaintext highlighter-rouge&#34;&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;highlight&#34;&gt;&lt;code&gt;commit 252b707bc41cc9bf6c55c18d8cb302a6176b7e48&#xA;Author: Magnus Hagander &amp;lt;magnus@hagander.net&amp;gt;&#xA;Date:   Wed Apr 17 13:51:48 2019 +0200&#xA;&#xA;    Return NULL for checksum failures if checksums are not enabled&#xA;&#xA;    Returning 0 could falsely indicate that there is no problem. NULL&#xA;    correctly indicates that there is no information about potential&#xA;    problems.&#xA;&#xA;    Also return 0 as numbackends instead of NULL for shared objects (as no&#xA;    connection can be made to a shared object only).&#xA;&#xA;    Author: Julien Rouhaud &amp;lt;rjuju123@gmail.com&amp;gt;&#xA;    Reviewed-by: Robert Treat &amp;lt;rob@xzilla.net&amp;gt;&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&#xA;&#xA;&lt;p&gt;Ces compteurs reflèteront les erreurs de validation de checksum à la fois pour&#xA;les processus clients et pour l’activité&#xA;&lt;a href=&#34;https://www.postgresql.org/docs/current/protocol-replication.html#id-1.10.5.9.7.1.8.1.12&#34;&gt;BASE_BACKUP&lt;/a&gt;,&#xA;par base de données.&lt;/p&gt;&#xA;&#xA;&lt;figure class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;n&#34;&gt;rjuju&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=#&lt;/span&gt; &lt;span class=&#34;err&#34;&gt;\&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;d&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;pg_stat_database&lt;/span&gt;&#xA;                        &lt;span class=&#34;k&#34;&gt;View&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;&#34;pg_catalog.pg_stat_database&#34;&lt;/span&gt;&#xA;        &lt;span class=&#34;k&#34;&gt;Column&lt;/span&gt;         &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;           &lt;span class=&#34;k&#34;&gt;Type&lt;/span&gt;           &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;Collation&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;Nullable&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;Default&lt;/span&gt;&#xA;&lt;span class=&#34;c1&#34;&gt;-----------------------+--------------------------+-----------+----------+---------&lt;/span&gt;&#xA; &lt;span class=&#34;n&#34;&gt;datid&lt;/span&gt;                 &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;oid&lt;/span&gt;                      &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;           &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;          &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&#xA; &lt;span class=&#34;n&#34;&gt;datname&lt;/span&gt;               &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;                     &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;           &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;          &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&#xA; &lt;span class=&#34;p&#34;&gt;[...]&lt;/span&gt;&#xA; &lt;span class=&#34;n&#34;&gt;checksum_failures&lt;/span&gt;     &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;bigint&lt;/span&gt;                   &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;           &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;          &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&#xA; &lt;span class=&#34;n&#34;&gt;checksum_last_failure&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;timestamp&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;with&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;time&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;zone&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;           &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;          &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&#xA; &lt;span class=&#34;p&#34;&gt;[...]&lt;/span&gt;&#xA; &lt;span class=&#34;n&#34;&gt;stats_reset&lt;/span&gt;           &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;timestamp&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;with&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;time&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;zone&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;           &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;          &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;&#xA;&#xA;&lt;p&gt;La colonne &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;checksum_failures&lt;/code&gt; montrera un nombre cumulé d’erreurs, et la&#xA;colonne &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;checksum_last_failure&lt;/code&gt; montrera l’horodatage de la dernière erreur de&#xA;validation sur la base de données (NULL si aucune erreur n’est jamais&#xA;survenue).&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Pour éviter toute confusion (merci à Robert Treat pour l’avoir signalé), ces&#xA;deux colonnes retourneront toujours NULL si les data checkums ne sont pas&#xA;activés, afin qu’on ne puisse pas croire que les checksums sont toujours&#xA;vérifiés avec succès.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Comme effet de bord, &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;pg_stat_database&lt;/code&gt;  montrera maintenant également les&#xA;statistiques disponibles pour les objets partagés (tels que la table&#xA;&lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;pg_database&lt;/code&gt; par exemple), dans une nouvelle ligne pour laquelle &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;datid&lt;/code&gt; vaut&#xA;&lt;strong&gt;0&lt;/strong&gt;, et &lt;code class=&#34;language-plaintext highlighter-rouge&#34;&gt;datname&lt;/code&gt; vaut &lt;strong&gt;NULL&lt;/strong&gt;.&lt;/p&gt;&#xA;&#xA;&lt;p&gt;&lt;del&gt;Une sonde dédiée est également &lt;a href=&#34;https://github.com/OPMDG/check_pgactivity/issues/226&#34;&gt;déjà&#xA;planifiée&lt;/a&gt; dans&#xA;&lt;a href=&#34;https://opm.readthedocs.io/probes/check_pgactivity.html&#34;&gt;check_pgactivity&lt;/a&gt; !&lt;/del&gt;&#xA;Une sonde dédiée est également &lt;a href=&#34;https://github.com/OPMDG/check_pgactivity/commit/0e8b516e95e4364470d4e205aebc9fe68bbcfd23&#34;&gt;déjà&#xA;disponible&lt;/a&gt;&#xA;dans &lt;a href=&#34;https://opm.readthedocs.io/probes/check_pgactivity.html&#34;&gt;check_pgactivity&lt;/a&gt; !&lt;/p&gt;&#xA;&#xA;    &lt;p&gt;&lt;a href=&#34;https://rjuju.github.io/postgresqlfr/2019/04/18/nouveau-dans-pg12-statistiques-erreurs-checksums.html&#34;&gt;Nouveauté pg12: Statistiques sur les erreurs de checkums&lt;/a&gt; was originally published by Julien Rouhaud at &lt;a href=&#34;https://rjuju.github.io&#34;&gt;rjuju&#39;s home&lt;/a&gt; on April 18, 2019.&lt;/p&gt;</content>
    <link href="https://rjuju.github.io/postgresqlfr/2019/04/18/nouveau-dans-pg12-statistiques-erreurs-checksums.html" rel="alternate"></link>
    <summary type="html"></summary>
    <author>
      <name>Julien Rouhaud</name>
    </author>
  </entry>
  <entry>
    <title>Mettre en place une streaming replication avec PostgreSQL 10</title>
    <updated>2018-03-13T06:28:00Z</updated>
    <id>tag:blog.raveland.tech,2018-03-13:/post/postgresql_sr_fr/</id>
    <link href="https://blog.raveland.tech/post/postgresql_sr_fr/" rel="alternate"></link>
    <summary type="html">&lt;p&gt;Dans ce post, je vais vous expliquer comment mettre en place une &lt;em&gt;streaming replication&lt;/em&gt; avec PostgreSQL 10. Par contre, je n&amp;rsquo;expliquerais pas comment installer PostgreSQL donc je suppose que cela est déjà le cas.&lt;/p&gt;</summary>
    <author>
      <name>blog.raveland.tech</name>
    </author>
  </entry>
  <entry>
    <title>OpenBSD / PostgreSQL / Authentification</title>
    <updated>2017-11-29T11:31:53Z</updated>
    <id>tag:blog.raveland.tech,2017-11-29:/post/openbsd_pg/</id>
    <link href="https://blog.raveland.tech/post/openbsd_pg/" rel="alternate"></link>
    <summary type="html">&lt;p&gt;Si vous êtes un utilisateur d&amp;rsquo;OpenBSD et de PostgreSQL, vous pouvez utiliser l&amp;rsquo;authentification BSD pour vous authentifier sur vos bases.&#xA;Nous allons voir comment faire cela.&lt;/p&gt;</summary>
    <author>
      <name>blog.raveland.tech</name>
    </author>
  </entry>
  <entry>
    <title>Postgresql et la réplication logique</title>
    <updated>2017-11-27T08:32:06Z</updated>
    <id>tag:blog.raveland.tech,2017-11-27:/post/postgresql_lr/</id>
    <link href="https://blog.raveland.tech/post/postgresql_lr/" rel="alternate"></link>
    <summary type="html">&lt;p&gt;Cet article va tester la nouvelle fonctionnalité disponible depuis PostgreSQL 10.0 : la réplication logique.&lt;/p&gt;&#xA;&lt;p&gt;Pour en savoir plus, l&amp;rsquo;excellente &lt;a href=&#34;https://docs.postgresql.fr/10/logical-replication.html&#34;&gt;documentation de PostgreSQL&lt;/a&gt;&lt;/p&gt;</summary>
    <author>
      <name>blog.raveland.tech</name>
    </author>
  </entry>
</feed>